define("utils/utils",[],function(){"use strict";var e={WIDTH:"width",HEIGHT:"height",ASPECT:"aspect",MINIMUM:"minimum",MAXIMUM:"maximum"},t={LEFT:1,MIDDLE:2,RIGHT:3},i=[],n={},s=180/Math.PI,o=Math.PI/180,r=.5*Math.PI,a=2*Math.PI,l={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,"caps lock":20,escape:27,space:32,"page up":33,"page down":34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,"left window":91,"right window":92,select:93,"numpad 0":96,"numpad 1":97,"numpad 2":98,"numpad 3":99,"numpad 4":100,"numpad 5":101,"numpad 6":102,"numpad 7":103,"numpad 8":104,"numpad 9":105,"numpad *":106,"numpad +":107,"numpad -":109,"numpad /":111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222},c={};return c.EMPTY_ARRAY=i,c.EMPTY_STRING="",c.EMPTY_OBJECT=n,c.DEG=s,c.RAD=o,c.HALF_PI=r,c.DOUBLE_PI=a,c.ScaleMode=e,c.MouseButton=t,c.scalesWithWidth=function(t,i,n){return t===e.WIDTH||t===e.MINIMUM&&i<n||t===e.MAXIMUM&&i>=n},c.xScalesWithWidth=function(t,i,n){return t===e.ASPECT||t===e.WIDTH||t===e.MINIMUM&&i<n||t===e.MAXIMUM&&i>=n},c.yScalesWithHeight=function(t,i,n){return t===e.ASPECT||t===e.HEIGHT||t===e.MINIMUM&&n<i||t===e.MAXIMUM&&n>=i},c.getKeyCodeOf=function(e){return e?"#"===e[0]?parseInt(e.slice(1),10):l[e]:-1},c.getKeyOfCode=function(e){var t;for(t in l)if(l[t]===e)return t;return"#"+e},c.arraysEqual=function(e,t){var i,n;if(!t)return!1;if(e.length!==t.length)return!1;for(i=0,n=e.length;i<n;i++)if(e[i]instanceof Array&&t[i]instanceof Array){if(!e[i].equals(t[i]))return!1}else if(e[i]!==t[i])return!1;return!0},c.objectsEqual=function(e,t){var i,n,s;if(null===e&&null===t)return!0;if(!e)return!1;if(i=Object.keys(e).sort(),!t)return!1;if(n=Object.keys(t).sort(),i.length!==n.length)return!1;for(s=0;s<i.length;s++)if(i[s]!==n[s]||e[i[s]]!==t[n[s]])return!1;return!0},c.equivalent=function(e,t){var i,n,s,o;if("object"==typeof e&&"object"==typeof t){if(null===e||null===t)return e===t;if(e instanceof Array&&t instanceof Array){if(e.length!==t.length)return!1;for(i=0,n=e.length;i<n;i++)if(!c.equivalent(e[i],t[i]))return!1;return!0}if(s=Object.keys(e).sort(),o=Object.keys(t).sort(),s.length!==o.length)return!1;for(i=0,n=s.length;i<n;i++)if(s[i]!==o[i]||!c.equivalent(e[s[i]],t[o[i]]))return!1;return!0}return e===t},c.shallowCopy=function(e){var t,i,n;if("object"==typeof e){if(e instanceof Array)return e.slice();for(t={},n=Object.keys(e),i=0;i<n.length;i++)t[n[i]]=e[n[i]];return t}return e},c.deepCopy=function(e){var t,i,n;if("object"==typeof e){if(e instanceof Array){for(t=[],i=0;i<e.length;i++)t.push(c.deepCopy(e[i]));return t}for(t={},n=Object.keys(e),i=0;i<n.length;i++)t[n[i]]=c.deepCopy(e[n[i]]);return t}return e},c.removeFromArray=function(e,t){var i=e.indexOf(t);return i>=0&&(e.splice(i,1),!0)},c.getSafeEnumValue=function(e,t,i){var n;i=i?c.getSafeEnumValue(e,i):null;for(n in e)if(e.hasOwnProperty(n)&&t===e[n])return t;return i||null},c.getSafeEnumValueForKey=function(e,t,i){return i=void 0!==i?c.getSafeEnumValue(e,i):null,t&&(t=c.constantName(t),e.hasOwnProperty(t))?e[t]:void 0!==i?i:null},c.getEnumValues=function(e){var t,i=[];for(t in e)e.hasOwnProperty(t)&&i.push(e[t]);return i},c.getEnumKeys=function(e){var t,i=Object.keys(e);for(t=0;t<i.length;t++)i[t]=c.camelCase(i[t]);return i},c.getEnumObject=function(e){var t,i={};for(t=0;t<e.length;t++)i[e[t]]=e[t];return i},c.getKeyOfValue=function(e,t){var i;for(i in e)if(e.hasOwnProperty(i)&&e[i]===t)return i;return null},c.getPaddedStringForNumber=function(e,t,i){var n,s=e.toString(i||10);for(n=s.length;n<t;n++)s="0"+s;return s},c.getDelimitedStringForNumber=function(e){return e>=1e3?c.getDelimitedStringForNumber(Math.floor(e/1e3))+" "+c.getPaddedStringForNumber(e%1e3,3):e.toString()},c.getLengthString=function(e,t){return e<2e3?e<100&&!t?e.toPrecision(3)+" m":Math.round(e)+" m":e<1e5?(e/1e3).toPrecision(3)+" km":c.getDelimitedStringForNumber(Math.round(e/1e3))+" km"},c.getMassString=function(e){return e<2e3?e<100?e.toPrecision(3)+" kg":Math.round(e)+" kg":e<1e5?(e/1e3).toPrecision(3)+" t":c.getDelimitedStringForNumber(Math.round(e/1e3))+" t"},c.getTimeString=function(e){return e<1e3?e+" ms":e<6e4?Math.round(e/10)/100+" s":c.formatTimeToMinutes(e)},c.getFileSizeString=function(e){return e<2048?e+" B":e<2097152?(e/1024).toFixed(1)+" KiB":(e/1024*1024).toFixed(1)+" MiB"},c.constantName=function(e){var t,i="";for(t=0;t<e.length;t++)e[t].match(/[A-Z]/)&&(i+="_"),i+=" "===e[t]||"-"===e[t]?"_":e[t].toUpperCase();return i},c.camelCase=function(e){var t,i="",n=!1;for(t=0;t<e.length;t++)"_"===e[t]?n=!0:(i+=n?e[t]:e[t].toLowerCase(),n=!1);return i},c.formatString=function(e,t){var i,n=e.toString();for(i in t)t.hasOwnProperty(i)&&(n=n.replace(new RegExp("\\{"+i+"\\}","gi"),t[i]));return n},c.formatTimeToMinutes=function(e){var t,i;return t=Math.floor(e/6e4),i=Math.floor(e/1e3)%60,c.getPaddedStringForNumber(t,2)+":"+c.getPaddedStringForNumber(i,2)},c.formatTimeToSeconds=function(e){var t,i;return t=Math.floor(e/1e3)%60,i=Math.floor(e%1e3/10),c.getPaddedStringForNumber(t,2)+"."+c.getPaddedStringForNumber(i,2)},c.executeAsync=function(e){setTimeout(e,0)},c.pointInRect=function(e,t,i,n,s,o){return e>=i&&e<=s&&t>=n&&t<=o},c.getFilenameWithoutExtension=function(e){var t=e.lastIndexOf("."),i=e.lastIndexOf("/");return e=t>0?e.substr(0,t):e,e=i>0?e.substr(i+1):e},c.getLinearMix=function(e,t,i){return e*(1-i)+t*i},c.getMixedColor=function(e,t,i){var n=1-i;return[e[0]*n+t[0]*i,e[1]*n+t[1]*i,e[2]*n+t[2]*i,e[3]*n+t[3]*i]},c.getLuminance=function(e){return.299*e[0]+.587*e[1]+.114*e[2]},c.filterColor=function(e,t){return e[0]*=t[0],e[1]*=t[1],e[2]*=t[2],e[3]*=t[3],e},c.gammaCorrect=function(e,t){return e[0]=Math.pow(e[0],1/t),e[1]=Math.pow(e[1],1/t),e[2]=Math.pow(e[2],1/t),e},c.getCSSColor=function(e){return"rgba("+Math.round(255*e[0])+","+Math.round(255*e[1])+","+Math.round(255*e[2])+","+e[3]+")"},c.getHexColor=function(e){return"#"+c.getPaddedStringForNumber(Math.round(255*e[0]),2,16)+c.getPaddedStringForNumber(Math.round(255*e[1]),2,16)+c.getPaddedStringForNumber(Math.round(255*e[2]),2,16)},c.getColor3FromHex=function(e){var t=[0,0,0];return t[0]=parseInt(e.substr(1,2),16)/255,t[1]=parseInt(e.substr(3,2),16)/255,t[2]=parseInt(e.substr(5,2),16)/255,t},c.isHexString=function(e){var t;for(t=0;t<e.length;t++)if(isNaN(parseInt(e[t],16)))return!1;return!0},c.getGreaterSolutionOfQuadraticEquation=function(e,t,i){var n=t*t-4*e*i;return n>=0?(Math.sqrt(n)-t)/(2*e):NaN},c.getSmallestPositiveSolutionOf4thDegreeEquationWithoutDegree3=function(e,t,i,n){var s,o,r,a,l,c,h,u,d,p,_,g,m=t/e,f=i/e,S=n/e,T=-m*m/48-S/4,y=-m*m*m/864-f*f/64+m*S/24,E=y*y/4+T*T*T/27;return E>=0?0===f&&m>0&&S===m*m/4?NaN:(s=Math.sqrt(E),o=Math.cbrt(-y/2+s),r=Math.cbrt(-y/2-s),l=m/6+2*(o+r),a=Math.sqrt(-m/3-(o+r)+Math.sqrt(l*l-S)),l=(f>0?-1:1)*Math.sqrt(-m/6+o+r),c=l+a,h=l-a,c<0?h:h<0?c:Math.min(c,h)):(l=2*Math.sqrt(-T/3),a=1/3*Math.acos(-y/2/Math.sqrt(-Math.pow(T/3,3))),u=-m/6+l*Math.cos(a),d=-m/6+l*Math.cos(2*Math.PI/3+a),p=-m/6+l*Math.cos(4*Math.PI/3+a),S>m*m/4||m>0?NaN:(l=(f>0?-1:1)*Math.sqrt(u),d=Math.sqrt(d),p=Math.sqrt(p),a=d+p,c=l+a,h=l-a,a=d-p,_=-l+a,g=-l-a,c<0?h<0?_<0?g<0?NaN:g:g<0?_:Math.min(_,g):_<0?g<0?h:Math.min(h,g):g<0?Math.min(h,_):Math.min(h,_,g):h<0?_<0?g<0?c:Math.min(c,g):g<0?Math.min(c,_):Math.min(c,_,g):_<0?g<0?Math.min(c,h):Math.min(c,h,g):g<0?Math.min(c,h,_):Math.min(c,h,_,g)))},c.areTouchEventsSupported=function(){return"ontouchstart"in window},c}),define("modules/application",[],function(){"use strict";function log(e,t){(!t||t<=r)&&console.log(e)}var e,t,i,n={CRITICAL:"critical",SEVERE:"severe",MINOR:"minor"},s=null,o=!0,r=0,a="",l=!0,c="web",h=!1;return{ErrorSeverity:n,getFolder:function(e){return e.length>0&&"/"===e[e.length-1]?e:s?void 0!==s[e]?s[e]:(this.showError("Asked for folder for file type '"+e+"', and folder for such files is not registered!",n.SEVERE),null):(this.log("Looking for the folder assigned to file type '"+e+"', but there are no folders specified in the application configuration. Will use the folder with the same name as the file type."),e+"/")},setFolders:function(e){var t="",i=function(t,s,o){var r=-1,a=-1,l="",c="";for(o=o||[];t.indexOf("{{")>=0;){if(!(t.indexOf("}}")>=0))return this.showError("Invalid folder name specified! Cannot resolve: '"+t+"'",n.SEVERE,"References to other folders must be surrounded by {{ and }}."),null;if(r=t.indexOf("{{"),a=t.indexOf("}}"),c=t.substring(r+2,a),!(l=e[c]))return this.showError("Invalid folder name specified! Cannot find referenced folder '"+t.substring(r+2,a)+"' in "+t+"!",n.SEVERE),null;if(!(o.indexOf(c)<0))return this.showError("Circular reference detected among the following folders: "+o.concat(s).join(", "),n.SEVERE),null;t=t.replace(t.substring(r,Math.min(a+3,t.length)),i(l,c,o.concat(s)))}return t}.bind(this);s={};for(t in e)e.hasOwnProperty(t)&&(s[t]=i(e[t],t))},setFileCacheBypassEnabled:function(e){o=e},setLogVerbosity:function(e){r=e},getVersion:function(){return a},getPlatform:function(){return c},getVersionURLArg:function(){return"v="+this.getVersion().split(" ")[0]},setVersion:function(e){a=e,requirejs.config({urlArgs:this.getVersionURLArg()})},setPlatform:function(e){c=h?"web"!==e?e:"electron":"web"},setPreviouslyRunVersion:function(i){e=i,t=void 0===e},isFirstRun:function(){return t},hasVersionChanged:function(){if(void 0!==t)return e!==a;this.showError("Cannot determine whether the game version has changed, because the previously ran version is not set!")},isDebugVersion:function(){return l},setDebugVersion:function(e){l=e},setReleases:function(e){i=e},getNewReleases:function(t){var n,s=[];for(n=0;n<i.length;n++)(t&&!e||e&&i[n]>e.substr(0,5))&&s.push(i[n]);return s},usesElectron:function(){return h},useElectron:function(e){h=e},getFileURL:function(e,t){return this.getFolder(e)+(t+(o||!this.getVersion()?"?t="+performance.now():"?"+this.getVersionURLArg()))},showError:function(e,t,i){var s="Error: "+e+(i?"\n\n"+i+"\n\n":"\n\n");switch(t){case n.CRITICAL:s+="Unfortunately this is a critical error.\nThe application is not functional until this error is resolved.";break;case n.SEVERE:s+="This is a severe error.\nThe application might produce unexpected behaviour from this point on. It is recommended that you restart the application by refreshing the page in your browser.";break;case n.MINOR:s+="This is a minor error.\nThe application might be fully functional, but you might need to readjust some settings or take some other actions depending on the explanation of the error.";break;default:s+="The severity of this error cannot be determined.\nThe application might produce unexpected behaviour from this point on. It is recommended that you restart the application by refreshing the page in your browser."}alert(s)},log:log,log_DEBUG:log,requestFile:function(e,t,i,s,o){this.log("Requesting file: '"+t+"' from "+(""!==this.getFolder(e)?"folder: '"+this.getFolder(e):"root folder")+"'...",2);var r=new XMLHttpRequest;r.onload=function(){this.log("File: '"+t+"' successfully loaded.",2),i(r)}.bind(this),r.onerror=function(){this.showError("An error occured while trying to load file: '"+t+"'.",n.SEVERE,"The status of the request was: '"+r.statusText+"' when the error happened."),i()}.bind(this),r.ontimeout=function(){this.showError("Request to load the file: '"+t+"' timed out.",n.SEVERE),i()}.bind(this),s&&r.overrideMimeType(s),o&&(r.responseType=o),r.open("GET",this.getFileURL(e,t),!0),r.send(null)},requestTextFile:function(e,t,i,n){this.requestFile(e,t,function(e){i(e?e.responseText:null)},n||"text/plain; charset=utf-8")},requestCSSFile:function(e,t,i){var n;0===document.head.querySelectorAll("link[href='"+this.getFileURL(e,t)+"']").length?(n=document.createElement("link"),n.setAttribute("rel","stylesheet"),n.setAttribute("type","text/css"),n.onload=i,n.href=this.getFileURL(e,t),document.head.appendChild(n)):i&&i()}}}),define("utils/types",["utils/utils","modules/application"],function(e,t){"use strict";function _getCheckFailErrorMessage(e,t,i,n){return"Invalid value for '"+e+"' ("+t+")"+(n?": "+n:".")+" Using default value "+i+" instead."}function _showCheckFailError(e,i,n,s){t.showError(_getCheckFailErrorMessage(e,i,n,s))}function _getTypeError(e,t,i,n){return"Invalid value for '"+t+"'. Expected "+e+", got a(n) "+("object"==typeof i?i.constructor.name:typeof i)+" ("+i+"). Using default value "+(n instanceof Array?"["+n.join(", ")+"]":"'"+n+"'")+" instead."}function _showTypeError(e,i,n,s){t.showError(_getTypeError(e,i,n,s))}function _getEnumValueError(t,i,n,s){return"Unrecognized '"+t+"' value: '"+i+"'. Possible values are are: "+e.getEnumValues(n).join(", ")+". Default value '"+s+"' will be used instead."}function _showEnumValueError(e,i,n,s){t.showError(_getEnumValueError(e,i,n,s))}var i={CHECK_FAIL_ERROR:"checkFailError",TYPE_ERROR:"typeError",ENUM_VALUE_ERROR:"enumValueError",INVALID_ENUM_OBJECT_ERROR:"invalidEnumObjectError"},n={Errors:i};return n.NUMBER="number",n.VECTOR2={baseType:"array",length:2,elementType:"number"},n.VECTOR3={baseType:"array",length:3,elementType:"number"},n.COLOR3={baseType:"array",length:3,elementType:"number",elementTypeParams:{range:[0,1]}},n.COLOR4={baseType:"array",length:4,elementType:"number",elementTypeParams:{range:[0,1]}},n.DURATION={baseType:"number",range:[0,void 0]},n.ANGLE_DEGREES={baseType:"number",range:[-360,360]},n.getBooleanValue=function(e,t){if(t=t||{},t.name=t.name||"unnamed boolean","boolean"==typeof e){if(!t.checkFunction||t.checkFunction(e,t.parentObject))return e;t.error=i.CHECK_FAIL_ERROR,t.silentFallback?(t.name,t.defaultValue,t.checkFailMessage):_showCheckFailError(t.name,e,t.defaultValue,t.checkFailMessage)}else t.error=i.TYPE_ERROR,t.silentFallback?(t.name,t.defaultValue):_showTypeError("a boolean",t.name,e,t.defaultValue);return null!==t.defaultValue?(e=t.defaultValue,t.defaultValue=null,n.getBooleanValue(e,t)):null},n.getNumberValue=function(e,t,i,s,o,r,a){return"number"==typeof t?s&&!s(t,r)?(_showCheckFailError(e,t,i,o),null!==i?n.getNumberValue(e,i,null,s,o,r):null):t:("number"==typeof i&&a||_showTypeError("a number",e,t,i),null!==i?n.getNumberValue(e,i,null,s,o,r):null)},n.getNumberValueInRange=function(e,i,s,o,r,a,l,c){return"number"==typeof i?((void 0!==s&&i<s||void 0!==o&&i>o)&&(t.showError("Invalid value for "+e+": out of range ("+(void 0!==s?s:"...")+"-"+(void 0!==o?o:"...")+"). The setting will be changed to fit the valid range."),void 0!==s&&(i=Math.max(s,i)),void 0!==o&&(i=Math.min(i,o))),a&&!a(i,c)?(_showCheckFailError(e,i,r,l),null!==r?n.getNumberValueInRange(e,r,s,o,null,a,l,c):null):i):(_showTypeError("a number",e,i,r),null!==r?n.getNumberValueInRange(e,r,s,o,null,a,l,c):null)},n.getStringValue=function(e,t,i,s,o,r){return"string"==typeof t?s&&!s(t,r)?(_showCheckFailError(e,t,i,o),null!==i?n.getStringValue(e,i,null,s,o,r):null):t:(_showTypeError("a string",e,t,i),null!==i?n.getStringValue(e,i,null,s,o,r):null)},n.getEnumValue=function(s,o,r){var a=e.getSafeEnumValue(s,o);if(r=r||{},r.name=r.name||"unnamed enum "+s.constructor.name,null!==a){if(!r.checkFunction||r.checkFunction(a,r.parentObject))return a;r.error=i.CHECK_FAIL_ERROR,r.silentFallback?(r.name,r.defaultValue,r.checkFailMessage):_showCheckFailError(r.name,a,r.defaultValue,r.checkFailMessage)}else{if("object"!=typeof s||0===Object.keys(s).length)return r.error=i.INVALID_ENUM_OBJECT_ERROR,t.showError("Invalid enum object specified for "+r.name+": "+s+", and thus its value ("+o+") cannot be verified!"),null;r.error=i.ENUM_VALUE_ERROR,r.silentFallback?(r.name,r.defaultValue):_showEnumValueError(r.name,o,s,r.defaultValue)}return null!==r.defaultValue?(o=r.defaultValue,r.defaultValue=null,n.getEnumValue(s,o,r)):null},n.getObjectValue=function(e,t,i,s,o,r){return"object"==typeof t?s&&!s(t,r)?(_showCheckFailError(e,t,i,o),null!==i?n.getObjectValue(e,i,null,s,o,r):null):t:(_showTypeError("an object",e,t,i),null!==i?n.getObjectValue(e,i,null,s,o,r):null)},n.getValueOfType=function(e,i,s,o,r,a,l,c,h){if(a=a||{},void 0===s)return void 0!==o?null!==o?n.getValueOfType(e,i,o,null,r,a,l,c,h):null:void(r||t.showError("Missing required value of '"+e+"'!"));if("object"==typeof i)return i.baseType?n.getValueOfType(e,i.baseType,s,o,r,i,l,c,h):n.getVerifiedObject(e,s,i);switch(i){case"boolean":return n.getBooleanValue(s,{name:e,defaultValue:o,checkFunction:l,checkFailMessage:c,parentObject:h});case"number":return a.range?n.getNumberValueInRange(e,s,a.range[0],a.range[1],o,l,c,h):n.getNumberValue(e,s,o,l,c,h);case"string":return n.getStringValue(e,s,o,l,c,h);case"enum":return a.values?n.getEnumValue(a.values,s,{name:e,defaultValue:o,checkFunction:l,checkFailMessage:c,parentObject:h}):(t.showError("Missing enum definition object for '"+e+"'!"),null);case"object":return a.properties?n.getVerifiedObject(e,s,a.properties):n.getObjectValue(e,s,o,l,c,h);case"array":return n.getArrayValue(e,s,a.elementType,a.elementTypeParams,a,o,l,c,a.elementCheck,a.elementCheckFailMessage,h);default:return t.showError("Unknown type specified for '"+e+"': "+i),null}},n.getArrayValue=function(e,i,s,o,r,a,l,c,h,u,d){var p,_=[];if(i instanceof Array){if(void 0!==r){if(void 0!==r.length&&i.length!==r.length)return t.showError("Invalid array length for '"+e+"'! Expected a length of "+r.length+" and got "+i.length+(a?". Using default value ["+a.join(", ")+"] instead.":".")),a?n.getArrayValue(e,a,s,o,r,null,l,c,h,u,d):null;if(void 0!==r.minLength&&i.length<r.minLength)return t.showError("Invalid array length for '"+e+"'! Expected a minimum length of "+r.minLength+" and got "+i.length+(a?". Using default value ["+a.join(", ")+"] instead.":".")),a?n.getArrayValue(e,a,s,o,r,null,l,c,h,u,d):null;if(void 0!==r.maxLength&&i.length>r.maxLength)return t.showError("Invalid array length for '"+e+"'! Expected a maximum length of "+r.maxLength+" and got "+i.length+(a?". Using default value ["+a.join(", ")+"] instead.":".")),a?n.getArrayValue(e,a,s,o,r,null,l,c,h,u,d):null}return void 0!==s&&(i.forEach(function(t,i){null!==(p=n.getValueOfType(e+"["+i+"]",s,t,null,!1,o,h,u,d))&&_.push(p)}),i=_),l&&!l(i)?(_showCheckFailError(e,i,"["+a.join(", ")+"]",c),null!==a?n.getArrayValue(e,a,s,o,r,null,l,c,h,u,d):null):i}return _showTypeError("an array",e,i,a),null!==a?n.getArrayValue(e,a,s,o,r,null,l,c,h,u,d):null},n.getVerifiedObject=function(e,i,s,o,r,a,l){var c,h,u,d,p,_,g=o||{},m=[];if("object"==typeof i){for(h in s)if(s.hasOwnProperty(h)){if(u=s[h],g[u.name]&&t.showError("'"+e+"' already has a property named '"+u.name+"', which will be overridden by a new value!"),!u.type&&!l)for(d={},_=Object.keys(u),p=0;p<_.length;p++)"object"==typeof u[_[p]]&&(d[_[p]]=u[_[p]]);g[u.name]=n.getValueOfType(e+"."+u.name,u.type||d||l,i[u.name],u.defaultValue,u.optional,{range:u.range,values:u.values,elementType:u.elementType,elementEnumObject:u.elementEnum,length:u.length,minLength:u.minLength,maxLength:u.maxLength,elementCheck:u.elementCheck,elementCheckFailMessage:u.elementCheckFailMessage,properties:u.properties},u.check,u.checkFailMessage,i),m.push(u.name)}if(r)for(c in i)i.hasOwnProperty(c)&&m.indexOf(c)<0&&r&&(g[c]=l?n.getValueOfType(e+"."+c,l,i[c]):i[c]);return g}return t.showError("Invalid value for '"+e+"'. Expected an object, got a(n) "+typeof i+" ("+i+")."),null},n.getBooleanValueFromLocalStorage=function(e,t){var i;return i=localStorage[e]===(!0).toString()||localStorage[e]!==(!1).toString()&&localStorage[e],t=t||{},t.name=t.name||"localStorage."+e,n.getBooleanValue(i,t)},n.getNumberValueFromLocalStorage=function(e,t){var i=parseFloat(localStorage[e]);return isNaN(i)&&(i=localStorage[e]),t=t||{},t.name=t.name||"localStorage."+e,n.getNumberValue(t.name,i,t.defaultValue,t.checkFunction,t.checkFailMessage,t.parentObject,t.silentFallback)},n.getEnumValueFromLocalStorage=function(e,t,i){return i=i||{},i.name=i.name||"localStorage."+t,n.getEnumValue(e,localStorage[t],i)},n.getStringValueFromLocalStorage=function(e,t){return t=t||{},t.name=t.name||"localStorage."+e,n.getStringValue(t.name,localStorage[e],t.defaultValue,t.checkFunction,t.checkFailMessage)},n.getValueOfTypeFromLocalStorage=function(e,t,i){if("object"==typeof e)return i.values=e.values,n.getValueOfTypeFromLocalStorage(e.baseType,t,i);switch(e){case"boolean":return n.getBooleanValueFromLocalStorage(t,i);case"number":return n.getNumberValueFromLocalStorage(t,i);case"enum":return n.getEnumValueFromLocalStorage(i.values,t,i);case"string":return n.getStringValueFromLocalStorage(t,i)}},n.getNameAndValueDefinitionObject=function(e){return{baseType:"object",properties:{NAME:{name:"name",type:"string"},VALUE:{name:e,type:"number"}}}},n.getEnumObjectForArray=function(e){var t,i={};for(t=0;t<e.length;t++)i[e[t]]=e[t];return i},n}),define("modules/async-resource",[],function(){"use strict";function AsyncResource(){this._readyToUse=!1,this._onReadyQueue=[],this._triggeredOnreadyQueueLength=0}return AsyncResource.prototype.addOnReadyFunction=function(e){this._onReadyQueue.push(e)},AsyncResource.prototype.resetReadyState=function(){this._readyToUse=!1},AsyncResource.prototype.executeOnReadyQueue=function(){var e;for(this._triggeredOnreadyQueueLength=this._onReadyQueue.length,e=0;e<this._triggeredOnreadyQueueLength;e++)this._onReadyQueue[e]&&this._onReadyQueue[e].call(this),this._onReadyQueue[e]=null;this._onReadyQueue=this._onReadyQueue.length>this._triggeredOnreadyQueueLength?this._onReadyQueue.slice(this._triggeredOnreadyQueueLength):[]},AsyncResource.prototype.setToReady=function(){!1===this._readyToUse&&(this._readyToUse=!0,this.executeOnReadyQueue())},AsyncResource.prototype.executeWhenReady=function(e,t,i){return this._readyToUse?i?(setTimeout(e.bind(this),0),!1):(e.call(this),!0):(this.addOnReadyFunction(e),void 0!==t&&t.call(this),!1)},{AsyncResource:AsyncResource}}),define("modules/resource-manager",["utils/utils","modules/application","modules/async-resource"],function(e,t,i){"use strict";function GenericResource(e){i.AsyncResource.call(this),this._name=e,this._requested=!1,this._loading=!1,this._hasError=!1,this._requestParams={}}function JSONResource(e,i,s){GenericResource.call(this,e?e.name||s&&(e&&e.source||n)||t.showError("Cannot initialize instance of "+this.constructor.name+": a name is required!"):null),this._source=e?e.source||null:null,this._sourceFolder=i,this._dataJSON=e,e&&(this._source||(this._loadData(e),this.setToReady()))}function ResourceHolder(e){i.AsyncResource.call(this),this._resourceType=e,this._resources={},this._resourceNames=[],this._numLoadedResources=0,this._numRequestedResources=0}function ResourceManager(){i.AsyncResource.call(this),this._resourceHolders={},this._numLoadedResources=0,this._numRequestedResources=0,this._onResourceTypeLoadFunctionQueues={},this._onAnyResourceTypeLoadFunctionQueue=[],this._onResourceLoadFunctionQueue=[],this._resourceClasses=null,this._sourceFolder=null}var n="unnamed";return GenericResource.prototype=new i.AsyncResource,GenericResource.prototype.constructor=GenericResource,GenericResource.prototype.isRequested=function(t){if(!this._requested)return!1;if(t){if(!this._requestParams)return!1;if(!e.equivalent(this._requestParams,t))return!1}return!0},GenericResource.prototype.request=function(i){this._loading&&!e.equivalent(this._requestParams||null,i||null)?t.showError("Attempting to request resource '"+this._name+"' with different parameters while it is being loaded!"):(this._requested=!0,this._requestParams=i)},GenericResource.prototype.requiresReload=function(){t.showError("Resource class does not implement requiresReload!")},GenericResource.prototype.isLoaded=function(){return this._readyToUse},GenericResource.prototype.hasError=function(){return this._hasError},GenericResource.prototype._requestFiles=function(){t.showError("Attempting to request files for a resource type that has no file request function implemented!")},GenericResource.prototype._loadData=function(){return t.showError("Attempting to load data for a resource type that has no data loading function implemented!"),!1},GenericResource.prototype.onFinalLoad=function(){this._requested=!1,this._loading=!1,this.setToReady()},GenericResource.prototype._onFilesLoad=function(e,t){this._hasError=this._hasError||!this._loadData(t),!0===e&&this.onFinalLoad()},GenericResource.prototype.requestLoadFromFile=function(){!1===this._readyToUse&&!0===this._requested&&!1===this._loading&&(this._loading=!0,this._requestFiles(this._requestParams))},GenericResource.prototype.getData=function(){return null},JSONResource.prototype=new GenericResource,JSONResource.prototype.constructor=JSONResource,JSONResource.prototype.requiresReload=function(){return!this.isRequested()&&!this.isLoaded()},JSONResource.prototype._requestFiles=function(){t.requestTextFile(this._sourceFolder,this._source,function(e){this._onFilesLoad(!0,JSON.parse(e))}.bind(this))},JSONResource.prototype._loadData=function(e){return this._source=this._source||"",this._dataJSON=e,!0},JSONResource.prototype.getData=function(){return this._dataJSON},JSONResource.prototype.reloadData=function(){this._loadData(this._dataJSON)},ResourceHolder.prototype=new i.AsyncResource,ResourceHolder.prototype.constructor=ResourceHolder,ResourceHolder.prototype.allResourcesAreLoaded=function(){return this._numLoadedResources===this._numRequestedResources},ResourceHolder.prototype.addResource=function(e,i){var n=e._name;return this._resources[n]?t.showError("Attempting to add a resource named '"+n+"' that already exists! Data will be overwritten."):i||this._resourceNames.push(n),this._resources[n]=e,this._resources[n]},ResourceHolder.prototype.getResource=function(e,i){var n;return this._resources[e]?(n=this._resources[e],i&&i.doNotLoad||n.requiresReload(i)&&(this._numRequestedResources++,this.resetReadyState(),n.resetReadyState(),n.executeWhenReady(function(){this._numLoadedResources++,this.allResourcesAreLoaded()&&this.setToReady()}.bind(this))),n):(i&&!0===i.allowNullResult||t.showError("Requested a resource named '"+e+"' from "+this._resourceType+", which does not exist."),null)},ResourceHolder.prototype.requestResourceLoad=function(){var e;for(e in this._resources)this._resources.hasOwnProperty(e)&&this._resources[e].requestLoadFromFile()},ResourceHolder.prototype.getResourceNames=function(e){return e?Object.keys(this._resources):this._resourceNames},ResourceHolder.prototype.renameResource=function(e,t){e!==t&&(this._resources[t]=this._resources[e],delete this._resources[e],this._resourceNames[this._resourceNames.indexOf(e)]=t)},ResourceHolder.prototype.moveResourceAfter=function(e,t){this._resourceNames.splice(this._resourceNames.indexOf(e),1),this._resourceNames.splice(this._resourceNames.indexOf(t)+1,0,e)},ResourceManager.prototype=new i.AsyncResource,ResourceManager.prototype.constructor=ResourceManager,ResourceManager.prototype.setToReady=function(){this._onResourceTypeLoadFunctionQueues={},this._onAnyResourceTypeLoadFunctionQueue=[],this._onResourceLoadFunctionQueue=[],this._numRequestedResources=0,this._numLoadedResources=0,i.AsyncResource.prototype.setToReady.call(this)},ResourceManager.prototype.executeOnResourceTypeLoad=function(e,t){this._onResourceTypeLoadFunctionQueues[e]=this._onResourceTypeLoadFunctionQueues[e]||[],this._onResourceTypeLoadFunctionQueues[e].push(t)},ResourceManager.prototype.executeOnAnyResourceTypeLoad=function(e){this._onAnyResourceTypeLoadFunctionQueue.push(e)},ResourceManager.prototype.executeOnResourceLoad=function(e){this._onResourceLoadFunctionQueue.push(e)},ResourceManager.prototype.addResource=function(e,t,i){return this._resourceHolders[e]=this._resourceHolders[e]||new ResourceHolder(e),this._resourceHolders[e].addResource(t,i)},ResourceManager.prototype.createResource=function(e,i){return this._resourceClasses?this._resourceClasses[e]?void this.addResource(e,new this._resourceClasses[e](i,this._sourceFolder)):void t.showError("Cannot create resource of type '"+e+"': no resource constructor was assigned for this resource type!"):void t.showError("Cannot create resource of type '"+e+"': no resource constructors were assigned!")},ResourceManager.prototype._onResourceLoad=function(e,t){var i,n;for(n=this._onResourceLoadFunctionQueue,i=0;i<n.length;i++)n[i](t,e,this._numRequestedResources,this._numLoadedResources);if(this.allResourcesOfTypeAreLoaded(e))for(n=this._onResourceTypeLoadFunctionQueues[e]||[],i=0;i<n.length;i++)n[i]();this.allResourcesAreLoaded()&&this.setToReady()},ResourceManager.prototype.getResource=function(e,i,n){var s;return(s=this._resourceHolders[e]?this._resourceHolders[e].getResource(i,n):null)?(n&&n.doNotLoad||s.requiresReload(n)&&(this._numRequestedResources++,this.resetReadyState(),s.request(n),s.executeWhenReady(function(){this._numLoadedResources++,this._onResourceLoad(e,i)}.bind(this))),s):(n&&!0===n.allowNullResult||t.showError("Requested a resource named '"+i+"' of type '"+e+"', which does not exist."),null)},ResourceManager.prototype.requestAllResources=function(e){var t,i,n;for(t in this._resourceHolders)if(this._resourceHolders.hasOwnProperty(t))for(i=this._resourceHolders[t].getResourceNames(e),n=0;n<i.length;n++)this.getResource(t,i[n])},ResourceManager.prototype.allResourcesOfTypeAreLoaded=function(e){return this._resourceHolders[e]._readyToUse},ResourceManager.prototype.allResourcesAreLoaded=function(){return this._numLoadedResources===this._numRequestedResources},ResourceManager.prototype.requestConfigLoad=function(e,i,n,s){t.requestTextFile(i,e,function(e){this._loadConfigFromJSON(JSON.parse(e),n),s&&s()}.bind(this))},ResourceManager.prototype._loadConfigFromJSON=function(e,t){var i,n,s;this._resourceClasses=t,this._sourceFolder=e.config?e.config.sourceFolder:null;for(i in t)if(t.hasOwnProperty(i))for(n=e[i],s=0;s<n.length;s++)this.addResource(i,new t[i](n[s],this._sourceFolder))},ResourceManager.prototype.requestResourceLoad=function(){var e;if(!0===this.allResourcesAreLoaded())this.executeOnReadyQueue();else for(e in this._resourceHolders)this._resourceHolders.hasOwnProperty(e)&&this._resourceHolders[e].requestResourceLoad()},ResourceManager.prototype.getResourceTypes=function(){return Object.keys(this._resourceHolders)},ResourceManager.prototype.getResourceNames=function(e){return this._resourceHolders[e]?this._resourceHolders[e].getResourceNames():(t.showError("Asked for the names of resources of type: '"+e+"', but no such resource type exists!"),null)},ResourceManager.prototype.renameResource=function(e,t,i){this._resourceHolders[e].renameResource(t,i)},ResourceManager.prototype.moveResourceAfter=function(e,t,i){this._resourceHolders[e].moveResourceAfter(t,i)},ResourceManager.prototype.executeForAllResourcesOfType=function(e,t,i,n){var s,o;for(o=this._resourceHolders[e].getResourceNames(i),s=0;s<o.length;s++)t(this._resourceHolders[e].getResource(o[s],{doNotLoad:n}),e)},ResourceManager.prototype.executeForAllResources=function(e,t){var i,n=Object.keys(this._resourceHolders);for(i=0;i<n.length;i++)this.executeForAllResourcesOfType(n[i],e,t)},{GenericResource:GenericResource,JSONResource:JSONResource,ResourceManager:ResourceManager}}),define("modules/managed-gl",["utils/utils","utils/types","modules/application","modules/async-resource"],function(e,t,i,n){"use strict";function getFloatVectorSize(e){switch(e){case o.NONE:return 0;case o.FLOAT:return 1;case o.VEC2:return 2;case o.VEC3:return 3;case o.VEC4:case o.MAT2:return 4;case o.MAT3:return 9;case o.MAT4:return 16;case o.SAMPLER2D:case o.SAMPLER_CUBE:case o.INT:case o.BOOL:return 1;default:return i.showError("Cannot determine vector size of GLSL type '"+e+"'!"),0}}function getVectorCount(e){switch(e){case o.NONE:return 0;case o.FLOAT:case o.VEC2:case o.VEC3:case o.VEC4:return 1;case o.MAT2:return 2;case o.MAT3:return 3;case o.MAT4:return 4;case o.SAMPLER2D:case o.SAMPLER_CUBE:case o.INT:case o.BOOL:
return 1;default:return i.showError("Cannot determine vector count of GLSL type '"+e+"'!"),0}}function isSamplerType(e){return e===o.SAMPLER2D||e===o.SAMPLER_CUBE}function intValueOfBool(e){return e?1:0}function ManagedTexture(e,t,i){this._name=e,this._image=t,this._mipmap=void 0===i||i,this._ids={},this._locations={}}function ManagedCubemap(e,t){this._name=e,this._images=t,this._ids={},this._locations={}}function ShaderAttribute(e,t,i){this.name=e,this.size=t,this.role=i}function ShaderUniform(e,n,s,r){var a;if(this._name=e,this._type=t.getEnumValue(o,n,{name:"uniform "+this._name+".type",defaultValue:o.NONE}),this._arraySize=s||0,this._unpacked=r,this._unpacked&&(!isSamplerType(this._type)||this._arraySize<1)&&(i.showError("Uniform '"+this._name+"' cannot be declared as an unpacked array!"),this._unpacked=!1),this._members=this._type===o.STRUCT?[]:null,this._locations={},this._numericValues={},this._prefixes=null,this._type===o.STRUCT)if(this._prefixes=[],this._arraySize>0)for(a=0;a<this._arraySize;a++)this._prefixes.push(this._name+"["+a+"].");else this._prefixes.push(this._name+".");switch(this._setConstantValue=null,this._type){case o.FLOAT:this._arraySize>0?this._setConstantValue=this._setFloatArrayValue:this._setConstantValue=this._setFloatValue;break;case o.VEC2:this._setConstantValue=this._setVec2Value;break;case o.VEC3:this._setConstantValue=this._setVec3Value;break;case o.VEC4:this._setConstantValue=this._setVec4Value;break;case o.MAT2:this._setConstantValue=this._setMat2Value;break;case o.MAT3:this._setConstantValue=this._setMat3Value;break;case o.MAT4:this._setConstantValue=this._setMat4Value;break;case o.SAMPLER2D:case o.SAMPLER_CUBE:case o.INT:this._arraySize>0?this._unpacked?this._setConstantValue=this._setUnpackedIntArrayValue:this._setConstantValue=this._setIntArrayValue:this._setConstantValue=this._setIntValue;break;case o.BOOL:this._arraySize>0?this._setConstantValue=this._setBoolArrayValue:this._setConstantValue=this._setBoolValue;break;case o.STRUCT:this._arraySize>0?this._setConstantValue=this._setStructArrayValue:this._setConstantValue=this._setStructValue}}function VertexBuffer(e,t,i,n){this._name=e,this._role=t,this._vectorSize=i,this._data=new Float32Array(n*this._vectorSize),this._ids={},this._locations={},this._filledVectors=0,this._dirty=!1}function FrameBuffer(e,t,i,n){this._name=e,this._id=null,this._width=t,this._height=i,this._depthOnly=!!n,this._textureID=null,this._textureLocation=this.TEXTURE_LOCATION_NOT_SET,this._renderBufferID=null}function ManagedShader(e,t,n,s,o,r,a,l){this._name=e,this._blendMode=s,this._vertexAttributes=[],this._instanceAttributes=[],this._uniforms=[],this._vertexShaderSource=t,this._fragmentShaderSource=n,this._ids={},this._instanceAttributeBuffers=[],this._uniformNamesForInstanceAttributeNames=r,this._instanceAttributeNames=Object.keys(r),this._numVertexUniformVectors=0,this._numAttributeVectors=0,this._numVaryingVectors=0,this._numTextureUnits=0,this._numFragmentUniformVectors=0,this._vertexShaderSource?this._fragmentShaderSource?this._parseShaderSources(o,a,l):i.showError("Cannot initialize shader '"+this._name+"': no fragment shader source specified!"):i.showError("Cannot initialize shader '"+this._name+"': no vertex shader source specified!")}function ManagedGLContext(e,t,i,s,o,r){n.AsyncResource.call(this),this._name=e,this._canvas=t,this.gl=null,this._antialiasing=!0===i,this._alpha=void 0===s||s,this._filtering=null,this.anisotropicFilterExt=null,this.instancingExt=null,this.depthTextureExt=null,this._shaders=[],this._models=[],this._vertexBuffers=null,this._boundVertexBuffers=[],this._vertexBuffersEnabled=[],this._vertexBuffersUsed=[],this._vertexBuffersInstanced=[],this._frameBuffers={},this._hasBoundFrameBuffer=!1,this._currentShader=null,this._currentBlendMode=null,this._currentColorMask=null,this._currentDepthMask=!1,this._blendingEnabled=!1,this._textures=[],this._boundTextures=[],this._maxBoundTextures=0,this._nextTextureBindLocation=0,this._maxTextureSize=0,this._maxCubemapSize=0,this._maxRenderbufferSize=0,this._maxVertexAttributes=0,this._maxVertexShaderUniforms=0,this._maxFragmentShaderUniforms=0,this._maxVaryings=0,this._fragmentShaderHighPrecisionSupport=!1,this._createContext(r),this.setFiltering(o)}var s={BILINEAR:"bilinear",TRILINEAR:"trilinear",ANISOTROPIC:"anisotropic"},o={NONE:"none",FLOAT:"float",VEC2:"vec2",VEC3:"vec3",VEC4:"vec4",MAT2:"mat2",MAT3:"mat3",MAT4:"mat4",SAMPLER2D:"sampler2D",SAMPLER_CUBE:"samplerCube",INT:"int",BOOL:"bool",STRUCT:"struct"},r={NONE:"none",MIX:"mix",ADD:"add"},a=null;return Object.freeze(s),Object.freeze(o),ManagedTexture.prototype.getLastTextureBindLocation=function(e){return this._locations[e]},ManagedTexture.prototype.forgetLastTextureBindLocation=function(e){delete this._locations[e]},ManagedTexture.prototype.setMinFiltering=function(e,t,i){if(!1===this._mipmap)e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR);else{switch(t){case s.BILINEAR:e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_NEAREST),i&&e.texParameterf(e.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,1);break;case s.TRILINEAR:e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),i&&e.texParameterf(e.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,1);break;case s.ANISOTROPIC:e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameterf(e.TEXTURE_2D,i.TEXTURE_MAX_ANISOTROPY_EXT,4)}e.generateMipmap(e.TEXTURE_2D)}},ManagedTexture.prototype.createGLTexture=function(e,t){this._ids[e]=t.createTexture()},ManagedTexture.prototype.bindGLTexture=function(e,t,i){t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_2D,this._ids[e]),this._locations[e]=i},ManagedTexture.prototype.setupGLTexture=function(e,t,i){e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this._image),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),this.setMinFiltering(e,t,i)},ManagedTexture.prototype.deleteGLTexture=function(e,t){this._ids[e]&&(t.deleteTexture(this._ids[e]),delete this._ids[e],delete this._locations[e])},ManagedCubemap.prototype.getLastTextureBindLocation=function(e){return this._locations[e]},ManagedCubemap.prototype.forgetLastTextureBindLocation=function(e){delete this._locations[e]},ManagedCubemap.prototype.createGLTexture=function(e,t){this._ids[e]=t.createTexture()},ManagedCubemap.prototype.bindGLTexture=function(e,t,i){t.activeTexture(t.TEXTURE0+i),t.bindTexture(t.TEXTURE_CUBE_MAP,this._ids[e]),this._locations[e]=i},ManagedCubemap.prototype.setupGLTexture=function(e){var t,i;for(e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),t=[e.TEXTURE_CUBE_MAP_POSITIVE_X,e.TEXTURE_CUBE_MAP_NEGATIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Z],i=0;i<6;i++)e.texImage2D(t[i],0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this._images[i])},ManagedCubemap.prototype.deleteGLTexture=function(e,t){this._ids[e]&&(t.deleteTexture(this._ids[e]),delete this._ids[e],delete this._locations[e])},ShaderUniform.prototype.addMember=function(e){this._type===o.STRUCT?this._members.push(e):i.showError("Attempting to add a member to uniform "+this._name+", which is not of struct type!")},ShaderUniform.prototype.saveLocation=function(e,t,i,n){n=n||this._name,this._locations[e]||(this._locations[e]={}),this._locations[e][n]=t.getUniformLocation(i.getIDForContext(e),n)},ShaderUniform.prototype.forgetLocations=function(e){var t,i;if(delete this._locations[e],this._numericValues={},this._members)for(t=0;t<this._arraySize;t++)for(i=0;i<this._members.length;i++)this._members[i].forgetLocations(e)},ShaderUniform.prototype.getLocation=function(e,t,i,n,s){var o=(n||"")+this._name+(s||"");return!n&&!s||this._locations[e]&&void 0!==this._locations[e][o]||this.saveLocation(e,t,i,o),this._locations[e][o]},ShaderUniform.prototype.getArraySize=function(){return this._arraySize},ShaderUniform.prototype.getRawName=function(){var e,t=this._name;return"u_".length>0&&(e=t.split("u_"),t=e[e.length-1]),"".length>0&&(t=t.split("")[0]),t},ShaderUniform.prototype.getTextureType=function(){var e,t;if(this._type!==o.SAMPLER2D)return null;if(e=this.getRawName(),"".length>0){if(t=e.split(""),t.length<2)return null;e=t[t.length-1]}if("Texture".length>0){if(t=e.split("Texture"),t.length<2)return null;e=t[0]}return e},ShaderUniform.prototype.getCubemapName=function(){var e,t;if(this._type!==o.SAMPLER_CUBE)return null;if(e=this.getRawName(),"".length>0){if(t=e.split(""),t.length<2)return null;e=t[t.length-1]}if("Cubemap".length>0){if(t=e.split("Cubemap"),t.length<2)return null;e=t[0]}return e},ShaderUniform.prototype.getUniformName=function(e){return"u_"+e},ShaderUniform.prototype.getTextureUniformRawName=function(e){return e+"Texture"},ShaderUniform.prototype.getCubemapUniformRawName=function(e){return e+"Cubemap"},ShaderUniform.prototype._setFloatArrayValue=function(e,t,i,n,s){t.uniform1fv(this.getLocation(e,t,i,s),n)},ShaderUniform.prototype._setFloatValue=function(e,t,i,n,s){(s||this._numericValues[e]!==n)&&(t.uniform1f(this.getLocation(e,t,i,s),n),this._numericValues[e]=n)},ShaderUniform.prototype._setVec2Value=function(e,t,i,n,s){t.uniform2fv(this.getLocation(e,t,i,s),n)},ShaderUniform.prototype._setVec3Value=function(e,t,i,n,s){t.uniform3fv(this.getLocation(e,t,i,s),n)},ShaderUniform.prototype._setVec4Value=function(e,t,i,n,s){t.uniform4fv(this.getLocation(e,t,i,s),n)},ShaderUniform.prototype._setMat2Value=function(e,t,i,n,s){t.uniformMatrix2fv(this.getLocation(e,t,i,s),!1,n)},ShaderUniform.prototype._setMat3Value=function(e,t,i,n,s){t.uniformMatrix3fv(this.getLocation(e,t,i,s),!1,n)},ShaderUniform.prototype._setMat4Value=function(e,t,i,n,s){t.uniformMatrix4fv(this.getLocation(e,t,i,s),!1,n)},ShaderUniform.prototype._setUnpackedIntArrayValue=function(e,t,i,n,s){var o;for(o=0;o<n.length;o++)t.uniform1i(this.getLocation(e,t,i,s,o.toString()),n[o])},ShaderUniform.prototype._setIntArrayValue=function(e,t,i,n,s){t.uniform1iv(this.getLocation(e,t,i,s),n)},ShaderUniform.prototype._setIntValue=function(e,t,i,n,s){(s||this._numericValues[e]!==n)&&(t.uniform1i(this.getLocation(e,t,i,s),n),this._numericValues[e]=n)},ShaderUniform.prototype._setBoolArrayValue=function(e,t,i,n,s){t.uniform1iv(this.getLocation(e,t,i,s),n.map(intValueOfBool))},ShaderUniform.prototype._setBoolValue=function(e,t,i,n,s){var o=n?1:0;(s||this._numericValues[e]!==o)&&(t.uniform1i(this.getLocation(e,t,i,s),o),this._numericValues[e]=o)},ShaderUniform.prototype._setStructArrayValue=function(e,t,i,n){var s,o,r,a=this._members.length;for(s=0;s<n.length&&null!==n[s];s++)for(o=0;o<a;o++)void 0!==n[s][this._members[o]._name]&&(r=this._members[o]._name,this._members[o]._setConstantValue(e,t,i,n[s][r],this._prefixes[s]))},ShaderUniform.prototype._setStructValue=function(e,t,i,n){var s,o,r=this._members.length;for(s=0;s<r;s++)void 0!==n[this._members[s]._name]&&(o=this._members[s]._name,this._members[s]._setConstantValue(e,t,i,n[o],this._prefixes[0]))},ShaderUniform.prototype.setValue=function(e,t,i,n,s){this._setConstantValue(e,t,i,n(e),s)},ShaderUniform.prototype.getVectorCount=function(){var e,t;if(this._type===o.STRUCT){for(e=0,t=0;t<this._members.length;t++)e+=this._members[t].getVectorCount();return e*(this._arraySize||1)}return getVectorCount(this._type)*(this._arraySize||1)},ShaderUniform.prototype.isSamplerType=function(){return isSamplerType(this._type)},VertexBuffer.prototype.getRole=function(){return this._role},VertexBuffer.prototype.setData=function(e,t){this._data.set(e,t*this._vectorSize)},VertexBuffer.prototype.getSize=function(){return this._data.length/this._vectorSize},VertexBuffer.prototype.resize=function(e){this._data=new Float32Array(e*this._vectorSize)},VertexBuffer.prototype.addVector=function(e){this._data.set(e,this._filledVectors*this._vectorSize),this._filledVectors++},VertexBuffer.prototype.resetFilledVectors=function(){this._filledVectors=0},VertexBuffer.prototype.freeData=function(){this._data=null},VertexBuffer.prototype.markDirty=function(){this._dirty=!0},VertexBuffer.prototype.loadToGPUMemory=function(e,t,i){this._ids[e]=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this._ids[e]),t.bufferData(t.ARRAY_BUFFER,this._data,t.STATIC_DRAW),i||this.freeData()},VertexBuffer.prototype.bind=function(e,t,i){void 0!==this._locations[t._name]&&-1!==this._locations[t._name]||(this._locations[t._name]=e.gl.getAttribLocation(t.getIDForContext(e._name),this._name));var n=this._locations[t._name];n>=0&&((e.getBoundVertexBuffer(n)!==this||this._dirty)&&(i?this.loadToGPUMemory(e._name,e.gl,!0):e.gl.bindBuffer(e.gl.ARRAY_BUFFER,this._ids[e._name]),e.gl.vertexAttribPointer(n,this._vectorSize,e.gl.FLOAT,!1,0,0),this._dirty=!1),e.setBoundVertexBuffer(n,this,!!i))},VertexBuffer.prototype.delete=function(e){var t,i;e.gl.deleteBuffer(this._ids[e._name]);for(t in this._locations)this._locations.hasOwnProperty(t)&&(i=this._locations[t],e.getBoundVertexBuffer(i)===this&&e.setBoundVertexBuffer(i,null,!1));delete this._ids[e._name],0===Object.keys(this._ids).length&&(this.freeData(),this._locations={})},FrameBuffer.prototype.TEXTURE_LOCATION_NOT_SET=-1,FrameBuffer.prototype.getWidth=function(){return this._width},FrameBuffer.prototype.getLastTextureBindLocation=function(){return this._textureLocation},FrameBuffer.prototype.forgetLastTextureBindLocation=function(){this._textureLocation=this.TEXTURE_LOCATION_NOT_SET},FrameBuffer.prototype.setup=function(e){var t;if(!this._id)switch(this._id=e.gl.createFramebuffer(),e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,this._id),this._textureID=e.gl.createTexture(),this._textureLocation=e.bindTexture(this),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_MAG_FILTER,e.gl.NEAREST),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_MIN_FILTER,e.gl.NEAREST),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_WRAP_S,e.gl.CLAMP_TO_EDGE),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_WRAP_T,e.gl.CLAMP_TO_EDGE),this._depthOnly&&e.areDepthTexturesAvailable()?(e.gl.texImage2D(e.gl.TEXTURE_2D,0,e.gl.DEPTH_COMPONENT,this._width,this._height,0,e.gl.DEPTH_COMPONENT,e.gl.UNSIGNED_SHORT,null),e.gl.framebufferTexture2D(e.gl.FRAMEBUFFER,e.gl.DEPTH_ATTACHMENT,e.gl.TEXTURE_2D,this._textureID,0)):(e.gl.texImage2D(e.gl.TEXTURE_2D,0,e.gl.RGBA,this._width,this._height,0,e.gl.RGBA,e.gl.UNSIGNED_BYTE,null),this._renderBufferID=e.gl.createRenderbuffer(),e.gl.bindRenderbuffer(e.gl.RENDERBUFFER,this._renderBufferID),e.gl.renderbufferStorage(e.gl.RENDERBUFFER,e.gl.DEPTH_COMPONENT16,this._width,this._height),e.gl.framebufferTexture2D(e.gl.FRAMEBUFFER,e.gl.COLOR_ATTACHMENT0,e.gl.TEXTURE_2D,this._textureID,0),e.gl.framebufferRenderbuffer(e.gl.FRAMEBUFFER,e.gl.DEPTH_ATTACHMENT,e.gl.RENDERBUFFER,this._renderBufferID)),t=e.gl.checkFramebufferStatus(e.gl.FRAMEBUFFER)){case e.gl.FRAMEBUFFER_COMPLETE:break;case e.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete.");break;case e.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': Attachment missing.");break;case e.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': Height and width of the attachment are not the same.");break;case e.gl.FRAMEBUFFER_UNSUPPORTED:i.showGraphicsError("Incomplete status for framebuffer '"+this._name+"': The format of the attachment is not supported or depth and stencil attachments are not the same renderbuffer.");break;default:i.showGraphicsError("Unknown framebuffer status for '"+this._name+"' ("+t+")!")}},FrameBuffer.prototype.bind=function(e){e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,this._id)},FrameBuffer.prototype.bindGLTexture=function(e,t){e.activeTexture(e.TEXTURE0+t),e.bindTexture(e.TEXTURE_2D,this._textureID),this._textureLocation=t},FrameBuffer.prototype.delete=function(e){e.gl.deleteTexture(this._textureID),this._depthOnly&&e.areDepthTexturesAvailable()||e.gl.deleteRenderbuffer(this._renderBufferID),e.gl.deleteFramebuffer(this._id),this._id=null},ManagedShader.prototype._hasUniform=function(e){var t;for(t=0;t<this._uniforms.length;t++)if(this._uniforms[t]._name===e)return!0;return!1},ManagedShader.prototype._getUniform=function(e){var t;for(t=0;t<this._uniforms.length;t++)if(this._uniforms[t]._name===e)return this._uniforms[t];return null},ManagedShader.prototype._parseShaderSources=function(t,n,s){var r,a,l,c,h,u,d,p,_,g,m,f,S,T,y,E,C,M,I,A,x={},v={},O=function(e,t){return _.indexOf(t)<0},R=function(e){return""!==e},b=function(e){return"highp"===e||"mediump"===e||"lowp"===e},L=function(t){return e.getSafeEnumValue(o,t,o.NONE)!==o.NONE};for(c=0;c<2;c++){switch(c){case 0:h=this._vertexShaderSource.split("\n");break;case 1:h=this._fragmentShaderSource.split("\n")}for(I=!1,_=[],r=0;r<h.length;r++)if(h[r].length>0)if(u=h[r].split(/\s+|[\(\)\[\]\{\}\+\?\-!<>=*\/\^\|\&,;]/),d=h[r].match(/\s+|[\(\)\[\]\{\}\+\?\-!<>=*\/\^\|\&,;]/g),"#define"===u[0])n&&void 0!==n[u[1]]?(x[u[1]]=n[u[1]],u[2]!==n[u[1]]&&(h[r]=h[r].replace(u[2],n[u[1]]),I=!0)):x[u[1]]=u[2];else if(0===c&&"attribute"===u[0])if(p=b(u[1])?3:2,g=u[p],y=u[p-1],m=getFloatVectorSize(y),f=t[g],this._numAttributeVectors+=getVectorCount(y),void 0===f){if(!this._uniformNamesForInstanceAttributeNames.hasOwnProperty(g))return void i.showError("Role for attribute named '"+g+"' not found for shader '"+this._name+"'!");f=this._uniformNamesForInstanceAttributeNames[g],this._instanceAttributes.push(new ShaderAttribute(g,m,f))}else this._vertexAttributes.push(new ShaderAttribute(g,m,f));else if("uniform"===u[0]){if(p=b(u[1])?3:2,T=u[p],y=u[p-1],!1===this._hasUniform(T)){if("["===d[p]){if(M=!1,C=u[p+1],x[C]&&(C=x[C]),E=parseInt(C,10),isSamplerType(y)&&s){for(h[r]="",a=0;a<E;a++){for(l=0;l<p;l++)h[r]+=u[l],h[r]+=d[l];h[r]+=T+a.toString()+";\n"}I=!0,M=!0}}else E=0;L(y)?this._uniforms.push(new ShaderUniform(T,y,E,M)):(S=new ShaderUniform(T,"struct",E),function(e,t){var i,n,s,o;for(i=!1,s=0;s<h.length;s++)if(n=h[s].split(" "),i){if(n=n.filter(R),n.length>0&&"}"===n[n.length-1].split(";")[0])break;n.length>=2&&(o=b(n[0])?1:0,e.addMember(new ShaderUniform(n[o+1].split(";")[0],n[o],0)))}else"struct"===n[0]&&n[1].split("{")[0]===t&&(i=!0)}(S,y),this._uniforms.push(S))}switch(c){case 0:this._numVertexUniformVectors+=this._getUniform(T).getVectorCount();break;case 1:this._numFragmentUniformVectors+=this._getUniform(T).getVectorCount(),isSamplerType(y)&&(this._numTextureUnits+=this._getUniform(T).getVectorCount())}}else if("varying"===u[0])p=b(u[1])?3:2,y=u[p-1],1===c&&("["===d[p]?(C=u[p+1],x[C]&&(C=x[C]),E=parseInt(C,10)):E=1,this._numVaryingVectors+=getVectorCount(y)*E);else{for(p=0;""===u[p];)p++;if(L(u[p])||b(u[p]))p=b(u[p])?p+2:p+1,"["===d[p]&&(C=u[p+1],x[C]&&(C=x[C]),v[u[p]]=parseInt(C,10));else{for(a=0;a<this._uniforms.length;a++)if((p=u.indexOf(this._uniforms[a]._name))>=0&&this._uniforms[a].getArraySize()>0&&"["===d[p]){if(parseInt(u[p+1],10).toString()===u[p+1]&&parseInt(u[p+1],10)>=this._uniforms[a].getArraySize()){h[r]="",_.push(r),I=!0;break}if(this._uniforms[a].isSamplerType()&&s){for(h[r]="",l=0;l<p;l++)h[r]+=u[l],h[r]+=d[l];for(h[r]+=u[p]+u[p+1],l=p+2;l<d.length;l++)h[r]+=u[l],h[r]+=d[l];h[r]+=u[u.length-1],I=!0;break}}for(A=Object.keys(v),a=0;a<A.length;a++)if((p=u.indexOf(A[a]))>=0&&"["===d[p]&&parseInt(u[p+1],10).toString()===u[p+1]&&parseInt(u[p+1],10)>=v[u[p]]){h[r]="",_.push(r),I=!0;break}}}if(I)switch(h=h.filter(O),c){case 0:this._vertexShaderSource=h.join("\n");break;case 1:this._fragmentShaderSource=h.join("\n")}}},ManagedShader.prototype.getIDForContext=function(e){return this._ids[e]},ManagedShader.prototype.getVertexAttributes=function(){return this._vertexAttributes},ManagedShader.prototype.getVertexAttribute=function(e){var t;for(t=0;t<this._vertexAttributes.length;t++)if(this._vertexAttributes[t].name===e)return this._vertexAttributes[t];return null},ManagedShader.prototype.getInstanceAttribute=function(e){var t;for(t=0;t<this._instanceAttributes.length;t++)if(this._instanceAttributes[t].name===e)return this._instanceAttributes[t];return null},ManagedShader.prototype.setupGLProgram=function(e,t){var n,s,o,r,a;if(!this._vertexShaderSource||!this._fragmentShaderSource)return void(this._ids[e]=null);if(n=t.createShader(t.VERTEX_SHADER),t.shaderSource(n,this._vertexShaderSource),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))return s=t.getShaderInfoLog(n),i.showGraphicsError("Compiling GLSL vertex shader of '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details:\n"+s,t),void(this._ids[e]=null);if(o=t.createShader(t.FRAGMENT_SHADER),t.shaderSource(o,this._fragmentShaderSource),t.compileShader(o),!t.getShaderParameter(o,t.COMPILE_STATUS))return s=t.getShaderInfoLog(o),i.showGraphicsError("Compiling GLSL fragment shader of '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details:\n"+s,t),void(this._ids[e]=null);if(this._ids[e]=t.createProgram(),r=this._ids[e],t.attachShader(r,n),t.attachShader(r,o),t.linkProgram(r),!t.getProgramParameter(r,t.LINK_STATUS))return s=t.getProgramInfoLog(r),i.showGraphicsError("Linking GLSL shader '"+this._name+"' failed.",i.ErrorSeverity.SEVERE,"More details: "+s,t),t.deleteProgram(r),void(this._ids[e]=null);for(a=0;a<this._uniforms.length;a++)this._uniforms[a].saveLocation(e,t,this)},ManagedShader.prototype.assignUniforms=function(e,t){var i;if(t)for(i=0;i<this._uniforms.length;i++)void 0!==t[this._uniforms[i]._name]&&this._uniforms[i].setValue(e._name,e.gl,this,t[this._uniforms[i]._name])},ManagedShader.prototype.bindVertexBuffers=function(e){var t;for(e.clearVertexBufferUsage(),t=0;t<this._vertexAttributes.length;t++)e.getVertexBuffer(this._vertexAttributes[t].name).bind(e,this);e.disableUnusedVertexBuffers()},ManagedShader.prototype.getUniformArrayLength=function(e){var t;for(t=0;t<this._uniforms.length;t++)if(this._uniforms[t]._name===e)return this._uniforms[t].getArraySize();return 0},ManagedShader.prototype.getTextureTypes=function(){var e,t,i=[];for(e=0;e<this._uniforms.length;e++)(t=this._uniforms[e].getTextureType())&&i.push(t);return i},ManagedShader.prototype.getCubemapNames=function(){var e,t,i=[];for(e=0;e<this._uniforms.length;e++)(t=this._uniforms[e].getCubemapName())&&i.push(t);return i},ManagedShader.prototype.createInstanceBuffers=function(e,t){var i,n;for(this._instanceAttributeBuffers.length<e+1&&(this._instanceAttributeBuffers=this._instanceAttributeBuffers.concat(new Array(e-this._instanceAttributeBuffers.length+1))),i=0;i<this._instanceAttributeNames.length;i++)n=this._instanceAttributeNames[i],this._instanceAttributeBuffers[e]||(this._instanceAttributeBuffers[e]={}),this._instanceAttributeBuffers[e][n]?(this._instanceAttributeBuffers[e][n].resize(t),this._instanceAttributeBuffers[e][n].resetFilledVectors(),this._instanceAttributeBuffers[e][n].markDirty()):this._instanceAttributeBuffers[e][n]=new VertexBuffer(n,this._uniformNamesForInstanceAttributeNames[n],this.getInstanceAttribute(n).size,t)},ManagedShader.prototype.addDataToInstanceBuffers=function(t,i){var n,s,o;for(n=0;n<this._instanceAttributeNames.length;n++)s=this._instanceAttributeNames[n],o=this._instanceAttributeBuffers[t][s].getRole(),this._instanceAttributeBuffers[t][s].addVector(i[o](e.EMPTY_STRING))},ManagedShader.prototype.bindAndFillInstanceBuffers=function(e,t){var i;for(i=0;i<this._instanceAttributeNames.length;i++)this._instanceAttributeBuffers[t][this._instanceAttributeNames[i]].bind(e,this,!0)},ManagedShader.prototype.deleteInstanceBuffers=function(e){var t,i;for(t=0;t<this._instanceAttributeBuffers.length;t++)for(i=0;i<this._instanceAttributeNames.length;i++)this._instanceAttributeBuffers[t][this._instanceAttributeNames[i]].delete(e);this._instanceAttributeBuffers=[]},ManagedShader.prototype.deleteGLProgram=function(e,t){var i;if(this._ids[e]){for(i=0;i<this._uniforms.length;i++)this._uniforms[i].forgetLocations(e);t.deleteProgram(this._ids[e]),delete this._ids[e]}},ManagedShader.prototype.isAllowedByRequirements=function(e){return this._numAttributeVectors<=e.requiredAttributeVectors&&this._numVertexUniformVectors<=e.requiredVertexUniformVectors&&this._numVaryingVectors<=e.requiredVaryingVectors&&this._numTextureUnits<=e.requiredTextureUnits&&this._numFragmentUniformVectors<=e.requiredFragmentUniformVectors},ManagedGLContext.prototype=new n.AsyncResource,ManagedGLContext.prototype.constructor=ManagedGLContext,ManagedGLContext.prototype._createContext=function(e){var t,n;n={alpha:this._alpha,antialias:this._antialiasing};try{this.gl=this._canvas.getContext("webgl",n)}catch(e){}if(!this.gl){n.alpha=!1;try{this.gl=this._canvas.getContext("experimental-webgl",n)}catch(e){}if(!this.gl)return void i.showError("Unable to initialize WebGL.",i.ErrorSeverity.CRITICAL,"It looks like your device, browser or graphics drivers do not support web 3D graphics. Make sure your browser and graphics drivers are updated to the latest version, and you are using a modern web browser (Firefox or Chrome are recommended).\nPlease note that some phones or handheld devices do not have 3D web capabilities, even if you use the latest software.");i.showError("Your device appears to only have experimental WebGL (web based 3D) support.",void 0,"This application relies on 3D web features, and without full support, the graphics of the application might be displayed with glitches or not at all. If you experience problems, it is recommended to use lower graphics quality settings.")}t=this.gl,this._antialiasing&&!t.getContextAttributes().antialias&&(e||i.showGraphicsError("Antialiasing is enabled in graphics settings but it is not supported.",i.ErrorSeverity.MINOR,"Your graphics driver, browser or device unfortunately does not support antialiasing. To avoid this error message showing up again, disable antialiasing in the graphics settings or try running the application in a different browser. Antialiasing will not work, but otherwise this error will have no consequences.",t),this._antialiasing=!1),this._maxBoundTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._maxCubemapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._maxRenderbufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this._maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._maxVertexShaderUniforms=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentShaderUniforms=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxVaryings=t.getParameter(t.MAX_VARYING_VECTORS),this._fragmentShaderHighPrecisionSupport=!!t.getShaderPrecisionFormat&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision>0,i.log("WebGL context successfully created.\n"+this.getInfoString(),1),this.anisotropicFilterExt=t.getExtension("EXT_texture_filter_anisotropic"),null===this.anisotropicFilterExt?i.log("Anisotropic filtering not available.",1):i.log("Anisotropic filtering successfully initialized.",1),this.instancingExt=t.getExtension("ANGLE_instanced_arrays"),null===this.instancingExt?i.log("Instancing is not available, and so it will be disabled.",1):i.log("Instancing successfully initialized.",1),this.depthTextureExt=t.getExtension("WEBGL_depth_texture"),null===this.depthTextureExt?i.log("Depth textures not available, and so will be disabled.",1):i.log("Depth texture extension successfully initialized.",1),t.clearDepth(1),t.colorMask(!0,!0,!0,!0),this._currentColorMask=[!0,!0,!0,!0],t.depthMask(!0),this._currentDepthMask=!0,t.enable(t.BLEND),this._blendingEnabled=!0,t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW)},ManagedGLContext.prototype.getInfoString=function(){return this.gl?"WebGL version: "+this.gl.getParameter(this.gl.VERSION)+"\nShading language version: "+this.gl.getParameter(this.gl.SHADING_LANGUAGE_VERSION)+"\nWebGL vendor: "+this.gl.getParameter(this.gl.VENDOR)+"\nWebGL renderer: "+this.gl.getParameter(this.gl.RENDERER)+"\nAvailable vertex shader uniform vectors: "+this._maxVertexShaderUniforms+"\nAvailable vertex attributes: "+this._maxVertexAttributes+"\nAvailable texture units in vertex shaders: "+this._maxVertexTextures+"\nAvailable varying vectors: "+this._maxVaryings+"\nAvailable fragment shader uniform vectors: "+this._maxFragmentShaderUniforms+"\nAvailable texture units: "+this._maxBoundTextures+"\nMaximum texture size: "+this._maxTextureSize+"\nMaximum cubemap size: "+this._maxCubemapSize+"\nMaximum renderbuffer size: "+this._maxRenderbufferSize+"\nFragment shader high precision float support: "+(this._fragmentShaderHighPrecisionSupport?"yes":"no"):"N/A"},ManagedGLContext.prototype.isAntialiased=function(){return this._antialiasing},ManagedGLContext.prototype.getFiltering=function(){return this._filtering},ManagedGLContext.prototype.setFiltering=function(t){var i;if((t=e.getSafeEnumValue(s,t,this._filtering))!==this._filtering)for(this._filtering=t,this._filtering===s.ANISOTROPIC&&(this.anisotropicFilterExt||(this._filtering=s.TRILINEAR)),i=0;i<this._textures.length;i++)this._textures[i].setMinFiltering&&(this.bindTexture(this._textures[i],void 0,void 0,!0),this._textures[i].setMinFiltering(this.gl,this._filtering,this.anisotropicFilterExt))},ManagedGLContext.prototype.isAnisotropicFilteringAvailable=function(){return!!this.anisotropicFilterExt},ManagedGLContext.prototype.isInstancingAvailable=function(){return!!this.instancingExt},ManagedGLContext.prototype.areDepthTexturesAvailable=function(){return!!this.depthTextureExt},ManagedGLContext.prototype.setColorMask=function(e){this._currentColorMask[0]===e[0]&&this._currentColorMask[1]===e[1]&&this._currentColorMask[2]===e[2]&&this._currentColorMask[3]===e[3]||(this.gl.colorMask(e[0],e[1],e[2],e[3]),this._currentColorMask=e)},ManagedGLContext.prototype.setDepthMask=function(e){this._currentDepthMask!==e&&(this.gl.depthMask(e),this._currentDepthMask=e)},ManagedGLContext.prototype.enableBlending=function(){this._blendingEnabled||(this.gl.enable(this.gl.BLEND),this._blendingEnabled=!0)},ManagedGLContext.prototype.disableBlending=function(){this._blendingEnabled&&(this.gl.disable(this.gl.BLEND),this._blendingEnabled=!1)},ManagedGLContext.prototype.addShader=function(e){this._shaders.indexOf(e)<0&&(this._shaders.push(e),e.setupGLProgram(this._name,this.gl),this.resetReadyState())},ManagedGLContext.prototype.addModel=function(e){this._models.indexOf(e)<0&&(this._models.push(e),this.resetReadyState())},ManagedGLContext.prototype.getVertexBuffer=function(e){return this._vertexBuffers[e]},ManagedGLContext.prototype.addVertexBuffer=function(e){void 0===this._vertexBuffers[e._name]&&(this._vertexBuffers[e._name]=e)},ManagedGLContext.prototype.getBoundVertexBuffer=function(e){return this._boundVertexBuffers[e]},ManagedGLContext.prototype.setBoundVertexBuffer=function(e,t,i){this._boundVertexBuffers[e]=t,this._vertexBuffersUsed[e]=!!t,t?(this._vertexBuffersEnabled[e]||(this.gl.enableVertexAttribArray(e),this._vertexBuffersEnabled[e]=!0),this.instancingExt&&i!==this._vertexBuffersInstanced[e]&&(this.instancingExt.vertexAttribDivisorANGLE(e,i?1:0),this._vertexBuffersInstanced[e]=i)):this._vertexBuffersEnabled[e]&&(this.gl.disableVertexAttribArray(e),this._vertexBuffersEnabled[e]=!1)},ManagedGLContext.prototype.clearVertexBufferUsage=function(){var e;for(e=0;e<this._vertexBuffersUsed.length;e++)this._vertexBuffersUsed[e]=!1},ManagedGLContext.prototype.disableUnusedVertexBuffers=function(){var e
;for(e=0;e<this._vertexBuffersEnabled.length;e++)this._vertexBuffersEnabled[e]&&!this._vertexBuffersUsed[e]&&(this.gl.disableVertexAttribArray(e),this._vertexBuffersEnabled[e]=!1)},ManagedGLContext.prototype.setVertexBufferData=function(e,t){var i;for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&void 0!==e[this._vertexBuffers[i].getRole()]&&this._vertexBuffers[i].setData(e[this._vertexBuffers[i].getRole()],t)},ManagedGLContext.prototype.setupVertexBuffers=function(){var e,t,i,n,s,o;if(!0!==this._readyToUse){for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&this._vertexBuffers[i].delete(this);for(n=0,e=0;e<this._models.length;e++)n+=this._models[e].getBufferSize(this);for(this._vertexBuffers={},e=0;e<this._shaders.length;e++)for(s=this._shaders[e].getVertexAttributes(),t=0;t<s.length;t++)this.addVertexBuffer(new VertexBuffer(s[t].name,s[t].role,s[t].size,n));for(o=0,e=0;e<this._models.length;e++)for(t=this._models[e]._minLOD;t<=this._models[e].getMaxLOD();t++)o+=this._models[e].loadToVertexBuffers(this,o,t);for(i in this._vertexBuffers)this._vertexBuffers.hasOwnProperty(i)&&this._vertexBuffers[i].loadToGPUMemory(this._name,this.gl);for(this._currentShader=null,e=0;e<this._shaders.length;e++)this.setCurrentShader(this._shaders[e])}},ManagedGLContext.prototype.getFrameBuffer=function(e){return this._frameBuffers[e]},ManagedGLContext.prototype.addFrameBuffer=function(e,t){(void 0===this._frameBuffers[e._name]||t)&&(this._frameBuffers[e._name]=e,this._readyToUse&&this._frameBuffers[e._name].setup(this))},ManagedGLContext.prototype.setupFrameBuffers=function(){var e;if(!this._readyToUse)for(e in this._frameBuffers)this._frameBuffers.hasOwnProperty(e)&&this._frameBuffers[e].setup(this)},ManagedGLContext.prototype.clearFrameBuffers=function(){var e;for(e in this._frameBuffers)this._frameBuffers.hasOwnProperty(e)&&this._frameBuffers[e].delete(this);this._frameBuffers={}},ManagedGLContext.prototype.setup=function(){this.setupVertexBuffers(),this.setupFrameBuffers(),this.setToReady()},ManagedGLContext.prototype.clear=function(){var e;for(this.clearFrameBuffers(),this._currentShader=null,e=0;e<this._boundTextures.length;e++)this.unbindTexture(this._boundTextures[e].texture);for(this._boundTextures=[],e=0;e<this._textures.length;e++)this._textures[e].forgetLastTextureBindLocation(this._name);for(e=0;e<this._boundVertexBuffers.length;e++)this.gl.disableVertexAttribArray(e);this._boundVertexBuffers.length=0,this._vertexBuffersUsed.length=0,this._vertexBuffersEnabled.length=0,this._vertexBuffersInstanced.length=0},ManagedGLContext.prototype.removeShaders=function(){var e;for(e=0;e<this._shaders.length;e++)this._shaders[e].deleteInstanceBuffers(this),this._shaders[e].deleteGLProgram(this._name,this.gl);this._shaders=[],this._currentShader=null},ManagedGLContext.prototype.setCurrentFrameBuffer=function(e){e?(this._frameBuffers[e].bind(this),this._hasBoundFrameBuffer=!0):this._hasBoundFrameBuffer&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this._hasBoundFrameBuffer=!1)},ManagedGLContext.prototype.getCurrentShader=function(){return this._currentShader},ManagedGLContext.prototype.setCurrentShader=function(e){var t,i;if(this._currentShader!==e){if(i=e.getIDForContext(this._name)){switch(this.gl.useProgram(i),t=e._blendMode){case r.MIX:this._currentBlendMode!==t&&(this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this._currentBlendMode=t);break;case r.ADD:this._currentBlendMode!==t&&(this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE),this._currentBlendMode=t)}return e.bindVertexBuffers(this),this._currentShader=e,!0}this._currentShader=null}return!1},ManagedGLContext.prototype.addTexture=function(e){this._textures.indexOf(e)<0&&(this._textures.push(e),e.createGLTexture(this._name,this.gl),this.bindTexture(e),e.setupGLTexture(this.gl,this._filtering,this.anisotropicFilterExt))},ManagedGLContext.prototype.bindTexture=function(e,t,n,s){var o=void 0!==t||n;if(void 0===t&&(void 0===(t=e.getLastTextureBindLocation(this._name))||t===FrameBuffer.prototype.TEXTURE_LOCATION_NOT_SET||this._boundTextures[t].texture!==e)){for(t=0;t<this._maxBoundTextures&&t<this._boundTextures.length&&this._boundTextures[t];)t++;if(t===this._maxBoundTextures){for(;this._boundTextures[this._nextTextureBindLocation].reserved;)this._nextTextureBindLocation=(this._nextTextureBindLocation+1)%this._maxBoundTextures;t=this._nextTextureBindLocation,this._nextTextureBindLocation=(this._nextTextureBindLocation+1)%this._maxBoundTextures}}return this._boundTextures[t]&&this._boundTextures[t].texture===e&&!s||(e instanceof ManagedTexture?e.bindGLTexture(this._name,this.gl,t):e instanceof ManagedCubemap?e.bindGLTexture(this._name,this.gl,t):e instanceof FrameBuffer?e.bindGLTexture(this.gl,t):i.showError("Cannot set object: '"+e.toString()+"' as current texture, because it is not of an appropriate type."),this._boundTextures[t]={texture:e,reserved:o}),this._boundTextures[t].reserved!==o&&(this._boundTextures[t].reserved=o),t},ManagedGLContext.prototype.unbindTexture=function(e){var t=e&&e.getLastTextureBindLocation(this._name);void 0!==t&&t>=0&&this._boundTextures[t]===e&&(this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,null),this._boundTextures[t]=null,e.forgetLastTextureBindLocation(this._name))},ManagedGLContext.prototype.removeTexture=function(e){var t=this._textures.indexOf(e);t>=0&&(this.unbindTexture(e),e.deleteGLTexture(this._name,this.gl),this._textures.splice(t,1))},ManagedGLContext.prototype.satisfiesRequirements=function(e){return this._maxVertexAttributes>=e.requiredAttributeVectors&&this._maxVertexShaderUniforms>=e.requiredVertexUniformVectors&&this._maxVaryings>=e.requiredVaryingVectors&&this._maxFragmentShaderUniforms>=e.requiredFragmentUniformVectors&&this._maxBoundTextures>=e.requiredTextureUnits&&(!e.fragmentShaderHighPrecision||this._fragmentShaderHighPrecisionSupport)},ManagedGLContext.prototype.getMaxTextureSize=function(){return this._maxTextureSize},ManagedGLContext.prototype.getMaxCubemapSize=function(){return this._maxCubemapSize},ManagedGLContext.prototype.getMaxRenderbufferSize=function(){return this._maxRenderbufferSize},i.showGraphicsError=function(e,t,n){i.showError(e,t,(n?n+"\n\n":"")+"This is a graphics related error.\nInformation about your graphics support:\n"+a.getInfoString())},a=new ManagedGLContext("",document.createElement("canvas"),!0,!0,s.BILINEAR,!0),{TextureFiltering:s,ShaderVariableType:o,ShaderBlendMode:r,getUniformName:ShaderUniform.prototype.getUniformName,getTextureUniformRawName:ShaderUniform.prototype.getTextureUniformRawName,getCubemapUniformRawName:ShaderUniform.prototype.getCubemapUniformRawName,ManagedTexture:ManagedTexture,ManagedCubemap:ManagedCubemap,ManagedShader:ManagedShader,FrameBuffer:FrameBuffer,ManagedGLContext:ManagedGLContext,requirementsAreSatisfied:a.satisfiesRequirements.bind(a),getMaxTextureSize:a.getMaxTextureSize.bind(a),getMaxCubemapSize:a.getMaxCubemapSize.bind(a),getMaxRenderbufferSize:a.getMaxRenderbufferSize.bind(a),isAntialiasingAvailable:a.isAntialiased.bind(a),isAnisotropicFilteringAvailable:a.isAnisotropicFilteringAvailable.bind(a),isInstancingAvailable:a.isInstancingAvailable.bind(a),areDepthTexturesAvailable:a.areDepthTexturesAvailable.bind(a)}}),define("utils/vectors",[],function(){"use strict";var e={},t=[],i=0,n=new Float32Array([0,0,0]);return e.NULL3=[0,0,0],Object.freeze(e.NULL3),e.NULL4=[0,0,0,0],Object.freeze(e.NULL4),e.NULL4W1=[0,0,0,1],Object.freeze(e.NULL4W1),e.UNIT2_X=[1,0],Object.freeze(e.UNIT2_X),e.UNIT2_Y=[0,1],Object.freeze(e.UNIT2_Y),e.UNIT3_X=[1,0,0],Object.freeze(e.UNIT3_X),e.UNIT3_Y=[0,1,0],Object.freeze(e.UNIT3_Y),e.UNIT3_Z=[0,0,1],Object.freeze(e.UNIT3_Z),e.perpendicular3=function(e){return[e[1],-e[0],0]},e.floatVector3Aux=function(e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n},e.length3=function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])},e.length3Squared=function(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]},e.toString3=function(e,t){return t=t||2,e[0].toFixed(t)+" "+e[1].toFixed(t)+" "+e[2].toFixed(t)},e.toString4=function(e,t){return t=t||2,e[0].toFixed(t)+" "+e[1].toFixed(t)+" "+e[2].toFixed(t)+" "+e[3].toFixed(t)},e.getYawAndPitch=function(t,i){Math.abs(i[2])>.99999?(t.yaw=0,t.pitch=i[2]>0?-Math.PI/2:Math.PI/2):(t.yaw=e.angle2yCapped(i[0],i[1]),i[0]>0&&(t.yaw=-t.yaw),t.pitch=Math.asin(i[2]))},e.getRollAndYaw=function(t,i,n){return Math.abs(i[1])>.99999?(t.roll=0,t.yaw=i[1]>0?0:Math.PI):(t.roll=e.angle2xCapped(i[0],i[2]),i[2]<0&&(t.roll=-t.roll),t.yaw=e.angle2yCapped(i[0]*Math.cos(-t.roll)+i[2]*Math.sin(t.roll),i[1]),!n&&Math.abs(t.roll)>Math.PI/2&&(t.yaw=-t.yaw,t.roll-=Math.PI*(t.roll>0?1:-1))),t},e.getRollAndPitch=function(t,i,n){return Math.abs(i[1])>.99999?(t.roll=0,t.pitch=i[1]>0?0:Math.PI):(t.roll=e.angle2yCapped(i[0],i[2]),i[0]>0&&(t.roll=-t.roll),t.pitch=e.angle2xCapped(i[1],i[0]*Math.sin(-t.roll)+i[2]*Math.cos(-t.roll)),!n&&Math.abs(t.roll)>Math.PI/2&&(t.pitch=-t.pitch,t.roll-=Math.PI*(t.roll>0?1:-1))),t},e.x3Aux=function(){var e=t[i];return e[0]=1,e[1]=0,e[2]=0,i=(i+1)%20,e},e.y3Aux=function(){var e=t[i];return e[0]=0,e[1]=1,e[2]=0,i=(i+1)%20,e},e.z3Aux=function(){var e=t[i];return e[0]=0,e[1]=0,e[2]=1,i=(i+1)%20,e},e.normal3=function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),i=0===t?1:1/t;return[e[0]*i,e[1]*i,e[2]*i]},e.scaled2=function(e,t){return[e[0]*t,e[1]*t]},e.scaled3=function(e,t){return[e[0]*t,e[1]*t,e[2]*t]},e.scaled3Aux=function(e,n){var s=t[i];return s[0]=e[0]*n,s[1]=e[1]*n,s[2]=e[2]*n,i=(i+1)%20,s},e.sum3=function(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2]]},e.sum3Aux=function(e,n){var s=t[i];return s[0]=e[0]+n[0],s[1]=e[1]+n[1],s[2]=e[2]+n[2],i=(i+1)%20,s},e.sumVec3Mat4Aux=function(e,n){var s=t[i];return s[0]=e[0]+n[12],s[1]=e[1]+n[13],s[2]=e[2]+n[14],i=(i+1)%20,s},e.diff3=function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]},e.diff3Aux=function(e,n){var s=t[i];return s[0]=e[0]-n[0],s[1]=e[1]-n[1],s[2]=e[2]-n[2],i=(i+1)%20,s},e.diffVec3Mat4Aux=function(e,n){var s=t[i];return s[0]=e[0]-n[12],s[1]=e[1]-n[13],s[2]=e[2]-n[14],i=(i+1)%20,s},e.diffMat4Vec3Aux=function(e,n){var s=t[i];return s[0]=e[12]-n[0],s[1]=e[13]-n[1],s[2]=e[14]-n[2],i=(i+1)%20,s},e.diffTranslation3Aux=function(e,n){var s=t[i];return s[0]=e[12]-n[12],s[1]=e[13]-n[13],s[2]=e[14]-n[14],i=(i+1)%20,s},e.dot3=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},e.cross3=function(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]},e.cross3Aux=function(e,n){var s=t[i];return s[0]=e[1]*n[2]-e[2]*n[1],s[1]=e[2]*n[0]-e[0]*n[2],s[2]=e[0]*n[1]-e[1]*n[0],i=(i+1)%20,s},e.angle2x=function(e,t){return Math.acos(e/Math.sqrt(e*e+t*t))},e.angle2y=function(e,t){return Math.acos(t/Math.sqrt(e*e+t*t))},e.angle2xCapped=function(e,t){return Math.acos(Math.min(Math.max(-1,e/Math.sqrt(e*e+t*t)),1))},e.angle2yCapped=function(e,t){return Math.acos(Math.min(Math.max(-1,t/Math.sqrt(e*e+t*t)),1))},e.angle3u=function(e,t){return Math.acos(e[0]*t[0]+e[1]*t[1]+e[2]*t[2])},e.angle3uCapped=function(e,t){return Math.acos(Math.min(Math.max(-1,e[0]*t[0]+e[1]*t[1]+e[2]*t[2]),1))},e.prodVec3Mat3Aux=function(e,n){var s=t[i];return s[0]=n[0]*e[0]+n[3]*e[1]+n[6]*e[2],s[1]=n[1]*e[0]+n[4]*e[1]+n[7]*e[2],s[2]=n[2]*e[0]+n[5]*e[1]+n[8]*e[2],i=(i+1)%20,s},e.prodVec3Mat4Aux=function(n,s){var o=t[i];return e.setProdVec3Mat4(o,n,s),i=(i+1)%20,o},e.prodVec4Mat4Aux=function(n,s){var o=t[i];return e.setProdVec4Mat4(o,n,s),i=(i+1)%20,o},e.prodTranslationRotation3Aux=function(e,n){var s=t[i];return s[0]=n[0]*e[12]+n[4]*e[13]+n[8]*e[14],s[1]=n[1]*e[12]+n[5]*e[13]+n[9]*e[14],s[2]=n[2]*e[12]+n[6]*e[13]+n[10]*e[14],i=(i+1)%20,s},e.prodTranslationModel3Aux=function(n,s){var o=t[i];return e.setProdTranslationModel3(o,n,s),i=(i+1)%20,o},e.prodMat4Vec3=function(e,t){return[e[0]*t[0]+e[1]*t[1]+e[2]*t[2],e[4]*t[0]+e[5]*t[1]+e[6]*t[2],e[8]*t[0]+e[9]*t[1]+e[10]*t[2]]},e.prodMat4Vec3Aux=function(n,s){var o=t[i];return e.setProdMat4Vec3(o,n,s),i=(i+1)%20,o},e.setNull3=function(e){e[0]=0,e[1]=0,e[2]=0},e.setVector3=function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2]},e.setVector4=function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]},e.normalize2=function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]),i=0===t?1:1/t;return e[0]*=i,e[1]*=i,e},e.normalize3=function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),i=0===t?1:1/t;return e[0]*=i,e[1]*=i,e[2]*=i,e},e.normalize4D=function(e){e[3]=e[3]||1e-7,e[0]/=e[3],e[1]/=e[3],e[2]/=e[3],e[3]=1},e.scale3=function(e,t){return e[0]*=t,e[1]*=t,e[2]*=t,e},e.setSum3=function(e,t,i){e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2]},e.add3=function(e,t){e[0]+=t[0],e[1]+=t[1],e[2]+=t[2]},e.addVec3Mat4=function(e,t){return e[0]+=t[12],e[1]+=t[13],e[2]+=t[14],e},e.setDiff3=function(e,t,i){e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2]},e.setDiffTranslation3=function(e,t,i){e[0]=t[12]-i[12],e[1]=t[13]-i[13],e[2]=t[14]-i[14]},e.sub3=function(e,t){e[0]-=t[0],e[1]-=t[1],e[2]-=t[2]},e.setCross3=function(e,t,i){e[0]=t[1]*i[2]-t[2]*i[1],e[1]=t[2]*i[0]-t[0]*i[2],e[2]=t[0]*i[1]-t[1]*i[0]},e.mulCross3=function(e,t){var i=e[0],n=e[1],s=e[2];e[0]=n*t[2]-s*t[1],e[1]=s*t[0]-i*t[2],e[2]=i*t[1]-n*t[0]},e.rotate2=function(e,t){var i=Math.cos(t),n=Math.sin(t),s=e[0];e[0]=e[0]*i+e[1]*-n,e[1]=s*n+e[1]*i},e.setTranslationVector3=function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},e.mulVec3Mat3=function(e,t){var i=e[0],n=e[1],s=e[2];e[0]=t[0]*i+t[3]*n+t[6]*s,e[1]=t[1]*i+t[4]*n+t[7]*s,e[2]=t[2]*i+t[5]*n+t[8]*s},e.mulVec3Mat4=function(e,t){var i=e[0],n=e[1],s=e[2];return e[0]=t[0]*i+t[4]*n+t[8]*s,e[1]=t[1]*i+t[5]*n+t[9]*s,e[2]=t[2]*i+t[6]*n+t[10]*s,e},e.mulMat4Vec3=function(e,t){var i=e[0],n=e[1],s=e[2];e[0]=t[0]*i+t[1]*n+t[2]*s,e[1]=t[4]*i+t[5]*n+t[6]*s,e[2]=t[8]*i+t[9]*n+t[10]*s},e.mulVec3ModelMat4=function(e,t){var i=e[0],n=e[1],s=e[2];e[0]=t[0]*i+t[4]*n+t[8]*s+t[12],e[1]=t[1]*i+t[5]*n+t[9]*s+t[13],e[2]=t[2]*i+t[6]*n+t[10]*s+t[14]},e.setProdVec3Mat4=function(e,t,i){e[0]=i[0]*t[0]+i[4]*t[1]+i[8]*t[2],e[1]=i[1]*t[0]+i[5]*t[1]+i[9]*t[2],e[2]=i[2]*t[0]+i[6]*t[1]+i[10]*t[2]},e.mulVec4Mat4=function(e,t){var i=e[0],n=e[1],s=e[2],o=e[3];e[0]=t[0]*i+t[4]*n+t[8]*s+t[12]*o,e[1]=t[1]*i+t[5]*n+t[9]*s+t[13]*o,e[2]=t[2]*i+t[6]*n+t[10]*s+t[14]*o,e[3]=t[3]*i+t[7]*n+t[11]*s+t[15]*o},e.setProdVec4Mat4=function(e,t,i){e[0]=i[0]*t[0]+i[4]*t[1]+i[8]*t[2]+i[12]*t[3],e[1]=i[1]*t[0]+i[5]*t[1]+i[9]*t[2]+i[13]*t[3],e[2]=i[2]*t[0]+i[6]*t[1]+i[10]*t[2]+i[14]*t[3],e[3]=i[3]*t[0]+i[7]*t[1]+i[11]*t[2]+i[15]*t[3]},e.setProdMat4Vec3=function(e,t,i){e[0]=t[0]*i[0]+t[1]*i[1]+t[2]*i[2],e[1]=t[4]*i[0]+t[5]*i[1]+t[6]*i[2],e[2]=t[8]*i[0]+t[9]*i[1]+t[10]*i[2]},e.setProdTranslationModel3=function(e,t,i){e[0]=i[0]*t[12]+i[4]*t[13]+i[8]*t[14]+i[12],e[1]=i[1]*t[12]+i[5]*t[13]+i[9]*t[14]+i[13],e[2]=i[2]*t[12]+i[6]*t[13]+i[10]*t[14]+i[14]},e.setRowB43=function(e,t){e[0]=t[4],e[1]=t[5],e[2]=t[6]},e.extractLength2=function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]),i=0===t?1:1/t;return e[0]*=i,e[1]*=i,t},e.extractLength3=function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),i=0===t?1:1/t;return e[0]*=i,e[1]*=i,e[2]*=i,t},e.getRowA43Aux=function(e){var n=t[i];return n[0]=e[0],n[1]=e[1],n[2]=e[2],i=(i+1)%20,n},e.getRowB43Aux=function(e){var n=t[i];return n[0]=e[4],n[1]=e[5],n[2]=e[6],i=(i+1)%20,n},e.getRowB43ScaledAux=function(e,n){var s=t[i];return s[0]=e[4]*n,s[1]=e[5]*n,s[2]=e[6]*n,i=(i+1)%20,s},e.getRowC43Aux=function(e){var n=t[i];return n[0]=e[8],n[1]=e[9],n[2]=e[10],i=(i+1)%20,n},e.getRowC43ScaledAux=function(e,n){var s=t[i];return s[0]=e[8]*n,s[1]=e[9]*n,s[2]=e[10]*n,i=(i+1)%20,s},function(){var e;for(e=0;e<20;e++)t.push([0,0,0,0])}(),e}),define("modules/egom-model",["utils/vectors","modules/application"],function(e,t){"use strict";function resetDebugStats(){}function getDebugStats(){return s}function Vertex(e,t,i){this.x=e,this.y=t,this.z=i}function Line(e,t,i){this.a=e,this.b=t,this.transformGroupIndex=i||0}function Triangle(t,i,n,s,o,r,a,l){this._mesh=t,this.a=i,this.b=n,this.c=s,this.color=o,this.texCoords=r,this.normals=a||e.normalize3(e.cross3(this._mesh.getVector(i,n),this._mesh.getVector(i,s))),this.groupIndices=l||[0,0]}function MeshContextProperties(){this.bufferStartWireframe=0,this.bufferStartSolid=0,this.bufferStartTransparent=0}function Mesh(){this._vertices=[],this._lines=[],this._linesByVertices=[],this._triangles=[],this._size=0,this._maxX=0,this._minX=0,this._maxY=0,this._minY=0,this._maxZ=0,this._minZ=0,this._nOpaqueTriangles=0,this._nTransparentTriangles=0,this._contextProperties={},this._texCoords=[[0,1],[1,1],[1,0],[0,0]],this._currentGroupIndices=[0,0],this._nullVertex=new Vertex(0,0,0)}function ModelContextProperties(){this.wireframe=!1,this.solid=!1,this.minLOD=0,this.maxLOD=0}function Model(){this._meshes=[],this._minLOD=this.LOD_NOT_SET,this._maxLOD=this.LOD_NOT_SET,this._name=null,this._infoProperties={},this._scale=1,this._contextProperties={},this._position4=!1}var i={POSITION:"position",POSITION4:"position4",TEXTURE_COORDINATES:"texCoord",NORMAL:"normal",COLOR:"color",GROUP_INDICES:"groupIndices",TRIANGLE_INDEX:"triangleIndex"},n=[[0,0],[1,1]],s={triangleDrawCalls:0,triangles:0,lineDrawCalls:0,lines:0,instancedTriangleDrawCalls:0,instancedTriangles:0,instancedLineDrawCalls:0,instancedLines:0},o=["3.6"];return Object.freeze(i),Triangle.prototype.getNormal=function(e){return this.normals[e]||this.normals[0]},Mesh.prototype.getNumLines=function(){return this._lines.length},Mesh.prototype.getNumOpaqueTriangles=function(){return this._nOpaqueTriangles},Mesh.prototype.getNumTransparentTriangles=function(){return this._nTransparentTriangles},Mesh.prototype.getNumTriangles=function(e){return void 0===e?this._triangles.length:e?this._nTransparentTriangles:this._nOpaqueTriangles},Mesh.prototype.resetMesh=function(){this.resetVertices(),this.resetLines(),this.resetTriangles()},Mesh.prototype.resetVertices=function(){this._vertices=[],this._maxX=0,this._minX=0,this._maxY=0,this._minY=0,this._maxZ=0,this._minZ=0},Mesh.prototype.setVertex=function(t,i){var n,s;if(this._vertices.length<t)for(n=this._vertices.length;n<t;n++)this._vertices[n]=this._nullVertex;this._vertices[t]=i,s=e.length3([this._vertices[t].x,this._vertices[t].y,this._vertices[t].z]),2*s>this._size&&(this._size=2*s),this._vertices[t].x>this._maxX&&(this._maxX=this._vertices[t].x),this._vertices[t].x<this._minX&&(this._minX=this._vertices[t].x),this._vertices[t].y>this._maxY&&(this._maxY=this._vertices[t].y),this._vertices[t].y<this._minY&&(this._minY=this._vertices[t].y),this._vertices[t].z>this._maxZ&&(this._maxZ=this._vertices[t].z),this._vertices[t].z<this._minZ&&(this._minZ=this._vertices[t].z)},Mesh.prototype.appendVertex=function(e){this.setVertex(this._vertices.length,new Vertex(e[0],e[1],e[2]))},Mesh.prototype.setupLinesByVertices=function(){var e,t=this._vertices.length-1;for(this._linesByVertices.length=t,e=0;e<t;e++)this._linesByVertices[e]=[]},Mesh.prototype.markLineByVertex=function(e,t,i){var n=Math.min(e,t),s=Math.max(e,t);this._linesByVertices[n].indexOf(s)%2&&this._linesByVertices[n].push(s,i)},Mesh.prototype.addLinesByVertices=function(){var e,t,i,n=this._linesByVertices.length;for(e=0;e<n;e++)for(i=this._linesByVertices[e],t=0;t<i.length;t+=2)this.addLine(new Line(e,i[t],i[t+1]));this._linesByVertices=null},Mesh.prototype.resetLines=function(){this._lines=[]},Mesh.prototype.addLine=function(e){this._lines.push(e)},Mesh.prototype.setLine=function(e,t){this._lines[e]=t},Mesh.prototype.resetTriangles=function(){this._triangles=[],this._nOpaqueTriangles=0,this._nTransparentTriangles=0},Mesh.prototype.getVector=function(e,t){return[this._vertices[t].x-this._vertices[e].x,this._vertices[t].y-this._vertices[e].y,this._vertices[t].z-this._vertices[e].z]},Mesh.prototype.addTriangle=function(e){this._triangles.push(e),e.color[3]<1?this._nTransparentTriangles++:this._nOpaqueTriangles++},Mesh.prototype.addTriangleWithParams=function(e,t,i,n){var s,o,r,a,l;return s=n.color||[1,1,1,1],o=n.texCoords||[this._texCoords[0],this._texCoords[1],this._texCoords[2]],r=n.normals,a=n.groupIndices||this._currentGroupIndices,l=new Triangle(this,e,t,i,s,o,r,a),this.addTriangle(l),l},Mesh.prototype.addQuad=function(e,t,i,n,s){var o,r;s=s||{},o=Object.create(s),o.texCoords=s.texCoords?[s.texCoords[0],s.texCoords[1],s.texCoords[2]]:[this._texCoords[0],this._texCoords[1],this._texCoords[2]],o.normals=s.normals?4===s.normals.length?[s.normals[0],s.normals[1],s.normals[2]]:s.normals:null,this.addTriangleWithParams(e,t,i,o),r=Object.create(s),r.texCoords=s.texCoords?[s.texCoords[2],s.texCoords[3],s.texCoords[0]]:[this._texCoords[2],this._texCoords[3],this._texCoords[0]],r.normals=s.normals?4===s.normals.length?[s.normals[2],s.normals[3],s.normals[0]]:s.normals:null,this.addTriangleWithParams(i,n,e,r)},Mesh.prototype.getSize=function(){return this._size},Mesh.prototype.getMaxX=function(){return this._maxX},Mesh.prototype.getMinX=function(){return this._minX},Mesh.prototype.getMaxY=function(){return this._maxY},Mesh.prototype.getMinY=function(){return this._minY},Mesh.prototype.getMaxZ=function(){return this._maxZ},Mesh.prototype.getMinZ=function(){return this._minZ},Mesh.prototype.getWidth=function(){return this._maxX-this._minX},Mesh.prototype.getHeight=function(){return this._maxY-this._minY},Mesh.prototype.getDepth=function(){return this._maxZ-this._minZ},Mesh.prototype.getBufferData=function(e,t,n){var s,o,r,a,l,c,h,u,d,p,_,g,m;if(t=t||0,!0===e){if(r=this._lines.length,n)for(h=new Float32Array(8*r),s=0;s<r;s++)h[8*s]=this._vertices[this._lines[s].a].x,h[8*s+1]=this._vertices[this._lines[s].a].y,h[8*s+2]=this._vertices[this._lines[s].a].z,h[8*s+3]=0,h[8*s+4]=this._vertices[this._lines[s].b].x,h[8*s+5]=this._vertices[this._lines[s].b].y,h[8*s+6]=this._vertices[this._lines[s].b].z,h[8*s+7]=1;else for(h=new Float32Array(6*r),s=0;s<r;s++)h[6*s]=this._vertices[this._lines[s].a].x,h[6*s+1]=this._vertices[this._lines[s].a].y,h[6*s+2]=this._vertices[this._lines[s].a].z,h[6*s+3]=this._vertices[this._lines[s].b].x,h[6*s+4]=this._vertices[this._lines[s].b].y,h[6*s+5]=this._vertices[this._lines[s].b].z;for(u=new Float32Array(4*r),s=0;s<r;s++)u[4*s]=0,u[4*s+1]=1,u[4*s+2]=1,u[4*s+3]=1;for(d=new Float32Array(6*r),s=0;s<r;s++)d[6*s]=0,d[6*s+1]=0,d[6*s+2]=1,d[6*s+3]=0,d[6*s+4]=0,d[6*s+5]=1;for(p=new Float32Array(8*r),s=0;s<r;s++)p[8*s]=1,p[8*s+1]=1,p[8*s+2]=1,p[8*s+3]=1,p[8*s+4]=1,p[8*s+5]=1,p[8*s+6]=1,p[8*s+7]=1;for(_=new Float32Array(4*r),s=0;s<r;s++)_[4*s]=this._lines[s].transformGroupIndex,_[4*s+1]=0,_[4*s+2]=this._lines[s].transformGroupIndex,_[4*s+3]=0;for(a=this._triangles.length,g=new Float32Array(3*a),s=0;s<a;s++)g[12*s]=0,g[12*s+1]=0,g[12*s+2]=0,g[12*s+3]=0,g[12*s+4]=0,g[12*s+5]=0,g[12*s+6]=0,g[12*s+7]=0,g[12*s+8]=0,g[12*s+9]=0,g[12*s+10]=0,g[12*s+11]=0}else{if(a=this._triangles.length,n)for(h=new Float32Array(12*a),s=0;s<a;s++)h[12*s]=this._vertices[this._triangles[s].a].x,h[12*s+1]=this._vertices[this._triangles[s].a].y,h[12*s+2]=this._vertices[this._triangles[s].a].z,h[12*s+3]=0,h[12*s+4]=this._vertices[this._triangles[s].b].x,h[12*s+5]=this._vertices[this._triangles[s].b].y,h[12*s+6]=this._vertices[this._triangles[s].b].z,h[12*s+7]=1,h[12*s+8]=this._vertices[this._triangles[s].c].x,h[12*s+9]=this._vertices[this._triangles[s].c].y,h[12*s+10]=this._vertices[this._triangles[s].c].z,h[12*s+11]=2;else for(h=new Float32Array(9*a),s=0;s<a;s++)h[9*s]=this._vertices[this._triangles[s].a].x,h[9*s+1]=this._vertices[this._triangles[s].a].y,h[9*s+2]=this._vertices[this._triangles[s].a].z,h[9*s+3]=this._vertices[this._triangles[s].b].x,h[9*s+4]=this._vertices[this._triangles[s].b].y,h[9*s+5]=this._vertices[this._triangles[s].b].z,h[9*s+6]=this._vertices[this._triangles[s].c].x,h[9*s+7]=this._vertices[this._triangles[s].c].y,h[9*s+8]=this._vertices[this._triangles[s].c].z;for(u=new Float32Array(6*a),s=0;s<a;s++)u[6*s]=this._triangles[s].texCoords[0][0],u[6*s+1]=this._triangles[s].texCoords[0][1],u[6*s+2]=this._triangles[s].texCoords[1][0],u[6*s+3]=this._triangles[s].texCoords[1][1],u[6*s+4]=this._triangles[s].texCoords[2][0],u[6*s+5]=this._triangles[s].texCoords[2][1];for(d=new Float32Array(9*a),s=0;s<a;s++)d[9*s]=this._triangles[s].getNormal(0)[0],d[9*s+1]=this._triangles[s].getNormal(0)[1],d[9*s+2]=this._triangles[s].getNormal(0)[2],d[9*s+3]=this._triangles[s].getNormal(1)[0],d[9*s+4]=this._triangles[s].getNormal(1)[1],d[9*s+5]=this._triangles[s].getNormal(1)[2],d[9*s+6]=this._triangles[s].getNormal(2)[0],d[9*s+7]=this._triangles[s].getNormal(2)[1],d[9*s+8]=this._triangles[s].getNormal(2)[2];for(p=new Float32Array(12*a),s=0;s<a;s++)p[12*s]=this._triangles[s].color[0],p[12*s+1]=this._triangles[s].color[1],p[12*s+2]=this._triangles[s].color[2],p[12*s+3]=this._triangles[s].color[3],p[12*s+4]=this._triangles[s].color[0],p[12*s+5]=this._triangles[s].color[1],p[12*s+6]=this._triangles[s].color[2],p[12*s+7]=this._triangles[s].color[3],p[12*s+8]=this._triangles[s].color[0],p[12*s+9]=this._triangles[s].color[1],p[12*s+10]=this._triangles[s].color[2],p[12*s+11]=this._triangles[s].color[3];for(_=new Float32Array(6*a),s=0;s<a;s++)_[6*s]=this._triangles[s].groupIndices[0],_[6*s+1]=this._triangles[s].groupIndices[1],_[6*s+2]=this._triangles[s].groupIndices[0],_[6*s+3]=this._triangles[s].groupIndices[1],_[6*s+4]=this._triangles[s].groupIndices[0],_[6*s+5]=this._triangles[s].groupIndices[1];for(g=new Float32Array(12*a),s=0;s<a;s++){for(l=t+s,c=[],o=0;o<4;o++)c[o]=l%256/255,l=Math.floor(l/256);g[12*s]=c[0],g[12*s+1]=c[1],g[12*s+2]=c[2],g[12*s+3]=c[3],g[12*s+4]=c[0],g[12*s+5]=c[1],g[12*s+6]=c[2],g[12*s+7]=c[3],g[12*s+8]=c[0],g[12*s+9]=c[1],g[12*s+10]=c[2],g[12*s+11]=c[3]}}return m={},m[n?i.POSITION4:i.POSITION]=h,m[i.TEXTURE_COORDINATES]=u,m[i.NORMAL]=d,m[i.COLOR]=p,m[i.GROUP_INDICES]=_,m[i.TRIANGLE_INDEX]=g,m.dataSize=e?2*this._lines.length:3*this._triangles.length,m},Mesh.prototype.getBufferSize=function(e,t){return(e?2*this._lines.length:0)+(t?3*this._triangles.length:0)},Mesh.prototype.loadToVertexBuffers=function(e,t,i,n,s){var o=null,r=0,a=this._contextProperties[e._name]||new MeshContextProperties;return i&&(o=this.getBufferData(!0,t,s),a.bufferStartWireframe=t,e.setVertexBufferData(o,t),r+=o.dataSize,t+=o.dataSize),n&&(o=this.getBufferData(!1,t,s),a.bufferStartSolid=t,a.bufferStartTransparent=t+3*this._nOpaqueTriangles,e.setVertexBufferData(o,t),r+=o.dataSize,t+=o.dataSize),this._contextProperties[e._name]=a,r},Mesh.prototype.render=function(e,t,i){var n=this._contextProperties[e._name];if(!0===t)e.gl.drawArrays(e.gl.LINES,n.bufferStartWireframe,2*this._lines.length);else switch(i){case!0:e.gl.drawArrays(e.gl.TRIANGLES,n.bufferStartSolid,3*this._nOpaqueTriangles);break;case!1:e.gl.drawArrays(e.gl.TRIANGLES,n.bufferStartTransparent,3*this._nTransparentTriangles);break;case void 0:e.gl.drawArrays(e.gl.TRIANGLES,n.bufferStartSolid,3*this._triangles.length)}},Mesh.prototype.renderInstances=function(e,t,i,n){var s=this._contextProperties[e._name];if(!0===t)e.instancingExt.drawArraysInstancedANGLE(e.gl.LINES,s.bufferStartWireframe,2*this._lines.length,n);else switch(i){case!0:e.instancingExt.drawArraysInstancedANGLE(e.gl.TRIANGLES,s.bufferStartSolid,3*this._nOpaqueTriangles,n);break;case!1:e.instancingExt.drawArraysInstancedANGLE(e.gl.TRIANGLES,s.bufferStartTransparent,3*this._nTransparentTriangles,n);break;case void 0:e.instancingExt.drawArraysInstancedANGLE(e.gl.TRIANGLES,s.bufferStartSolid,3*this._triangles.length,n)}},Mesh.prototype.addCuboid=function(t,i,n,s,o,r,a,l,c){var h,u,d,p;for(u=+this._vertices.length,this.appendVertex([t-s/2,i-o/2,n+r/2]),this.appendVertex([t+s/2,i-o/2,n+r/2]),this.appendVertex([t+s/2,i+o/2,n+r/2]),this.appendVertex([t-s/2,i+o/2,n+r/2]),this.appendVertex([t-s/2,i+o/2,n-r/2]),this.appendVertex([t+s/2,i+o/2,n-r/2]),this.appendVertex([t+s/2,i-o/2,n-r/2]),this.appendVertex([t-s/2,i-o/2,n-r/2]),this.appendVertex([t+s/2,i+o/2,n-r/2]),this.appendVertex([t-s/2,i+o/2,n-r/2]),this.appendVertex([t-s/2,i+o/2,n+r/2]),this.appendVertex([t+s/2,i+o/2,n+r/2]),this.appendVertex([t-s/2,i-o/2,n-r/2]),this.appendVertex([t+s/2,i-o/2,n-r/2]),this.appendVertex([t+s/2,i-o/2,n+r/2]),this.appendVertex([t-s/2,i-o/2,n+r/2]),this.appendVertex([t+s/2,i-o/2,n-r/2]),this.appendVertex([t+s/2,i+o/2,n-r/2]),this.appendVertex([t+s/2,i+o/2,n+r/2]),this.appendVertex([t+s/2,i-o/2,n+r/2]),this.appendVertex([t-s/2,i+o/2,n-r/2]),this.appendVertex([t-s/2,i-o/2,n-r/2]),this.appendVertex([t-s/2,i-o/2,n+r/2]),this.appendVertex([t-s/2,i+o/2,n+r/2]),d=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],p={color:a,texCoords:l},h=0;h<6;h++)p.normals=[d[h]],this.addQuad(u+4*h,u+4*h+1,u+4*h+2,u+4*h+3,p),c||(p.normals=[e.scaled3(d[h],-1)],this.addQuad(u+4*h+2,u+4*h+1,u+4*h,u+4*h+3,p))},Model.prototype.LOD_NOT_SET=-1,Model.prototype.getMaxLOD=function(){return this._maxLOD},Model.prototype.includeVertexIndicesInPosition=function(e){this._position4=e},Model.prototype.getClosestAvailableLOD=function(e){return Math.min(Math.max(this._minLOD,e),this.getMaxLOD())},Model.prototype.updateLODInfo=function(e,t){this._minLOD=this._minLOD===this.LOD_NOT_SET?e:e<this._minLOD?e:this._minLOD,this._maxLOD=this._maxLOD===this.LOD_NOT_SET?t:t>this._maxLOD?t:this._maxLOD},Model.prototype.getMeshWithLOD=function(e){var t;for(t=this._meshes.length;t<=e;t++)this._meshes.push(new Mesh),this._maxLOD=t;return this._meshes[e]},Model.prototype.setVertex=function(e,t,i,n){var s;for(s=e;s<=t;s++)this._meshes[s].setVertex(i,n)},Model.prototype.addLineDirect=function(e,t,i){var n;for(n=e;n<=t;n++)this._meshes[n].addLine(i)},Model.prototype.setupLinesByVertices=function(e,t){var i;for(i=e;i<=t;i++)this._meshes[i].setupLinesByVertices()},Model.prototype.markLineByVertex=function(e,t,i,n,s){var o;for(o=e;o<=t;o++)this._meshes[o].markLineByVertex(i,n,s)},Model.prototype.addLinesByVertices=function(e,t){var i;for(i=e;i<=t;i++)this._meshes[i].addLinesByVertices()},Model.prototype.addTriangleDirect=function(e,t,i,n,s,o){var r,a=this._meshes[e].addTriangleWithParams(i,n,s,o);for(r=e+1;r<=t;r++)this._meshes[r].addTriangle(a);return a},Model.prototype.loadFromJSON=function(e,i,n){var s,r,a,l,c,h,u,d,p,_,g,m,f,S,T,y,E,C,M,I=null,A=null,x=null,v=null,O=function(e,t){var i;if(null===I){for(i=e;i<=t;i++)this.getMeshWithLOD(i).resetMesh();I=e,A=t}else{for(i=e;i<I;i++)this.getMeshWithLOD(i).resetMesh();for(i=A+1;i<=t;i++)this.getMeshWithLOD(i).resetMesh();I=e<I?e:I,A=t>A?t:A}}.bind(this);if(n=n||0,"object"!=typeof i)return t.showError("'"+e+"' does not appear to be a JSON file.",t.ErrorSeverity.SEVERE,"A model was supposed to be loaded from this file, but only models of EgomModel JSON format are accepted."),!1;if(!(c=i.version))return t.showError("Model from file: '"+e+"' could not be loaded, because the file version could not have been determined.",t.ErrorSeverity.SEVERE),!1;if(o.indexOf(c)<0)return t.showError("Model from file: '"+e+"' could not be loaded, because the version of the file ("+c+") is not supported.",t.ErrorSeverity.SEVERE,"Supported versions are: "+o.join(", ")+"."),!1;for(h=null,this._infoProperties=i.info||{},this._name=i.info.name||null,this._scale=i.info.scale||1,x=null===i.info.LOD[0]?n:i.info.LOD[0],v=null===i.info.LOD[1]?n:i.info.LOD[1],this.updateLODInfo(x,v),O(x,v),h=i.info.colorPalette,m=i.vertices.length,a=x,l=v,s=0;s<m;s++)M=i.vertices[s].length,i.vertices[s].length>=5&&(a=i.vertices[s][3],l=i.vertices[s][4]),C=new Vertex(i.vertices[s][0],i.vertices[s][1],i.vertices[s][2]),this.setVertex(a,l,s,C);for(f=i.polygons.length,a=x,l=v,this.setupLinesByVertices(a,l),g={color:h[0],groupIndices:[0,0]},T=3,s=0;s<f;s++){for(y=i.polygons[s][0],M=y.length,S=y[0]<0?1:0,1===S&&(T=-y[0]),u=(M-S-T)%2,d=M-S-T-u>2?2*T:0,M-S-T-u-d>=2&&(a=y[M-2],l=y[M-1]),g.color=u?h[y[S+T]]:g.color,d&&(p=y.slice(S+T+u,S+T+u+d)),M=i.polygons[s].length,M>1&&i.polygons[s][1].length>2&&(_=i.polygons[s][1]),g.groupIndices=M>1&&i.polygons[s][1].length%3==2?i.polygons[s][1].slice(-2):g.groupIndices,r=0;r<T-2;r++)g.texCoords=[[p[0],p[1]],[p[2*r+2],p[2*r+3]],[p[2*r+4],p[2*r+5]]],
g.normals=_.length>=3*T?[_.slice(0,3),_.slice(3*r+3,3*r+6),_.slice(3*r+6,3*r+9)]:[_.slice(0,3)],E=y[S],this.addTriangleDirect(a,l,E,E+y[S+r+1],E+y[S+r+2],g),this.markLineByVertex(a,l,E+y[S+r+1],E+y[S+r+2],g.groupIndices[0]);this.markLineByVertex(a,l,E,E+y[S+T-1],g.groupIndices[0]),this.markLineByVertex(a,l,E,E+y[S+1],g.groupIndices[0])}return this.addLinesByVertices(x,v),!0},Model.prototype._getLargestValueOfMeshes=function(e,t){var i,n;if(void 0!==e)return t(this.getMeshWithLOD(e));for(e=this._minLOD;e<=this._maxLOD;e++)n=t(this.getMeshWithLOD(e)),(void 0===i||n>i)&&(i=n);return i},Model.prototype._getLowestValueOfMeshes=function(e,t){var i,n;if(void 0!==e)return t(this.getMeshWithLOD(e));for(e=this._minLOD;e<=this._maxLOD;e++)n=t(this.getMeshWithLOD(e)),(void 0===i||n<i)&&(i=n);return i},Model.prototype.getSize=function(e){return this._getLargestValueOfMeshes(e,function(e){return e?e.getSize():0})},Model.prototype.getMaxX=function(e){return this._getLargestValueOfMeshes(e,function(e){return e?e.getMaxX():0})},Model.prototype.getMinX=function(e){return this._getLowestValueOfMeshes(e,function(e){return e?e.getMinX():0})},Model.prototype.getMaxY=function(e){return this._getLargestValueOfMeshes(e,function(e){return e?e.getMaxY():0})},Model.prototype.getMinY=function(e){return this._getLowestValueOfMeshes(e,function(e){return e?e.getMinY():0})},Model.prototype.getMaxZ=function(e){return this._getLargestValueOfMeshes(e,function(e){return e?e.getMaxZ():0})},Model.prototype.getMinZ=function(e){return this._getLowestValueOfMeshes(e,function(e){return e?e.getMinZ():0})},Model.prototype.getWidth=function(e){return this._getLargestValueOfMeshes(e,function(e){return e?e.getWidth():0})},Model.prototype.getHeight=function(e){return this._getLargestValueOfMeshes(e,function(e){return e?e.getHeight():0})},Model.prototype.getDepth=function(e){return this._getLargestValueOfMeshes(e,function(e){return e?e.getDepth():0})},Model.prototype.getWidthInMeters=function(e){return e=void 0!==e?e:this._minLOD,this.getWidth(e)*this._scale},Model.prototype.getHeightInMeters=function(e){return e=void 0!==e?e:this._minLOD,this.getHeight(e)*this._scale},Model.prototype.getDepthInMeters=function(e){return e=void 0!==e?e:this._minLOD,this.getDepth(e)*this._scale},Model.prototype.getNumLines=function(e){return e=void 0!==e?e:this._minLOD,e>=0?this.getMeshWithLOD(e).getNumLines():0},Model.prototype.getNumOpaqueTriangles=function(e){return e=void 0!==e?e:this._minLOD,this.getMeshWithLOD(e).getNumOpaqueTriangles()},Model.prototype.getNumTransparentTriangles=function(e){return e=void 0!==e?e:this._minLOD,this.getMeshWithLOD(e).getNumTransparentTriangles()},Model.prototype.getNumTriangles=function(e,t){return e=void 0!==e?e:this._minLOD,e>=0?this.getMeshWithLOD(e).getNumTriangles(t):0},Model.prototype.addToContext=function(e,t){this._minLOD=this._minLOD!==this.LOD_NOT_SET?this._minLOD:0,this._maxLOD=this._maxLOD!==this.LOD_NOT_SET?this._maxLOD:0;var i=this._contextProperties[e._name];i?(!i.wireframe&&t&&(i.wireframe=!0,e.resetReadyState()),i.solid||t||(i.solid=!0,e.resetReadyState()),i.minLOD>this._minLOD&&(i.minLOD=this._minLOD,e.resetReadyState()),i.maxLOD<this._maxLOD&&(i.maxLOD=this._maxLOD,e.resetReadyState())):(i=new ModelContextProperties,i.wireframe=t,i.solid=!t,i.minLOD=this._minLOD,i.maxLOD=this._maxLOD,e.addModel(this)),this._contextProperties[e._name]=i},Model.prototype.clearContextBindings=function(){var e;for(e in this._contextProperties)this._contextProperties.hasOwnProperty(e)&&delete this._contextProperties[e]},Model.prototype.getBufferData=function(e,t,i){return i=void 0!==i?i:this._minLOD,this._meshes[i].getBufferData(e,t,this._position4)},Model.prototype.getBufferSize=function(e){var t,i=this._contextProperties[e._name],n=0;for(t=i.minLOD;t<=i.maxLOD;t++)n+=this._meshes[t].getBufferSize(i.wireframe,i.solid);return n},Model.prototype.loadToVertexBuffers=function(e,t,i){i=void 0!==i?i:this._minLOD;var n=this._contextProperties[e._name];return this._meshes[i].loadToVertexBuffers(e,t,n.wireframe,n.solid,this._position4)},Model.prototype.render=function(e,t,i,n){n=void 0!==n?n:this._minLOD,this._meshes[n].render(e,t,i)},Model.prototype.renderInstances=function(e,t,i,n,s){n=void 0!==n?n:this._minLOD,this._meshes[n].renderInstances(e,t,i,s)},Model.prototype.appendVertex=function(e){this.getMeshWithLOD(0).appendVertex(e)},Model.prototype.addLine=function(e){this.getMeshWithLOD(0).addLine(e)},Model.prototype.addQuad=function(e,t,i,n,s){this.getMeshWithLOD(0).addQuad(e,t,i,n,s)},Model.prototype.addCuboid=function(e,t,i,n,s,o,r,a,l){this.getMeshWithLOD(0).addCuboid(e,t,i,n,s,o,r,a,l)},{VertexAttributeRole:i,resetDebugStats:resetDebugStats,getDebugStats:getDebugStats,Model:Model,fvqModel:function(e){var t=new Model;return e&&(t._name=e),t.appendVertex([-1,-1,0]),t.appendVertex([1,-1,0]),t.appendVertex([1,1,0]),t.appendVertex([-1,1,0]),t.addQuad(0,1,2,3),t},squareModel:function(e,t){var i,s=new Model;return e&&(s._name=e),i=t||n,s.appendVertex([-1,-1,0]),s.appendVertex([1,-1,0]),s.appendVertex([1,1,0]),s.appendVertex([-1,1,0]),s.addQuad(0,1,2,3,{texCoords:[[i[0][0],i[1][1]],[i[1][0],i[1][1]],[i[1][0],i[0][1]],[i[0][0],i[0][1]]]}),s},turningBillboardModel:function(e,t,i){var n,s=.5-.5*i,o=.5+.5*i,r=.75-.25*i,a=.75+.25*i,l=new Model;if(e&&(l._name=e),l.appendVertex([-i,-1,0]),l.appendVertex([i,-1,0]),l.appendVertex([i,1,0]),l.appendVertex([-i,1,0]),l.addQuad(0,1,2,3,{texCoords:[[s,.5],[o,.5],[o,0],[s,0]]}),t)for(n=0;n<t.length;n++)l.appendVertex([i,t[n],-i]),l.appendVertex([-i,t[n],-i]),l.appendVertex([-i,t[n],i]),l.appendVertex([i,t[n],i]),l.addQuad(4*(n+1),4*(n+1)+1,4*(n+1)+2,4*(n+1)+3,{texCoords:[[s,a],[o,a],[o,r],[s,r]]}),l.addQuad(4*(n+1)+3,4*(n+1)+2,4*(n+1)+1,4*(n+1),{texCoords:[[s,a],[o,a],[o,r],[s,r]]});return l},cuboidModel:function(e,t,i,n,s){var o=new Model;return e&&(o._name=e),o.addCuboid(0,0,0,t,i,n,s,[[0,1],[1,1],[1,0],[0,0]],!1),o},lineModel:function(e,t){var i=new Model;return e&&(i._name=e),i.appendVertex([0,0,0]),i.appendVertex(t),i.addLine(new Line(0,1)),i},gridModel:function(e,t,i,n,s){var o,r=[0,0,0],a=new Model;for(e&&(a._name=e),o=0;o<n;o++)r[0]=t*(o/(n-1)-.5),r[1]=-.5*i,a.appendVertex(r),r[1]=.5*i,a.appendVertex(r),a.addLine(new Line(2*o,2*o+1));for(o=0;o<s;o++)r[0]=-.5*t,r[1]=i*(o/(s-1)-.5),a.appendVertex(r),r[0]=.5*t,a.appendVertex(r),a.addLine(new Line(2*(n+o),2*(n+o)+1));return a},positionMarkerModel:function(e,t){var i,n,s=[1,0,0],o=new Model;for(e&&(o._name=e),o.appendVertex(s),i=1;i<t;i++)n=i/t*2*Math.PI,s[0]=Math.cos(n),s[1]=Math.sin(n),o.appendVertex(s),o.addLine(new Line(i-1,i));return o.addLine(new Line(i-1,0)),s[0]=0,s[1]=0,s[2]=0,o.appendVertex(s),s[2]=1,o.appendVertex(s),o.addLine(new Line(i,i+1)),o}}}),define("modules/audio",["modules/application"],function(e){"use strict";function _rampVolume(e,t,i,n){var s=l.currentTime;e.gain.cancelScheduledValues(s),e.gain.setValueAtTime(e.gain.value,s),n?e.gain.setTargetAtTime(t,s,i||u):e.gain.linearRampToValueAtTime(t,s+(i||u))}function SoundSource(e,i,n,s,o){var r;this._x=e,this._y=i,this._z=n,this._positionChangeTime=0,this._pannerNode=s?l.createPanner():null,this._clips={},this._pannerNode&&(this._pannerNode.panningModel=s,this._pannerNode.refDistance=1,this._pannerNode.rolloffFactor=o||d,r=l.currentTime,this._pannerNode.positionX.setValueAtTime(this._x,r),this._pannerNode.positionY.setValueAtTime(this._y,r),this._pannerNode.positionZ.setValueAtTime(this._z,r),this._positionChangeTime=r,this._pannerNode.connect(t))}function SoundClip(e,t,i,n,s,o,r,a){this._soundCategory=e,this._sampleName=t,this._volume=i,this._loop=n,this._shouldStack=s||!1,this._stackTimeThreshold=o||0,this._stackVolumeFactor=r||1,this._sourceNode=null,this._gainNode=null,this._playbackStartTime=0,this._playing=!1,this._stopping=!1,this._onFinish=null,this._onEnded=null,this._soundSource=null,a&&this.setSource(a)}function loadSample(t,i,n,s){l.decodeAudioData(i.response,function(e){_[t]=e,n&&n()},function(){e.showError("Decoding audio sample '"+t+"' failed!"),s&&s()})}function playSound(e,t,i,n){SoundClip.call(r,c.SOUND_EFFECT,e,t,!1),i&&(SoundSource.call(a,i[0],i[1],i[2],p,n),r.setSource(a)),r.play()}function setEffectVolume(e,i){_rampVolume(t,e,i)}function setMusicVolume(e,t){_rampVolume(i,e,t)}function setUIVolume(e,t){_rampVolume(n,e,t)}function setMasterVolume(e,t){_rampVolume(s,e,t)}function resume(){l.resume()}var t,i,n,s,o,r,a,l,c={NOME:0,SOUND_EFFECT:1,MUSIC:2,UI:3},h={EQUAL_POWER:"equalpower",HRTF:"HRTF"},u=.01,d=.01,p=h.EQUAL_POWER,_={};return SoundSource.prototype.updatePosition=function(e,t,i){var n=l.currentTime;n-this._positionChangeTime>=.15&&(e!==this._x||t!==this._y||i!==this._z)&&(this._x=e,this._y=t,this._z=i,this._positionChangeTime=n,this._pannerNode.positionX.value!==e&&(this._pannerNode.positionX.setValueAtTime(this._pannerNode.positionX.value,n),this._pannerNode.positionX.linearRampToValueAtTime(e,n+u)),this._pannerNode.positionY.value!==t&&(this._pannerNode.positionY.setValueAtTime(this._pannerNode.positionY.value,n),this._pannerNode.positionY.linearRampToValueAtTime(t,n+u)),this._pannerNode.positionZ.value!==i&&(this._pannerNode.positionZ.setValueAtTime(this._pannerNode.positionZ.value,n),this._pannerNode.positionZ.linearRampToValueAtTime(i,n+u)))},SoundSource.prototype.setPositionImmediate=function(e,t,i){var n=l.currentTime;this._x=e,this._y=t,this._z=i,this._positionChangeTime=n,this._pannerNode.positionX.value!==e&&this._pannerNode.positionX.setValueAtTime(e,n),this._pannerNode.positionY.value!==t&&this._pannerNode.positionY.setValueAtTime(t,n),this._pannerNode.positionZ.value!==i&&this._pannerNode.positionZ.setValueAtTime(i,n)},SoundSource.prototype.setClip=function(e,t){this._clips[e]=t},SoundSource.prototype.getClip=function(e){return this._clips[e]},SoundSource.prototype.destroy=function(){this._pannerNode&&this._pannerNode.disconnect(),this._pannerNode=null},SoundClip.prototype.setSource=function(t){this._soundCategory!==c.SOUND_EFFECT?e.showError("Cannot set sound source for clip '"+this._sampleName+"', because its sound category is not sound effect!"):this._soundSource?e.showError("Cannot set sound source for clip '"+this._sampleName+"', because it already has a source!"):this._playing?e.showError("Cannot set sound source for clip '"+this._sampleName+"', because it is already playing!"):this._soundSource=t},SoundClip.prototype.getVolume=function(){return void 0!==this._volume?this._volume:1},SoundClip.prototype.setVolume=function(e){this._volume=e,this._gainNode&&(this._gainNode.gain.value=e)},SoundClip.prototype.increaseVolume=function(e){this._volume+=e,this._gainNode&&(this._gainNode.gain.value=this._volume)},SoundClip.prototype.rampVolume=function(e,t,i,n){!this._gainNode||i&&this._volume===e||_rampVolume(this._gainNode,e,t,n),this._volume=e},SoundClip.prototype.getPlaybackPosition=function(){var e=l.currentTime-this._playbackStartTime;return this._loop?e%_[this._sampleName].duration:Math.min(e,_[this._sampleName].duration)},SoundClip.prototype._handleEnded=function(){this._playing=!1},SoundClip.prototype._startPlayingSample=function(s,o){var r;if(this._sourceNode=l.createBufferSource(),this._sourceNode.buffer=_[this._sampleName],o?this._sourceNode.onended=function(){this._playing=!1,o()}.bind(this):(this._onEnded=this._onEnded||this._handleEnded.bind(this),this._sourceNode.onended=this._onEnded),this._onFinish=o,r=this._sourceNode,void 0!==this._volume&&(this._gainNode=l.createGain(),this._gainNode.gain.value=this._volume,r.connect(this._gainNode),r=this._gainNode),this._loop&&(this._sourceNode.loop=!0),this._soundSource)r.connect(this._soundSource._pannerNode);else switch(this._soundCategory){case c.SOUND_EFFECT:r.connect(t);break;case c.MUSIC:r.connect(i);break;case c.UI:r.connect(n);break;default:e.showError("Cannot play sound '"+this._sampleName+"', because it has an unkown category: "+this._soundCategory)}this._playing=!0,this._stopping=!1,this._sourceNode.start(l.currentTime,s),this._playbackStartTime=l.currentTime-s},SoundClip.prototype.play=function(t,i){var n;if(_[this._sampleName]){if(this._playing)if(t)this.stopPlaying();else if(this._loop)return;this._soundSource&&this._shouldStack?(n=this._soundSource.getClip(this._sampleName),n&&n._playing&&n.getPlaybackPosition()<=this._stackTimeThreshold?n.increaseVolume(this._volume*this._stackVolumeFactor):(this._startPlayingSample(0,i),this._soundSource&&this._soundSource.setClip(this._sampleName,this))):this._startPlayingSample(0,i)}else this._sampleName&&e.showError("Attempting to play back '"+this._sampleName+"', which is not loaded!")},SoundClip.prototype.stopPlaying=function(e){this._sourceNode&&this._playing&&!this._stopping&&(e?(this.rampVolume(0,e),setTimeout(this._sourceNode.stop.bind(this._sourceNode),1e3*e),this._stopping=!0):this._sourceNode.stop())},SoundClip.prototype.stopLoop=function(){this._sourceNode&&this._playing&&!this._stopping&&(this._sourceNode.loop=!1,this._stopping=!0)},SoundClip.prototype.destroy=function(){this.stopPlaying(),this._sourceNode=null,this._gainNode=null,this._position=null},l=new AudioContext,s=l.createGain(),s.connect(l.destination),o=l.createDynamicsCompressor(),o.connect(s),t=l.createGain(),t.connect(o),i=l.createGain(),i.connect(o),n=l.createGain(),n.connect(s),r=new SoundClip,a=new SoundSource(0,0,0),l.createPanner().positionX||e.showError("3D audio is not properly supported by your browser!",e.ErrorSeverity.SEVERE,"This game requires 3D positional audio to work properly. Please upgrade to a browser that supports it to play!"),{SoundCategory:c,PanningModel:h,SoundClip:SoundClip,SoundSource:SoundSource,loadSample:loadSample,playSound:playSound,setEffectVolume:setEffectVolume,setMusicVolume:setMusicVolume,setUIVolume:setUIVolume,setMasterVolume:setMasterVolume,resume:resume}}),define("modules/media-resources",["utils/utils","utils/types","modules/application","modules/resource-manager","modules/managed-gl","modules/egom-model","modules/audio"],function(e,t,i,n,s,o,r){"use strict";function MediaResource(e){n.GenericResource.call(this,e?e.name:""),this._dataJSON=e,e&&this._loadConfig(e)}function TextureResource(e){MediaResource.call(this,e)}function CubemapResource(e){MediaResource.call(this,e)}function ShaderResource(e){MediaResource.call(this,e)}function ModelResource(e){MediaResource.call(this,e)}function SoundEffectResource(e){MediaResource.call(this,e)}function MusicResource(e){MediaResource.call(this,e)}function MediaResourceManager(){n.ResourceManager.call(this)}function requestConfigLoad(e,t){var i={};i[c]=TextureResource,i[h]=CubemapResource,i[u]=ShaderResource,i[d]=ModelResource,i[p]=SoundEffectResource,i[_]=MusicResource,a.requestConfigLoad(e.filename,e.folder,i,t)}var a,l={VERTEX:"vertex",FRAGMENT:"fragment"},c="textures",h="cubemaps",u="shaders",d="models",p="soundEffects",_="music",g={},m={},f={};return Object.freeze(l),MediaResource.prototype=new n.GenericResource,MediaResource.prototype.constructor=MediaResource,MediaResource.prototype._loadConfig=function(e){this._dataJSON=e},MediaResource.prototype.getData=function(){return this._dataJSON},MediaResource.prototype.reloadData=function(){this._loadConfig(this._dataJSON),this.resetReadyState()},TextureResource.prototype=new MediaResource,TextureResource.prototype.constructor=TextureResource,TextureResource.prototype._loadConfig=function(e){MediaResource.prototype._loadConfig.call(this,e),this._basepath=e.basepath,this._format=e.format,this._useMipmap=!0===e.useMipmap,this._typeSuffixes=e.typeSuffixes,this._qualitySuffixes=e.qualitySuffixes,this._loadedImages=0,this._imagesToLoad=0,this._images={},this._managedTextures={},this._cachedManagedTexturesOfTypes=[]},TextureResource.prototype._getPath=function(e,t){return this._basepath+this._typeSuffixes[e]+this._qualitySuffixes[t]+"."+this._format},TextureResource.prototype._getOnLoadImageFunction=function(e,t){var i=this._getPath(e,t);return function(){this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:i})}.bind(this)},TextureResource.prototype._handleError=function(e){i.showError("Could not load texture '"+this._name+"': downloading file '"+e+"' failed!"),this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:e,error:!0})},TextureResource.prototype._getMostFittingQuality=function(e){var t,n,s,o=this.getQualities(),r=-1;for(t=0;t<o.length;t++)(n=e.indexOf(o[t]))>=0&&(-1===r||n<r)&&(r=n,s=e[n]);return-1===r?(i.showError("Texture '"+this._name+"' is not available in any of the qualities: ["+e.join(", ")+"]!"),null):s},TextureResource.prototype._getProcessedParams=function(e){return e=e||{},e.types=e.types||Object.keys(this._typeSuffixes),e.qualities=e.qualities||e.qualityPreferenceList&&[this._getMostFittingQuality(e.qualityPreferenceList)]||Object.keys(this._qualitySuffixes),delete e.qualityPreferenceList,e},TextureResource.prototype.requiresReload=function(e){var t,i;if(e=this._getProcessedParams(e),this.isRequested(e))return!1;for(t=0;t<e.types.length;t++)if(this._typeSuffixes.hasOwnProperty(e.types[t])){if(!this._images[e.types[t]])return!0;for(i=0;i<e.qualities.length;i++)if(this._qualitySuffixes.hasOwnProperty(e.qualities[i])&&!this._images[e.types[t]][e.qualities[i]])return!0}return!1},TextureResource.prototype._requestFiles=function(e){var t,n,s,o,r;for(e=this._getProcessedParams(e),t=0;t<e.types.length;t++)if(s=e.types[t],this._typeSuffixes.hasOwnProperty(s))for(this._images[s]=this._images[s]||{},n=0;n<e.qualities.length;n++)o=e.qualities[n],this._qualitySuffixes.hasOwnProperty(o)&&(this._images[s][o]||(r=this._getPath(s,o),m[r]?this._images[s][o]=m[r]:(m[r]=new Image,this._imagesToLoad++,this._images[s][o]=m[r],this._images[s][o].onload=this._getOnLoadImageFunction(s,o).bind(this),this._images[s][o].onerror=this._handleError.bind(this,r))));for(t=0;t<e.types.length;t++)if(s=e.types[t],this._typeSuffixes.hasOwnProperty(s))for(n=0;n<e.qualities.length;n++)o=e.qualities[n],this._qualitySuffixes.hasOwnProperty(o)&&(this._images[s][o].src||(this._images[s][o].src=i.getFileURL("texture",this._getPath(s,o))));this._loadedImages===this._imagesToLoad&&this._onFilesLoad(!0,{path:this._basepath})},TextureResource.prototype._loadData=function(e){return!e.error},TextureResource.prototype.getQualities=function(){return Object.keys(this._qualitySuffixes)},TextureResource.prototype.getManagedTexture=function(e,t){return!1===this._readyToUse?(i.showError("Cannot get managed GL texture for '"+this._name+"', as it has not been loaded from file yet!"),null):(this._images[e]||(i.showError("The requested texture '"+this._name+"' has no type '"+e+"' available!"),e=Object.keys(this._images)[0]),this._managedTextures[e]=this._managedTextures[e]||{},this._managedTextures[e][t]=this._managedTextures[e][t]||new s.ManagedTexture(this._name,this._images[e][t],this._useMipmap),this._managedTextures[e][t])},TextureResource.prototype.getManagedTexturesOfTypes=function(t,i){var n,s,o;for(t.sort(),n=0;n<this._cachedManagedTexturesOfTypes.length;n++)if(e.arraysEqual(t,this._cachedManagedTexturesOfTypes[n].types)&&e.arraysEqual(i,this._cachedManagedTexturesOfTypes[n].qualityPreferenceList))return this._cachedManagedTexturesOfTypes[n].textures;for(s={},o=this._getMostFittingQuality(i),n=0;n<t.length;n++)s[t[n]]=this.getManagedTexture(t[n],o);return this._cachedManagedTexturesOfTypes.push({types:t,qualityPreferenceList:i,textures:s}),s},CubemapResource.prototype=new MediaResource,CubemapResource.prototype.constructor=CubemapResource,CubemapResource.prototype._loadConfig=function(e){MediaResource.prototype._loadConfig.call(this,e),this._basepath=e.basepath,this._format=e.format,this._imageNames=e.imageNames,this._qualitySuffixes=e.qualitySuffixes,this._loadedImages=0,this._imagesToLoad=0,this._images={},this._cachedManagedCubemaps=[]},CubemapResource.prototype._getPath=function(e,t){return this._basepath+this._imageNames[e]+this._qualitySuffixes[t]+"."+this._format},CubemapResource.prototype._getOnLoadImageFunction=function(e,t){var i=this._getPath(e,t);return function(){this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:i})}.bind(this)},CubemapResource.prototype._handleError=function(e){i.showError("Could not load cube mapped texture '"+this._name+"': downloading file '"+e+"' failed!"),this._loadedImages++,this._onFilesLoad(this._loadedImages===this._imagesToLoad,{path:e,error:!0})},CubemapResource.prototype._getMostFittingQuality=function(e){var t,n,s,o=this.getQualities(),r=-1;for(t=0;t<o.length;t++)(n=e.indexOf(o[t]))>=0&&(-1===r||n<r)&&(r=n,s=e[n]);return-1===r?(i.showError("Cubemap '"+this._name+"' is not available in any of the qualities: ["+e.join(", ")+"]!"),null):s},CubemapResource.prototype._getProcessedParams=function(e){return e=e||{},e.qualities=e.qualities||e.qualityPreferenceList&&[this._getMostFittingQuality(e.qualityPreferenceList)]||Object.keys(this._qualitySuffixes),delete e.qualityPreferenceList,e},CubemapResource.prototype.requiresReload=function(e){var t,i;if(e=this._getProcessedParams(e),this.isRequested(e))return!1;for(t in this._imageNames)if(this._imageNames.hasOwnProperty(t)){if(!this._images[t])return!0;for(i=0;i<e.qualities.length;i++)if(this._qualitySuffixes.hasOwnProperty(e.qualities[i])&&!this._images[t][e.qualities[i]])return!0}return!1},CubemapResource.prototype._requestFiles=function(e){var t,n,s,o;e=this._getProcessedParams(e);for(t in this._imageNames)if(this._imageNames.hasOwnProperty(t))for(this._images[t]=this._images[t]||{},n=0;n<e.qualities.length;n++)s=e.qualities[n],this._qualitySuffixes.hasOwnProperty(s)&&(this._images[t][s]||(o=this._getPath(t,s),f[o]?this._images[t][s]=f[o]:(f[o]=new Image,this._imagesToLoad++,this._images[t][s]=f[o],this._images[t][s].onload=this._getOnLoadImageFunction(t,s).bind(this),this._images[t][s].onerror=this._handleError.bind(this,o))));for(t in this._imageNames)if(this._imageNames.hasOwnProperty(t))for(n=0;n<e.qualities.length;n++)s=e.qualities[n],this._qualitySuffixes.hasOwnProperty(s)&&(this._images[t][s].src||(this._images[t][s].src=i.getFileURL("texture",this._getPath(t,s))));this._loadedImages===this._imagesToLoad&&this._onFilesLoad(!0,{path:this._basepath})},CubemapResource.prototype._loadData=function(e){return!e.error},CubemapResource.prototype.getQualities=function(){return Object.keys(this._qualitySuffixes)},CubemapResource.prototype.getManagedCubemap=function(t){var n,o,r;if(!1===this._readyToUse)return i.showError("Cannot get managed GL cubemap for '"+this._name+"', as it has not been loaded from file yet!"),null;for(n=0;n<this._cachedManagedCubemaps.length;n++)if(e.arraysEqual(t,this._cachedManagedCubemaps[n].qualityPreferenceList))return this._cachedManagedCubemaps[n].cubemap;return r=this._getMostFittingQuality(t),o=new s.ManagedCubemap(this._name,[this._images.posX[r],this._images.negX[r],this._images.posY[r],this._images.negY[r],this._images.posZ[r],this._images.negZ[r]]),this._cachedManagedCubemaps.push({qualityPreferenceList:t,cubemap:o}),o},ShaderResource.prototype=new MediaResource,ShaderResource.prototype.constructor=ShaderResource,ShaderResource.prototype._loadConfig=function(e){MediaResource.prototype._loadConfig.call(this,e),this._variantShaderNames=e.variants||null,this._vertexShaderSourcePath=e.vertexShaderSource,this._fragmentShaderSourcePath=e.fragmentShaderSource,this._blendMode=t.getEnumValue(s.ShaderBlendMode,e.blendMode,{name:"shader.blendMode"}),this._vertexAttributeRoles=e.vertexAttributeRoles,this._instanceAttributeRoles=e.instanceAttributeRoles||{},this._vertexShaderSource=null,this._fragmentShaderSource=null,this._managedShaderBindings=[],this._shaderIncludesToLoad=0,this._shaderIncludesLoaded=0},ShaderResource.prototype._checkAllSourcesLoaded=function(){this._vertexShaderSource&&this._fragmentShaderSource&&this._shaderIncludesLoaded===this._shaderIncludesToLoad&&("-"===this._vertexShaderSource&&(this._vertexShaderSource=null),"-"===this._fragmentShaderSource&&(this._fragmentShaderSource=null),this.onFinalLoad())},ShaderResource.prototype._loadIncludeSource=function(e,t,i){var n;for(g[t].source=i,this._resolveInclude(e,t),n=0;n<g[t].onLoad.length;n++)g[t].onLoad[n]()},ShaderResource.prototype._getIncludeFileName=function(e){return e.substr('#include "'.length,e.length-('#include "'.length+'"'.length))},ShaderResource.prototype._resolveInclude=function(e,t){var i,n,s=g[t].source;switch(e){case l.VERTEX:n=this._vertexShaderSource.split("\n");break;case l.FRAGMENT:n=this._fragmentShaderSource.split("\n")}for(i=0;i<n.length;i++)if('#include "'===n[i].substr(0,'#include "'.length)&&t===this._getIncludeFileName(n[i])){switch(n[i]=s,e){case l.VERTEX:this._vertexShaderSource=n.join("\n");break;case l.FRAGMENT:this._fragmentShaderSource=n.join("\n")}this._resolveSource(e,s);break}this._shaderIncludesLoaded++,this._checkAllSourcesLoaded()},ShaderResource.prototype._resolveSource=function(e,t){var n,s=t.split("\n"),o=[];for(n=0;n<s.length;n++)'#include "'===s[n].substr(0,'#include "'.length)&&(o.push(this._getIncludeFileName(s[n])),this._shaderIncludesToLoad++);for(n=0;n<o.length;n++)g[o[n]]?g[o[n]].source?this._resolveInclude(e,o[n]):g[o[n]].onLoad.push(this._resolveInclude.bind(this,e,o[n])):(g[o[n]]={onLoad:[]},i.requestTextFile("shader",o[n],this._loadIncludeSource.bind(this,e,o[n])))},ShaderResource.prototype.requiresReload=function(){return!this.isRequested()&&!this.isLoaded()},ShaderResource.prototype._requestFiles=function(){i.requestTextFile("shader",this._vertexShaderSourcePath,function(e){this._onFilesLoad(!1,{shaderType:l.VERTEX,text:e})}.bind(this)),i.requestTextFile("shader",this._fragmentShaderSourcePath,function(e){this._onFilesLoad(!1,{shaderType:l.FRAGMENT,text:e})}.bind(this))},ShaderResource.prototype._loadData=function(e){switch(t.getEnumValue(l,e.shaderType,{name:"shaderType",defaultValue:null})){case l.VERTEX:this._vertexShaderSource=e.text||"-";break;case l.FRAGMENT:this._fragmentShaderSource=e.text||"-"}return e.text&&this._resolveSource(e.shaderType,e.text),this._checkAllSourcesLoaded(),!!e.text},ShaderResource.prototype.getVariantShaderName=function(e){return this._variantShaderNames?this._variantShaderNames[e]:null},ShaderResource.prototype.getManagedShader=function(t,n){var o;if(!1===this._readyToUse)return i.showError("Cannot get managed GL shader for '"+this._name+"', as it has not been loaded from file yet!"),null;for(t=t||null,o=0;o<this._managedShaderBindings.length;o++)if(e.objectsEqual(this._managedShaderBindings[o].replacedDefines,t))return this._managedShaderBindings[o].managedShader;return this._managedShaderBindings.push({managedShader:new s.ManagedShader(this._name,this._vertexShaderSource,this._fragmentShaderSource,this._blendMode,this._vertexAttributeRoles,this._instanceAttributeRoles,t,n),replacedDefines:t}),this._managedShaderBindings[this._managedShaderBindings.length-1].managedShader},ModelResource.prototype=new MediaResource,ModelResource.prototype.constructor=ModelResource,ModelResource.prototype._loadConfig=function(e){if(MediaResource.prototype._loadConfig.call(this,e),e.model)return this._model=e.model,this._files=[],this._dataJSON=null,void this.setToReady();this._basepath=e.basepath,this._format=e.format,this._files=e.files,this._loadedFiles=0,this._filesToLoad=0,this._model=null,this._maxLoadedLOD=-1},ModelResource.prototype._getPath=function(e){var t;for(t=0;t<this._files.length;t++)if(this._files[t].maxLOD===e)return this._basepath+this._files[t].suffix+"."+this._format;return null},ModelResource.prototype.requiresReload=function(e){return!this.isRequested(e)&&(0!==this._files.length&&(e&&"number"==typeof e.maxLOD?e.maxLOD>this._maxLoadedLOD:null!==this.getMaxLOD()&&this.requiresReload({maxLOD:this.getMaxLOD()})))},ModelResource.prototype.getMaxLOD=function(){var e,t=null;for(e=0;e<this._files.length;e++)(null===t||this._files[e].maxLOD>t)&&(t=this._files[e].maxLOD);return t},ModelResource.prototype._requestFile=function(e){this._filesToLoad++,i.requestTextFile("model",this._getPath(e),function(t){this._loadedFiles++,this._onFilesLoad(this._filesToLoad===this._loadedFiles,{maxLOD:e,text:t})}.bind(this))},ModelResource.prototype._requestFiles=function(e){var t,n;if(e=e||{},void 0!==e.maxLOD){for(t=e.maxLOD;t>=0;t--)if(null!==this._getPath(t))return void this._requestFile(t);if(t<0&&this._files.length>0)for(n=this.getMaxLOD(),t=e.maxLOD+1;t<=n;t++)if(null!==this._getPath(t))return void this._requestFile(t);i.showError("Could not find any files to load for model: '"+this._name+"'!")}else this._requestFiles({maxLOD:this.getMaxLOD()})},ModelResource.prototype._loadData=function(e){return this._model=new o.Model,e.text?("{"===e.text[0]?this._model.loadFromJSON(this._getPath(e.maxLOD),JSON.parse(e.text),e.maxLOD):i.showError("Cannot load Egom Model from file '"+this._getPath(e.maxLOD)+"' - the file needs to start with '{'!"),this._maxLoadedLOD=e.maxLOD,!0):(i.showError("Model file of max LOD level "+e.maxLOD+" could not be loaded for model '"+this._name+"'!"),!1)},ModelResource.prototype.getEgomModel=function(){return!1===this._readyToUse?(i.showError("Cannot get model object for '"+this._name+"', as it has not been loaded from file yet!"),null):this._model},SoundEffectResource.prototype=new MediaResource,SoundEffectResource.prototype.constructor=SoundEffectResource,SoundEffectResource.prototype._loadConfig=function(e){MediaResource.prototype._loadConfig.call(this,e),this._samples=e.samples,this._loadedSamples=0,this._samplesToLoad=0},SoundEffectResource.prototype.requiresReload=function(){return!this._readyToUse&&!this.isRequested()},SoundEffectResource.prototype._requestFile=function(e){this._samplesToLoad++,i.requestFile("soundEffect",this._samples[e],function(t){t?r.loadSample(this._samples[e],t,function(){this._loadedSamples++,this._onFilesLoad(this._samplesToLoad===this._loadedSamples,{path:this._samples[e]})}.bind(this)):(i.showError("Could not load sound sample '"+this._name+"'!"),this._samples[e]=null,this._loadedSamples++,this._onFilesLoad(this._samplesToLoad===this._loadedSamples,{path:this._samples[e],error:!0}))}.bind(this),void 0,"arraybuffer")},SoundEffectResource.prototype._requestFiles=function(){var e;for(e=0;e<this._samples.length;e++)this._requestFile(e)},SoundEffectResource.prototype._loadData=function(e){return!e.error},SoundEffectResource.prototype.play=function(e,t,n){var s;if(!1===this._readyToUse)return void i.showError("Cannot play sound effect '"+this._name+"', as it has not been loaded from file yet!");(s=this._samples[Math.floor(Math.random()*this._samples.length)])&&r.playSound(s,e,t,n)},SoundEffectResource.prototype.createSoundClip=function(e,t,n,s,o,a,l){var c;return!1===this._readyToUse?(i.showError("Cannot create sound source for sound effect '"+this._name+"', as it has not been loaded from file yet!"),null):(c=this._samples[Math.floor(Math.random()*this._samples.length)],c?new r.SoundClip(e,c,t,n,s,o,a,l):null)},MusicResource.prototype=new MediaResource,MusicResource.prototype.constructor=MusicResource,MusicResource.prototype._loadConfig=function(e){MediaResource.prototype._loadConfig.call(this,e),this._sample=e.sample},MusicResource.prototype.requiresReload=function(){return!this._readyToUse&&!this.isRequested()},MusicResource.prototype._requestFiles=function(){i.requestFile("music",this._sample,function(e){e?r.loadSample(this._sample,e,function(){this._onFilesLoad(!0,{path:this._sample})}.bind(this)):(i.showError("Could not load music track '"+this._name+"'!"),this._sample=null,this._onFilesLoad(!0,{path:this._sample,error:!0}))}.bind(this),void 0,"arraybuffer")},MusicResource.prototype._loadData=function(e){return!e.error},MusicResource.prototype.createSoundClip=function(e,t){return!1===this._readyToUse?(i.showError("Cannot create sound source for music '"+this._name+"', as it has not been loaded from file yet!"),null):this._sample?new r.SoundClip(r.SoundCategory.MUSIC,this._sample,e,t):null},MediaResourceManager.prototype=new n.ResourceManager,
MediaResourceManager.prototype.constructor=MediaResourceManager,MediaResourceManager.prototype.getTexture=function(e,t){return this.getResource(c,e,t)},MediaResourceManager.prototype.getCubemap=function(e,t){return this.getResource(h,e,t)},MediaResourceManager.prototype.getShader=function(e){return this.getResource(u,e)},MediaResourceManager.prototype.getVariantShader=function(e,t){return this.getResource(u,this.getResource(u,e,{doNotLoad:!0}).getVariantShaderName(t),{allowNullResult:!0})||this.getShader(e)},MediaResourceManager.prototype.getModel=function(e,t){return this.getResource(d,e,t)},MediaResourceManager.prototype.getOrAddModel=function(e){var t=this.getResource(d,e._name,{allowNullResult:!0});return t||(t=this.addResource(d,new ModelResource({name:e._name,model:e}),!0)),t},MediaResourceManager.prototype.getSoundEffect=function(e){return this.getResource(p,e)},MediaResourceManager.prototype.getMusic=function(e){return this.getResource(_,e)},a=new MediaResourceManager,{SoundCategory:r.SoundCategory,requestConfigLoad:requestConfigLoad,requestResourceLoad:a.requestResourceLoad.bind(a),getTexture:a.getTexture.bind(a),getCubemap:a.getCubemap.bind(a),getShader:a.getShader.bind(a),getVariantShader:a.getVariantShader.bind(a),getModel:a.getModel.bind(a),getOrAddModel:a.getOrAddModel.bind(a),getSoundEffect:a.getSoundEffect.bind(a),getMusic:a.getMusic.bind(a),getResourceTypes:a.getResourceTypes.bind(a),getResourceNames:a.getResourceNames.bind(a),getResource:a.getResource.bind(a),addResource:a.addResource.bind(a),createResource:a.createResource.bind(a),executeWhenReady:a.executeWhenReady.bind(a),executeOnResourceLoad:a.executeOnResourceLoad.bind(a),executeForAllResources:a.executeForAllResources.bind(a),renameResource:a.renameResource.bind(a),moveResourceAfter:a.moveResourceAfter.bind(a)}}),define("utils/matrices",["utils/utils","utils/vectors"],function(e,t){"use strict";function _getFreeTempMatrixIndex(){var e;for(e=0;e<n.length;e++)if(!n[e].used)return e;return n.push({used:!1,matrix:i.identity4()}),n.length-1}function _getTempMatrix(e){return n[e].used=!0,n[e].matrix}function _releaseTempMatrix(e){n[e].used=!1}var i={},n=[],s=[],o=0,r=[],a=0,l=0;return i.clearMatrixCount=function(){l=0},i.getMatrixCount=function(){return l},i.identity3=function(){return new Float32Array([1,0,0,0,1,0,0,0,1])},i.identity3Aux=function(){var e=r[a];return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,a=(a+1)%20,e},i.IDENTITY3=i.identity3(),i.identity4=function(){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},i.identity4Aux=function(){var e=s[o];return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,o=(o+1)%20,e},i.IDENTITY4=i.identity4(),i.copy=function(e){return new Float32Array(e)},i.matrix3Aux=function(e){var t=r[a];return t.set(e),a=(a+1)%20,t},i.matrix4Aux=function(e){var t=s[o];return t.set(e),o=(o+1)%20,t},i.translation4=function(e,t,i){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1])},i.translation4Aux=function(e,t,i){var n=s[o];return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=e,n[13]=t,n[14]=i,n[15]=1,o=(o+1)%20,n},i.translation4v=function(e){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,e[0],e[1],e[2],1])},i.translation4vAux=function(e){var t=s[o];return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,o=(o+1)%20,t},i.translation4m4=function(e){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],1])},i.translation4m4Aux=function(e){var t=s[o];return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=1,o=(o+1)%20,t},i.rotation2=function(e){var t=Math.cos(e),i=Math.sin(e);return new Float32Array([t,-i,i,t])},i.rotation3Aux=function(e,t){var i=Math.cos(t),n=Math.sin(t),s=r[a];return s[0]=i+(1-i)*e[0]*e[0],s[1]=(1-i)*e[0]*e[1]-n*e[2],s[2]=(1-i)*e[0]*e[2]+n*e[1],s[3]=(1-i)*e[0]*e[1]+n*e[2],s[4]=i+(1-i)*e[1]*e[1],s[5]=(1-i)*e[1]*e[2]-n*e[0],s[6]=(1-i)*e[0]*e[2]-n*e[1],s[7]=(1-i)*e[1]*e[2]+n*e[0],s[8]=i+(1-i)*e[2]*e[2],a=(a+1)%20,s},i.rotationX4=function(e){var t=Math.cos(e),i=Math.sin(e);return new Float32Array([1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1])},i.ROTATION_X_90=i.rotationX4(.5*Math.PI),i.ROTATION_X_180=i.rotationX4(1*Math.PI),i.ROTATION_X_270=i.rotationX4(1.5*Math.PI),i.rotationY4=function(e){var t=Math.cos(e),i=Math.sin(e);return new Float32Array([t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1])},i.ROTATION_Y_90=i.rotationY4(.5*Math.PI),i.ROTATION_Y_180=i.rotationY4(1*Math.PI),i.ROTATION_Y_270=i.rotationY4(1.5*Math.PI),i.rotationZ4=function(e){var t=Math.cos(e),i=Math.sin(e);return new Float32Array([t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1])},i.ROTATION_Z_90=i.rotationZ4(.5*Math.PI),i.ROTATION_Z_180=i.rotationZ4(1*Math.PI),i.ROTATION_Z_270=i.rotationZ4(1.5*Math.PI),i.rotation4Aux=function(e,t){var i=Math.cos(t),n=Math.sin(t),r=s[o];return r[0]=i+(1-i)*e[0]*e[0],r[1]=(1-i)*e[0]*e[1]-n*e[2],r[2]=(1-i)*e[0]*e[2]+n*e[1],r[3]=0,r[4]=(1-i)*e[0]*e[1]+n*e[2],r[5]=i+(1-i)*e[1]*e[1],r[6]=(1-i)*e[1]*e[2]-n*e[0],r[7]=0,r[8]=(1-i)*e[0]*e[2]-n*e[1],r[9]=(1-i)*e[1]*e[2]+n*e[0],r[10]=i+(1-i)*e[2]*e[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,o=(o+1)%20,r},i.rotationX4Aux=function(e){var t=Math.cos(e),i=Math.sin(e),n=s[o];return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=t,n[6]=-i,n[7]=0,n[8]=0,n[9]=i,n[10]=t,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,o=(o+1)%20,n},i.rotationZ4Aux=function(e){var t=Math.cos(e),i=Math.sin(e),n=s[o];return n[0]=t,n[1]=-i,n[2]=0,n[3]=0,n[4]=i,n[5]=t,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,o=(o+1)%20,n},i.lookTowards4=function(e,t){var n;return n=i.identity4(),i.setLookTowards4(n,e,t),n},i.lookTowards4Aux=function(e,t){var n=s[o];return i.setLookTowards4(n,e,t),o=(o+1)%20,n},i.scaling4=function(e,t,i){return void 0===t&&(t=e),void 0===i&&(i=e),new Float32Array([e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1])},i.scaling4Aux=function(e,t,i){var n=s[o];return void 0===t&&(t=e),void 0===i&&(i=e),n[0]=e,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=t,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=i,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,o=(o+1)%20,n},i.rotation4FromJSON=function(n){var s,o,r,a=i.identity4();if(n)for(s=0;s<n.length;s++){if(r="string"==typeof n[s]?{axis:n[s][0],degrees:parseFloat(n[s].substring(1))}:n[s],"string"==typeof r.axis)switch(r.axis){case"x":case"X":o=t.UNIT3_X;break;case"y":case"Y":o=t.UNIT3_Y;break;case"z":case"Z":o=t.UNIT3_Z}else r.axis instanceof Array&&(o=r.axis);i.mulRotationRotation4(a,i.rotation4Aux(o,r.degrees*e.RAD))}return a},i.getRowD4=function(e){return[e[12],e[13],e[14],e[15]]},i.determinant3=function(e){return e[0]*e[4]*e[8]+e[1]*e[5]*e[6]+e[2]*e[3]*e[7]-e[2]*e[4]*e[6]-e[1]*e[3]*e[8]-e[0]*e[5]*e[7]},i.translationVector3=function(e){return[e[12],e[13],e[14]]},i.translationLength=function(e){return Math.sqrt(e[12]*e[12]+e[13]*e[13]+e[14]*e[14])},i.getYawAndPitch=function(n){var s,o={};return Math.abs(n[6])>.99999?(o.yaw=0,o.pitch=n[6]>0?-e.HALF_PI:e.HALF_PI):(o.yaw=n[10]>0?t.angle2yCapped(n[4],n[5]):t.angle2yCapped(-n[4],-n[5]),n[4]*n[10]<0&&(o.yaw=-o.yaw),s=i.prod3x3SubOf4Aux(n,i.rotationZ4Aux(-o.yaw)),i.correctOrthogonal4(s),o.pitch=t.angle2xCapped(s[5],s[6]),s[6]>0&&(o.pitch=-o.pitch)),o},i.getRotations=function(n){var s,o,r={};return s=t.dot3(t.UNIT3_Y,t.getRowB43Aux(n)),Math.abs(s)>.99999?(r.alphaAxis=[0,0,1],r.alpha=s>0?0:Math.PI):(r.alphaAxis=t.normalize3(t.cross3(t.getRowB43Aux(n),t.UNIT3_Y)),r.alpha=t.angle3u(t.getRowB43Aux(n),t.UNIT3_Y)),r.alpha>Math.PI&&(r.alpha-=e.DOUBLE_PI),o=i.prod3x3SubOf43Aux(n,i.rotation3Aux(r.alphaAxis,-r.alpha)),i.correctOrthogonal4(o),s=t.dot3(t.UNIT3_X,t.getRowA43Aux(o)),Math.abs(s)>.99999?(r.gammaAxis=[0,1,0],r.gamma=s>0?0:Math.PI):(r.gammaAxis=t.normalize3(t.cross3(t.getRowA43Aux(o),t.UNIT3_X)),r.gamma=t.angle3u(t.getRowA43Aux(o),t.UNIT3_X)),r.gamma>Math.PI&&(r.gamma-=e.DOUBLE_PI),r},i.toString3=function(e,t){return t=t||2,e[0].toFixed(t)+" "+e[1].toFixed(t)+" "+e[2].toFixed(t)+"\n"+e[3].toFixed(t)+" "+e[4].toFixed(t)+" "+e[5].toFixed(t)+"\n"+e[6].toFixed(t)+" "+e[7].toFixed(t)+" "+e[8].toFixed(t)},i.toString4=function(e,t){return t=t||2,e[0].toFixed(t)+" "+e[1].toFixed(t)+" "+e[2].toFixed(t)+" "+e[3].toFixed(t)+"\n"+e[4].toFixed(t)+" "+e[5].toFixed(t)+" "+e[6].toFixed(t)+" "+e[7].toFixed(t)+"\n"+e[8].toFixed(t)+" "+e[9].toFixed(t)+" "+e[10].toFixed(t)+" "+e[11].toFixed(t)+"\n"+e[12].toFixed(t)+" "+e[13].toFixed(t)+" "+e[14].toFixed(t)+" "+e[15].toFixed(t)},i.toHTMLString4=function(e,t){return t=t||2,e[0].toFixed(t)+" "+e[1].toFixed(t)+" "+e[2].toFixed(t)+" "+e[3].toFixed(t)+"<br/>"+e[4].toFixed(t)+" "+e[5].toFixed(t)+" "+e[6].toFixed(t)+" "+e[7].toFixed(t)+"<br/>"+e[8].toFixed(t)+" "+e[9].toFixed(t)+" "+e[10].toFixed(t)+" "+e[11].toFixed(t)+"<br/>"+e[12].toFixed(t)+" "+e[13].toFixed(t)+" "+e[14].toFixed(t)+" "+e[15].toFixed(t)},i.matrix3from4Aux=function(e){var t=r[a];return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],a=(a+1)%20,t},i.transposed3Aux=function(e){var t=r[a];return i.setTransposed3(t,e),a=(a+1)%20,t},i.transposed4=function(e){return new Float32Array([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]])},i.transposed4Aux=function(e){var t=s[o];return i.setTransposed4(t,e),o=(o+1)%20,t},i.transpose3=function(e){var t=e[1],i=e[2],n=e[5];e[1]=e[3],e[3]=t,e[2]=e[6],e[6]=i,e[5]=e[7],e[7]=n},i.inverse3Aux=function(e){var t=r[a];return i.setInverse3(t,e),a=(a+1)%20,t},i.inverse4Aux=function(e){var t=s[o];return i.setInverse4(t,e),o=(o+1)%20,t},i.inverseOfTranslation4Aux=function(e){var t=s[o];return i.setInverseOfTranslation4(t,e),o=(o+1)%20,t},i.inverseOfRotation4=i.transposed4,i.inverseOfRotation4Aux=i.transposed4Aux,i.equal4=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]},i.prod4Aux=function(e,t){var n=s[o];return i.setProd4(n,e,t),o=(o+1)%20,n},i.prod3x3SubOf4Aux=function(e,t){var i=s[o];return i[0]=e[0]*t[0]+e[1]*t[4]+e[2]*t[8],i[1]=e[0]*t[1]+e[1]*t[5]+e[2]*t[9],i[2]=e[0]*t[2]+e[1]*t[6]+e[2]*t[10],i[3]=0,i[4]=e[4]*t[0]+e[5]*t[4]+e[6]*t[8],i[5]=e[4]*t[1]+e[5]*t[5]+e[6]*t[9],i[6]=e[4]*t[2]+e[5]*t[6]+e[6]*t[10],i[7]=0,i[8]=e[8]*t[0]+e[9]*t[4]+e[10]*t[8],i[9]=e[8]*t[1]+e[9]*t[5]+e[10]*t[9],i[10]=e[8]*t[2]+e[9]*t[6]+e[10]*t[10],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,o=(o+1)%20,i},i.scaledRotationAux=function(e,t){var i=s[o];return i[0]=e*t[0],i[1]=e*t[1],i[2]=e*t[2],i[3]=0,i[4]=e*t[4],i[5]=e*t[5],i[6]=e*t[6],i[7]=0,i[8]=e*t[8],i[9]=e*t[9],i[10]=e*t[10],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,o=(o+1)%20,i},i.prodScalingRotation3Aux=function(e,t){var i=r[a];return i[0]=e[0]*t[0],i[1]=e[0]*t[1],i[2]=e[0]*t[2],i[3]=e[5]*t[4],i[4]=e[5]*t[5],i[5]=e[5]*t[6],i[6]=e[10]*t[8],i[7]=e[10]*t[9],i[8]=e[10]*t[10],a=(a+1)%20,i},i.prod3x3SubOf43Aux=function(e,t){var i=s[o];return i[0]=e[0]*t[0]+e[1]*t[3]+e[2]*t[6],i[1]=e[0]*t[1]+e[1]*t[4]+e[2]*t[7],i[2]=e[0]*t[2]+e[1]*t[5]+e[2]*t[8],i[3]=0,i[4]=e[4]*t[0]+e[5]*t[3]+e[6]*t[6],i[5]=e[4]*t[1]+e[5]*t[4]+e[6]*t[7],i[6]=e[4]*t[2]+e[5]*t[5]+e[6]*t[8],i[7]=0,i[8]=e[8]*t[0]+e[9]*t[3]+e[10]*t[6],i[9]=e[8]*t[1]+e[9]*t[4]+e[10]*t[7],i[10]=e[8]*t[2]+e[9]*t[5]+e[10]*t[8],i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,o=(o+1)%20,i},i.prodTranslationRotation4=function(e,t){return new Float32Array([t[0],t[1],t[2],0,t[4],t[5],t[6],0,t[8],t[9],t[10],0,t[0]*e[12]+t[4]*e[13]+t[8]*e[14],t[1]*e[12]+t[5]*e[13]+t[9]*e[14],t[2]*e[12]+t[6]*e[13]+t[10]*e[14],1])},i.prodTranslationRotation4Aux=function(e,t){var n=s[o];return i.setProdTranslationRotation4(n,e,t),o=(o+1)%20,n},i.prod34Aux=function(e,t,n){var s=i.prod4Aux(e,t);return i.mul4(s,n),s},i.translatedByM4Aux=function(e,t){var n=s[o];return i.setTranslatedByM4(n,e,t),o=(o+1)%20,n},i.distanceSquared=function(e,t){return(e[12]-t[12])*(e[12]-t[12])+(e[13]-t[13])*(e[13]-t[13])+(e[14]-t[14])*(e[14]-t[14])},i.setIdentity3=function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},i.setIdentity4=function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1},i.setMatrix3=function(e,t){var i;for(i=0;i<9;i++)e[i]=t[i]},i.setMatrix4=function(e,t){var i;for(i=0;i<16;i++)e[i]=t[i]},i.copyTranslation4=function(e,t){e[12]=t[12],e[13]=t[13],e[14]=t[14]},i.copyRotation4=function(e,t){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[8]=t[8],e[9]=t[9],e[10]=t[10]},i.copyScaling4=function(e,t){e[0]=t[0],e[5]=t[5],e[10]=t[10]},i.updateTranslation4v=function(e,t){e[12]=t[0],e[13]=t[1],e[14]=t[2]},i.setRotation2=function(e,t){var i=Math.cos(t),n=Math.sin(t);e[0]=i,e[1]=-n,e[2]=n,e[3]=i},i.setRotation3=function(e,t,i){var n=Math.cos(i),s=Math.sin(i);e[0]=n+(1-n)*t[0]*t[0],e[1]=(1-n)*t[0]*t[1]-s*t[2],e[2]=(1-n)*t[0]*t[2]+s*t[1],e[3]=(1-n)*t[0]*t[1]+s*t[2],e[4]=n+(1-n)*t[1]*t[1],e[5]=(1-n)*t[1]*t[2]-s*t[0],e[6]=(1-n)*t[0]*t[2]-s*t[1],e[7]=(1-n)*t[1]*t[2]+s*t[0],e[8]=n+(1-n)*t[2]*t[2]},i.setRotation4=function(e,t,i){var n=Math.cos(i),s=Math.sin(i);e[0]=n+(1-n)*t[0]*t[0],e[1]=(1-n)*t[0]*t[1]-s*t[2],e[2]=(1-n)*t[0]*t[2]+s*t[1],e[3]=0,e[4]=(1-n)*t[0]*t[1]+s*t[2],e[5]=n+(1-n)*t[1]*t[1],e[6]=(1-n)*t[1]*t[2]-s*t[0],e[7]=0,e[8]=(1-n)*t[0]*t[2]-s*t[1],e[9]=(1-n)*t[1]*t[2]+s*t[0],e[10]=n+(1-n)*t[2]*t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1},i.setRotationAroundPoint4=function(e,n,s,o){var r;i.setRotation4(e,s,o),r=t.prodVec3Mat4Aux(n,e),e[12]=n[0]-r[0],e[13]=n[1]-r[1],e[14]=n[2]-r[2]},i.setLookTowards4=function(e,n,s){var o;s=s||[0,1,0],Math.abs(t.dot3(s,n))>.99999&&(s=t.perpendicular3(n)),o=t.cross3Aux(s,n),e[0]=o[0],e[1]=o[1],e[2]=o[2],s=t.cross3Aux(n,o),e[4]=s[0],e[5]=s[1],e[6]=s[2],i.correctOrthogonal4(e)},i.translateByVector=function(e,t){e[12]+=t[0],e[13]+=t[1],e[14]+=t[2]},i.translateByMatrix=function(e,t){e[12]+=t[12],e[13]+=t[13],e[14]+=t[14]},i.translateByMatrixMul=function(e,t,i){e[12]+=t[12]*i,e[13]+=t[13]*i,e[14]+=t[14]*i},i.rotate4=function(e,t,n){var s=_getFreeTempMatrixIndex(),o=_getTempMatrix(s);i.setRotation3(o,t,n),i.mul43(e,o),_releaseTempMatrix(s)},i.rotateAroundPoint4=function(e,t,n,s){var o=_getFreeTempMatrixIndex(),r=_getTempMatrix(o);i.setRotationAroundPoint4(r,t,n,s),i.mul4(e,r),_releaseTempMatrix(o)},i.setInverse3=function(e,t){var n,s,o,r,a,l,c,h=_getFreeTempMatrixIndex();if(l=_getTempMatrix(h),i.setMatrix3(l,t),i.setIdentity3(e),0!==i.determinant3(l)){for(n=0;n<3;n++){if(Math.abs(l[4*n])<=1e-4){for(s=n+1;Math.abs(l[3*s+n])<=1e-4;)s++;for(o=0;o<3;o++)c=l[3*n+o],l[3*n+o]=l[3*s+o],l[3*s+o]=c,c=e[3*n+o],e[3*n+o]=e[3*s+o],e[3*s+o]=c}for(r=l[4*n],s=0;s<3;s++)l[3*n+s]=l[3*n+s]/r,e[3*n+s]=e[3*n+s]/r;for(s=n+1;s<3;s++)for(a=l[3*s+n]/l[4*n],o=0;o<3;o++)l[3*s+o]=l[3*s+o]-a*l[3*n+o],e[3*s+o]=e[3*s+o]-a*e[3*n+o]}for(n=2;n>=1;n--)for(s=n-1;s>=0;s--)for(o=0;o<3;o++)e[3*s+o]=e[3*s+o]-l[3*s+n]*e[3*n+o];_releaseTempMatrix(h)}},i.setInverse4=function(e,t){var n,s,o,r,a,l,c,h=_getFreeTempMatrixIndex();for(l=_getTempMatrix(h),i.setMatrix4(l,t),i.setIdentity4(e),n=0;n<4;n++){if(Math.abs(l[5*n])<=1e-4){for(s=n+1;Math.abs(l[4*s+n])<=1e-4;)s++;for(o=0;o<4;o++)c=l[4*n+o],l[4*n+o]=l[4*s+o],l[4*s+o]=c,c=e[4*n+o],e[4*n+o]=e[4*s+o],e[4*s+o]=c}for(r=l[5*n],s=0;s<4;s++)l[4*n+s]=l[4*n+s]/r,e[4*n+s]=e[4*n+s]/r;for(s=n+1;s<4;s++)for(a=l[4*s+n]/l[5*n],o=0;o<4;o++)l[4*s+o]=l[4*s+o]-a*l[4*n+o],e[4*s+o]=e[4*s+o]-a*e[4*n+o]}for(n=3;n>=1;n--)for(s=n-1;s>=0;s--)for(o=0;o<4;o++)e[4*s+o]=e[4*s+o]-l[4*s+n]*e[4*n+o];_releaseTempMatrix(h)},i.setInverseOfTranslation4=function(e,t){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=-t[12],e[13]=-t[13],e[14]=-t[14],e[15]=1},i.setTransposed3=function(e,t){e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]},i.setTransposed4=function(e,t){e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15]},i.setInverseOfRotation4=i.setTransposed4,i.mul3=function(e,t){var n=_getFreeTempMatrixIndex(),s=_getTempMatrix(n);i.setMatrix3(s,e),e[0]=s[0]*t[0]+s[1]*t[3]+s[2]*t[6],e[1]=s[0]*t[1]+s[1]*t[4]+s[2]*t[7],e[2]=s[0]*t[2]+s[1]*t[5]+s[2]*t[8],e[3]=s[3]*t[0]+s[4]*t[3]+s[5]*t[6],e[4]=s[3]*t[1]+s[4]*t[4]+s[5]*t[7],e[5]=s[3]*t[2]+s[4]*t[5]+s[5]*t[8],e[6]=s[6]*t[0]+s[7]*t[3]+s[8]*t[6],e[7]=s[6]*t[1]+s[7]*t[4]+s[8]*t[7],e[8]=s[6]*t[2]+s[7]*t[5]+s[8]*t[8],_releaseTempMatrix(n)},i.mul3multi=function(e,t,n){var s,o=_getFreeTempMatrixIndex(),r=_getTempMatrix(o);for(s=0;s<n;s++)i.setMatrix3(r,e),e[0]=r[0]*t[0]+r[1]*t[3]+r[2]*t[6],e[1]=r[0]*t[1]+r[1]*t[4]+r[2]*t[7],e[2]=r[0]*t[2]+r[1]*t[5]+r[2]*t[8],e[3]=r[3]*t[0]+r[4]*t[3]+r[5]*t[6],e[4]=r[3]*t[1]+r[4]*t[4]+r[5]*t[7],e[5]=r[3]*t[2]+r[4]*t[5]+r[5]*t[8],e[6]=r[6]*t[0]+r[7]*t[3]+r[8]*t[6],e[7]=r[6]*t[1]+r[7]*t[4]+r[8]*t[7],e[8]=r[6]*t[2]+r[7]*t[5]+r[8]*t[8];_releaseTempMatrix(o)},i.mul4=function(e,t){var n=_getFreeTempMatrixIndex(),s=_getTempMatrix(n);i.setMatrix4(s,e),e[0]=s[0]*t[0]+s[1]*t[4]+s[2]*t[8]+s[3]*t[12],e[1]=s[0]*t[1]+s[1]*t[5]+s[2]*t[9]+s[3]*t[13],e[2]=s[0]*t[2]+s[1]*t[6]+s[2]*t[10]+s[3]*t[14],e[3]=s[0]*t[3]+s[1]*t[7]+s[2]*t[11]+s[3]*t[15],e[4]=s[4]*t[0]+s[5]*t[4]+s[6]*t[8]+s[7]*t[12],e[5]=s[4]*t[1]+s[5]*t[5]+s[6]*t[9]+s[7]*t[13],e[6]=s[4]*t[2]+s[5]*t[6]+s[6]*t[10]+s[7]*t[14],e[7]=s[4]*t[3]+s[5]*t[7]+s[6]*t[11]+s[7]*t[15],e[8]=s[8]*t[0]+s[9]*t[4]+s[10]*t[8]+s[11]*t[12],e[9]=s[8]*t[1]+s[9]*t[5]+s[10]*t[9]+s[11]*t[13],e[10]=s[8]*t[2]+s[9]*t[6]+s[10]*t[10]+s[11]*t[14],e[11]=s[8]*t[3]+s[9]*t[7]+s[10]*t[11]+s[11]*t[15],e[12]=s[12]*t[0]+s[13]*t[4]+s[14]*t[8]+s[15]*t[12],e[13]=s[12]*t[1]+s[13]*t[5]+s[14]*t[9]+s[15]*t[13],e[14]=s[12]*t[2]+s[13]*t[6]+s[14]*t[10]+s[15]*t[14],e[15]=s[12]*t[3]+s[13]*t[7]+s[14]*t[11]+s[15]*t[15],_releaseTempMatrix(n)},i.mul43=function(e,t){var n=_getFreeTempMatrixIndex(),s=_getTempMatrix(n);i.setMatrix4(s,e),e[0]=s[0]*t[0]+s[1]*t[3]+s[2]*t[6],e[1]=s[0]*t[1]+s[1]*t[4]+s[2]*t[7],e[2]=s[0]*t[2]+s[1]*t[5]+s[2]*t[8],e[4]=s[4]*t[0]+s[5]*t[3]+s[6]*t[6],e[5]=s[4]*t[1]+s[5]*t[4]+s[6]*t[7],e[6]=s[4]*t[2]+s[5]*t[5]+s[6]*t[8],e[8]=s[8]*t[0]+s[9]*t[3]+s[10]*t[6],e[9]=s[8]*t[1]+s[9]*t[4]+s[10]*t[7],e[10]=s[8]*t[2]+s[9]*t[5]+s[10]*t[8],e[12]=s[12]*t[0]+s[13]*t[3]+s[14]*t[6],e[13]=s[12]*t[1]+s[13]*t[4]+s[14]*t[7],e[14]=s[12]*t[2]+s[13]*t[5]+s[14]*t[8],_releaseTempMatrix(n)},i.mulRotation43=function(e,t){var n=_getFreeTempMatrixIndex(),s=_getTempMatrix(n);i.copyRotation4(s,e),e[0]=s[0]*t[0]+s[1]*t[3]+s[2]*t[6],e[1]=s[0]*t[1]+s[1]*t[4]+s[2]*t[7],e[2]=s[0]*t[2]+s[1]*t[5]+s[2]*t[8],e[4]=s[4]*t[0]+s[5]*t[3]+s[6]*t[6],e[5]=s[4]*t[1]+s[5]*t[4]+s[6]*t[7],e[6]=s[4]*t[2]+s[5]*t[5]+s[6]*t[8],e[8]=s[8]*t[0]+s[9]*t[3]+s[10]*t[6],e[9]=s[8]*t[1]+s[9]*t[4]+s[10]*t[7],e[10]=s[8]*t[2]+s[9]*t[5]+s[10]*t[8],_releaseTempMatrix(n)},i.mulRotation43Multi=function(e,t,n){var s,o=_getFreeTempMatrixIndex(),r=_getTempMatrix(o);for(s=0;s<n;s++)i.copyRotation4(r,e),e[0]=r[0]*t[0]+r[1]*t[3]+r[2]*t[6],e[1]=r[0]*t[1]+r[1]*t[4]+r[2]*t[7],e[2]=r[0]*t[2]+r[1]*t[5]+r[2]*t[8],e[4]=r[4]*t[0]+r[5]*t[3]+r[6]*t[6],e[5]=r[4]*t[1]+r[5]*t[4]+r[6]*t[7],e[6]=r[4]*t[2]+r[5]*t[5]+r[6]*t[8],e[8]=r[8]*t[0]+r[9]*t[3]+r[10]*t[6],e[9]=r[8]*t[1]+r[9]*t[4]+r[10]*t[7],e[10]=r[8]*t[2]+r[9]*t[5]+r[10]*t[8];_releaseTempMatrix(o)},i.mulRotationRotation4=function(e,t){var n=_getFreeTempMatrixIndex(),s=_getTempMatrix(n);i.copyRotation4(s,e),e[0]=s[0]*t[0]+s[1]*t[4]+s[2]*t[8],e[1]=s[0]*t[1]+s[1]*t[5]+s[2]*t[9],e[2]=s[0]*t[2]+s[1]*t[6]+s[2]*t[10],e[4]=s[4]*t[0]+s[5]*t[4]+s[6]*t[8],e[5]=s[4]*t[1]+s[5]*t[5]+s[6]*t[9],e[6]=s[4]*t[2]+s[5]*t[6]+s[6]*t[10],e[8]=s[8]*t[0]+s[9]*t[4]+s[10]*t[8],e[9]=s[8]*t[1]+s[9]*t[5]+s[10]*t[9],e[10]=s[8]*t[2]+s[9]*t[6]+s[10]*t[10],_releaseTempMatrix(n)},i.setProd4=function(e,t,i){e[0]=t[0]*i[0]+t[1]*i[4]+t[2]*i[8]+t[3]*i[12],e[1]=t[0]*i[1]+t[1]*i[5]+t[2]*i[9]+t[3]*i[13],e[2]=t[0]*i[2]+t[1]*i[6]+t[2]*i[10]+t[3]*i[14],e[3]=t[0]*i[3]+t[1]*i[7]+t[2]*i[11]+t[3]*i[15],e[4]=t[4]*i[0]+t[5]*i[4]+t[6]*i[8]+t[7]*i[12],e[5]=t[4]*i[1]+t[5]*i[5]+t[6]*i[9]+t[7]*i[13],e[6]=t[4]*i[2]+t[5]*i[6]+t[6]*i[10]+t[7]*i[14],e[7]=t[4]*i[3]+t[5]*i[7]+t[6]*i[11]+t[7]*i[15],e[8]=t[8]*i[0]+t[9]*i[4]+t[10]*i[8]+t[11]*i[12],e[9]=t[8]*i[1]+t[9]*i[5]+t[10]*i[9]+t[11]*i[13],e[10]=t[8]*i[2]+t[9]*i[6]+t[10]*i[10]+t[11]*i[14],e[11]=t[8]*i[3]+t[9]*i[7]+t[10]*i[11]+t[11]*i[15],e[12]=t[12]*i[0]+t[13]*i[4]+t[14]*i[8]+t[15]*i[12],e[13]=t[12]*i[1]+t[13]*i[5]+t[14]*i[9]+t[15]*i[13],e[14]=t[12]*i[2]+t[13]*i[6]+t[14]*i[10]+t[15]*i[14],e[15]=t[12]*i[3]+t[13]*i[7]+t[14]*i[11]+t[15]*i[15]},i.setProd4NoProj=function(e,t,i){e[0]=t[0]*i[0]+t[1]*i[4]+t[2]*i[8],e[1]=t[0]*i[1]+t[1]*i[5]+t[2]*i[9],e[2]=t[0]*i[2]+t[1]*i[6]+t[2]*i[10],e[4]=t[4]*i[0]+t[5]*i[4]+t[6]*i[8],e[5]=t[4]*i[1]+t[5]*i[5]+t[6]*i[9],e[6]=t[4]*i[2]+t[5]*i[6]+t[6]*i[10],e[8]=t[8]*i[0]+t[9]*i[4]+t[10]*i[8],e[9]=t[8]*i[1]+t[9]*i[5]+t[10]*i[9],e[10]=t[8]*i[2]+t[9]*i[6]+t[10]*i[10],e[12]=t[12]*i[0]+t[13]*i[4]+t[14]*i[8]+i[12],e[13]=t[12]*i[1]+t[13]*i[5]+t[14]*i[9]+i[13],e[14]=t[12]*i[2]+t[13]*i[6]+t[14]*i[10]+i[14]},i.setProd3x3SubOf4=function(e,t,i){e[0]=t[0]*i[0]+t[1]*i[4]+t[2]*i[8],e[1]=t[0]*i[1]+t[1]*i[5]+t[2]*i[9],e[2]=t[0]*i[2]+t[1]*i[6]+t[2]*i[10],e[3]=0,e[4]=t[4]*i[0]+t[5]*i[4]+t[6]*i[8],e[5]=t[4]*i[1]+t[5]*i[5]+t[6]*i[9],e[6]=t[4]*i[2]+t[5]*i[6]+t[6]*i[10],e[7]=0,e[8]=t[8]*i[0]+t[9]*i[4]+t[10]*i[8],e[9]=t[8]*i[1]+t[9]*i[5]+t[10]*i[9],e[10]=t[8]*i[2]+t[9]*i[6]+t[10]*i[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1},i.updateProdRotationRotationInverse4=function(e,t,i){e[0]=t[0]*i[0]+t[1]*i[1]+t[2]*i[2],e[1]=t[0]*i[4]+t[1]*i[5]+t[2]*i[6],e[2]=t[0]*i[8]+t[1]*i[9]+t[2]*i[10],e[4]=t[4]*i[0]+t[5]*i[1]+t[6]*i[2],e[5]=t[4]*i[4]+t[5]*i[5]+t[6]*i[6],e[6]=t[4]*i[8]+t[5]*i[9]+t[6]*i[10],e[8]=t[8]*i[0]+t[9]*i[1]+t[10]*i[2],e[9]=t[8]*i[4]+t[9]*i[5]+t[10]*i[6],e[10]=t[8]*i[8]+t[9]*i[9]+t[10]*i[10]},i.setProdRotationRotationInverse43=function(e,t,i){e[0]=t[0]*i[0]+t[1]*i[1]+t[2]*i[2],e[1]=t[0]*i[4]+t[1]*i[5]+t[2]*i[6],e[2]=t[0]*i[8]+t[1]*i[9]+t[2]*i[10],e[3]=t[4]*i[0]+t[5]*i[1]+t[6]*i[2],e[4]=t[4]*i[4]+t[5]*i[5]+t[6]*i[6],e[5]=t[4]*i[8]+t[5]*i[9]+t[6]*i[10],e[6]=t[8]*i[0]+t[9]*i[1]+t[10]*i[2],e[7]=t[8]*i[4]+t[9]*i[5]+t[10]*i[6],e[8]=t[8]*i[8]+t[9]*i[9]+t[10]*i[10]},i.setScalingToProdScalingScaling4=function(e,t,i){e[0]=t[0]*i[0],e[5]=t[5]*i[5],e[10]=t[10]*i[10]},i.setProdTranslationRotation4=function(e,t,i){e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=0,e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=0,e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=0,e[12]=i[0]*t[12]+i[4]*t[13]+i[8]*t[14],e[13]=i[1]*t[12]+i[5]*t[13]+i[9]*t[14],e[14]=i[2]*t[12]+i[6]*t[13]+i[10]*t[14],e[15]=1},i.updateProdTranslationRotationInverse4=function(e,t,i){e[0]=i[0],e[1]=i[4],e[2]=i[8],e[4]=i[1],e[5]=i[5],e[6]=i[9],e[8]=i[2],e[9]=i[6],e[10]=i[10],e[12]=i[0]*t[12]+i[1]*t[13]+i[2]*t[14],e[13]=i[4]*t[12]+i[5]*t[13]+i[6]*t[14],e[14]=i[8]*t[12]+i[9]*t[13]+i[10]*t[14]},i.setProdScalingRotation=function(e,t,i){e[0]=t[0]*i[0],e[1]=t[0]*i[1],e[2]=t[0]*i[2],e[3]=0,e[4]=t[5]*i[4],e[5]=t[5]*i[5],e[6]=t[5]*i[6],e[7]=0,e[8]=t[10]*i[8],e[9]=t[10]*i[9],e[10]=t[10]*i[10],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1},i.setModelMatrix=function(e,t,i,n){e[0]=n[0]*i[0],e[1]=n[0]*i[1],e[2]=n[0]*i[2],e[4]=n[5]*i[4],e[5]=n[5]*i[5],e[6]=n[5]*i[6],e[8]=n[10]*i[8],e[9]=n[10]*i[9],e[10]=n[10]*i[10],e[12]=t[12],e[13]=t[13],e[14]=t[14]},i.updateModelMatrixInverse=function(e,t,i,n){e[0]=i[0]*n,e[1]=i[4]*n,e[2]=i[8]*n,e[4]=i[1]*n,e[5]=i[5]*n,e[6]=i[9]*n,e[8]=i[2]*n,e[9]=i[6]*n,e[10]=i[10]*n,e[12]=-e[0]*t[12]-e[4]*t[13]-e[8]*t[14],e[13]=-e[1]*t[12]-e[5]*t[13]-e[9]*t[14],e[14]=-e[2]*t[12]-e[6]*t[13]-e[10]*t[14]},i.setTranslatedByVector=function(e,t,i){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12]+i[0],e[13]=t[13]+i[1],e[14]=t[14]+i[2],e[15]=t[15]},i.setTranslatedByM4=function(e,t,i){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12]+i[12],e[13]=t[13]+i[13],e[14]=t[14]+i[14],e[15]=t[15]},i.setPerspective4=function(e,t,i,n,s){e[0]=n/t,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n/i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=(n+s)/(n-s),e[11]=-1,e[12]=0,e[13]=0,e[14]=2*n*s/(n-s),e[15]=0},i.setOrthographic4=function(e,t,i,n,s){e[0]=1/t,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1/i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=-2/(s-n),e[11]=0,e[12]=0,e[13]=0,e[14]=-(n+s)/2,e[15]=1},i.correctOrthogonal4=function(e){var i=t.normalize3([e[0],e[1],e[2]]),n=t.normalize3([e[4],e[5],e[6]]),s=t.cross3Aux(i,n);t.setCross3(n,s,i),e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=0,e[4]=n[0],e[5]=n[1],e[6]=n[2],e[7]=0,e[8]=s[0],e[9]=s[1],e[10]=s[2],e[11]=0},i.straightenTranslation=function(e,t){e[12]=Math.abs(e[12])<t?0:Math.abs(1-e[12])<t?1:Math.abs(-1-e[12])<t?-1:e[12],e[13]=Math.abs(e[13])<t?0:Math.abs(1-e[13])<t?1:Math.abs(-1-e[13])<t?-1:e[13],e[14]=Math.abs(e[14])<t?0:Math.abs(1-e[14])<t?1:Math.abs(-1-e[14])<t?-1:e[14]},i.straightenRotation4=function(e,t){var i;for(i=0;i<11;i++)e[i]=Math.abs(e[i])<t?0:Math.abs(1-e[i])<t?1:Math.abs(-1-e[i])<t?-1:e[i]},function(){var e;for(e=0;e<20;e++)s.push(i.identity4());for(e=0;e<20;e++)r.push(i.identity3())}(),i}),define("modules/scene/lights",["utils/vectors","utils/matrices","modules/managed-gl"],function(e,t,i){"use strict";function setupLiSPSM(e,t){o=e,r=t}function DirectionalLightSource(o,r){this._color=o,this._direction=e.normal3(r),this.oM=t.inverseOfRotation4(t.lookTowards4Aux(this._direction)),this._baseMatrix=t.identity4(),this._baseMatrixValid=!1,this._near=0,this._far=0,this._lispMatrix=t.copy([1,0,0,0,0,1,0,-1,0,0,1,0,0,0,0,0]),this._shadowMapBufferNamePrefix=null,this._uniformValueFunctions={},this._uniformData={color:this._color,direction:[this._direction[0],this._direction[1],this._direction[2],1],matrix:this._baseMatrix},this._shadowMapParams=[0,0,1],this._uniformValueFunctions[i.getUniformName(n)]=function(){return this._baseMatrix}.bind(this),this._uniformValueFunctions[i.getUniformName(s)]=function(){return this._shadowMapParams}.bind(this)}function PointLightSource(e,t,i,n,s,o){this._objectIntensity=t,this._relativePositionVector=i,this._hasRelativePosition=i&&(0!==i[0]||0!==i[1]||0!==i[2]),this._emittingObjects=n,this._singleEmittingObject=!!n&&1===n.length,this._positionVector=[0,0,0],this._states=s,this._timeSinceLastTransition=0,this._currentStateIndex=0,this._looping=o,this._uniformColor=[e[0],e[1],e[2],t*(n?n.length:1)],this._uniformData={color:this._uniformColor,position:this._positionVector}}function SpotLightSource(e,t,i,n,s,o,r){this._visible=!0,this._uniformColor=[e[0],e[1],e[2],t],this._relativePositionVector=i,this._positionVector=[0,0,0,o<s?Math.cos(Math.radians(o)):0],this._relativeSpotDirection=n,this._emittingObject=r,this._uniformData={color:this._uniformColor,position:this._positionVector,spot:[0,0,0,Math.cos(Math.radians(s))]}}var n="lightMatrix",s="shadowMapParams",o=10,r=100;return DirectionalLightSource.prototype.getShadowMapBufferName=function(e){return this._shadowMapBufferNamePrefix+e.toString()},DirectionalLightSource.prototype.addToContext=function(e,t,n,s,o){var r,a,l;if(this._shadowMapBufferNamePrefix=n,t)for(r=0;r<s;r++)a=this.getShadowMapBufferName(r),l=e.getFrameBuffer(a),e.addFrameBuffer(new i.FrameBuffer(a,o,o,!0),l&&l.getWidth()!==o)},DirectionalLightSource.prototype.reset=function(){this._baseMatrixValid=!1},DirectionalLightSource.prototype._updateLiSPMatrix=function(){var e=this._shadowMapParams[0],t=this._shadowMapParams[1];this._near=(r+e)*this._shadowMapParams[2]+o,this._far=2*e+this._near,this._lispMatrix[0]=this._far/e,this._lispMatrix[5]=(this._far+this._near)/(this._far-this._near),this._lispMatrix[10]=this._far/t,this._lispMatrix[13]=2*this._far*this._near/(this._far-this._near)},DirectionalLightSource.prototype.isInsideCurrentMap=function(t,i){var n,s,o,r,a,l,c,h=this._shadowMapParams[0],u=this._shadowMapParams[2];return i*=.5,n=e.prodTranslationModel3Aux(t,this._baseMatrix),n[1]-=u*h+this._near,n[2]=-n[2]+u*h,s=n[0]*this._lispMatrix[0],o=(n[1]+i)*this._lispMatrix[5]+this._lispMatrix[13],r=(n[1]-i)*this._lispMatrix[5]+this._lispMatrix[13],a=n[2]*this._lispMatrix[10],l=-n[1],c=Math.max(l,0),Math.abs(s)-i*this._lispMatrix[0]<c&&(o>0||o>-(l-i))&&(r<0||r<l+i)&&Math.abs(a)-i*this._lispMatrix[10]<c},DirectionalLightSource.prototype.startShadowMap=function(i,n,s,o,r){var a,l;i.setCurrentFrameBuffer(this.getShadowMapBufferName(s)),a=e.getRowC43Aux(n.getCameraOrientationMatrix()),l=Math.abs(e.dot3(a,this._direction)),this._shadowMapParams[0]=o,this._shadowMapParams[1]=r,this._shadowMapParams[2]=l,this._baseMatrixValid||(t.setInverseOfRotation4(this.oM,t.lookTowards4Aux(this._direction,a)),t.setProdTranslationRotation4(this._baseMatrix,n.getInversePositionMatrix(),this.oM),this._baseMatrixValid=!0),this._uniformData.direction[3]=l,this._updateLiSPMatrix(),i.getCurrentShader().assignUniforms(i,this._uniformValueFunctions)},PointLightSource.prototype.isVisible=function(){var e;if(this._singleEmittingObject)return this._emittingObjects[0].isVisible();for(e=0;e<this._emittingObjects.length;e++)if(this._emittingObjects[e]&&!this._emittingObjects[e].canBeReused()&&this._emittingObjects[e].isVisible())return!0;return!1},PointLightSource.prototype.updateState=function(t){var i,n;if(this._states&&t>0){for(this._timeSinceLastTransition+=t,i=(this._currentStateIndex+1)%this._states.length;this._timeSinceLastTransition>this._states[i].timeToReach;){if(0===i&&!this._looping){i=this._states.length-1,this._timeSinceLastTransition=this._states[i].timeToReach;break}this._timeSinceLastTransition-=this._states[i].timeToReach,i=(i+1)%this._states.length}this._currentStateIndex=0===i?this._states.length-1:i-1,n=this._timeSinceLastTransition/this._states[i].timeToReach,this._objectIntensity=this._states[this._currentStateIndex].intensity*(1-n)+this._states[i].intensity*n,this.setColor(e.sum3Aux(e.scaled3Aux(this._states[this._currentStateIndex].color,1-n),e.scaled3Aux(this._states[i].color,n)))}},PointLightSource.prototype.update=function(i){var n,s;if(this.updateState(i),this._singleEmittingObject)this._uniformColor[3]=this._objectIntensity,this._emittingObjects[0].copyPositionToVector(this._positionVector),this._hasRelativePosition&&e.add3(this._positionVector,e.prodVec3Mat4Aux(this._relativePositionVector,t.prod3x3SubOf4Aux(this._emittingObjects[0].getCascadeScalingMatrix(),this._emittingObjects[0].oM)));else{for(e.setNull3(this._positionVector),s=0,n=0;n<this._emittingObjects.length;n++)this._emittingObjects[n]&&!this._emittingObjects[n].canBeReused()&&this._emittingObjects[n].isVisible()&&(this._emittingObjects[n].addPositionToVector(this._positionVector),s++);s>1&&(this._positionVector[0]/=s,this._positionVector[1]/=s,this._positionVector[2]/=s),this._uniformColor[3]=this._objectIntensity*s}},PointLightSource.prototype.canBeReused=function(){var e;if(this._singleEmittingObject)return this._emittingObjects[0].canBeReused();for(e=0;e<this._emittingObjects.length;e++)if(this._emittingObjects[e]&&!this._emittingObjects[e].canBeReused())return!1;return!0},PointLightSource.prototype.setColor=function(e){this._uniformColor[0]=e[0],this._uniformColor[1]=e[1],this._uniformColor[2]=e[2]},PointLightSource.prototype.addEmittingObject=function(e){this._emittingObjects.push(e),this._singleEmittingObject=1===this._emittingObjects.length},PointLightSource.prototype.shouldBeRendered=function(e){var t=e.getViewMatrix();return this._uniformColor[3]>0&&this._positionVector[0]*t[2]+this._positionVector[1]*t[6]+this._positionVector[2]*t[10]+t[14]<this._uniformColor[3]},PointLightSource.prototype.setAnimationTime=function(e){this._timeSinceLastTransition=0,this._currentStateIndex=0,this.updateState(e)},SpotLightSource.prototype.isVisible=function(){
return this._visible&&this._emittingObject.isVisible()},SpotLightSource.prototype.update=function(){this._emittingObject.copyPositionToVector(this._positionVector),e.add3(this._positionVector,e.prodVec3Mat4Aux(this._relativePositionVector,t.prod3x3SubOf4Aux(this._emittingObject.getCascadeScalingMatrix(),this._emittingObject.oM))),e.setProdVec3Mat4(this._uniformData.spot,this._relativeSpotDirection,this._emittingObject.oM)},SpotLightSource.prototype.canBeReused=function(){return this._emittingObject.canBeReused()},SpotLightSource.prototype.shouldBeRendered=function(e){var t=e.getViewMatrix();return this._positionVector[0]*t[2]+this._positionVector[1]*t[6]+this._positionVector[2]*t[10]+t[14]<this._uniformColor[3]},SpotLightSource.prototype.hide=function(){this._visible=!1},SpotLightSource.prototype.show=function(){this._visible=!0},{setupLiSPSM:setupLiSPSM,DirectionalLightSource:DirectionalLightSource,PointLightSource:PointLightSource,SpotLightSource:SpotLightSource}}),define("armada/constants",[],function(){"use strict";return{GAME_NAME:"Interstellar Armada",LOCAL_STORAGE_PREFIX:"armada_",LANGUAGE_LOCAL_STORAGE_ID:"armada_language",VERSION_LOCAL_STORAGE_ID:"armada_version"}}),define("modules/scene/object-3d",["utils/vectors","utils/matrices"],function(e,t){"use strict";function Object3D(e,i,n,s,o,r){this._parent=null,this.pM=e||t.identity4(),this.oM=i||t.identity4(),this.sM=n||t.identity4(),this.csM=t.identity4(),this.csMValid=!1,this._largestScalingFactor=1,this.mM=t.identity4(),this.mMValid=!1,this._cascadedModelMatrix=t.identity4(),this.mMForFrame=this.mM,this.mMForFrameValid=!1,this._size=void 0!==s?s:1,this._insideParent=null,this._childrenAlwaysInside=o||!1,this._lastSizeInsideViewFrustum={width:-1,height:-1},this.pMC=t.identity4(),this.pMCV=!1,this._ignoreTransform=r||!1}var i,n;return i=function(){function init(e,i,n,s,o,r){this._parent=null,t.copyTranslation4(this.pM,e||t.IDENTITY4),t.copyRotation4(this.oM,i||t.IDENTITY4),t.copyScaling4(this.sM,n||t.IDENTITY4),this.mMForFrame=this.mM,this.csMValid=!1,this.mMValid=!1,this.mMForFrameValid=!1,this._size=void 0!==s?s:1,this._insideParent=null,this._childrenAlwaysInside=o||!1,this._ignoreTransform=r||!1,this._lastSizeInsideViewFrustum={width:-1,height:-1},this.pMCV=!1}function resetCachedValues(){this.pMCV=!1,this.mMForFrameValid=!1}function setParent(e){this._parent=e,this.mMForFrame=e&&!e._ignoreTransform?this._cascadedModelMatrix:this.mM}function setPositionMatrix(e){this.pM=e,this.mM[12]=this.pM[12],this.mM[13]=this.pM[13],this.mM[14]=this.pM[14],this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function getPositionVector(){return[this.pM[12],this.pM[13],this.pM[14]]}function copyPositionToVector(e){e[0]=this.pM[12],e[1]=this.pM[13],e[2]=this.pM[14]}function addPositionToVector(e){e[0]+=this.pM[12],e[1]+=this.pM[13],e[2]+=this.pM[14]}function setPositionv(e){this.pM[12]=e[0],this.pM[13]=e[1],this.pM[14]=e[2],this.mM[12]=e[0],this.mM[13]=e[1],this.mM[14]=e[2],this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function setPositionM4(e){this.pM[12]=e[12],this.pM[13]=e[13],this.pM[14]=e[14],this.mM[12]=e[12],this.mM[13]=e[13],this.mM[14]=e[14],this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function translate(e,t,i){this.pM[12]+=e,this.pM[13]+=t,this.pM[14]+=i,this.mM[12]+=e,this.mM[13]+=t,this.mM[14]+=i,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function translatev(e){this.pM[12]+=e[0],this.pM[13]+=e[1],this.pM[14]+=e[2],this.mM[12]+=e[0],this.mM[13]+=e[1],this.mM[14]+=e[2],this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function translateByMatrix(e){this.pM[12]+=e[12],this.pM[13]+=e[13],this.pM[14]+=e[14],this.mM[12]+=e[12],this.mM[13]+=e[13],this.mM[14]+=e[14],this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function translateByMatrixMul(e,t){this.pM[12]+=e[12]*t,this.pM[13]+=e[13]*t,this.pM[14]+=e[14]*t,this.mM[12]+=e[12]*t,this.mM[13]+=e[13]*t,this.mM[14]+=e[14]*t,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function translateTowardsM4(e,t){var i=t*e[12]+(1-t)*this.pM[12]-this.pM[12];this.pM[12]+=i,this.mM[12]+=i,i=t*e[13]+(1-t)*this.pM[13]-this.pM[13],this.pM[13]+=i,this.mM[13]+=i,i=t*e[14]+(1-t)*this.pM[14]-this.pM[14],this.pM[14]+=i,this.mM[14]+=i,this._parent&&this._parent._childrenAlwaysInside||(this._insideParent=null),this.pMCV=!1}function setOrientationMatrix(e){e&&(this.oM=e),this.mMValid=!1,this._handleOrientationChanged&&this._handleOrientationChanged()}function setOrientationM4(e){t.copyRotation4(this.oM,e),this.mMValid=!1,this._handleOrientationChanged&&this._handleOrientationChanged()}function getXDirectionVector(){return[this.oM[0],this.oM[1],this.oM[2]]}function getYDirectionVector(){return[this.oM[4],this.oM[5],this.oM[6]]}function getZDirectionVector(){return[this.oM[8],this.oM[9],this.oM[10]]}function rotate(e,i){0!==i&&(t.rotate4(this.oM,e,i),this.setOrientationMatrix())}function rotateByMatrix(e){t.mulRotationRotation4(this.oM,e),this.setOrientationMatrix()}function setScaling(e,t,i){this.sM[0]=e,this.sM[5]=t,this.sM[10]=i,this.mMValid=!1,this.csMValid=!1}function setScale(e){this.sM[0]=e,this.sM[5]=e,this.sM[10]=e,this.mMValid=!1,this.csMValid=!1}function getCascadeScalingMatrix(){return this.csMValid||(this._parent&&!this._parent._ignoreTransform?t.setScalingToProdScalingScaling4(this.csM,this._parent.getCascadeScalingMatrix(),this.sM):t.copyScaling4(this.csM,this.sM),this._largestScalingFactor=Math.max(Math.abs(this.csM[0]),Math.abs(this.csM[5]),Math.abs(this.csM[10])),this.csMValid=!0),this.csM}function getModelMatrix(){return this.mMForFrameValid||(this.mMValid||(t.setModelMatrix(this.mM,this.pM,this.oM,this.sM),this.mMValid=!0),this._parent&&!this._parent._ignoreTransform&&t.setProd4NoProj(this._cascadedModelMatrix,this.mM,this._parent.getModelMatrix()),this.mMForFrameValid=!0),this.mMForFrame}function getSize(){return this._size}function setSize(e){this._size=e}function getScaledSize(){return this.getSize()*this.getCascadeScalingMatrix()[0]}function isInsideParent(){return null===this._insideParent&&(this._insideParent=!!this._parent&&(this._parent._childrenAlwaysInside||Math.abs(this.pM[12])<this._parent.getSize()&&Math.abs(this.pM[13])<this._parent.getSize()&&Math.abs(this.pM[14])<this._parent.getSize())),this._insideParent}function getPositionMatrixInCameraSpace(i){return this.pMCV||(t.updateTranslation4v(this.pMC,e.prodTranslationModel3Aux(this.getModelMatrix(),i.getViewMatrix())),this.pMCV=!0),this.pMC}function getSizeInsideViewFrustum(e,t){var i,n,s,o,r,a,l,c;if(n=this.getPositionMatrixInCameraSpace(e),0!==n[14]){if(this.getCascadeScalingMatrix(),t&&(i=this.getSize()*this._largestScalingFactor,n[14]-i>=-e._near||n[14]+i<-e._viewDistance))return this._lastSizeInsideViewFrustum.width=0,this._lastSizeInsideViewFrustum.height=0,this._lastSizeInsideViewFrustum;if(s=e.getProjectionMatrix(),i=this.getSize(),c=-1/n[14],o=n[12]*s[0]*c,r=n[13]*s[5]*c,a=Math.abs(this._largestScalingFactor*s[0]*i*c),l=Math.abs(this._largestScalingFactor*s[5]*i*c),!(o+a<-1||o-a>1||r+l<-1||r-l>1))return this._lastSizeInsideViewFrustum.width=a,this._lastSizeInsideViewFrustum.height=l,this._lastSizeInsideViewFrustum}return this._lastSizeInsideViewFrustum.width=0,this._lastSizeInsideViewFrustum.height=0,this._lastSizeInsideViewFrustum}function isInsideShadowRegion(e){return e.isInsideCurrentMap(this.getModelMatrix(),this.getScaledSize())}return function(){this.prototype.init=init,this.prototype.resetCachedValues=resetCachedValues,this.prototype.setParent=setParent,this.prototype.setPositionMatrix=setPositionMatrix,this.prototype.setPositionv=setPositionv,this.prototype.setPositionM4=setPositionM4,this.prototype.setOrientationMatrix=setOrientationMatrix,this.prototype.setOrientationM4=setOrientationM4,this.prototype.setScaling=setScaling,this.prototype.setScale=setScale,this.prototype.getPositionVector=getPositionVector,this.prototype.copyPositionToVector=copyPositionToVector,this.prototype.addPositionToVector=addPositionToVector,this.prototype.translate=translate,this.prototype.translatev=translatev,this.prototype.translateByMatrix=translateByMatrix,this.prototype.translateByMatrixMul=translateByMatrixMul,this.prototype.translateTowardsM4=translateTowardsM4,this.prototype.getXDirectionVector=getXDirectionVector,this.prototype.getYDirectionVector=getYDirectionVector,this.prototype.getZDirectionVector=getZDirectionVector,this.prototype.rotate=rotate,this.prototype.rotateByMatrix=rotateByMatrix,this.prototype.getCascadeScalingMatrix=getCascadeScalingMatrix,this.prototype.getModelMatrix=getModelMatrix,this.prototype.getSize=getSize,this.prototype.setSize=setSize,this.prototype.getScaledSize=getScaledSize,this.prototype.isInsideParent=isInsideParent,this.prototype.getPositionMatrixInCameraSpace=getPositionMatrixInCameraSpace,this.prototype.getSizeInsideViewFrustum=getSizeInsideViewFrustum,this.prototype.isInsideShadowRegion=isInsideShadowRegion}},n=i(),n.call(Object3D),{Object3D:Object3D,makeObject3DMixinClass:n}}),define("modules/scene/camera",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/scene/object-3d"],function(e,t,i,n,s){"use strict";function CameraPositionConfiguration(e,t,n,s,o,r,a,l,c,h){this._fixed=e,this._turnsAroundObjects=t,this._movesRelativeToObject=n,this._followedObjects=s||[],this._startsWithRelativePosition=o,this._defaultRelativePositionMatrix=i.copy(r),this._relativePositionMatrix=r,this._worldPositionMatrix=i.identity4(),this._worldPositionMatrixValid=!1,this._distanceIsConfined=!!a,this._minimumDistance=a?a[0]:0,this._maximumDistance=a?a[1]:0,this._xIsConfined=!(!l||!l[0]),this._minimumX=l&&l[0]?l[0][0]:0,this._maximumX=l&&l[0]?l[0][1]:0,this._yIsConfined=!(!l||!l[1]),this._minimumY=l&&l[1]?l[1][0]:0,this._maximumY=l&&l[1]?l[1][1]:0,this._zIsConfined=!(!l||!l[2]),this._minimumZ=l&&l[2]?l[2][0]:0,this._maximumZ=l&&l[2]?l[2][1]:0,this._resetsWhenLeavingConfines=c,this._isTransitionConfiguration=h,this._isStarting=!0,this._camera=null}function CameraOrientationConfiguration(e,t,n,s,c,h,u,d,p,_,g,m){this._fixed=e,this._pointsTowardsObjects=t,this._fps=n,this._followedObjects=s||[],this._defaultRelativeOrientationMatrix=i.copy(c),this._relativeOrientationMatrix=c,this._worldOrientationMatrix=i.identity4(),this._worldOrientationMatrixValid=!1,this._defaultAlpha=h||0,this._alpha=h||0,this._defaultBeta=u||0,this._beta=u||0,this._minAlpha=d&&void 0!==d[0]?d[0]:o,this._maxAlpha=d&&void 0!==d[1]?d[1]:r,this._minBeta=p&&void 0!==p[0]?p[0]:a,this._maxBeta=p&&void 0!==p[1]?p[1]:l,this._baseOrientation=_,this._pointToFallback=g,this._isTransitionConfiguration=m,this._camera=null}function CameraConfiguration(e,t,i,n,o,r,a,l){s.Object3D.call(this,t.pM,i.oM),this._name=e,this._positionConfiguration=t,this._orientationConfiguration=i,this._defaultFOV=n,this._fov=n,this._minFOV=o?o[0]:n,this._maxFOV=o?o[1]:n,this._span=r,this._resetsOnFocusChange=a,this._excludeFromCycle=l,this._camera=null}function getFreeCameraConfiguration(t,n,s,o,r,a,l){var c=i.getYawAndPitch(s);return new CameraConfiguration(e.EMPTY_STRING,new CameraPositionConfiguration(!1,!1,!1,[],!1,i.copy(n),null,null,!1),new CameraOrientationConfiguration(!1,!1,t,[],i.copy(s),Math.degrees(c.yaw),Math.degrees(c.pitch),void 0,void 0,CameraOrientationConfiguration.BaseOrientation.WORLD,CameraOrientationConfiguration.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD),o,[r,a],l)}function Camera(e,t,n,o,r,a,l){this._object3D=new s.Object3D(i.identity4(),i.identity4(),i.identity4()),this._scene=e,this._aspect=t,this._usesVerticalValues=n,this._viewDistance=o,this._previousConfiguration=null,this._currentConfiguration=r,this._currentConfiguration.setCamera(this),this._transitionStyle=Camera.TransitionStyle.NONE,this._defaultTransitionStyle=l||Camera.TransitionStyle.NONE,this._transitionDuration=0,this._defaultTransitionDuration=a||0,this._transitionElapsedTime=0,this._velocityVector=[0,0,0],this._controlledVelocityVector=[0,0,0],this._angularVelocityVector=[0,0,0],this._previousFollowedPositionVector=null,this._projectionMatrix=i.identity4(),this._projectionMatrixValid=!1,this._followedNode=null,this._viewMatrix=i.identity4(),this._viewMatrixValid=!1,this._inversePositionMatrix=i.identity4(),this._inversePositionMatrixValid=!1,this._inverseOrientationMatrix=i.identity4(),this._inverseOrientationMatrixValid=!1,this._fov=0,this._span=0,this._near=0,this._extendedCamera=null,this._extendedCameraValid=!1,this._combinedExtendedCamera=null,this._combinedExtendedCameraValid=!1,this._posMatrix=i.identity4(),this._oriMatrix=i.identity4(),this._interocularHalfDistance=c,this._stereoscopicConvergenceDistance=h,this._stereoAngle=0,this._stereoscopy=Camera.Stereoscopy.NONE,this._leftEye=!1,this._rightEye=!1,this._updateFOV(),this._updateSpan(),this._updateStereoAngle()}var o=-360,r=360,a=-90,l=90,c=.0635/1.5,h=20;return CameraPositionConfiguration.prototype.init=function(e,t,n,s,o,r,a,l,c,h){this._fixed=e,this._turnsAroundObjects=t,this._movesRelativeToObject=n,this._followedObjects=s||[],this._startsWithRelativePosition=o,i.copyTranslation4(this._defaultRelativePositionMatrix,r),i.copyTranslation4(this._relativePositionMatrix,r),i.setIdentity4(this._worldPositionMatrix),this._worldPositionMatrixValid=!1,this._distanceIsConfined=!!a,this._minimumDistance=a?a[0]:0,this._maximumDistance=a?a[1]:0,this._xIsConfined=!(!l||!l[0]),this._minimumX=l&&l[0]?l[0][0]:0,this._maximumX=l&&l[0]?l[0][1]:0,this._yIsConfined=!(!l||!l[1]),this._minimumY=l&&l[1]?l[1][0]:0,this._maximumY=l&&l[1]?l[1][1]:0,this._zIsConfined=!(!l||!l[2]),this._minimumZ=l&&l[2]?l[2][0]:0,this._maximumZ=l&&l[2]?l[2][1]:0,this._resetsWhenLeavingConfines=c,this._isTransitionConfiguration=h,this._isStarting=!0,this._camera=null},CameraPositionConfiguration.prototype.copy=function(e){var t=new CameraPositionConfiguration(this._fixed,this._turnsAroundObjects,this._movesRelativeToObject,this._followedObjects.slice(),this._startsWithRelativePosition,i.copy(this._defaultRelativePositionMatrix),this._distanceIsConfined?[this._minimumDistance,this._maximumDistance]:null,[this._xIsConfined?[this._minimumX,this._maximumX]:null,this._yIsConfined?[this._minimumY,this._maximumY]:null,this._zIsConfined?[this._minimumZ,this._maximumZ]:null],this._resetsWhenLeavingConfines,e);return t._relativePositionMatrix=i.copy(this._relativePositionMatrix),t._worldPositionMatrix=i.copy(this._worldPositionMatrix),t._isStarting=this._isStarting,t},CameraPositionConfiguration.prototype.setCamera=function(e,t){e&&this._camera!==e&&this._startsWithRelativePosition&&!t&&this.resetToDefaults(!0),this._camera=e},CameraPositionConfiguration.prototype.resetToDefaults=function(e){this._camera&&!e&&this._camera.positionConfigurationWillChange(),i.copyTranslation4(this._relativePositionMatrix,this._defaultRelativePositionMatrix),this._worldPositionMatrixValid=!1,this._isStarting=!0},CameraPositionConfiguration.prototype.setRelativePositionMatrix=function(e,t){this._camera&&!t&&this._camera.positionConfigurationWillChange(),this._relativePositionMatrix=e},CameraPositionConfiguration.prototype.moveByVector=function(e,t){this._camera&&!t&&this._camera.positionConfigurationWillChange(),i.translateByVector(this._relativePositionMatrix,e)},CameraPositionConfiguration.prototype.followsObjects=function(t){return t?e.arraysEqual(this._followedObjects.sort(),t.sort()):this._followedObjects.length>0&&!this._startsWithRelativePosition},CameraPositionConfiguration.prototype.getFollowedPositionVector=function(){var e,t=[0,0,0];if(0===this._followedObjects.length);else{for(e=0;e<this._followedObjects.length;e++)this._followedObjects[e].addPositionToVector(t);t=[t[0]/this._followedObjects.length,t[1]/this._followedObjects.length,t[2]/this._followedObjects.length]}return t},CameraPositionConfiguration.prototype.getFollowedPositionMatrix=function(){var e,t=i.identity4Aux();if(0===this._followedObjects.length);else{for(e=0;e<this._followedObjects.length;e++)i.translateByMatrix(t,this._followedObjects[e].pM);t=i.translation4Aux(t[12]/this._followedObjects.length,t[13]/this._followedObjects.length,t[14]/this._followedObjects.length)}return t},CameraPositionConfiguration.prototype.getFollowedObjectOrientationMatrix=function(){return 0===this._followedObjects.length?null:this._followedObjects[0].oM},CameraPositionConfiguration.prototype._cleanupFollowedObjects=function(){var e,t,n;for(e=0;e<this._followedObjects.length;e++){for(t=e,n=0;t<this._followedObjects.length&&(!this._followedObjects[t]||!0===this._followedObjects[t].canBeReused());)t++,n++;n>0&&(this._followedObjects.splice(e,n),0===this._followedObjects.length&&i.copyTranslation4(this._relativePositionMatrix,this._worldPositionMatrixValid&&this._worldPositionMatrix||this._relativePositionMatrix||this._defaultRelativePositionMatrix))}},CameraPositionConfiguration.prototype._calculateWorldPositionMatrix=function(e){this._followedObjects.length>0&&(!this._startsWithRelativePosition||this._isStarting)?(this._isStarting=!1,this._turnsAroundObjects?e&&i.setTranslatedByM4(this._worldPositionMatrix,i.translation4m4Aux(i.prodTranslationRotation4Aux(this._relativePositionMatrix,i.prod3x3SubOf4Aux(i.ROTATION_X_90,e))),this.getFollowedPositionMatrix()):i.setTranslatedByM4(this._worldPositionMatrix,i.translation4m4Aux(i.prodTranslationRotation4Aux(this._relativePositionMatrix,this.getFollowedObjectOrientationMatrix())),this.getFollowedPositionMatrix()),this._startsWithRelativePosition&&i.copyTranslation4(this._relativePositionMatrix,this._worldPositionMatrix)):i.copyTranslation4(this._worldPositionMatrix,this._relativePositionMatrix),this._worldPositionMatrixValid=!0},CameraPositionConfiguration.prototype.getWorldPositionMatrix=function(e){return this._worldPositionMatrixValid||this._calculateWorldPositionMatrix(e),this._worldPositionMatrix},CameraPositionConfiguration.prototype._checkConfines=function(e){var n,s,o;if(o=this._startsWithRelativePosition&&!this._isStarting&&this._followedObjects.length>0?i.translation4m4Aux(i.prodTranslationRotation4Aux(i.translatedByM4Aux(this._relativePositionMatrix,i.inverseOfTranslation4Aux(this.getFollowedPositionMatrix())),i.inverseOfRotation4Aux(this.getFollowedObjectOrientationMatrix()))):this._relativePositionMatrix,this._distanceIsConfined)if(this._followedObjects.length>0){if(n=i.translationVector3(o),(s=t.extractLength3(n))<this._minimumDistance||s>this._maximumDistance){if(s>this._maximumDistance&&this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;s=Math.min(Math.max(s,this._minimumDistance),this._maximumDistance),o=i.translation4vAux(t.scale3(n,s))}}else if(e&&(n=t.diffVec3Mat4Aux(e,o),(s=t.extractLength3(n))<this._minimumDistance||s>this._maximumDistance)){if(s>this._maximumDistance&&this._resetsWhenLeavingConfines)return!1;s=Math.min(Math.max(s,this._minimumDistance),this._maximumDistance),o=i.translation4vAux(t.sum3Aux(e,t.scale3(n,-s)))}if(this._xIsConfined&&(o[12]<this._minimumX||o[12]>this._maximumX)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;o[12]=Math.min(Math.max(o[12],this._minimumX),this._maximumX)}if(this._yIsConfined&&(o[13]<this._minimumY||o[13]>this._maximumY)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;o[13]=Math.min(Math.max(o[13],this._minimumY),this._maximumY)}if(this._zIsConfined&&(o[14]<this._minimumZ||o[14]>this._maximumZ)){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;o[14]=Math.min(Math.max(o[14],this._minimumZ),this._maximumZ)}return this._startsWithRelativePosition&&!this._isStarting&&this._followedObjects.length>0?i.setTranslatedByM4(this._relativePositionMatrix,i.translation4m4Aux(i.prodTranslationRotation4Aux(o,this.getFollowedObjectOrientationMatrix())),this.getFollowedPositionMatrix()):i.copyTranslation4(this._relativePositionMatrix,o),!0},CameraPositionConfiguration.prototype.update=function(e,n,s,o){var r,a;if(!this._fixed)if(0===this._followedObjects.length||this._startsWithRelativePosition)i.translateByVector(this._relativePositionMatrix,t.scale3(t.prodVec3Mat4Aux(s,e),o/1e3));else if(this._turnsAroundObjects){if(this._distanceIsConfined){if(r=i.translationVector3(this._relativePositionMatrix),(a=t.extractLength3(r)+s[2]*o/1e3)<this._minimumDistance||a>this._maximumDistance){if(this._resetsWhenLeavingConfines)return this.resetToDefaults(),!1;s[2]=0,a=Math.min(Math.max(a,this._minimumDistance),this._maximumDistance)}i.updateTranslation4v(this._relativePositionMatrix,t.scale3(r,a))}}else this._movesRelativeToObject?i.translateByVector(this._relativePositionMatrix,t.scaled3Aux(t.prodVec3Mat4Aux(s,i.ROTATION_X_270),.001*o)):i.translateByVector(this._relativePositionMatrix,t.scaled3Aux(t.prodVec3Mat4Aux(s,i.prod3x3SubOf4Aux(e,i.inverseOfRotation4Aux(this.getFollowedObjectOrientationMatrix()))),.001*o));if(!this._isTransitionConfiguration){if(!this._checkConfines(n))return!1;this._cleanupFollowedObjects()}return this._worldPositionMatrixValid=!1,!0},CameraOrientationConfiguration.BaseOrientation={WORLD:"world",POSITION_FOLLOWED_OBJECTS:"positionFollowedObjects",ORIENTATION_FOLLOWED_OBJECT:"orientationFollowedObject"},Object.freeze(CameraOrientationConfiguration.BaseOrientation),CameraOrientationConfiguration.PointToFallback={WORLD:"world",STATIONARY:"stationary",POSITION_FOLLOWED_OBJECT_OR_WORLD:"positionFollowedObjectOrWorld"},Object.freeze(CameraOrientationConfiguration.PointToFallback),CameraOrientationConfiguration.prototype.init=function(e,t,n,s,c,h,u,d,p,_,g,m){this._fixed=e,this._pointsTowardsObjects=t,this._fps=n,this._followedObjects=s||[],i.copyRotation4(this._defaultRelativeOrientationMatrix,c),i.copyRotation4(this._relativeOrientationMatrix,c),i.setIdentity4(this._worldOrientationMatrix),this._worldOrientationMatrixValid=!1,this._defaultAlpha=h||0,this._alpha=h||0,this._defaultBeta=u||0,this._beta=u||0,this._minAlpha=d&&void 0!==d[0]?d[0]:o,this._maxAlpha=d&&void 0!==d[1]?d[1]:r,this._minBeta=p&&void 0!==p[0]?p[0]:a,this._maxBeta=p&&void 0!==p[1]?p[1]:l,this._baseOrientation=_,this._pointToFallback=g,this._isTransitionConfiguration=m,this._camera=null},CameraOrientationConfiguration.prototype.copy=function(e){var t=new CameraOrientationConfiguration(this._fixed,this._pointsTowardsObjects,this._fps,this._followedObjects.slice(),i.copy(this._defaultRelativeOrientationMatrix),this._alpha,this._beta,[this._minAlpha,this._maxAlpha],[this._minBeta,this._maxBeta],this._baseOrientation,this._pointToFallback,e);return t._relativeOrientationMatrix=i.copy(this._relativeOrientationMatrix),t._worldOrientationMatrix=i.copy(this._worldOrientationMatrix),t},CameraOrientationConfiguration.prototype.setCamera=function(e){this._camera=e},CameraOrientationConfiguration.prototype.resetToDefaults=function(e){this._camera&&!e&&this._camera.orientationConfigurationWillChange(),i.copyRotation4(this._relativeOrientationMatrix,this._defaultRelativeOrientationMatrix),this._alpha=this._defaultAlpha,this._beta=this._defaultBeta,this._worldOrientationMatrixValid=!1},CameraOrientationConfiguration.prototype.setRelativeOrientationMatrix=function(e,t){this._camera&&!t&&this._camera.orientationConfigurationWillChange(),this._relativeOrientationMatrix=e},CameraOrientationConfiguration.prototype.isFPS=function(){return this._fps},CameraOrientationConfiguration.prototype.followsObjects=function(t){return t?e.arraysEqual(this._followedObjects.sort(),t.sort()):this._followedObjects.length>0},CameraOrientationConfiguration.prototype.setFollowedObjects=function(e,t){0===this._followedObjects.length&&0===e.length||(this._camera&&!t&&this._camera.orientationConfigurationWillChange(),this._followedObjects=e)},CameraOrientationConfiguration.prototype.setFollowedObject=function(e,t){1===this._followedObjects.length&&this._followedObjects[0]===e||this.setFollowedObjects([e],t)},CameraOrientationConfiguration.prototype.getFollowedObjectsPositionVector=function(){var e,t=[0,0,0];if(0===this._followedObjects.length);else{for(e=0;e<this._followedObjects.length;e++)this._followedObjects[e].addPositionToVector(t);t=[t[0]/this._followedObjects.length,t[1]/this._followedObjects.length,t[2]/this._followedObjects.length]}return t},CameraOrientationConfiguration.prototype.getFollowedOrientationMatrix=function(){return 0===this._followedObjects.length?null:this._followedObjects[0].oM},CameraOrientationConfiguration.prototype._cleanupFollowedObjects=function(){var e,t,n;for(e=0;e<this._followedObjects.length;e++){for(t=e,n=0;t<this._followedObjects.length&&(!this._followedObjects[t]||!0===this._followedObjects[t].canBeReused());)t++,n++;if(n>0){if(this._followedObjects.length===n)return this._camera&&this._camera.orientationConfigurationWillChange(),this._pointsTowardsObjects||(i.copyRotation4(this._relativeOrientationMatrix,this._worldOrientationMatrixValid&&this._worldOrientationMatrix||this._relativeOrientationMatrix||this._defaultRelativeOrientationMatrix),this._fps=!1),this._followedObjects.splice(e,n),!1;this._followedObjects.splice(e,n)}}return!0},CameraOrientationConfiguration.prototype._calculateWorldOrientationMatrix=function(e,n){var s,o,r,a=function(e){i.setProd3x3SubOf4(this._worldOrientationMatrix,i.prod3x3SubOf4Aux(i.ROTATION_X_270,this._relativeOrientationMatrix),e)}.bind(this),l=function(){this._fps?i.setProd3x3SubOf4(this._worldOrientationMatrix,i.ROTATION_X_270,this._relativeOrientationMatrix):i.copyRotation4(this._worldOrientationMatrix,this._relativeOrientationMatrix)}.bind(this);if(this._followedObjects.length>0)if(this._pointsTowardsObjects)if(e)if(o=t.normalize3(t.diffVec3Mat4Aux(this.getFollowedObjectsPositionVector(),e)),this._fps){switch(this._baseOrientation){case CameraOrientationConfiguration.BaseOrientation.WORLD:s=null;break;case CameraOrientationConfiguration.BaseOrientation.POSITION_FOLLOWED_OBJECTS:s=n||null;break;case CameraOrientationConfiguration.BaseOrientation.ORIENTATION_FOLLOWED_OBJECT:s=this.followsObjects()?this.getFollowedOrientationMatrix():null}s?o=t.prodMat4Vec3Aux(s,o):s=i.IDENTITY4,this._alpha=0!==o[0]||0!==o[1]?t.angle2yCapped(o[0],o[1]):0,o[0]<0&&(this._alpha=-this._alpha),i.setProd3x3SubOf4(this._worldOrientationMatrix,i.ROTATION_X_270,i.rotationZ4Aux(this._alpha)),this._beta=t.angle3uCapped(t.getRowC43ScaledAux(this._worldOrientationMatrix,-1),o),o[2]>0&&(this._beta=-this._beta),i.setProd3x3SubOf4(this._worldOrientationMatrix,i.prod3x3SubOf4Aux(i.ROTATION_X_270,i.rotationX4Aux(this._beta)),i.rotationZ4Aux(this._alpha)),i.mulRotationRotation4(this._worldOrientationMatrix,s)}else this._worldOrientationMatrix[8]=o[0],this._worldOrientationMatrix[9]=o[1],this._worldOrientationMatrix[10]=o[2],this._worldOrientationMatrix[11]=0,r=t.cross3Aux(t.UNIT3_X,o),this._worldOrientationMatrix[4]=r[0],this._worldOrientationMatrix[5]=r[1],this._worldOrientationMatrix[6]=r[2],this._worldOrientationMatrix[7]=0,r=t.cross3Aux(o,r),this._worldOrientationMatrix[0]=r[0],this._worldOrientationMatrix[1]=r[1],this._worldOrientationMatrix[2]=r[2],this._worldOrientationMatrix[3]=0,this._worldOrientationMatrix[12]=0,this._worldOrientationMatrix[13]=0,this._worldOrientationMatrix[14]=0,this._worldOrientationMatrix[15]=1,i.correctOrthogonal4(this._worldOrientationMatrix);else;else a(this.getFollowedOrientationMatrix());else if(this._pointsTowardsObjects)switch(this._pointToFallback){case CameraOrientationConfiguration.PointToFallback.WORLD:l();break;case CameraOrientationConfiguration.PointToFallback.STATIONARY:i.setIdentity4(this._worldOrientationMatrix);break;case CameraOrientationConfiguration.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD:n?a(n):l()}else l();this._worldOrientationMatrixValid=!0},CameraOrientationConfiguration.prototype.getWorldOrientationMatrix=function(e,t){return this._worldOrientationMatrixValid||this._calculateWorldOrientationMatrix(e,t),this._worldOrientationMatrix},CameraOrientationConfiguration.prototype.update=function(n,s){var o;if(!this._pointsTowardsObjects||this.followsObjects()||this._pointToFallback!==CameraOrientationConfiguration.PointToFallback.STATIONARY)return this._fixed||(this._fps?(this._alpha+=n[1]*s/1e3,this._beta+=n[0]*s/1e3,this._alpha>=360&&(this._alpha-=360),this._alpha<=-360&&(this._alpha+=360),this._beta>=360&&(this._beta-=360),this._beta<=-360&&(this._beta+=360),this._alpha=Math.min(Math.max(this._minAlpha,this._alpha),this._maxAlpha),this._beta=Math.min(Math.max(this._minBeta,this._beta),this._maxBeta),i.setProd3x3SubOf4(this._relativeOrientationMatrix,i.rotationX4Aux(this._beta*e.RAD),i.rotationZ4Aux(this._alpha*e.RAD))):(o=e.RAD*s/1e3,this._followedObjects.length>0?i.mulRotationRotation4(this._relativeOrientationMatrix,i.prod34Aux(i.rotation4Aux(t.normalize3(t.getRowB43Aux(this._relativeOrientationMatrix)),n[2]*o),i.rotation4Aux(t.normalize3(t.getRowA43Aux(this._relativeOrientationMatrix)),n[0]*o),i.rotation4Aux(t.normalize3(t.getRowC43Aux(this._relativeOrientationMatrix)),n[1]*o))):i.mulRotationRotation4(this._relativeOrientationMatrix,i.prod34Aux(i.rotation4Aux(t.normalize3(t.getRowC43Aux(this._relativeOrientationMatrix)),n[2]*o),i.rotation4Aux(t.normalize3(t.getRowA43Aux(this._relativeOrientationMatrix)),n[0]*o),i.rotation4Aux(t.normalize3(t.getRowB43Aux(this._relativeOrientationMatrix)),n[1]*o))))),!(!this._isTransitionConfiguration&&!this._cleanupFollowedObjects())&&(this._worldOrientationMatrixValid=!1,!0)},s.makeObject3DMixinClass.call(CameraConfiguration),CameraConfiguration.prototype.init=function(e,t,i,n,o,r,a,l){s.Object3D.prototype.init.call(this,t.pM,i.oM),this._name=e,
this._positionConfiguration=t,this._orientationConfiguration=i,this._defaultFOV=n,this._fov=n,this._minFOV=o?o[0]:n,this._maxFOV=o?o[1]:n,this._span=r,this._resetsOnFocusChange=a,this._excludeFromCycle=l,this._camera=null},CameraConfiguration.prototype.copy=function(t,n){var s=new CameraConfiguration(t||e.EMPTY_STRING,this._positionConfiguration.copy(n),this._orientationConfiguration.copy(n),this._fov,[this._minFOV,this._maxFOV],this._span);return s.setPositionMatrix(i.copy(this.pM)),s.setOrientationMatrix(i.copy(this.oM)),s},CameraConfiguration.prototype.setCamera=function(e,t){this._camera=e,this._positionConfiguration.setCamera(e,t),this._orientationConfiguration.setCamera(e),this._camera&&this._resetsOnFocusChange&&!t&&this.resetToDefaults(!0)},CameraConfiguration.prototype.setRelativePositionMatrix=function(e,t){this._positionConfiguration.setRelativePositionMatrix(e,t)},CameraConfiguration.prototype.moveByVector=function(e,t){this._positionConfiguration.moveByVector(e,t)},CameraConfiguration.prototype.setRelativeOrientationMatrix=function(e,t){this._orientationConfiguration.setRelativeOrientationMatrix(e,t)},CameraConfiguration.prototype.isFPS=function(){return this._orientationConfiguration.isFPS()},CameraConfiguration.prototype.setFOV=function(e,t){this._camera&&!t&&this._camera.configurationWillChange(),this._fov=Math.min(Math.max(e,this._minFOV),this._maxFOV)},CameraConfiguration.prototype.getFOV=function(){return this._fov},CameraConfiguration.prototype.decreaseFOV=function(){return this.setFOV(.95*this._fov,!0),this._fov},CameraConfiguration.prototype.increaseFOV=function(){return this.setFOV(1.05*this._fov,!0),this._fov},CameraConfiguration.prototype.getSpan=function(){return this._span},CameraConfiguration.prototype.resetsOnFocusChange=function(){return this._resetsOnFocusChange},CameraConfiguration.prototype.shouldExcludeFromCycle=function(){return this._excludeFromCycle},CameraConfiguration.prototype.resetToDefaults=function(e){this._camera&&!e&&this._camera.configurationWillChange(),this.setFOV(this._defaultFOV,!0),this._positionConfiguration.resetToDefaults(!0),this._orientationConfiguration.resetToDefaults(!0)},CameraConfiguration.prototype.update=function(e,t,i){var n=!0;return n=this._orientationConfiguration.update(t,i),this.setOrientationMatrix(this._orientationConfiguration.getWorldOrientationMatrix(this.pM,this._positionConfiguration.followsObjects()?this._positionConfiguration.getFollowedObjectOrientationMatrix():null)),n=this._positionConfiguration.update(this.oM,this._orientationConfiguration.followsObjects()?this._orientationConfiguration.getFollowedObjectsPositionVector():null,e,i)&&n,this.setPositionMatrix(this._positionConfiguration.getWorldPositionMatrix(this.oM)),n},CameraConfiguration.prototype.positionFollowsObjects=function(){return this._positionConfiguration.followsObjects()},CameraConfiguration.prototype.orientationFollowsObjects=function(){return this._orientationConfiguration.followsObjects()},CameraConfiguration.prototype.getFollowedPositionVector=function(){return this._positionConfiguration.getFollowedPositionVector()},CameraConfiguration.prototype.setOrientationFollowedObjects=function(e,t){this._orientationConfiguration.setFollowedObjects(e,t)},CameraConfiguration.prototype.setToFree=function(t,n,s,o,r,a,l){var c=i.getYawAndPitch(s);this._positionConfiguration.init(!1,!1,!1,[],!1,n,null,null,!1),this._orientationConfiguration.init(!1,!1,t,[],s,Math.degrees(c.yaw),Math.degrees(c.pitch),void 0,void 0,CameraOrientationConfiguration.BaseOrientation.WORLD,CameraOrientationConfiguration.PointToFallback.POSITION_FOLLOWED_OBJECT_OR_WORLD),this.init(e.EMPTY_STRING,this._positionConfiguration,this._orientationConfiguration,o,[r,a],l)},CameraConfiguration.prototype.destroy=function(){this._positionConfiguration=null,this._orientationConfiguration=null,this._camera=null},Camera.Stereoscopy={NONE:0,LEFT:1,RIGHT:2},Camera.TransitionStyle={NONE:"none",LINEAR:"linear",SMOOTH:"smooth"},Object.freeze(Camera.TransitionStyle),Camera.prototype.init=function(e,t,n,s,o,r,a){this._object3D.init(i.IDENTITY4,i.IDENTITY4,i.IDENTITY4),this._scene=e,this._aspect=t,this._usesVerticalValues=n,this._viewDistance=s,this._previousConfiguration=null,this._currentConfiguration=o,this._currentConfiguration.setCamera(this),this._transitionStyle=Camera.TransitionStyle.NONE,this._defaultTransitionStyle=a||Camera.TransitionStyle.NONE,this._transitionDuration=0,this._defaultTransitionDuration=r||0,this._transitionElapsedTime=0,this._velocityVector=[0,0,0],this._controlledVelocityVector=[0,0,0],this._angularVelocityVector=[0,0,0],this._previousFollowedPositionVector=null,i.setIdentity4(this._projectionMatrix),this._projectionMatrixValid=!1,this._followedNode=null,i.setIdentity4(this._viewMatrix),this._viewMatrixValid=!1,i.setIdentity4(this._inversePositionMatrix),this._inversePositionMatrixValid=!1,i.setIdentity4(this._inverseOrientationMatrix),this._inverseOrientationMatrixValid=!1,this._fov=0,this._span=0,this._near=0,this._extendedCamera=null,this._extendedCameraValid=!1,this._combinedExtendedCamera=null,this._combinedExtendedCameraValid=!1,this._updateFOV(),this._updateSpan()},Camera.prototype.setViewDistance=function(e){this._viewDistance=e,this._updateProjectionMatrix(this._fov,this._span)},Camera.prototype.getCameraPositionMatrix=function(){return i.copyTranslation4(this._posMatrix,this._object3D.pM),this._posMatrix},Camera.prototype.getCameraPositionVector=function(){return this._object3D.getPositionVector()},Camera.prototype.getCameraOrientationMatrix=function(){return i.copyRotation4(this._oriMatrix,this._object3D.oM),this._oriMatrix},Camera.prototype._setPositionMatrix=function(e){this._object3D.setPositionMatrix(e),this._viewMatrixValid=!1,this._inversePositionMatrixValid=!1},Camera.prototype._setPositionv=function(e){this._object3D.setPositionv(e),this._viewMatrixValid=!1,this._inversePositionMatrixValid=!1},Camera.prototype._setPositionM4=function(e){this._object3D.setPositionM4(e),this._viewMatrixValid=!1,this._inversePositionMatrixValid=!1},Camera.prototype._setOrientationMatrix=function(e){this._object3D.setOrientationMatrix(e),this._viewMatrixValid=!1,this._inverseOrientationMatrixValid=!1},Camera.prototype._setOrientationM4=function(e){this._object3D.setOrientationM4(e),this._viewMatrixValid=!1,this._inverseOrientationMatrixValid=!1},Camera.prototype._rotate=function(e,t){this._object3D.rotate(e,t),this._setOrientationMatrix()},Camera.prototype.moveToPosition=function(e,t,n){t=void 0===t?this._defaultTransitionDuration:t,t>0&&this.transitionToSameConfiguration(t,n),this._currentConfiguration.setRelativePositionMatrix(i.translation4v(e),!0)},Camera.prototype.getViewMatrix=function(){return this._viewMatrixValid||(i.setProdTranslationRotation4(this._viewMatrix,this.getInversePositionMatrix(),this.getInverseOrientationMatrix()),this._viewMatrixValid=!0),this._viewMatrix},Camera.prototype.getInversePositionMatrix=function(){return this._inversePositionMatrixValid||(i.setInverseOfTranslation4(this._inversePositionMatrix,this.getCameraPositionMatrix()),this._inversePositionMatrixValid=!0),this._inversePositionMatrix},Camera.prototype.getInverseOrientationMatrix=function(){return this._inverseOrientationMatrixValid||(i.setInverseOfRotation4(this._inverseOrientationMatrix,this.getCameraOrientationMatrix()),this._inverseOrientationMatrixValid=!0),this._inverseOrientationMatrix},Camera.prototype.getConfiguration=function(){return this._currentConfiguration},Camera.prototype.getProjectionMatrix=function(){return this._projectionMatrixValid||this._updateProjectionMatrix(this.getFOV(),this.getSpan()),this._projectionMatrix},Camera.prototype._updateProjectionMatrix=function(t,n){this._near=.5*n/Math.tan(t*e.RAD*.5),this._usesVerticalValues?i.setPerspective4(this._projectionMatrix,n*this._aspect*.5,.5*n,this._near,this._viewDistance):i.setPerspective4(this._projectionMatrix,.5*n,n/this._aspect*.5,this._near,this._viewDistance),this._projectionMatrixValid=!0},Camera.prototype.setAspect=function(e){this._aspect!==e&&(this._aspect=e,this._projectionMatrixValid=!1)},Camera.prototype.getFOV=function(){return this._fov||this._updateFOV(this._getTransitionProgress()),this._fov},Camera.prototype.setFOV=function(e,t,i){t=void 0===t?this._defaultTransitionDuration:t,t>0?this.transitionToSameConfiguration(t,i):this._fov=e,this._currentConfiguration.setFOV(e,!0),this._projectionMatrixValid=!1},Camera.prototype.decreaseFOV=function(){this._fov=this._currentConfiguration.decreaseFOV(),this._projectionMatrixValid=!1},Camera.prototype.increaseFOV=function(){this._fov=this._currentConfiguration.increaseFOV(),this._projectionMatrixValid=!1},Camera.prototype.getSpan=function(){return this._span||this._updateSpan(this._getTransitionProgress()),this._span},Camera.prototype.setControlledVelocityVector=function(e){this._controlledVelocityVector=e},Camera.prototype.setAngularVelocityVector=function(e){this._angularVelocityVector=e},Camera.prototype._getFreeCameraConfiguration=function(e,t,n){return void 0===e&&(e=this._currentConfiguration.isFPS()),t=t||this.getCameraPositionMatrix(),n=n||this.getCameraOrientationMatrix(),e&&(n=i.prod3x3SubOf4Aux(i.ROTATION_X_90,n)),getFreeCameraConfiguration(e,t,n,this.getFOV(),this._currentConfiguration._minFOV,this._currentConfiguration._maxFOV,this.getSpan())},Camera.prototype.setConfiguration=function(e,t){this._currentConfiguration&&this._currentConfiguration.setCamera(null),this._currentConfiguration=e,this._previousConfiguration=null,this._updateFOV(),this._updateSpan(),this._updateProjectionMatrix(this._fov,this._span),this._currentConfiguration.setCamera(this,t)},Camera.prototype.startTransitionToConfiguration=function(e,t,i){this._currentConfiguration!==e&&(0===t?this.setConfiguration(e):(this._previousConfiguration&&this._currentConfiguration?this._previousConfiguration=this._getFreeCameraConfiguration(!1):this._previousConfiguration=this._currentConfiguration,this._currentConfiguration&&this._currentConfiguration.setCamera(null),this._currentConfiguration=e,this._currentConfiguration.setCamera(this),this._transitionDuration=void 0===t?this._defaultTransitionDuration:t,this._transitionElapsedTime=0,this._transitionStyle=void 0===i?this._defaultTransitionStyle:i))},Camera.prototype.transitionToFreeCamera=function(e,t,i,n,s){this._followedNode=null,this.startTransitionToConfiguration(this._getFreeCameraConfiguration(e,t,i),n,s)},Camera.prototype.setToFreeCamera=function(e,t,i){this.transitionToFreeCamera(e,t,i,0)},Camera.prototype.transitionToSameConfiguration=function(t,i){var n=this._currentConfiguration;this.setConfiguration(this._previousConfiguration?this._getFreeCameraConfiguration(!1):this._currentConfiguration.copy(e.EMPTY_STRING,!0),!0),this.startTransitionToConfiguration(n,t,i)},Camera.prototype.transitionToConfigurationDefaults=function(e,t){this.transitionToSameConfiguration(e,t),this._currentConfiguration.resetToDefaults(!0)},Camera.prototype.positionConfigurationWillChange=function(){this.transitionToSameConfiguration()},Camera.prototype.orientationConfigurationWillChange=function(){this.transitionToSameConfiguration()},Camera.prototype.configurationWillChange=function(){this.transitionToSameConfiguration()},Camera.prototype.getFollowedNode=function(){return this._followedNode},Camera.prototype.moveToOrigoIfNeeded=function(e){var t=this.getCameraPositionMatrix(),n=null;return(t[12]>e||t[12]<-e||t[13]>e||t[13]<-e||t[14]>e||t[14]<-e)&&(n=[-t[12],-t[13],-t[14]],this._currentConfiguration.positionFollowsObjects()||this._currentConfiguration.setRelativePositionMatrix(i.identity4(),!0),this._previousConfiguration&&!this._previousConfiguration.positionFollowsObjects()&&this._previousConfiguration.moveByVector(n,!0)),n},Camera.prototype.followNode=function(e,t,i,n,s){var o,r;return!t&&this._followedNode===e||(this._followedNode=e,this._followedNode?(s&&(o=this._followedNode.getCameraConfigurationsWithName(s),o.length>0&&(r=o[0])),!!(r=r||this._followedNode.getNextCameraConfiguration())&&(this.startTransitionToConfiguration(r,i,n),!0)):(s&&(o=this._scene.getCameraConfigurationsWithName(s),o.length>0&&(r=o[0])),!!(r=r||this._scene.getNextCameraConfiguration())&&(this.startTransitionToConfiguration(r,i,n),!0)))},Camera.prototype.followObject=function(e,t,i,n,s){return this.followNode(e._node,t,i,n,s)},Camera.prototype.changeToNextView=function(e,t){this._followedNode?this.startTransitionToConfiguration(this._followedNode.getNextCameraConfiguration(this._currentConfiguration),e,t):this._scene.getNextCameraConfiguration()&&this.startTransitionToConfiguration(this._scene.getNextCameraConfiguration(this._scene.hasCameraConfiguration(this._currentConfiguration)?this._currentConfiguration:null),e,t)},Camera.prototype.changeToPreviousView=function(e,t){this._followedNode?this.startTransitionToConfiguration(this._followedNode.getPreviousCameraConfiguration(this._currentConfiguration),e,t):this._scene.getNextCameraConfiguration()&&this.startTransitionToConfiguration(this._scene.getPreviousCameraConfiguration(this._scene.hasCameraConfiguration(this._currentConfiguration)?this._currentConfiguration:null),e,t)},Camera.prototype.followNextNode=function(e,t,i){for(var n=this._scene.getNextNode(this._followedNode),s=this._followedNode;n!==s&&n&&(!n.getNextCameraConfiguration()||!n.isVisible());)if(s||(s=n),n=this._scene.getNextNode(n),e&&this._followedNode&&n===this._scene.getFirstNode()&&this.followNode(null,!0,t,i))return!0;return!!(n&&n.getNextCameraConfiguration()&&n.isVisible())&&this.followNode(n,!0,t,i)},Camera.prototype.followPreviousNode=function(e,t,i){for(var n=this._scene.getFirstNode(),s=this._scene.getPreviousNode(this._followedNode),o=this._followedNode;s!==o&&s&&(!s.getNextCameraConfiguration()||!s.isVisible());){if(o||(o=s),e&&s===n&&this.followNode(null,!0,t,i))return;s=this._scene.getPreviousNode(s)}s&&s.getNextCameraConfiguration()&&this.followNode(s,!0,t,i)},Camera.prototype.followOrientationOfObjects=function(e,t,i){t=void 0===t?this._defaultTransitionDuration:t,t>0&&this.transitionToSameConfiguration(t,i),this._currentConfiguration.setOrientationFollowedObjects(e,!0)},Camera.prototype._getTransitionProgress=function(){var e;if(0===this._transitionDuration)return 0;switch(this._transitionStyle){case Camera.TransitionStyle.LINEAR:return this._transitionElapsedTime/this._transitionDuration;case Camera.TransitionStyle.SMOOTH:return e=this._transitionElapsedTime/this._transitionDuration,e=3*e*e-2*e*e*e}return-1},Camera.prototype._updateFOV=function(e){this._fov=this._previousConfiguration?this._previousConfiguration.getFOV()+(this._currentConfiguration.getFOV()-this._previousConfiguration.getFOV())*e:this._currentConfiguration.getFOV()},Camera.prototype._updateSpan=function(e){this._span=this._previousConfiguration?this._previousConfiguration.getSpan()+(this._currentConfiguration.getSpan()-this._previousConfiguration.getSpan())*e:this._currentConfiguration.getSpan()},Camera.prototype._updateStereoAngle=function(){this._stereoAngle=Math.atan(this._interocularHalfDistance/this._stereoscopicConvergenceDistance)},Camera.prototype.update=function(e){var n,s,o,r,a,l,c;if(this._extendedCameraValid=!1,this._combinedExtendedCameraValid=!1,this._previousConfiguration){if(!this._currentConfiguration.update([0,0,0],[0,0,0],e))return void this.update(e);if(this._transitionElapsedTime+=e,this._transitionElapsedTime>this._transitionDuration&&(this._transitionElapsedTime=this._transitionDuration),l=this._getTransitionProgress(),!this._previousConfiguration.update([0,0,0],[0,0,0],e))return void this.update(e);n=this._previousConfiguration.getPositionVector(),s=this._currentConfiguration.getPositionVector(),o=this.getCameraPositionVector(),this._setPositionv(t.sum3Aux(t.scaled3Aux(n,1-l),t.scaled3Aux(s,l))),t.setProdMat4Vec3(this._velocityVector,this.getCameraOrientationMatrix(),t.diff3Aux(this.getCameraPositionVector(),o)),t.scale3(this._velocityVector,1e3/e),r=i.prod3x3SubOf4Aux(i.inverseOfRotation4Aux(this._previousConfiguration.oM),this._currentConfiguration.oM),a=i.getRotations(r),this._setOrientationM4(i.IDENTITY4),this._rotate(a.gammaAxis,a.gamma*l),this._rotate(a.alphaAxis,a.alpha*l),c=i.prod3x3SubOf4Aux(this._previousConfiguration.oM,this.getCameraOrientationMatrix()),i.correctOrthogonal4(c),this._setOrientationM4(c),this._updateFOV(l),this._updateSpan(l),this._updateProjectionMatrix(this._fov,this._span),this._transitionElapsedTime===this._transitionDuration&&(this._previousConfiguration=null)}else{if(!this._currentConfiguration.update(this._controlledVelocityVector,this._angularVelocityVector,e))return void this.update(e);if(!this._currentConfiguration.update([0,0,0],[0,0,0],e))return void this.update(e);o=this.getCameraPositionVector(),this._setPositionM4(this._currentConfiguration.pM),this._setOrientationM4(this._currentConfiguration.oM),this._currentConfiguration.positionFollowsObjects()?(this._previousFollowedPositionVector?(t.setProdMat4Vec3(this._velocityVector,this.getCameraOrientationMatrix(),t.diff3Aux(this._currentConfiguration.getFollowedPositionVector(),this._previousFollowedPositionVector)),t.scale3(this._velocityVector,1e3/e)):(this._velocityVector[0]=0,this._velocityVector[1]=0,this._velocityVector[2]=0),this._previousFollowedPositionVector=this._currentConfiguration.getFollowedPositionVector()):(t.setProdMat4Vec3(this._velocityVector,this.getCameraOrientationMatrix(),t.diff3Aux(this.getCameraPositionVector(),o)),t.scale3(this._velocityVector,1e3/e))}},Camera.prototype._setStereoscopy=function(e){this._stereoscopy!==e&&(this._stereoscopy=e,this._leftEye=e===Camera.Stereoscopy.LEFT,this._rightEye=e===Camera.Stereoscopy.RIGHT,this._viewMatrixValid=!1,this._inversePositionMatrixValid=!1,this._inverseOrientationMatrixValid=!1)},Camera.prototype.setLeftEye=function(){this._setStereoscopy(Camera.Stereoscopy.LEFT)},Camera.prototype.setRightEye=function(){this._setStereoscopy(Camera.Stereoscopy.RIGHT)},Camera.prototype.setInterocularDistance=function(e){this._interocularHalfDistance=.5*e,this._updateStereoAngle()},Camera.prototype.setStereoscopicConvergenceDistance=function(e){this._stereoscopicConvergenceDistance=e,this._updateStereoAngle()},Camera.prototype.copyStereoscopy=function(e,t,i){this._setStereoscopy(e),e!==Camera.Stereoscopy.NONE&&(this._interocularHalfDistance=t,this._stereoscopicConvergenceDistance=i,this._updateStereoAngle())},Camera.prototype.getExtendedCamera=function(e){var t,i;return!e&&this._extendedCameraValid?i=this._extendedCamera:e&&this._combinedExtendedCameraValid?i=this._combinedExtendedCamera:(0===this._fov&&(this._updateFOV(),this._updateSpan()),t=e?this._span:this._span/this._near*this._viewDistance,i=e?this._combinedExtendedCamera:this._extendedCamera,i?(i.getConfiguration().setToFree(!1,this._object3D.pM,this._object3D.oM,this._fov,this._fov,this._fov,t,t,t),i.init(this._scene,this._aspect,this._usesVerticalValues,5*this._viewDistance,i.getConfiguration())):i=new Camera(this._scene,this._aspect,this._usesVerticalValues,5*this._viewDistance,getFreeCameraConfiguration(!1,this._object3D.pM,this._object3D.oM,this._fov,this._fov,this._fov,t)),i.update(0),e?(this._combinedExtendedCameraValid=!0,this._combinedExtendedCamera=i):(this._extendedCameraValid=!0,this._extendedCamera=i)),i.copyStereoscopy(this._stereoscopy,this._interocularHalfDistance,this._stereoscopicConvergenceDistance),i},{CAMERA_EXTENSION_FACTOR:5,CameraPositionConfiguration:CameraPositionConfiguration,CameraOrientationConfiguration:CameraOrientationConfiguration,CameraConfiguration:CameraConfiguration,Camera:Camera,getFreeCameraConfiguration:getFreeCameraConfiguration}}),define("modules/physics",["utils/utils","utils/vectors","utils/matrices"],function(e,t,i){"use strict";function getDrag(){return s}function setDrag(e,t){s=e,o=t}function applyDrag(e,t,i){var o,r;(o=e[12]*e[12]+e[13]*e[13]+e[14]*e[14])>n&&(r=s*i*o,o=1/Math.sqrt(o),r=-o*r*t*.001,e[12]+=r*e[12],e[13]+=r*e[13],e[14]+=r*e[14])}function Body(e,n,s){this.pM=e,this._positionVector=i.translationVector3(e),this.oM=n,this._rotated=!i.equal4(n,i.IDENTITY4),this.mMI=i.prodTranslationRotation4(i.inverseOfTranslation4Aux(this.pM),i.inverseOfRotation4Aux(this.oM)),this._halfWidth=.5*s[0],this._halfHeight=.5*s[1],this._halfDepth=.5*s[2],this._modelTransformResult=[0,0,0,1],this._points=new Float32Array(24),this._points.set(t.addVec3Mat4(t.mulVec3Mat4([-this._halfWidth,-this._halfHeight,-this._halfDepth],this.oM),this.pM),0),this._points.set(t.addVec3Mat4(t.mulVec3Mat4([this._halfWidth,-this._halfHeight,-this._halfDepth],this.oM),this.pM),3),this._points.set(t.addVec3Mat4(t.mulVec3Mat4([-this._halfWidth,this._halfHeight,-this._halfDepth],this.oM),this.pM),6),this._points.set(t.addVec3Mat4(t.mulVec3Mat4([this._halfWidth,this._halfHeight,-this._halfDepth],this.oM),this.pM),9),this._points.set(t.addVec3Mat4(t.mulVec3Mat4([-this._halfWidth,-this._halfHeight,this._halfDepth],this.oM),this.pM),12),this._points.set(t.addVec3Mat4(t.mulVec3Mat4([this._halfWidth,-this._halfHeight,this._halfDepth],this.oM),this.pM),15),this._points.set(t.addVec3Mat4(t.mulVec3Mat4([-this._halfWidth,this._halfHeight,this._halfDepth],this.oM),this.pM),18),this._points.set(t.addVec3Mat4(t.mulVec3Mat4([this._halfWidth,this._halfHeight,this._halfDepth],this.oM),this.pM),21),this._hitDistance=0}function PhysicalObject(e,t,n,s,o,r,a){this._mass=0,this.pM=i.identity4(),this.oM=i.identity4(),this.sM=i.identity4(),this.mM=i.identity4(),this.mMValid=!1,this.mMI=i.identity4(),this.mMIV=!1,this._velocityMatrix=i.identity4(),this._acceleration=[0,0,0],this._offset=[0,0,0],this._angularAccelerationMatrix=i.identity3(),this._orientationOffset=i.identity3(),this._hasAngularAcceleration=!1,this._bodies=null,this._bodySize=-1,this._dragFactor=0,this._inverseScalingFactor=1,this._inverseMass=0,this._collision={position:[0,0,0,1],direction:[0,0,0],magnitude:0,reverse:!1},t&&this.init(e,t,n,s,o,r,a)}var n=.1,s=0,o=0,r=[0,0,0,1],a=[0,0,0,1],l=i.identity4(),c=i.identity4();return Body.prototype.getWidth=function(){return 2*this._halfWidth},Body.prototype.getHeight=function(){return 2*this._halfHeight},Body.prototype.getDepth=function(){return 2*this._halfDepth},Body.prototype._modelTransform=function(e){return this._rotated?t.setSum3(this._modelTransformResult,t.prodVec3Mat4Aux(e,this.oM),this._positionVector):t.setSum3(this._modelTransformResult,e,this._positionVector),this._modelTransformResult},Body.prototype.getHalfDimensions=function(){return[this._halfWidth,this._halfHeight,this._halfDepth]},Body.prototype.checkHit=function(i,n,s,o){var r,a,l,c=this._halfWidth+o,h=this._halfHeight+o,u=this._halfDepth+o;if(this._rotated?(i=t.prodVec4Mat4Aux(i,this.mMI),n=t.prodMat4Vec3Aux(this.oM,n)):i=t.diff3Aux(i,this._positionVector),0!==n[0])if(n[0]>0){if(r=(-c-i[0])/n[0],a=i[1]+n[1]*r,l=i[2]+n[2]*r,e.pointInRect(a,l,-h,-u,h,u))return r<=0&&r>=-s?(this._hitDistance=r,this._modelTransform([-c,a,l])):null}else if(r=(c-i[0])/n[0],a=i[1]+n[1]*r,l=i[2]+n[2]*r,e.pointInRect(a,l,-h,-u,h,u))return r<=0&&r>=-s?(this._hitDistance=r,this._modelTransform([c,a,l])):null;if(0!==n[1])if(n[1]>0){if(r=(-h-i[1])/n[1],a=i[0]+n[0]*r,l=i[2]+n[2]*r,e.pointInRect(a,l,-c,-u,c,u))return r<=0&&r>=-s?(this._hitDistance=r,this._modelTransform([a,-h,l])):null}else if(r=(h-i[1])/n[1],a=i[0]+n[0]*r,l=i[2]+n[2]*r,e.pointInRect(a,l,-c,-u,c,u))return r<=0&&r>=-s?(this._hitDistance=r,this._modelTransform([a,h,l])):null;if(0!==n[2])if(n[2]>0){if(r=(-u-i[2])/n[2],a=i[0]+n[0]*r,l=i[1]+n[1]*r,e.pointInRect(a,l,-c,-h,c,h))return r<=0&&r>=-s?(this._hitDistance=r,this._modelTransform([a,l,-u])):null}else if(r=(u-i[2])/n[2],a=i[0]+n[0]*r,l=i[1]+n[1]*r,e.pointInRect(a,l,-c,-h,c,h))return r<=0&&r>=-s?(this._hitDistance=r,this._modelTransform([a,l,u])):null;return null},PhysicalObject.prototype.init=function(n,s,o,r,a,l,c){this._mass=n,this._inverseMass=1/n,i.copyTranslation4(this.pM,s),i.copyRotation4(this.oM,o),this.sM[0]=r,this.sM[5]=r,this.sM[10]=r,this.mMValid=!1,this.mMIV=!1,i.setIdentity4(this._velocityMatrix),i.copyTranslation4(this._velocityMatrix,a),t.setNull3(this._acceleration),t.setNull3(this._offset),i.setIdentity3(this._angularAccelerationMatrix),i.setIdentity3(this._orientationOffset),this._hasAngularAcceleration=!1,this._inverseScalingFactor=1/this.sM[0],this._bodies=l||e.EMPTY_ARRAY,this._bodySize=-1,this._calculateBodySize(),this._dragFactor=void 0!==c?c:1},PhysicalObject.prototype.reset=function(){i.setIdentity4(this._velocityMatrix),t.setNull3(this._acceleration),t.setNull3(this._offset),i.setIdentity3(this._orientationOffset),i.setIdentity3(this._angularAccelerationMatrix),this._hasAngularAcceleration=!1},PhysicalObject.prototype.copyPositionToVector=function(e){e[0]=this.pM[12],e[1]=this.pM[13],e[2]=this.pM[14]},PhysicalObject.prototype.getBodySize=function(){return this._bodySize},PhysicalObject.prototype.getSize=function(){return this._bodySize*this.sM[0]},PhysicalObject.prototype.setVelocity=function(e,t,i){this._velocityMatrix[12]=e,this._velocityMatrix[13]=t,this._velocityMatrix[14]=i},PhysicalObject.prototype.setVelocityv=function(e){this._velocityMatrix[12]=e[0],this._velocityMatrix[13]=e[1],this._velocityMatrix[14]=e[2]},PhysicalObject.prototype.setAngularVelocity=function(e,t,i,n,s,o,r,a,l){this._velocityMatrix[0]=e,this._velocityMatrix[1]=t,this._velocityMatrix[2]=i,this._velocityMatrix[4]=n,this._velocityMatrix[5]=s,this._velocityMatrix[6]=o,this._velocityMatrix[8]=r,this._velocityMatrix[9]=a,this._velocityMatrix[10]=l},PhysicalObject.prototype.applyForce=function(e,t,i,n,s){var o=.001*s,r=e*this._inverseMass*.5*o*o;this._offset[0]+=t*r,this._offset[1]+=i*r,this._offset[2]+=n*r,r=e*this._inverseMass*o,this._acceleration[0]+=t*r,this._acceleration[1]+=i*r,this._acceleration[2]+=n*r},PhysicalObject.prototype.applyTorque=function(e,t,n){var s=.001*n,o=e*this._inverseMass*s;this._hasAngularAcceleration=!0,i.mul3(this._orientationOffset,i.rotation3Aux(t,.5*o*s)),i.mul3(this._angularAccelerationMatrix,i.rotation3Aux(t,5*o*.001))},PhysicalObject.prototype.setPosition=function(e,t,i){this.pM[12]=e,this.pM[13]=t,this.pM[14]=i,this.mMValid=!1,this.mMIV=!1},PhysicalObject.prototype.translate=function(e,t,i){this.pM[12]+=e,this.pM[13]+=t,this.pM[14]+=i,this.mMValid=!1,this.mMIV=!1},PhysicalObject.prototype.updateOrientationMatrix=function(e){this.oM[0]=e[0],this.oM[1]=e[1],this.oM[2]=e[2],this.oM[4]=e[4],this.oM[5]=e[5],this.oM[6]=e[6],this.oM[8]=e[8],this.oM[9]=e[9],this.oM[10]=e[10],this.mMValid=!1,this.mMIV=!1},PhysicalObject.prototype.setOrientation=function(e,t,i,n,s,o){this.oM[0]=t*o-i*s,this.oM[1]=i*n-e*o,this.oM[2]=e*s-t*n,this.oM[4]=e,this.oM[5]=t,this.oM[6]=i,this.oM[8]=n,this.oM[9]=s,this.oM[10]=o,this.mMValid=!1,this.mMIV=!1},PhysicalObject.prototype.setScaling=function(e){this.sM[0]=e,this.sM[5]=e,this.sM[10]=e,this.mMValid=!1,this.mMIV=!1,this._inverseScalingFactor=1/e},PhysicalObject.prototype.getModelMatrix=function(){return this.mMValid||(i.setModelMatrix(this.mM,this.pM,this.oM,this.sM),this.mMValid=!0),this.mM},PhysicalObject.prototype.getModelMatrixInverse=function(){return this.mMIV||(i.updateModelMatrixInverse(this.mMI,this.pM,this.oM,this._inverseScalingFactor),this.mMIV=!0),this.mMI},PhysicalObject.prototype.applyForceAndTorque=function(e,n,s,o,r){var a,l,c=t.length3(e),h=t.scaled3Aux(e,1/c),u=t.scaled3Aux(h,t.dot3(n,h)),d=t.diff3Aux(n,u),p=.001*r,_=s*this._inverseMass*.5*p*p;this._offset[0]+=n[0]*_,this._offset[1]+=n[1]*_,this._offset[2]+=n[2]*_,_=s*this._inverseMass*p,this._velocityMatrix[12]+=n[0]*_,this._velocityMatrix[13]+=n[1]*_,this._velocityMatrix[14]+=n[2]*_,a=1!==o?s>0?Math.min(o*s*t.length3(d)*c,s/c):Math.max(o*s*t.length3(d)*c,s/c):s*t.length3(d)*c,l=t.normalize3(t.cross3Aux(d,h)),_=a*this._inverseMass*p,i.mul3(this._orientationOffset,i.rotation3Aux(l,.5*_*p)),i.mulRotation43(this._velocityMatrix,i.rotation3Aux(l,5*_*.001)),i.straightenRotation4(this._velocityMatrix,1e-5)},PhysicalObject.prototype._calculateBodySize=function(){var e,n,s=[0,0,0];for(this._bodySize=0,e=0;e<this._bodies.length;e++)t.setTranslationVector3(s,this._bodies[e].pM),n=t.prodVec3Mat3Aux(this._bodies[e].getHalfDimensions(),i.prod3x3SubOf43Aux(this.oM,this._bodies[e].oM)),this._bodySize=Math.max(this._bodySize,t.length3(t.sum3Aux(s,n))),this._bodySize=Math.max(this._bodySize,t.length3(t.sum3Aux(s,[n[0],n[1],-n[2]]))),this._bodySize=Math.max(this._bodySize,t.length3(t.sum3Aux(s,[n[0],-n[1],n[2]]))),this._bodySize=Math.max(this._bodySize,t.length3(t.sum3Aux(s,[n[0],-n[1],-n[2]]))),this._bodySize=Math.max(this._bodySize,t.length3(t.sum3Aux(s,[-n[0],n[1],n[2]]))),this._bodySize=Math.max(this._bodySize,t.length3(t.sum3Aux(s,[-n[0],n[1],-n[2]]))),this._bodySize=Math.max(this._bodySize,t.length3(t.sum3Aux(s,[-n[0],-n[1],n[2]]))),this._bodySize=Math.max(this._bodySize,t.length3(t.sum3Aux(s,[-n[0],-n[1],-n[2]])))},PhysicalObject.prototype.checkHit=function(e,i,n,s){var o,l,c=null;if(s*=this._inverseScalingFactor,t.setProdTranslationModel3(r,e,this.getModelMatrixInverse()),a[0]=i[12]-this._velocityMatrix[12],a[1]=i[13]-this._velocityMatrix[13],a[2]=i[14]-this._velocityMatrix[14],o=t.extractLength3(a),l=o*n*.001*this._inverseScalingFactor,Math.abs(r[0])-l<this._bodySize+s&&Math.abs(r[1])-l<this._bodySize+s&&Math.abs(r[2])-l<this._bodySize+s)for(r[3]=1,t.mulMat4Vec3(a,this.oM),o=0;null===c&&o<this._bodies.length;o++)c=this._bodies[o].checkHit(r,a,l,s);return c},PhysicalObject.prototype.checkHitRelative=function(e,t,i,n){var s,o=null;for(s=0;null===o&&s<this._bodies.length;s++)o=this._bodies[s].checkHit(e,t,i,n);return o},PhysicalObject.prototype._checkCollision=function(e,n,s,o){var h,u,d,p,_,g,m,f,S,T,y;for(f=this.getModelMatrixInverse(),i.setProd4(l,e.getModelMatrix(),f),i.setProdScalingRotation(c,e.sM,e.oM),o&&i.mulRotation43Multi(c,i.matrix3from4Aux(e._velocityMatrix),Math.round(.2*n)),i.translateByMatrix(c,e.pM),i.mul4(c,f),y=t.prodMat4Vec3Aux(this.oM,t.diffTranslation3Aux(e._velocityMatrix,this._velocityMatrix)),t.scale3(y,.001*n*this._inverseScalingFactor),c[12]+=y[0],c[13]+=y[1],c[14]+=y[2],s&&(S=i.matrix3from4Aux(this._velocityMatrix),i.mul3multi(S,i.matrix3Aux(S),Math.round(.2*n)),i.setProdRotationRotationInverse43(S,i.prod3x3SubOf43Aux(this.oM,S),this.oM),i.transpose3(S),i.mul43(c,S)),
m=0,d=0;d<e._bodies.length;d++)for(p=0;p<8;p++)for(r[0]=e._bodies[d]._points[3*p],r[1]=e._bodies[d]._points[3*p+1],r[2]=e._bodies[d]._points[3*p+2],r[3]=1,t.setProdVec4Mat4(a,r,c),t.mulVec4Mat4(r,l),a[0]=(a[0]-r[0])*this.sM[0],a[1]=(a[1]-r[1])*this.sM[0],a[2]=(a[2]-r[2])*this.sM[0],h=t.extractLength3(a),T=1e3*h/n,h*=this._inverseScalingFactor,u=0;u<this._bodies.length;u++)(_=this._bodies[u].checkHit(r,a,h,0))&&this._bodies[u]._hitDistance<m&&(g=_,m=this._bodies[u]._hitDistance,this._collision.direction[0]=a[0],this._collision.direction[1]=a[1],this._collision.direction[2]=a[2],this._collision.magnitude=T);return g?(this._collision.reverse=!1,this._collision.position[0]=g[0],this._collision.position[1]=g[1],this._collision.position[2]=g[2],this._collision.position[3]=1,t.setProdVec3Mat4(a,this._collision.direction,this.oM),m-=.25*this._inverseScalingFactor,e._mass<=this._mass?(e.translate(a[0]*m*this.sM[0],a[1]*m*this.sM[0],a[2]*m*this.sM[0]),T=this._collision.magnitude*e._mass*1200):(this.translate(-a[0]*m*this.sM[0],-a[1]*m*this.sM[0],-a[2]*m*this.sM[0]),T=this._collision.magnitude*this._mass*1200),t.setProdVec4Mat4(r,this._collision.position,this.getModelMatrix()),this.applyForceAndTorque(t.diffVec3Mat4Aux(r,this.pM),a,T,.005,1),e.applyForceAndTorque(t.diffVec3Mat4Aux(r,e.pM),a,-T,.005,1),this._collision):null},PhysicalObject.prototype.checkCollision=function(e,n){var s,o,r,a,l;return s=this._bodySize*this.sM[0]+e.getBodySize()*e.sM[0],r=t.length3(t.diffTranslation3Aux(e._velocityMatrix,this._velocityMatrix))*n*.001,i.distanceSquared(e.pM,this.pM)>s*s+r*r+2*s*r?null:(a=0!==this._velocityMatrix[1]||0!==this._velocityMatrix[2]||0!==this._velocityMatrix[4]||0!==this._velocityMatrix[6]||0!==this._velocityMatrix[8]||0!==this._velocityMatrix[9],l=0!==e._velocityMatrix[1]||0!==e._velocityMatrix[2]||0!==e._velocityMatrix[4]||0!==e._velocityMatrix[6]||0!==e._velocityMatrix[8]||0!==e._velocityMatrix[9],r<1e-4&&!a&&!l?null:(o=this._checkCollision(e,n,a,l),o||(o=e._checkCollision(this,n,l,a))&&(o.reverse=!0),o))},PhysicalObject.prototype.simulate=function(e){var n,r,a;if(e>0){for(s>0&&this._dragFactor>0&&applyDrag(this._velocityMatrix,e,this._dragFactor),i.translateByMatrixMul(this.pM,this._velocityMatrix,.001*e),i.translateByVector(this.pM,this._offset),this.mMIV=!1,i.translateByVector(this._velocityMatrix,this._acceleration),t.setNull3(this._acceleration),t.setNull3(this._offset),i.straightenTranslation(this._velocityMatrix,1e-4),s>0&&this._dragFactor>0&&(a=i.identity3Aux(),r=o*this._dragFactor*e*.001,t.angle2y(this._velocityMatrix[4],this._velocityMatrix[5])>.001&&i.mul3(a,i.rotation3Aux(t.UNIT3_Z,this._velocityMatrix[4]>0?-r:r)),t.angle2x(this._velocityMatrix[5],this._velocityMatrix[6])>.001&&i.mul3(a,i.rotation3Aux(t.UNIT3_X,this._velocityMatrix[6]>0?r:-r)),t.angle2x(this._velocityMatrix[0],this._velocityMatrix[2])>.001&&i.mul3(a,i.rotation3Aux(t.UNIT3_Y,this._velocityMatrix[2]>0?-r:r)),i.mulRotation43(this._velocityMatrix,a)),n=0;n+2.5<e;n+=5)i.mulRotationRotation4(this.oM,this._velocityMatrix);this._hasAngularAcceleration&&(i.mulRotation43(this.oM,this._orientationOffset),i.setIdentity3(this._orientationOffset),i.mulRotation43(this._velocityMatrix,this._angularAccelerationMatrix),i.setIdentity3(this._angularAccelerationMatrix),this._hasAngularAcceleration=!1,i.straightenRotation4(this._velocityMatrix,1e-5)),i.correctOrthogonal4(this.oM),i.correctOrthogonal4(this._velocityMatrix),this.mMValid=!1,this.mMIV=!1}},{getDrag:getDrag,setDrag:setDrag,applyDrag:applyDrag,Body:Body,PhysicalObject:PhysicalObject,ANGULAR_VELOCITY_MATRIX_DURATION:5,ANGULAR_VELOCITY_MATRIX_DURATION_S:.005,VELOCITY_MATRIX_ERROR_THRESHOLD:1e-4,ANGULAR_VELOCITY_MATRIX_ERROR_THRESHOLD:1e-5}}),define("modules/scene/renderable-objects",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/scene/object-3d"],function(e,t,i,n,s,o){"use strict";function _getScaleModeInt(t){switch(t){case e.ScaleMode.WIDTH:return 0;case e.ScaleMode.HEIGHT:return 1;case e.ScaleMode.ASPECT:return 2;case e.ScaleMode.MINIMUM:return 3;case e.ScaleMode.MAXIMUM:return 4}}function RenderableObject(e,t,i,n,s){this._node=null,this._shader=e,this._textures={},this._textureRoles=[],this._uniformValueFunctions={},this._isRenderedWithDepthMask=void 0===t||t,this._isRenderedWithoutDepthMask=void 0===i||i,this._instancedShader=n||null,this._canBeReused=!1,this._visible=!0,this._castsShadows=void 0===s||s,this._wasRenderedToShadowMap=!1,this._name=null}function RenderableObject3D(e,t,i,n,s,r,a,l,c,h){RenderableObject.call(this,e,t,i,a),o.Object3D.call(this,n,s,r,l,c,h),this._visibleSize={width:-1,height:-1},this._visibleSizeUpdated=!1,this._smallestSizeWhenDrawn=0}function ContainerObject(e){RenderableObject3D.call(this,e)}function CubemapSampledFVQ(e,t,n,s,o){RenderableObject.call(this,t,!1,!0),this._model=e,this._samplerName=n,this._camera=o,this.setTexture(n,s),this.setUniformValueFunction(r,function(){return i.inverse4Aux(i.prod4Aux(this._camera.getInverseOrientationMatrix(),this._camera.getProjectionMatrix()))})}function ShadedLODMesh(e,t,n,s,o,r,c,h,u){RenderableObject3D.call(this),this._model=null,this._wireframe=!1,this._currentLOD=this.LOD_NOT_SET,this._lastLOD=this.LOD_NOT_SET,this._modelSize=0,this._lodSizeFactors=null,this._staticLOD=this.LOD_NOT_SET,e&&this.init(e,t,n,s,o,r,c,h,u),this.setUniformValueFunction(a,function(){return this.getModelMatrix()}),this.setUniformValueFunction(l,function(){return i.transposed3Aux(i.inverse3Aux(i.matrix3from4Aux(this.getModelMatrix())))})}function ParameterizedMesh(e,t,i,n,s,o,r,a,l,c,h){ShadedLODMesh.call(this),this._parameterArrays=null,e&&this.init(e,t,i,n,s,o,r,a,l,c,h)}function Billboard(e,t,i,n,s,o,r,a){RenderableObject3D.call(this),this._model=null,this._wireframe=!1,this._renderPosition=[0,0,0,0],this._renderDirection=[0,0,0,0],e&&this.init(e,t,i,n,s,o,r,a),this.setUniformValueFunction(p,function(){return this.copyPositionToVector(this._renderPosition),this._renderPosition}),this.setUniformValueFunction(_,function(){return this._renderDirection})}function Trail(e){RenderableObject3D.call(this),this._detached=!1,e&&this.init(e),this.setUniformValueFunction(a,function(){return this.getModelMatrix()})}function TrailSegment(e,t,i,n,s,o,r,a,l,c,u,d,p,_){RenderableObject3D.call(this),this._model=null,this._wireframe=!1,this._sizeVector=[0,0,0],this._startPosition=[0,0,0],this._endPosition=[0,0,0],this._startDirection=[0,0,0],this._endDirection=[0,0,0],this._direction=[0,0,0],this._color=[0,0,0,0],this._duration=0,this._startTimeLeft=0,this._endTimeLeft=0,e&&this.init(e,t,i,n,s,o,r,a,l,c,u,d,p,_),this.setUniformValueFunction(m,function(){return this._startPosition}),this.setUniformValueFunction(f,function(){return this._endPosition}),this.setUniformValueFunction(S,function(){return this._startDirection}),this.setUniformValueFunction(T,function(){return this._endDirection}),this.setUniformValueFunction(g,function(){return this._sizeVector}),this.setUniformValueFunction(h,function(){return this._color})}function ParticleState(e,t,i){this.color=e||A,this.size=void 0!==t?t:1,this.timeToReach=i||0}function Particle(e,i,n,s,o,r,a,l){RenderableObject3D.call(this),this._smallestSizeWhenDrawn=.1,this._model=e,this._color=[0,0,0,0],this._size=0,this._relativeSize=0,this._positionVector=[0,0,0,0],this._states=null,this._currentStateIndex=0,this._looping=!1,this._timeSinceLastTransition=0,this._velocityVector=[0,0,0],this._worldVelocityDirectionVector=[0,0,0],this._worldVelocityDirectionVectorValid=!1,this._shouldAnimate=!1,this._duration=0,e&&this.init(e,i,n,s,o,r,a,l),this.setUniformValueFunction(p,function(){var e;return e=this.getModelMatrix(),this._positionVector[0]=e[12],this._positionVector[1]=e[13],this._positionVector[2]=e[14],this._positionVector}),this.setUniformValueFunction(h,function(){return this._color}),this.setUniformValueFunction(_,function(){return t.floatVector3Aux(this.getWorldVelocityDirectionVector())})}function initDynamicParticle(e,t,i,n,s,o,r,a,l){e.init(t,i,n,r,[new ParticleState(s,o,0),new ParticleState(s,0,a)],!1,l)}function dynamicParticle(e,t,i,n,s,o,r,a){var l=new Particle;return initDynamicParticle(l,e,t,i,n,s,o,r,a),l}function staticParticle(e,t,i,n,s,o,r){return new Particle(e,t,i,o,[new ParticleState(n,s,0)],!1,r)}function BackgroundBillboard(n,s,o,r,l,h,u){var d,p,_,g={yaw:0,pitch:0,roll:0};Particle.call(this,n,s,o,h,[new ParticleState(r,l,0)],!1),_=[0,1],t.rotate2(_,u),d=[_[0],0,_[1]],p=t.normalize3(i.translationVector3(h)),t.getYawAndPitch(g,p),_=[0,_[1]],t.rotate2(_,g.pitch),d=[d[0],_[0],_[1]],_=[d[0],_[0]],t.rotate2(_,g.yaw),d=[_[0],_[1],d[2]],this.setOrientationMatrix(i.lookTowards4(t.scaled3Aux(p,-1),d)),this._positionVector.length=3,this._calculatedSize=[l],this.setUniformValueFunction(c,function(t){return t===e.EMPTY_STRING?this._calculatedSize:this._calculatedSize[0]}),this.setUniformValueFunction(a,function(){return this.getModelMatrix()})}function PointParticle(e,t,i,n,s,o){RenderableObject.call(this,t,!1,!0,i),this._positionVector=n,this._model=e,this._color=s,this._range=o,this._shift=null,this.setUniformValueFunction(p,function(){return this._positionVector}),this._color&&(this._shift=[0,0,0],this.setUniformValueFunction(h,function(){return this._color}),this.setUniformValueFunction(u,function(){return this._shift}),this.setUniformValueFunction(d,function(){return this._range}))}function UIElement(e,t,n,s,o,r,a,l,c,u){RenderableObject.call(this,t,!1,!0),this.setTextures(n),this._model=e,this._position=s,this._color=a,this._size=o,this._scaleMode=_getScaleModeInt(r),this._rotationMatrix=i.rotation2(Math.radians(l||0)),this._clipCoordinates=c||I.slice(),this._clipColor=u||[0,0,0,0],this.setUniformValueFunction(p,function(){return this._position}),this.setUniformValueFunction(g,function(){return this._size}),this.setUniformValueFunction(y,function(){return this._scaleMode}),this.setUniformValueFunction(h,function(){return this._color}),this.setUniformValueFunction(E,function(){return this._rotationMatrix}),this.setUniformValueFunction(C,function(){return this._clipCoordinates}),this.setUniformValueFunction(M,function(){return this._clipColor})}var r="viewDirectionProjectionInverse",a="modelMatrix",l="normalMatrix",c="billboardSize",h="color",u="shift",d="farthestZ",p="position",_="direction",g="size",m="startPosition",f="endPosition",S="startDirection",T="endDirection",y="scaleMode",E="rotationMatrix",C="clipCoords",M="clipColor",I=[0,1,0,1],A=[1,1,1,1];return RenderableObject.prototype.init=function(e,t,i,n,s){this._shader=e,this._textures={},this._textureRoles.length=0,this._isRenderedWithDepthMask=void 0===t||t,this._isRenderedWithoutDepthMask=void 0===i||i,this._instancedShader=n||null,this._canBeReused=!1,this._visible=!0,this._castsShadows=void 0===s||s,this._name=null},RenderableObject.prototype.getShader=function(){return this._shader},RenderableObject.prototype.setShader=function(e){this._shader=e},RenderableObject.prototype._updateTextures=function(){var e,t,i;for(this._textureRoles=Object.keys(this._textures),e=0;e<this._textureRoles.length;e++){if(t=this._textureRoles[e],this._textures[t]instanceof s.ManagedTexture)i=s.getUniformName(s.getTextureUniformRawName(t));else{if(!(this._textures[t]instanceof s.ManagedCubemap)){n.showError("Attempting to add a texture of unknown type ("+this._textures[t].constructor.name+") to the GL context.");continue}i=s.getUniformName(s.getCubemapUniformRawName(t))}this._uniformValueFunctions[i]=this._uniformValueFunctions[i]||this._getTextureLocation.bind(this,t)}},RenderableObject.prototype.setTexture=function(e,t){this._textures[e]=t,this._updateTextures()},RenderableObject.prototype.setTextures=function(e){this._textures=e,e&&this._updateTextures()},RenderableObject.prototype.setUniformValueFunction=function(e,t,i){this._uniformValueFunctions[s.getUniformName(e)]=t.bind(i||this)},RenderableObject.prototype._getTextureLocation=function(e,t){return this._textures[e].getLastTextureBindLocation(t)},RenderableObject.prototype.addToContext=function(e){var t,i;for(this._shader&&e.addShader(this._shader),this._instancedShader&&e.addShader(this._instancedShader),i=0;i<this._textureRoles.length;i++)t=this._textureRoles[i],e.addTexture(this._textures[t])},RenderableObject.prototype.bindTextures=function(e){var t,i;for(i=0;i<this._textureRoles.length;i++)t=this._textureRoles[i],e.bindTexture(this._textures[t])},RenderableObject.prototype.markAsReusable=function(e){this._canBeReused=!0,this._node&&this._node.handleObjectBecameReusable(e)},RenderableObject.prototype.canBeReused=function(){return this._canBeReused},RenderableObject.prototype.isVisible=function(){return this._visible&&(!this._node||this._node.isVisible())},RenderableObject.prototype.getRenderQueueBits=function(){return this._visible?1:0},RenderableObject.prototype.prepareForInstancedRender=function(e,t,i,n){e.setCurrentShader(this._instancedShader)&&t.assignUniforms(e,this._instancedShader),e.getCurrentShader()===this._instancedShader&&(this.bindTextures(e),this._instancedShader.assignUniforms(e,this._uniformValueFunctions),this._instancedShader.createInstanceBuffers(i,n))},RenderableObject.prototype.mightBeRendered=function(){return!0!==this._canBeReused&&this._visible},RenderableObject.prototype.shouldBeRendered=function(e){return e.depthMask&&this._isRenderedWithDepthMask||!e.depthMask&&this._isRenderedWithoutDepthMask},RenderableObject.prototype.prepareForRender=function(e){e.useInstancing&&e.context.getCurrentShader()===this._instancedShader?this._instancedShader.addDataToInstanceBuffers(e.instanceQueueIndex,this._uniformValueFunctions):(e.context.setCurrentShader(this._shader)&&e.scene.assignUniforms(e.context,this._shader),e.context.getCurrentShader()===this._shader&&(this.bindTextures(e.context),this._shader.assignUniforms(e.context,this._uniformValueFunctions)))},RenderableObject.prototype.performRender=function(){return!0},RenderableObject.prototype.render=function(e){return!!this.shouldBeRendered(e)&&(this.prepareForRender(e),e.useInstancing||this.performRender(e),!0)},RenderableObject.prototype.renderInstances=function(e,t,i){this._instancedShader.bindAndFillInstanceBuffers(e,t),this._peformRenderInstances(e,i)},RenderableObject.prototype.mightBeRenderedToShadowMap=function(){return!this._canBeReused&&this._visible&&this._castsShadows},RenderableObject.prototype.shouldBeRenderedToShadowMap=function(){return!0},RenderableObject.prototype.wasRenderedToShadowMap=function(){return this._wasRenderedToShadowMap},RenderableObject.prototype.prepareForRenderToShadowMap=function(){return!0},RenderableObject.prototype.performRenderToShadowMap=function(){return!0},RenderableObject.prototype.renderToShadowMap=function(e){return this.shouldBeRenderedToShadowMap(e)?(this.prepareForRenderToShadowMap(e),this.performRenderToShadowMap(e),this._wasRenderedToShadowMap=!0,!0):(this._wasRenderedToShadowMap=!1,!1)},RenderableObject.prototype.shouldAnimate=function(e){return e>0},RenderableObject.prototype.performAnimate=function(){return!0},RenderableObject.prototype.animate=function(e){this.shouldAnimate(e)&&this.performAnimate(e)},RenderableObject.prototype.shouldGoInSameRenderQueue=function(e){return this._shader===e.getShader()},RenderableObject.prototype.shouldGoInSameRenderQueueInstanced=function(e){return this.constructor===e.constructor&&this._shader===e._shader},RenderableObject3D.prototype=new RenderableObject,o.makeObject3DMixinClass.call(RenderableObject3D),RenderableObject3D.prototype.constructor=RenderableObject,RenderableObject3D.prototype.init=function(e,t,i,n,s,r,a,l,c,h){RenderableObject.prototype.init.call(this,e,t,i,a),o.Object3D.prototype.init.call(this,n,s,r,l,c,h),this._visibleSize={width:-1,height:-1},this._smallestSizeWhenDrawn=0},RenderableObject3D.prototype.updateVisibleSize=function(e,t){return this._visibleSizeUpdated||(this._visibleSize=this.getSizeInsideViewFrustum(e.camera)),this._visibleSizeUpdated=t,this._visibleSize},RenderableObject3D.prototype.getSizeInPixels=function(e){return Math.max(this._visibleSize.width*e.viewportWidth/2,this._visibleSize.height*e.viewportHeight/2)},RenderableObject3D.prototype.resetForNewFrame=function(){RenderableObject3D.prototype.resetCachedValues.call(this)},RenderableObject3D.prototype.getRenderQueueBits=function(e,t){var i,n,s=0;return this.isInsideParent()?t:(i=this.getPositionMatrixInCameraSpace(e),this.getCascadeScalingMatrix(),n=this.getSize()*this._largestScalingFactor,i[14]-n<=-e._near&&i[14]+n>-e._viewDistance&&(s|=1),i[14]-n<=-e._viewDistance&&i[14]+n>-e.getExtendedCamera()._viewDistance&&(s|=2),s)},RenderableObject3D.prototype.shouldBeRendered=function(e){var t,i;return RenderableObject.prototype.shouldBeRendered.call(this,e)?!0===this.isInsideParent()?(t=e.parent._visibleSize,t.width>0?(i=Math.max(this.getSize()/e.parent.getSize(),e.lodContext.minimumRelativeSize),this._visibleSize.width=t.width*i,this._visibleSize.height=t.height*i,this.getSizeInPixels(e)>=this._smallestSizeWhenDrawn):(this._visibleSize.width=0,this._visibleSize.height=0,!1)):(t=this.updateVisibleSize(e,!1),t.width>0&&this.getSizeInPixels(e)>=this._smallestSizeWhenDrawn):(this._visibleSize.width=0,this._visibleSize.height=0,!1)},RenderableObject3D.prototype.shouldBeRenderedToShadowMap=function(e){return!0===this.isInsideParent()?e.parent.wasRenderedToShadowMap():this.isInsideShadowRegion(e.light)},ContainerObject.prototype=new RenderableObject3D,ContainerObject.prototype.constructor=ContainerObject,ContainerObject.prototype.shouldBeRendered=function(e){return this._visibleSize=e.parent._visibleSize,!1},CubemapSampledFVQ.prototype=new RenderableObject,CubemapSampledFVQ.prototype.constructor=CubemapSampledFVQ,CubemapSampledFVQ.prototype.addToContext=function(e){RenderableObject.prototype.addToContext.call(this,e),this._model.addToContext(e,!1)},CubemapSampledFVQ.prototype.performRender=function(e){this._model.render(e.context,!1)},ShadedLODMesh.prototype=new RenderableObject3D,ShadedLODMesh.prototype.constructor=ShadedLODMesh,ShadedLODMesh.prototype.LOD_NOT_SET=-1,ShadedLODMesh.prototype.init=function(e,t,i,n,s,o,r,a,l){RenderableObject3D.prototype.init.call(this,t,!0,!0,n,s,o),this._smallestSizeWhenDrawn=l||5,this.setTextures(i),this._model=e,this._wireframe=!0===r,this._wireframe&&(this._isRenderedWithDepthMask=!1),this._currentLOD=this.LOD_NOT_SET,this._lastLOD=this.LOD_NOT_SET,this._modelSize=0,this._lodSizeFactors={},this._staticLOD=void 0!==a?a:this.LOD_NOT_SET;for(var c=this._model._minLOD;c<=this._model.getMaxLOD();c++)this._model.getSize(c)>this._modelSize&&(this._modelSize=this._model.getSize(c))},ShadedLODMesh.prototype.addToContext=function(e){RenderableObject3D.prototype.addToContext.call(this,e),this._model.addToContext(e,this._wireframe)},ShadedLODMesh.prototype.getModel=function(){return this._model},ShadedLODMesh.prototype.getSize=function(){return this._modelSize},ShadedLODMesh.prototype.setModelSize=function(e){this._modelSize=e},ShadedLODMesh.prototype.getLODSize=function(e,t){return void 0===this._lodSizeFactors[t.toString()]&&(this._lodSizeFactors[t.toString()]=Math.log10(t+10)/Math.log10(this.getScaledSize()+10)),e*this._lodSizeFactors[t.toString()]},ShadedLODMesh.prototype.getHeight=function(){return this._model.getHeight()},ShadedLODMesh.prototype.getHeightInMeters=function(){return this._model.getHeightInMeters()},ShadedLODMesh.prototype.getDepthInMeters=function(){return this._model.getDepthInMeters()},ShadedLODMesh.prototype.getMaxY=function(){return this._model.getMaxY()},ShadedLODMesh.prototype.getCurrentLOD=function(e){var t,i,n;if(this._currentLOD===this.LOD_NOT_SET)if(this._staticLOD!==this.LOD_NOT_SET)this._currentLOD=this._model.getClosestAvailableLOD(this._staticLOD);else{if(!e)return this.LOD_NOT_SET;if(this.updateVisibleSize(e,!0),t=this.getSizeInPixels(e),(i=e.lodContext.compensateForObjectSize?this.getLODSize(t,e.lodContext.referenceSize):t)>0)for(n=Math.min(this._model.getMaxLOD(),e.lodContext.maxEnabledLOD);n>=this._model._minLOD;n--)if(e.lodContext.thresholds[n]<=i){this._currentLOD=n;break}}return this._currentLOD!==this.LOD_NOT_SET?(this._lastLOD=this._currentLOD,this._currentLOD):this._lastLOD!==this.LOD_NOT_SET?this._lastLOD:0},ShadedLODMesh.prototype.setStaticLOD=function(e){this._staticLOD=e,this._currentLOD=this.LOD_NOT_SET,this._lastLOD=this.LOD_NOT_SET},ShadedLODMesh.prototype.resetForNewFrame=function(){RenderableObject3D.prototype.resetForNewFrame.call(this),this._staticLOD===this.LOD_NOT_SET&&(this._currentLOD=this.LOD_NOT_SET)},ShadedLODMesh.prototype.shouldBeRendered=function(e){if(RenderableObject3D.prototype.shouldBeRendered.call(this,e)){if(!0===this._wireframe)return!0;if(!0===e.depthMask){if(this._model.getNumOpaqueTriangles(this.getCurrentLOD(e))>0)return!0}else if(!1===e.depthMask&&this._model.getNumTransparentTriangles(this.getCurrentLOD(e))>0)return!0;return!1}return!1},ShadedLODMesh.prototype.performRender=function(e){this._model.render(e.context,this._wireframe,e.depthMask,this.getCurrentLOD(e))},ShadedLODMesh.prototype.shouldBeRenderedToShadowMap=function(e){if(RenderableObject3D.prototype.shouldBeRenderedToShadowMap.call(this,e))return this._model.getNumOpaqueTriangles(this.getCurrentLOD(e))>0},ShadedLODMesh.prototype.prepareForRenderToShadowMap=function(e){e.context.getCurrentShader().assignUniforms(e.context,this._uniformValueFunctions)},ShadedLODMesh.prototype.performRenderToShadowMap=function(e){this._model.render(e.context,this._wireframe,!0,this.getCurrentLOD(e))},ParameterizedMesh.prototype=new ShadedLODMesh,ParameterizedMesh.prototype.constructor=ParameterizedMesh,ParameterizedMesh.prototype.init=function(e,t,i,o,r,a,l,c,h,u,d){var p,_,g,m;for(ShadedLODMesh.prototype.init.call(this,e,t,i,o,r,a,l,c,h),this._parameterArrays={},m=Object.keys(u),p=0;p<m.length;p++)if(_=s.getUniformName(m[p]),(g=t.getUniformArrayLength(_))>0){if(d)this._parameterArrays[m[p]]=d._parameterArrays[m[p]];else{switch(u[m[p]]){case s.ShaderVariableType.FLOAT:break;case s.ShaderVariableType.MAT4:g*=16;break;default:n.showError("Cannot create uniform parameter array with elements of type: '"+u[m[p]]+"'!")}this._parameterArrays[m[p]]=new Float32Array(g),this._parameterArrays[m[p]].fill(0)}this.setUniformValueFunction(m[p],this.createGetParameterArrayFunction(this._parameterArrays[m[p]]))}else this._parameterArrays[m[p]]=new Float32Array},ParameterizedMesh.prototype.createGetParameterArrayFunction=function(e){return function(){return e}},ParameterizedMesh.prototype.hasParameterArray=function(e){return!!this._parameterArrays[e]&&this._parameterArrays[e].length>0},ParameterizedMesh.prototype.setFloatParameter=function(e,t,i){this._parameterArrays[e][t]=i},ParameterizedMesh.prototype.setMat4Parameter=function(e,t,i){this._parameterArrays[e].set(i,16*t)},ParameterizedMesh.prototype.setParameterArray=function(e,t){this._parameterArrays[e].set(t,0)},Billboard.prototype=new RenderableObject3D,Billboard.prototype.constructor=Billboard,Billboard.prototype.init=function(e,n,s,o,r,a,l,c){RenderableObject3D.prototype.init.call(this,n,!1,!0,a,l,i.scaling4Aux(o),c),this.setTextures(s),t.setRowB43(this._renderDirection,this.oM),this._renderDirection[3]=1,this._renderPosition[3]=o,this._model=e,this._wireframe=!0===r,this._wireframe&&(this._isRenderedWithDepthMask=!1)},Billboard.prototype.getModel=function(){return this._model},Billboard.prototype.getCurrentLOD=function(){return 0},Billboard.prototype.updateDirection=function(){t.setRowB43(this._renderDirection,this.oM)},Billboard.prototype.setDirectionW=function(e){this._renderDirection[3]=e},Billboard.prototype.addToContext=function(e){RenderableObject3D.prototype.addToContext.call(this,e),this._model.addToContext(e,this._wireframe)},Billboard.prototype.performRender=function(e){this._model.render(e.context,this._wireframe)},Billboard.prototype._peformRenderInstances=function(e,t){this._model.renderInstances(e,this._wireframe,void 0,void 0,t)},Billboard.prototype.mightBeRenderedToShadowMap=function(){return!1},Billboard.prototype.shouldGoInSameRenderQueueInstanced=function(e){return RenderableObject3D.prototype.shouldGoInSameRenderQueueInstanced.call(this,e)&&this._textures===e._textures&&this._model===e._model},Trail.prototype=new RenderableObject3D,Trail.prototype.constructor=Trail,Trail.prototype.init=function(e){RenderableObject3D.prototype.init.call(this,null,!1,!1,null,null,null,null,e,!0,!0),this._detached=!1},Trail.prototype.detach=function(){this._detached=!0},Trail.prototype.performAnimate=function(){this._detached&&0===this._node._subnodes._length&&this.markAsReusable(!0)},Trail.prototype.translatev=function(e){var t;for(o.Object3D.prototype.translatev.call(this,e),t=this._node._subnodes._first;t;t=t.next)t._renderableObject.translatev(e)},TrailSegment.prototype=new RenderableObject3D,TrailSegment.prototype.constructor=TrailSegment,TrailSegment.prototype.init=function(e,n,s,o,r,a,l,c,h,u,d,p,_,g){RenderableObject3D.prototype.init.call(this,n,!1,!0,i.translation4vAux(a),i.IDENTITY4,i.scaling4Aux(o),g),this.setTextures(s),t.setVector3(this._startPosition,a),t.setVector3(this._endPosition,c),t.setVector3(this._startDirection,l),t.setVector3(this._endDirection,h),t.setVector4(this._color,u),this._duration=d,this._startTimeLeft=p,this._endTimeLeft=_,this._sizeVector[0]=o,this._model=e,this._wireframe=!0===r,this._wireframe&&(this._isRenderedWithDepthMask=!1)},TrailSegment.prototype.shouldBeRendered=function(e){return RenderableObject.prototype.shouldBeRendered.call(this,e)},TrailSegment.prototype.translatev=function(e){t.add3(this._startPosition,e),t.add3(this._endPosition,e)},TrailSegment.prototype.getModel=function(){return this._model},TrailSegment.prototype.getCurrentLOD=function(){return 0},TrailSegment.prototype.getEndDirection=function(){return this._endDirection},TrailSegment.prototype.getEndTimeLeft=function(){return this._endTimeLeft},TrailSegment.prototype.addToContext=function(e){RenderableObject3D.prototype.addToContext.call(this,e),this._model.addToContext(e,this._wireframe)},TrailSegment.prototype.performAnimate=function(e){var i;if(this._startTimeLeft-=e,this._endTimeLeft-=e,this._endTimeLeft<=0)return this._startTimeLeft=0,this._endTimeLeft=0,void this.markAsReusable(!0);this._startTimeLeft<0&&(t.setDiff3(this._direction,this._endPosition,this._startPosition),i=t.extractLength3(this._direction),t.add3(this._startPosition,t.scaled3Aux(this._direction,i*(1-this._endTimeLeft/(this._endTimeLeft-this._startTimeLeft)))),this._startTimeLeft=0),this._sizeVector[1]=this._startTimeLeft/this._duration,this._sizeVector[2]=this._endTimeLeft/this._duration},TrailSegment.prototype.performRender=function(e){this._model.render(e.context,this._wireframe)},TrailSegment.prototype._peformRenderInstances=function(e,t){this._model.renderInstances(e,this._wireframe,void 0,void 0,t)},TrailSegment.prototype.mightBeRenderedToShadowMap=function(){return!1},TrailSegment.prototype.shouldGoInSameRenderQueueInstanced=function(e){return RenderableObject3D.prototype.shouldGoInSameRenderQueueInstanced.call(this,e)&&this._textures===e._textures&&this._model===e._model},Particle.prototype=new RenderableObject3D,Particle.prototype.constructor=Particle,Particle.prototype.init=function(t,n,s,o,r,a,l,c){RenderableObject3D.prototype.init.call(this,n,!1,!0,o,i.IDENTITY4,i.IDENTITY4,l),this.setTextures(s),this._model=t,r?(this._color[0]=r[0].color[0],this._color[1]=r[0].color[1],this._color[2]=r[0].color[2],this._color[3]=r[0].color[3],this._states=r):this._states=e.EMPTY_ARRAY,this._size=void 0!==c?c:r?r[0].size:0,this._relativeSize=1,this._calculateSize(),this._calculateDuration(),this._currentStateIndex=0,this._looping=!0===a,this._timeSinceLastTransition=0,this._velocityVector[0]=0,this._velocityVector[1]=0,this._velocityVector[2]=0,this._worldVelocityDirectionVector[0]=0,this._worldVelocityDirectionVector[1]=0,this._worldVelocityDirectionVector[2]=0,this._worldVelocityDirectionVectorValid=!1,this._shouldAnimate=!1,this._updateShouldAnimate()},Particle.prototype._calculateDuration=function(){var e;for(this._duration=0,e=1;e<this._states.length;e++)this._duration+=this._states[e].timeToReach},Particle.prototype._calculateSize=function(){this._positionVector[3]=this._size*this._relativeSize,this._visible=this._positionVector[3]>=.01},Particle.prototype.getSize=function(){return this._positionVector[3]},Particle.prototype.getFinalSize=function(){return 0===this._states.length?this._size:this._states[this._states.length-1].size},Particle.prototype.getMaxSize=function(){var e,t;if(0===this._states.length)return this._size;for(e=0,t=0;t<this._states.length;t++)this._states[t].size>e&&(e=this._states[t].size);return e},Particle.prototype._hasVelocity=function(){return this._velocityVector&&(0!==this._velocityVector[0]||0!==this._velocityVector[1]||0!==this._velocityVector[2])},Particle.prototype.rotateByMatrix=function(e){this._velocityVector?(t.mulVec3Mat4(this._velocityVector,e),this._updateVelocity()):RenderableObject3D.prototype.rotateByMatrix.call(this,e)},Particle.prototype._updateShouldAnimate=function(){this._shouldAnimate=this._states.length>1||this._hasVelocity()},Particle.prototype._updateVelocity=function(){this._worldVelocityDirectionVectorValid=!1,this._updateShouldAnimate()},Particle.prototype.setRelativeSize=function(e){this._relativeSize=e,this._calculateSize()},Particle.prototype.setVelocityVector=function(e){this._velocityVector=e,this._updateVelocity()},Particle.prototype.setVelocity=function(e,t,i){this._velocityVector[0]=e,this._velocityVector[1]=t,this._velocityVector[2]=i,this._updateVelocity()},Particle.prototype.setVelocityM=function(e){this._velocityVector[0]=e[12],this._velocityVector[1]=e[13],this._velocityVector[2]=e[14],this._updateVelocity()},Particle.prototype.getWorldVelocityDirectionVector=function(){return this._worldVelocityDirectionVectorValid||(t.setProdVec3Mat4(this._worldVelocityDirectionVector,this._velocityVector,this.getModelMatrix()),t.normalize3(this._worldVelocityDirectionVector),this._worldVelocityDirectionVectorValid=!0),this._worldVelocityDirectionVector},Particle.prototype.invalidateWorldVelocityDirectionVector=function(){this._worldVelocityDirectionVectorValid=!1},Particle.prototype.setAnimationTime=function(e){this._currentStateIndex=0,this._timeSinceLastTransition=0,this.performAnimate(e)},Particle.prototype.addToContext=function(e){RenderableObject3D.prototype.addToContext.call(this,e),this._model.addToContext(e,!1)},Particle.prototype.getRenderQueueBits=function(e,t){return this._visible?RenderableObject3D.prototype.getRenderQueueBits.call(this,e,t):0},Particle.prototype.performRender=function(e){this._model.render(e.context,!1)},Particle.prototype._peformRenderInstances=function(e,t){this._model.renderInstances(e,!1,void 0,void 0,t)},Particle.prototype.mightBeRenderedToShadowMap=function(){return!1},Particle.prototype.shouldAnimate=function(e){return!!RenderableObject3D.prototype.shouldAnimate.call(this,e)&&this._shouldAnimate},Particle.prototype.performAnimate=function(e){var i,n,s;if(this._states.length>1){for(this._timeSinceLastTransition+=e,i=(this._currentStateIndex+1)%this._states.length;this._timeSinceLastTransition>this._states[i].timeToReach;){if(0===i&&!this._looping)return this._size=0,void this.markAsReusable(!0);this._timeSinceLastTransition-=this._states[i].timeToReach,i=(i+1)%this._states.length}for(this._currentStateIndex=0===i?this._states.length-1:i-1,n=this._timeSinceLastTransition/this._states[i].timeToReach,s=0;s<4;s++)this._color[s]=this._states[this._currentStateIndex].color[s]*(1-n)+this._states[i].color[s]*n
;this._size=this._states[this._currentStateIndex].size*(1-n)+this._states[i].size*n,this._calculateSize()}this._hasVelocity()&&this.translatev(t.scaled3Aux(this._velocityVector,.001*e))},Particle.prototype.shouldGoInSameRenderQueueInstanced=function(e){return RenderableObject3D.prototype.shouldGoInSameRenderQueueInstanced.call(this,e)&&this._textures===e._textures&&this._model===e._model},BackgroundBillboard.prototype=new Particle,BackgroundBillboard.prototype.constructor=BackgroundBillboard,BackgroundBillboard.prototype._calculateSize=function(){return!0},BackgroundBillboard.prototype.shouldBeRendered=function(e){return RenderableObject.prototype.shouldBeRendered.call(this,e)},PointParticle.prototype=new RenderableObject,PointParticle.prototype.constructor=PointParticle,PointParticle.prototype.addToContext=function(e){this._color&&(RenderableObject.prototype.addToContext.call(this,e),this._model.addToContext(e,!0))},PointParticle.prototype.setShift=function(e,t,i){this._shift[0]=e,this._shift[1]=t,this._shift[2]=i},PointParticle.prototype.fitPositionWithinRange=function(e,t){var i;for(i=0;i<3;i++){for(;this._positionVector[i]>e[12+i]+t;)this._positionVector[i]-=2*t;for(;this._positionVector[i]<e[12+i]-t;)this._positionVector[i]+=2*t}},PointParticle.prototype.performRender=function(e){this._model.render(e.context,!0)},PointParticle.prototype._peformRenderInstances=function(e,t){this._model.renderInstances(e,!0,!1,void 0,t)},PointParticle.prototype.mightBeRenderedToShadowMap=function(){return!1},PointParticle.prototype.shouldAnimate=function(){return!1},PointParticle.prototype.shouldGoInSameRenderQueueInstanced=function(e){return RenderableObject.prototype.shouldGoInSameRenderQueueInstanced.call(this,e)&&this._color===e._color&&this._range===e._range},UIElement.prototype=new RenderableObject,UIElement.prototype.constructor=UIElement,UIElement.prototype.init=function(e,t,n,s,o,r,a,l,c,h){RenderableObject.prototype.init.call(this,t,!1,!0),this.setTextures(n),this._model=e,this._position=s,this._color=a,this._size=o,this._scaleMode=_getScaleModeInt(r),i.setRotation2(this._rotationMatrix,Math.radians(l||0)),this._clipCoordinates=c||I.slice(),this._clipColor=h||[0,0,0,0]},UIElement.prototype.addToContext=function(e){RenderableObject.prototype.addToContext.call(this,e),this._model.addToContext(e,!1)},UIElement.prototype.performRender=function(e){this._model.render(e.context)},UIElement.prototype.setPosition=function(e){this._position=e},UIElement.prototype.setSize=function(e){this._size=e},UIElement.prototype.setColor=function(e){this._color=e},UIElement.prototype.setAngle=function(e){i.setRotation2(this._rotationMatrix,e)},UIElement.prototype.setClipCoordinates=function(e){this._clipCoordinates=e},UIElement.prototype.clipX=function(e,t){this._clipCoordinates[0]=e,this._clipCoordinates[1]=t},UIElement.prototype.clipY=function(e,t){this._clipCoordinates[2]=1-t,this._clipCoordinates[3]=1-e},UIElement.prototype.setClipColor=function(e){this._clipColor=e},UIElement.prototype.setModel=function(e){this._model=e},UIElement.prototype.setScaleMode=function(e){this._scaleMode=_getScaleModeInt(e)},{RENDER_QUEUE_FRONT_BIT:1,RENDER_QUEUE_DISTANCE_BIT:2,UNIFORM_COLOR_NAME:h,CLIP_COORDINATES_NO_CLIP:I,RenderableObject:RenderableObject,RenderableObject3D:RenderableObject3D,ContainerObject:ContainerObject,CubemapSampledFVQ:CubemapSampledFVQ,ShadedLODMesh:ShadedLODMesh,ParameterizedMesh:ParameterizedMesh,Billboard:Billboard,Trail:Trail,TrailSegment:TrailSegment,ParticleState:ParticleState,Particle:Particle,staticParticle:staticParticle,initDynamicParticle:initDynamicParticle,dynamicParticle:dynamicParticle,BackgroundBillboard:BackgroundBillboard,PointParticle:PointParticle,UIElement:UIElement}}),define("modules/containers",[],function(){"use strict";function DirectDoubleLinkedList(){this._first=null,this._last=null,this._length=0}return DirectDoubleLinkedList.prototype.add=function(e){this._first?(this._last.next=e,e.previous=this._last):(this._first=e,e.previous=null),e.next=null,e.list=this,this._last=e,this._length++},DirectDoubleLinkedList.prototype.remove=function(e){e.list===this&&(e.previous?e.previous.next=e.next:this._first=e.next,e.next?e.next.previous=e.previous:this._last=e.previous,e.list=null,this._length--)},DirectDoubleLinkedList.prototype.clear=function(e){var t;if(e)for(t=this._first;t;t=t.next)t.list=null;this._first=null,this._last=null,this._length=0},DirectDoubleLinkedList.prototype.getNext=function(e){return e&&e.list===this?e.next||this._first:this._first},DirectDoubleLinkedList.prototype.getPrevious=function(e){return e&&e.list===this?e.previous||this._last:this._last},DirectDoubleLinkedList.prototype.appendToArray=function(e){var t,i;for(i=e.length,e.length=i+this._length,t=this._first;t;t=t.next,i++)e[i]=t},{DirectDoubleLinkedList:DirectDoubleLinkedList}}),define("modules/scene/scene-graph",["utils/utils","utils/types","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/egom-model","modules/containers","modules/scene/camera","modules/scene/renderable-objects"],function(e,t,i,n,s,o,r,a,l,c){"use strict";function getDebugInfo(){return S}function LODContext(e,t,i,n,s){this.maxEnabledLOD=e,this.thresholds=t,this.compensateForObjectSize=!0===i,this.referenceSize=n||d,this.minimumRelativeSize=s||p}function RenderParameters(e,t,i,n,s,o,r,a,l,c,h,u){this.context=e,this.depthMask=t,this.scene=i,this.parent=n,this.camera=s,this.viewportWidth=o,this.viewportHeight=r,this.lodContext=a,this.dt=l||0,this.useInstancing=c||!1,this.instanceQueueIndex=h,this.light=u}function RenderableNode(e,t,i,n){this._renderableObject=e,e._node=this,this._scene=null,this._parent=null,this._subnodes=new a.DirectDoubleLinkedList,this._visible=!0,this._renderParameters=new RenderParameters,this._cameraConfigurations=null,this._isRenderedToShadowMap=!1!==t,this._hasInstancedSubnodes=i,this._instancing=!!n,this._canBeReused=!1,this.next=null,this.previous=null,this.list=null}function Scene(e,t,i,s,r,a,c,h,u,d,p,_,g,S){this._left=e,this._bottom=t,this._width=i,this._height=s,this._shouldClearColorOnRender=r,this._clearColorMask=a,this._clearColor=c,this._shouldClearDepthOnRender=h,this._rootBackgroundNode=null,this._rootNode=null,this._rootUINode=null,this._objectsToMove=null,this._ambientColor=[0,0,0],this._directionalLights=[],this._maxRenderedDirectionalLights=d||0,this._renderedDirectionalLights=0,this._directionalLightUniformData=new Array(this._maxRenderedDirectionalLights),this._pointLightPriorityArrays=null,this._maxRenderedPointLights=p||0,this._renderedPointLights=0,this._pointLightUniformData=new Array(this._maxRenderedPointLights),this._spotLights=[],this._maxRenderedSpotLights=_||0,this._renderedSpotLights=0,this._spotLightUniformData=new Array(this._maxRenderedSpotLights),this._rootResourceNode=null,this._resourceObjectIDs=null,this._camera=new l.Camera(this,this._width/this._height,g.useVerticalValues,g.viewDistance,g.configuration||l.getFreeCameraConfiguration(g.fps,g.positionMatrix||n.IDENTITY4,g.orientationMatrix||n.IDENTITY4,g.fov,g.fovRange&&g.fovRange[0]||g.fov,g.fovRange&&g.fovRange[1]||g.fov,g.span),g.transitionDuration,g.transitionStyle),this._lodContext=u,this._shadowMappingEnabled=!1,this._shadowMappingShader=null,this._shadowMapTextureSize=0,this._shadowMapRanges=new Float32Array([]),this._shadowMapDepthRatio=0,this._numShadowMapSamples=0,this._shadowMapSampleOffsets=[],this._uniformValueFunctions={},this._cameraUniformValueFunctions={},this._constantUniformValueFunctions={},this._stereoscopicUniformValueFunctions={},this._stereoscopicTextureUnit=0,this._stereoscopicUniformValueFunctions[o.getUniformName(o.getTextureUniformRawName(m))]=function(){return this._stereoscopicTextureUnit}.bind(this),this._shadowMapDebugUniformValueFunctions={},this._shadowMapTextureUnit=0,this._shadowMapDebugUniformValueFunctions[o.getUniformName(f)]=function(){return this._shadowMapTextureUnit}.bind(this),this._contextUniformValueFunctions=[],this._contextConstantUniformValueFunctions=[],this._shouldAnimate=!0,this._shouldUpdateCamera=!0,this._contexts=[],this._distanceRendering=void 0===S||S,this._renderQueues=this._distanceRendering?[[],[],[],[]]:[[],[]],this._shadowQueue=null,this._uniformsUpdatedForFrame=!1,this._uniformsUpdated=new Set,this._cameraUniformsUpdated=new Set,this._constantUniformsUpdated=new Set,this._nodeCount=0,this._nodeCountByType=null,this._mainDebugStats=null,this._shadowMapDebugStats=null,this._stereoscopicMode=Scene.StereoscopicMode.NONE,this._redShader=null,this._cyanShader=null,this._stereoscopicFrameBuffer=null,this._leftShader=null,this._rightShader=null,this._sideBySideOriginalAspect=!1,this._shadowMapDebugging=!1,this._shadowMapDebugLightIndex=0,this._shadowMapDebugRangeIndex=0,this._shadowMapDebugShader=null,this._initNodes(),this.clearPointLights(),this._setGeneralUniformValueFunctions()}var h=c.RENDER_QUEUE_FRONT_BIT,u=c.RENDER_QUEUE_DISTANCE_BIT,d=100,p=.05,_=[0,0,1,0,0,1,-1,0,0,-1,1,1,1,-1,-1,1,-1,-1],g=[!0,!0,!0,!0],m="stereo",f="shadowMapDebug",S="";return RenderableNode.prototype.canBeReused=function(){var e;if(this._canBeReused)return!0;if(this._renderableObject.canBeReused()){for(e=this._subnodes._first;e;e=e.next)if(!1===e.canBeReused())return!1;return this._canBeReused=!0,!0}return!1},RenderableNode.prototype.getScene=function(){return this._scene},RenderableNode.prototype.setScene=function(e,t){var i;for(this._scene=e,e&&t&&e.addObjectToContexts(this._renderableObject),i=this._subnodes._first;i;i=i.next)i.setScene(e,t)},RenderableNode.prototype.addToRenderQueue=function(e){var t;if(this._instancing){for(t=0;t<e.length;t++)if(e[t].length>0&&e[t][0]._instancing&&this._renderableObject.shouldGoInSameRenderQueueInstanced(e[t][0]._renderableObject))return e[t].push(this),t}else for(t=0;t<e.length;t++)if(e[t].length>0&&!e[t][0]._instancing&&this._renderableObject.shouldGoInSameRenderQueue(e[t][0]._renderableObject))return e[t].push(this),t;return e.push([this]),e.length-1},RenderableNode.prototype.animateAndAddToRenderQueues=function(e,t,i,n,s){var o,r,a,l,c,d,p;if(this._visible&&(this._renderableObject.resetForNewFrame&&this._renderableObject.resetForNewFrame(),this._scene.shouldAnimate()&&this._renderableObject.animate(n),!this._renderableObject.canBeReused()&&(c=this._renderableObject._isRenderedWithoutDepthMask,d=this._renderableObject._isRenderedWithDepthMask,(c||d)&&(t?(o=this._renderableObject.getRenderQueueBits(i,s),o&h&&(c&&this.addToRenderQueue(e[1]),d&&this.addToRenderQueue(e[0])),o&u&&(c&&this.addToRenderQueue(e[3]),d&&this.addToRenderQueue(e[2]))):(c&&this.addToRenderQueue(e[1]),d&&this.addToRenderQueue(e[0]))),this._subnodes._length>0)))if(void 0===o&&(o=t?this._renderableObject.getRenderQueueBits(i,s):h),this._hasInstancedSubnodes&&this._subnodes._first._instancing){if(this._scene.shouldAnimate())for(r=this._subnodes._first;r;r=a)a=r.next,p=r._renderableObject,p.animate(n),p.resetForNewFrame&&p.resetForNewFrame();else for(r=this._subnodes._first;r;r=a)a=r.next,p=r._renderableObject,p.resetForNewFrame&&p.resetForNewFrame();r=this._subnodes._first,r&&(c=r._renderableObject._isRenderedWithoutDepthMask,d=r._renderableObject._isRenderedWithDepthMask,(c||d)&&(o=r._renderableObject.getRenderQueueBits(i,o),o&h&&(c&&(l=r.addToRenderQueue(e[1]),e[1][l].pop(),this._subnodes.appendToArray(e[1][l])),d&&(l=r.addToRenderQueue(e[0]),e[0][l].pop(),this._subnodes.appendToArray(e[0][l]))),o&u&&(c&&(l=r.addToRenderQueue(e[3]),e[3][l].pop(),this._subnodes.appendToArray(e[3][l])),d&&(l=r.addToRenderQueue(e[2]),e[2][l].pop(),this._subnodes.appendToArray(e[2][l])))))}else for(r=this._subnodes._first;r;r=a)a=r.next,r.animateAndAddToRenderQueues(e,t,i,n,o)},RenderableNode.prototype.setParent=function(e){this._parent=e,this.setScene(e.getScene()),this._renderableObject.setParent&&this._renderableObject.setParent(e._renderableObject)},RenderableNode.prototype.isVisible=function(){return this._visible&&(!this._parent||this._parent.isVisible())},RenderableNode.prototype.show=function(){this._visible=!0},RenderableNode.prototype.hide=function(){this._visible=!1},RenderableNode.prototype.toggleVisibility=function(){this._visible=!this._visible},RenderableNode.prototype.addSubnode=function(e,t){return this._subnodes.add(e),e.setParent(this),this._scene&&e.setScene(this._scene,t),e},RenderableNode.prototype.getFirstSubnode=function(){return this._subnodes._first},RenderableNode.prototype.getNextSubnode=function(e){return this._subnodes.getNext(e)},RenderableNode.prototype.getPreviousSubnode=function(e){return this._subnodes.getPrevious(e)},RenderableNode.prototype.addCameraConfiguration=function(e){this._cameraConfigurations||(this._cameraConfigurations=[]),this._cameraConfigurations.push(e)},RenderableNode.prototype.hasCameraConfiguration=function(e){var t;if(!this._cameraConfigurations)return!1;for(t=0;t<this._cameraConfigurations.length;t++)if(this._cameraConfigurations[t]===e)return!0;return!1},RenderableNode.prototype.getNextCameraConfiguration=function(e){var t,i,n;if(!this._cameraConfigurations)return null;if((n=this._cameraConfigurations.length)<=0)return null;if(e){for(t=0;t<n;t++)if(this._cameraConfigurations[t]===e){i=t;break}if(t>=n)return}else i=-1;for(t=(i+1)%n;t!==i&&this._cameraConfigurations[t].shouldExcludeFromCycle();)t=(t+1)%n;return this._cameraConfigurations[t]},RenderableNode.prototype.getPreviousCameraConfiguration=function(e){var t,i,n;if(!this._cameraConfigurations)return null;if((n=this._cameraConfigurations.length)<=0)return null;if(e){for(t=n-1;t>=0;t--)if(this._cameraConfigurations[t]===e){i=t;break}if(t<0)return}else i=n;for(t=(i+n-1)%n;t!==i&&this._cameraConfigurations[t].shouldExcludeFromCycle();)t=(t+n-1)%n;return this._cameraConfigurations[t]},RenderableNode.prototype.getCameraConfigurationsWithName=function(e){var t,i=[];if(this._cameraConfigurations)for(t=0;t<this._cameraConfigurations.length;t++)this._cameraConfigurations[t]._name===e&&i.push(this._cameraConfigurations[t]);return i},RenderableNode.prototype.resetCameraConfigurations=function(){var e;if(this._cameraConfigurations)for(e=0;e<this._cameraConfigurations.length;e++)this._cameraConfigurations[e].resetToDefaults()},RenderableNode.prototype.log=function(e){var t,i,n="",s=this._renderableObject.constructor.name;for(t=0;t<e;t++)n+=". ";for(n+=s,this._scene.increaseCount(s),i=this._subnodes._first;i;i=i.next)i.log(e+1)},RenderableNode.prototype.setRenderParameters=function(e,t,i,n,s,o,r){var a=this._renderParameters;a.context=e,a.depthMask=n,a.scene=this._scene,a.parent=this._parent?this._parent._renderableObject:null,a.camera=this._scene._camera,a.viewportWidth=t,a.viewportHeight=i,a.lodContext=this._scene._lodContext,a.useInstancing=s,a.instanceQueueIndex=o,a.light=r},RenderableNode.prototype.render=function(e,t,i,n,s,o,r,a){var l,c;if(this._visible){if(!a&&this._renderableObject.resetForNewFrame&&this._renderableObject.resetForNewFrame(),this._renderableObject.mightBeRendered()?(this.setRenderParameters(e,t,i,n,o,r),c=this._renderableObject.render(this._renderParameters)):c=!1,!s)for(l=this._subnodes._first;l;l=l.next)l.render(e,t,i,n,s,o,r,a);return c}return!1},RenderableNode.prototype.prepareForInstancedRender=function(e,t,i){this._renderableObject.prepareForInstancedRender(e,this._scene,t,i)},RenderableNode.prototype.renderInstances=function(e,t,i){this._renderableObject.renderInstances(e,t,i)},RenderableNode.prototype.renderToShadowMap=function(e,t,i,n){var s,o;if(this._visible&&this._isRenderedToShadowMap){for(this._renderableObject.mightBeRenderedToShadowMap()?(this.setRenderParameters(e,t,i,!0,void 0,void 0,n),o=this._renderableObject.renderToShadowMap(this._renderParameters)):o=!1,s=this._subnodes._first;s;s=s.next)s.renderToShadowMap(e,t,i,n);return o}return!1},RenderableNode.prototype.execute=function(e){var t;for(e(this._renderableObject),t=this._subnodes._first;t;t=t.next)t.execute(e)},RenderableNode.prototype.addToContext=function(e){var t;for(this._renderableObject.addToContext(e),t=this._subnodes._first;t;t=t.next)t.addToContext(e)},RenderableNode.prototype.getShader=function(){return this._renderableObject.getShader()},RenderableNode.prototype.setShader=function(e){var t;for(this._renderableObject.setShader(e),t=this._subnodes._first;t;t=t.next)t.setShader(e)},RenderableNode.prototype.markAsReusable=function(e){var t,i;for(this._renderableObject.markAsReusable(e),t=this._subnodes._first;t;t=i)i=t.next,t.markAsReusable(e);this._canBeReused=!0,e&&this._parent&&this._parent.removeSubnode(this,!0)},RenderableNode.prototype.handleObjectBecameReusable=function(e){e&&this._parent&&0===this._subnodes._length&&this._parent.removeSubnode(this,!0)},RenderableNode.prototype.cleanUp=function(){var e,t;for(e=this._subnodes._first;e;)t=e.next,e.canBeReused()&&this._subnodes.remove(e),e=t;for(e=this._subnodes._first;e;e=e.next)e.cleanUp()},RenderableNode.prototype.removeSubnode=function(e,t){this._subnodes.remove(e),t&&0===this._subnodes._length&&this._renderableObject.canBeReused()&&this._parent&&this._parent.removeSubnode(this,!0)},RenderableNode.prototype.removeSubnodes=function(e){this._subnodes.clear(e)},RenderableNode.prototype.destroy=function(){var e,t;if(this._renderableObject._node=null,this._renderableObject=null,this._scene=null,this._parent=null,this._subnodes){for(e=this._subnodes._first;e;e=t)t=e.next,e.destroy(),e=null;this._subnodes=null}this._renderParameters=null,this._cameraConfigurations=null,this.next=null,this.previous=null,this.list=null},Scene.StereoscopicMode={NONE:"none",ANAGLYPH:"anaglyph",SIDE_BY_SIDE:"sideBySide"},Scene.prototype._setGeneralUniformValueFunctions=function(){this.setUniformValueFunction("ambientColor",function(){return this._ambientColor}),this.setUniformValueFunction("numDirLights",function(){return this._renderedDirectionalLights}),this.setUniformValueFunction("dirLights",function(){return this._directionalLightUniformData}),this.setUniformValueFunction("numPointLights",function(){return this._renderedPointLights}),this.setUniformValueFunction("pointLights",function(){return this._pointLightUniformData}),this.setUniformValueFunction("numSpotLights",function(){return this._renderedSpotLights}),this.setUniformValueFunction("spotLights",function(){return this._spotLightUniformData}),this.setCameraUniformValueFunction("cameraMatrix",function(){return this._camera.getViewMatrix()}),this.setCameraUniformValueFunction("cameraOrientationMatrix",function(){return this._camera.getInverseOrientationMatrix()}),this.setCameraUniformValueFunction("aspect",function(){return this._camera._aspect}),this.setCameraUniformValueFunction("projMatrix",function(){return this._camera.getProjectionMatrix()}),this.setCameraUniformValueFunction("viewProjMatrix",function(){return n.prod4Aux(this._camera.getViewMatrix(),this._camera.getProjectionMatrix())}),this.setCameraUniformValueFunction("eyePos",function(){return i.floatVector3Aux(this._camera.getCameraPositionVector())})},Scene.prototype._setContextUniformValueFunctions=function(e){var t=this._contexts[e].gl,i=[0,0];this.setContextUniformValueFunction(e,"viewportSize",function(){return i[0]=t.drawingBufferWidth*this._width,i[1]=t.drawingBufferHeight*this._height,i})},Scene.prototype._setShadowMappedShaderUniformValueFunctions=function(e){var t;if(0===e&&(this.setConstantUniformValueFunction("shadowMapRanges",function(){return this._shadowMapRanges}),this.setConstantUniformValueFunction("shadowMapSampleOffsets",function(){return this._shadowMapSampleOffsets})),void 0!==e)this.setContextConstantUniformValueFunction(e,"shadowMaps",function(){var t,i,n=[];for(t=0;t<this._directionalLights.length&&t<this._maxRenderedDirectionalLights;t++)for(i=0;i<this._shadowMapRanges.length;i++)n.push(this._contexts[e].getFrameBuffer(this._directionalLights[t].getShadowMapBufferName(i)).getLastTextureBindLocation(this._contexts[e]._name));return new Int32Array(n)});else for(t=0;t<this._contexts.length;t++)this._setShadowMappedShaderUniformValueFunctions(t)},Scene.prototype._updateStaticLightUniformData=function(){var e;for(this._renderedDirectionalLights=Math.min(this._directionalLights.length,this._maxRenderedDirectionalLights),e=0;e<this._renderedDirectionalLights;e++)this._directionalLightUniformData[e]=this._directionalLights[e]._uniformData;e<this._maxRenderedDirectionalLights&&(this._directionalLightUniformData[e]=null)},Scene.prototype._clearDynamicLightUniformData=function(){this._renderedPointLights=0,this._pointLightUniformData[0]=null,this._renderedSpotLights=0,this._spotLightUniformData[0]=null},Scene.prototype._updateDynamicLightUniformData=function(e){var t,i,n,s;for(t=0,n=0;t<this._pointLightPriorityArrays.length;t++){for(i=0;i<this._pointLightPriorityArrays[t].length&&n<this._maxRenderedPointLights;i++)this._pointLightPriorityArrays[t][i].isVisible()&&(this._pointLightPriorityArrays[t][i].update(e),this._pointLightPriorityArrays[t][i].shouldBeRendered(this._camera)&&(this._pointLightUniformData[n]=this._pointLightPriorityArrays[t][i]._uniformData,n++));for(;i<this._pointLightPriorityArrays[t].length;)this._pointLightPriorityArrays[t][i].isVisible()&&this._pointLightPriorityArrays[t][i].updateState(e),i++}for(this._renderedPointLights=n,n<this._maxRenderedPointLights&&(this._pointLightUniformData[n]=null),n=0,t=0,s=Math.min(this._spotLights.length,this._maxRenderedSpotLights);t<this._spotLights.length&&n<s;t++)this._spotLights[t].isVisible()&&(this._spotLights[t].update(e),this._spotLights[t].shouldBeRendered(this._camera)&&(this._spotLightUniformData[n]=this._spotLights[t]._uniformData,n++));this._renderedSpotLights=n,n<this._maxRenderedSpotLights&&(this._spotLightUniformData[n]=null)},Scene.prototype._getShadowMapBufferNamePrefix=function(e){return"shadow-map-buffer-"+e+"-"},Scene.prototype._getWidthInPixels=function(e){return e.gl.drawingBufferWidth*this._width},Scene.prototype._getHeightInPixels=function(e){return e.gl.drawingBufferHeight*this._height},Scene.prototype._setupContext=function(e){var t,i;if(this._constantUniformsUpdated.clear(),void 0!==e)for(i=this._contexts[e],this._setContextUniformValueFunctions(e),this._shadowMappingEnabled&&(i.addShader(this._shadowMappingShader),this._setShadowMappedShaderUniformValueFunctions(e)),t=0;t<this._directionalLights.length&&t<this._maxRenderedDirectionalLights;t++)this._directionalLights[t].addToContext(this._contexts[e],this._shadowMappingEnabled,this._getShadowMapBufferNamePrefix(t),this._shadowMapRanges.length,this._shadowMapTextureSize);else for(t=0;t<this._contexts.length;t++)this._setupContext(t)},Scene.prototype.setAnaglyphRendering=function(e){this._stereoscopicMode=Scene.StereoscopicMode.ANAGLYPH,this._redShader=e.redShader,this._cyanShader=e.cyanShader,void 0!==e.interocularDistance&&this._camera.setInterocularDistance(e.interocularDistance),void 0!==e.convergenceDistance&&this._camera.setStereoscopicConvergenceDistance(e.convergenceDistance)},Scene.prototype.setSideBySideRendering=function(e){this._stereoscopicMode=Scene.StereoscopicMode.SIDE_BY_SIDE,this._leftShader=e.leftShader,this._rightShader=e.rightShader,void 0!==e.interocularDistance&&this._camera.setInterocularDistance(e.interocularDistance),void 0!==e.convergenceDistance&&this._camera.setStereoscopicConvergenceDistance(e.convergenceDistance),void 0!==e.originalAspect&&(this._sideBySideOriginalAspect=e.originalAspect)},Scene.prototype.setupShadowMapDebugging=function(e){this._shadowMapDebugging=!0,this._shadowMapDebugShader=e.shader,this._shadowMapDebugLightIndex=e.lightIndex||0,this._shadowMapDebugRangeIndex=e.rangeIndex||0},Scene.prototype.setRelativeViewport=function(e,t,i,n){this._left=e,this._bottom=t,this._width=i,this._height=n},Scene.prototype.addToContext=function(e){var t=this._contexts.findIndex(function(t){return t._name===e._name});t<0&&(this._contexts.push(e),t=this._contexts.length-1),this._setupContext(t),this._rootBackgroundNode.addToContext(e),this._rootNode.addToContext(e),this._rootUINode.addToContext(e),this._rootResourceNode.addToContext(e)},Scene.prototype.enableShadowMapping=function(){this._shadowMappingShader&&this._shadowMapRanges.length>0?(this._shadowMappingEnabled=!0,this._setupContext()):s.showError("Cannot enable shadow mapping, as no shadow mapping shader or no shadow mapping ranges were specified")},Scene.prototype.disableShadowMapping=function(){this._shadowMappingEnabled=!1},Scene.prototype.toggleShadowMapping=function(){this._shadowMappingEnabled=!this._shadowMappingEnabled,this._shadowMappingEnabled?this.enableShadowMapping():this.disableShadowMapping()},Scene.prototype.setShadowMapRanges=function(e){this._shadowMapRanges=new Float32Array(e),this._setupContext()},Scene.prototype.setShadowMapping=function(e){e?(this._shadowMappingEnabled=void 0!==e.enable?e.enable:this._shadowMappingEnabled,this._shadowMappingShader=e.shader||this._shadowMappingShader,this._shadowMapTextureSize=e.textureSize||this._shadowMapTextureSize,this._shadowMapRanges=e.ranges?new Float32Array(e.ranges):this._shadowMapRanges,this._shadowMapDepthRatio=e.depthRatio||this._shadowMapDepthRatio,this._numShadowMapSamples=e.numSamples?t.getNumberValueInRange("shadowMappingParams.numSamples",e.numSamples,this._shadowMappingEnabled?1:0,this._shadowMappingEnabled?_.length/2:0,this._shadowMappingEnabled?1:0):e.numSamples,this._shadowMapSampleOffsets=_.slice(0,2*this._numShadowMapSamples),e.deferSetup||this._setupContext()):(this._shadowMappingEnabled=!1,this._shadowMappingShader=null,this._shadowMapTextureSize=0,this._shadowMapRanges=new Float32Array([]),this._shadowMapDepthRatio=0,this._numShadowMapSamples=0,this._shadowMapSampleOffsets=[]),this._constantUniformsUpdated.clear()},Scene.prototype.shouldAnimate=function(){return this._shouldAnimate},Scene.prototype.setShouldAnimate=function(e){this._shouldAnimate=e},Scene.prototype.setShouldUpdateCamera=function(e){this._shouldUpdateCamera=e},Scene.prototype.addBackgroundObject=function(e){var t=new RenderableNode(e,!1);return this._rootBackgroundNode.addSubnode(t),t},Scene.prototype.addObject=function(e,t,i){var n=e._node||new RenderableNode(e,t,!1,i);return this._rootNode.addSubnode(n),n},Scene.prototype.addNode=function(e){return this._rootNode.addSubnode(e),e},Scene.prototype.addUIObject=function(e){var t=new RenderableNode(e,!1);return this._rootUINode.addSubnode(t),t},Scene.prototype.addObjectToContexts=function(e){var t;for(t=0;t<this._contexts.length;t++)e.addToContext(this._contexts[t])},Scene.prototype.addObjectToMove=function(e){this._objectsToMove.push(e)},Scene.prototype.clear=function(e){this.clearNodes(e),this.clearDirectionalLights(),this.clearPointLights(),this.clearSpotLights()},Scene.prototype._initNodes=function(){this._rootBackgroundNode=new RenderableNode(new c.RenderableObject3D(null,!1,!1,n.IDENTITY4,n.IDENTITY4,n.IDENTITY4,void 0,0,!1,!0),!1),this._rootBackgroundNode.setScene(this),this._rootNode=new RenderableNode(new c.RenderableObject3D(null,!1,!1,n.IDENTITY4,n.IDENTITY4,n.IDENTITY4,void 0,0,!1,!0)),this._rootNode.setScene(this),this._rootResourceNode=new RenderableNode(new c.RenderableObject3D(null,!1,!1,n.IDENTITY4,n.IDENTITY4,n.IDENTITY4,void 0,1,!1,!0),!1),this._rootResourceNode.setScene(this),this._resourceObjectIDs={},this._rootUINode=new RenderableNode(new c.RenderableObject3D(null,!1,!1,n.IDENTITY4,n.IDENTITY4,n.IDENTITY4,void 0,0,!1,!0),!1),this._rootUINode.setScene(this),this._objectsToMove=[]},Scene.prototype.clearNodes=function(e){this._rootBackgroundNode&&this._rootBackgroundNode.removeSubnodes(e),this._rootNode&&this._rootNode.removeSubnodes(e),this._rootResourceNode&&this._rootResourceNode.removeSubnodes(e),this._resourceObjectIDs={},this._rootUINode&&this._rootUINode.removeSubnodes(e),this._objectsToMove.length=0},Scene.prototype.clearDirectionalLights=function(){this._directionalLights=[]},Scene.prototype.clearPointLights=function(){var e;for(this._pointLightPriorityArrays=new Array(5),e=0;e<5;e++)this._pointLightPriorityArrays[e]=[]},Scene.prototype.clearSpotLights=function(){this._spotLights=[]},Scene.prototype.getAllObjects=function(){var e,t=[],i=this._rootNode._subnodes;for(e=i._first;e;e=e.next)t.push(e._renderableObject);return t},Scene.prototype.getAll3DObjects=function(){var e,t,i=[],n=this._rootNode._subnodes;for(t=n._first;t;t=t.next)e=t._renderableObject,e.getPositionMatrix&&e.getOrientationMatrix&&i.push(e);return i},Scene.prototype.moveAllObjectsByVector=function(e){var t,i,n,s=this._rootNode._subnodes;for(n=s._first;n;n=n.next)i=n._renderableObject,i.translatev&&i.translatev(e);for(t=0;t<this._objectsToMove.length;t++)this._objectsToMove[t].translatev(e)},Scene.prototype.moveCameraToOrigoIfNeeded=function(e){var t=this._camera.moveToOrigoIfNeeded(e);return t&&this.moveAllObjectsByVector(t),t},Scene.prototype.getFirstNode=function(){return this._rootNode.getFirstSubnode()},Scene.prototype.getNextNode=function(e){return this._rootNode.getNextSubnode(e)},Scene.prototype.getPreviousNode=function(e){return this._rootNode.getPreviousSubnode(e)},Scene.prototype.hasResourcesOfObject=function(e){return!!this._resourceObjectIDs[e]},Scene.prototype.addResourcesOfObject=function(e,t){var i;t&&this._resourceObjectIDs[t]||(e&&(i=new RenderableNode(e,!1),this._rootResourceNode.addSubnode(i,!0),i.markAsReusable(!1)),t&&(this._resourceObjectIDs[t]=!0))},Scene.prototype.addDirectionalLightSource=function(e){this._directionalLights.push(e)},Scene.prototype.addPointLightSource=function(e,t){t=Math.min(t||0,4),this._pointLightPriorityArrays[t].push(e)},Scene.prototype.addSpotLightSource=function(e){this._spotLights.push(e)},Scene.prototype.getLODContext=function(){return this._lodContext},Scene.prototype.setUniformValueFunction=function(e,t){this._uniformValueFunctions[o.getUniformName(e)]=t.bind(this)},Scene.prototype.setCameraUniformValueFunction=function(e,t){this._cameraUniformValueFunctions[o.getUniformName(e)]=t.bind(this)},Scene.prototype.setConstantUniformValueFunction=function(e,t){this._constantUniformValueFunctions[o.getUniformName(e)]=t.bind(this)},Scene.prototype.setContextUniformValueFunction=function(e,t,i){this._contextUniformValueFunctions[e]||(this._contextUniformValueFunctions[e]={}),this._contextUniformValueFunctions[e][o.getUniformName(t)]=i.bind(this)},Scene.prototype.setContextConstantUniformValueFunction=function(e,t,i){this._contextConstantUniformValueFunctions[e]||(this._contextConstantUniformValueFunctions[e]={}),this._contextConstantUniformValueFunctions[e][o.getUniformName(t)]=i.bind(this)},Scene.prototype.addCameraConfiguration=function(e){this._rootNode.addCameraConfiguration(e)},Scene.prototype.hasCameraConfiguration=function(e){return this._rootNode.hasCameraConfiguration(e)},Scene.prototype.getNextCameraConfiguration=function(e){return this._rootNode.getNextCameraConfiguration(e)},Scene.prototype.getPreviousCameraConfiguration=function(e){return this._rootNode.getPreviousCameraConfiguration(e)},Scene.prototype.getCameraConfigurationsWithName=function(e){return this._rootNode.getCameraConfigurationsWithName(e)},Scene.prototype.hideUI=function(){this._rootUINode.hide()},Scene.prototype.showUI=function(){this._rootUINode.show()},Scene.prototype.assignUniforms=function(e,t){this._uniformsUpdated.has(t)||(t.assignUniforms(e,this._uniformValueFunctions),t.assignUniforms(e,this._contextUniformValueFunctions[this._contexts.indexOf(e)]),this._uniformsUpdated.add(t),this._uniformsUpdatedForFrame=!0),this._cameraUniformsUpdated.has(t)||(t.assignUniforms(e,this._cameraUniformValueFunctions),this._cameraUniformsUpdated.add(t)),this._constantUniformsUpdated.has(t)||(t.assignUniforms(e,this._constantUniformValueFunctions),t.assignUniforms(e,this._contextConstantUniformValueFunctions[this._contexts.indexOf(e)]),this._constantUniformsUpdated.add(t))},Scene.prototype.cleanUpLights=function(){var e,t,i,n;for(n=0;n<this._pointLightPriorityArrays.length;n++)for(e=0;e<this._pointLightPriorityArrays[n].length;e++){for(t=e,
i=0;t<this._pointLightPriorityArrays[n].length&&(!this._pointLightPriorityArrays[n][t]||!0===this._pointLightPriorityArrays[n][t].canBeReused());)t++,i++;this._pointLightPriorityArrays[n].splice(e,i)}for(e=0;e<this._spotLights.length;e++){for(t=e,i=0;t<this._spotLights.length&&(!this._spotLights[t]||!0===this._spotLights[t].canBeReused());)t++,i++;this._spotLights.splice(e,i)}},Scene.prototype._renderShadowMap=function(e,t,i,n){var s,r,a=e.gl;if(this._shadowQueue.length>0){for(o.areDepthTexturesAvailable()?a.clear(a.DEPTH_BUFFER_BIT):a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),r=[],s=0;s<this._shadowQueue.length;s++)this._shadowQueue[s].renderToShadowMap(e,t,i,n)&&r.push(this._shadowQueue[s]);this._shadowQueue=r}},Scene.prototype._renderShadowMaps=function(e,t,i){var n,s,o,r=e.gl;if(this._shadowMappingEnabled){for(r.viewport(0,0,this._shadowMapTextureSize,this._shadowMapTextureSize),r.clearColor(0,0,0,0),e.setColorMask(g),e.disableBlending(),e.setDepthMask(!0),e.setCurrentShader(this._shadowMappingShader),this.assignUniforms(e,this._shadowMappingShader),n=0;n<this._directionalLights.length&&n<this._maxRenderedDirectionalLights;n++){for(this._directionalLights[n].reset(),this._shadowQueue=new Array(this._rootNode._subnodes._length),s=0,o=this._rootNode._subnodes._first;o;o=o.next,s++)this._shadowQueue[s]=o;for(s=this._shadowMapRanges.length-1;s>=0;s--)this._directionalLights[n].startShadowMap(e,this._camera,s,this._shadowMapRanges[s],this._shadowMapRanges[s]*this._shadowMapDepthRatio),this._renderShadowMap(e,t,i,this._directionalLights[n])}for(n=0;n<this._directionalLights.length&&n<this._maxRenderedDirectionalLights;n++)for(s=0;s<this._shadowMapRanges.length;s++)e.bindTexture(e.getFrameBuffer(this._directionalLights[n].getShadowMapBufferName(s)),void 0,!0)}e.setCurrentFrameBuffer(null)},Scene.prototype._renderBackgroundObjects=function(e,t,i){e.enableBlending(),e.setDepthMask(!1),this._rootBackgroundNode.render(e,t,i,!1)},Scene.prototype._renderQueue=function(e,t,i,n,s,o){var r,a,l=n.length;if(l>0)if(n[0]._instancing&&e.instancingExt){for(a=0,n[0].prepareForInstancedRender(e,s,l),r=0;r<l;r++)n[r].render(e,t,i,o,!0,!0,s,!0)&&a++;a>0&&n[0].renderInstances(e,s,a)}else for(r=0;r<l;r++)n[r].render(e,t,i,o,!0,void 0,void 0,!0)},Scene.prototype._renderMainObjects=function(e,t,i,n,s,o){var r;if(n.length>0)for(e.setDepthMask(!0),e.disableBlending(),r=0;r<n.length;r++)this._renderQueue(e,t,i,n[r],r,!0);if(o&&this._renderBackgroundObjects(e,t,i),s.length>0)for(e.setDepthMask(!1),e.enableBlending(),r=0;r<s.length;r++)this._renderQueue(e,t,i,s[r],r,!1)},Scene.prototype._renderUIObjects=function(e,t,i){var n,s=e.gl;this._rootUINode.isVisible()&&this._rootUINode._subnodes._length>0&&(n=this._camera,this._distanceRendering&&(this._camera=this._camera.getExtendedCamera(!0)),e.enableBlending(),s.disable(s.DEPTH_TEST),e.setDepthMask(!1),this._rootUINode.render(e,t,i,!1),s.enable(s.DEPTH_TEST),this._camera=n)},Scene.prototype._render=function(e,t,i,n,s,o){var r,a,l=e.gl;this._shouldClearColorOnRender&&(e.setColorMask(this._clearColorMask),l.clearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3])),e.setDepthMask(!0),r=this._shouldClearColorOnRender?l.COLOR_BUFFER_BIT:0,r=this._shouldClearDepthOnRender?r|l.DEPTH_BUFFER_BIT:r,l.clear(r),t&&(a=this._camera,this._camera=this._camera.getExtendedCamera(),this._cameraUniformsUpdated.clear(),this._clearDynamicLightUniformData(),this._renderMainObjects(e,n,s,this._renderQueues[2],this._renderQueues[3],!0),this._camera=a,e.setDepthMask(!0),l.clear(l.DEPTH_BUFFER_BIT),this._cameraUniformsUpdated.clear()),!i&&t||(this._updateDynamicLightUniformData(this._shouldAnimate?o:0),e.getCurrentShader()&&this.assignUniforms(e,e.getCurrentShader()),this._renderMainObjects(e,n,s,this._renderQueues[0],this._renderQueues[1],!t)),this._renderUIObjects(e,n,s)},Scene.prototype.render=function(e,t){var i,n,s,o=e.gl,a=o.drawingBufferWidth,l=o.drawingBufferHeight,c=a*this._width,h=l*this._height;r.resetDebugStats(),this._camera.setAspect(c/h),this._shouldUpdateCamera&&this._camera.update(t),this._uniformsUpdated.clear(),this._cameraUniformsUpdated.clear(),s=!1,!1===this._uniformsUpdatedForFrame&&e.getCurrentShader()&&(this._updateStaticLightUniformData(),this.assignUniforms(e,e.getCurrentShader()),s=!0),this._uniformsUpdatedForFrame=!1,this._renderQueues[0].length=0,this._renderQueues[1].length=0,this._distanceRendering&&(this._renderQueues[2].length=0,this._renderQueues[3].length=0),this._rootNode.animateAndAddToRenderQueues(this._renderQueues,this._distanceRendering,this._camera,t),this.cleanUpLights(),i=this._renderQueues[0].length>0||this._renderQueues[1].length>0,n=this._distanceRendering&&(this._renderQueues[2].length>0||this._renderQueues[3].length>0),i&&(this._renderShadowMaps(e,c,h),this._shadowMappingEnabled&&(s=!1)),s||this._updateStaticLightUniformData(),o.viewport(this._left*a,this._bottom*l,c,h),this._render(e,n,i,c,h,t)},Scene.prototype.increaseCount=function(e){this._nodeCount++,this._nodeCountByType[e]=this._nodeCountByType[e]||0,this._nodeCountByType[e]++},Scene.prototype.logNodes=function(){var e,t;for(this._nodeCount=0,this._nodeCountByType={},this._rootNode.log(0),e=Object.keys(this._nodeCountByType),t=0;t<e.length;t++);},Scene.prototype.getMainDebugStats=function(){return this._mainDebugStats},Scene.prototype.getShadowMapDebugStats=function(){return this._shadowMapDebugStats},{getDebugInfo:getDebugInfo,LODContext:LODContext,RenderableNode:RenderableNode,Scene:Scene}}),function(){"use strict";Math.sign=Math.sign||function(e){return e=+e,0===e||isNaN(e)?e:e>0?1:-1},Math.log10=Math.log10||function(e){return Math.log(e)/Math.LN10},Math.log2=Math.log2||function(e){return Math.log(e)/Math.LN2},Math.seed=function(e){return function(){return(e=1e4*Math.sin(e))-Math.floor(e)}},Math.radians=function(e){return e*Math.PI/180},Math.degrees=function(e){return 180*e/Math.PI},Number.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},Array.prototype.findIndex=Array.prototype.findIndex||function(e,t){var i;for(i=0;i<this.length;i++)if(e.call(t||e,this[i],i,this))return i;return-1},Array.prototype.find=Array.prototype.find||function(e,t){var i;for(i=0;i<this.length;i++)if(e.call(t||e,this[i],i,this))return this[i]}}(),define("utils/polyfill",function(){}),define("armada/graphics",["utils/matrices","utils/types","modules/application","modules/async-resource","modules/managed-gl","modules/media-resources","modules/scene/scene-graph","armada/constants","utils/polyfill"],function(e,t,i,n,s,o,r,a){"use strict";function _getDependentShaderRequirement(e,t){var i,n,s=0;for(i in p)p.hasOwnProperty(i)&&(n=p[i],t.hasOwnProperty(n.name)&&(s+=e[n.name]*t[n.name]));return s}function _getShaderRequirementsFromDescriptor(e,t){return{requiredVertexUniformVectors:e[_]+_getDependentShaderRequirement(e[g],t),requiredAttributeVectors:e[m]+_getDependentShaderRequirement(e[f],t),requiredVaryingVectors:e[S]+_getDependentShaderRequirement(e[T],t),requiredTextureUnits:e[y]+_getDependentShaderRequirement(e[E],t),requiredFragmentUniformVectors:e[C]+_getDependentShaderRequirement(e[M],t),fragmentShaderHighPrecision:e[I]}}function _getCombinedRequirements(e,t){return{requiredVertexUniformVectors:e.requiredVertexUniformVectors+t.requiredVertexUniformVectors,requiredAttributeVectors:e.requiredAttributeVectors+t.requiredAttributeVectors,requiredVaryingVectors:e.requiredVaryingVectors+t.requiredVaryingVectors,requiredTextureUnits:e.requiredTextureUnits+t.requiredTextureUnits,requiredFragmentUniformVectors:e.requiredFragmentUniformVectors+t.requiredFragmentUniformVectors,fragmentShaderHighPrecision:e.fragmentShaderHighPrecision||t.fragmentShaderHighPrecision}}function OrderedNamedNumericOptions(e,i,n,s){this._list=e?t.getArrayValue(n||"OrderedNamedNumericOptions.list",e,i,null,{minLength:1},[]):[],this._optionNamePropertyName=i?i.properties.NAME.name:null,this._optionValuePropertyName=i?i.properties.VALUE.name:null,this._list.sort(function(e,t){return e[this._optionValuePropertyName]-t[this._optionValuePropertyName]}.bind(this)),this._currentIndex=this._list.length-1,s&&this.applyLimit(s)}function TextureQuality(e,t,i){OrderedNamedNumericOptions.call(this,e,h,t,i),this._preferenceList=null,this._preferenceNameList=null,this._updatePreferenceList()}function GraphicsSettingsContext(){n.AsyncResource.call(this),this._dataJSON=null,this._antialiasing=!1,this._filtering=null,this._lodLevel=null,this._maxLoadedLOD=0,this._lodContext=null,this._msInLaunchers=!1,this._textureQuality=null,this._cubemapQuality=null,this._shadowMappingEnabled=!1,this._shadowMapQuality=null,this._shadowRanges=null,this._shadowDistances=null,this._shadowDepthRatio=0,this._pointLightAmount=null,this._particleAmount=null,this._dustParticleAmount=null,this._shaderConfig=null,this._shaderComplexity=null,this._luminosityTextureAreAvailable=!1,this._groupTransformIdentityArray=null,this._generalLevels=null,this._currentGeneralLevel=null}function shouldUseShadowMapping(){return l.isShadowMappingEnabled()&&l.isShadowMappingAvailable()}function getShadowMappingShader(){return l.getShader(l.getShadowMappingShaderName())}function getShadowMappingSettings(){return shouldUseShadowMapping()?{enable:!0,shader:l.getManagedShader(l.getShadowMappingShaderName()),textureSize:l.getShadowMapTextureSize(),ranges:l.getShadowRanges(),depthRatio:l.getShadowDepthRatio(),numSamples:l.getNumShadowMapSamples()}:null}function getAnaglyphRedShader(){return l.getShader(l.getShaderConfig(O.ANAGLYPH_RED_SHADER_NAME))}function getAnaglyphCyanShader(){return l.getShader(l.getShaderConfig(O.ANAGLYPH_CYAN_SHADER_NAME))}function getSideBySideLeftShader(){return l.getShader(l.getShaderConfig(O.SIDE_BY_SIDE_LEFT_SHADER_NAME))}function getSideBySideRightShader(){return l.getShader(l.getShaderConfig(O.SIDE_BY_SIDE_RIGHT_SHADER_NAME))}function getShadowMapDebugShader(){return l.getShader(l.getShaderConfig(O.SHADOW_MAP_DEBUG_SHADER_NAME))}function getAnaglyphOriginalColorRatio(){return parseFloat(l.getShaderConfig(O.ANAGLYPH_ORIGINAL_COLOR_RATIO))}function getAnaglyphGamma(){return parseFloat(l.getShaderConfig(O.ANAGLYPH_GAMMA))}function getAnaglyphCyanFactor(){return parseFloat(l.getShaderConfig(O.ANAGLYPH_CYAN_FACTOR))}function getLispsmMinimumNear(){return parseFloat(l.getShaderConfig(O.LISPSM_MINIMUM_NEAR))}function getLispsmNearFactor(){return parseFloat(l.getShaderConfig(O.LISPSM_NEAR_FACTOR))}function onSettingsChange(e){z.push(e)}function handleSettingsChanged(){var e;for(e=0;e<z.length;e++)z[e]()}var l,c=a.LOCAL_STORAGE_PREFIX+"graphics_",h=t.getNameAndValueDefinitionObject("maximumResolution"),u=t.getNameAndValueDefinitionObject("lod"),d={baseType:"object",properties:{LUMINOSITY_FACTOR:{name:"luminosityFactor",type:"number",defaultValue:0},GROUP_TRANSFORM:{name:"groupTransform",type:"number",defaultValue:0},DIR_LIGHT:{name:"dirLight",type:"number",defaultValue:0},POINT_LIGHT:{name:"pointLight",type:"number",defaultValue:0},SPOT_LIGHT:{name:"spotLight",type:"number",defaultValue:0},SHADOW_MAP:{name:"shadowMap",type:"number",defaultValue:0},SHADOW_MAP_RANGE:{name:"shadowMapRange",type:"number",defaultValue:0},SHADOW_MAP_SAMPLE:{name:"shadowMapSample",type:"number",defaultValue:0}}},p=d.properties,_="requiredVertexUniformVectors",g="requiredVertexUniformVectorsPer",m="requiredAttributeVectors",f="requiredAttributeVectorsPer",S="requiredVaryingVectors",T="requiredVaryingVectorsPer",y="requiredTextureUnits",E="requiredTextureUnitsPer",C="requiredFragmentUniformVectors",M="requiredFragmentUniformVectorsPer",I="fragmentShaderHighPrecision",A={baseType:"object",properties:{VERTEX_UNIFORM_VECTORS:{name:_,type:"number",defaultValue:0},VERTEX_UNIFORM_VECTORS_PER:{name:g,type:d,defaultValue:{}},ATTRIBUTE_VECTORS:{name:m,type:"number",defaultValue:0},ATTRIBUTE_VECTORS_PER:{name:f,type:d,defaultValue:{}},VARYING_VECTORS:{name:S,type:"number",defaultValue:0},VARYING_VECTORS_PER:{name:T,type:d,defaultValue:{}},TEXTURE_UNITS:{name:y,type:"number",defaultValue:0},TEXTURE_UNITS_PER:{name:E,type:d,defaultValue:{}},FRAGMENT_UNIFORM_VECTORS:{name:C,type:"number",defaultValue:0},FRAGMENT_UNIFORM_VECTORS_PER:{name:M,type:d,defaultValue:{}},FRAGMENT_SHADER_HIGH_PRECISION:{name:I,type:"boolean",defaultValue:!1}}},x={baseType:"object",properties:{NAME:{name:"name",type:"string"},SHADOW_MAPPING_AVAILABLE:{name:"shadows",type:"boolean"},NUM_SHADOW_MAP_SAMPLES:{name:"numShadowMapSamples",type:"number",defaultValue:0},DYNAMIC_LIGHTS_AVAILABLE:{name:"dynamicLights",type:"boolean"},MAX_DIR_LIGHTS:{name:"maxDirLights",type:"number"},MAX_SPOT_LIGHTS:{name:"maxSpotLights",type:"number",defaultValue:0},LUMINOSITY_TEXTURES_AVAILABLE:{name:"luminosityTextures",type:"boolean"},REVEAL_AVAILABLE:{name:"reveal",type:"boolean"},REQUIREMENTS:{name:"requirements",type:A}}},v=x.properties,O={FEATURE_REQUIREMENTS:{name:"featureRequirements",type:"object",properties:{SHADOWS:{name:"shadows",type:A},DYNAMIC_LIGHTS:{name:"dynamicLights",type:A},REVEAL:{name:"reveal",type:A}}},COMPLEXITIES:{name:"complexities",type:"array",elementType:x,minLength:1},SHADOW_MAPPING_SHADER_NAME:{name:"shadowMappingShaderName",type:"string"},MAX_DIR_LIGHTS_DEFINE_NAME:{name:"maxDirLightsDefineName",type:"string"},MAX_POINT_LIGHTS_DEFINE_NAME:{name:"maxPointLightsDefineName",type:"string"},MAX_SPOT_LIGHTS_DEFINE_NAME:{name:"maxSpotLightsDefineName",type:"string"},DUST_LENGTH_DIVISOR:{name:"dustLengthDivisor",type:"string"},DUST_LENGTH_DIVISOR_DEFINE_NAME:{name:"dustLengthDivisorDefineName",type:"string"},MAX_LUMINOSITY_FACTORS:{name:"maxLuminosityFactors",type:"number"},MAX_LUMINOSITY_FACTORS_DEFINE_NAME:{name:"maxLuminosityFactorsDefineName",type:"string"},MAX_GROUP_TRANSFORMS:{name:"maxGroupTransforms",type:"number"},MAX_GROUP_TRANSFORMS_DEFINE_NAME:{name:"maxGroupTransformsDefineName",type:"string"},SHADOW_MAP_TEXTURE_SIZE_DEFINE_NAME:{name:"shadowMapTextureSizeDefineName",type:"string"},MAX_SHADOW_MAP_RANGES_DEFINE_NAME:{name:"maxShadowMapRangesDefineName",type:"string"},MAX_SHADOW_MAPS_DEFINE_NAME:{name:"maxShadowMapsDefineName",type:"string"},NUM_SHADOW_MAP_SAMPLES_DEFINE_NAME:{name:"numShadowMapSamplesDefineName",type:"string"},SHADOW_MAP_DEPTH_RATIO_DEFINE_NAME:{name:"shadowMapDepthRatioDefineName",type:"string"},DEPTH_TEXTURES_DEFINE_NAME:{name:"depthTexturesDefineName",type:"string"},MAX_SHININESS:{name:"maxShininess",type:"string"},MAX_SHININESS_DEFINE_NAME:{name:"maxShininessDefineName",type:"string"},LISPSM_MINIMUM_NEAR:{name:"lispsmMinimumNear",type:"string"},LISPSM_MINIMUM_NEAR_DEFINE_NAME:{name:"lispsmMinimumNearDefineName",type:"string"},LISPSM_NEAR_FACTOR:{name:"lispsmNearFactor",type:"string"},LISPSM_NEAR_FACTOR_DEFINE_NAME:{name:"lispsmNearFactorDefineName",type:"string"},ANAGLYPH_RED_SHADER_NAME:{name:"anaglyphRedShaderName",type:"string"},ANAGLYPH_CYAN_SHADER_NAME:{name:"anaglyphCyanShaderName",type:"string"},SIDE_BY_SIDE_LEFT_SHADER_NAME:{name:"sideBySideLeftShaderName",type:"string"},SIDE_BY_SIDE_RIGHT_SHADER_NAME:{name:"sideBySideRightShaderName",type:"string"},SHADOW_MAP_DEBUG_SHADER_NAME:{name:"shadowMapDebugShaderName",type:"string"},ANAGLYPH_ORIGINAL_COLOR_RATIO:{name:"anaglyphOriginalColorRatio",type:"string"},ANAGLYPH_ORIGINAL_COLOR_RATIO_DEFINE_NAME:{name:"anaglyphOriginalColorRatioDefineName",type:"string"},ANAGLYPH_GAMMA:{name:"anaglyphGamma",type:"string"},ANAGLYPH_GAMMA_DEFINE_NAME:{name:"anaglyphGammaDefineName",type:"string"},ANAGLYPH_CYAN_FACTOR:{name:"anaglyphCyanFactor",type:"string"},ANAGLYPH_CYAN_FACTOR_DEFINE_NAME:{name:"anaglyphCyanFactorDefineName",type:"string"}},R=O.FEATURE_REQUIREMENTS.properties,b=t.getNameAndValueDefinitionObject("numRanges"),L=t.getNameAndValueDefinitionObject("maxLights"),N=t.getNameAndValueDefinitionObject("particleCountFactor"),D=c+"generalLevel",P=c+"antialiasing",w=c+"filtering",V=s.TextureFiltering.TRILINEAR,F=c+"textureQuality",U=c+"cubemapQuality",B=c+"maxLOD",H=c+"missilesInLaunchers",G=c+"shaderComplexity",j=c+"shadowMapping",k=c+"shadowQuality",W=c+"shadowDistance",Y=c+"pointLightAmount",X=c+"particleAmount",q=c+"dustParticleAmount",z=[];return OrderedNamedNumericOptions.prototype._getNameFunction=function(e){return e[this._optionNamePropertyName]},OrderedNamedNumericOptions.prototype._checkNameFunction=function(e,t){return t[this._optionNamePropertyName]===e},OrderedNamedNumericOptions.prototype._isWithinLimitFunction=function(e,t){return t[this._optionValuePropertyName]<=e},OrderedNamedNumericOptions.prototype._valueFilterFunction=function(e,t){return e(t[this._optionValuePropertyName])},OrderedNamedNumericOptions.prototype._getInvalidOptionAccessErrorMessage=function(e){return"Invalid option ("+this._optionValuePropertyName+") '"+e+"' specified! Valid values are: "+this.getNameList().join(", ")+"."},OrderedNamedNumericOptions.prototype.getNameList=function(){return this._list.map(this._getNameFunction.bind(this))},OrderedNamedNumericOptions.prototype.getFilteredNameList=function(e){return this._list.filter(this._valueFilterFunction.bind(this,e)).map(this._getNameFunction.bind(this))},OrderedNamedNumericOptions.prototype.setCurrent=function(e,t){return this._currentIndex=this._list.findIndex(this._checkNameFunction.bind(this,e)),this._currentIndex<0&&t&&(this._currentIndex=this._list.length-1),!(this._currentIndex<0)||(i.showError(this._getInvalidOptionAccessErrorMessage(e)),!1)},OrderedNamedNumericOptions.prototype.getCurrentName=function(){return this._currentIndex>=0?this._list[this._currentIndex][this._optionNamePropertyName]:null},OrderedNamedNumericOptions.prototype.getCurrentValue=function(){return this._currentIndex>=0?this._list[this._currentIndex][this._optionValuePropertyName]:0},OrderedNamedNumericOptions.prototype.getValueForName=function(e){var t=this._list.findIndex(this._checkNameFunction.bind(this,e));return t>=0?this._list[t][this._optionValuePropertyName]:(i.showError(this._getInvalidOptionAccessErrorMessage(e)),0)},OrderedNamedNumericOptions.prototype.applyLimit=function(e){this.getCurrentName();this._list=this._list.filter(this._isWithinLimitFunction.bind(this,e)),this._currentIndex>=this._list.length&&(this._currentIndex=this._list.length-1)},OrderedNamedNumericOptions.prototype.decrease=function(){return this._currentIndex>0&&(this._currentIndex--,!0)},OrderedNamedNumericOptions.prototype.setLowest=function(){this._currentIndex=0},OrderedNamedNumericOptions.prototype.getFirstValue=function(){return this._list[0][this._optionValuePropertyName]},TextureQuality.prototype=new OrderedNamedNumericOptions,TextureQuality.prototype.constructor=TextureQuality,TextureQuality.prototype._updatePreferenceList=function(){var e;for(this._preferenceList=[],e=this._currentIndex;e>=0;e--)this._preferenceList.push(this._list[e]);for(e=this._currentIndex+1;e<this._list.length;e++)this._preferenceList.push(this._list[e]);this._preferenceNameList=this._preferenceList.map(this._getNameFunction.bind(this))},TextureQuality.prototype.setCurrent=function(e,t){var i;return i=OrderedNamedNumericOptions.prototype.setCurrent.call(this,e,t),this._updatePreferenceList(),i},TextureQuality.prototype.getPreferenceNameList=function(){return this._preferenceNameList},TextureQuality.prototype.applyLimit=function(e){OrderedNamedNumericOptions.prototype.applyLimit.call(this,e),this._updatePreferenceList()},GraphicsSettingsContext.prototype=new n.AsyncResource,GraphicsSettingsContext.prototype.constructor=GraphicsSettingsContext,GraphicsSettingsContext.prototype._getShaderRequirements=function(e){e=e||{};var t,i=this._getShaderComplexityDescriptor(e.complexityLevelIndex),n=this.getShaderConfig(O.FEATURE_REQUIREMENTS),s=i[v.MAX_DIR_LIGHTS.name],o=void 0===e.numPointLights?this.getMaxPointLights():e.numPointLights,r=o>0?i[v.MAX_SPOT_LIGHTS.name]:0,a=void 0===e.numShadowRanges?this.getNumShadowMapRanges():e.numShadowRanges,l=s*a,c=i[v.NUM_SHADOW_MAP_SAMPLES.name],h={};return h[p.DIR_LIGHT.name]=s,h[p.POINT_LIGHT.name]=o,h[p.SPOT_LIGHT.name]=r,h[p.SHADOW_MAP.name]=l,h[p.SHADOW_MAP_RANGE.name]=a,h[p.SHADOW_MAP_SAMPLE.name]=c,h[p.LUMINOSITY_FACTOR.name]=this.getShaderConfig(O.MAX_LUMINOSITY_FACTORS),h[p.GROUP_TRANSFORM.name]=this.getShaderConfig(O.MAX_GROUP_TRANSFORMS),t=_getShaderRequirementsFromDescriptor(i[v.REQUIREMENTS.name],h),i[v.SHADOW_MAPPING_AVAILABLE.name]&&a>0&&(t=_getCombinedRequirements(t,_getShaderRequirementsFromDescriptor(n[R.SHADOWS.name],h))),i[v.DYNAMIC_LIGHTS_AVAILABLE.name]&&o>0&&(t=_getCombinedRequirements(t,_getShaderRequirementsFromDescriptor(n[R.DYNAMIC_LIGHTS.name],h))),i[v.REVEAL_AVAILABLE.name]&&(t=_getCombinedRequirements(t,_getShaderRequirementsFromDescriptor(n[R.REVEAL.name],h))),t},GraphicsSettingsContext.prototype._shaderRequirementsAreSatisfied=function(e){return s.requirementsAreSatisfied(this._getShaderRequirements(e))},GraphicsSettingsContext.prototype._limitShaderComplexities=function(){var e,t=[],i=this.getShaderConfig(O.COMPLEXITIES);for(e=0;e<i.length;e++)this._shaderRequirementsAreSatisfied({numPointLights:0,numShadowRanges:0,complexityLevelIndex:e})&&t.push(i[e]);this.setShaderConfig(O.COMPLEXITIES,t)},GraphicsSettingsContext.prototype._setFallbackShaderComplexity=function(e){var t;for(e&&!this._shaderRequirementsAreSatisfied()&&this._disableShaderFeatures(),t=this.getShaderComplexities().indexOf(this.getShaderComplexity());t>0&&!this._shaderRequirementsAreSatisfied({complexityLevelIndex:t});)t--;this.setShaderComplexity(this.getShaderComplexities()[t],!1)},GraphicsSettingsContext.prototype.loadConfigurationFromJSON=function(i){var n,o,a,l;for(this._shaderConfig=t.getVerifiedObject("config.graphics.shaders",i.shaders,O),this._limitShaderComplexities(),this._textureQuality=new TextureQuality(i.context.textureQualities,"config.graphics.context.textureQualities",s.getMaxTextureSize()),this._cubemapQuality=new TextureQuality(i.context.cubemapQualities,"config.graphics.context.cubemapQualities",s.getMaxCubemapSize()),this._shadowMapQuality=new TextureQuality(i.context.shadows.qualities,"config.graphics.context.shadows.qualities",s.getMaxRenderbufferSize()),this._shadowRanges=t.getArrayValue("config.graphics.context.shadows.ranges",i.context.shadows.ranges,"number",null,{minLength:1}),this._shadowDistances=new OrderedNamedNumericOptions(i.context.shadows.distances,b,"config.graphics.context.shadows.distances",this._shadowRanges.length),this._shadowDepthRatio=t.getNumberValue("config.graphics.context.shadows.depthRatio",i.context.shadows.depthRatio),this._pointLightAmount=new OrderedNamedNumericOptions(i.context.pointLightAmounts,L,"config.graphics.context.pointLightAmounts"),this._particleAmount=new OrderedNamedNumericOptions(i.context.particleAmounts,N,"config.graphics.context.particleAmounts"),this._dustParticleAmount=new OrderedNamedNumericOptions(i.context.dustParticleAmounts,N,"config.graphics.context.dustParticleAmounts"),this._lodLevel=new OrderedNamedNumericOptions(i.levelOfDetailSettings.lodLevels,u,"config.graphics.levelOfDetailSettings.lodLevels"),l=new Array(i.levelOfDetailSettings.lodDisplayProfile.limits.length+1),l[0]=0,n=0,o=i.levelOfDetailSettings.lodDisplayProfile.limits.length;n<o;n++)a=i.levelOfDetailSettings.lodDisplayProfile.limits[n],l[this._lodLevel.getValueForName(a.level)+1]=a.objectSizeLessThan;for(this._lodContext=new r.LODContext(this._lodLevel.getFirstValue(),l,i.levelOfDetailSettings.lodDisplayProfile.compensateForObjectSize,i.levelOfDetailSettings.lodDisplayProfile.referenceSize,i.levelOfDetailSettings.lodDisplayProfile.minimumRelativeSize),this._generalLevels=i.generalLevels,this._groupTransformIdentityArray=new Float32Array(16*this.getShaderConfig(O.MAX_GROUP_TRANSFORMS)),n=0;n<this._groupTransformIdentityArray.length;n++)this._groupTransformIdentityArray[n]=e.IDENTITY4[n%16]},GraphicsSettingsContext.prototype._limitSettingByScreenSize=function(e,t,i,n,s){var o,r,a,l;if(!0===e.autoLimitByScreenSize)for(o=Math.max(screen.width,screen.height),r=0,a=e.limits.length;r<a;r++)l=e.limits[r],o<l.screenSizeLessThan&&i()>t.getValueForName(l[s])&&n(l[s],!1)},GraphicsSettingsContext.prototype.loadSettingsFromJSON=function(e,n){n=n||!1,n||(this._dataJSON=e),"object"==typeof e.shaders?this.setShaderComplexity(e.shaders.complexity,!1,!0):i.showError("Missing required settings.graphics.shaders from the setting definition object!"),"object"==typeof e.context?(this.setAntialiasing(t.getBooleanValue(e.context.antialiasing,{name:"settings.graphics.context.antialiasing"}),!1),this.setFiltering(t.getEnumValue(s.TextureFiltering,e.context.filtering,{name:"settings.graphics.context.filtering"}),!1),this.setTextureQuality(e.context.textureQuality,!1,!0),this.setCubemapQuality(e.context.cubemapQuality.level,!1,!0),this._limitSettingByScreenSize(e.context.cubemapQuality,this._cubemapQuality,this.getCubemapMaxResolution.bind(this),this.setCubemapQuality.bind(this),"level"),this.setShadowMapping(t.getBooleanValue(e.context.shadowMapping,{name:"settings.graphics.context.shadowMapping"}),!1,!0),"object"==typeof e.context.shadows&&(this.setShadowMapQuality(e.context.shadows.quality,!1,!0),this.setShadowDistance(e.context.shadows.distance,!1,!0)),this.setPointLightAmount(e.context.pointLightAmount,!1,!0)):i.showError("Missing required settings.graphics.context from the setting definition object!"),this.setLODLevel(e.levelOfDetail.maxLevel,!1),this._limitSettingByScreenSize(e.levelOfDetail,this._lodLevel,this.getMaxLoadedLOD.bind(this),this.setLODLevel.bind(this),"level"),this.setMissilesInLaunchersVisible(t.getBooleanValue(e.showMissilesInLaunchers,{name:"settings.graphics.showMissilesInLaunchers"}),!1),this.setParticleAmount(e.particleAmount.amount,!1),this._limitSettingByScreenSize(e.particleAmount,this._particleAmount,this.getParticleCountFactor.bind(this),this.setParticleAmount.bind(this),"amount"),!0===e.particleAmount.autoDecreaseIfInstancingNotAvailable&&(s.isInstancingAvailable()||this._particleAmount.decrease()),this.setDustParticleAmount(e.dustParticleAmount.amount,!1),this._limitSettingByScreenSize(e.dustParticleAmount,this._dustParticleAmount,this.getDustParticleCountFactor.bind(this),this.setDustParticleAmount.bind(this),"amount"),!0===e.dustParticleAmount.autoDecreaseIfInstancingNotAvailable&&(s.isInstancingAvailable()||this._dustParticleAmount.decrease()),this._setFallbackShaderComplexity(!0)},GraphicsSettingsContext.prototype.loadFromLocalStorage=function(){var e,n,o=function(s,o,r,a){void 0!==localStorage[s]&&(n={silentFallback:i.hasVersionChanged(),defaultValue:r},e=t.getValueOfTypeFromLocalStorage(o,s,n),n.error&&!i.hasVersionChanged()||a(e,!!n.error&&n.error!==t.Errors.INVALID_ENUM_OBJECT_ERROR))};o(D,{baseType:"enum",values:t.getEnumObjectForArray(this.getGeneralLevelNames())},this.getGeneralLevel(),function(e){this._currentGeneralLevel=e}.bind(this)),o(P,"boolean",this.getAntialiasing(),this.setAntialiasing.bind(this)),o(w,{baseType:"enum",values:s.TextureFiltering},this.getFiltering(),this.setFiltering.bind(this)),o(F,{baseType:"enum",values:t.getEnumObjectForArray(this.getTextureQualities())},this.getTextureQuality(),this.setTextureQuality.bind(this)),o(U,{baseType:"enum",values:t.getEnumObjectForArray(this.getCubemapQualities())},this.getCubemapQuality(),this.setCubemapQuality.bind(this)),o(B,{baseType:"enum",values:t.getEnumObjectForArray(this.getLODLevels())},this.getLODLevel(),this.setLODLevel.bind(this)),o(H,"boolean",this.areMissilesInLaunchersVisible(),this.setMissilesInLaunchersVisible.bind(this)),o(G,{baseType:"enum",values:t.getEnumObjectForArray(this.getShaderComplexities())},this.getShaderComplexity(),this.setShaderComplexity.bind(this)),o(j,"boolean",this.isShadowMappingEnabled(),this.setShadowMapping.bind(this)),o(k,{baseType:"enum",values:t.getEnumObjectForArray(this.getShadowMapQualities())},this.getShadowMapQuality(),this.setShadowMapQuality.bind(this)),this.canEnableShadowMapping()&&o(W,{baseType:"enum",values:t.getEnumObjectForArray(this.getShadowDistances())},this.getShadowDistance(),this.setShadowDistance.bind(this)),o(Y,{baseType:"enum",values:t.getEnumObjectForArray(this.getPointLightAmounts())},this.getPointLightAmount(),this.setPointLightAmount.bind(this)),o(X,{baseType:"enum",values:t.getEnumObjectForArray(this.getParticleAmounts())},this.getParticleAmount(),this.setParticleAmount.bind(this)),o(q,{baseType:"enum",values:t.getEnumObjectForArray(this.getDustParticleAmounts())},this.getDustParticleAmount(),this.setDustParticleAmount.bind(this)),this.setToReady()},GraphicsSettingsContext.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0),localStorage.removeItem(D),localStorage.removeItem(P),localStorage.removeItem(w),localStorage.removeItem(F),localStorage.removeItem(U),localStorage.removeItem(B),localStorage.removeItem(H),localStorage.removeItem(G),localStorage.removeItem(j),localStorage.removeItem(k),localStorage.removeItem(W),localStorage.removeItem(Y),localStorage.removeItem(X),localStorage.removeItem(q)},GraphicsSettingsContext.prototype.getAntialiasing=function(){return this._antialiasing},GraphicsSettingsContext.prototype.setAntialiasing=function(e,t){return void 0===t&&(t=!0),s.isAntialiasingAvailable()?this._antialiasing=e:this._antialiasing=!1,t&&(localStorage[P]=e.toString()),this._antialiasing===e},GraphicsSettingsContext.prototype.getFiltering=function(){return this._filtering},GraphicsSettingsContext.prototype.setFiltering=function(e,i){void 0===i&&(i=!0),e=t.getEnumValue(s.TextureFiltering,e,{name:"texture filtering",defaultValue:this._filtering}),this._filtering=e,s.isAnisotropicFilteringAvailable()||e!==s.TextureFiltering.ANISOTROPIC||(this._filtering=V),i&&(localStorage[w]=e.toString())},GraphicsSettingsContext.prototype.getTextureQualities=function(){return this._textureQuality.getNameList()},GraphicsSettingsContext.prototype.getTextureQualityPreferenceList=function(){return this._textureQuality.getPreferenceNameList()},GraphicsSettingsContext.prototype.getTextureQuality=function(){return this._textureQuality.getCurrentName()},GraphicsSettingsContext.prototype.setTextureQuality=function(e,t,i){void 0===t&&(t=!0),this._textureQuality.setCurrent(e,i)&&t&&(localStorage[F]=e)},GraphicsSettingsContext.prototype.getCubemapMaxResolution=function(){return this._cubemapQuality.getCurrentValue()},GraphicsSettingsContext.prototype.getCubemapQualities=function(){return this._cubemapQuality.getNameList()},GraphicsSettingsContext.prototype.getCubemapQualityPreferenceList=function(){return this._cubemapQuality.getPreferenceNameList()},GraphicsSettingsContext.prototype.getCubemapQuality=function(){return this._cubemapQuality.getCurrentName()},GraphicsSettingsContext.prototype.setCubemapQuality=function(e,t,i){void 0===t&&(t=!0),this._cubemapQuality.setCurrent(e,i)&&t&&(localStorage[U]=e)},GraphicsSettingsContext.prototype.getMaxLoadedLOD=function(){return this._maxLoadedLOD},GraphicsSettingsContext.prototype.getLODLevels=function(){return this._lodLevel.getNameList()},GraphicsSettingsContext.prototype.getLODLevel=function(){return this._lodLevel.getCurrentName()},GraphicsSettingsContext.prototype.getLOD=function(e){return this._lodLevel.getValueForName(e)},GraphicsSettingsContext.prototype.setLODLevel=function(e,t){void 0===t&&(t=!0),this._lodLevel.setCurrent(e)&&(this._maxLoadedLOD=this._lodLevel.getCurrentValue(),this._lodContext.maxEnabledLOD=this._lodLevel.getCurrentValue(),t&&(localStorage[B]=e))},GraphicsSettingsContext.prototype.getLODContext=function(){return this._lodContext},GraphicsSettingsContext.prototype.setMissilesInLaunchersVisible=function(e,t){void 0===t&&(t=!0),this._msInLaunchers=e,t&&(localStorage[H]=e.toString())},GraphicsSettingsContext.prototype.areMissilesInLaunchersVisible=function(){return this._msInLaunchers},GraphicsSettingsContext.prototype.getShaderComplexity=function(){return this._shaderComplexity},GraphicsSettingsContext.prototype._limitShaderFeatures=function(){var e=this.isShadowMappingEnabled();for(this.getNumShadowMapRanges(),
this.getMaxPointLights();!this._shaderRequirementsAreSatisfied();)if(this.isShadowMappingEnabled())this._shadowDistances.decrease()||this.setShadowMapping(!1,!1,!0);else if(!this._pointLightAmount.decrease())return void i.showError("Cannot satisfy shader requirements for current complexity!");this.isShadowMappingEnabled()!==e||this.getNumShadowMapRanges(),this.getMaxPointLights()},GraphicsSettingsContext.prototype._disableShaderFeatures=function(){this.isShadowMappingEnabled()&&this.setShadowMapping(!1,!1,!0),this._pointLightAmount.setLowest()},GraphicsSettingsContext.prototype.setShaderComplexity=function(e,t,n){var s=this.getShaderComplexities();void 0===t&&(t=!0),s.indexOf(e)>=0?(this._shaderComplexity!==e&&(this._shaderComplexity=e,this._limitShaderFeatures()),t&&(localStorage[G]=e)):n?this._shaderComplexity=s[s.length-1]:i.showError("Attempting to set shader complexity to '"+e+"', which is not one of the available options ("+this.getShaderComplexities().join(", ")+").",i.ErrorSeverity.MINOR,"The shader complexity will stay '"+this.getShaderComplexity()+"'."),this._luminosityTextureAreAvailable=this._getShaderComplexityDescriptor()[v.LUMINOSITY_TEXTURES_AVAILABLE.name]},GraphicsSettingsContext.prototype.getShaderComplexities=function(){return this.getShaderConfig(O.COMPLEXITIES).map(function(e){return e[v.NAME.name]})},GraphicsSettingsContext.prototype.getShadowMappingShaderName=function(){return this.getShaderConfig(O.SHADOW_MAPPING_SHADER_NAME)},GraphicsSettingsContext.prototype.isShadowMappingEnabled=function(){return this._shadowMappingEnabled},GraphicsSettingsContext.prototype.setShadowMapping=function(e,i,n){return void 0===e&&(e=void 0!==localStorage[j]?"true"===localStorage[j]:t.getBooleanValue(this._dataJSON.context.shadowMapping,{name:"settings.graphics.context.shadowMapping"}),i=!1,n=!1),void 0===i&&(i=!0),n||!e||this.canEnableShadowMapping()?this._shadowMappingEnabled!==e&&(this._shadowMappingEnabled=e,!n&&e&&this._limitShaderFeatures()):this._shadowMappingEnabled=!1,i&&(localStorage[j]=e.toString()),this._shadowMappingEnabled===e},GraphicsSettingsContext.prototype.getShadowMapQualities=function(){return this._shadowMapQuality.getNameList()},GraphicsSettingsContext.prototype.getShadowMapQuality=function(){return this._shadowMapQuality.getCurrentName()},GraphicsSettingsContext.prototype.getShadowMapTextureSize=function(){return this._shadowMapQuality.getCurrentValue()},GraphicsSettingsContext.prototype.setShadowMapQuality=function(e,t,i){void 0===t&&(t=!0),this._shadowMapQuality.setCurrent(e,i)&&t&&(localStorage[k]=e)},GraphicsSettingsContext.prototype.getShadowRanges=function(){var e,t=[],i=this.getNumShadowMapRanges();for(e=0;e<i;e++)t.push(this._shadowRanges[e]);return t},GraphicsSettingsContext.prototype.getShadowDistances=function(){return this._shadowDistances.getFilteredNameList(function(e){return this._shaderRequirementsAreSatisfied({numShadowRanges:e})}.bind(this))},GraphicsSettingsContext.prototype.getShadowDistance=function(){return this._shadowDistances.getCurrentName()},GraphicsSettingsContext.prototype.getNumShadowMapRanges=function(){return this._shadowMappingEnabled?this._shadowDistances.getCurrentValue():0},GraphicsSettingsContext.prototype.setShadowDistance=function(e,t,i){void 0===t&&(t=!0),this._shadowDistances.setCurrent(e,i)&&t&&(localStorage[W]=e)},GraphicsSettingsContext.prototype.getShadowDepthRatio=function(){return this._shadowDepthRatio},GraphicsSettingsContext.prototype.isAnaglyphRenderingEnabled=function(){return this._dataJSON.stereoscopy.enabled&&"anaglyph"===this._dataJSON.stereoscopy.mode},GraphicsSettingsContext.prototype.getAnaglyphRenderingSettings=function(){return{redShader:this.getManagedShader(this.getShaderConfig(O.ANAGLYPH_RED_SHADER_NAME)),cyanShader:this.getManagedShader(this.getShaderConfig(O.ANAGLYPH_CYAN_SHADER_NAME)),interocularDistance:this._dataJSON.stereoscopy.interocularDistance,convergenceDistance:this._dataJSON.stereoscopy.convergenceDistance}},GraphicsSettingsContext.prototype.isSideBySideRenderingEnabled=function(){return this._dataJSON.stereoscopy.enabled&&"sideBySide"===this._dataJSON.stereoscopy.mode},GraphicsSettingsContext.prototype.getSideBySideRenderingSettings=function(){return{leftShader:this.getManagedShader(this.getShaderConfig(O.SIDE_BY_SIDE_LEFT_SHADER_NAME)),rightShader:this.getManagedShader(this.getShaderConfig(O.SIDE_BY_SIDE_RIGHT_SHADER_NAME)),interocularDistance:this._dataJSON.stereoscopy.interocularDistance,convergenceDistance:this._dataJSON.stereoscopy.convergenceDistance,originalAspect:this._dataJSON.stereoscopy.sideBySideOriginalAspect}},GraphicsSettingsContext.prototype.isShadowMapDebuggingEnabled=function(){return this._dataJSON.shadowMapDebugging.enabled},GraphicsSettingsContext.prototype.getShadowMapDebuggingSettings=function(){return{shader:this.getManagedShader(this.getShaderConfig(O.SHADOW_MAP_DEBUG_SHADER_NAME)),lightIndex:this._dataJSON.shadowMapDebugging.lightIndex,rangeIndex:this._dataJSON.shadowMapDebugging.rangeIndex}},GraphicsSettingsContext.prototype._getShaderComplexityDescriptor=function(e){return void 0===e?this.getShaderConfig(O.COMPLEXITIES).find(function(e){return e[v.NAME.name]===this.getShaderComplexity()}.bind(this),this):this.getShaderConfig(O.COMPLEXITIES)[e]},GraphicsSettingsContext.prototype.getMaxDirLights=function(){return this._getShaderComplexityDescriptor()[v.MAX_DIR_LIGHTS.name]},GraphicsSettingsContext.prototype.getPointLightAmounts=function(){return this._pointLightAmount.getFilteredNameList(function(e){return this._shaderRequirementsAreSatisfied({numPointLights:e})}.bind(this))},GraphicsSettingsContext.prototype.getPointLightAmount=function(){return this._pointLightAmount.getCurrentName()},GraphicsSettingsContext.prototype.getMaxPointLights=function(){return this._pointLightAmount.getCurrentValue()},GraphicsSettingsContext.prototype.setPointLightAmount=function(e,t,i){void 0===t&&(t=!0),this._pointLightAmount.setCurrent(e,i)&&t&&(localStorage[Y]=e)},GraphicsSettingsContext.prototype.getMaxSpotLights=function(){return this._getShaderComplexityDescriptor()[v.MAX_SPOT_LIGHTS.name]},GraphicsSettingsContext.prototype.getParticleAmounts=function(){return this._particleAmount.getNameList()},GraphicsSettingsContext.prototype.getParticleAmount=function(){return this._particleAmount.getCurrentName()},GraphicsSettingsContext.prototype.getParticleCountFactor=function(){return this._particleAmount.getCurrentValue()},GraphicsSettingsContext.prototype.setParticleAmount=function(e,t,i){void 0===t&&(t=!0),this._particleAmount.setCurrent(e,i)&&t&&(localStorage[X]=e)},GraphicsSettingsContext.prototype.getDustParticleAmounts=function(){return this._dustParticleAmount.getNameList()},GraphicsSettingsContext.prototype.getDustParticleAmount=function(){return this._dustParticleAmount.getCurrentName()},GraphicsSettingsContext.prototype.getDustParticleCountFactor=function(){return this._dustParticleAmount.getCurrentValue()},GraphicsSettingsContext.prototype.setDustParticleAmount=function(e,t,i){void 0===t&&(t=!0),this._dustParticleAmount.setCurrent(e,i)&&t&&(localStorage[q]=e)},GraphicsSettingsContext.prototype.getShaderConfig=function(e){return this._shaderConfig[e.name]},GraphicsSettingsContext.prototype.setShaderConfig=function(e,t){this._shaderConfig[e.name]=t},GraphicsSettingsContext.prototype.getNumShadowMapSamples=function(){return this._getShaderComplexityDescriptor()[v.NUM_SHADOW_MAP_SAMPLES.name]},GraphicsSettingsContext.prototype.isShadowMappingAvailable=function(){return this._getShaderComplexityDescriptor()[v.SHADOW_MAPPING_AVAILABLE.name]},GraphicsSettingsContext.prototype.areLuminosityTexturesAvailable=function(){return this._luminosityTextureAreAvailable},GraphicsSettingsContext.prototype.getGroupTransformIdentityArray=function(){return this._groupTransformIdentityArray},GraphicsSettingsContext.prototype.isRevealAvailable=function(){return this._getShaderComplexityDescriptor()[v.REVEAL_AVAILABLE.name]},GraphicsSettingsContext.prototype.areDynamicLightsAvailable=function(){return this._getShaderComplexityDescriptor()[v.DYNAMIC_LIGHTS_AVAILABLE.name]},GraphicsSettingsContext.prototype.canEnableShadowMapping=function(){return this.isShadowMappingAvailable()&&this._shaderRequirementsAreSatisfied({numShadowRanges:this._shadowDistances.getFirstValue()})},GraphicsSettingsContext.prototype.getTexture=function(e,t){return t=t||{},t.qualityPreferenceList=this.getTextureQualityPreferenceList(),o.getTexture(e,t)},GraphicsSettingsContext.prototype.getCubemap=function(e,t){return t=t||{},t.qualityPreferenceList=this.getCubemapQualityPreferenceList(),o.getCubemap(e,t)},GraphicsSettingsContext.prototype.getShader=function(e){return e=o.getVariantShader(e,this.getShaderComplexity())._name,this._shadowMappingEnabled||(e=o.getVariantShader(e,"withoutShadows")._name),0===this._pointLightAmount.getCurrentValue()&&(e=o.getVariantShader(e,"withoutDynamicLights")._name),o.getShader(e)},GraphicsSettingsContext.prototype.getManagedShader=function(e){var t,n={};return n[this.getShaderConfig(O.MAX_DIR_LIGHTS_DEFINE_NAME)]=this.getMaxDirLights(),n[this.getShaderConfig(O.MAX_POINT_LIGHTS_DEFINE_NAME)]=this.getMaxPointLights(),n[this.getShaderConfig(O.MAX_SPOT_LIGHTS_DEFINE_NAME)]=this.getMaxSpotLights(),n[this.getShaderConfig(O.SHADOW_MAP_TEXTURE_SIZE_DEFINE_NAME)]=this.getShadowMapTextureSize()+".0",n[this.getShaderConfig(O.MAX_SHADOW_MAP_RANGES_DEFINE_NAME)]=this.getNumShadowMapRanges(),n[this.getShaderConfig(O.MAX_SHADOW_MAPS_DEFINE_NAME)]=this.getMaxDirLights()*this.getNumShadowMapRanges(),n[this.getShaderConfig(O.NUM_SHADOW_MAP_SAMPLES_DEFINE_NAME)]=this.getNumShadowMapSamples(),n[this.getShaderConfig(O.SHADOW_MAP_DEPTH_RATIO_DEFINE_NAME)]=this.getShadowDepthRatio()+".0",n[this.getShaderConfig(O.DUST_LENGTH_DIVISOR_DEFINE_NAME)]=this.getShaderConfig(O.DUST_LENGTH_DIVISOR),n[this.getShaderConfig(O.MAX_LUMINOSITY_FACTORS_DEFINE_NAME)]=this.getShaderConfig(O.MAX_LUMINOSITY_FACTORS),n[this.getShaderConfig(O.MAX_GROUP_TRANSFORMS_DEFINE_NAME)]=this.getShaderConfig(O.MAX_GROUP_TRANSFORMS),n[this.getShaderConfig(O.DEPTH_TEXTURES_DEFINE_NAME)]=s.areDepthTexturesAvailable()?"1":"0",n[this.getShaderConfig(O.MAX_SHININESS_DEFINE_NAME)]=this.getShaderConfig(O.MAX_SHININESS),n[this.getShaderConfig(O.LISPSM_MINIMUM_NEAR_DEFINE_NAME)]=this.getShaderConfig(O.LISPSM_MINIMUM_NEAR),n[this.getShaderConfig(O.LISPSM_NEAR_FACTOR_DEFINE_NAME)]=this.getShaderConfig(O.LISPSM_NEAR_FACTOR),n[this.getShaderConfig(O.ANAGLYPH_ORIGINAL_COLOR_RATIO_DEFINE_NAME)]=this.getShaderConfig(O.ANAGLYPH_ORIGINAL_COLOR_RATIO),n[this.getShaderConfig(O.ANAGLYPH_GAMMA_DEFINE_NAME)]=this.getShaderConfig(O.ANAGLYPH_GAMMA),n[this.getShaderConfig(O.ANAGLYPH_CYAN_FACTOR_DEFINE_NAME)]=this.getShaderConfig(O.ANAGLYPH_CYAN_FACTOR),t=this.getShader(e).getManagedShader(n,!0),t.isAllowedByRequirements(this._getShaderRequirements())||i.showError("Shader '"+e+"' has too high requirements!"),t},GraphicsSettingsContext.prototype.getModel=function(e){return o.getModel(e,{maxLOD:this.getMaxLoadedLOD()})},GraphicsSettingsContext.prototype.getGeneralLevelNames=function(){return Object.keys(this._generalLevels)},GraphicsSettingsContext.prototype.setGeneralLevel=function(e,t){void 0===t&&(t=!0),e?(this.loadSettingsFromJSON(this._generalLevels[e],!0),t&&(localStorage[D]=e)):t&&localStorage.removeItem(D),this._currentGeneralLevel=e},GraphicsSettingsContext.prototype.getGeneralLevel=function(){return this._currentGeneralLevel},l=new GraphicsSettingsContext,{SHADER_VARIANT_WITHOUT_SHADOWS_NAME:"withoutShadows",SHADER_VARIANT_WITHOUT_DYNAMIC_LIGHTS_NAME:"withoutDynamicLights",loadConfigurationFromJSON:l.loadConfigurationFromJSON.bind(l),loadSettingsFromJSON:l.loadSettingsFromJSON.bind(l),loadSettingsFromLocalStorage:l.loadFromLocalStorage.bind(l),restoreDefaults:l.restoreDefaults.bind(l),getAntialiasing:l.getAntialiasing.bind(l),setAntialiasing:l.setAntialiasing.bind(l),getFiltering:l.getFiltering.bind(l),setFiltering:l.setFiltering.bind(l),getTextureQualities:l.getTextureQualities.bind(l),getTextureQuality:l.getTextureQuality.bind(l),setTextureQuality:l.setTextureQuality.bind(l),getTextureQualityPreferenceList:l.getTextureQualityPreferenceList.bind(l),getCubemapQualities:l.getCubemapQualities.bind(l),getCubemapQuality:l.getCubemapQuality.bind(l),setCubemapQuality:l.setCubemapQuality.bind(l),getCubemapQualityPreferenceList:l.getCubemapQualityPreferenceList.bind(l),getLODLevels:l.getLODLevels.bind(l),getLODLevel:l.getLODLevel.bind(l),getLOD:l.getLOD.bind(l),setLODLevel:l.setLODLevel.bind(l),getMaxLoadedLOD:l.getMaxLoadedLOD.bind(l),getLODContext:l.getLODContext.bind(l),setMissilesInLaunchersVisible:l.setMissilesInLaunchersVisible.bind(l),areMissilesInLaunchersVisible:l.areMissilesInLaunchersVisible.bind(l),getShaderComplexity:l.getShaderComplexity.bind(l),setShaderComplexity:l.setShaderComplexity.bind(l),getShaderComplexities:l.getShaderComplexities.bind(l),getMaxLuminosityFactors:l.getShaderConfig.bind(l,O.MAX_LUMINOSITY_FACTORS),getMaxGroupTransforms:l.getShaderConfig.bind(l,O.MAX_GROUP_TRANSFORMS),getLispsmMinimumNear:getLispsmMinimumNear,getLispsmNearFactor:getLispsmNearFactor,getShadowMappingShaderName:l.getShadowMappingShaderName.bind(l),isShadowMappingEnabled:l.isShadowMappingEnabled.bind(l),setShadowMapping:l.setShadowMapping.bind(l),getShadowMapQualities:l.getShadowMapQualities.bind(l),getShadowMapQuality:l.getShadowMapQuality.bind(l),getShadowMapTextureSize:l.getShadowMapTextureSize.bind(l),setShadowMapQuality:l.setShadowMapQuality.bind(l),getShadowDistances:l.getShadowDistances.bind(l),getShadowDistance:l.getShadowDistance.bind(l),setShadowDistance:l.setShadowDistance.bind(l),getNumShadowMapRanges:l.getNumShadowMapRanges.bind(l),getNumShadowMapSamples:l.getNumShadowMapSamples.bind(l),getMaxDirLights:l.getMaxDirLights.bind(l),getPointLightAmounts:l.getPointLightAmounts.bind(l),getPointLightAmount:l.getPointLightAmount.bind(l),getMaxPointLights:l.getMaxPointLights.bind(l),setPointLightAmount:l.setPointLightAmount.bind(l),getParticleAmounts:l.getParticleAmounts.bind(l),getParticleAmount:l.getParticleAmount.bind(l),getParticleCountFactor:l.getParticleCountFactor.bind(l),setParticleAmount:l.setParticleAmount.bind(l),getDustParticleAmounts:l.getDustParticleAmounts.bind(l),getDustParticleAmount:l.getDustParticleAmount.bind(l),getDustParticleCountFactor:l.getDustParticleCountFactor.bind(l),setDustParticleAmount:l.setDustParticleAmount.bind(l),getMaxSpotLights:l.getMaxSpotLights.bind(l),isShadowMappingAvailable:l.isShadowMappingAvailable.bind(l),areLuminosityTexturesAvailable:l.areLuminosityTexturesAvailable.bind(l),getGroupTransformIdentityArray:l.getGroupTransformIdentityArray.bind(l),isRevealAvailable:l.isRevealAvailable.bind(l),areDynamicLightsAvailable:l.areDynamicLightsAvailable.bind(l),canEnableShadowMapping:l.canEnableShadowMapping.bind(l),getTexture:l.getTexture.bind(l),getCubemap:l.getCubemap.bind(l),getShader:l.getShader.bind(l),getManagedShader:l.getManagedShader.bind(l),getModel:l.getModel.bind(l),getGeneralLevelNames:l.getGeneralLevelNames.bind(l),setGeneralLevel:l.setGeneralLevel.bind(l),getGeneralLevel:l.getGeneralLevel.bind(l),isAnaglyphRenderingEnabled:l.isAnaglyphRenderingEnabled.bind(l),getAnaglyphRenderingSettings:l.getAnaglyphRenderingSettings.bind(l),getAnaglyphOriginalColorRatio:getAnaglyphOriginalColorRatio,getAnaglyphGamma:getAnaglyphGamma,getAnaglyphCyanFactor:getAnaglyphCyanFactor,isSideBySideRenderingEnabled:l.isSideBySideRenderingEnabled.bind(l),getSideBySideRenderingSettings:l.getSideBySideRenderingSettings.bind(l),isShadowMapDebuggingEnabled:l.isShadowMapDebuggingEnabled.bind(l),getShadowMapDebuggingSettings:l.getShadowMapDebuggingSettings.bind(l),shouldUseShadowMapping:shouldUseShadowMapping,getShadowMappingShader:getShadowMappingShader,getShadowMappingSettings:getShadowMappingSettings,getAnaglyphRedShader:getAnaglyphRedShader,getAnaglyphCyanShader:getAnaglyphCyanShader,getSideBySideLeftShader:getSideBySideLeftShader,getSideBySideRightShader:getSideBySideRightShader,getShadowMapDebugShader:getShadowMapDebugShader,onSettingsChange:onSettingsChange,handleSettingsChanged:handleSettingsChanged,executeWhenReady:l.executeWhenReady.bind(l)}}),define("modules/strings",["utils/types","modules/application"],function(e,t){"use strict";function _flatten(e){var t,n;for(t in e)if(e.hasOwnProperty(t)&&"object"==typeof e[t]){_flatten(e[t]);for(n in e[t])e[t].hasOwnProperty(n)&&(e[t+i+n]=e[t][n]);delete e[t]}}var i=".",n={},s=null,o={},r={};return n.getLanguage=function(){return s},n.setLanguage=function(e){r.hasOwnProperty(e)?s=e:t.showError("Cannot set language to '"+e+"', as there are no strings loaded for that language!")},n.languageIsLoaded=function(e){return r.hasOwnProperty(e)},n.loadStrings=function(t,i,a){var l;o[t]={},_flatten(i);for(l in a)a.hasOwnProperty(l)&&"object"==typeof a[l]&&e.getVerifiedObject("strings."+l,i,a[l],o[t],!1,!0,"string");r[t]=e.getVerifiedObject("strings."+l,i,{},null,!0,!0,"string"),s||n.setLanguage(t)},n.get=function(e,t,i){return r[s]&&r[s][e.name+(t||"")]||i||e.defaultValue||e.name+(t||"")},n.has=function(e,t){return r[s]&&void 0!==r[s][e.name+(t||"")]},n.getKeys=function(e){return Object.keys(r[s]).filter(function(t){return 0===t.indexOf(e)})},n.getLocale=function(){return r[s].locale},n.CATEGORY_SEPARATOR=i,n}),define("armada/strings",["modules/strings"],function(e){"use strict";function startsWithVowel(e){var t=e[0].toLowerCase();return"a"===t||"e"===t||"u"===t||"i"===t||"o"===t||"á"===t||"é"===t||"ú"===t||"ü"===t||"ű"===t||"í"===t||"ó"===t||"ö"===t||"ő"===t}return e.GRAMMAR={DEFINITE_ARTICLE_BEFORE_VOWEL:{name:"grammar.definiteArticle.beforeVowel"},DEFINITE_ARTICLE_BEFORE_CONSONANT:{name:"grammar.definiteArticle.beforeConsonant"},AND:{name:"grammar.and"}},e.FIRST_RUN_NOTE={HEADER:{name:"firstRunNote.header"},MESSAGE:{name:"firstRunNote.message"},MESSAGE_WEB:{name:"firstRunNote.messageWeb"},BUTTON:{name:"firstRunNote.button"}},e.RELEASE_NOTES={PREFIX:{name:"releaseNotes.",optional:!0},HEADER:{name:"releaseNotes.header"},GENERAL:{name:"releaseNotes.general"},NO_NEWS:{name:"releaseNotes.noNews"},BUTTON:{name:"releaseNotes.button"}},e.FIRST_MULTI_RUN_NOTE={HEADER:{name:"firstMultiRunNote.header"},MESSAGE:{name:"firstMultiRunNote.message"},OK_BUTTON:{name:"firstMultiRunNote.okButton"},DO_NOT_SHOW_AGAIN_BUTTON:{name:"firstMultiRunNote.doNotShowAgainButton"},CANCEL_BUTTON:{name:"firstMultiRunNote.cancelButton"}},e.SCREEN={BACK:{name:"screen.back"},CANCEL:{name:"screen.cancel"}},e.MAIN_MENU={SINGLE_PLAYER:{name:"mainMenu.singlePlayer"},MULTIPLAYER:{name:"mainMenu.multiplayer"},DATABASE:{name:"mainMenu.database"},SETTINGS:{name:"mainMenu.settings"},ABOUT:{name:"mainMenu.about"},QUIT:{name:"mainMenu.quit"}},e.SINGLE_PLAYER_MENU={CAMPAIGN:{name:"singlePlayer.campaign"},MY_MISSIONS:{name:"singlePlayer.myMissions"},COMMUNITY_MISSIONS:{name:"singlePlayer.communityMissions"}},e.MISSIONS={BACK:{name:"missions.backButton"},CAMPAIGN_TITLE:{name:"missions.campaignTitle"},MY_MISSIONS_TITLE:{name:"missions.myMissionsTitle"},COMMUNITY_MISSIONS_TITLE:{name:"missions.communityMissionsTitle"},DIFFICULTY:{name:"missions.difficulty"},LAUNCH_BUTTON:{name:"missions.launchButton"},DEMO_BUTTON:{name:"missions.demoButton"},FILE_BUTTON:{name:"missions.fileButton"},CUSTOM_MISSION_CAPTION:{name:"missions.customMissionCaption"},CUSTOM_MISSION_SUBCAPTION:{name:"missions.customMissionSubcaption"},COMMUNITY_MISSION_SUBCAPTION:{name:"missions.communityMissionSubcaption"},NOT_COMPLETED:{name:"missions.notCompleted"},BEST_SCORE:{name:"missions.bestScore"},SANDBOX_COMPLETED:{name:"missions.sandboxCompleted"},NO_SELECTED_NAME:{name:"missions.noSelectedName"},NO_SELECTED_DESCRIPTION:{name:"missions.noSelectedDescription"},CUSTOM_DESCRIPTION:{name:"missions.customDescription"},MISSION_HUB_CONNECTING_DESCRIPTION:{name:"missions.missionHubConnectingDescription"},MISSION_HUB_DESCRIPTION:{name:"missions.missionHubDescription"},LOCATION:{name:"missions.location"},CREATED_BY:{name:"missions.createdBy"},LOADING_DESCRIPTION:{name:"missions.loadingDescription"},NO_TRANSLATED_DESCRIPTION:{name:"missions.noTranslatedDescription"},NO_DESCRIPTION:{name:"missions.noDescription"},OBJECTIVES_TITLE:{name:"missions.missionObjectivesTitle"},SPACECRAFT_TITLE:{name:"missions.playerSpacecraftTitle"},SPACECRAFT_DATA:{name:"missions.playerSpacecraftData"},SPACECRAFT_WEAPONS:{name:"missions.playerSpacecraftWeapons"},SPACECRAFT_MISSILES:{name:"missions.playerSpacecraftMissiles"},SPACECRAFT_SHIELD:{name:"missions.playerSpacecraftShield"},SPACECRAFT_PROPULSION:{name:"missions.playerSpacecraftPropulsion"},OBJECTIVE_SUBJECTS_SQUAD:{name:"missions.objectiveSubjects.squad"},OBJECTIVE_SUBJECTS_SQUADS:{name:"missions.objectiveSubjects.squads"},OBJECTIVE_SUBJECTS_TEAM:{name:"missions.objectiveSubjects.team"},OBJECTIVE_SUBJECTS_TEAMS:{name:"missions.objectiveSubjects.teams"},OBJECTIVE_WIN_PREFIX:{name:"missions.winObjective.",optional:!0},OBJECTIVE_LOSE_PREFIX:{name:"missions.loseObjective.",optional:!0},SUBMIT_FILE_BUTTON:{name:"missions.submitFileButton"},SUBMIT_MISSION_ACCEPT_TERMS:{name:"missions.submitMissionAcceptTerms"},SUBMIT_MISSION_SUCCESS:{name:"missions.submitMissionSuccess"},SUBMIT_MISSION_HELP:{name:"missions.submitMissionHelp"},DELETE_SUBMISSION_BUTTON:{name:"missions.deleteSubmissionButton"},REVOKE_SUBMISSION_BUTTON:{name:"missions.revokeSubmissionButton"},DELETE_SUBMISSION_SUCCESS:{name:"missions.deleteSubmissionSuccess"},SUBMISSION_STATUS_PENDING:{name:"missions.submissionStatus.pending"},SUBMISSION_STATUS_APPROVED:{name:"missions.submissionStatus.approved"},SUBMISSION_STATUS_REJECTED:{name:"missions.submissionStatus.rejected"},SUBMISSION_STATS_STARTED:{name:"missions.submissionStats.started"},SUBMISSION_STATS_WON:{name:"missions.submissionStats.won"},SUBMISSION_STATS_LOST:{name:"missions.submissionStats.lost"}},e.SERVER_REGION={PREFIX:{name:"serverRegion.",optional:!0},UNKNOWN:{name:"serverRegion.unknown"},EU:{name:"serverRegion.EU"},US:{name:"serverRegion.US"}},e.MULTI_GAME_MODE={PREFIX:{name:"multiGames.gameMode.",optional:!0}},e.MULTI_GAMES={BACK:{name:"multiGames.backButton"},TITLE:{name:"multiGames.title"},STARTED_YES:{name:"multiGames.started.yes"},STARTED_NO:{name:"multiGames.started.no"},JOIN_BUTTON:{name:"multiGames.joinButton"},GAME_MODE:{name:"multiGames.mode"},MAX_PLAYERS:{name:"multiGames.maxPlayers"},DISCONNECT_MESSAGE:{name:"multiGames.disconnectMessage"},CANNOT_CONNECT_MESSAGE:{name:"multiGames.cannotConnectMessage"},GAME_NOT_FOUND_ERROR:{name:"multiGames.gameNotFoundError"},GAME_IS_FULL_ERROR:{name:"multiGames.gameIsFullError"},GAME_ALREADY_STARTED_ERROR:{name:"multiGames.gameAlreadyStartedError"},PLAYER_NAME_ALREADY_EXISTS_ERROR:{name:"multiGames.playerNameAlreadyExistsError"},GAME_NAME_ALREADY_EXISTS_ERROR:{name:"multiGames.gameNameAlreadyExistsError"},INVALID_GAME_SETTINGS_ERROR:{name:"multiGames.invalidGameSettingsError"},INVALID_PLAYER_NAME_ERROR:{name:"multiGames.invalidPlayerNameError"},INVALID_TEXT_ERROR:{name:"multiGames.invalidTextError"},SERVER_IS_FULL_ERROR:{name:"multiGames.serverIsFullError"},INCOMPATIBLE_API_VERSION_ERROR:{name:"multiGames.incompatibleApiVersionError"},NO_WELCOME_ERROR:{name:"multiGames.noWelcomeError"}},e.MULTI_LOBBY={GAME_TITLE:{name:"multiLobby.gameTitle"},CONNECTION_SERVER:{name:"multiLobby.connection.server"},CONNECTION_DIRECT:{name:"multiLobby.connection.direct"},READY_YES:{name:"multiLobby.ready.yes"},READY_NO:{name:"multiLobby.ready.no"},KICK_BUTTON:{name:"multiLobby.kickButton"},CHAT_MESSAGE_PLACEHOLDER:{name:"multiLobby.chatMessagePlaceholder"},LOCATION_LABEL:{name:"multiLobby.locationLabel"},LOADOUT_LABEL:{name:"multiLobby.loadoutLabel"},LOADOUT_PREFIX:{name:"multiLobby.loadout.",optional:!0},DIFFICULTY_LABEL:{name:"multiLobby.difficultyLabel"},ENEMIES_PER_WAVE_LABEL:{name:"multiLobby.enemiesPerWaveLabel"},HOST_LEFT_MESSAGE:{name:"multiLobby.hostLeftMessage"},KICKED_MESSAGE:{name:"multiLobby.kickedMessage"},GAME_CREATED_MESSAGE:{name:"multiLobby.gameCreatedMessage"},JOINED_MESSAGE:{name:"multiLobby.joinedMessage"},READY_MESSAGE:{name:"multiLobby.readyMessage"},PLAYER_JOINED_MESSAGE:{name:"multiLobby.playerJoinedMessage"},PLAYER_LEFT_MESSAGE:{name:"multiLobby.playerLeftMessage"},PLAYER_READY_MESSAGE:{name:"multiLobby.playerReadyMessage"},PLAYER_KICKED_MESSAGE:{name:"multiLobby.playerKickedMessage"}},e.OBJECTIVE={DESTROY_ALL_SUFFIX:{name:"destroyAll",optional:!0},DESTROY_SUFFIX:{name:"destroy",optional:!0},DESTROY_ONE_SUFFIX:{name:"destroyOne",optional:!0},DESTROY_ANY_SUFFIX:{name:"destroyAny",optional:!0},COUNT_BELOW_SUFFIX:{name:"countBelow",optional:!0},TIME_SUFFIX:{name:"time",optional:!0},TIME_MULTI_SUFFIX:{name:"timeMulti",optional:!0},MAX_HULL_INTEGRITY_SUFFIX:{name:"maxHullIntegrity",optional:!0},MAX_HULL_INTEGRITY_ANY_SUFFIX:{name:"maxHullIntegrityAny",optional:!0},MAX_HULL_INTEGRITY_ONE_SUFFIX:{name:"maxHullIntegrityOne",optional:!0},MAX_HULL_INTEGRITY_SELF_SUFFIX:{name:"maxHullIntegritySelf",optional:!0},DISTANCE_MIN_SUFFIX:{name:"distanceMin",optional:!0},DISTANCE_MAX_SUFFIX:{name:"distanceMax",optional:!0}},e.MISSION_HUB_ERROR={PREFIX:{name:"missionHubError.",optional:!0},DEFAULT_SUFFIX:{name:"default",optional:!0},GENERAL:{name:"missionHubError.general"}},e.MISSION_HUB_CLIENT_ERROR={PREFIX:{name:"missionHubClientError.",optional:!0},GENERAL:{name:"missionHubClientError.general"}},e.LOCATION={UNKNOWN:{name:"location.unknown"},SYSTEM:{name:"location.system"}},e.SETTINGS={GENERAL:{name:"settings.general"},GRAPHICS:{name:"settings.graphics"},AUDIO:{name:"settings.audio"},GAMEPLAY:{name:"settings.gameplay"},CONTROLS:{name:"settings.controls"},DEFAULTS:{name:"settings.defaults"}},e.INGAME_MENU={TITLE:{name:"ingameMenu.title"},RESUME:{name:"ingameMenu.resume"},RESTART:{name:"ingameMenu.restart"},RESTART_HEADER:{name:"ingameMenu.restartDialog.header"},RESTART_MESSAGE:{name:"ingameMenu.restartDialog.message"},RESTART_RESTART:{name:"ingameMenu.restartDialog.restartButton"},QUIT:{name:"ingameMenu.quit"},QUIT_HEADER:{name:"ingameMenu.quitDialog.header"},QUIT_MESSAGE:{name:"ingameMenu.quitDialog.message"},QUIT_TO_MISSIONS:{name:"ingameMenu.quitDialog.quitToMissionsButton"},QUIT_TO_MAIN_MENU:{name:"ingameMenu.quitDialog.quitToMainMenuButton"},QUIT_MULTI:{name:"ingameMenu.quitMulti"},QUIT_MULTI_HEADER:{name:"ingameMenu.quitMultiDialog.header"},QUIT_MULTI_MESSAGE:{name:"ingameMenu.quitMultiDialog.message"},QUIT_TO_SCORE:{name:"ingameMenu.quitMultiDialog.quitToScoreButton"}},e.INFO_BOX={HEADER:{name:"infoBox.header"},OK_BUTTON:{name:"infoBox.okButton"}},e.LOADING={HEADER:{name:"loading.header"},RESOURCES_START:{name:"loading.resourcesStart"},RESOURCE_READY:{name:"loading.resourceReady"},INIT_WEBGL:{name:"loading.initWebGL"},READY:{name:"loading.ready"}},e.SPACECRAFT_STATS={ARMOR:{name:"spacecraftStats.armor"},ARMOR_RATING:{name:"spacecraftStats.armorRating"}},e.MISSION={PREFIX:{name:"mission.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0},MESSAGES_SUFFIX:{name:".messages.",optional:!0}},e.FACTION={PREFIX:{name:"faction.",optional:!0}},e.SQUAD={PREFIX:{name:"squad.",optional:!0}},e.BATTLE={DEVELOPMENT_VERSION_NOTICE:{name:"battle.developmentVersionNotice"},SPECTATOR_MODE:{name:"battle.spectatorMode"},SCORE:{name:"battle.score"},HUD_FIREPOWER:{name:"battle.hud.firepower"},HUD_DISTANCE:{name:"battle.hud.distance"},HUD_VELOCITY:{name:"battle.hud.velocity"},HUD_SPACECRAFT_NAME_UNKNOWN:{name:"battle.hud.spacecraftNameUnknown"},HUD_TEAM_UNKNOWN:{name:"battle.hud.teamUnknown"},HUD_WINGMEN_HEADER:{name:"battle.hud.wingmenHeader"},HUD_FLIGHT_MODE:{name:"battle.hud.flightMode"},HUD_MISSILES:{name:"battle.hud.missiles"},HUD_OBJECTIVES:{name:"battle.hud.objectives"},HUD_ESCORTED_SHIPS_HEADER:{name:"battle.hud.escortedShipsHeader"},OBJECTIVE_SUBJECTS_SPACECRAFTS:{name:"battle.objectiveSubjects.spacecrafts"},OBJECTIVE_SUBJECTS_SQUADS:{name:"battle.objectiveSubjects.squads"},OBJECTIVE_SUBJECTS_TEAMS:{name:"battle.objectiveSubjects.teams"},OBJECTIVE_WIN_PREFIX:{name:"battle.winObjective.",optional:!0},OBJECTIVE_LOSE_PREFIX:{name:"battle.loseObjective.",optional:!0},LOADING_BOX_LOADING_MISSION:{name:"battle.loadingBox.loadingMission"},LOADING_BOX_BUILDING_SCENE:{name:"battle.loadingBox.buildingScene"},MESSAGE_READY:{name:"battle.message.ready"},MESSAGE_PAUSED:{name:"battle.message.paused"},MESSAGE_VICTORY:{name:"battle.message.victory"},MESSAGE_FAIL:{name:"battle.message.fail"},MESSAGE_DEFEAT_HEADER:{name:"battle.message.defeat.header"},MESSAGE_DEFEAT_MESSAGE:{name:"battle.message.defeat.message"},MESSAGE_DEFEAT_DEBRIEFING:{name:"battle.message.defeat.debriefingButton"},MESSAGE_DEFEAT_RESTART:{name:"battle.message.defeat.restartButton"},MESSAGE_DEFEAT_SPECTATE:{name:"battle.message.defeat.spectateButton"},MESSAGE_JUMP_ENGAGED:{name:"battle.message.jump.engaged"},MESSAGE_JUMP_PREPARING:{name:"battle.message.jump.preparing"},MESSAGE_NEW_HOSTILES:{name:"battle.message.newHostiles"}},e.MULTI_BATTLE={WAITING_FOR_OTHER_PLAYERS:{name:"battle.multi.waitingForOtherPlayers"},HOST_LEFT_MESSAGE:{name:"battle.multi.hostLeftMessage"},PLAYER_LEFT_MESSAGE:{name:"battle.multi.playerLeftMessage"},ALL_PLAYERS_LEFT_MESSAGE:{name:"battle.multi.allPlayersLeftMessage"},SLOW_CONNECTION:{name:"battle.multi.slowConnection"},CONNECTION_LOST:{name:"battle.multi.connectionLost"},CONNECTION_TIMEOUT:{name:"battle.multi.connectionTimeout"}},e.PERFORMANCE_LEVEL={PREFIX:{name:"performanceLevel.",optional:!0}},e.DEBRIEFING={BACK:{name:"debriefing.backButton"},VICTORY_TITLE:{name:"debriefing.victoryTitle"},DEFEAT_TITLE:{name:"debriefing.defeatTitle"},GENERIC_TITLE:{name:"debriefing.genericTitle"},SCORE:{name:"debriefing.score"},NEW_RECORD:{name:"debriefing.newRecord"},DESCRIPTION_VICTORY:{name:"debriefing.description.victory"},DESCRIPTION_NEXT_PERFORMANCE:{name:"debriefing.description.nextPerformance"},DESCRIPTION_FAIL:{name:"debriefing.description.fail"},DESCRIPTION_DEFEAT:{name:"debriefing.description.defeat"},DESCRIPTION_LEFT_EARLY:{name:"debriefing.description.leftEarly"},DESCRIPTION_GENERIC:{name:"debriefing.description.generic"},OBJECTIVES_HEADER:{name:"debriefing.objectivesHeader"},COMPLETED:{name:"debriefing.completed"},FAILED:{name:"debriefing.failed"},STATISTICS_HEADER:{name:"debriefing.statisticsHeader"},TIME_LABEL_CELL:{name:"debriefing.timeLabelCell"},KILLS_LABEL_CELL:{name:"debriefing.killsLabelCell"},DAMAGE_LABEL_CELL:{name:"debriefing.damageLabelCell"},HIT_RATIO_LABEL_CELL:{name:"debriefing.hitRatioLabelCell"},HULL_INTEGRITY_LABEL_CELL:{name:"debriefing.hullIntegrityLabelCell"},TEAM_SURVIVAL_LABEL_CELL:{name:"debriefing.teamSurvivalLabelCell"},BASE_SCORE_LABEL_CELL:{name:"debriefing.baseScoreLabelCell"},HIT_RATIO_BONUS_LABEL_CELL:{name:"debriefing.hitRatioBonusLabelCell"},HULL_INTEGRITY_BONUS_LABEL_CELL:{name:"debriefing.hullIntegrityBonusLabelCell"},TEAM_SURVIVAL_BONUS_LABEL_CELL:{name:"debriefing.teamSurvivalBonusLabelCell"},SCORE_BREAKDOWN_HEADER:{name:"debriefing.scoreBreakdownHeader"},RESTART_BUTTON:{name:"debriefing.restartButton"}},e.MULTI_SCORE={TITLE:{name:"multiScore.title"}},e.DATABASE={BACK:{name:"database.backButton"},TITLE:{name:"database.title"},PREV_BUTTON:{name:"database.prevButton"},NEXT_BUTTON:{name:"database.nextButton"},LOADING_BOX_INITIALIZING:{name:"database.loadingBox.initializing"},LENGTH:{name:"database.length"},HEIGHT:{name:"database.height"},WEAPON_SLOTS:{name:"database.weaponSlots"},MISSILE_LAUNCHERS:{name:"database.missileLaunchers"},LOCK_RESIST:{name:"database.lockResist"},MISSING_SPACECRAFT_TYPE_DESCRIPTION:{name:"database.missingSpacecraftTypeDescription"},MISSING_SPACECRAFT_CLASS_DESCRIPTION:{name:"database.missingSpacecraftClassDescription"}},e.ABOUT={BACK:{name:"about.backButton"},TITLE:{name:"about.title"},VERSION_PARAGRAPH:{name:"about.versionParagraph"},ABOUT_GAME_PARAGRAPH:{name:"about.aboutGameParagraph"},ABOUT_GAME_DEV_PARAGRAPH:{name:"about.aboutGameDevParagraph"},LICENSE_NOTE:{name:"about.licenseNote"},CREDITS_HEADER:{name:"about.creditsHeader"
},CREDITS_GAME_DESIGN:{name:"about.creditsGameDesign"},CREDITS_PROGRAMMING:{name:"about.creditsProgramming"},CREDITS_REQUIREJS_NOTE:{name:"about.creditsRequireJSNote"},CREDITS_FONTS:{name:"about.creditsFonts"},CREDITS_MODELS_TEXTURES_MUSIC:{name:"about.credits3DModelsTexturesMusic"},CREDITS_SFX:{name:"about.creditsSoundEffects"},CREDITS_FREESOUND_NOTE:{name:"about.creditsFreesoundNote"},CREDITS_OTHER_SOUNDS_NOTE:{name:"about.creditsOtherSoundsNote"},CREDITS_SOUND_LICENSE_NOTE:{name:"about.creditsSoundLicenseNote"},CREDITS_TESTING:{name:"about.creditsTesting"},USED_SOFTWARE_HEADER:{name:"about.usedSoftwareHeader"},USED_SOFTWARE_PARAGRAPH:{name:"about.usedSoftwareParagraph"},LICENSE_HEADER:{name:"about.licenseHeader"},LICENSE_PARAGRAPH:{name:"about.licenseParagraph"},REQUIRE_JS_LICENSE:{name:"about.requireJSLicense"},ELECTRON_LICENSE:{name:"about.electronLicense"},HERE:{name:"about.here"}},e.SETTING={PREFIX:{name:"setting.",optional:!0},ON:{name:"setting.on"},OFF:{name:"setting.off"},VERY_LOW:{name:"setting.veryLow"},LOW:{name:"setting.low"},MEDIUM:{name:"setting.medium"},HIGH:{name:"setting.high"},VERY_HIGH:{name:"setting.veryHigh"},NORMAL:{name:"setting.normal"},MINIMUM:{name:"setting.minimum"},MAXIMUM:{name:"setting.maximum"},FEW:{name:"setting.few"},MANY:{name:"setting.many"},EASY:{name:"setting.easy"},HARD:{name:"setting.hard"},CUSTOM:{name:"setting.custom"}},e.GENERAL_SETTINGS={BACK:{name:"generalSettings.backButton"},TITLE:{name:"generalSettings.title"},LANGUAGE:{name:"generalSettings.language"},ANALYTICS:{name:"generalSettings.analytics"},ANALYTICS_NOTE:{name:"generalSettings.analyticsNote"},SHOW_DEMO_BUTTON:{name:"generalSettings.showDemoButton"}},e.GRAPHICS={PREFIX:{name:"graphics.",optional:!0},BACK:{name:"graphics.backButton"},TITLE:{name:"graphics.title"},GENERAL_LEVEL:{name:"graphics.generalLevel"},ANTIALIASING:{name:"graphics.antialiasing"},FILTERING:{name:"graphics.filtering"},BILINEAR:{name:"graphics.bilinear"},TRILINEAR:{name:"graphics.trilinear"},ANISOTROPIC:{name:"graphics.anisotropic"},TEXTURE_QUALITY:{name:"graphics.textureQuality"},BACKGROUND_QUALITY:{name:"graphics.backgroundQuality"},MODEL_DETAILS:{name:"graphics.modelDetails"},MISSILES_IN_LAUNCHERS:{name:"graphics.missilesInLaunchers"},SHADERS:{name:"graphics.shaders"},SHADOWS:{name:"graphics.shadows"},SHADOW_QUALITY:{name:"graphics.shadowQuality"},SHADOW_DISTANCE:{name:"graphics.shadowDistance"},MAX_DYNAMIC_LIGHTS:{name:"graphics.maxDynamicLights"},PARTICLE_AMOUNT:{name:"graphics.particleAmount"},DUST_PARTICLE_AMOUNT:{name:"graphics.dustParticleAmount"}},e.GAMEPLAY_SETTINGS={PREFIX:{name:"gameplaySettings.",optional:!0},BACK:{name:"gameplaySettings.backButton"},TITLE:{name:"gameplaySettings.title"},HUD_TITLE:{name:"gameplaySettings.hudTitle"},CAMERA_TITLE:{name:"gameplaySettings.cameraTitle"},CONTROLS_TITLE:{name:"gameplaySettings.controlsTitle"},OTHER_TITLE:{name:"gameplaySettings.otherTitle"},TARGET_HEALTH_AT_CENTER:{name:"gameplaySettings.targetHealthAtCenter"},OFFSET_IMPACT_INDICATORS:{name:"gameplaySettings.offsetImpactIndicators"},RELATIVE_TARGET_ORIENTATION:{name:"gameplaySettings.relativeTargetOrientation"},SHOW_VERSION_INFO:{name:"gameplaySettings.showVersionInfo"},SHOW_FPS_COUNTER:{name:"gameplaySettings.showFpsCounter"},PREFERRED_FIGHTER_VIEW:{name:"gameplaySettings.preferredFighterView"},PREFERRED_SHIP_VIEW:{name:"gameplaySettings.preferredShipView"},DEMO_VIEW_SWITCHING:{name:"gameplaySettings.demoViewSwitching"},DEFAULT_SALVO_MODE:{name:"gameplaySettings.defaultSalvoMode"},SHOW_READY_MESSAGE:{name:"gameplaySettings.showReadyMessage"}},e.AUDIO={PREFIX:{name:"audio.",optional:!0},BACK:{name:"audio.backButton"},TITLE:{name:"audio.title"},MASTER_VOLUME:{name:"audio.masterVolume"},MUSIC_VOLUME:{name:"audio.musicVolume"},SFX_VOLUME:{name:"audio.sfxVolume"},UI_VOLUME:{name:"audio.uiVolume"}},e.CONTOLLER={PREFIX:{name:"controller.",optional:!0},GENERAL:{name:"controller.general"},FIGHTER:{name:"controller.fighter"},CAMERA:{name:"controller.camera"}},e.INPUT={DEVICE_NAME_PREFIX:{name:"inputDevice.",optional:!0},DEVICE_KEYBOARD:{name:"inputDevice.keyboard"},DEVICE_MOUSE:{name:"inputDevice.mouse"},DEVICE_JOYSTICK:{name:"inputDevice.joystick"}},e.TOUCH_AREA={PREFIX:{name:"touchArea.",optional:!0},DEFAULT:{name:"touchArea.default"}},e.CONTROLLER_PROFILE={PREFIX:{name:"controllerProfile.",optional:!0},NONE:{name:"controllerProfile.none"}},e.CONTROLS={BACK:{name:"controls.backButton"},SETTINGS_TITLE:{name:"controls.settingsTitle"},TITLE:{name:"controls.title"},MOUSE_TURN_SENSITIVITY:{name:"controls.mouseTurnSensitivity"},POINTER_LOCK:{name:"controls.pointerLock"},CONTROLLER:{name:"controls.controller"},CONTROLLER_DISABLED:{name:"controls.controllerDisabled"},CONTROLLER_PROFILE:{name:"controls.controllerProfile"},VIBRATION_ENABLED:{name:"controls.vibrationEnabled"},CONTROLLER_TYPE_HEADING:{name:"controls.controllerHeading"},ACTION:{name:"controls.action"}},e.ACTION_DESCRIPTIONS={PREFIX:{name:"actionDescriptions.",optional:!0}},e.SPACECRAFT_CLASS={PREFIX:{name:"spacecraftClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},e.SPACECRAFT_TYPE={PREFIX:{name:"spacecraftType.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},e.WEAPON_CLASS={PREFIX:{name:"weaponClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},e.MISSILE_CLASS={PREFIX:{name:"missileClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},e.PROPULSION_CLASS={PREFIX:{name:"propulsionClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},e.SENSORS_CLASS={PREFIX:{name:"sensorsClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},e.SHIELD_CLASS={PREFIX:{name:"shieldClass.",optional:!0},NAME_SUFFIX:{name:".name",optional:!0},DESCRIPTION_SUFFIX:{name:".description",optional:!0}},e.MISSILE_SIZE={PREFIX:{name:"missileSize.",optional:!0}},e.OBJECT_VIEW={PREFIX:{name:"objectView.",optional:!0}},e.FLIGHT_MODE={PREFIX:{name:"flightMode.",optional:!0}},e.TIP={PREFIX:{name:"tip.",optional:!0}},e.getDefiniteArticleForWord=function(t){return e.get(startsWithVowel(t)?e.GRAMMAR.DEFINITE_ARTICLE_BEFORE_VOWEL:e.GRAMMAR.DEFINITE_ARTICLE_BEFORE_CONSONANT)},e.getList=function(t){var i,n;for(i=t[0],n=1;n<t.length-1;n++)i+=", "+t[n];return t.length>1&&(i+=" "+e.get(e.GRAMMAR.AND)+" "+t[t.length-1]),i},e.getOnOffSettingValues=function(){return[e.get(e.SETTING.OFF),e.get(e.SETTING.ON)]},e.getOffSettingValue=function(){return[e.get(e.SETTING.OFF)]},e}),define("armada/logic/classes",["utils/utils","utils/types","utils/vectors","utils/matrices","modules/application","modules/resource-manager","modules/egom-model","modules/physics","modules/media-resources","modules/scene/camera","modules/scene/renderable-objects","armada/graphics","armada/strings"],function(e,t,i,n,s,o,r,a,l,c,h,u,d){"use strict";function getSkyboxClass(e){return p.getResource(C,e)}function getBackgroundObjectClass(e){return p.getResource(M,e)}function getDustCloudClass(e){return p.getResource(I,e)}function getExplosionClass(e){return p.getResource(A,e)}function getProjectileClass(e){return p.getResource(x,e)}function getMissileClass(e){return p.getResource(v,e)}function getWeaponClass(e){return p.getResource(O,e)}function getPropulsionClass(e){return p.getResource(R,e)}function getSensorsClass(e){return p.getResource(b,e)}function getJumpEngineClass(e){return p.getResource(L,e)}function getShieldClass(e){return p.getResource(N,e)}function getSpacecraftType(e){return p.getResource(D,e)}function getSpacecraftClass(e,t){return p.getResource(P,e,{allowNullResult:t})}function getSpacecraftClassesInArray(e){var t,i=[],n=p.getResourceNames(P);for(t=0;t<n.length;t++)e&&!getSpacecraftClass(n[t]).shouldShowInDatabase()||i.push(getSpacecraftClass(n[t]));return i}function getClassCategories(){return p.getResourceTypes()}function getClassNames(e){return p.getResourceNames(e)}function getClass(e,t,i){return p.getResource(e,t,i)}function _showMissingPropertyError(e,t){s.showError("Cannot initialize "+e.constructor.name+" without correctly specifying its property '"+t+"'!",s.ErrorSeverity.SEVERE,"The property was either not specified, or it was specified with a wrong type or an invalid value."+("string"==typeof e._name?"The error happened while initializing '"+e._name+"'":""))}function _missingNumber(e,t){return _showMissingPropertyError(e,t),0}function _missingString(e,t){return _showMissingPropertyError(e,t),""}function _missingVector2(e,t){return _showMissingPropertyError(e,t),[0,0]}function _missingVector3(e,t){return _showMissingPropertyError(e,t),[0,0,0]}function _missingArray(e,t){return _showMissingPropertyError(e,t),[]}function _missingObject(e,t){return _showMissingPropertyError(e,t),null}function _loadSoundEffect(e){e.resource=l.getSoundEffect(e.name)}function _playSoundEffect(e,t){e.resource.play(e.volume,t)}function _createSoundClip(e,t,i,n,s,o){return e.resource?e.resource.createSoundClip(l.SoundCategory.SOUND_EFFECT,e.volume,t,n,s,o,i):null}function _loadThrusterSlots(e,t,n){var s,o,r,a,l,c,h,u,d;for(s=0;s<e.thrusterSlots.length;s++){if(r=e.thrusterSlots[s].group,a=e.thrusterSlots[s].uses,e.thrusterSlots[s].count>0)for(l=e.thrusterSlots[s].position||_missingVector3(t,"thrusterSlot array position"),c=e.thrusterSlots[s].vector||_missingVector3(t,"thrusterSlot array vector"),h=e.thrusterSlots[s].size||_missingNumber(t,"thrusterSlot array size"),u=e.thrusterSlots[s].count,o=0;o<u;o++)n.push(new ThrusterSlot({position:i.sum3(l,i.scaled3Aux(c,o)),size:h,groupIndex:r,uses:a}));if(e.thrusterSlots[s].thrusters)for(o=0;o<e.thrusterSlots[s].thrusters.length;o++)d=Object.assign({},e.thrusterSlots[s].thrusters[o]),d.groupIndex=r,d.uses=a,n.push(new ThrusterSlot(d))}}function _getLoadoutProperty(e,t,i){var n,s;for(n=0,s=e[i];void 0===s&&n<t.length;n++)s=t[n][i];return s||null}function GenericClass(e,t){o.JSONResource.call(this,e,_,t)}function ShadedClass(e,t){GenericClass.call(this,e,t)}function ShadedModelClass(e,t){ShadedClass.call(this,e,t)}function SkyboxClass(e){ShadedModelClass.call(this,e)}function TexturedModelClass(e,t){ShadedModelClass.call(this,e,t)}function ParticleDescriptor(e){TexturedModelClass.call(this,e,!0)}function TrailDescriptor(e){TexturedModelClass.call(this,e,!0)}function BackgroundObjectClass(e){GenericClass.call(this,e)}function DustCloudClass(e){ShadedModelClass.call(this,e)}function ParticleEmitterDescriptor(e){TexturedModelClass.call(this,e,!0)}function ExplosionClass(e){GenericClass.call(this,e)}function ProjectileClass(e){TexturedModelClass.call(this,e)}function MissileClass(e){TexturedModelClass.call(this,e)}function Barrel(e){this._positionVector=e?e.position?e.position.slice():_missingVector3(this,"position"):null,this._positionVector&&this._positionVector.push(1)}function WeaponRotator(e){this.axis=t.getValueOfType("WeaponRotator.axis",t.VECTOR3,e.axis),this.center=t.getValueOfType("WeaponRotator.center",t.VECTOR3,e.center),this.range=t.getValueOfType("WeaponRotator.range",t.VECTOR2,e.range,null,!0),this.range&&(this.range[0]=Math.radians(this.range[0]),this.range[1]=Math.radians(this.range[1])),this.defaultAngle=Math.radians(t.getValueOfType("WeaponRotator.defaultAngle",t.NUMBER,e.defaultAngle,0,!0)),this.restricted=!!this.range,this.rotationRate=Math.radians(t.getValueOfType("WeaponRotator.rotationRate",t.NUMBER,e.rotationRate)),this.transformGroupIndex=t.getValueOfType("WeaponRotator.transformGroupIndex",t.NUMBER,e.transformGroupIndex)}function WeaponClass(e){TexturedModelClass.call(this,e)}function PropulsionClass(e){GenericClass.call(this,e)}function SensorsClass(e){GenericClass.call(this,e)}function JumpEngineClass(e){GenericClass.call(this,e)}function ShieldClass(e){GenericClass.call(this,e)}function SpacecraftType(e){GenericClass.call(this,e)}function WeaponSlot(e){this.positionMatrix=e?n.translation4v(e.position||_missingVector3(this,"position")):null,this.orientationMatrix=e?n.rotation4FromJSON(e.rotations||[]):null,this.clear=!!e&&(e.clear||!1)}function MissileLauncherDescriptor(t){var s,o,r;if(this.tubePositions=t?t.tubes?[]:_missingArray(this,"tubes"):null,this.tubePositions)for(s=0;s<t.tubes.length;s++)if(r=t.tubes[s],r.count>1)for(o=0;o<r.count;o++)this.tubePositions.push(i.sum3(r.position,i.scaled3Aux(r.vector,o)));else this.tubePositions.push(r.position);this.orientationMatrix=t?n.rotation4FromJSON(t.rotations||[]):null,this.size=t?e.getSafeEnumValue(S,t.size,null)||_missingString(this,"size"):null,this.capacity=t?t.capacity||_missingNumber(this,"capacity"):0,this.salvo=t?t.salvo||1:0}function ThrusterSlot(e){this.positionVector=e?e.position.slice()||_missingVector3(this,"position"):null,this.positionVector&&this.positionVector.push(1),this.size=e?e.size||1:0,this.uses=e?e.uses||_missingArray(this,"uses"):null,this.group=e?"number"==typeof e.groupIndex?e.groupIndex:_missingNumber(this,"groupIndex"):0}function WeaponDescriptor(e){this.className=e?e.class||_missingString(this,"class"):null,this.slotIndex=e?e.slotIndex:-1}function MissileDescriptor(e){this.className=e?e.class||_missingString(this,"class"):null,this.launcherIndex=e?e.launcherIndex:-1,this.amount=e?e.amount||_missingNumber(this,"amount"):0}function PropulsionDescriptor(e){this.className=e?e.class||_missingString(this,"class"):null}function SensorsDescriptor(e){this.className=e?e.class||_missingString(this,"class"):null}function JumpEngineDescriptor(e){this.className=e?e.class||_missingString(this,"class"):null}function ShieldDescriptor(e){this.className=e?e.class||_missingString(this,"class"):null}function Loadout(e,t,i){var n,o,r,a,l,c,h,u,d,p,_=[];if(t)for(r=!1,o=e.basedOn;o;){for(a=!1,n=0;n<t.length;n++)if(t[n].name===o){_.indexOf(t[n])<0?(a=!0,_.push(t[n]),o=t[n].basedOn):(r=!0,o=null);break}r?s.showError("Circular reference detected in loadout '"+e.name+"'!"):a||(s.showError("Could not find referenced loadout '"+o+"'!"),o=null)}if(this._name=e.name||"custom",this._wDescriptors=[],l=_getLoadoutProperty(e,_,"weapons"))for(n=0;n<l.length;n++)this._wDescriptors.push(new WeaponDescriptor(l[n]));else i&&(this._wDescriptors=i._wDescriptors);if(this._mDescriptors=[],c=_getLoadoutProperty(e,_,"missiles"))for(n=0;n<c.length;n++)this._mDescriptors.push(new MissileDescriptor(c[n]));else i&&(this._mDescriptors=i._mDescriptors);h=_getLoadoutProperty(e,_,"propulsion"),this._propulsionDescriptor=h?new PropulsionDescriptor(h):i?i._propulsionDescriptor:null,u=_getLoadoutProperty(e,_,"sensors"),this._sensorsDescriptor=u?new SensorsDescriptor(u):i?i._sensorsDescriptor:null,d=_getLoadoutProperty(e,_,"jumpEngine"),this._jumpEngineDescriptor=d?new JumpEngineDescriptor(d):i?i._jumpEngineDescriptor:null,p=_getLoadoutProperty(e,_,"shield"),this._shieldDescriptor=p?new ShieldDescriptor(p):i?i._shieldDescriptor:null}function GenericView(t){this._name=t?t.name||_missingString(this,"name"):null,this._fps=!!t&&("boolean"==typeof t.fps&&t.fps),this._fov=t?t.fov||0:0,this._fovRange=t?t.fovRange||null:null,this._movable=!!t&&!0===t.movable,this._turnable=!!t&&!0===t.turnable,this.pM=t?n.translation4v(t.position||_missingVector3(this,"position")):null,this.oM=t?n.rotation4FromJSON(t.rotations):null,this._alphaRange=t&&this._fps?t.alphaRange||[-360,360]:[0,0],this._betaRange=t&&this._fps?t.betaRange||[-90,90]:[0,0],this._span=t?t.span||0:0,this._confines=t?t.confines||null:null,this._resetsWhenLeavingConfines=!!t&&("boolean"==typeof t.resetsWhenLeavingConfines&&t.resetsWhenLeavingConfines),this._baseOrientation=t&&t.baseOrientation?e.getSafeEnumValue(c.CameraOrientationConfiguration.BaseOrientation,t.baseOrientation)||s.showError("Invalid value '"+t.baseOrientation+"' specified for view baseOrientation!",s.ErrorSeverity.MINOR,"Valid values are: "+e.getEnumValues(c.CameraOrientationConfiguration.BaseOrientation).join(", ")+"."):null,this._pointToFallback=t&&t.pointToFallback?e.getSafeEnumValue(c.CameraOrientationConfiguration.PointToFallback,t.pointToFallback)||s.showError("Invalid value '"+t.pointToFallback+"' specified for view pointToFallback!",s.ErrorSeverity.MINOR,"Valid values are: "+e.getEnumValues(c.CameraOrientationConfiguration.PointToFallback).join(", ")+"."):null,this._excludeFromCycle=!!t&&("boolean"==typeof t.excludeFromCycle&&t.excludeFromCycle)}function ObjectView(t){var i;GenericView.call(this,t),i=e.getSafeEnumValue(m,t.lookAt,m.NONE),this._isAimingView=!0===t.aimingView,this._followsPosition=void 0!==t.followsPosition?t.followsPosition:i!==m.SELF,this._followsOrientation=void 0!==t.followsOrientation?t.followsOrientation:i===m.NONE,this._lookAtSelf=i===m.SELF&&(!(this._followsPosition||this._followsOrientation||this._turnable)||s.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'self' if followsPosition, followsOrientation or turnable are true!")),this._lookAtTarget=i===m.TARGET&&(!this._followsOrientation&&!this._turnable||s.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'target' if followsOrientation or turnable are true!")),this._rotationCenterIsObject="boolean"==typeof t.rotationCenterIsObject&&(!!t.rotationCenterIsObject&&(!(this._lookAtSelf||!this._followsPosition)||s.showError("Invalid view configuration ('"+this._name+"'): rotationCenterIsObject with lookAtSelf or without followsPosition!"))),this._startsWithRelativePosition=!0===t.startsWithRelativePosition&&(!this._followsPosition&&!this._rotationCenterIsObject||s.showError("Invalid view configuration ('"+this._name+"'): startsWithRelativePosition cannot be set to true if followsPosition or rotationCenterIsObject are true!")),this._distanceRange=(this._rotationCenterIsObject||this._lookAtSelf||this._lookAtTarget)&&this._movable?t.distanceRange||_missingVector2(this,"distanceRange"):t.distanceRange||null,this._movesRelativeToObject=!0===t.movesRelativeToObject&&(!(this._rotationCenterIsObject||!this._followsPosition||!this._followsOrientation)||s.showError("Invalid view configuration ('"+this._name+"'): movesRelativeToObject can only be set if both position and orientation is followed and rotationCenterIsObject is false!")),this._resetsOnFocusChange="boolean"==typeof t.resetsOnFocusChange&&t.resetsOnFocusChange,!this._followsPosition&&!this._startsWithRelativePosition&&(this._lookAtSelf||this._lookAtTarget)&&this._confines&&this._distanceRange&&s.showError("Invalid view configuration ('"+this._name+"'): A lookAt configuration with absolute position cannot have both position and distance confines!",s.ErrorSeverity.SEVERE,"Setting this configuration will likely cause a crash as position confines are absolute (if the position is absolute) but distance confines are relative to the lookAt object."),this._followsPosition||this._startsWithRelativePosition||!this._resetsWhenLeavingConfines||s.showError("Invalid view configuration ('"+this._name+"'): resetsWhenLeavingConfines cannot be set if position is absolute!")}function SceneView(t){GenericView.call(this,t),this._turnAroundAll="boolean"==typeof t.turnAroundAll&&t.turnAroundAll,this._lookAtAll=e.getSafeEnumValue(f,t.lookAt,f.NONE)===f.ALL&&(!this._turnAroundAll&&!this._turnable||s.showError("Invalid view configuration ('"+this._name+"'): lookAt mode cannot be 'all' if turnAroundAll or turnable are true!")),this._distanceRange=(this._turnAroundAll||this._lookAtAll)&&this._movable?t.distanceRange||_missingVector2(this,"distanceRange"):t.distanceRange||null,this._startsWithRelativePosition=!0===t.startsWithRelativePosition&&(!this._turnAroundAll||s.showError("Invalid view configuration ('"+this._name+"'): startsWithRelativePosition cannot be true if the view is set to turn around the objects!")),!this._turnAroundAll&&!this._startsWithRelativePosition&&this._lookAtAll&&this._confines&&this._distanceRange&&s.showError("Invalid view configuration ('"+this._name+"'): A lookAt configuration with absolute position cannot have both position and distance confines!",s.ErrorSeverity.SEVERE,"Setting this configuration will likely cause a crash as position confines are absolute (if the position is absolute) but distance confines are relative to the lookAt object."),this._turnAroundAll||this._startsWithRelativePosition||!this._resetsWhenLeavingConfines||s.showError("Invalid view configuration ('"+this._name+"'): resetsWhenLeavingConfines cannot be set if position is absolute!")}function DamageIndicator(e){this.hullIntegrity=e?e.hullIntegrity||_missingNumber(this,"hullIntegrity"):0,this.explosionClass=e?getExplosionClass(e.class||_missingString(this,"class")):null}function LightSourceDescriptor(e){this.position=e?e.position||_missingVector3(this,"position"):null,this.color=e?e.color||[1,1,1]:null,this.intensity=e?e.intensity||_missingNumber(this,"intensity"):0,this.spotDirection=e?e.spotDirection||null:null,this.spotCutoffAngle=e?e.spotCutoffAngle||0:0,this.spotFullIntensityAngle=e?e.spotFullIntensityAngle||0:0}function BlinkerDescriptor(e){this._particle=null,e.particle?this._particle=new ParticleDescriptor(e.particle):_showMissingPropertyError(this,"particle"),this._position=e?e.position||_missingVector3(this,"position"):null,this._period=e?e.period||_missingNumber(this,"period"):0,this._blinks=e?e.blinks||_missingArray(this,"blinks"):null,this._intensity=e?e.intensity||_missingNumber(this,"intensity"):0,this._lightColor=this._particle?[this._particle._color[0],this._particle._color[1],this._particle._color[2]]:null}function SpacecraftClass(e){TexturedModelClass.call(this,e)}function requestLoad(e,t){var i={};i[C]=SkyboxClass,i[M]=BackgroundObjectClass,i[I]=DustCloudClass,i[A]=ExplosionClass,i[x]=ProjectileClass,i[O]=WeaponClass,i[R]=PropulsionClass,i[b]=SensorsClass,i[v]=MissileClass,i[L]=JumpEngineClass,i[N]=ShieldClass,i[D]=SpacecraftType,i[P]=SpacecraftClass,p.requestConfigLoad(e.filename,e.folder,i,function(){p.requestAllResources(),p.requestResourceLoad(),t&&t()}),_=e.folder}var p,_,g={OMNIDIRECTIONAL:"omnidirectional",UNIDIRECTIONAL:"unidirectional",PLANAR:"planar"},m={NONE:"none",SELF:"self",TARGET:"target"},f={NONE:"none",ALL:"all"},S={SMALL:"small",MEDIUM:"medium",LARGE:"large"},T={NONE:0,INITIAL:1,CONTINUOUS:2},y={NONE:"none",YAW_PITCH:"yawPitch",ROLL_YAW:"rollYaw"},E={YAW_PITCH:"yawPitch",ROLL_YAW:"rollYaw",ROLL_PITCH:"rollPitch"},C="skyboxClasses",M="backgroundObjectClasses",I="dustCloudClasses",A="explosionClasses",x="projectileClasses",v="missileClasses",O="weaponClasses",R="propulsionClasses",b="sensorsClasses",L="jumpEngineClasses",N="shieldClasses",D="spacecraftTypes",P="spacecraftClasses",w={NAME:{name:"name",type:"string"},VOLUME:{name:"volume",type:"number",range:[0,10],defaultValue:1},RESOURCE:{name:"resource",type:"object",optional:!0}},V={NAME:{name:"name",type:"string"},VOLUME:{name:"volume",type:"number",range:[0,50],defaultValue:1},RESOURCE:{name:"resource",type:"object",optional:!0}};return Object.freeze(g),Object.freeze(m),Object.freeze(f),Object.freeze(T),Object.freeze(y),Object.freeze(E),GenericClass.prototype=new o.JSONResource,GenericClass.prototype.constructor=GenericClass,GenericClass.prototype.showResourceAccessError=function(e,t){s.showError("Attempting to access "+e+" ('"+t+"') of class '"+this._name+"' before it has been loaded!")},GenericClass.prototype.handleGraphicsSettingsChanged=function(){},ShadedClass.prototype=new GenericClass,ShadedClass.prototype.constructor=ShadedClass,ShadedClass.prototype._overrideData=function(e,t){GenericClass.prototype._loadData.call(this,t),this._shaderName=e?t&&t.shader?t.shader:e._shaderName:t?t.shader||_missingString(this,"shader"):null,this._shader=null,this._instancedShaderName=null,this._instancedShader=null,this._managedShader=null,this._managedInstancedShader=null},ShadedClass.prototype._loadData=function(e){return this._overrideData(null,e),!0},ShadedClass.prototype.acquireResources=function(t){t=t||e.EMPTY_OBJECT,t.omitShader||(this._shader=u.getShader(this._shaderName),this._instancedShaderName=l.getShader(this._shaderName).getVariantShaderName("instanced"),this._instancedShaderName&&(this._instancedShader=u.getShader(this._instancedShaderName)))},ShadedClass.prototype.getShader=function(){return null===this._shader?(this.showResourceAccessError("shader",this._shaderName),null):(this._managedShader||(this._managedShader=u.getManagedShader(this._shaderName)),this._managedShader)},ShadedClass.prototype.getInstancedShader=function(){return null===this._instancedShader?(s.showError("Attempting to access the instanced shader of '"+this._name+"', which does not exist (or is not loaded)!"),null):(this._managedInstancedShader||(this._managedInstancedShader=u.getManagedShader(this._instancedShaderName)),this._managedInstancedShader)},ShadedClass.prototype.handleGraphicsSettingsChanged=function(){this._managedShader=null,this._managedInstancedShader=null},ShadedModelClass.prototype=new ShadedClass,ShadedModelClass.prototype.constructor=ShadedModelClass,ShadedModelClass.prototype._overrideData=function(e,t){ShadedClass.prototype._overrideData.call(this,e,t),this._modelName=e?t&&t.model?t.model:e._modelName:t?t.model||null:null,this._model=null},ShadedModelClass.prototype._loadData=function(e){return this._overrideData(null,e),!0},ShadedModelClass.prototype.acquireResources=function(e){ShadedClass.prototype.acquireResources.call(this,e),e&&e.model?(this._model=l.getOrAddModel(e.model),this._modelName=this._model._name):this._model=u.getModel(this._modelName)},ShadedModelClass.prototype.getModel=function(){return null===this._model?(this.showResourceAccessError("model",this._modelName),null):this._model.getEgomModel()},SkyboxClass.prototype=new ShadedModelClass,SkyboxClass.prototype.constructor=SkyboxClass,SkyboxClass.prototype._loadData=function(e){return ShadedModelClass.prototype._loadData.call(this,e),this._cubemapName=e?e.cubemap||_missingString(this,"cubemap"):null,this._cubemap=null,!0},SkyboxClass.prototype.acquireResources=function(){ShadedModelClass.prototype.acquireResources.call(this,{model:r.fvqModel("fvqModel")}),null===this._cubemap&&(this._cubemap=u.getCubemap(this._cubemapName))},SkyboxClass.prototype.getCubemap=function(e){return null===this._cubemap?(this.showResourceAccessError("cubemap",this._cubemapName),null):this._cubemap.getManagedCubemap(e)},SkyboxClass.prototype.handleGraphicsSettingsChanged=function(){ShadedModelClass.prototype.handleGraphicsSettingsChanged.call(this),this._cubemap=null},TexturedModelClass.prototype=new ShadedModelClass,TexturedModelClass.prototype.constructor=TexturedModelClass,TexturedModelClass.prototype._overrideData=function(e,t){var i,n,o;for(ShadedModelClass.prototype._overrideData.call(this,e,t),this._textureName=e?t&&t.texture?t.texture:e._textureName:t?t.texture||_missingString(this,"texture"):null,this._texture=null,this._defaultLuminosityFactors=[],i=0,o=u.getMaxLuminosityFactors();i<o;i++)this._defaultLuminosityFactors.push(0);if(t.defaultLuminosityFactors)for(i=0;i<t.defaultLuminosityFactors.length;i++)n=t.defaultLuminosityFactors[i][0],n<u.getMaxLuminosityFactors()?this._defaultLuminosityFactors[n]=t.defaultLuminosityFactors[i][1]:s.showError("Attempting to set luminosity of group with index "+n+", while there are only "+u.getMaxLuminosityFactors()+" luminosity groups available. (and indices start with 0)",s.ErrorSeverity.MINOR,"Happened while creating textured model class '"+this._name+"'.");else e&&(this._defaultLuminosityFactors=e._defaultLuminosityFactors.slice())},TexturedModelClass.prototype._loadData=function(e){return this._overrideData(null,e),!0},TexturedModelClass.prototype.acquireResources=function(e){ShadedModelClass.prototype.acquireResources.call(this,e),null===this._texture&&(this._texture=u.getTexture(this._textureName))},TexturedModelClass.prototype.getTexture=function(e,t){return null===this._texture?(this.showResourceAccessError("texture",this._textureName),null):this._texture.getManagedTexture(e,t)},TexturedModelClass.prototype.getTexturesOfTypes=function(e,t){return null===this._texture?(this.showResourceAccessError("texture",this._textureName),null):this._texture.getManagedTexturesOfTypes(e,t)},TexturedModelClass.prototype.getDefaultGroupLuminosity=function(e){return this._defaultLuminosityFactors[e]},TexturedModelClass.prototype.getDefaultGroupLuminosityFactors=function(){return this._defaultLuminosityFactors},TexturedModelClass.prototype.handleGraphicsSettingsChanged=function(){ShadedModelClass.prototype.handleGraphicsSettingsChanged.call(this),this._texture=null},ParticleDescriptor.prototype=new TexturedModelClass,ParticleDescriptor.prototype.constructor=ParticleDescriptor,ParticleDescriptor.prototype._loadData=function(e){return TexturedModelClass.prototype._loadData.call(this,e),this._size=e?e.size||1:0,this._color=e?e.color||[1,1,1,1]:null,this._duration=e?e.duration:null,!0},ParticleDescriptor.prototype.acquireResources=function(){TexturedModelClass.prototype.acquireResources.call(this,{model:r.squareModel("squareModel")})},ParticleDescriptor.prototype.getSize=function(){return this._size},TrailDescriptor.prototype=new TexturedModelClass,TrailDescriptor.prototype.constructor=TrailDescriptor,TrailDescriptor.prototype._loadData=function(e){return TexturedModelClass.prototype._loadData.call(this,e),this._size=e?e.size||1:0,this._color=e?e.color||[1,1,1,1]:null,this._duration=e?e.duration||_missingNumber(this,"duration"):null,this._growthRate=e?e.growthRate||_missingNumber(this,"growthRate"):null,!0},TrailDescriptor.prototype.acquireResources=function(){TexturedModelClass.prototype.acquireResources.call(this,{model:r.turningBillboardModel("squareModel",e.EMPTY_ARRAY,1)})},TrailDescriptor.prototype.getSize=function(){return this._size},BackgroundObjectClass.prototype=new GenericClass,BackgroundObjectClass.prototype.constructor=BackgroundObjectClass,BackgroundObjectClass.prototype._loadData=function(e){var t;if(GenericClass.prototype._loadData.call(this,e),this._lightColor=e?e.lightColor:null,this._layers=[],e)if(e.layers&&e.layers.length>0)for(t=0;t<e.layers.length;t++)this._layers.push(new ParticleDescriptor(e.layers[t]));else _showMissingPropertyError(this,"layers");return!0},BackgroundObjectClass.prototype.acquireResources=function(){var e;for(e=0;e<this._layers.length;e++)this._layers[e].acquireResources()},BackgroundObjectClass.prototype.handleGraphicsSettingsChanged=function(){var e;for(GenericClass.prototype.handleGraphicsSettingsChanged.call(this),e=0;e<this._layers.length;e++)this._layers[e].handleGraphicsSettingsChanged()},DustCloudClass.prototype=new ShadedModelClass,DustCloudClass.prototype.constructor=DustCloudClass,DustCloudClass.prototype._loadData=function(e){return ShadedModelClass.prototype._loadData.call(this,e),this._numberOfParticles=e?e.numberOfParticles||_missingNumber(this,"numberOfParticles"):0,this._color=e?e.color||[1,1,1]:null,this._range=e?e.range||_missingNumber(this,"range"):0,!0},DustCloudClass.prototype.acquireResources=function(){ShadedModelClass.prototype.acquireResources.call(this,{model:r.lineModel("dust",[1,1,1])})},DustCloudClass.prototype.getNumberOfParticles=function(){return this._numberOfParticles*u.getDustParticleCountFactor()},DustCloudClass.prototype.getRange=function(){return this._range},ParticleEmitterDescriptor.prototype=new TexturedModelClass,ParticleEmitterDescriptor.prototype.constructor=ParticleEmitterDescriptor,ParticleEmitterDescriptor.prototype._loadData=function(t){var i;if(TexturedModelClass.prototype._loadData.call(this,t),this._type=t?e.getSafeEnumValue(g,t.type,g.OMNIDIRECTIONAL):null,this._hasProjectileModel=!!t&&(t.hasProjectileModel||!1),this._pModelWidth=t?t.projectileModelWidth||1:0,this._pModelIntersection=t?t.projectileModelIntersection||0:0,this._dimensions=t?t.dimensions||[0,0,0]:null,
this._directionSpread=!t||this._type!==g.UNIDIRECTIONAL&&this._type!==g.PLANAR?0:t.directionSpread||0,this._velocity=t?t.velocity||0:0,this._velocitySpread=t?t.velocitySpread||0:0,this._initialNumber=t?t.initialNumber||0:0,this._spawnNumber=t?t.spawnNumber||0:0,this._spawnTime=t?t.spawnTime||1:0,this._duration=t?t.duration||0:0,this._delay=t?t.delay||0:0,this._particleStates=null,t)if(this._particleStates=[],t.particleStates&&t.particleStates.length>0)for(i=0;i<t.particleStates.length;i++)this._particleStates.push(new h.ParticleState(t.particleStates[i].color,t.particleStates[i].size,t.particleStates[i].timeToReach));else _showMissingPropertyError(this,"particleStates");return!0},ParticleEmitterDescriptor.prototype.acquireResources=function(){TexturedModelClass.prototype.acquireResources.call(this,{model:this._hasProjectileModel?r.turningBillboardModel("projectileModel-"+this._pModelIntersection+"-width-"+this._pModelWidth,[this._pModelIntersection],this._pModelWidth):r.squareModel("squareModel")})},ParticleEmitterDescriptor.prototype.getType=function(){return this._type},ParticleEmitterDescriptor.prototype.isContinuous=function(){return this._spawnNumber>0&&0===this._duration},ParticleEmitterDescriptor.prototype.getParticleStates=function(){return this._particleStates},ParticleEmitterDescriptor.prototype.getParticleDuration=function(){var e,t=0;for(e=1;e<this._particleStates.length;e++)t+=this._particleStates[e].timeToReach;return t},ParticleEmitterDescriptor.prototype.getTotalDuration=function(){var e=this._delay;return this._spawnNumber&&this._spawnTime&&(e+=Math.floor(this._duration/this._spawnTime)*this._spawnTime),e+=this.getParticleDuration()},ParticleEmitterDescriptor.prototype.getMaxParticleCount=function(){var e,t,i,n=this.getParticleDuration();return i=Math.floor(this._duration/this._spawnTime)+1,t=Math.ceil(n/this._spawnTime),e=this._spawnNumber*(this._duration?Math.min(i,t):t),this._initialNumber>this._spawnNumber?e+=this._initialNumber-this._spawnNumber:this._initialNumber<this._spawnNumber&&this._duration&&i<=t&&(e-=this._spawnNumber-this._initialNumber),e},ExplosionClass.prototype=new GenericClass,ExplosionClass.prototype.constructor=ExplosionClass,ExplosionClass.prototype._loadData=function(e){var i;if(GenericClass.prototype._loadData.call(this,e),this._particleEmitterDescriptors=null,e&&e.particleEmitters)for(this._particleEmitterDescriptors=[],i=0;i<e.particleEmitters.length;i++)this._particleEmitterDescriptors.push(new ParticleEmitterDescriptor(e.particleEmitters[i]));return this._lightStates=e?e.lightStates:null,this._soundEffect=e&&e.soundEffect?t.getVerifiedObject("explosionClasses['"+this._name+"'].soundEffect",e.soundEffect,V):null,!0},ExplosionClass.prototype.acquireResources=function(e){var t;for(t=0;t<this._particleEmitterDescriptors.length;t++)this._particleEmitterDescriptors[t].acquireResources();e.sound&&this._soundEffect&&_loadSoundEffect(this._soundEffect)},ExplosionClass.prototype.getLightStates=function(){return this._lightStates},ExplosionClass.prototype.getTotalDuration=function(){var e,t,i=0;for(e=0;e<this._particleEmitterDescriptors.length;e++)(t=this._particleEmitterDescriptors[e].getTotalDuration())>i&&(i=t);return i},ExplosionClass.prototype.getMaxParticleCount=function(){var e,t=0;for(e=0;e<this._particleEmitterDescriptors.length;e++)t+=this._particleEmitterDescriptors[e].getMaxParticleCount();return t},ExplosionClass.prototype.isContinuous=function(){var e;for(e=0;e<this._particleEmitterDescriptors.length;e++)if(this._particleEmitterDescriptors[e].isContinuous())return!0;return!1},ExplosionClass.prototype.playSound=function(e,t,i,n){var s;this._soundEffect&&(s=_createSoundClip(this._soundEffect,!1,e,t,i,n))&&s.play()},ExplosionClass.prototype.handleGraphicsSettingsChanged=function(){var e;for(GenericClass.prototype.handleGraphicsSettingsChanged.call(this),e=0;e<this._particleEmitterDescriptors.length;e++)this._particleEmitterDescriptors[e].handleGraphicsSettingsChanged()},ProjectileClass.prototype=new TexturedModelClass,ProjectileClass.prototype.constructor=ProjectileClass,ProjectileClass.prototype._loadData=function(e){return TexturedModelClass.prototype._loadData.call(this,e),this._damage=e?e.damage||0:0,this._size=e?e.size||1:0,this._intersectionPositions=e?e.intersectionPositions||[]:null,this._width=e?e.width||1:0,this._mass=e?e.mass||_missingNumber(this,"mass"):0,this._dragFactor=e?e.dragFactor||0:0,this._duration=e?e.duration||_missingNumber(this,"duration"):0,this._dissipationDuration=e?e.dissipationDuration||_missingNumber(this,"dissipationDuration"):0,this._muzzleFlash=null,e&&(e.muzzleFlash?this._muzzleFlash=new ParticleDescriptor(e.muzzleFlash):_showMissingPropertyError(this,"muzzleFlash")),this._lightColor=e?e.lightColor||null:null,this._lightIntensity=e&&e.lightColor?e.lightIntensity||_missingNumber(this,"lightIntensity"):0,this._explosionClass=e?getExplosionClass(e.explosion||_missingString(this,"explosion")):null,this._shieldExplosionClass=e?getExplosionClass(e.shieldExplosion||_missingString(this,"shieldExplosion")):null,!0},ProjectileClass.prototype.acquireResources=function(e){TexturedModelClass.prototype.acquireResources.call(this,{model:r.turningBillboardModel("projectileModel-"+this._intersectionPositions.join("-")+"-width-"+this._width,this._intersectionPositions,this._width)}),e.projectileOnly||(this._muzzleFlash.acquireResources(),this._explosionClass.acquireResources({sound:e.sound}),this._shieldExplosionClass.acquireResources({sound:e.sound}))},ProjectileClass.prototype.getDamage=function(){return this._damage},ProjectileClass.prototype.getSize=function(){return this._size},ProjectileClass.prototype.handleGraphicsSettingsChanged=function(){TexturedModelClass.prototype.handleGraphicsSettingsChanged.call(this),this._muzzleFlash.handleGraphicsSettingsChanged()},MissileClass.prototype=new TexturedModelClass,MissileClass.prototype.constructor=MissileClass,MissileClass.prototype._loadData=function(i){var n;return TexturedModelClass.prototype._loadData.call(this,i),this._fullName=i?i.fullName||this._name:null,this._shortName=i?i.shortName||this._fullName&&this._fullName.split(" ")[0].substring(0,5):null,this._antiShip=!!i&&(i.antiShip||!1),this._damage=i?i.damage||0:0,this._modelScale=i?i.modelScale||1:0,this._size=i?e.getSafeEnumValue(S,i.size,null)||_missingString(this,"size"):null,this._capacity=i?i.capacity||1:0,this._length=i?i.length||_missingNumber(this,"length"):0,this._homingMode=i?e.getSafeEnumValueForKey(T,i.homingMode,T.NONE):null,this._mass=i?i.mass||_missingNumber(this,"mass"):0,this._dragFactor=i?void 0!==i.dragFactor?i.dragFactor:1:0,this._launchVelocity=i?i.launchVelocity||0:0,this._ignitionTime=i?i.ignitionTime||0:0,this._acceleration=i?i.acceleration||_missingNumber(this,"acceleration"):0,this._thrust=i?this._mass*i.acceleration||_missingNumber(this,"acceleration"):0,this._angularAcceleration=this._homingMode!==T.NONE&&i?Math.radians(i.angularAcceleration)||_missingNumber(this,"angularAcceleration"):0,this._angularThrust=i?this._mass*this._angularAcceleration:0,this._mainBurnAngleThreshold=this._homingMode!==T.NONE&&i?Math.radians(i.mainBurnAngleThreshold)||_missingNumber(this,"mainBurnAngleThreshold"):0,this._duration=i?i.duration||_missingNumber(this,"duration"):0,this._lockingTime=this._homingMode!==T.NONE&&i?i.lockingTime||0:0,this._lockingAngle=this._lockingTime>0&&i?Math.radians(i.lockingAngle||0):0,this._cooldown=i?i.cooldown||_missingNumber(this,"cooldown"):0,this._salvoCooldown=i?i.salvoCooldown||this._cooldown:0,this._proximityRange=i?i.proximityRange||0:0,this._kineticFactor=i?i.kineticFactor||1:0,this._lightColor=i?i.lightColor||null:null,this._lightIntensity=i&&i.lightColor?i.lightIntensity||_missingNumber(this,"lightIntensity"):0,this._trailDescriptor=i?i.trail?new TrailDescriptor(i.trail):_missingObject(this,"trail"):null,this._explosionClass=i?getExplosionClass(i.explosion||_missingString(this,"explosion")):null,this._shieldExplosionClass=i?getExplosionClass(i.shieldExplosion||_missingString(this,"shieldExplosion")):null,this._scoreValue=i?i.scoreValue||0:0,this._launchSound=i?t.getVerifiedObject("missileClasses['"+this._name+"'].launchSound",i.launchSound,V):null,this._startSound=i?t.getVerifiedObject("missileClasses['"+this._name+"'].startSound",i.startSound,V):null,this._propulsionClass=i?getPropulsionClass(i.propulsion||_missingString(this,"propulsion")):null,this._thrusterSlots=i?[]:null,i&&i.thrusterSlots?_loadThrusterSlots(i,this,this._thrusterSlots):i&&_showMissingPropertyError(this,"thrusterSlots"),this._enginePosition=this._thrusterSlots&&this._thrusterSlots.length>0?this._thrusterSlots[0].positionVector:[0,0,0],n=.001*(this._duration-this._ignitionTime),this._nominalRange=.001*this._duration*this._launchVelocity+.5*this._acceleration*n*n,!0},MissileClass.prototype.acquireResources=function(e){TexturedModelClass.prototype.acquireResources.call(this,e),e.missileOnly||(this._explosionClass.acquireResources({sound:e.sound}),this._shieldExplosionClass.acquireResources({sound:e.sound}),this._propulsionClass.acquireResources({sound:!1}),e.sound&&(_loadSoundEffect(this._launchSound),_loadSoundEffect(this._startSound)),e.trail&&this._trailDescriptor.acquireResources())},MissileClass.prototype.getDisplayName=function(){return d.get(d.MISSILE_CLASS.PREFIX,this._name+d.MISSILE_CLASS.NAME_SUFFIX.name,this._fullName)},MissileClass.prototype.getDamage=function(e){return Math.max(0,this._damage-e)},MissileClass.prototype.getNominalRange=function(){return this._nominalRange},MissileClass.prototype.getFireRate=function(){return 1e3/this._cooldown},MissileClass.prototype.getLockingTime=function(){return this._lockingTime},MissileClass.prototype.getSize=function(){return this._size},MissileClass.prototype.getThrust=function(){return this._thrust},MissileClass.prototype.getAngularThrust=function(){return this._angularThrust},MissileClass.prototype.getLaunchForce=function(){return this._launchVelocity*this._mass*1e3},MissileClass.prototype.getCooldown=function(){return this._cooldown},MissileClass.prototype.getPropulsionClass=function(){return this._propulsionClass},MissileClass.prototype.getMaxCount=function(){return Math.ceil(this._duration/this._cooldown)},MissileClass.prototype.getParticleCount=function(){return this._thrusterSlots.length},MissileClass.prototype.getScoreValue=function(){return this._scoreValue},MissileClass.prototype.playLaunchSound=function(e,t,i,n){e?_playSoundEffect(this._launchSound,e):_createSoundClip(this._launchSound,!1,t,!0,i,n).play()},MissileClass.prototype.playStartSound=function(e){var t=_createSoundClip(this._startSound,!1,e);return t.play(),t},MissileClass.prototype.getEnginePosition=function(){return this._enginePosition},MissileClass.prototype.getTargetHitTime=function(t,i,n){var s,o,r,a;return s=this._acceleration*this._acceleration*.25,o=-(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]),r=2*n[0]*(t[12]-i[0])+2*n[1]*(t[13]-i[1])+2*n[2]*(t[14]-i[2]),a=-i[0]*i[0]-t[12]*t[12]+2*i[0]*t[12]-i[1]*i[1]-t[13]*t[13]+2*i[1]*t[13]-i[2]*i[2]-t[14]*t[14]+2*i[2]*t[14],e.getSmallestPositiveSolutionOf4thDegreeEquationWithoutDegree3(s,o,r,a)},MissileClass.prototype.handleGraphicsSettingsChanged=function(){TexturedModelClass.prototype.handleGraphicsSettingsChanged.call(this),this._trailDescriptor.handleGraphicsSettingsChanged()},Barrel.prototype.getPositionVector=function(){return this._positionVector},WeaponClass.prototype=new TexturedModelClass,WeaponClass.prototype.constructor=WeaponClass,WeaponClass.prototype._loadData=function(i){var n;if(TexturedModelClass.prototype._loadData.call(this,i),this._fullName=i?i.fullName||this._name:null,this._pClass=i?getProjectileClass(i.projectile||_missingString(this,"projectile")):null,this._pVelocity=i?i.projectileVelocity||_missingNumber(this,"projectileVelocity"):0,this._cooldown=i?i.cooldown||_missingNumber(this,"cooldown"):0,this._barrels=[],i)if(i.barrels)for(n=0;n<i.barrels.length;n++)this._barrels.push(new Barrel(i.barrels[n]));else _showMissingPropertyError(this,"barrels");if(this._attachmentPoint=i?i.attachmentPoint||[0,0,0]:null,this._rotationStyle=i?e.getSafeEnumValue(y,i.rotationStyle,y.NONE):null,this._fixed=this._rotationStyle===y.NONE,this._basePoint=i&&!this._fixed?i.basePoint&&i.basePoint.slice()||[0,0,0]:null,this._basePoint&&this._basePoint.push(1),this._rotators=[],i&&!this._fixed)if(i.rotators)for(n=0;n<i.rotators.length;n++)this._rotators.push(new WeaponRotator(i.rotators[n]));else _showMissingPropertyError(this,"rotators");return this._fireSound=i?t.getVerifiedObject("weaponClasses['"+this._name+"'].fireSound",i.fireSound,V):null,this._scoreValue=i?i.scoreValue||0:0,!0},WeaponClass.prototype.acquireResources=function(e){TexturedModelClass.prototype.acquireResources.call(this,e),e.projectileResources&&this._pClass.acquireResources({projectileOnly:!1,sound:e.sound}),e.sound&&_loadSoundEffect(this._fireSound),e.barrelMarkers&&(l.getOrAddModel(r.positionMarkerModel("marker",8)),e.barrelMarkerShaderName&&u.getShader(e.barrelMarkerShaderName))},WeaponClass.prototype.getDisplayName=function(){return d.get(d.WEAPON_CLASS.PREFIX,this._name+d.WEAPON_CLASS.NAME_SUFFIX.name,this._fullName)},WeaponClass.prototype.getCooldown=function(){return this._cooldown},WeaponClass.prototype.getProjectileClass=function(){return this._pClass},WeaponClass.prototype.getProjectileVelocity=function(){return this._pVelocity},WeaponClass.prototype.getFireForce=function(){return this._pVelocity*this._pClass._mass*1e3},WeaponClass.prototype.getDamage=function(e){return this._barrels.length*Math.max(0,this.getProjectileClass().getDamage()-(e||0))},WeaponClass.prototype.getFirepower=function(e){return 1e3*this.getDamage(e)/this._cooldown},WeaponClass.prototype.getFireRate=function(){return 1e3/this._cooldown},WeaponClass.prototype.playFireSound=function(e,t,i,n){e?_playSoundEffect(this._fireSound,e):_createSoundClip(this._fireSound,!1,t,!0,i,n).play()},WeaponClass.prototype.getScoreValue=function(){return this._scoreValue},WeaponClass.prototype.getMaxProjectileCount=function(){return this._barrels.length*Math.ceil(this._pClass._duration/this._cooldown)},WeaponClass.prototype.getMaxExplosionCount=function(){return this._barrels.length*Math.ceil(Math.max(this._pClass._explosionClass.getTotalDuration(),this._pClass._shieldExplosionClass.getTotalDuration())/this._cooldown)},WeaponClass.prototype.getMaxParticleCount=function(){return this._barrels.length*(1+this.getMaxExplosionCount(this._cooldown)*Math.max(this._pClass._explosionClass.getMaxParticleCount(),this._pClass._shieldExplosionClass.getMaxParticleCount()))},PropulsionClass.prototype=new GenericClass,PropulsionClass.prototype.constructor=PropulsionClass,PropulsionClass.prototype._loadData=function(e){var i;return GenericClass.prototype._loadData.call(this,e),i=e?e.referenceMass||1:null,this._fullName=e?e.fullName||this._name:null,this._thrusterBurnParticle=new ParticleDescriptor(e),this._thrust=e?i*e.thrust||_missingNumber(this,"thrust"):0,this._angularThrust=e?i*Math.radians(e.angularThrust)||_missingNumber(this,"angularThrust"):0,this._maxMoveBurnLevel=e?e.maxMoveBurnLevel||_missingNumber(this,"maxMoveBurnLevel"):0,this._maxTurnBurnLevel=e?e.maxTurnBurnLevel||_missingNumber(this,"maxTurnBurnLevel"):0,this._thrusterSound=e?t.getVerifiedObject("propulsionClasses['"+this._name+"'].thrusterSound",e.thrusterSound,V):null,this._scoreValue=e?e.scoreValue||0:0,!0},PropulsionClass.prototype.acquireResources=function(e){this._thrusterBurnParticle.acquireResources(),e.sound&&_loadSoundEffect(this._thrusterSound)},PropulsionClass.prototype.getDisplayName=function(){return d.get(d.PROPULSION_CLASS.PREFIX,this._name+d.PROPULSION_CLASS.NAME_SUFFIX.name,this._fullName)},PropulsionClass.prototype.getThrust=function(){return this._thrust},PropulsionClass.prototype.getAngularThrust=function(){return this._angularThrust},PropulsionClass.prototype.getMaxMoveBurnLevel=function(){return this._maxMoveBurnLevel},PropulsionClass.prototype.getMaxTurnBurnLevel=function(){return this._maxTurnBurnLevel},PropulsionClass.prototype.handleGraphicsSettingsChanged=function(){GenericClass.prototype.handleGraphicsSettingsChanged.call(this),this._thrusterBurnParticle.handleGraphicsSettingsChanged()},PropulsionClass.prototype.createThrusterSoundClip=function(e){return _createSoundClip(this._thrusterSound,!0,e)},PropulsionClass.prototype.getThrusterSoundVolume=function(){return this._thrusterSound.volume},PropulsionClass.prototype.getScoreValue=function(){return this._scoreValue},SensorsClass.prototype=new GenericClass,SensorsClass.prototype.constructor=SensorsClass,SensorsClass.prototype._loadData=function(e){return GenericClass.prototype._loadData.call(this,e),this._fullName=e?e.fullName||this._name:null,this._range=e?e.range||_missingNumber(this,"range"):0,this._scoreValue=e?e.scoreValue||0:0,!0},SensorsClass.prototype.acquireResources=function(){return!0},SensorsClass.prototype.getDisplayName=function(){return d.get(d.SENSORS_CLASS.PREFIX,this._name+d.SENSORS_CLASS.NAME_SUFFIX.name,this._fullName)},SensorsClass.prototype.getRange=function(){return this._range},SensorsClass.prototype.getScoreValue=function(){return this._scoreValue},JumpEngineClass.prototype=new GenericClass,JumpEngineClass.prototype.constructor=JumpEngineClass,JumpEngineClass.prototype._loadData=function(e){return GenericClass.prototype._loadData.call(this,e),this._engageSound=e?t.getVerifiedObject("JumpEngineClasses['"+this._name+"'].engageSound",e.engageSound,w):null,this._disengageSound=e?t.getVerifiedObject("JumpEngineClasses['"+this._name+"'].disengageSound",e.disengageSound,w):null,this._prepareVelocity=e?void 0!==e.prepareVelocity?e.prepareVelocity:_missingNumber(this,"prepareVelocity"):0,this._prepareDuration=e?void 0!==e.prepareDuration?e.prepareDuration:_missingNumber(this,"prepareDuration"):0,this._prepareSound=e?t.getVerifiedObject("JumpEngineClasses['"+this._name+"'].prepareSound",e.prepareSound,V):null,this._cancelSound=e?t.getVerifiedObject("JumpEngineClasses['"+this._name+"'].cancelSound",e.cancelSound,V):null,this._jumpOutAcceleration=e?e.jumpOutAcceleration||_missingNumber(this,"jumpOutAcceleration"):0,this._jumpOutScaling=e?e.jumpOutScaling||1:0,this._jumpOutDuration=e?e.jumpOutDuration||_missingNumber(this,"jumpOutDuration"):0,this._jumpOutSound=e?t.getVerifiedObject("JumpEngineClasses['"+this._name+"'].jumpOutSound",e.jumpOutSound,V):null,this._jumpOutExplosionClass=e?getExplosionClass(e.jumpOutExplosion||_missingString(this,"jumpOutExplosion")):null,this._jumpInDeceleration=e?e.jumpInDeceleration||this._jumpOutAcceleration:0,this._jumpInVelocity=e?void 0!==e.jumpInVelocity?e.jumpInVelocity:this._prepareVelocity:0,this._jumpInScaling=e?e.jumpInScaling||this._jumpOutScaling:0,this._jumpInDuration=e?e.jumpInDuration||this._jumpOutDuration:0,this._jumpInSound=e?e.jumpInSound?t.getVerifiedObject("JumpEngineClasses['"+this._name+"'].jumpInSound",e.jumpInSound,V):this._jumpOutSound:null,this._jumpInExplosionClass=e?e.jumpInExplosion?getExplosionClass(e.jumpInExplosion):this._jumpOutExplosionClass:null,!0},JumpEngineClass.prototype.acquireResources=function(e){e.sound&&(_loadSoundEffect(this._engageSound),_loadSoundEffect(this._disengageSound),_loadSoundEffect(this._prepareSound),_loadSoundEffect(this._cancelSound),_loadSoundEffect(this._jumpOutSound),_loadSoundEffect(this._jumpInSound)),this._jumpOutExplosionClass.acquireResources({sound:e.sound}),this._jumpInExplosionClass.acquireResources({sound:e.sound})},JumpEngineClass.prototype.createEngageSoundClip=function(){return _createSoundClip(this._engageSound,!1)},JumpEngineClass.prototype.createDisengageSoundClip=function(){return _createSoundClip(this._disengageSound,!1)},JumpEngineClass.prototype.createPrepareSoundClip=function(e){return _createSoundClip(this._prepareSound,!1,e)},JumpEngineClass.prototype.createCancelSoundClip=function(e){return _createSoundClip(this._cancelSound,!1,e)},JumpEngineClass.prototype.createJumpOutSoundClip=function(e){return _createSoundClip(this._jumpOutSound,!1,e)},JumpEngineClass.prototype.createJumpInSoundClip=function(e){return _createSoundClip(this._jumpInSound,!1,e)},ShieldClass.prototype=new GenericClass,ShieldClass.prototype.constructor=ShieldClass,ShieldClass.prototype._loadData=function(e){return GenericClass.prototype._loadData.call(this,e),this._fullName=e?e.fullName||this._name:null,this._capacity=e?e.capacity||_missingNumber(this,"capacity"):0,this._rechargeDelay=e?void 0!==e.rechargeDelay?e.rechargeDelay:_missingNumber(this,"rechargeDelay"):0,this._rechargeRate=e?e.rechargeRate||_missingNumber(this,"rechargeRate"):0,this._rechargeColor=e?e.rechargeColor||[1,1,1]:null,this._rechargeAnimationDuration=e?e.rechargeAnimationDuration||_missingNumber(this,"rechargeAnimationDuration"):0,this._rechargeStartSound=e?t.getVerifiedObject("ShieldClasses['"+this._name+"'].rechargeStartSound",e.rechargeStartSound,V):null,this._scoreValue=e?e.scoreValue||0:0,!0},ShieldClass.prototype.acquireResources=function(e){e.sound&&_loadSoundEffect(this._rechargeStartSound)},ShieldClass.prototype.getDisplayName=function(){return d.get(d.SHIELD_CLASS.PREFIX,this._name+d.SHIELD_CLASS.NAME_SUFFIX.name,this._fullName)},ShieldClass.prototype.getRechargeDelay=function(){return this._rechargeDelay},ShieldClass.prototype.getRechargeRate=function(){return this._rechargeRate},ShieldClass.prototype.createRechargeStartSoundClip=function(e){return _createSoundClip(this._rechargeStartSound,!1,e)},ShieldClass.prototype.getScoreValue=function(){return this._scoreValue},SpacecraftType.prototype=new GenericClass,SpacecraftType.prototype.constructor=SpacecraftType,SpacecraftType.prototype._loadData=function(e){return GenericClass.prototype._loadData.call(this,e),this._isFighterType=!!e&&!0===e.isFighterType,this._fullName=e?e.fullName||this._name:null,this._description=e?"string"==typeof e.description?e.description:_missingString(this,"description"):null,this._goodAgainstTypeNames=e?e.goodAgainst||[]:null,this._badAgainstTypeNames=e?e.badAgainst||[]:null,!0},SpacecraftType.prototype.getDisplayName=function(){return d.get(d.SPACECRAFT_TYPE.PREFIX,this._name+d.SPACECRAFT_TYPE.NAME_SUFFIX.name,this._fullName)},SpacecraftType.prototype.getDisplayDescription=function(){return d.get(d.SPACECRAFT_TYPE.PREFIX,this._name+d.SPACECRAFT_TYPE.DESCRIPTION_SUFFIX.name,e.formatString(d.get(d.DATABASE.MISSING_SPACECRAFT_TYPE_DESCRIPTION),{spacecraftType:this.getDisplayName(),originalDescription:this._description}))},SpacecraftType.prototype.getGoodAgainstTypes=function(){var e,t;for(t=[],e=0;e<this._goodAgainstTypeNames.length;e++)t.push(getSpacecraftType(this._goodAgainstTypeNames[e]))},SpacecraftType.prototype.getBadAgainstTypes=function(){var e,t;for(t=[],e=0;e<this._badAgainstTypeNames.length;e++)t.push(getSpacecraftType(this._badAgainstTypeNames[e]))},SpacecraftType.prototype.isGoodAgainst=function(e){return this._goodAgainstTypeNames.indexOf(e._name)>=0},SpacecraftType.prototype.isBadAgainst=function(e){return this._badAgainstTypeNames.indexOf(e._name)>=0},GenericView.prototype.isFPS=function(){return this._fps},GenericView.prototype.getFOV=function(){return this._fov},GenericView.prototype.getFOVRange=function(){return this._fovRange},GenericView.prototype.getSpan=function(){return this._span},GenericView.prototype.isMovable=function(){return this._movable},GenericView.prototype.isTurnable=function(){return this._turnable},GenericView.prototype.getAlphaRange=function(){return this._alphaRange},GenericView.prototype.getBetaRange=function(){return this._betaRange},GenericView.prototype.getConfines=function(){return this._confines},GenericView.prototype.resetsWhenLeavingConfines=function(){return this._resetsWhenLeavingConfines},GenericView.prototype.getBaseOrientation=function(){return this._baseOrientation},GenericView.prototype.getPointToFallback=function(){return this._pointToFallback},GenericView.prototype.shouldExcludeFromCycle=function(){return this._excludeFromCycle},GenericView.prototype.destroy=function(){this._fovRange=null,this.pM=null,this.oM=null,this._alphaRange=null,this._betaRange=null,this._confines=null},ObjectView.prototype=new GenericView,ObjectView.prototype.constructor=ObjectView,ObjectView.prototype.turnsAroundObjects=function(){return this._rotationCenterIsObject},ObjectView.prototype.movesRelativeToObject=function(){return this._movesRelativeToObject},ObjectView.prototype.getPositionFollowedObjectsForObject=function(e){return this._followsPosition||this._startsWithRelativePosition?[e]:[]},ObjectView.prototype.startsWithRelativePosition=function(){return this._startsWithRelativePosition},ObjectView.prototype.getDistanceRange=function(){return this._distanceRange},ObjectView.prototype.pointsTowardsObjects=function(){return this._lookAtSelf||this._lookAtTarget},ObjectView.prototype.getOrientationFollowedObjectsForObject=function(e){return this._lookAtSelf||this._followsOrientation?[e]:[]},ObjectView.prototype.resetsOnFocusChange=function(){return this._resetsOnFocusChange},ObjectView.prototype.createCameraConfiguration=function(e,t,i,s,o){var r,a,l=n.getYawAndPitch(this.oM);return r=new c.CameraPositionConfiguration(!this.isMovable(),this.turnsAroundObjects(),this.movesRelativeToObject(),this.getPositionFollowedObjectsForObject(e),this.startsWithRelativePosition(),n.copy(this.pM),this.getDistanceRange(),this.getConfines(),this.resetsWhenLeavingConfines()),a=new c.CameraOrientationConfiguration(!this.isTurnable(),this.pointsTowardsObjects(),this.isFPS(),this.getOrientationFollowedObjectsForObject(e),n.copy(this.oM),Math.degrees(l.yaw),Math.degrees(l.pitch),this.getAlphaRange(),this.getBetaRange(),this.getBaseOrientation()||t,this.getPointToFallback()||i),new c.CameraConfiguration(this._name,r,a,this.getFOV()||s,this.getFOVRange(),this.getSpan()||o,this.resetsOnFocusChange(),this.shouldExcludeFromCycle())},ObjectView.prototype.destroy=function(){GenericView.prototype.destroy.call(this),this._distanceRange=null},SceneView.prototype=new GenericView,SceneView.prototype.constructor=SceneView,SceneView.prototype.turnsAroundObjects=function(){return this._turnAroundAll},SceneView.prototype.movesRelativeToObject=function(){return!1},SceneView.prototype.getPositionFollowedObjectsForScene=function(e){return this._turnAroundAll||this._startsWithRelativePosition?e.getAll3DObjects():[]},SceneView.prototype.startsWithRelativePosition=function(){return this._startsWithRelativePosition},SceneView.prototype.getDistanceRange=function(){return this._distanceRange},SceneView.prototype.pointsTowardsObjects=function(){return this._lookAtAll},SceneView.prototype.getOrientationFollowedObjectsForScene=function(e){return this._lookAtAll?e.getAll3DObjects():[]},SceneView.prototype.resetsOnFocusChange=function(){return!1},SceneView.prototype.destroy=function(){GenericView.prototype.destroy.call(this),this._distanceRange=null},BlinkerDescriptor.prototype.acquireResources=function(){this._particle.acquireResources()},BlinkerDescriptor.prototype.getParticleStates=function(){var e,t=0,i=[];if(this._blinks.length>0)for(this._blinks[0]>0&&(i.push(new h.ParticleState(this._particle._color,0,0)),i.push(new h.ParticleState(this._particle._color,0,this._blinks[0]))),e=0;e<this._blinks.length;e++)i.push(new h.ParticleState(this._particle._color,this._particle.getSize(),0)),i.push(new h.ParticleState(this._particle._color,0,this._particle._duration)),t=this._blinks[e]+this._particle._duration,i.push(new h.ParticleState(this._particle._color,0,e<this._blinks.length-1?this._blinks[e+1]-t:this._period-t));else i.push(new h.ParticleState(this._particle._color,this._particle.getSize(),0));return i},BlinkerDescriptor.prototype.getLightStates=function(){var e,t=0,i=[];if(this._blinks.length>0)for(this._blinks[0]>0&&(i.push({color:this._lightColor,intensity:0,timeToReach:0}),i.push({color:this._lightColor,intensity:0,timeToReach:this._blinks[0]})),e=0;e<this._blinks.length;e++)i.push({color:this._lightColor,intensity:this._intensity,timeToReach:0}),i.push({color:this._lightColor,intensity:0,timeToReach:this._particle._duration}),t=this._blinks[e]+this._particle._duration,i.push({color:this._lightColor,intensity:0,timeToReach:e<this._blinks.length-1?this._blinks[e+1]-t:this._period-t});else i.push({color:this._lightColor,intensity:this._intensity,timeToReach:0});return i},BlinkerDescriptor.prototype.handleGraphicsSettingsChanged=function(){this._particle.handleGraphicsSettingsChanged()},SpacecraftClass.prototype=new TexturedModelClass,SpacecraftClass.prototype.constructor=SpacecraftClass,SpacecraftClass.prototype._overrideData=function(o,r){var l,c,h,u,d,p,_,g;switch(TexturedModelClass.prototype._overrideData.call(this,o,r),this._scType=o?r.type?getSpacecraftType(r.type):o._scType:getSpacecraftType(r.type||_missingString(this,"type")),this._fullName=o?r.fullName||o._fullName:r.fullName||this._name,this._showInDatabase=o?"boolean"==typeof r.showInDatabase?r.showInDatabase:o._showInDatabase:"boolean"!=typeof r.showInDatabase||r.showInDatabase,this._description=o?r.description||o._description:r.description||(this._showInDatabase?_missingString(this,"description"):""),this._hitpoints=o?r.hitpoints||o._hitpoints:r.hitpoints||_missingNumber(this,"hitpoints"),this._armor="number"==typeof r.armor?r.armor:o?o._armor:0,this._factionColor=o?r.factionColor||o._factionColor:r.factionColor||null,this._turnStyle=r.turnStyle?e.getSafeEnumValue(E,r.turnStyle,E.YAW_PITCH):o?o._turnStyle:E.YAW_PITCH,this._attackVector=r.attackVector?i.normal3(r.attackVector):o?o._attackVector:[0,1,0],this._attackVectorAngles=[0,0],g={yaw:0,pitch:0,roll:0},this._turnStyle){case E.YAW_PITCH:i.getYawAndPitch(g,this._attackVector),this._attackVectorAngles[0]=g.yaw,this._attackVectorAngles[1]=g.pitch;break;case E.ROLL_YAW:i.getRollAndYaw(g,this._attackVector,!1),this._attackVectorAngles[0]=g.roll,this._attackVectorAngles[1]=g.yaw;break;case E.ROLL_PITCH:i.getRollAndPitch(g,this._attackVector,!1),this._attackVectorAngles[0]=g.roll,this._attackVectorAngles[1]=g.pitch}if(this._attackThresholdAngle=Math.radians(r.attackThresholdAngle)||(o?o._attackThresholdAngle:0),this._mass=o?r.mass||o._mass:r.mass||_missingNumber(this,"mass"),this._dragFactor=o?void 0!==r.dragFactor?r.dragFactor:o._dragFactor:void 0!==r.dragFactor?r.dragFactor:1,this._bodies=o&&!r.bodies?o._bodies:[],r.bodies)for(l=0;l<r.bodies.length;l++)this._bodies.push(new a.Body(n.translation4v(r.bodies[l].position||_missingVector3(this,"bodies[i].position")),n.rotation4FromJSON(r.bodies[l].rotations),r.bodies[l].size));else o||_showMissingPropertyError(this,"bodies");if(this._wSlots=o&&!r.weaponSlots?o._wSlots:[],r.weaponSlots)for(l=0;l<r.weaponSlots.length;l++)if(r.weaponSlots[l].count>1)for(h=r.weaponSlots[l].position||_missingVector3(this,"weaponSlot array position"),u=r.weaponSlots[l].vector||_missingVector3(this,"weaponSlot array vector"),d=r.weaponSlots[l].rotations,p=r.weaponSlots[l].count,_=r.weaponSlots[l].clear,c=0;c<p;c++)this._wSlots.push(new WeaponSlot({position:i.sum3(h,i.scaled3Aux(u,c)),rotations:d,clear:_}));else this._wSlots.push(new WeaponSlot(r.weaponSlots[l]));if(this._mLs=o&&!r.missileLaunchers?o._mLs:[],r.missileLaunchers)for(l=0;l<r.missileLaunchers.length;l++)this._mLs.push(new MissileLauncherDescriptor(r.missileLaunchers[l]));if(this._thrusterSlots=o&&!r.thrusterSlots?o._thrusterSlots:[],r.thrusterSlots&&_loadThrusterSlots(r,this,this._thrusterSlots),this._views=o&&!r.views?o._views:[],r.views)for(l=0;l<r.views.length;l++)this._views.push(new ObjectView(r.views[l]));else o||_showMissingPropertyError(this,"views");if(this._loadouts=o&&!r.loadouts?o._loadouts:{},
r.loadouts)for(l=0;l<r.loadouts.length;l++)this._loadouts[r.loadouts[l].name]=new Loadout(r.loadouts[l],r.loadouts);if(this._defaultLoadout=o?r.defaultLoadout||o._defaultLoadout:r.defaultLoadout||null,this._defaultLoadout&&!this._loadouts[this._defaultLoadout]&&(s.showError("Non-existing default loadout '"+this._defaultLoadout+"' specified for spacecraft class "+this._name+"!",s.ErrorSeverity.MINOR),this._defaultLoadout=null),this._humSound=r.humSound?t.getVerifiedObject("spacecraftClasses['"+this._name+"'].humSound",r.humSound,V):o?o._humSound:null,this._collisionSound=r.collisionSound?t.getVerifiedObject("spacecraftClasses['"+this._name+"'].collisionSound",r.collisionSound,V):o?o._collisionSound:null,this._explosionClass=o?r.explosion?getExplosionClass(r.explosion):o._explosionClass:getExplosionClass(r.explosion||_missingString(this,"explosion")),this._showTimeRatioDuringExplosion=void 0!==r.showTimeRatioDuringExplosion?r.showTimeRatioDuringExplosion:o?o._showTimeRatioDuringExplosion:_missingNumber(this,"showTimeRatioDuringExplosion"),this._damageIndicators=o&&!r.damageIndicators?o._damageIndicators:[],r.damageIndicators)for(l=0;l<r.damageIndicators.length;l++)this._damageIndicators.push(new DamageIndicator(r.damageIndicators[l]));if(this._lightSources=o&&!r.lights?o._lightSources:[],r.lights)for(l=0;l<r.lights.length;l++)this._lightSources.push(new LightSourceDescriptor(r.lights[l]));if(this._blinkerDescriptors=o&&!r.blinkers?o._blinkerDescriptors:[],r.blinkers)for(l=0;l<r.blinkers.length;l++)this._blinkerDescriptors.push(new BlinkerDescriptor(r.blinkers[l]));this._lockingTimeFactor=void 0!==r.lockingTimeFactor?r.lockingTimeFactor:o?o._lockingTimeFactor:1,this._scoreValue=o?r.scoreValue||o._scoreValue:r.scoreValue||0},SpacecraftClass.prototype._loadData=function(e){var t;return e.basedOn?(t=getSpacecraftClass(e.basedOn),t.executeWhenReady(function(){this._overrideData(t,e)}.bind(this))):this._overrideData(null,e),!0},SpacecraftClass.prototype.isFighterClass=function(){return this._scType._isFighterType},SpacecraftClass.prototype.getDisplayName=function(){return d.get(d.SPACECRAFT_CLASS.PREFIX,this._name+d.SPACECRAFT_CLASS.NAME_SUFFIX.name,this._fullName)},SpacecraftClass.prototype.getDisplayDescription=function(){return d.get(d.SPACECRAFT_CLASS.PREFIX,this._name+d.SPACECRAFT_CLASS.DESCRIPTION_SUFFIX.name,e.formatString(d.get(d.DATABASE.MISSING_SPACECRAFT_CLASS_DESCRIPTION),{spacecraftClass:this.getDisplayName(),originalDescription:this._description}))},SpacecraftClass.prototype.shouldShowInDatabase=function(){return this._showInDatabase},SpacecraftClass.prototype.getMissileLaunchersBySize=function(){var e,t={};for(e=0;e<this._mLs.length;e++)t[this._mLs[e].size]?t[this._mLs[e].size].push(this._mLs[e]):t[this._mLs[e].size]=[this._mLs[e]];return t},SpacecraftClass.prototype.getLoadout=function(e){return this._loadouts[e]},SpacecraftClass.prototype.getLoadoutNames=function(){return Object.keys(this._loadouts)},SpacecraftClass.prototype.getView=function(e){var t;for(t=0;t<this._views.length;t++)if(this._views[t]._name===e)return this._views[t];return null},SpacecraftClass.prototype.getLockingTimeFactor=function(){return this._lockingTimeFactor},SpacecraftClass.prototype.acquireResources=function(e){var t;if(TexturedModelClass.prototype.acquireResources.call(this,e),e.explosion&&this._explosionClass.acquireResources({sound:e.sound}),e.damageIndicators)for(t=0;t<this._damageIndicators.length;t++)this._damageIndicators[t].explosionClass.acquireResources({sound:e.sound});if(e.blinkers)for(t=0;t<this._blinkerDescriptors.length;t++)this._blinkerDescriptors[t].acquireResources();e.sound&&(this._humSound&&_loadSoundEffect(this._humSound),this._collisionSound&&_loadSoundEffect(this._collisionSound))},SpacecraftClass.prototype.handleGraphicsSettingsChanged=function(){var e;if(TexturedModelClass.prototype.handleGraphicsSettingsChanged.call(this),this._blinkerDescriptors)for(e=0;e<this._blinkerDescriptors.length;e++)this._blinkerDescriptors[e].handleGraphicsSettingsChanged()},SpacecraftClass.prototype.hasHumSound=function(){return!!this._humSound},SpacecraftClass.prototype.createHumSoundClip=function(e){return this._humSound?_createSoundClip(this._humSound,!0,e):null},SpacecraftClass.prototype.playCollisionSound=function(e){return this._collisionSound&&_playSoundEffect(this._collisionSound,e),null},SpacecraftClass.prototype.getScoreValue=function(){return this._scoreValue},p=new o.ResourceManager,u.onSettingsChange(function(){p.executeForAllResources(function(e){e.handleGraphicsSettingsChanged()})}),{MARKER_MODEL_NAME:"marker",SHADER_VARIANT_INSTANCED_NAME:"instanced",SOUND_EFFECT:w,ParticleEmitterType:g,ObjectViewLookAtMode:m,SceneViewLookAtMode:f,MissileSize:S,MissileHomingMode:T,WeaponRotationStyle:y,SpacecraftTurnStyle:E,TexturedModelClass:TexturedModelClass,getSkyboxClass:getSkyboxClass,getBackgroundObjectClass:getBackgroundObjectClass,getDustCloudClass:getDustCloudClass,getExplosionClass:getExplosionClass,getMissileClass:getMissileClass,getWeaponClass:getWeaponClass,getPropulsionClass:getPropulsionClass,getSensorsClass:getSensorsClass,getJumpEngineClass:getJumpEngineClass,getShieldClass:getShieldClass,getSpacecraftType:getSpacecraftType,getSpacecraftClass:getSpacecraftClass,getSpacecraftClassesInArray:getSpacecraftClassesInArray,getClassCategories:getClassCategories,getClassNames:getClassNames,getClass:getClass,createClass:p.createResource.bind(p),Loadout:Loadout,ObjectView:ObjectView,SceneView:SceneView,requestLoad:requestLoad,executeWhenReady:p.executeWhenReady.bind(p),executeForAllClasses:p.executeForAllResources.bind(p),renameClass:p.renameResource.bind(p),moveClassAfter:p.moveResourceAfter.bind(p)}}),define("armada/configuration",["utils/utils","utils/types","modules/async-resource","modules/scene/camera","armada/logic/classes","armada/constants"],function(e,t,i,n,s,o){"use strict";function ConfigurationContext(){i.AsyncResource.call(this),this._configuration=null,this._settings=null,this._hudSettings={}}var r,a,l,c,h,u,d,p,_,g=o.LOCAL_STORAGE_PREFIX+"settings_",m={};return m.FILE_DESCRIPTOR={baseType:"object",properties:{FILENAME:{name:"filename",type:"string"},FOLDER:{name:"folder",type:"string"}}},m.LIGHT_SOURCE={baseType:"object",properties:{COLOR:{name:"color",type:t.COLOR3},DIRECTION:{name:"direction",type:t.VECTOR3}}},m.LAYOUT_DESCRIPTOR={baseType:"object",properties:{LEFT:{name:"left",type:"number",optional:!0},CENTER_X:{name:"centerX",type:"number",optional:!0},RIGHT:{name:"right",type:"number",optional:!0},TOP:{name:"top",type:"number",optional:!0},CENTER_Y:{name:"centerY",type:"number",optional:!0},BOTTOM:{name:"bottom",type:"number",optional:!0},WIDTH:{name:"width",type:"number",optional:!0},HEIGHT:{name:"height",type:"number",optional:!0},SCALE_MODE:{name:"scaleMode",type:"enum",values:e.ScaleMode},X_SCALE_MODE:{name:"xScaleMode",type:"enum",values:e.ScaleMode,optional:!0},Y_SCALE_MODE:{name:"yScaleMode",type:"enum",values:e.ScaleMode,optional:!0}}},m.TEXTURE_MAPPING={baseType:"array",elementType:t.VECTOR2,length:2},m.UI_IMAGE_DESCRIPTOR={baseType:"object",properties:{TEXTURE:{name:"texture",type:"string"},MAPPING:{name:"mapping",type:m.TEXTURE_MAPPING,optional:!0},SIZE:{name:"size",type:t.VECTOR2},SCALE_MODE:{name:"scaleMode",type:"enum",values:e.ScaleMode},COLOR:{name:"color",type:t.COLOR4}}},m.UI_LAID_OUT_IMAGE_DESCRIPTOR={baseType:"object",properties:{TEXTURE:{name:"texture",type:"string"},MAPPING:{name:"mapping",type:m.TEXTURE_MAPPING},LAYOUT:{name:"layout",type:m.LAYOUT_DESCRIPTOR},COLOR:{name:"color",type:t.COLOR4}}},m.TEXT_DESCRIPTOR={baseType:"object",properties:{COLOR:{name:"color",type:t.COLOR4},FONT_SIZE:{name:"fontSize",type:"number"},FONT_NAME:{name:"fontName",type:"string"},POSITION:{name:"position",type:t.VECTOR2},LAYOUT:{name:"layout",type:m.LAYOUT_DESCRIPTOR,optional:!0}}},m.CRAFT_INDICATOR_POSITIONS={baseType:"array",elementType:{baseType:"array",elementType:t.VECTOR2}},m.NUMBER_ARRAY={baseType:"array",elementType:"number"},m.STRING_ARRAY={baseType:"array",elementType:"string"},m.getCustomDescriptor=function(t,i,n){var s,o,r,a,l=e.deepCopy(t);for(r=Object.keys(i),s=0;s<r.length;s++){for(a=l.properties[r[s]],l.properties[r[s]+"S"]={name:a.name+"s",type:{baseType:"object",properties:{}}},o=0;o<i[r[s]].length;o++)l.properties[r[s]+"S"].type.properties[i[r[s]][o].toUpperCase()]={name:i[r[s]][o],type:a.type};delete l.properties[r[s]]}if(n)for(s=0;s<n.length;s++)delete l.properties[n[s]];return l},r={CLASSES_SOURCE_FILE:{name:"classes",type:m.FILE_DESCRIPTOR},ENVIRONMENTS_SOURCE_FILE:{name:"environments",type:m.FILE_DESCRIPTOR},MISSION_FILES:{name:"missions",type:{baseType:"object",properties:{FILENAME:{name:"filename",type:"string"},FOLDER:{name:"folder",type:"string"}}}}},a={UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME:{name:"groupTransformsArrayName",type:"string",defaultValue:"groupTransforms"},BUTTON_SELECT_SOUND:{name:"buttonSelectSound",type:s.SOUND_EFFECT},BUTTON_CLICK_SOUND:{name:"buttonClickSound",type:s.SOUND_EFFECT},SHOW_DEMO_BUTTON:{name:"showDemoButton",type:"boolean"}},l={MAX_PLAYER_OPTIONS:{name:"maxPlayerOptions",type:m.NUMBER_ARRAY},SPACECRAFTS:{name:"spacecrafts",type:m.STRING_ARRAY},LOADOUTS:{name:"loadouts",type:m.STRING_ARRAY}},c={},h={SHOW_READY_MESSAGE:{name:"showReadyMessage",type:"boolean"},HITBOX_COLOR:{name:"hitboxColor",type:t.COLOR4,defaultValue:[0,.5,.5,.5]},HITBOX_TEXTURE_NAME:{name:"hitboxTexture",type:"string",defaultValue:"white"},HITBOX_SHADER_NAME:{name:"hitboxShader",type:"string",defaultValue:"oneColor"},DEFAULT_FIGHTER_VIEW_NAME:{name:"defaultFighterViewName",type:"string"},DEFAULT_FIGHTER_VIEW_NAME_OPTIONS:{name:"defaultFighterViewNameOptions",type:m.STRING_ARRAY},DEFAULT_SHIP_VIEW_NAME:{name:"defaultShipViewName",type:"string"},DEFAULT_SHIP_VIEW_NAME_OPTIONS:{name:"defaultShipViewNameOptions",type:m.STRING_ARRAY},HUD:{name:"hud",ALWAYS_SHOW_TARGET_HULL_BAR_AT_CENTER:{name:"alwaysShowTargetHullBarAtCenter",type:"boolean"},AIM_ASSIST_CROSSHAIRS:{name:"aimAssistCrosshairs",type:"boolean"},RELATIVE_TARGET_ORIENTATION:{name:"relativeTargetOrientation",type:"boolean"},SHOW_VERSION_INFO:{name:"showVersionInfo",type:"boolean"},SHOW_FPS_COUNTER:{name:"showFpsCounter",type:"boolean"},HIGHLIGHT_INTERVAL:{name:"highlightInterval",type:"number"},TARGET_SWITCH_ANIMATION_DURATION:{name:"targetSwitchAnimationDuration",type:"number"},AIM_ASSIST_APPEAR_ANIMATION_DURATION:{name:"aimAssistAppearAnimationDuration",type:"number"},HULL_INTEGRITY_DECREASE_ANIMATION_DURATION:{name:"hullIntegrityDecreaseAnimationDuration",type:"number"},SHIELD_DECREASE_ANIMATION_DURATION:{name:"shieldDecreaseAnimationDuration",type:"number"},TARGET_HULL_INTEGRITY_DECREASE_ANIMATION_DURATION:{name:"targetHullIntegrityDecreaseAnimationDuration",type:"number"},TARGET_SHIELD_DECREASE_ANIMATION_DURATION:{name:"targetShieldDecreaseAnimationDuration",type:"number"},SHIP_INDICATOR_HIGHLIGHT_ANIMATION_INTERVAL:{name:"shipIndicatorHighlightAnimationInterval",type:"number"},CENTER_CROSSHAIR:{name:"centerCrosshair",type:m.UI_IMAGE_DESCRIPTOR},CURSOR:{name:"cursor",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{MAPPING:["still","turn"]})},SHIP_ARROW:{name:"shipArrow",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{COLOR:["hostile","friendly","hostileHighlight","friendlyHighlight","newHostile","hostileTarget","friendlyTarget","transmission"],SIZE:["default","target"]})},SHIP_ARROW_POSITION_RADIUS:{name:"shipArrowPositionRadius",type:"number"},TARGET_ARROW_SWITCH_SCALE:{name:"targetArrowSwitchScale",type:"number"},SHIP_INDICATOR:{name:"shipIndicator",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{COLOR:["hostile","friendly","hostileHighlight","friendlyHighlight","newHostile","hostileTarget","friendlyTarget","transmission"],SIZE:["minimum","targetMinimum","maximum"]})},SHIP_INDICATOR_SIZE_FACTOR:{name:"shipIndicatorSizeFactor",type:"number"},TARGET_INDICATOR_SWITCH_SCALE:{name:"targetIndicatorSwitchScale",type:"number"},MISSILE_LOCK_INDICATOR:{name:"missileLockIndicator",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{COLOR:["hostileTarget","friendlyTarget"]},["SIZE"])},MISSILE_LOCK_INDICATOR_COUNT:{name:"missileLockIndicatorCount",type:"number"},MISSILE_LOCK_INDICATOR_RADIUS:{name:"missileLockIndicatorRadius",type:"number"},MISSILE_LOCK_INDICATOR_SIZE:{name:"missileLockIndicatorSize",type:"number"},MISSILE_LOCK_INDICATOR_ANGLE:{name:"missileLockIndicatorAngle",type:"number"},MISSILE_LOCK_INDICATOR_ROTATION_SPEED:{name:"missileLockIndicatorRotationSpeed",type:"number"},MISSILE_LOCK_INDICATOR_BLINK_INTERVAL:{name:"missileLockIndicatorBlinkInterval",type:"number"},DISTANCE_TEXT_LAYER_LAYOUT:{name:"distanceTextLayerLayout",type:m.LAYOUT_DESCRIPTOR},DISTANCE_TEXT:{name:"distanceText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["hostile","friendly"]})},SHIP_STATUS_INDICATOR:{name:"shipStatusIndicator",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{MAPPING:["protect","destroy","transmission"],COLOR:["protect","destroy","transmission"],SIZE:["reticle","arrow"]})},AIM_ASSIST_INDICATOR:{name:"aimAssistIndicator",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{COLOR:["hostile","friendly","appear"]})},AIM_ASSIST_INDICATOR_APPEAR_SCALE:{name:"aimAssistIndicatorAppearScale",type:"number"},WEAPON_IMPACT_INDICATOR:{name:"weaponImpactIndicator",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{COLOR:["normal","outOfRange"]})},WEAPON_IMPACT_INDICATOR_SWITCH_SCALE:{name:"weaponImpactIndicatorSwitchScale",type:"number"},TARGET_VIEW_LAYOUT:{name:"targetViewLayout",type:m.LAYOUT_DESCRIPTOR},TARGET_VIEW_CAMERA_DISTANCE:{name:"targetViewCameraDistance",type:"number"},TARGET_VIEW_VIEW_DISTANCE:{name:"targetViewViewDistance",type:"number"},TARGET_VIEW_FOV:{name:"targetViewFOV",type:"number"},TARGET_VIEW_TARGET_ITEM_SHADER:{name:"targetViewTargetItemShader",type:"string"},TARGET_VIEW_TARGET_ITEM_FULL_INTEGRITY_COLOR:{name:"targetViewTargetItemFullIntegrityColor",type:t.COLOR4},TARGET_VIEW_TARGET_ITEM_HALF_INTEGRITY_COLOR:{name:"targetViewTargetItemHalfIntegrityColor",type:t.COLOR4},TARGET_VIEW_TARGET_ITEM_ZERO_INTEGRITY_COLOR:{name:"targetViewTargetItemZeroIntegrityColor",type:t.COLOR4},TARGET_INFO_BACKGROUND:{name:"targetInfoBackground",type:m.UI_LAID_OUT_IMAGE_DESCRIPTOR},TARGET_HULL_INTEGRITY_BAR:{name:"targetHullIntegrityBar",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty"]})},TARGET_SHIELD_BAR:{name:"targetShieldBar",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty"]})},TARGET_INFO_TEXT_LAYER_LAYOUT:{name:"targetInfoTextLayerLayout",type:m.LAYOUT_DESCRIPTOR},TARGET_INFO_TEXT:{name:"targetInfoText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["hostile","friendly"],FONT_SIZE:["name","others"],POSITION:["name","class","team","firepower","distance","velocity"]})},WINGMEN_STATUS_BACKGROUND:{name:"wingmenStatusBackground",type:m.UI_LAID_OUT_IMAGE_DESCRIPTOR},WINGMEN_STATUS_HEADER_TEXT:{name:"wingmenStatusHeaderText",type:m.TEXT_DESCRIPTOR},WINGMEN_STATUS_CRAFT_INDICATOR:{name:"wingmenStatusCraftIndicator",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{MAPPING:["player","shield","general","interceptor","bomber","heavyFighter"],COLOR:["fullIntegrity","halfIntegrity","zeroIntegrity","destroyed","away","fullShieldIntegrity","halfShieldIntegrity","zeroShieldIntegrity"]})},WINGMEN_STATUS_CRAFT_POSITIONS:{name:"wigmenStatusCraftPositions",type:m.CRAFT_INDICATOR_POSITIONS},WINGMEN_STATUS_SQUAD_LAYOUT:{name:"wigmenStatusSquadLayout",type:m.LAYOUT_DESCRIPTOR},WINGMEN_STATUS_SQUAD_TEXT:{name:"wingmenStatusSquadText",type:m.TEXT_DESCRIPTOR},SPEED_BAR:{name:"speedBar",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["combatFilled","combatEmpty","combatReverseFilled","combatReverseEmpty","cruiseFilled","cruiseEmpty","cruiseReverseFilled","cruiseReverseEmpty","freeFilled","freeEmpty","freeReverseFilled","freeReverseEmpty"]})},SPEED_BAR_BASE_MAX_SPEED_FACTOR:{name:"speedBarBaseMaxSpeedFactor",type:"number"},SPEED_BAR_DEFAULT_BASE_MAX_SPEED:{name:"speedBarDefaultBaseMaxSpeed",type:"number"},SPEED_BAR_MAX_SPEED_STEP_FACTOR:{name:"speedBarMaxSpeedStepFactor",type:"number"},SPEED_BAR_MAX_SPEED_STEP_BUFFER:{name:"speedBarMaxSpeedStepBuffer",type:"number"},SPEED_TEXT_LAYER_LAYOUT:{name:"speedTextLayerLayout",type:m.LAYOUT_DESCRIPTOR},SPEED_TEXT:{name:"speedText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["combatForward","combatReverse","cruiseForward","cruiseReverse","freeForward","freeReverse"],POSITION:["maxForward","maxReverse"]})},SPEED_TARGET_INDICATOR:{name:"speedTargetIndicator",type:m.UI_IMAGE_DESCRIPTOR},MISSILE_INDICATOR:{name:"missileIndicator",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{MAPPING:["single","salvo"],COLOR:["ready","locking","loading"]})},MISSILE_INDICATOR_TEXT_LAYOUT:{name:"missileIndicatorTextLayout",type:m.LAYOUT_DESCRIPTOR},MISSILE_INDICATOR_TEXT:{name:"missileIndicatorText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["ready","locking","loading"]})},HULL_INTEGRITY_BAR:{name:"hullIntegrityBar",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty","filledWhenDecreasing","emptyWhenDecreasing"]})},SHIELD_BAR:{name:"shieldBar",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty","filledWhenDecreasing","emptyWhenDecreasing"]})},FLIGHT_MODE_INDICATOR_BACKGROUND:{name:"flightModeIndicatorBackground",type:m.UI_LAID_OUT_IMAGE_DESCRIPTOR},FLIGHT_MODE_HEADER_TEXT:{name:"flightModeHeaderText",type:m.TEXT_DESCRIPTOR},FLIGHT_MODE_TEXT:{name:"flightModeText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["free","combat","cruise"]})},MISSILE_INFO_BACKGROUND:{name:"missileInfoBackground",type:m.UI_LAID_OUT_IMAGE_DESCRIPTOR},MISSILE_INFO_HEADER_TEXT:{name:"missileInfoHeaderText",type:m.TEXT_DESCRIPTOR},MISSILE_INFO_TEXT:{name:"missileInfoText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["readySelected","lockingSelected","loadingSelected","notSelected","empty"],POSITION:["name","count"]})},MISSILE_INFO_TEXT_OFFSET:{name:"missileInfoTextOffset",type:"number"},MAX_MISSILE_INFO_DISPLAYED:{name:"maxMissileInfoDisplayed",type:"number"},DRIFT_ARROW:{name:"driftArrow",type:m.getCustomDescriptor(m.UI_IMAGE_DESCRIPTOR,{COLOR:["minSpeed","maxSpeed"]})},DRIFT_ARROW_POSITION_RADIUS:{name:"driftArrowPositionRadius",type:"number"},DRIFT_ARROW_MIN_SPEED:{name:"driftArrowMinSpeed",type:"number"},DRIFT_ARROW_MAX_SPEED_FACTOR:{name:"driftArrowMaxSpeedFactor",type:"number"},TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR:{name:"targetHullIntegrityQuickViewBar",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["hostileFilled","hostileEmpty","friendlyFilled","friendlyEmpty","filledWhenDecreasing"]})},TARGET_SHIELD_QUICK_VIEW_BAR:{name:"targetShieldQuickViewBar",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["filled","empty","filledWhenDecreasing"]})},HEADER_TEXT_LAYER_LAYOUT:{name:"headerTextLayerLayout",type:m.LAYOUT_DESCRIPTOR},SMALL_HEADER_TEXT:{name:"smallHeaderText",type:m.TEXT_DESCRIPTOR},BIG_HEADER_TEXT:{name:"bigHeaderText",type:m.TEXT_DESCRIPTOR},SUBHEADER_TEXT:{name:"subheaderText",type:m.TEXT_DESCRIPTOR},MESSAGE_BACKGROUND:{name:"messageBackground",type:m.UI_LAID_OUT_IMAGE_DESCRIPTOR},MESSAGE_TEXT:{name:"messageText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["default","jump","alert","controlString","friendlySpacecraft","hostileSpacecraft","slowConnection","connectionLost"]})},MESSAGE_TEXT_MARGIN:{name:"messageTextMargin",type:"number"},TOP_LEFT_TEXT_LAYER_LAYOUT:{name:"topLeftTextLayerLayout",type:m.LAYOUT_DESCRIPTOR},SCORE_TEXT:{name:"scoreText",type:m.TEXT_DESCRIPTOR},OBJECTIVES_BACKGROUND:{name:"objectivesBackground",type:m.UI_LAID_OUT_IMAGE_DESCRIPTOR},OBJECTIVES_HEADER_TEXT:{name:"objectivesHeaderText",type:m.TEXT_DESCRIPTOR},OBJECTIVES_TEXT:{name:"objectivesText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["inProgress","completed","failed"]})},OBJECTIVES_TEXT_OFFSET:{name:"objectivesTextOffset",type:"number"},MAX_OBJECTIVES_DISPLAYED:{name:"maxObjectivesDisplayed",type:"number"},ESCORTS_BACKGROUND:{name:"escortsBackground",type:m.UI_LAID_OUT_IMAGE_DESCRIPTOR},ESCORTS_HEADER_TEXT:{name:"escortsHeaderText",type:m.TEXT_DESCRIPTOR},ESCORTS_TEXT:{name:"escortsText",type:m.getCustomDescriptor(m.TEXT_DESCRIPTOR,{COLOR:["alive","away","destroyed"]})},ESCORTS_INTEGRITY_BARS:{name:"escortsIntegrityBars",type:m.getCustomDescriptor(m.UI_LAID_OUT_IMAGE_DESCRIPTOR,{COLOR:["fullHull","halfHull","zeroHull","awayHull","destroyed","shield","lostShield"],LAYOUT:["hull","shield"]})},ESCORTS_TEXT_OFFSET:{name:"escortsTextOffset",type:"number"},MAX_ESCORTS_DISPLAYED:{name:"maxEscortsDisplayed",type:"number"},TARGET_SWITCH_SOUND:{name:"targetSwitchSound",type:s.SOUND_EFFECT},TARGET_SWITCH_DENIED_SOUND:{name:"targetSwitchDeniedSound",type:s.SOUND_EFFECT},FLIGHT_MODE_SWITCH_SOUND:{name:"flightModeSwitchSound",type:s.SOUND_EFFECT},MISSILE_CHANGE_SOUND:{name:"missileChangeSound",type:s.SOUND_EFFECT},MISSILE_CHANGE_DENIED_SOUND:{name:"missileChangeDeniedSound",type:s.SOUND_EFFECT},MISSILE_SALVO_SOUND:{name:"missileSalvoSound",type:s.SOUND_EFFECT},MISSILE_LOADED_SOUND:{name:"missileLoadedSound",type:s.SOUND_EFFECT},MISSILE_LOCKING_SOUND:{name:"missileLockingSound",type:s.SOUND_EFFECT},MISSILE_LOCKING_SOUND_COUNT:{name:"missileLockingSoundCount",type:"number"},MISSILE_LOCKED_SOUND:{name:"missileLockedSound",type:s.SOUND_EFFECT},MESSAGE_SOUND:{name:"messageSound",type:s.SOUND_EFFECT},MESSAGE_TYPE_SOUND:{name:"messageTypeSound",type:s.SOUND_EFFECT},NEW_HOSTILES_ALERT_SOUND:{name:"newHostilesAlertSound",type:s.SOUND_EFFECT},CONNECTION_WARNING_SOUND:{name:"connectionWarningSound",type:s.SOUND_EFFECT},NEW_HOSTILES_ALERT_DURATION:{name:"newHostilesAlertDuration",type:"number"},NEW_HOSTILES_ALERT_BLINK_INTERVAL:{name:"newHostilesAlertBlinkInterval",type:"number"}},DEMO_VIEW_SWITCHING:{name:"demoViewSwitching",type:"boolean"},ANTICIPATION_MUSIC:{name:"anticipationMusic",type:m.STRING_ARRAY},COMBAT_MUSIC:{name:"combatMusic",type:m.STRING_ARRAY},DEFAULT_SALVO_MODE:{name:"defaultSalvoMode",type:"boolean"}},u={},d=g+h.HUD.name+"_",p=g+"battle_",Object.freeze(m),ConfigurationContext.prototype=new i.AsyncResource,ConfigurationContext.prototype.constructor=ConfigurationContext,ConfigurationContext.prototype.loadConfigurationFromJSON=function(e){this._configuration=t.getVerifiedObject("configuration",e,r)},ConfigurationContext.prototype.getConfigurationSetting=function(e){return this._configuration[e.name]},ConfigurationContext.prototype.getSetting=function(e){return this._settings[e.name]},ConfigurationContext.prototype.getGeneralSetting=function(e){var i;return void 0!==localStorage[g+e.name]&&(i=t.getValueOfTypeFromLocalStorage(e.type,g+e.name)),void 0!==i?i:this._settings[e.name]},ConfigurationContext.prototype.setGeneralSetting=function(e,t){localStorage[g+e.name]=t},ConfigurationContext.prototype.getBattleSetting=function(e){var i;return void 0!==localStorage[p+e.name]&&(i=t.getValueOfTypeFromLocalStorage(e.type,p+e.name)),void 0!==i?i:this._settings[e.name]},ConfigurationContext.prototype.setBattleSetting=function(e,t){localStorage[p+e.name]=t},ConfigurationContext.prototype.gHS=function(e){var i;return void 0===this._hudSettings[e.name]&&(void 0!==localStorage[d+e.name]&&(i=t.getValueOfTypeFromLocalStorage(e.type,d+e.name)),this._hudSettings[e.name]=void 0!==i?i:this._settings[h.HUD.name][e.name]),this._hudSettings[e.name]},ConfigurationContext.prototype.setHUDSetting=function(e,t){localStorage[d+e.name]=t,this._hudSettings[e.name]=t},ConfigurationContext.prototype.resetGeneralSettings=function(){var e,t,i=Object.keys(a);for(e=0;e<i.length;e++)"object"==typeof a[i[e]]&&(t=a[i[e]].name,localStorage.removeItem(g+t))},ConfigurationContext.prototype.resetHUDSettings=function(){var e,t,i=Object.keys(h.HUD);for(e=0;e<i.length;e++)"object"==typeof h.HUD[i[e]]&&(t=h.HUD[i[e]].name,localStorage.removeItem(d+t),this._hudSettings[t]=this._settings[h.HUD.name][t])},ConfigurationContext.prototype.resetBattleSettings=function(){var e,t=Object.keys(h);for(e=0;e<t.length;e++)"object"==typeof h[t[e]]&&localStorage.removeItem(p+h[t[e]].name)},ConfigurationContext.prototype.getDefaultCameraFOV=function(){return 40},ConfigurationContext.prototype.getDefaultCameraSpan=function(){return.2},ConfigurationContext.prototype.getDefaultCameraBaseOrientation=function(){return"orientationFollowedObject"},ConfigurationContext.prototype.getDefaultCameraPointToFallback=function(){return"positionFollowedObjectOrWorld"},ConfigurationContext.prototype.getDefaultCameraConfigurationName=function(e){return e.isFighter()?this.getBattleSetting(h.DEFAULT_FIGHTER_VIEW_NAME):this.getBattleSetting(h.DEFAULT_SHIP_VIEW_NAME)},ConfigurationContext.prototype.loadSettingsFromJSON=function(e){this._settings=t.getVerifiedObject("general",e.general,a),t.getVerifiedObject("multi",e.multi,l,this._settings),t.getVerifiedObject("database",e.database,c,this._settings),t.getVerifiedObject("battle",e.battle,h,this._settings),t.getVerifiedObject("camera",e.camera,u,this._settings),s.requestLoad(this.getConfigurationSetting(r.CLASSES_SOURCE_FILE),function(){this.setToReady()}.bind(this))},_=new ConfigurationContext,{CONFIGURATION:r,GENERAL_SETTINGS:a,MULTI_SETTINGS:l,BS:h,DATABASE_SETTINGS:c,CAMERA_SETTINGS:u,loadConfigurationFromJSON:_.loadConfigurationFromJSON.bind(_),loadSettingsFromJSON:_.loadSettingsFromJSON.bind(_),getConfigurationSetting:_.getConfigurationSetting.bind(_),getSetting:_.getSetting.bind(_),getGeneralSetting:_.getGeneralSetting.bind(_),setGeneralSetting:_.setGeneralSetting.bind(_),gHS:_.gHS.bind(_),setHUDSetting:_.setHUDSetting.bind(_),getBattleSetting:_.getBattleSetting.bind(_),setBattleSetting:_.setBattleSetting.bind(_),resetGeneralSettings:_.resetGeneralSettings.bind(_),resetHUDSettings:_.resetHUDSettings.bind(_),resetBattleSettings:_.resetBattleSettings.bind(_),getDefaultCameraFOV:_.getDefaultCameraFOV.bind(_),getDefaultCameraSpan:_.getDefaultCameraSpan.bind(_),getDefaultCameraBaseOrientation:_.getDefaultCameraBaseOrientation.bind(_),getDefaultCameraPointToFallback:_.getDefaultCameraPointToFallback.bind(_),getDefaultCameraConfigurationName:_.getDefaultCameraConfigurationName.bind(_),executeWhenReady:_.executeWhenReady.bind(_)}}),define("modules/pools",[],function(){"use strict";function Pool(e){this._objectConstructor=e,this._objects=[],this._objectsFree=[],this._freeIndices=[],this._firstFreeIndex=0,this._firstLockedIndex=0}function getPool(t,i){var n=e[t]||new Pool(i);return e[t]=n,n}var e={};return Pool.prototype.markAsFree=function(e){this._objectsFree[e]||(this._freeIndices[this._firstLockedIndex]=e,this._objectsFree[e]=!0,++this._firstLockedIndex>=this._freeIndices.length&&(this._firstLockedIndex=0))},Pool.prototype.getFreeObject=function(){var e;return this._objectsFree[this._freeIndices[this._firstFreeIndex]]?(this._objectsFree[this._freeIndices[this._firstFreeIndex]]=!1,e=this._objects[this._freeIndices[this._firstFreeIndex]],this._firstFreeIndex++,this._firstFreeIndex>=this._freeIndices.length&&(this._firstFreeIndex=0),e):null},Pool.prototype.addObject=function(e){this._objects.push(e),this._objectsFree.push(!1),this._firstFreeIndex<this._firstLockedIndex||this._firstFreeIndex===this._firstLockedIndex&&!this._objectsFree[this._freeIndices[this._firstFreeIndex]]?this._freeIndices.push(-1):(this._freeIndices.splice(this._firstLockedIndex,0,-1),++this._firstFreeIndex>=this._freeIndices.length&&(this._firstFreeIndex=0))},Pool.prototype.getObjects=function(){return this._objects},Pool.prototype.getObject=function(){var e=this.getFreeObject();return e||(e=new this._objectConstructor,this.addObject(e)),e},Pool.prototype.hasLockedObjects=function(){return this._firstFreeIndex!==this._firstLockedIndex||!this._objectsFree[this._freeIndices[this._firstFreeIndex]]},Pool.prototype.getLockedObjectCount=function(){return this._firstFreeIndex===this._firstLockedIndex?this._objectsFree[this._freeIndices[this._firstFreeIndex]]?0:this._objects.length:this._firstFreeIndex<this._firstLockedIndex?this._objects.length-(this._firstLockedIndex-this._firstFreeIndex):this._firstFreeIndex-this._firstLockedIndex},Pool.prototype.executeForLockedObjects=function(e){var t,i=this._freeIndices.length;if(i>0)for(t=0;t<i;t++)this._objectsFree[t]||e(this._objects[t],t)},Pool.prototype.clear=function(){this._objects=[],this._objectsFree=[],this._freeIndices=[],this._firstFreeIndex=0,this._firstLockedIndex=0},Pool.prototype.prefill=function(e,t){var i;for(this._objects.length>0&&this.clear(),this._objects=new Array(e),this._objectsFree=new Array(e),this._freeIndices=new Array(e),i=0;i<e;i++)this._objects[i]=new this._objectConstructor,this._objectsFree[i]=!0,this._freeIndices[i]=i;if(t)for(i=0;i<e;i++)t(this._objects[i],i);this._firstFreeIndex=0,this._firstLockedIndex=0},{Pool:Pool,getPool:getPool}}),define("modules/scene/particle-system",["utils/utils","utils/vectors","utils/matrices","modules/scene/renderable-objects","modules/scene/scene-graph"],function(e,t,i,n,s){"use strict";function ParticleEmitter(e,t,i,n,s,o,r,a,l,c,h){this.pM=e,this.oM=t,this._dimensions=i,this._velocity=n,this._velocitySpread=s,this._initialNumber=o,this._spawnNumber=r,this._spawnTime=a,this._age=0,this._duration=l,this._delay=c||0,this._lastSpawn=0,this._createParticleFunction=h,this._particleDuration=-1,this._size=0,e&&this._calculateSize()}function OmnidirectionalParticleEmitter(e,t,i,n,s,o,r,a,l,c,h){ParticleEmitter.call(this,e,t,i,n,s,o,r,a,l,c,h),this._calculateSize()}function UnidirectionalParticleEmitter(t,i,n,s,o,r,a,l,c,h,u,d,p){ParticleEmitter.call(this,t,i,n,r,a,l,c,h,u,d,p),this._direction=s,this._directionSpread=o*e.RAD}function PlanarParticleEmitter(t,i,n,s,o,r,a,l,c,h,u,d,p){ParticleEmitter.call(this,t,i,n,r,a,l,c,h,u,d,p),this._planeNormal=s,this._directionSpread=o*e.RAD}function ParticleSystem(e,t,i,s,o,r,a,l,c,h){n.RenderableObject3D.call(this,null,!1,!0,e,t,i,void 0,1,!0),this._velocityMatrix=s,this._emitters=o,this._age=0,this._duration=r,this._keepAlive=!0===a,this._carriesParticles=!0===l,this._hasRelativeOrientation=!0===c,this._particleCountFactor=void 0!==h?h:1,this._calculateSize()}return ParticleEmitter.prototype._calculateSize=function(){var e=this._createParticleFunction();this._size=i.translationLength(this.pM)+t.length3(this._dimensions)+Math.max((this._velocity+.5*this._velocitySpread)*e._duration*.001+e.getFinalSize(),e.getMaxSize()),e.markAsReusable(!0)},ParticleEmitter.prototype.getSize=function(){return this._size},ParticleEmitter.prototype.getParticleDuration=function(){var e;return-1===this._particleDuration&&(this._particleDuration=0,e=this._createParticleFunction(),this._particleDuration=e._duration,e.markAsReusable(!0)),this._particleDuration},ParticleEmitter.prototype._emitParticle=function(){var e,i;return e=this._createParticleFunction(),i=[this.pM[12]+(Math.random()-.5)*this._dimensions[0],this.pM[13]+(Math.random()-.5)*this._dimensions[1],this.pM[14]+(Math.random()-.5)*this._dimensions[2]],e.setPositionv(t.prodVec3Mat4Aux(i,this.oM)),e},ParticleEmitter.prototype.emitParticles=function(e,t){var i,n,s;if(i=[],void 0===t&&(t=1),this._delay>0&&(this._delay-=e,this._delay<=0&&(e=-this._delay,this._delay=0)),0===this._delay){if(0===this._age)for(s=Math.round(this._initialNumber*t),this._initialNumber>0&&s<1&&(s=1),n=0;n<s;n++)i.push(this._emitParticle());for(this._age+=e;this._age-this._lastSpawn>this._spawnTime&&(this._lastSpawn<this._duration||0===this._duration);){for(s=Math.round(this._spawnNumber*t),this._spawnNumber>0&&s<1&&(s=1),n=0;n<s;n++)i.push(this._emitParticle());this._lastSpawn+=this._spawnTime}}return i},ParticleEmitter.prototype.addToContext=function(e){var t=this._createParticleFunction()
;t.addToContext(e),t.markAsReusable(!0)},OmnidirectionalParticleEmitter.prototype=new ParticleEmitter,OmnidirectionalParticleEmitter.prototype.constructor=OmnidirectionalParticleEmitter,OmnidirectionalParticleEmitter.prototype._emitParticle=function(){var t,i,n,s,o,r,a,l=ParticleEmitter.prototype._emitParticle.call(this);return t=this._velocity+(Math.random()-.5)*this._velocitySpread,i=Math.random()*e.DOUBLE_PI,n=Math.random()*e.DOUBLE_PI,s=Math.sin(i),o=Math.cos(i),r=Math.sin(n),a=Math.cos(n),l.setVelocity(t*o*a,t*o*r,t*s),l},UnidirectionalParticleEmitter.prototype=new ParticleEmitter,UnidirectionalParticleEmitter.prototype.constructor=UnidirectionalParticleEmitter,UnidirectionalParticleEmitter.prototype._emitParticle=function(){var n,s,o,r=ParticleEmitter.prototype._emitParticle.call(this);return n=this._velocity+(Math.random()-.5)*this._velocitySpread,s=t.scaled3Aux(this._direction,n),o=Math.abs(this._direction[0])<.75?t.x3Aux():Math.abs(this._direction[1])<.75?t.y3Aux():t.z3Aux(),t.mulCross3(o,this._direction),t.normalize3(o),t.mulVec3Mat3(s,i.rotation3Aux(o,Math.random()*this._directionSpread)),t.mulVec3Mat3(s,i.rotation3Aux(this._direction,Math.random()*e.DOUBLE_PI)),r.setVelocity(s[0],s[1],s[2]),r},PlanarParticleEmitter.prototype=new ParticleEmitter,PlanarParticleEmitter.prototype.constructor=UnidirectionalParticleEmitter,PlanarParticleEmitter.prototype._emitParticle=function(){var n,s,o,r=ParticleEmitter.prototype._emitParticle.call(this);return s=this._velocity+(Math.random()-.5)*this._velocitySpread,n=Math.abs(this._planeNormal[0])<.75?t.x3Aux():Math.abs(this._planeNormal[1])<.75?t.y3Aux():t.z3Aux(),t.mulCross3(n,this._planeNormal),t.normalize3(n),o=t.scaled3Aux(n,s),t.mulVec3Mat3(o,i.rotation3Aux(t.cross3Aux(n,this._planeNormal),(Math.random()-.5)*this._directionSpread)),t.mulVec3Mat3(o,i.rotation3Aux(this._planeNormal,Math.random()*e.DOUBLE_PI)),r.setVelocity(o[0],o[1],o[2]),r},ParticleSystem.prototype=new n.RenderableObject3D,ParticleSystem.prototype.constructor=ParticleSystem,ParticleSystem.prototype.init=function(e,t,i,s,o,r,a,l,c,h){n.RenderableObject3D.prototype.init.call(this,null,!1,!0,e,t,i,void 0,1,!0),this._velocityMatrix=s,this._emitters=o,this._age=0,this._duration=r,this._keepAlive=!0===a,this._carriesParticles=!0===l,this._hasRelativeOrientation=!0===c,this._particleCountFactor=void 0!==h?h:1,this._calculateSize()},ParticleSystem.prototype._calculateSize=function(){var e,t=0;for(e=0;e<this._emitters.length;e++)t=Math.max(t,this._emitters[e].getSize());this.setSize(t)},ParticleSystem.prototype._handleOrientationChanged=function(){var e;if(this._carriesParticles&&this._node)for(e=this._node._subnodes._first;e;e=e.next)e._renderableObject.invalidateWorldVelocityDirectionVector()},ParticleSystem.prototype.shouldBeRendered=function(e){return this.updateVisibleSize(e,!1),!1},ParticleSystem.prototype.performAnimate=function(e){var t,i,n,o;if(!this._keepAlive&&this._age>this._duration)return void this._node.markAsReusable(!0);if(this._age+=e,this._emitters)for(t=0;t<this._emitters.length;t++)if(n=this._emitters[t].emitParticles(e,this._particleCountFactor),this._carriesParticles)for(i=0;i<n.length;i++)this._node.addSubnode(n[i]._node||new s.RenderableNode(n[i],!1,!1,!0));else if(this._hasRelativeOrientation)for(o=this.getModelMatrix(),i=0;i<n.length;i++)n[i].translateByMatrix(o),n[i].rotateByMatrix(o),this._node.getScene().addNode(n[i]._node||new s.RenderableNode(n[i],!1,!1,!0));else for(o=this.getModelMatrix(),i=0;i<n.length;i++)n[i].translateByMatrix(o),this._node.getScene().addNode(n[i]._node||new s.RenderableNode(n[i],!1,!1,!0));this.translateByMatrixMul(this._velocityMatrix,.001*e)},ParticleSystem.prototype.finishEmitting=function(){var e,t,i=0;if(this._keepAlive=!1,this._carriesParticles){if(this._emitters){for(this._age=0,e=0;e<this._emitters.length;e++)(t=this._emitters[e].getParticleDuration())>i&&(i=t);this._emitters=null,this._duration=i}}else this._duration=0,this._node.markAsReusable(!0)},ParticleSystem.prototype.addToContext=function(e){var t;for(t=0;t<this._emitters.length;t++)this._emitters[t].addToContext(e)},{ParticleEmitter:ParticleEmitter,OmnidirectionalParticleEmitter:OmnidirectionalParticleEmitter,UnidirectionalParticleEmitter:UnidirectionalParticleEmitter,PlanarParticleEmitter:PlanarParticleEmitter,ParticleSystem:ParticleSystem}}),define("armada/logic/constants",[],function(){"use strict";return{SPACECRAFT_LIGHT_PRIORITY:0,EXPLOSION_LIGHT_PRIORITY:1,PROJECTILE_LIGHT_PRIORITY:2,MISSILE_LIGHT_PRIORITY:3,BLINKER_LIGHT_PRIORITY:4,PARTICLE_POOL_NAME:"Particle",PROJECTILE_POOL_NAME:"Projectile",MISSILE_POOL_NAME:"Missile",TRAIL_POOL_NAME:"Trail",TRAIL_SEGMENT_POOL_NAME:"TrailSegment",EXPLOSION_POOL_NAME:"Explosion",MULTI_HOST_DATA_LENGTH:30,MULTI_GUEST_DATA_LENGTH:8}}),define("armada/logic/explosion",["utils/vectors","utils/matrices","modules/application","modules/media-resources","modules/pools","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","modules/scene/particle-system","armada/graphics","armada/logic/classes","armada/configuration","armada/logic/constants","utils/polyfill"],function(e,t,i,n,s,o,r,a,l,c,h,u,d){"use strict";function handleGraphicsSettingsChanged(){f=c.areDynamicLightsAvailable()&&c.getMaxPointLights()>0}function getExplosion(){return m.getObject()}function Explosion(e,i,n,s,o,r,a,l){this._class=e,this.pM=i||t.identity4(),this.oM=n||t.identity4(),this._direction=s||[0,0,0],this._carriesParticles=!0===o,this._hasRelativeOrientation=!0===r,this._velocityMatrix=a||t.identity4(),this._ignoreParticleCountFactor=!0===l,this.vMo=null}var p,_,g,m,f=!1;return Explosion.prototype.init=function(e,i,n,s,o,r,a,l){this._class=e,t.copyTranslation4(this.pM,i),t.copyRotation4(this.oM,n),this._direction[0]=s[0],this._direction[1]=s[1],this._direction[2]=s[2],this._carriesParticles=!0===o,this._hasRelativeOrientation=!0===r,this._ignoreParticleCountFactor=!0===l,t.copyTranslation4(this._velocityMatrix,a||t.IDENTITY4)},Explosion.prototype.createVisualModel=function(e,i){this.vMo=new l.ParticleSystem(this.pM,this.oM,e?t.scaling4(e):t.identity4(),this._velocityMatrix,i||[],this._class?this._class.getTotalDuration():0,!!this._class&&this._class.isContinuous(),this._carriesParticles,this._hasRelativeOrientation,this._ignoreParticleCountFactor?1:c.getParticleCountFactor())},Explosion.prototype.canBeReused=function(){return this.vMo&&this.vMo.canBeReused()},Explosion.prototype.getEmitterParticleConstructor=function(e){var i=this._class._particleEmitterDescriptors[e],n=i.getModel(),s=i.getShader(),o=i.getTexturesOfTypes(i.getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),r=i.getParticleStates(),a=i.getInstancedShader();return function(){var e=g.getObject();return e.init(n,s,o,t.IDENTITY4,r,!1,a),e}.bind(this)},Explosion.prototype._initVisualModel=function(e){var i,n,s,o;for(n=[],o=this._class._particleEmitterDescriptors,i=0;i<o.length;i++){switch(o[i].getType()){case h.ParticleEmitterType.OMNIDIRECTIONAL:s=new l.OmnidirectionalParticleEmitter(t.IDENTITY4,t.IDENTITY4,o[i]._dimensions,o[i]._velocity,o[i]._velocitySpread,o[i]._initialNumber,o[i]._spawnNumber,o[i]._spawnTime,o[i]._duration,o[i]._delay,this.getEmitterParticleConstructor(i));break;case h.ParticleEmitterType.UNIDIRECTIONAL:s=new l.UnidirectionalParticleEmitter(t.IDENTITY4,t.IDENTITY4,o[i]._dimensions,this._direction,o[i]._directionSpread,o[i]._velocity,o[i]._velocitySpread,o[i]._initialNumber,o[i]._spawnNumber,o[i]._spawnTime,o[i]._duration,o[i]._delay,this.getEmitterParticleConstructor(i));break;case h.ParticleEmitterType.PLANAR:s=new l.PlanarParticleEmitter(t.IDENTITY4,t.IDENTITY4,o[i]._dimensions,this._direction,o[i]._directionSpread,o[i]._velocity,o[i]._velocitySpread,o[i]._initialNumber,o[i]._spawnNumber,o[i]._spawnTime,o[i]._duration,o[i]._delay,this.getEmitterParticleConstructor(i))}n.push(s)}this.vMo?this.vMo.init(this.pM,this.oM,e?t.scaling4Aux(e):t.IDENTITY4,this._velocityMatrix,n,this._class.getTotalDuration(),this._class.isContinuous(),this._carriesParticles,this._hasRelativeOrientation,this._ignoreParticleCountFactor?1:c.getParticleCountFactor()):this.createVisualModel(e,n)},Explosion.prototype.addToSceneNow=function(t,i,n,s){var o,l=t.getScene();this._initVisualModel(1/t._renderableObject.getCascadeScalingMatrix()[0]),t.addSubnode(this.vMo._node||new a.RenderableNode(this.vMo,!1)),f&&(o=this._class.getLightStates())&&l.addPointLightSource(new r.PointLightSource(o[0].color,o[0].intensity,e.NULL3,[this.vMo],o),d.EXPLOSION_LIGHT_PRIORITY),this._class.playSound(i,n,p,_),s&&s(this.vMo)},Explosion.prototype.addToScene=function(e,t,i,s){n.executeWhenReady(this.addToSceneNow.bind(this,e,t,i,s))},Explosion.prototype.addResourcesToScene=function(e){var t="explosion/"+this._class._name;this._class.acquireResources({sound:!0}),n.executeWhenReady(function(){e.hasResourcesOfObject(t)||(this._initVisualModel(),e.addResourcesOfObject(this.vMo,t))}.bind(this))},Explosion.prototype.finish=function(){this.vMo.finishEmitting()},Explosion.prototype.destroy=function(){this._class=null,this.pM=null,this.oM=null,this._direction=null,this.vMo&&this.vMo._node.markAsReusable(!0),this.vMo=null},g=s.getPool(d.PARTICLE_POOL_NAME,o.Particle),m=s.getPool(d.EXPLOSION_POOL_NAME,Explosion),u.executeWhenReady(function(){p=.1,_=.5,c.executeWhenReady(handleGraphicsSettingsChanged),c.onSettingsChange(handleGraphicsSettingsChanged)}),{getExplosion:getExplosion,Explosion:Explosion}}),define("armada/logic/environments",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/async-resource","modules/media-resources","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","armada/graphics","armada/logic/classes","armada/logic/explosion","armada/configuration","armada/strings","utils/polyfill"],function(e,t,i,n,s,o,r,a,l,c,h,u,d,p){"use strict";function getDebugInfo(){return g}function Skybox(e){this._class=e}function BackgroundObject(e,t,i,n,s){this._class=e,this._size=t,this._direction=[Math.cos(Math.radians(i))*Math.cos(Math.radians(n)),Math.sin(Math.radians(i))*Math.cos(Math.radians(n)),Math.sin(Math.radians(n))],this._angle=Math.radians(s)||0}function DustParticle(e,t){this._positionVector=t,this.vMo=null,this._cloud=e,this._range=e.getRange()}function DustCloud(e){this._class=e,this._particles=null,this.vMo=null}function ParticleEffect(e){this._origin=e.position?e.position.slice():[0,0,0],this._origin.push(1),this._position=[0,0,0,1],this._relativeToCamera=!1!==e.relativeToCamera,this._effect=new u.Explosion(h.getExplosionClass(e.class),this._relativeToCamera?void 0:i.translation4v(this._origin),void 0,e.direction||[0,0,1],!1,!0===e.relativeDirection,void 0,!0)}function Environment(e){this._name=null,this._location=null,this._color=null,this._skyboxes=null,this._backgroundObjects=null,this._dustClouds=null,this._particleEffects=null,this._shadows=!1,this._ambientColor=null,this._drag=0,this._angularDrag=0,this._sensorRangeFactor=0,this._lockingTimeFactor=0,this._camera=null,this._dataJSON=null,void 0!==e&&this.loadFromJSON(e)}function EnvironmentContext(){s.AsyncResource.call(this),this._environments=null}var _,g="";return Skybox.prototype.addToScene=function(e){this._class.acquireResources(),o.executeWhenReady(function(){e.addBackgroundObject(new r.CubemapSampledFVQ(this._class.getModel(),this._class.getShader(),this._class.getShader().getCubemapNames()[0],this._class.getCubemap(c.getCubemapQualityPreferenceList()),e._camera))}.bind(this))},Skybox.prototype.destroy=function(){this._class=null},BackgroundObject.prototype.addToScene=function(e,n){!n&&this._class._lightColor&&e.addDirectionalLightSource(new a.DirectionalLightSource(this._class._lightColor,this._direction)),this._class.acquireResources(),o.executeWhenReady(function(){var n,s,o;for(s=this._class._layers,n=0;n<s.length;n++)o=new r.BackgroundBillboard(s[n].getModel(),s[n].getShader(),s[n].getTexturesOfTypes(s[n].getShader().getTextureTypes(),c.getTextureQualityPreferenceList()),s[n]._color,s[n].getSize()*this._size,i.translation4v(t.scaled3Aux(this._direction,4500)),this._angle),o.setRelativeSize(1),e.addBackgroundObject(o)}.bind(this))},BackgroundObject.prototype.destroy=function(){this._class=null,this._direction=null},DustParticle.prototype.addToScene=function(e,t){this.vMo=new r.PointParticle(this._cloud.getClass().getModel(),this._cloud.getClass().getShader(),this._cloud.getClass().getInstancedShader(),this._positionVector,t?this._cloud.getClass()._color:null,t?this._range:0),e.addSubnode(new l.RenderableNode(this.vMo,!1,!1,!0))},DustParticle.prototype.simulate=function(e){this.vMo.fitPositionWithinRange(e.getCameraPositionMatrix(),this._range)},DustParticle.prototype.destroy=function(){this._positionVector=null,this.vMo&&(this.vMo._node.markAsReusable(!0),this.vMo=null),this._cloud=null},DustCloud.prototype.getClass=function(){return this._class},DustCloud.prototype.getRange=function(){return this._class.getRange()},DustCloud.prototype.addToScene=function(e){var t,i,n;for(this._class.acquireResources(),this._particles=[],i=this._class.getNumberOfParticles(),t=0;t<i;t++)n=new DustParticle(this,[2*(Math.random()-.5)*this._class.getRange(),2*(Math.random()-.5)*this._class.getRange(),2*(Math.random()-.5)*this._class.getRange()]),this._particles.push(n);o.executeWhenReady(function(){var t,n;for(this.vMo=new r.RenderableObject(null,!1,!1,void 0,!1),n=e.addNode(new l.RenderableNode(this.vMo,!1,!0)),t=0;t<i;t++)this._particles[t].addToScene(n,0===t)}.bind(this))},DustCloud.prototype.simulate=function(e){var t,i;for(i=this._class.getNumberOfParticles(),this._particles[0].vMo.setShift(e._velocityVector[0],e._velocityVector[1],e._velocityVector[2]),t=0;t<i;t++)this._particles[t].simulate(e)},DustCloud.prototype.destroy=function(){var e,t;if(t=this._class.getNumberOfParticles(),this._class=null,this._particles){for(e=0;e<t;e++)this._particles[e].destroy(),this._particles[e]=null;this._particles=null}this.vMo&&(this.vMo._node.markAsReusable(!0),this.vMo=null)},ParticleEffect.prototype.addResourcesToScene=function(e){this._effect.addResourcesToScene(e)},ParticleEffect.prototype.addToScene=function(e){this._effect.addToScene(e._rootNode)},ParticleEffect.prototype.simulate=function(e){var i;this._relativeToCamera&&(t.setVector4(this._position,this._origin),i=e.getCameraOrientationMatrix(),t.mulVec4Mat4(this._position,i),t.add3(this._position,e.getCameraPositionVector()),this._effect.vMo.setPositionv(this._position),this._effect.vMo.setOrientationM4(i))},ParticleEffect.prototype.destroy=function(){this._origin=null,this._position=null,this._effect&&this._effect.destroy(),this._effect=null},Environment.prototype.loadFromJSON=function(e){var t,i;if(this._dataJSON=e,this._name=e.name,this._location=e.location,this._color=e.color||[0,0,0,0],this._skyboxes=[],e.skyboxes)for(t=0;t<e.skyboxes.length;t++)this._skyboxes.push(new Skybox(h.getSkyboxClass(e.skyboxes[t].class)));if(this._backgroundObjects=[],e.backgroundObjects)for(t=0;t<e.backgroundObjects.length;t++)i=h.getBackgroundObjectClass(e.backgroundObjects[t].class),e.backgroundObjects[t].position||n.showError("No position specified for background object of class '"+i._name+"' in environment '"+this._name+"'!",n.ErrorSeverity.MINOR),this._backgroundObjects.push(new BackgroundObject(i,e.backgroundObjects[t].size||n.showError("No size specified for background object of class '"+i._name+"' in environment '"+this._name+"'!",n.ErrorSeverity.MINOR)||0,e.backgroundObjects[t].position&&e.backgroundObjects[t].position.angleAlpha||0,e.backgroundObjects[t].position&&e.backgroundObjects[t].position.angleBeta||0,e.backgroundObjects[t].position&&e.backgroundObjects[t].position.angleGamma||0));if(this._dustClouds=[],e.dustClouds)for(t=0;t<e.dustClouds.length;t++)this._dustClouds.push(new DustCloud(h.getDustCloudClass(e.dustClouds[t].class)));if(this._particleEffects=[],e.particleEffects)for(t=0;t<e.particleEffects.length;t++)this._particleEffects.push(new ParticleEffect(e.particleEffects[t]));this._shadows=!1!==e.shadows,this._ambientColor=e.ambientColor||[0,0,0],this._drag=e.drag||0,this._angularDrag=e.angularDrag||0,this._sensorRangeFactor=void 0!==e.sensorRangeFactor?e.sensorRangeFactor:1,this._lockingTimeFactor=void 0!==e.lockingTimeFactor?e.lockingTimeFactor:1},Environment.prototype.getDisplayName=function(){return this._location?e.formatString(p.get(p.LOCATION.SYSTEM),{systemName:this._location}):p.get(p.LOCATION.UNKNOWN)},Environment.prototype.hasShadows=function(){return this._shadows},Environment.prototype.getDrag=function(){return this._drag},Environment.prototype.getSensorRangeFactor=function(){return this._sensorRangeFactor},Environment.prototype.getLockingTimeFactor=function(){return this._lockingTimeFactor},Environment.prototype.getData=function(){return this._dataJSON},Environment.prototype.reloadData=function(){this.loadFromJSON(this._dataJSON)},Environment.prototype.addToScene=function(e){var t;for(e._clearColor=this._color,t=0;t<this._skyboxes.length;t++)this._skyboxes[t].addToScene(e);for(t=0;t<this._backgroundObjects.length;t++)this._backgroundObjects[t].addToScene(e,!1);for(t=0;t<this._dustClouds.length;t++)this._dustClouds[t].addToScene(e);for(t=0;t<this._particleEffects.length;t++)this._particleEffects[t].addResourcesToScene(e);this._camera=e._camera,e._ambientColor=this._ambientColor},Environment.prototype.addParticleEffectsToScene=function(e){var t;for(t=0;t<this._particleEffects.length;t++)this._particleEffects[t].addToScene(e);return this._particleEffects.length>0},Environment.prototype.simulate=function(){var e;if(this._camera){for(e=0;e<this._dustClouds.length;e++)this._dustClouds[e].simulate(this._camera);for(e=0;e<this._particleEffects.length;e++)this._particleEffects[e].simulate(this._camera)}},Environment.prototype.removeFromScene=function(){this._camera=null},Environment.prototype.destroy=function(){var e;if(this._skyboxes){for(e=0;e<this._skyboxes.length;e++)this._skyboxes[e].destroy(),this._skyboxes[e]=null;this._skyboxes=null}if(this._backgroundObjects){for(e=0;e<this._backgroundObjects.length;e++)this._backgroundObjects[e].destroy(),this._backgroundObjects[e]=null;this._backgroundObjects=null}if(this._dustClouds){for(e=0;e<this._dustClouds.length;e++)this._dustClouds[e].destroy(),this._dustClouds[e]=null;this._dustClouds=null}if(this._particleEffects){for(e=0;e<this._particleEffects.length;e++)this._particleEffects[e].destroy(),this._particleEffects[e]=null;this._particleEffects=null}this._camera=null},EnvironmentContext.prototype=new s.AsyncResource,EnvironmentContext.prototype.constructor=EnvironmentContext,EnvironmentContext.prototype.getEnvironment=function(e){return this._environments[e]||null},EnvironmentContext.prototype.getEnvironmentNames=function(){return Object.keys(this._environments)},EnvironmentContext.prototype.createEnvironment=function(e){this._environments[e.name]=new Environment(e)},EnvironmentContext.prototype.executeForAllEnvironments=function(e){var t,i=this.getEnvironmentNames();for(t=0;t<i.length;t++)e(this._environments[i[t]],"environments")},EnvironmentContext.prototype.requestLoad=function(){n.requestTextFile(d.getConfigurationSetting(d.CONFIGURATION.ENVIRONMENTS_SOURCE_FILE).folder,d.getConfigurationSetting(d.CONFIGURATION.ENVIRONMENTS_SOURCE_FILE).filename,function(e){this.loadEnvironmentsFromJSON(JSON.parse(e)),this.setToReady()}.bind(this))},EnvironmentContext.prototype.loadEnvironmentsFromJSON=function(e){var t,i;for(this._environments={},t=0;t<e.environments.length;t++)i=new Environment(e.environments[t]),this._environments[e.environments[t].name]=i},_=new EnvironmentContext,{requestLoad:_.requestLoad.bind(_),executeWhenReady:_.executeWhenReady.bind(_),getDebugInfo:getDebugInfo,getEnvironment:_.getEnvironment.bind(_),getEnvironmentNames:_.getEnvironmentNames.bind(_),createEnvironment:_.createEnvironment.bind(_),executeForAllEnvironments:_.executeForAllEnvironments.bind(_),Skybox:Skybox,BackgroundObject:BackgroundObject,Environment:Environment}}),define("modules/control/control",["utils/utils","modules/application","modules/async-resource","modules/strings"],function(e,t,i){"use strict";function _setContext(e){n=e}function getContext(){return n}function isPointerLockSupported(){return o}function exitPointerLock(){o&&(a=!0,document.exitPointerLock())}function onPointerLockExit(e){s=e}function isPointerLocked(){return r}function ControlBinding(e,t){this._actionName=null,this._profileName=t,this.loadFromJSON(e)}function InputInterpreter(e,t){this._listening=!1,this._enabled=!0,this._bindingClass=e,this._profiles={},this._profileKeywords={},this._currentProfile=null,this._currentProfileName=null,this._defaultProfileName=null,this._disabledActions={},void 0!==t&&this.loadFromJSON(t)}function Action(e){this._name=null,this._description=null,this._continuous=!1,this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED,this._executed=!1,this._nonTriggeredExecuted=!0,this._executeTriggered=null,this._executeNonTriggered=null,this._source=null,void 0!==e&&this.loadFromJSON(e)}function Controller(e){this._context=null,this._actions={},void 0!==e&&this.loadFromJSON(e)}function ControlContext(){i.AsyncResource.call(this),this._dataJSON=null,this._inputInterpreterTypes={},this._inputInterpreters=null,this._inputInterpretersByType={},this._controllerTypes={},this._controllers=null,this._controllersPriorityQueue=null,this._controllersByType={},this._listening=!1,this._disabledActions={},_setContext(this)}var n,s,o="function"==typeof document.body.requestPointerLock&&"function"==typeof document.exitPointerLock,r=!1,a=!1;return ControlBinding.prototype.getActionName=function(){return this._actionName},ControlBinding.prototype.loadFromJSON=function(e){this._actionName=e?e.action:null},InputInterpreter.prototype.getDeviceName=function(){return"Generic"},InputInterpreter.prototype.isListening=function(){return this._listening},InputInterpreter.prototype.startListening=function(){this._listening||(this.resetState(),this._listening=!0)},InputInterpreter.prototype.stopListening=function(){this._listening&&(this.resetState(),this._listening=!1)},InputInterpreter.prototype.toggleListening=function(){this._listening?this.stopListening():this.startListening()},InputInterpreter.prototype.isEnabled=function(){return this._enabled},InputInterpreter.prototype.enable=function(){this._enabled=!0},InputInterpreter.prototype.disable=function(){this._enabled=!1},InputInterpreter.prototype.toggleEnabled=function(){this._enabled?this.disable():this.enable()},InputInterpreter.prototype.setProfile=function(e){this._profiles.hasOwnProperty(e)&&(this._currentProfile=this._profiles[e],this._currentProfileName=e)},InputInterpreter.prototype.getProfile=function(){return this._currentProfileName},InputInterpreter.prototype.getProfiles=function(){return Object.keys(this._profiles)},InputInterpreter.prototype.setBinding=function(e){this._currentProfile[e.getActionName()]=e},InputInterpreter.prototype.setAndStoreBinding=function(e){var t=new this._bindingClass(e,this._currentProfileName);this.setBinding(t),t.saveToLocalStorage()},InputInterpreter.prototype.loadFromJSON=function(e){var t,i,n,s,o;if(e.profiles){for(n in e.profiles)if(e.profiles.hasOwnProperty(n)){for(s=e.profiles[n],o=[e.profiles[n].bindings];s.basedOn&&e.profiles.hasOwnProperty(s.basedOn);)o.unshift(e.profiles[s.basedOn].bindings),s=e.profiles[s.basedOn];for(this._profiles[n]={},this._currentProfile=this._profiles[n],t=0;t<o.length;t++)for(i=0;i<o[t].length;i++)this.setBinding(new this._bindingClass(o[t][i],n));this._profileKeywords[n]=s.keywords}this._defaultProfileName=e.defaultProfile,this._currentProfile=this._profiles[e.defaultProfile],this._currentProfileName=e.defaultProfile}else for(this._profiles.default={},this._currentProfile=this._profiles.default,this._currentProfileName="default",t=0;t<e.bindings.length;t++)this.setBinding(new this._bindingClass(e.bindings[t],"default"))},InputInterpreter.prototype.loadFromLocalStorage=function(){var e;for(e in this._currentProfile)this._currentProfile.hasOwnProperty(e)&&this._currentProfile[e].loadFromLocalStorage()},InputInterpreter.prototype.removeFromLocalStorage=function(){var e;for(e in this._currentProfile)this._currentProfile.hasOwnProperty(e)&&this._currentProfile[e].removeFromLocalStorage()},InputInterpreter.prototype.getControlStringForAction=function(e){return void 0!==this._currentProfile[e]?this._currentProfile[e].getControlString():""},InputInterpreter.prototype._addActionByBinding=function(e,t,i){var n;if(t){for(n=0;n<e.length;n++)if(i.bindsTheSameControls(e[n].binding))return void e[n].actions.push(t);e.push({binding:i,actions:[t]})}},InputInterpreter.prototype.disableAction=function(e){this._disabledActions[e]=!0},InputInterpreter.prototype.enableAction=function(e){this._disabledActions[e]=!1},InputInterpreter.prototype.getTriggeredActions=function(e){var t,i,n=[],s=[];if(!this.isListening()||!this.isEnabled())return n;for(t in this._currentProfile)this._currentProfile.hasOwnProperty(t)&&(this._disabledActions[t]||e&&!e(t)||this._addActionByBinding(s,this.checkAction(t),this._currentProfile[t]));for(i=0;i<s.length;i++)n.push(s[i].actions);return n},Action.prototype.INTENSITY_NOT_SPECIFIED=-3,Action.prototype.INTENSITY_KEYPRESS=-2,Action.prototype.getDescription=function(){return this._description},Action.prototype.loadFromJSON=function(e){this._name=e.name,this._description=e.description,this._continuous=!0===e.continuous,this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED,this._executed=!1,this._nonTriggeredExecuted=!0},Action.prototype.setTriggered=function(e,t,i){this._triggered=e,void 0!==t&&(this._intensity===this.INTENSITY_NOT_SPECIFIED||this._intensity>=0&&t>this._intensity)?this._intensity=t:void 0===t&&(this._intensity=this.INTENSITY_KEYPRESS),this._source=i},Action.prototype.setExecuteTriggered=function(e){this._executeTriggered=e},Action.prototype.setExecuteNonTriggered=function(e){this._executeNonTriggered=e},Action.prototype.execute=function(){!0===this._continuous?!0===this._triggered?null!==this._executeTriggered&&this._executeTriggered(this._intensity>=0?this._intensity:void 0,this._source):null!==this._executeNonTriggered&&this._executeNonTriggered():!0===this._triggered&&!1===this._executed?(null!==this._executeTriggered&&this._executeTriggered(this._intensity>=0?this._intensity:void 0,this._source),this._executed=!0):(!1===this._triggered&&!1===this._nonTriggeredExecuted&&(null!==this._executeNonTriggered&&this._executeNonTriggered(),this._nonTriggeredExecuted=!0),!1===this._triggered?this._executed=!1:this._nonTriggeredExecuted=!1),this._triggered=!1,this._intensity=this.INTENSITY_NOT_SPECIFIED},Controller.prototype.setContext=function(e){this._context=e},Controller.prototype.getActions=function(){var e,t=[];for(e in this._actions)this._actions.hasOwnProperty(e)&&t.push(this._actions[e]);return t},Controller.prototype.loadFromJSON=function(e){var t,i;for(t=0;t<e.actions.length;t++)i=e.actions[t],i.debug||(this._actions[i.name]=new Action(i))},Controller.prototype.setActionFunction=function(e,i,n){this._actions[e]?!0===i?this._actions[e].setExecuteTriggered(n):this._actions[e].setExecuteNonTriggered(n):t.showError("Attempting to initialize action '"+e+"', but no such action was defined for '"+this.getType()+"' type controllers.",t.ErrorSeverity.SEVERE,"The action definition might be missing from the settings file, or the settings file has not been loaded properly. The game is still playable, but this action will not work until the error with the settings file is corrected and the game is restarted.")},Controller.prototype.setActionFunctions=function(e,t,i){this.setActionFunction(e,!0,t),this.setActionFunction(e,!1,i)},Controller.prototype.executeActions=function(e){var t,i,n,s,o;for(t=0;t<e.length;t++){for(n=null,s=-1,o=null,i=0;i<e[t].length;i++)void 0!==this._actions[e[t][i].name]&&(void 0!==e[t][i].intensity&&void 0!==s&&e[t][i].intensity>s||void 0!==s&&void 0===e[t][i].intensity)&&(n=e[t][i].name,s=e[t][i].intensity,o=e[t][i].source);n&&((void 0===s||s>0)&&this._actions[n].setTriggered(!0,s,o),e[t]=[])}for(n in this._actions)this._actions.hasOwnProperty(n)&&this._actions[n].execute()},Controller.prototype.executeAction=function(e,t,i){this._actions.hasOwnProperty(e)&&(this._actions[e].setTriggered(!0,t,i),this._actions[e].execute())},ControlContext.prototype=new i.AsyncResource,ControlContext.prototype.constructor=ControlContext,ControlContext.prototype.registerInputInterpreterType=function(e,t){this._inputInterpreterTypes[e]=t},ControlContext.prototype.addInputInterpreter=function(i){var n=e.getKeyOfValue(this._inputInterpreterTypes,i.constructor);n?(this._inputInterpreters.push(i),this._inputInterpretersByType[n]=i):t.showError("Attempting to add an input interpreter of an unregistered type to the control context!",t.ErrorSeverity.SEVERE,"Interpreter type: "+i.constructor.name)},ControlContext.prototype.getInputInterpreters=function(){return this._inputInterpreters},ControlContext.prototype.getInputInterpreter=function(e){return this._inputInterpretersByType[e]?this._inputInterpretersByType[e]:(t.showError("Asked for a interpreter of type '"+e+"', which does not exist!"),null)},ControlContext.prototype.registerControllerType=function(e,t){this._controllerTypes[e]=t},ControlContext.prototype.addController=function(i){var n=e.getKeyOfValue(this._controllerTypes,i.constructor);n?(this._controllers.push(i),this._controllersByType[n]=i,i.setContext(this)):t.showError("Attempting to add a controller of an unregistered type to the control context!",t.ErrorSeverity.SEVERE,"Controller type: "+i.prototype.constructor.name)},ControlContext.prototype.getControllers=function(){return this._controllers},ControlContext.prototype.getController=function(e){return this._controllersByType[e]?this._controllersByType[e]:(t.showError("Asked for a controller of type '"+e+"', which does not exist!"),null)},ControlContext.prototype.makeControllerPriority=function(e){var t;for(this._controllersPriorityQueue=[],t=0;t<this._controllers.length;t++)if(this._controllers[t]===e){this._controllersPriorityQueue.push(this._controllers[t]);break}for(t=0;t<this._controllers.length;t++)this._controllers[t]!==e&&this._controllersPriorityQueue.push(this._controllers[t])},ControlContext.prototype.isControllerPriority=function(e){return this._controllersPriorityQueue.length>0&&this._controllersPriorityQueue[0]===this.getController(e)},ControlContext.prototype.restoreDefaultControllerPriorityOrder=function(){this._controllersPriorityQueue=this._controllers},ControlContext.prototype.disableAction=function(e){this._disabledActions[e]=!0},ControlContext.prototype.enableAction=function(e){this._disabledActions[e]=!1},ControlContext.prototype.control=function(e){var t,i,n=function(e){return!this._disabledActions[e]}.bind(this);if(this._listening){for(i=[],t=0;t<this._inputInterpreters.length;t++)i=i.concat(this._inputInterpreters[t].getTriggeredActions(n));for(t=0;t<this._controllersPriorityQueue.length;t++)this._controllersPriorityQueue[t].executeActions(i,e)}},ControlContext.prototype.loadConfigurationFromJSON=function(e){var i,n;for(this._controllers=[],i=0,
n=e.controllers.length;i<n;i++)this._controllerTypes[e.controllers[i].type]?this.addController(new this._controllerTypes[e.controllers[i].type](e.controllers[i])):t.showError("Attempting to load unregistered controller type: '"+e.controllers[i].type+"'!",t.ErrorSeverity.SEVERE,Object.keys(this._controllerTypes).length>0?"Every controller to be loaded must be of one of the registered types: "+Object.keys(this._controllerTypes).join(", ")+".":"There are no types registered and thus loading controllers is not possible.");this._controllersPriorityQueue=this._controllers},ControlContext.prototype.loadSettingsFromJSON=function(e,i){var n,s;if(i)for(n=0,s=e.inputDevices.length;n<s;n++)this._inputInterpreterTypes[e.inputDevices[n].type]&&(this._inputInterpreters[n].removeFromLocalStorage(),this._inputInterpreters[n].loadFromJSON(e.inputDevices[n]));else for(this._dataJSON=e,this._inputInterpreters=[],n=0,s=e.inputDevices.length;n<s;n++)this._inputInterpreterTypes[e.inputDevices[n].type]?this.addInputInterpreter(new this._inputInterpreterTypes[e.inputDevices[n].type](e.inputDevices[n])):e.inputDevices[n].optional||t.showError("Attempting to load unregistered input device type: '"+e.inputDevices[n].type+"'!",t.ErrorSeverity.SEVERE,Object.keys(this._inputInterpreterTypes).length>0?"Every input device interpreter to be loaded must be of one of the registered types: "+Object.keys(this._inputInterpreterTypes).join(", ")+".":"There are no types registered and thus loading input interpreters is not possible.")},ControlContext.prototype.loadSettingsFromLocalStorage=function(){var e;for(e=0;e<this._inputInterpreters.length;e++)this._inputInterpreters[e].loadFromLocalStorage();this.setToReady()},ControlContext.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0)},ControlContext.prototype.startListening=function(){this.executeWhenReady(function(){var e;for(e=0;e<this._inputInterpreters.length;e++)this._inputInterpreters[e].startListening();this._listening=!0})},ControlContext.prototype.stopListening=function(){this.executeWhenReady(function(){var e;for(e=0;e<this._inputInterpreters.length;e++)this._inputInterpreters[e].stopListening();this._listening=!1})},ControlContext.prototype.isListening=function(){return this._listening},ControlContext.prototype.setScreenCenter=function(e,t){this.executeWhenReady(function(){var i;for(i=0;i<this._inputInterpreters.length;i++)this._inputInterpreters[i].setScreenCenter&&this._inputInterpreters[i].setScreenCenter(e,t)})},ControlContext.prototype.executeAction=function(e,t,i){var n;for(n=0;n<this._controllersPriorityQueue.length;n++)this._controllersPriorityQueue[n].executeAction(e,t,i)},o&&document.addEventListener("pointerlockchange",function(){var e=r;r=!!document.pointerLockElement,e&&!r?s&&s(a):a=!1}),{ControlBinding:ControlBinding,InputInterpreter:InputInterpreter,Controller:Controller,ControlContext:ControlContext,getContext:getContext,isPointerLockSupported:isPointerLockSupported,exitPointerLock:exitPointerLock,onPointerLockExit:onPointerLockExit,isPointerLocked:isPointerLocked}}),define("modules/control/keyboard",["utils/utils","modules/application","modules/strings","modules/control/control"],function(e,t,i,n){"use strict";function setModulePrefix(e){o=e}function KeyBinding(e,t){this._key=null,this._keyCode=0,this._shiftState=!1,this._ctrlState=!1,this._altState=!1,n.ControlBinding.call(this,e,t)}function KeyboardInputInterpreter(e){n.InputInterpreter.call(this,KeyBinding,e),this._currentlyPressedKeys=new Array(256)}var s={name:"key"+i.CATEGORY_SEPARATOR},o="";return KeyBinding.prototype=new n.ControlBinding,KeyBinding.prototype.constructor=KeyBinding,KeyBinding.prototype.loadFromJSON=function(e){n.ControlBinding.prototype.loadFromJSON.call(this,e),this.setKey(e.key),this._shiftState=!0===e.shift||16===this._keyCode,this._ctrlState=!0===e.ctrl||17===this._keyCode,this._altState=!0===e.alt||18===this._keyCode},KeyBinding.prototype.saveToLocalStorage=function(){localStorage[o+this._actionName+"_key"]=this._key,localStorage[o+this._actionName+"_shift"]=this._shiftState,localStorage[o+this._actionName+"_ctrl"]=this._ctrlState,localStorage[o+this._actionName+"_alt"]=this._altState},KeyBinding.prototype.loadFromLocalStorage=function(){void 0!==localStorage[o+this._actionName+"_key"]&&(this.setKey(localStorage[o+this._actionName+"_key"]),this._shiftState="true"===localStorage[o+this._actionName+"_shift"],this._ctrlState="true"===localStorage[o+this._actionName+"_ctrl"],this._altState="true"===localStorage[o+this._actionName+"_alt"])},KeyBinding.prototype.removeFromLocalStorage=function(){localStorage.removeItem(o+this._actionName+"_key"),localStorage.removeItem(o+this._actionName+"_shift"),localStorage.removeItem(o+this._actionName+"_ctrl"),localStorage.removeItem(o+this._actionName+"_alt")},KeyBinding.prototype.setKey=function(t){this._key=t,this._keyCode=e.getKeyCodeOf(this._key)},KeyBinding.prototype.getShiftState=function(){return this._shiftState},KeyBinding.prototype.getCtrlState=function(){return this._ctrlState},KeyBinding.prototype.getAltState=function(){return this._altState},KeyBinding.prototype.getControlString=function(){var t,n;return t=i.get(s,this._key,this._key),this._shiftState&&16!==this._keyCode&&(n=e.getKeyOfCode(16),n=i.get(s,n,n),t=n+" + "+t),this._ctrlState&&17!==this._keyCode&&(n=e.getKeyOfCode(17),n=i.get(s,n,n),t=n+" + "+t),this._altState&&18!==this._keyCode&&(n=e.getKeyOfCode(18),n=i.get(s,n,n),t=n+" + "+t),t},KeyBinding.prototype.isTriggered=function(e){return e[this._keyCode]&&(e[16]||!this._shiftState)&&(e[17]||!this._ctrlState)&&(e[18]||!this._altState)},KeyBinding.prototype.bindsTheSameControls=function(e){return this._keyCode===e._keyCode},KeyboardInputInterpreter.prototype=new n.InputInterpreter,KeyboardInputInterpreter.prototype.constructor=KeyboardInputInterpreter,KeyboardInputInterpreter.prototype.getDeviceName=function(){return"keyboard"},KeyboardInputInterpreter.prototype.resetState=function(){var e;for(e=0;e<this._currentlyPressedKeys.length;e++)this._currentlyPressedKeys[e]=!1},KeyboardInputInterpreter.prototype.setEscapeToPressed=function(){this._currentlyPressedKeys[27]=!0},KeyboardInputInterpreter.prototype.defaultActionEnabledForKey=function(t){return["f5","f11","escape"].indexOf(e.getKeyOfCode(t))>=0},KeyboardInputInterpreter.prototype.handleKeyDown=function(e){this._currentlyPressedKeys[e.keyCode]=!0,this.defaultActionEnabledForKey(e.keyCode)||(e.preventDefault(),e.stopPropagation())},KeyboardInputInterpreter.prototype.handleKeyUp=function(e){this._currentlyPressedKeys[e.keyCode]=!1,this.defaultActionEnabledForKey(e.keyCode)||(e.preventDefault(),e.stopPropagation())},KeyboardInputInterpreter.prototype.startListening=function(){n.InputInterpreter.prototype.startListening.call(this),document.onkeydown=function(e){this.handleKeyDown(e)}.bind(this),document.onkeyup=function(e){this.handleKeyUp(e)}.bind(this),document.onkeypress=function(e){this.defaultActionEnabledForKey(e.keyCode)||(e.preventDefault(),e.stopPropagation())}.bind(this),n.onPointerLockExit(function(e){var t,i;if(!e){for(this._currentlyPressedKeys[27]=!0,t=this.getTriggeredActions(),i=0;i<t.length;i++)n.getContext().executeAction(t[i][0].name,void 0,this);this._currentlyPressedKeys[27]=!1}}.bind(this))},KeyboardInputInterpreter.prototype.stopListening=function(){n.InputInterpreter.prototype.stopListening.call(this),document.onkeydown=null,document.onkeyup=null,document.onkeypress=null,n.onPointerLockExit(null)},KeyboardInputInterpreter.prototype.checkAction=function(e){return this._currentProfile[e].isTriggered(this._currentlyPressedKeys)?{name:e,source:this}:null},{setModulePrefix:setModulePrefix,KeyboardInputInterpreter:KeyboardInputInterpreter}}),define("modules/control/mouse",["utils/utils","modules/strings","modules/control/control"],function(e,t,i){"use strict";function setModulePrefix(e){m=e}function MouseBinding(e,t){this._buttonIndex=0,this._moveX=0,this._moveY=0,this._measuredFromCenter=!1,this._scrollX=0,this._scrollY=0,i.ControlBinding.call(this,e,t)}function MouseInputInterpreter(e){this._currentlyPressedButtons=[!1,!1,!1],this._screenCenter=[0,0],this._screenSize=0,this._mousePosition=[-1,-1],this._mousePositionChange=[0,0],this._scrollChange=[0,0],this._moveSensitivity=0,this._displacementAreaRelativeSize=0,this._maxDisplacement=0,this._displacementFactor=1,this._displacementDeadzone=0,this._pointerLock=!1,this.handlePointerLockChange=this.handlePointerLockChange.bind(this),i.InputInterpreter.call(this,MouseBinding,e)}var n={NONE:"none",LEFT:"left",MIDDLE:"middle",RIGHT:"right"},s=[n.NONE,n.LEFT,n.MIDDLE,n.RIGHT],o={name:"mouse"+t.CATEGORY_SEPARATOR+"leftButton",defaultValue:"left click"},r={name:"mouse"+t.CATEGORY_SEPARATOR+"rightButton",defaultValue:"right click"},a={name:"mouse"+t.CATEGORY_SEPARATOR+"middleButton",defaultValue:"middle click"},l={name:"mouse"+t.CATEGORY_SEPARATOR+"fromCenter",defaultValue:"{move} {toDirection} from center"},c={name:"mouse"+t.CATEGORY_SEPARATOR+"notFromCenter",defaultValue:"{move} {toDirection}"},h={name:"mouse"+t.CATEGORY_SEPARATOR+"move",defaultValue:"move"},u={name:"mouse"+t.CATEGORY_SEPARATOR+"leftDirection",defaultValue:"left"},d={name:"mouse"+t.CATEGORY_SEPARATOR+"rightDirection",defaultValue:"right"},p={name:"mouse"+t.CATEGORY_SEPARATOR+"upDirection",defaultValue:"up"},_={name:"mouse"+t.CATEGORY_SEPARATOR+"downDirection",defaultValue:"down"},g={name:"mouse"+t.CATEGORY_SEPARATOR+"scroll",defaultValue:"scroll"},m="";return MouseBinding.prototype=new i.ControlBinding,MouseBinding.prototype.constructor=MouseBinding,MouseBinding.prototype.loadFromJSON=function(e){switch(i.ControlBinding.prototype.loadFromJSON.call(this,e),this._buttonIndex=s.indexOf(e.button),this._moveX=0,this._moveY=0,e.move){case"left":this._moveX=-1;break;case"right":this._moveX=1;break;case"up":this._moveY=-1;break;case"down":this._moveY=1}switch(this._measuredFromCenter=!0===e.fromCenter,this._scrollX=0,this._scrollY=0,e.scroll){case"left":this._scrollX=-1;break;case"right":this._scrollX=1;break;case"up":this._scrollY=-1;break;case"down":this._scrollY=1}},MouseBinding.prototype.saveToLocalStorage=function(){localStorage[m+this._actionName+"_button"]=this._buttonIndex,localStorage[m+this._actionName+"_moveX"]=this._moveX,localStorage[m+this._actionName+"_moveY"]=this._moveY,localStorage[m+this._actionName+"_measuredFromCenter"]=this._measuredFromCenter,localStorage[m+this._actionName+"_scrollX"]=this._scrollX,localStorage[m+this._actionName+"_scrollY"]=this._scrollY},MouseBinding.prototype.loadFromLocalStorage=function(){void 0!==localStorage[m+this._actionName+"_button"]&&(this._buttonIndex=parseInt(localStorage[m+this._actionName+"_button"],10),this._moveX=parseInt(localStorage[m+this._actionName+"_moveX"],10),this._moveY=parseInt(localStorage[m+this._actionName+"_moveY"],10),this._measuredFromCenter="true"===localStorage[m+this._actionName+"_measuredFromCenter"],this._scrollX=parseInt(localStorage[m+this._actionName+"_scrollX"],10),this._scrollY=parseInt(localStorage[m+this._actionName+"_scrollY"],10))},MouseBinding.prototype.removeFromLocalStorage=function(){localStorage.removeItem(m+this._actionName+"_button"),localStorage.removeItem(m+this._actionName+"_moveX"),localStorage.removeItem(m+this._actionName+"_moveY"),localStorage.removeItem(m+this._actionName+"_measuredFromCenter"),localStorage.removeItem(m+this._actionName+"_scrollX"),localStorage.removeItem(m+this._actionName+"_scrollY")},MouseBinding.prototype.getControlString=function(){var i="",m=null;switch(s[this._buttonIndex]){case n.LEFT:return t.get(o);case n.MIDDLE:return t.get(a);case n.RIGHT:return t.get(r)}return i=this._measuredFromCenter?t.get(l):t.get(c),this._moveX<0?m=t.get(u):this._moveX>0?m=t.get(d):this._moveY<0?m=t.get(p):this._moveY>0&&(m=t.get(_)),m?i=e.formatString(i,{move:t.get(h),toDirection:m}):(m=null,i=t.get(c),this._scrollX<0?m=t.get(u):this._scrollX>0?m=t.get(d):this._scrollY<0?m=t.get(p):this._scrollY>0&&(m=t.get(_)),m&&(i=e.formatString(i,{move:t.get(g),toDirection:m})),i)},MouseBinding.prototype.getTriggeredIntensity=function(e,t,i,n,s){var o,r;return this._buttonIndex>0?!0===e[this._buttonIndex]?1:-1:t?(o=this._measuredFromCenter?t[0]>=0?t[0]-n[0]:0:i[0],0!==this._moveX?o*this._moveX:(r=this._measuredFromCenter?t[1]>=0?t[1]-n[1]:0:i[1],0!==this._moveY?r*this._moveY:0!==this._scrollX?s[0]*this._scrollX:0!==this._scrollY?s[1]*this._scrollY:void 0)):0},MouseBinding.prototype.bindsTheSameControls=function(e){return this._buttonIndex===e._buttonIndex&&(0===this._moveX&&0===e._moveX||this._moveX*e._moveX!=0)&&(0===this._moveY&&0===e._moveY||this._moveY*e._moveY!=0)&&(0===this._scrollX&&0===e._scrollX||this._scrollX*e._scrollX!=0)&&(0===this._scrollY&&0===e._scrollY||this._scrollY*e._scrollY!=0)},MouseInputInterpreter.prototype=new i.InputInterpreter,MouseInputInterpreter.prototype.constructor=MouseInputInterpreter,MouseInputInterpreter.prototype._updateDisplacementFactor=function(){this._maxDisplacement=(this._screenSize||1)*this._displacementAreaRelativeSize,this._displacementFactor=1/this._maxDisplacement,this._maxDisplacement+=this._displacementDeadzone},MouseInputInterpreter.prototype.setScreenCenter=function(e,t){this._screenCenter=[e,t],this._screenSize=Math.min(e,t),this._updateDisplacementFactor(),this._mousePosition=[e,t],this._mousePositionChange=[0,0],this._scrollChange=[0,0]},MouseInputInterpreter.prototype.getDeviceName=function(){return"mouse"},MouseInputInterpreter.prototype.resetState=function(){var e;for(e=0;e<this._currentlyPressedButtons.length;e++)this._currentlyPressedButtons[e]=!1;this._mousePosition=[-1,-1],this._mousePositionChange=[0,0],this._scrollChange=[0,0]},MouseInputInterpreter.prototype.setAndStoreMoveSensitivity=function(e){this._moveSensitivity=e,localStorage[m+"mouse_moveSensitivity"]=this._moveSensitivity},MouseInputInterpreter.prototype.getDisplacementAreaRelativeSize=function(){return this._displacementAreaRelativeSize},MouseInputInterpreter.prototype.setAndStoreDisplacementAreaRelativeSize=function(e){this._displacementAreaRelativeSize=e,this._updateDisplacementFactor(),localStorage[m+"mouse_displacementAreaRelativeSize"]=this._displacementAreaRelativeSize},MouseInputInterpreter.prototype.setAndStoreDisplacementDeadzone=function(e){this._displacementDeadzone=e,localStorage[m+"mouse_displacementDeadzone"]=this._displacementDeadzone},MouseInputInterpreter.prototype.loadFromJSON=function(e){i.InputInterpreter.prototype.loadFromJSON.call(this,e),this._moveSensitivity=e.sensitivityProfile.moveSensitivity,this._displacementAreaRelativeSize=e.sensitivityProfile.displacementAreaRelativeSize,this._updateDisplacementFactor(),this._displacementDeadzone=e.sensitivityProfile.displacementDeadzone},MouseInputInterpreter.prototype.loadFromLocalStorage=function(){i.InputInterpreter.prototype.loadFromLocalStorage.call(this),void 0!==localStorage[m+"mouse_moveSensitivity"]&&(this._moveSensitivity=parseFloat(localStorage[m+"mouse_moveSensitivity"])),void 0!==localStorage[m+"mouse_displacementAreaRelativeSize"]&&(this._displacementAreaRelativeSize=parseFloat(localStorage[m+"mouse_displacementAreaRelativeSize"]),this._updateDisplacementFactor()),void 0!==localStorage[m+"mouse_displacementDeadzone"]&&(this._displacementDeadzone=parseInt(localStorage[m+"mouse_displacementDeadzone"],10))},MouseInputInterpreter.prototype.removeFromLocalStorage=function(){i.InputInterpreter.prototype.removeFromLocalStorage.call(this),localStorage.removeItem(m+"mouse_moveSensitivity"),localStorage.removeItem(m+"mouse_displacementAreaRelativeSize"),localStorage.removeItem(m+"mouse_displacementDeadzone")},MouseInputInterpreter.prototype.handleMouseDown=function(e){return this._currentlyPressedButtons[e.which]=!0,e.preventDefault(),!1},MouseInputInterpreter.prototype.handleMouseUp=function(e){return this._currentlyPressedButtons[e.which]=!1,e.preventDefault(),!1},MouseInputInterpreter.prototype.handleMouseMove=function(e){this._mousePosition[0]>=0&&(this._pointerLock?(this._mousePositionChange[0]+=e.movementX,this._mousePositionChange[1]+=e.movementY):(this._mousePositionChange[0]+=e.clientX-this._mousePosition[0],this._mousePositionChange[1]+=e.clientY-this._mousePosition[1])),this._pointerLock?(this._mousePosition[0]=Math.min(Math.max(this._screenCenter[0]-this._maxDisplacement,this._mousePosition[0]+e.movementX),this._screenCenter[0]+this._maxDisplacement),this._mousePosition[1]=Math.min(Math.max(this._screenCenter[1]-this._maxDisplacement,this._mousePosition[1]+e.movementY),this._screenCenter[1]+this._maxDisplacement)):this._mousePosition=[e.clientX,e.clientY]},MouseInputInterpreter.prototype.handleWheel=function(e){this._scrollChange[0]+=e.deltaX,this._scrollChange[1]+=e.deltaY},MouseInputInterpreter.prototype.handlePointerLockChange=function(){this._pointerLock=!!document.pointerLockElement,this._pointerLock&&this._mousePosition[0]<0&&(this._mousePosition[0]=this._screenCenter[0],this._mousePosition[1]=this._screenCenter[1])},MouseInputInterpreter.prototype.startListening=function(){i.InputInterpreter.prototype.startListening.call(this),document.onmousedown=function(e){this.handleMouseDown(e)}.bind(this),document.onmouseup=function(e){this.handleMouseUp(e)}.bind(this),document.onmousemove=function(e){this.handleMouseMove(e)}.bind(this),document.onwheel=function(e){this.handleWheel(e)}.bind(this),document.onclick=function(e){return e.preventDefault(),!1},document.oncontextmenu=function(e){return e.preventDefault(),!1},i.isPointerLockSupported()&&(this.handlePointerLockChange(),document.addEventListener("pointerlockchange",this.handlePointerLockChange))},MouseInputInterpreter.prototype.stopListening=function(){i.InputInterpreter.prototype.stopListening.call(this),document.onmousedown=null,document.onmouseup=null,document.onmousemove=null,document.onwheel=null,document.onclick=null,document.oncontextmenu=null,i.isPointerLockSupported()&&document.removeEventListener("pointerlockchange",this.handlePointerLockChange)},MouseInputInterpreter.prototype.checkAction=function(e){var t=this._currentProfile[e].getTriggeredIntensity(this._currentlyPressedButtons,this._mousePosition,this._mousePositionChange,this._screenCenter,this._scrollChange);return t>=0?{name:e,intensity:!0===this._currentProfile[e]._measuredFromCenter?Math.min(1,Math.max(0,t-this._displacementDeadzone)*this._displacementFactor):t*this._moveSensitivity,source:this}:null},MouseInputInterpreter.prototype.getTriggeredActions=function(e){var t=i.InputInterpreter.prototype.getTriggeredActions.call(this,e);return this._mousePositionChange=[0,0],this._scrollChange=[0,0],t},MouseInputInterpreter.prototype.isMouseDisplaced=function(){return Math.abs(this._mousePosition[0]-this._screenCenter[0])>this._displacementDeadzone||Math.abs(this._mousePosition[1]-this._screenCenter[1])>this._displacementDeadzone},{setModulePrefix:setModulePrefix,MouseInputInterpreter:MouseInputInterpreter}}),define("modules/control/gamepad",["utils/utils","modules/application","modules/strings","modules/control/control"],function(e,t,i,n){"use strict";function setModulePrefix(e){p=e}function GamepadBinding(e,t){this._button=this.BUTTON_NONE,this._axisIndex=this.AXIS_NONE,this._axisPositive=!1,n.ControlBinding.call(this,e,t)}function GamepadSensitivityActionGroup(e){this._sensitivityFactor=e.sensitivityFactor||0,this._staticSensitivity=!0===e.staticSensitivity,this._quadraticIntensity=!0===e.quadraticSensitivity,this._actionNames=e.actionNames,this._sensitivityFactor&&this._staticSensitivity&&t.showError("Sensitivity action group defined with both factored and static sensitivity!",t.ErrorSeverity.MINOR)}function GamepadInputInterpreter(e){this._gamepad=null,this._gamepadSetIndex=localStorage[p+s]===o?l:a,this._detectingPreference=!!localStorage[p+s],this._preferredGamepadId=localStorage[p+s],this._vibrationEnabled=!1,this._vibrationEffects=null,this._sensitivityActionGroups=null,n.InputInterpreter.call(this,GamepadBinding,e)}var s="preferredGamepad",o="null",r=[],a=-2,l=-1,c={name:"joystick"+i.CATEGORY_SEPARATOR+"button",defaultValue:"button {index}"},h={name:"joystick"+i.CATEGORY_SEPARATOR+"axis",defaultValue:"axis {index} {direction}"},u={name:"joystick"+i.CATEGORY_SEPARATOR+"positiveDirection",defaultValue:"positive"},d={name:"joystick"+i.CATEGORY_SEPARATOR+"negativeDirection",defaultValue:"negative"},p="",_=!!navigator.getGamepads,g=_?function(){return navigator.getGamepads()}:function(){return r};return GamepadBinding.prototype=new n.ControlBinding,GamepadBinding.prototype.constructor=GamepadBinding,GamepadBinding.prototype.BUTTON_NONE=-1,GamepadBinding.prototype.AXIS_NONE=-1,GamepadBinding.prototype.loadFromJSON=function(e){n.ControlBinding.prototype.loadFromJSON.call(this,e),"number"==typeof e.button&&(this._button=e.button),"string"==typeof e.axis&&(this._axisIndex=Math.abs(parseInt(e.axis,10)),this._axisPositive="-"!==e.axis[0])},GamepadBinding.prototype._getLocalStoragePrefix=function(){return p+this._profileName+"_"+this._actionName},GamepadBinding.prototype.saveToLocalStorage=function(){var e=this._getLocalStoragePrefix();localStorage[e+"_gamepad_button"]=this._button,localStorage[e+"_gamepad_axisIndex"]=this._axisIndex,localStorage[e+"_gamepad_axisPositive"]=this._axisPositive},GamepadBinding.prototype.loadFromLocalStorage=function(){var e=this._getLocalStoragePrefix();void 0!==localStorage[e+"_gamepad_button"]&&(this._button=parseInt(localStorage[e+"_gamepad_button"],10),this._axisIndex=parseInt(localStorage[e+"_gamepad_button"],10),this._axisPositive="true"===localStorage[e+"_gamepad_axisPositive"])},GamepadBinding.prototype.removeFromLocalStorage=function(){var e=this._getLocalStoragePrefix();localStorage.removeItem(e+"_gamepad_button"),localStorage.removeItem(e+"_gamepad_axisIndex"),localStorage.removeItem(e+"_gamepad_axisPositive")},GamepadBinding.prototype.getTriggeredIntensity=function(e){return e?this._button!==this.BUTTON_NONE?e.buttons[this._button]?e.buttons[this._button].value:0:this._axisIndex!==this.AXIS_NONE&&e.axes.length>this._axisIndex?Math.max(e.axes[this._axisIndex]*(this._axisPositive?1:-1),0):0:0},GamepadBinding.prototype.getControlString=function(){return this._button!==this.BUTTON_NONE?e.formatString(i.get(c),{index:this._button+1}):this._axisIndex!==this.AXIS_NONE?e.formatString(i.get(h),{index:this._axisIndex+1,direction:this._axisPositive?i.get(u):i.get(d)}):""},GamepadBinding.prototype.bindsTheSameControls=function(e){return this._button===e._button&&this._axisIndex===e._axisIndex},GamepadSensitivityActionGroup.prototype.getIntensityForAction=function(e,t){return this._actionNames.indexOf(t)>=0?this._staticSensitivity?void 0:e*(this._quadraticIntensity?e:1)*this._sensitivityFactor:-1},GamepadInputInterpreter.prototype=new n.InputInterpreter,GamepadInputInterpreter.prototype.constructor=GamepadInputInterpreter,GamepadInputInterpreter.prototype.getDeviceName=function(){return"joystick"},GamepadInputInterpreter.prototype.resetState=function(){this._gamepad=null},GamepadInputInterpreter.prototype.loadFromJSON=function(e){var t;if(n.InputInterpreter.prototype.loadFromJSON.call(this,e),this._sensitivityActionGroups=[],e.sensitivityProfile&&e.sensitivityProfile.actionGroups)for(t=0;t<e.sensitivityProfile.actionGroups.length;t++)this._sensitivityActionGroups.push(new GamepadSensitivityActionGroup(e.sensitivityProfile.actionGroups[t]));this._vibrationEnabled=!!e.vibrationEnabled||!1,this._vibrationEffects=e.vibrationEffects||{}},GamepadInputInterpreter.prototype.loadFromLocalStorage=function(){n.InputInterpreter.prototype.loadFromLocalStorage.call(this),void 0!==localStorage[p+"vibrationEnabled"]&&(this._vibrationEnabled=localStorage[p+"vibrationEnabled"]===(!0).toString())},GamepadInputInterpreter.prototype.handleGamepadConnected=function(e){this._gamepad||this._gamepadSetIndex!==a||(this._gamepad=e.gamepad,this.setProfile(this._getProfile(e.gamepad),!1))},GamepadInputInterpreter.prototype.startListening=function(){n.InputInterpreter.prototype.startListening.call(this),window.addEventListener("gamepadconnected",function(e){this.handleGamepadConnected(e)}.bind(this))},GamepadInputInterpreter.prototype.stopListening=function(){n.InputInterpreter.prototype.stopListening.call(this),window.ongamepadconnected=null},GamepadInputInterpreter.prototype.checkAction=function(e){var t,i,n;if((t=this._currentProfile[e].getTriggeredIntensity(this._gamepad))>0){for(i=0;i<this._sensitivityActionGroups.length;i++)if(void 0===(n=this._sensitivityActionGroups[i].getIntensityForAction(t,e))||n>0)return{name:e,intensity:n,source:this};return{name:e,intensity:t,source:this}}return null},GamepadInputInterpreter.prototype.updateGamepad=function(){var e,t,i;if(e=g(),this._gamepadSetIndex>=0&&(e[this._gamepadSetIndex]?this._gamepad=e[this._gamepadSetIndex]:this._gamepadSetIndex=a),this._gamepadSetIndex===a)if(i=null!==this._gamepad?this._gamepad.index:-1,this._gamepad=null,this._detectingPreference){for(t=0;t<e.length;t++)if(e[t]){if(this._detectingPreference=!1,e[t].id===this._preferredGamepadId){this._setGamepad(e[t]);break}null===this._gamepad&&(this._gamepad=e[t],this.setProfile(this._getProfile(e[t]),!1))}}else for(t=0;t<e.length;t++)if(e[t]){this._gamepad=e[t],e[t].index!==i&&this.setProfile(this._getProfile(e[t]),!1);break}return this._gamepad},GamepadInputInterpreter.prototype.getTriggeredActions=function(e){return this.isListening()&&this._gamepadSetIndex!==l?(this.updateGamepad(),null!==this._gamepad?n.InputInterpreter.prototype.getTriggeredActions.call(this,e):r):r},GamepadInputInterpreter.prototype._getProfile=function(e){var t,i,n,s,o,r;if(t=this._getProfilePreferences(),t[e.id])return t[e.id];for(o=Object.keys(this._profileKeywords),r=e.id.toLowerCase(),i=0;i<o.length;i++)if(s=this._profileKeywords[o[i]])for(n=0;n<s.length;n++)if(r.indexOf(s[n])>=0)return o[i];return this._defaultProfileName},GamepadInputInterpreter.prototype._setGamepad=function(e){this._gamepad=e,this._gamepadSetIndex=e.index,this._preferredGamepadId=e.id,localStorage[p+s]=e.id,this.setProfile(this._getProfile(e),!1)},GamepadInputInterpreter.prototype.setGamepad=function(e){var t,i=g();if(!e)return this._gamepad=null,this._gamepadSetIndex=l,this._preferredGamepadId=o,localStorage[p+s]=o,!0;for(t=0;t<i.length;t++)if(i[t]===e)return this._setGamepad(e),!0;return!1},GamepadInputInterpreter.prototype.removeFromLocalStorage=function(){n.InputInterpreter.prototype.removeFromLocalStorage.call(this),localStorage.removeItem(p+s),localStorage.removeItem(p+"preferredProfiles"),localStorage.removeItem(p+"vibrationEnabled"),this._gamepadSetIndex=a,this._preferredGamepadId=""},GamepadInputInterpreter.prototype._getProfilePreferences=function(){var e,t=localStorage[p+"preferredProfiles"];if(!t)return{};try{e=JSON.parse(t)}catch(e){return{}}return e&&"object"==typeof e?e:{}},GamepadInputInterpreter.prototype.setProfile=function(e,t){var i;n.InputInterpreter.prototype.setProfile.call(this,e),null!==this._gamepad&&!1!==t&&(i=this._getProfilePreferences(),i[this._gamepad.id]=this._currentProfileName,localStorage[p+"preferredProfiles"]=JSON.stringify(i))},GamepadInputInterpreter.prototype.isVibrationSupported=function(){return null!==this._gamepad&&this._gamepad.vibrationActuator&&"dual-rumble"===this._gamepad.vibrationActuator.type&&"function"==typeof this._gamepad.vibrationActuator.playEffect},GamepadInputInterpreter.prototype.setVibrationEnabled=function(e,t){void 0===t&&(t=!0),this._vibrationEnabled=e,t&&(localStorage[p+"vibrationEnabled"]=e.toString())},GamepadInputInterpreter.prototype.vibrate=function(e){this._vibrationEnabled&&this._gamepad&&this._gamepad.vibrationActuator&&this._vibrationEffects.hasOwnProperty(e)&&this._gamepad.vibrationActuator.playEffect("dual-rumble",this._vibrationEffects[e])},{setModulePrefix:setModulePrefix,getDevices:g,GamepadInputInterpreter:GamepadInputInterpreter}}),define("modules/control/touch",["utils/utils","modules/strings","modules/control/control"],function(e,t,i){"use strict";function setModulePrefix(e){f=e}function TouchBinding(e,t){this._area=s.NONE,this._type=null,this._timeout=0,this._count=1,this._range=0,this._moveX=0,this._moveY=0,this._currentX=0,this._currentY=0,this._touches=[],this._areaPx=null,this._rangePx=0,this._rangeFactor=0,i.ControlBinding.call(this,e,t)}function TouchInputInterpreter(e){this._touches=[],this._handleTouchStart=this._handleTouchStart.bind(this),this._handleTouchMove=this._handleTouchMove.bind(this),this._handleTouchEnd=this._handleTouchEnd.bind(this),i.InputInterpreter.call(this,TouchBinding,e)}var n={TAP:0,LONG_TAP:1,TWO_POINT_TAP:2,THREE_POINT_TAP:3,HOLD:4,SLIDE:5,SWIPE:6},s={NONE:{x:[0,0],y:[0,0]},FULL:{x:[0,1],y:[0,1]},"top-left":{x:[0,.5],y:[0,.5]},"top-right":{x:[.5,1],y:[0,.5]},"bottom-left":{x:[0,.5],y:[.5,1]},"bottom-right":{x:[.5,1],y:[.5,1]},left:{x:[0,.5],y:[0,1]},right:{x:[.5,1],y:[0,1]}},o={name:"touch"+t.CATEGORY_SEPARATOR+"tap",defaultValue:"tap {area} of the screen"},r={name:"touch"+t.CATEGORY_SEPARATOR+"longTap",defaultValue:"long tap {area} of the screen"},a={name:"touch"+t.CATEGORY_SEPARATOR+"twoPointTap",defaultValue:"tap {area} of the screen with two fingers"},l={name:"touch"+t.CATEGORY_SEPARATOR+"threePointTap",defaultValue:"tap {area} of the screen with three fingers"},c={name:"touch"+t.CATEGORY_SEPARATOR+"swipe",defaultValue:"swipe {direction} on {area} of the screen"},h={name:"touch"+t.CATEGORY_SEPARATOR+"hold",defaultValue:"tap and hold on {area} of the screen"},u={name:"touch"+t.CATEGORY_SEPARATOR+"holdDirection",defaultValue:"swipe {direction} and hold on {area} of the screen"},d={name:"touch"+t.CATEGORY_SEPARATOR+"slide",defaultValue:"slide {direction} on {area} of the screen"},p={name:"touch"+t.CATEGORY_SEPARATOR+"leftDirection",defaultValue:"left"},_={name:"touch"+t.CATEGORY_SEPARATOR+"rightDirection",defaultValue:"right"},g={name:"touch"+t.CATEGORY_SEPARATOR+"upDirection",defaultValue:"up"},m={name:"touch"+t.CATEGORY_SEPARATOR+"downDirection",defaultValue:"down"},f="";return TouchBinding.prototype=new i.ControlBinding,TouchBinding.prototype.constructor=TouchBinding,TouchBinding.prototype._initDerivedProperties=function(){switch(this._areaPx=e.deepCopy(this._area),this._type){case n.TWO_POINT_TAP:this._count=2;break;case n.THREE_POINT_TAP:this._count=3;break;default:this._count=1}this._timeout=this._type===n.LONG_TAP?2e3:300,this._rangePx=0,this._rangeFactor=0,this._currentX=0,this._currentY=0},TouchBinding.prototype.loadFromJSON=function(t){if(i.ControlBinding.prototype.loadFromJSON.call(this,t),"string"==typeof t.area?this._area=s[t.area]:this._area=s.FULL,"string"==typeof t.type&&(this._type=e.getSafeEnumValueForKey(n,t.type)),this._range=t.range||.5,this._moveX=0,this._moveY=0,"string"==typeof t.direction)switch(t.direction){case"left":this._moveX=-1;break;case"right":this._moveX=1;break;case"up":this._moveY=-1;break;case"down":this._moveY=1}this._initDerivedProperties()},TouchBinding.prototype.saveToLocalStorage=function(){localStorage[f+this._actionName+"_touch_area"]=JSON.stringify(this._area),localStorage[f+this._actionName+"_touch_type"]=this._type,localStorage[f+this._actionName+"_touch_moveX"]=this._moveX,localStorage[f+this._actionName+"_touch_moveY"]=this._moveY,localStorage[f+this._actionName+"_touch_range"]=this._range},TouchBinding.prototype.loadFromLocalStorage=function(){void 0!==localStorage[f+this._actionName+"_touch_type"]&&(this._area=JSON.parse(localStorage[f+this._actionName+"_touch_area"]),this._type=localStorage[f+this._actionName+"_touch_type"],this._moveX=parseInt(localStorage[f+this._actionName+"_touch_moveX"],10),this._moveY=parseInt(localStorage[f+this._actionName+"_touch_moveY"],10),this._range=parseInt(localStorage[f+this._actionName+"_touch_range"],10),this._initDerivedProperties())},TouchBinding.prototype.removeFromLocalStorage=function(){localStorage.removeItem(f+this._actionName+"_touch_area"),localStorage.removeItem(f+this._actionName+"_touch_type"),
localStorage.removeItem(f+this._actionName+"_touch_moveX"),localStorage.removeItem(f+this._actionName+"_touch_moveY"),localStorage.removeItem(f+this._actionName+"_touch_range")},TouchBinding.prototype.setScreenSize=function(e,t){this._areaPx.x[0]=this._area.x[0]*e,this._areaPx.x[1]=this._area.x[1]*e,this._areaPx.y[0]=this._area.y[0]*t,this._areaPx.y[1]=this._area.y[1]*t,this._rangePx=this._range*Math.min(e,t),this._rangeFactor=1/(this._rangePx||1)},TouchBinding.prototype._touchStartedInArea=function(e){return e.startX>=this._areaPx.x[0]&&e.startX<=this._areaPx.x[1]&&e.startY>=this._areaPx.y[0]&&e.startY<=this._areaPx.y[1]},TouchBinding.prototype.getTriggeredIntensity=function(e){var t,i,s;switch(this._type){case n.TAP:case n.LONG_TAP:for(t=e.length-1;t>=0;t--){if(i=e[t],i.age>this._timeout)return 0;if(null===i.capturedBy&&this._touchStartedInArea(i)&&Math.abs(i.currentX-i.startX)<=20&&Math.abs(i.currentY-i.startY)<=20&&!0===i.finished)return i.capturedBy=this,1}return 0;case n.TWO_POINT_TAP:case n.THREE_POINT_TAP:if(this._touches.length>0){for(s=0,t=0;t<this._count;t++){if(i=this._touches[t],i.age>this._timeout||null!==i.capturedBy&&i.capturedBy!==this)return this._touches.length=0,0;!0===i.finished&&s++}for(t=0;t<this._count;t++)this._touches[t].capturedBy=this;if(s===this._count)return this._touches.length=0,1}else{for(t=e.length-1;t>=0&&(i=e[t],!(i.age>this._timeout));t--)if(null===i.capturedBy&&this._touchStartedInArea(i)&&Math.abs(i.currentX-i.startX)<=20&&Math.abs(i.currentY-i.startY)<=20){if(!(this._touches.length<this._count))return this._touches.length=0,0;this._touches.push(i)}if(this._touches.length!==this._count)return this._touches.length=0,0;for(t=0;t<this._count;t++)this._touches[t].capturedBy=this}return 0;case n.SWIPE:for(t=0;t<e.length;t++)if(i=e[t],!0===i.finished&&!(i.age>=1e3)&&this._touchStartedInArea(i)&&(i.currentX-i.startX>20&&this._moveX>0||i.currentX-i.startX<-20&&this._moveX<0||i.currentY-i.startY>20&&this._moveY>0||i.currentY-i.startY<-20&&this._moveY<0))return 1;return 0;case n.HOLD:for(t=0;t<e.length;t++)if(i=e[t],!1===i.finished&&this._touchStartedInArea(i))return this._moveX>0?Math.min(Math.max(0,(i.currentX-i.startX-5)*this._rangeFactor),1):this._moveX<0?Math.min(Math.max(0,(i.startX-i.currentX-5)*this._rangeFactor),1):this._moveY>0?Math.min(Math.max(0,(i.currentY-i.startY-5)*this._rangeFactor),1):this._moveY<0?Math.min(Math.max(0,(i.startY-i.currentY-5)*this._rangeFactor),1):1;break;case n.SLIDE:for(t=0;t<e.length;t++)if(i=e[t],!0===i.finished&&!(i.age>=300)&&this._touchStartedInArea(i)&&Math.abs(i.currentX-i.startX)<=5&&Math.abs(i.currentY-i.startY)<=5)return this._currentX=0,this._currentY=0,0;for(t=0;t<e.length;t++)i=e[t],!1===i.finished&&this._touchStartedInArea(i)&&(this._currentX+=i.currentX-i.previousX,this._currentY+=i.currentY-i.previousY,this._currentX>this._rangePx+5?this._currentX=this._rangePx+5:this._currentX<-this._rangePx-5&&(this._currentX=-this._rangePx-5),this._currentY>this._rangePx+5?this._currentY=this._rangePx+5:this._currentY<-this._rangePx-5&&(this._currentY=-this._rangePx-5));return this._moveX>0?Math.min(Math.max(0,(this._currentX-5)*this._rangeFactor),1):this._moveX<0?Math.min(Math.max(0,(-this._currentX-5)*this._rangeFactor),1):this._moveY>0?Math.min(Math.max(0,(this._currentY-5)*this._rangeFactor),1):this._moveY<0?Math.min(Math.max(0,(-this._currentY-5)*this._rangeFactor),1):0}return 0},TouchBinding.prototype.getControlString=function(){var i="",f="";switch(this._moveX<0?i=t.get(p):this._moveX>0?i=t.get(_):this._moveY<0?i=t.get(g):this._moveY>0&&(i=t.get(m)),f=t.get(t.TOUCH_AREA.PREFIX,e.getKeyOfValue(s,this._area)),this._type){case n.TAP:return e.formatString(t.get(o),{area:f});case n.LONG_TAP:return e.formatString(t.get(r),{area:f});case n.TWO_POINT_TAP:return e.formatString(t.get(a),{area:f});case n.THREE_POINT_TAP:return e.formatString(t.get(l),{area:f});case n.SWIPE:return e.formatString(t.get(c),{area:f,direction:i});case n.HOLD:return 0!==this._moveX||0!==this._moveY?e.formatString(t.get(u),{area:f,direction:i}):e.formatString(t.get(h),{area:f});case n.SLIDE:return e.formatString(t.get(d),{area:f,direction:i})}return""},TouchBinding.prototype.bindsTheSameControls=function(t){return this._type===t._type&&this._moveX===t._moveX&&this._moveY===t._moveY&&e.objectsEqual(this._area,t._area)},TouchInputInterpreter.prototype=new i.InputInterpreter,TouchInputInterpreter.prototype.constructor=TouchInputInterpreter,TouchInputInterpreter.prototype.getDeviceName=function(){return"touch"},TouchInputInterpreter.prototype.resetState=function(){this._touches=[]},TouchInputInterpreter.prototype.setScreenCenter=function(e,t){var i,n;for(n=Object.keys(this._currentProfile),i=0;i<n.length;i++)this._currentProfile[n[i]].setScreenSize(2*e,2*t)},TouchInputInterpreter.prototype._addTouch=function(e,t){this._touches.push({identifier:e.identifier,startTime:t,startX:e.clientX,startY:e.clientY,previousX:e.clientX,previousY:e.clientY,currentX:e.clientX,currentY:e.clientY,finished:!1,capturedBy:null,age:0})},TouchInputInterpreter.prototype._updateTouch=function(e){var t;for(t=0;t<this._touches.length;t++)if(this._touches[t].identifier===e.identifier&&!1===this._touches[t].finished)return this._touches[t].currentX=e.clientX,void(this._touches[t].currentY=e.clientY)},TouchInputInterpreter.prototype._removeTouch=function(e){var t;for(t=0;t<this._touches.length;t++)if(this._touches[t].identifier===e.identifier)return void(this._touches[t].finished=!0)},TouchInputInterpreter.prototype._handleTouchStart=function(e){var t,i=performance.now();for(e.preventDefault(),t=0;t<e.changedTouches.length;t++)this._addTouch(e.changedTouches[t],i);return!1},TouchInputInterpreter.prototype._handleTouchMove=function(e){var t;for(e.preventDefault(),t=0;t<e.changedTouches.length;t++)this._updateTouch(e.changedTouches[t]);return!1},TouchInputInterpreter.prototype._handleTouchEnd=function(e){var t;for(e.preventDefault(),t=0;t<e.changedTouches.length;t++)this._removeTouch(e.changedTouches[t]);return!1},TouchInputInterpreter.prototype.startListening=function(){var e={passive:!1};i.InputInterpreter.prototype.startListening.call(this),document.addEventListener("touchstart",this._handleTouchStart,e),document.addEventListener("touchmove",this._handleTouchMove,e),document.addEventListener("touchend",this._handleTouchEnd,e),document.addEventListener("touchcancel",this._handleTouchEnd,e)},TouchInputInterpreter.prototype.stopListening=function(){i.InputInterpreter.prototype.stopListening.call(this),document.removeEventListener("touchstart",this._handleTouchStart),document.removeEventListener("touchmove",this._handleTouchMove),document.removeEventListener("touchend",this._handleTouchEnd),document.removeEventListener("touchcancel",this._handleTouchEnd)},TouchInputInterpreter.prototype.checkAction=function(e){var t=this._currentProfile[e].getTriggeredIntensity(this._touches);return t>0?{name:e,intensity:t,source:this}:null},TouchInputInterpreter.prototype.getTriggeredActions=function(e){var t,n,s,o=performance.now();for(n=i.InputInterpreter.prototype.getTriggeredActions.call(this,e),t=0;t<this._touches.length;t++)s=this._touches[t],s.finished?(this._touches.splice(t,1),t--):(s.previousX=s.currentX,s.previousY=s.currentY,s.age=o-s.startTime,s.capturedBy=null);return n},{setModulePrefix:setModulePrefix,TouchInputInterpreter:TouchInputInterpreter}}),define("modules/camera-controller",["utils/types","modules/application","modules/control/control","modules/scene/camera"],function(e,t,i,n){"use strict";function CameraController(s){i.Controller.call(this,s),this._controlledCamera=null,this._controlledVelocityVector=[0,0,0],this._velocityTargetVector=[0,0,0],this._maxSpeed=s.maxSpeed||0,this._acceleration=s.acceleration||0,this._deceleration=s.deceleration||0,this._angularVelocityVector=[0,0,0],this._maxAngularVelocity=s.maxSpin||0,this._angularAcceleration=s.angularAcceleration||0,this._angularDeceleration=s.angularDeceleration||0,this._angularVelocityTargetVector=[0,0,0],this._objectChangeTransitionDuration=s.objectChangeTransitionDuration,this._viewChangeTransitionDuration=s.viewChangeTransitionDuration,this._viewResetTransitionDuration=s.viewResetTransitionDuration,this._transitionStyle=e.getEnumValue(n.Camera.TransitionStyle,s.transitionStyle,{name:"cameraController.transitionStyle"}),this.setActionFunctions("controlCamera",function(){this._context?this._context.makeControllerPriority(this):t.showError("Cannot make camera controller the priority controller because it is not added to any control context!")}.bind(this),function(){this._controlledCamera.getConfiguration().resetsOnFocusChange()&&this._controlledCamera.transitionToConfigurationDefaults(this._viewResetTransitionDuration,this._transitionStyle),this._context?this._context.restoreDefaultControllerPriorityOrder():t.showError("Cannot restore original priority order of the camera controller's context because it is not added to any!")}.bind(this)),this.setActionFunctions("cameraTurnLeft",function(e){void 0===e?this._angularVelocityTargetVector[1]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[1]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[1]=-e,this._angularVelocityVector[1]=-e)}.bind(this),function(){this._angularVelocityTargetVector[1]<0&&(this._angularVelocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraTurnRight",function(e){void 0===e?this._angularVelocityTargetVector[1]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[1]=this._maxAngularVelocity):(this._angularVelocityTargetVector[1]=e,this._angularVelocityVector[1]=e)}.bind(this),function(){this._angularVelocityTargetVector[1]>0&&(this._angularVelocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraTurnUp",function(e){void 0===e?this._angularVelocityTargetVector[0]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[0]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[0]=-e,this._angularVelocityVector[0]=-e)}.bind(this),function(){this._angularVelocityTargetVector[0]<0&&(this._angularVelocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraTurnDown",function(e){void 0===e?this._angularVelocityTargetVector[0]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[0]=this._maxAngularVelocity):(this._angularVelocityTargetVector[0]=e,this._angularVelocityVector[0]=e)}.bind(this),function(){this._angularVelocityTargetVector[0]>0&&(this._angularVelocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraRollLeft",function(e){void 0===e?this._angularVelocityTargetVector[2]>-this._maxAngularVelocity&&(this._angularVelocityTargetVector[2]=-this._maxAngularVelocity):(this._angularVelocityTargetVector[2]=-e,this._angularVelocityVector[2]=-e)}.bind(this),function(){this._angularVelocityTargetVector[2]<0&&(this._angularVelocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraRollRight",function(e){void 0===e?this._angularVelocityTargetVector[2]<this._maxAngularVelocity&&(this._angularVelocityTargetVector[2]=this._maxAngularVelocity):(this._angularVelocityTargetVector[2]=e,this._angularVelocityVector[2]=e)}.bind(this),function(){this._angularVelocityTargetVector[2]>0&&(this._angularVelocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraMoveLeft",function(e){this._velocityTargetVector[0]=-(void 0!==e?e:1)*this._maxSpeed}.bind(this),function(){this._velocityTargetVector[0]<0&&(this._velocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraMoveRight",function(e){this._velocityTargetVector[0]=(void 0!==e?e:1)*this._maxSpeed}.bind(this),function(){this._velocityTargetVector[0]>0&&(this._velocityTargetVector[0]=0)}.bind(this)),this.setActionFunctions("cameraMoveUp",function(e){this._velocityTargetVector[1]=(void 0!==e?e:1)*this._maxSpeed}.bind(this),function(){this._velocityTargetVector[1]>0&&(this._velocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraMoveDown",function(e){this._velocityTargetVector[1]=-(void 0!==e?e:1)*this._maxSpeed}.bind(this),function(){this._velocityTargetVector[1]<0&&(this._velocityTargetVector[1]=0)}.bind(this)),this.setActionFunctions("cameraMoveForward",function(e){this._velocityTargetVector[2]=-(void 0!==e?e:1)*this._maxSpeed}.bind(this),function(){this._velocityTargetVector[2]<0&&(this._velocityTargetVector[2]=0)}.bind(this)),this.setActionFunctions("cameraMoveBackward",function(e){this._velocityTargetVector[2]=(void 0!==e?e:1)*this._maxSpeed}.bind(this),function(){this._velocityTargetVector[2]>0&&(this._velocityTargetVector[2]=0)}.bind(this)),this.setActionFunction("cameraDecreaseFOV",!0,function(){this._controlledCamera.decreaseFOV()}.bind(this)),this.setActionFunction("cameraIncreaseFOV",!0,function(){this._controlledCamera.increaseFOV()}.bind(this)),this.setActionFunction("nextView",!0,function(){this._controlledCamera.changeToNextView(this._viewChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("previousView",!0,function(){this._controlledCamera.changeToPreviousView(this._viewChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("followNext",!0,function(){this._controlledCamera.followNextNode(!0,this._objectChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("followPrevious",!0,function(){this._controlledCamera.followPreviousNode(!0,this._objectChangeTransitionDuration,this._transitionStyle)}.bind(this)),this.setActionFunction("resetView",!0,function(){this._controlledCamera.transitionToConfigurationDefaults(this._viewResetTransitionDuration,this._transitionStyle)}.bind(this))}return CameraController.prototype=new i.Controller,CameraController.prototype.constructor=CameraController,CameraController.prototype.getType=function(){return"camera"},CameraController.prototype.getMaxSpeed=function(){return this._maxSpeed},CameraController.prototype.setCameraToFollowObject=function(e,t,i,n){this._controlledCamera.followObject(e,!1,t,i,n)},CameraController.prototype.setToFreeCamera=function(){this._controlledCamera.setToFreeCamera(!1)},CameraController.prototype.stop=function(){this._controlledVelocityVector[0]=0,this._controlledVelocityVector[1]=0,this._controlledVelocityVector[2]=0,this._velocityTargetVector[0]=0,this._velocityTargetVector[1]=0,this._velocityTargetVector[2]=0,this._angularVelocityVector[0]=0,this._angularVelocityVector[1]=0,this._angularVelocityVector[2]=0,this._angularVelocityTargetVector[0]=0,this._angularVelocityTargetVector[1]=0,this._angularVelocityTargetVector[2]=0},CameraController.prototype._updateAngularVelocity=function(e){var t;for(t=0;t<this._angularVelocityVector.length;t++)this._angularVelocityVector[t]>=0?this._angularVelocityVector[t]<this._angularVelocityTargetVector[t]?(this._angularVelocityVector[t]+=this._angularAcceleration*e/1e3,this._angularVelocityVector[t]>this._angularVelocityTargetVector[t]&&(this._angularVelocityVector[t]=this._angularVelocityTargetVector[t])):this._angularVelocityVector[t]>this._angularVelocityTargetVector[t]&&(this._angularVelocityVector[t]-=this._angularDeceleration*e/1e3,this._angularVelocityVector[t]<this._angularVelocityTargetVector[t]&&(this._angularVelocityVector[t]=this._angularVelocityTargetVector[t])):this._angularVelocityVector[t]<0&&(this._angularVelocityVector[t]>this._angularVelocityTargetVector[t]?(this._angularVelocityVector[t]-=this._angularAcceleration*e/1e3,this._angularVelocityVector[t]<this._angularVelocityTargetVector[t]&&(this._angularVelocityVector[t]=this._angularVelocityTargetVector[t])):this._angularVelocityVector[t]<this._angularVelocityTargetVector[t]&&(this._angularVelocityVector[t]+=this._angularDeceleration*e/1e3,this._angularVelocityVector[t]>this._angularVelocityTargetVector[t]&&(this._angularVelocityVector[t]=this._angularVelocityTargetVector[t])))},CameraController.prototype._updateVelocity=function(e){var t;for(t=0;t<this._controlledVelocityVector.length;t++)this._controlledVelocityVector[t]>=0?this._controlledVelocityVector[t]<this._velocityTargetVector[t]?(this._controlledVelocityVector[t]+=this._acceleration*e/1e3,this._controlledVelocityVector[t]>this._velocityTargetVector[t]&&(this._controlledVelocityVector[t]=this._velocityTargetVector[t])):this._controlledVelocityVector[t]>this._velocityTargetVector[t]&&(this._controlledVelocityVector[t]-=this._deceleration*e/1e3,this._controlledVelocityVector[t]<this._velocityTargetVector[t]&&(this._controlledVelocityVector[t]=this._velocityTargetVector[t])):this._controlledVelocityVector[t]<0&&(this._controlledVelocityVector[t]>this._velocityTargetVector[t]?(this._controlledVelocityVector[t]-=this._acceleration*e/1e3,this._controlledVelocityVector[t]<this._velocityTargetVector[t]&&(this._controlledVelocityVector[t]=this._velocityTargetVector[t])):this._controlledVelocityVector[t]<this._velocityTargetVector[t]&&(this._controlledVelocityVector[t]+=this._deceleration*e/1e3,this._controlledVelocityVector[t]>this._velocityTargetVector[t]&&(this._controlledVelocityVector[t]=this._velocityTargetVector[t])))},CameraController.prototype.executeActions=function(e,t){this._controlledCamera&&(i.Controller.prototype.executeActions.call(this,e),this._updateAngularVelocity(t),this._updateVelocity(t),this._controlledCamera.setControlledVelocityVector(this._controlledVelocityVector),this._controlledCamera.setAngularVelocityVector(this._angularVelocityVector))},{CameraController:CameraController}}),define("modules/screen-manager",["modules/async-resource","modules/application"],function(e,t){"use strict";function ScreenManager(){e.AsyncResource.call(this),this._screens={},this._coveredScreens=[],this._currentScreen=null,this._screensLoaded=0,this._screensToLoad=0}var i;return ScreenManager.prototype=new e.AsyncResource,ScreenManager.prototype.constructor=ScreenManager,ScreenManager.prototype.getScreen=function(e){return e?this._screens[e]:this._currentScreen},ScreenManager.prototype.addScreen=function(e,t,i){var n=function(){++this._screensLoaded===this._screensToLoad&&this.setToReady()}.bind(this);this.resetReadyState(),this._screensToLoad++,this._screens[e._name]=e,e.addScreenToPage(n,t,i),this._currentScreen||(this._currentScreen=e,this._currentScreen.setActive(!0))},ScreenManager.prototype.setCurrentScreen=function(e,i,n){var s,o=this.getScreen(e);if(!o)return void t.showError("Cannot switch to screen '"+e+"', because it does not exist!");if(!0!==i&&null!==this._currentScreen)for(this._currentScreen.hide(),s=0;s<this._coveredScreens.length;s++)this._coveredScreens[s].hide();!0===i?(this._coveredScreens.push(this._currentScreen),this._currentScreen.setActive(!1),this._currentScreen=o,o.superimposeOnPage(n)):(this._currentScreen=o,o.show()),this._currentScreen===o&&this._currentScreen.setActive(!0)},ScreenManager.prototype.closeSuperimposedScreen=function(){this._currentScreen.hide(),this._currentScreen=this._coveredScreens.pop(),this._currentScreen.setActive(!0)},ScreenManager.prototype.closeOrNavigateTo=function(e){this._currentScreen.isSuperimposed()?this.closeSuperimposedScreen():this.setCurrentScreen(e)},ScreenManager.prototype.updateAllScreens=function(){var e;for(e in this._screens)this._screens.hasOwnProperty(e)&&this._screens[e].updateScreen()},i=new ScreenManager,{getScreen:i.getScreen.bind(i),addScreen:i.addScreen.bind(i),setCurrentScreen:i.setCurrentScreen.bind(i),closeSuperimposedScreen:i.closeSuperimposedScreen.bind(i),closeOrNavigateTo:i.closeOrNavigateTo.bind(i),updateAllScreens:i.updateAllScreens.bind(i),executeWhenReady:i.executeWhenReady.bind(i)}}),define("modules/game",["modules/application","modules/screen-manager","modules/strings"],function(e,t,i){"use strict";var n=!1,s=!1,o=!1,r=null,a=null,l=null,c=null,h=null,u=null,d=null,p=function(){n&&s&&o&&(e.log("Initialization of "+r+" completed."),document.body.firstElementChild.remove(),t.setCurrentScreen(a))},_=function(){e._buildScreensAndExecuteCallback(function(){o=!0,p()})},g=function(t){e.requestTextFile(t.folder,t.filename,function(t){var i=JSON.parse(t);e.log("Loading game settings...",1),e._loadGameSettingsAndExecuteCallback(i,function(){e.log("Game settings loaded.",1),s=!0,_()})})},m=function(){e.requestTextFile(l,c,function(t){var i=JSON.parse(t);e.log("Loading game configuration..."),e.setFolders(i.folders),e.setLogVerbosity(i.logVerbosity),e.setVersion(i.version),e.setPlatform(i.platform),e.setDebugVersion(i.debugVersion),e.setReleases(i.releases),e.log("Game version is: "+e.getVersion(),1),e.log("Game platform is: "+e.getPlatform(),1),h=i.defaultLanguage,u=i.configFiles.strings,requirejs(["modules/media-resources"],function(t){e._loadGameConfigurationAndExecuteCallback(i,function(){t.requestConfigLoad(i.dataFiles.media.resources,function(){e.log("Game configuration loaded."),n=!0}),g(i.configFiles.settings)})})})};return e.setGameName=function(e){r=e},e.setStartScreenName=function(e){a=e},e.setConfigFolder=function(e){l=e},e.setConfigFileName=function(e){c=e},e.getDefaultLanguage=function(){return h},e.getLanguage=function(){return i.getLanguage()||h},e.getLanguages=function(){return Object.keys(u)},e.getDefaultCursor=function(){return d},e.requestLanguageChange=function(n,s,o){return u&&u[n]?(i.languageIsLoaded(n)?(i.setLanguage(n),t.updateAllScreens(),o(!1)):e.requestTextFile(u[n].folder,u[n].filename,function(e){i.loadStrings(n,JSON.parse(e),s),i.setLanguage(n),t.updateAllScreens(),o(!0)}),!0):(e.showError("Cannot change application language to '"+n+"' as there is no strings file set for this langauge!"),!1)},e.initialize=function(t){if(e.log("Initializing "+r+"..."),e.useElectron(t.electron),!e.usesElectron()&&"file:"===location.protocol&&!t.local)return void this.showError("Trying to run the game from the local filesystem!",e.ErrorSeverity.CRITICAL,"This application can only be run through a web server. If you wish to run it from your own computer, you have to install, set up and start a web server first. You have to put the folder containing the files of this game (assume it is called 'game') to the HTML serving folder of the web server, then you can start the game by entering 'localhost/game' in your browser's address bar.");d=document.body.style.cursor,m()},e.getScreen=t.getScreen,e.setScreen=t.setCurrentScreen,e.addScreen=t.addScreen,e.closeSuperimposedScreen=t.closeSuperimposedScreen,e.closeOrNavigateTo=t.closeOrNavigateTo,e.updateAllScreens=t.updateAllScreens,e.executeWhenAllScreensReady=t.executeWhenReady,e}),define("modules/components",["utils/utils","modules/application","modules/async-resource","modules/strings"],function(e,t,i,n){"use strict";function _isModelLoadedForSource(e){return F[e]&&!!F[e].model}function _getModelForSource(e){return F[e]&&F[e].model}function _isModelRequestedForSource(e){return F[e]&&F[e].requested}function _requestModelForSource(e,i){_isModelRequestedForSource(e)?_isModelLoadedForSource(e)?i&&i():F[e].onLoadQueue.push(i):(F[e]={},F[e].requested=!0,F[e].onLoadQueue=[i],t.requestTextFile(s,e,function(t){var i,n;for(F[e].model=document.createDocumentFragment(),n=document.createElement("div"),n.innerHTML=t,F[e].model.appendChild(n.firstElementChild),i=0;i<F[e].onLoadQueue.length;i++)F[e].onLoadQueue[i]()}))}function _getLabelText(t){var i=t.getCaption?t.getCaption():t.caption||n.get({name:t.id});return t.replacements?e.formatString(i,t.replacements):i}function clearStoredDOMModels(){F={}}function appendFormattedContent(e,t){var i,n,s,o,r,a;for(i=t.split("[p]"),s=0;s<i.length;s++)if(i[s]){for(n=document.createElement("p"),r=i[s].split("["),o=0;o<r.length;o++)if(r[o])if(o%2==0)n.appendChild(document.createTextNode(r[o].substring(r[o].indexOf("]")+1)));else{switch(a=document.createElement("span"),r[o].substring(0,r[o].indexOf("]"))){case"b":a.className=y;break;case"s":a.className=E;break;case"s:h":a.className=C}a.textContent=r[o].substring(r[o].indexOf("]")+1),n.appendChild(a)}e.appendChild(n)}}function SimpleComponent(e,t,i){this._name=e,this._elementID=t||e,this._element=null,this._onShow=i?i[M]:null,this._onHide=i?i[I]:null,this._onEnable=i?i[A]:null,this._onDisable=i?i[x]:null,this._onSelect=i?i[v]:null,this._onUnselect=i?i[O]:null}function ExternalComponent(e,t,n){i.AsyncResource.call(this),this._name=e,this._rootElementID=e,this._htmlFilename=t,this._style=n||{},this._rootElement=null,this._cssLoaded=!1,this._simpleComponents=[],t&&this.requestModelLoad()}function LoadingBox(e,t,i,n){ExternalComponent.call(this,e,t,i),this._progress=this.registerSimpleComponent(o),this._status=this.registerSimpleComponent(r),this._header=this.registerSimpleComponent(a),this._image=this.registerSimpleComponent(l),this._headerID=n}function InfoBox(e,t,i,n,s,o){ExternalComponent.call(this,e,t,i),this._onShow=o?o[M]:null,this._onHide=o?o[I]:null,this._onButtonSelect=o?o[R]:null,this._onButtonClick=o?o[b]:null,this._message=this.registerSimpleComponent(c),this._okButton=this.registerSimpleComponent(h,this._onButtonSelect?{select:function(){this._onButtonSelect(this._okButton.isEnabled())}.bind(this)}:null),this._header=this.registerSimpleComponent(u),this._headerID=n,this._okButtonID=s,this._handleKeyUp=function(e){e.keyCode===f?this._okButton._element.onclick():e.keyCode!==S&&e.keyCode!==T||this._okButton.select()}.bind(this)}function MenuComponent(e,t,i,n,s){var o;for(ExternalComponent.call(this,e,t,i),this._menuOptions=n,o=0;o<this._menuOptions.length;o++)void 0===this._menuOptions[o].enabled&&(this._menuOptions[o].enabled=!0);this._selectedIndex=-1,this._onOptionSelect=s?s[L]:null,this._onOptionClick=s?s[N]:null,this._validateStyle(i)}function CheckGroup(e,t,i,n,s){ExternalComponent.call(this,e,t,i),this._options=n,this._onChange=s?s[P]:null,this._onClick=s?s[D]:null,this._onSelect=s?s[v]:null}function ListComponent(e,t,i,n,s,o){var r;for(ExternalComponent.call(this,e,t,i),this._listElements=n,r=0;r<this._listElements.length;r++)void 0===this._listElements[r].enabled&&(this._listElements[r].enabled=!0);this._subcaptions=s,this._highlightedIndex=-1,this._selectedIndex=-1,this._onElementHighlight=o?o[w]:null,this._onElementSelect=o?o[V]:null,this._ulElement=null,this._validateStyle(i)}function Selector(e,t,i,n,s){ExternalComponent.call(this,e,t,i),this._propertyLabelDescriptor=n,this._valueList=s,this._valueIndex=0,this._propertyLabel=this.registerSimpleComponent(d),this._valueSelector=this.registerSimpleComponent(p),this.onChange=null}function Slider(e,t,i,n,s,o){ExternalComponent.call(this,e,t,i),this._propertyLabelDescriptor=n,s=s||{},this._min=s.valueList?0:s.min,this._max=s.valueList?s.valueList.length-1:s.max,this._default=s.default,this._step=s.valueList?1:void 0!==s.step?s.step:1,this._valueList=s.valueList||null,this._propertyLabel=this.registerSimpleComponent(_),this._slider=this.registerSimpleComponent(g),this._valueLabel=this.registerSimpleComponent(m),this.onChange=o||null}var s="component",o="progress",r="status",a="header",l="image",c="message",h="okButton",u="header",d="property",p="value",_="property",g="slider",m="valueLabel",f=13,S=38,T=40,y="bold",E="ship",C="ship-hostile",M="show",I="hide",A="enable",x="disable",v="select",O="unselect",R="buttonselect",b="buttonclick",L="optionselect",N="optionclick",D="click",P="change",w="elementhighlight",V="elementselect",F={};return SimpleComponent.prototype.setElementID=function(e){this._elementID=e,this._element&&this._element.setAttribute("id",this._elementID)},SimpleComponent.prototype.getContent=function(){return this._element.innerHTML},SimpleComponent.prototype.setContent=function(t,i){this._element.innerHTML=i?e.formatString(t,i):t},SimpleComponent.prototype.setTextContent=function(t,i){this._element.textContent=i?e.formatString(t,i):t},SimpleComponent.prototype.customizeContent=function(t){this._element.innerHTML=e.formatString(this._element.innerHTML,t)},SimpleComponent.prototype.getAttribute=function(e){return this._element[e]},SimpleComponent.prototype.setAttribute=function(e,t){this._element[e]=t},SimpleComponent.prototype.initComponent=function(){this._element=document.getElementById(this._elementID),this._element||t.showError("Cannot initialize component: '"+this._name+"'!",t.ErrorSeverity.SEVERE,"No element can be found on the page with a corresponding ID: '"+this._elementID+"'!")},SimpleComponent.prototype.isVisible=function(){return!this._element.hidden},SimpleComponent.prototype.hide=function(){this.isVisible()&&(this._element.hidden=!0,this._onHide&&this._onHide())},SimpleComponent.prototype.show=function(){this.isVisible()||(this._element.hidden=!1,this._onShow&&this._onShow())},SimpleComponent.prototype.setVisible=function(e){e?this.show():this.hide()},SimpleComponent.prototype.isEnabled=function(){return!this._element.classList.contains("disabled")},SimpleComponent.prototype.disable=function(){this.isEnabled()&&(this._element.classList.add("disabled"),this._onDisable&&this._onDisable())},SimpleComponent.prototype.enable=function(){this.isEnabled()||(this._element.classList.remove("disabled"),this._onEnable&&this._onEnable())},SimpleComponent.prototype.isSelected=function(){return this._element.classList.contains("selected")},SimpleComponent.prototype.select=function(){this.isSelected()||(this._element.classList.add("selected"),this._onSelect&&this._onSelect())},SimpleComponent.prototype.unselect=function(){this.isSelected()&&(this._element.classList.remove("selected"),this._onUnselect&&this._onUnselect()),this._element.blur()},ExternalComponent.prototype=new i.AsyncResource,ExternalComponent.prototype.constructor=ExternalComponent,ExternalComponent.prototype.setRootElementID=function(e){var i;if(this._rootElement)t.showError("Attempting to change the root element ID for external component '"+this._name+"' after it has already been added to the page!");else for(this._rootElementID=e,i=0;i<this._simpleComponents.length;i++)this._simpleComponents[i].setElementID(this._getElementID(this._simpleComponents[i]._name))},ExternalComponent.prototype.requestModelLoad=function(){this._style.cssFilename?(this._cssLoaded=!1,t.requestCSSFile("css",this._style.cssFilename,function(){this._cssLoaded=!0,_isModelLoadedForSource(this._htmlFilename)&&this.setToReady()}.bind(this))):this._cssLoaded=!0,_requestModelForSource(this._htmlFilename,function(){!0===this._cssLoaded&&this.setToReady()}.bind(this))},ExternalComponent.prototype.appendToPage=function(e){var t,i;for(e=e||document.body,this._rootElement=e.appendChild(document.importNode(_getModelForSource(this._htmlFilename).firstElementChild,!0)),this._rootElement.setAttribute("id",this._rootElementID),t=this._rootElement.querySelectorAll("[id]"),i=0;i<t.length;i++)t[i].setAttribute("id",this._getElementID(t[i].getAttribute("id")));this._initializeComponents()},ExternalComponent.prototype._getElementID=function(e){return this._rootElementID+"_"+e},ExternalComponent.prototype._getOriginalElementID=function(e){return e.getAttribute("id").substr(this._rootElementID.length+"_".length)},ExternalComponent.prototype._initializeComponents=function(){var e;if(this._rootElement)for(e=0;e<this._simpleComponents.length;e++)this._simpleComponents[e].initComponent()},ExternalComponent.prototype.updateComponents=function(){var e,t;if(this._rootElement&&this._rootElement.parentNode===document.body)for(t=this._rootElement.querySelectorAll("[data-translation-key]"),e=0;e<t.length;e++)t[e].innerHTML=n.get({name:t[e].getAttribute("data-translation-key"),defaultValue:t[e].innerHTML})},ExternalComponent.prototype.registerSimpleComponent=function(e,t){var i=new SimpleComponent(e,this._getElementID(e),t);return this._simpleComponents.push(i),i},ExternalComponent.prototype.isVisible=function(){return!this._rootElement.hidden},ExternalComponent.prototype.show=function(){return!(!this._rootElement||this.isVisible())&&(this._rootElement.hidden=!1,!0)},ExternalComponent.prototype.hide=function(){return!(!this._rootElement||!this.isVisible())&&(this._rootElement.hidden=!0,!0)},ExternalComponent.prototype.setVisible=function(e){e?this.show():this.hide()},
LoadingBox.prototype=new ExternalComponent,LoadingBox.prototype.constructor=LoadingBox,LoadingBox.prototype._initializeComponents=function(){ExternalComponent.prototype._initializeComponents.call(this),this._rootElement&&(this._headerID&&this._header.setElementID(this._getElementID(this._headerID)),this.hide())},LoadingBox.prototype.setMaxProgress=function(e){this._rootElement&&(this._progress._element.max=e)},LoadingBox.prototype.updateProgress=function(e){this._rootElement&&(this._progress._element.value=e)},LoadingBox.prototype.updateStatus=function(e,t,i){this._rootElement&&(this._status.setContent(e,t),void 0!==i&&this.updateProgress(i))},LoadingBox.prototype.makeIndeterminate=function(){this._rootElement&&(this._progress.hide(),this._image.show())},InfoBox.prototype=new ExternalComponent,InfoBox.prototype.constructor=InfoBox,InfoBox.prototype._initializeComponents=function(){ExternalComponent.prototype._initializeComponents.call(this),this._rootElement&&(this._headerID&&this._header.setElementID(this._getElementID(this._headerID)),this._okButtonID&&this._okButton.setElementID(this._getElementID(this._okButtonID)),this._okButton._element.onmouseenter=function(){this._okButton.select()}.bind(this),this._okButton._element.onmouseleave=function(){this._okButton.unselect()}.bind(this),this._okButton._element.onclick=function(){return this._onButtonClick&&this._onButtonClick(this._okButton.isEnabled()),this.hide(),!1}.bind(this),ExternalComponent.prototype.hide.call(this))},InfoBox.prototype.show=function(){return!!ExternalComponent.prototype.show.call(this)&&(this._okButton.unselect(),document.addEventListener("keyup",this._handleKeyUp),this._onShow&&this._onShow(),!0)},InfoBox.prototype.hide=function(){return!!ExternalComponent.prototype.hide.call(this)&&(document.removeEventListener("keyup",this._handleKeyUp),this._onHide&&this._onHide(),!0)},InfoBox.prototype.updateMessage=function(e,t,i){this._rootElement&&(i?this._message.setContent(e,t):this._message.setTextContent(e,t))},InfoBox.prototype.onButtonClick=function(e){this._onButtonClick=e},MenuComponent.prototype=new ExternalComponent,MenuComponent.prototype.constructor=MenuComponent,MenuComponent.prototype._validateStyle=function(e){if("object"!=typeof e)return void t.showError("Invalid menu style specified: not an object!");e.selectedButtonClassName||t.showError("Attempting to specify a menu style without specifying a class for selected menu buttons!"),e.disabledClassName||t.showError("Attempting to specify a menu style without specifying a class for disabled menu buttons!")},MenuComponent.prototype._selectIndex=function(e){e!==this._selectedIndex&&(this._selectedIndex>=0&&(this._menuOptions[this._selectedIndex].element.classList.remove(this._style.selectedButtonClassName),this._menuOptions[this._selectedIndex].element.blur()),this._selectedIndex=e,this._selectedIndex>=0&&this._menuOptions[this._selectedIndex].enabled&&(this._menuOptions[this._selectedIndex].element.classList.add(this._style.selectedButtonClassName),this._onOptionSelect&&this._onOptionSelect(!0)))},MenuComponent.prototype._getMenuClickHandler=function(e){return function(){return this._menuOptions[e].enabled&&(this._selectIndex(e),this._menuOptions[e].action()),this._onOptionClick&&this._onOptionClick(this._menuOptions[e].enabled),!1}.bind(this)},MenuComponent.prototype._getMenuMouseMoveHandler=function(e){return function(){this._menuOptions[e].enabled&&this._selectIndex(e)}.bind(this)},MenuComponent.prototype._initializeComponents=function(){var e,t,i;if(ExternalComponent.prototype._initializeComponents.call(this),this._rootElement){for(this._rootElement.classList.add(this._style.menuClassName),e=0;e<this._menuOptions.length;e++)t=document.createElement("button"),this._menuOptions[e].id&&(t.id=this._getElementID(this._menuOptions[e].id)),t.className=(this._style.menuClassName||"")+" "+(this._style.buttonClassName||"")+(this._menuOptions[e].enabled?"":this._style.disabledClassName),t.innerHTML=_getLabelText(this._menuOptions[e]),t.onclick=this._getMenuClickHandler(e),t.onmousemove=this._getMenuMouseMoveHandler(e),this._menuOptions[e].element=t,i=document.createElement("li"),i.className=this._style.buttonContainerClassName||"",i.appendChild(t),this._rootElement.appendChild(i);this._rootElement.onmouseout=this.unselect.bind(this),this.refresh()}},MenuComponent.prototype.updateComponents=function(){var e;for(ExternalComponent.prototype.updateComponents.call(this),e=0;e<this._menuOptions.length;e++)this._menuOptions[e].element.innerHTML=_getLabelText(this._menuOptions[e])},MenuComponent.prototype.unselect=function(){this._selectIndex(-1)},MenuComponent.prototype.selectNext=function(){var e=this._selectedIndex;-1===e&&(e=this._menuOptions.length-1);do{this._selectIndex((this._selectedIndex+1)%this._menuOptions.length)}while(this._selectedIndex!==e&&!this._menuOptions[this._selectedIndex].enabled);this._menuOptions[this._selectedIndex].enabled||this._selectIndex(-1)},MenuComponent.prototype.selectPrevious=function(){var e=this._selectedIndex;-1===e&&(e=0);do{this._selectedIndex>0?this._selectIndex(this._selectedIndex-1):this._selectIndex(this._menuOptions.length-1)}while(this._selectedIndex!==e&&!this._menuOptions[this._selectedIndex].enabled);this._menuOptions[this._selectedIndex].enabled||this._selectIndex(-1)},MenuComponent.prototype.activateSelected=function(){this._selectedIndex>=0&&this._menuOptions[this._selectedIndex].element.onclick()},MenuComponent.prototype.refresh=function(){var e;for(e=0;e<this._menuOptions.length;e++)this._menuOptions[e].element&&(this._menuOptions[e].enabled?this._menuOptions[e].element.classList.remove(this._style.disabledClassName):this._menuOptions[e].element.classList.add(this._style.disabledClassName),this._menuOptions[e].isVisible&&(this._menuOptions[e].element.hidden=!this._menuOptions[e].isVisible()))},CheckGroup.prototype=new ExternalComponent,CheckGroup.prototype.constructor=CheckGroup,CheckGroup.prototype._getItemChangeHandler=function(){return function(){this._onChange&&this._onChange()}.bind(this)},CheckGroup.prototype._getItemSelectHandler=function(){return function(){this._onSelect&&this._onSelect(!0)}.bind(this)},CheckGroup.prototype._getItemClickHandler=function(e){return function(t){var i=!0;this._onClick&&(i=this._onClick(t)),i&&(this._options[e].element.click(),t.stopPropagation())}.bind(this)},CheckGroup.prototype._initializeComponents=function(){var e,t,i,n,s=function(e){return e.stopPropagation(),!0},o=this._getItemChangeHandler(),r=this._getItemSelectHandler();if(ExternalComponent.prototype._initializeComponents.call(this),this._rootElement)for(e=0;e<this._options.length;e++)i=document.createElement("input"),i.type="checkbox",this._options[e].id&&(i.id=this._getElementID(this._options[e].id)),i.onchange=o,i.onclick=s,i.onfocus=r,this._options[e].element=i,n=document.createElement("label"),n.innerHTML=_getLabelText(this._options[e]),this._options[e].id&&(n.for=this._getElementID(this._options[e].id)),this._options[e].label=n,t=document.createElement("div"),t.appendChild(i),t.appendChild(n),t.onclick=this._getItemClickHandler(e),t.onmouseenter=r,this._rootElement.appendChild(t)},CheckGroup.prototype.updateComponents=function(){var e;for(ExternalComponent.prototype.updateComponents.call(this),e=0;e<this._options.length;e++)this._options[e].label.innerHTML=_getLabelText(this._options[e])},CheckGroup.prototype.getValue=function(){var e,t=[];for(e=0;e<this._options.length;e++)this._options[e].element.checked&&t.push(this._options[e].value);return t},ListComponent.prototype=new ExternalComponent,ListComponent.prototype.constructor=ListComponent,ListComponent.prototype._validateStyle=function(e){if("object"!=typeof e)return void t.showError("Invalid menu style specified: not an object!");e.disabledElementClassName||t.showError("Attempting to specify a list style without specifying a class for disabled list elements!"),e.selectedElementClassName||t.showError("Attempting to specify a list style without specifying a class for selected list elements!"),e.highlightedElementClassName||t.showError("Attempting to specify a list style without specifying a class for highlighted list elements!")},ListComponent.prototype._scrollToIndex=function(e){var t;t=this._listElements[e].element,t.offsetTop<this._rootElement.scrollTop?this._rootElement.scrollTop=t.offsetTop:t.offsetTop+t.offsetHeight>this._rootElement.scrollTop+this._rootElement.clientHeight&&(this._rootElement.scrollTop=t.offsetTop+t.offsetHeight-this._rootElement.clientHeight)},ListComponent.prototype._highlightIndex=function(e,t){e!==this._highlightedIndex&&(this._highlightedIndex>=0&&this._listElements[this._highlightedIndex].element.classList.remove(this._style.highlightedElementClassName),this._highlightedIndex=e,this._highlightedIndex>=0&&this._listElements[this._highlightedIndex].enabled&&(this._listElements[this._highlightedIndex].element.classList.add(this._style.highlightedElementClassName),t&&this._scrollToIndex(e),this._onElementHighlight&&this._onElementHighlight(e,!0)))},ListComponent.prototype.selectIndex=function(e,t){t&&e>=0&&this._scrollToIndex(e),e!==this._selectedIndex&&((e<0||e>=0&&this._listElements[e].enabled)&&(this._selectedIndex>=0&&this._listElements[this._selectedIndex].element.classList.remove(this._style.selectedElementClassName),this._selectedIndex=e,this._selectedIndex>=0&&this._listElements[this._selectedIndex].element.classList.add(this._style.selectedElementClassName)),this._onElementSelect&&this._onElementSelect(e,e>=0&&this._listElements[e].enabled))},ListComponent.prototype.getHighlightedIndex=function(){return this._highlightedIndex},ListComponent.prototype.getSelectedIndex=function(){return this._selectedIndex},ListComponent.prototype._getElementClickHandler=function(e){return function(){return this._listElements[e].enabled&&this.selectIndex(e),!1}.bind(this)},ListComponent.prototype._getElementMouseMoveHandler=function(e){return function(){this._listElements[e].enabled?this._highlightIndex(e):this._highlightIndex(-1)}.bind(this)},ListComponent.prototype._addListElement=function(e,t){var i,s,o;o=document.createElement("li"),o.className=this._style.elementContainerClassName||"",s=document.createElement("a"),s.className=(this._style.elementClassName||"")+" "+(e.enabled?"":this._style.disabledElementClassName),e.element=s,s.onclick=this._getElementClickHandler(t),s.onmousemove=this._getElementMouseMoveHandler(t),o.appendChild(s),i=document.createElement("span"),e.captionID&&i.setAttribute("data-translation-key",e.captionID),i.className=this._style.captionClassName||"",i.innerHTML=e.caption||n.get({name:e.captionID}),s.appendChild(i),this._subcaptions&&(s.appendChild(document.createElement("br")),i=document.createElement("span"),e.subcaptionID&&i.setAttribute("data-translation-key",e.subcaptionID),i.className=this._style.subcaptionClassName||"",i.innerHTML=e.subcaption||n.get({name:e.subcaptionID}),s.appendChild(i)),this._ulElement.appendChild(o)},ListComponent.prototype.addListElement=function(e){void 0===e.enabled&&(e.enabled=!0),this._listElements.push(e),this._addListElement(e,this._listElements.length-1)},ListComponent.prototype.setListElements=function(e){var t;for(this.reset(),this._ulElement.innerHTML="",this._listElements=e,t=0;t<this._listElements.length;t++)void 0===this._listElements[t].enabled&&(this._listElements[t].enabled=!0),this._addListElement(this._listElements[t],t)},ListComponent.prototype._initializeComponents=function(){var e;if(ExternalComponent.prototype._initializeComponents.call(this),this._rootElement){for(this._rootElement.classList.add(this._style.listContainerClassName),this._ulElement=document.createElement("ul"),this._ulElement.classList.add(this._style.listClassName),e=0;e<this._listElements.length;e++)this._addListElement(this._listElements[e],e);this._rootElement.onmouseleave=this.unhighlight.bind(this),this._rootElement.appendChild(this._ulElement)}},ListComponent.prototype.unhighlight=function(){this._highlightIndex(-1)},ListComponent.prototype.unselect=function(){this.selectIndex(-1)},ListComponent.prototype.reset=function(){this.unselect(),this.unhighlight(),this._rootElement.scrollTop=0},ListComponent.prototype.highlightNext=function(){var e=this._highlightedIndex;-1===e&&(e=this._listElements.length-1);do{this._highlightIndex((this._highlightedIndex+1)%this._listElements.length,!0)}while(this._highlightedIndex!==e&&!this._listElements[this._highlightedIndex].enabled);this._listElements[this._highlightedIndex].enabled||this._highlightIndex(-1)},ListComponent.prototype.highlightPrevious=function(){var e=this._highlightedIndex;-1===e&&(e=0);do{this._highlightedIndex>0?this._highlightIndex(this._highlightedIndex-1,!0):this._highlightIndex(this._listElements.length-1,!0)}while(this._highlightedIndex!==e&&!this._listElements[this._highlightedIndex].enabled);this._listElements[this._highlightedIndex].enabled||this._highlightIndex(-1)},ListComponent.prototype.selectHighlighted=function(){this._highlightedIndex>=0&&this._listElements[this._highlightedIndex].element.onclick()},ListComponent.prototype.executeForListElements=function(e){var t;for(t=0;t<this._listElements.length;t++)e(this._listElements[t].element)},ListComponent.prototype.setCaption=function(e,t){var i=this._listElements[e],n=i.element.querySelector("."+this._style.captionClassName);i.captionID&&(i.captionID="",n.removeAttribute("data-translation-key")),i.caption=t,n.innerHTML=t},Selector.prototype=new ExternalComponent,Selector.prototype.constructor=Selector,Selector.prototype._initializeComponents=function(){ExternalComponent.prototype._initializeComponents.call(this),this._rootElement&&(this._style.selectorClassName&&(this._rootElement.className=this._style.selectorClassName),this._propertyLabelDescriptor.id&&this._propertyLabel.setElementID(this._getElementID(this._propertyLabelDescriptor.id)),this._propertyLabel.setContent(_getLabelText(this._propertyLabelDescriptor)),this._style.propertyContainerClassName&&(this._propertyLabel._element.className=this._style.propertyContainerClassName),this._valueSelector.setContent(this._valueList[0]),this._valueIndex=0,this.setValueList(this._valueList),this._valueSelector._element.onmouseup=function(e){switch(e.preventDefault(),e.stopPropagation(),e.which){case 1:this.selectNextValue();break;case 3:this.selectPreviousValue()}return!1}.bind(this),this._valueSelector._element.oncontextmenu=function(e){return e.preventDefault(),e.stopPropagation(),!1})},Selector.prototype.updateComponents=function(){ExternalComponent.prototype.updateComponents.call(this),this._propertyLabel.setContent(_getLabelText(this._propertyLabelDescriptor))},Selector.prototype.selectValue=function(e){if(this._rootElement){for(var i=0;i<this._valueList.length&&this._valueList[i]!==e;)i++;i<this._valueList.length?this.selectValueWithIndex(i,0):t.showError("Attempted to select value: '"+e+"' for '"+_getLabelText(this._propertyLabelDescriptor)+"', which is not one of the available options.",t.ErrorSeverity.MINOR)}else t.showError("Attemted to select value for selector "+this._name+" which is not yet appended to the page!")},Selector.prototype.selectValueWithIndex=function(e,i){var n=this._valueIndex;this._rootElement?this._valueList.length>e?(this._valueIndex=e,this._valueSelector.setContent(this._valueList[this._valueIndex]),n!==e&&this.onChange&&this.onChange(i||0)):t.showError("Attempted to select value with index '"+e+"' for '"+_getLabelText(this._propertyLabelDescriptor)+"', while the available range is: 0-"+(this._valueList.length-1),t.ErrorSeverity.MINOR):t.showError("Attemted to select value for selector "+this._name+" which is not yet appended to the page!")},Selector.prototype.getSelectedValue=function(){return this._valueList[this._valueIndex]},Selector.prototype.getSelectedIndex=function(){return this._valueIndex},Selector.prototype.selectNextValue=function(){this.selectValueWithIndex((this._valueIndex+1)%this._valueList.length,1)},Selector.prototype.selectPreviousValue=function(){this.selectValueWithIndex(this._valueIndex>0?this._valueIndex-1:this._valueList.length-1,-1)},Selector.prototype.setValueList=function(e){this._valueList=e,this._valueIndex>=this._valueList.length&&(this._valueIndex=0),this._valueList.length<2?this._valueSelector.disable():this._valueSelector.enable()},Selector.prototype.refreshValue=function(){this.selectValueWithIndex(this._valueIndex)},Slider.prototype=new ExternalComponent,Slider.prototype.constructor=Slider,Slider.prototype._initializeComponents=function(){var e=function(){this._updateValueLabel(),this.onChange&&this.onChange(this.getValue())}.bind(this);ExternalComponent.prototype._initializeComponents.call(this),this._rootElement&&(this._propertyLabelDescriptor.id&&this._propertyLabel.setElementID(this._getElementID(this._propertyLabelDescriptor.id)),this._propertyLabel.setContent(_getLabelText(this._propertyLabelDescriptor)),this._valueList?(this.setValueList(this._valueList),this._valueLabel.show()):(this._valueLabel.hide(),this._updateSlider()),this.setNumericValue(this._default),this._slider._element.onchange=e,this._slider._element.oninput=e)},Slider.prototype.updateComponents=function(){ExternalComponent.prototype.updateComponents.call(this),this._propertyLabel.setContent(_getLabelText(this._propertyLabelDescriptor))},Slider.prototype._updateSlider=function(){this._slider.setAttribute("min",this._min),this._slider.setAttribute("max",this._max),this._slider.setAttribute("step",this._step)},Slider.prototype._updateValueLabel=function(){this._valueList&&this._valueLabel.setContent(this._valueList[this.getNumericValue()])},Slider.prototype.setNumericValue=function(e){this._slider.setAttribute("value",e),this._updateValueLabel()},Slider.prototype.setListedValue=function(e){var i;this._valueList?(i=this._valueIndex.indexOf(e),i>=0?this.setNumericValue(i):t.showError("Cannot set listed value '"+e+"' for slider '"+this._name+"', because it is not in the value list!")):t.showError("Cannot set listed value '"+e+"' for slider '"+this._name+"', because it has no value list!")},Slider.prototype.getNumericValue=function(){return parseFloat(this._slider.getAttribute("value"))},Slider.prototype.getListedValue=function(){return this._valueList[this.getNumericValue()]},Slider.prototype.getValue=function(){return this._valueList?this.getListedValue():this.getNumericValue()},Slider.prototype.setValueList=function(e){var t=this.getNumericValue();this._valueList=e,this._min=0,this._max=e.length-1,this._step=1,t>this._max&&(t=0),this._updateSlider(),this.setNumericValue(t)},{ELEMENT_ID_SEPARATOR:"_",DISABLED_CLASS_NAME:"disabled",SELECTED_CLASS_NAME:"selected",HIGHLIGHTED_CLASS_NAME:"highlighted",EYE_CROSSED_CLASS_NAME:"crossed",FOCUSING_CLASS_NAME:"focusing",SHOW_EVENT_NAME:M,HIDE_EVENT_NAME:I,BUTTON_SELECT_EVENT_NAME:R,BUTTON_CLICK_EVENT_NAME:b,OPTION_SELECT_EVENT_NAME:L,OPTION_CLICK_EVENT_NAME:N,TRANSLATION_KEY_ATTRIBUTE:"data-translation-key",clearStoredDOMModels:clearStoredDOMModels,appendFormattedContent:appendFormattedContent,SimpleComponent:SimpleComponent,LoadingBox:LoadingBox,InfoBox:InfoBox,MenuComponent:MenuComponent,CheckGroup:CheckGroup,ListComponent:ListComponent,Selector:Selector,Slider:Slider}}),define("armada/audio",["utils/types","modules/application","modules/async-resource","modules/audio","modules/media-resources","armada/constants","armada/configuration","utils/polyfill"],function(e,t,i,n,s,o,r){"use strict";function AudioSettingsContext(){i.AsyncResource.call(this),this._dataJSON=null,this._masterVolume=1,this._musicVolume=1,this._sfxVolume=1,this._uiVolume=1,this._rolloffFactor=0,this._panningModel=m}function initMusic(e,t,i){var n;S[t]&&S[t].name===e||(n=s.getMusic(e))&&!n.hasError()&&s.executeWhenReady(function(){S[t]={name:e,clip:n.createSoundClip(1,i)}})}function playMusic(e,t,i){void 0===i&&(i=f?e?l:c:e?a:0),e!==f&&(f&&S[f]&&(i>0?S[f].clip.rampVolume(0,i):S[f].clip.stopPlaying()),e&&S[e]&&(S[e].clip.play(!0,t?function(){f===e&&playMusic(t,null,i)}:null),i>0?(S[e].clip.setVolume(0),S[e].clip.rampVolume(1,i)):S[e].clip.setVolume(1)),f=e)}function stopMusic(){var e,t=Object.keys(S);for(e=0;e<t.length;e++)S[t[e]]&&S[t[e]].clip.stopPlaying();f=null}function resume(){n.resume()}var a,l,c,h,u=o.LOCAL_STORAGE_PREFIX+"audio_",d=u+"masterVolume",p=u+"musicVolume",_=u+"sfxVolume",g=u+"uiVolume",m=n.PanningModel.EQUAL_POWER,f=null,S={};return AudioSettingsContext.prototype=new i.AsyncResource,AudioSettingsContext.prototype.constructor=AudioSettingsContext,AudioSettingsContext.prototype.loadConfigurationFromJSON=function(t){t.rolloffFactor&&(this._rolloffFactor=e.getNumberValue("configuration.audio.rolloffFactor",t.rolloffFactor,0)),t.panningModel&&(this._panningModel=e.getEnumValue(n.PanningModel,t.panningModel,{name:"configuration.audio.panningModel"}))},AudioSettingsContext.prototype.loadSettingsFromJSON=function(i,n){if("object"!=typeof i)return void t.showError("Cannot initialize audio settings from JSON: audio section missing or has wrong type ('"+typeof i+"')!");n=n||!1,n||(this._dataJSON=i),this.setMasterVolume(e.getNumberValue("settings.audio.masterVolume",i.masterVolume,1),!1),this.setMusicVolume(e.getNumberValue("settings.audio.musicVolume",i.musicVolume,1),!1),this.setSFXVolume(e.getNumberValue("settings.audio.sfxVolume",i.sfxVolume,1),!1),this.setUIVolume(e.getNumberValue("settings.audio.uiVolume",i.uiVolume,1),!1)},AudioSettingsContext.prototype.loadFromLocalStorage=function(){var i,n,s=function(s,o,r,a){void 0!==localStorage[s]&&(n={silentFallback:t.hasVersionChanged(),defaultValue:r},i=e.getValueOfTypeFromLocalStorage(o,s,n),n.error&&!t.hasVersionChanged()||a(i,!!n.error&&n.error!==e.Errors.INVALID_ENUM_OBJECT_ERROR))};s(d,"number",this.getMasterVolume(),this.setMasterVolume.bind(this)),s(p,"number",this.getMusicVolume(),this.setMusicVolume.bind(this)),s(_,"number",this.getSFXVolume(),this.setSFXVolume.bind(this)),s(g,"number",this.getUIVolume(),this.setUIVolume.bind(this)),this.setToReady()},AudioSettingsContext.prototype.restoreDefaults=function(){this.loadSettingsFromJSON(this._dataJSON,!0),localStorage.removeItem(d),localStorage.removeItem(p),localStorage.removeItem(_),localStorage.removeItem(g)},AudioSettingsContext.prototype.getMasterVolume=function(){return this._masterVolume},AudioSettingsContext.prototype.setMasterVolume=function(e,t){return void 0===t&&(t=!0),this._masterVolume=e,n.setMasterVolume(this._masterVolume),t&&(localStorage[d]=e.toString()),this._masterVolume===e},AudioSettingsContext.prototype.resetMasterVolume=function(){this.setMasterVolume(void 0!==localStorage[d]?localStorage[d]:this._dataJSON.masterVolume)},AudioSettingsContext.prototype.getMusicVolume=function(){return this._musicVolume},AudioSettingsContext.prototype.setMusicVolume=function(e,t){return void 0===t&&(t=!0),this._musicVolume=e,n.setMusicVolume(this._musicVolume),t&&(localStorage[p]=e.toString()),this._musicVolume===e},AudioSettingsContext.prototype.resetMusicVolume=function(){this.setMusicVolume(void 0!==localStorage[p]?localStorage[p]:this._dataJSON.musicVolume)},AudioSettingsContext.prototype.getSFXVolume=function(){return this._sfxVolume},AudioSettingsContext.prototype.setSFXVolume=function(e,t){return void 0===t&&(t=!0),this._sfxVolume=e,n.setEffectVolume(this._sfxVolume),t&&(localStorage[_]=e.toString()),this._sfxVolume===e},AudioSettingsContext.prototype.resetSFXVolume=function(){this.setSFXVolume(void 0!==localStorage[_]?localStorage[_]:this._dataJSON.sfxVolume)},AudioSettingsContext.prototype.getUIVolume=function(){return this._uiVolume},AudioSettingsContext.prototype.setUIVolume=function(e,t){return void 0===t&&(t=!0),this._uiVolume=e,n.setUIVolume(this._uiVolume),t&&(localStorage[g]=e.toString()),this._uiVolume===e},AudioSettingsContext.prototype.resetUIVolume=function(){this.setUIVolume(void 0!==localStorage[g]?localStorage[g]:this._dataJSON.uiVolume)},AudioSettingsContext.prototype.createSoundSource=function(e,t,i){return new n.SoundSource(e,t,i,this._panningModel,this._rolloffFactor)},h=new AudioSettingsContext,r.executeWhenReady(function(){a=.1,l=1.5,c=.1}),{SOUND_RAMP_DURATION:.1,SoundCategory:n.SoundCategory,loadConfigurationFromJSON:h.loadConfigurationFromJSON.bind(h),loadSettingsFromJSON:h.loadSettingsFromJSON.bind(h),loadSettingsFromLocalStorage:h.loadFromLocalStorage.bind(h),restoreDefaults:h.restoreDefaults.bind(h),getMasterVolume:h.getMasterVolume.bind(h),setMasterVolume:h.setMasterVolume.bind(h),resetMasterVolume:h.resetMasterVolume.bind(h),getMusicVolume:h.getMusicVolume.bind(h),setMusicVolume:h.setMusicVolume.bind(h),resetMusicVolume:h.resetMusicVolume.bind(h),getSFXVolume:h.getSFXVolume.bind(h),setSFXVolume:h.setSFXVolume.bind(h),resetSFXVolume:h.resetSFXVolume.bind(h),getUIVolume:h.getUIVolume.bind(h),setUIVolume:h.setUIVolume.bind(h),resetUIVolume:h.resetUIVolume.bind(h),createSoundSource:h.createSoundSource.bind(h),executeWhenReady:h.executeWhenReady.bind(h),initMusic:initMusic,playMusic:playMusic,stopMusic:stopMusic,resume:resume}}),define("armada/screens/shared",["modules/game","modules/media-resources","modules/components","armada/configuration","armada/audio"],function(e,t,i,n,s){"use strict";function _toggleFullscreen(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.mozExitFullScreen?document.mozExitFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen():document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen?document.documentElement.webkitRequestFullscreen():document.documentElement.msRequestFullscreen&&document.documentElement.msRequestFullscreen()}var o,r,a={GAME_VERSION_LABEL_ID:"gameVersion",MENU_THEME:"menu",DEBRIEFING_VICTORY_THEME:"debriefing_victory",DEBRIEFING_DEFEAT_THEME:"debriefing_defeat",SELECTOR_SOURCE:"selector.html",SELECTOR_CSS:"selector.css",SLIDER_SOURCE:"slider.html",SLIDER_CSS:"slider.css",LOADING_BOX_SOURCE:"loadingbox.html",LOADING_BOX_CSS:"loadingbox.css",INFO_BOX_SOURCE:"infobox.html",INFO_BOX_CSS:"infobox.css",MENU_COMPONENT_SOURCE:"menucomponent.html",CHECK_GROUP_SOURCE:"checkgroup.html",CHECK_GROUP_CSS:"checkgroup.css",LIST_COMPONENT_SOURCE:"listcomponent.html",LIST_COMPONENT_CSS:"listcomponent.css",MENU_CLASS_NAME:"menu",MENU_BUTTON_CONTAINER_CLASS_NAME:"transparentContainer",LIST_CLASS_NAME:"list",LIST_ELEMENT_CLASS_NAME:"listElement",LIST_ELEMENT_CONTAINER_CLASS_NAME:"transparentContainer",CAPTION_CLASS_NAME:"caption",SUBCAPTION_CLASS_NAME:"subcaption",SUPERIMPOSE_BACKGROUND_COLOR:[.25,.25,.25,.5],SCREEN_BACKGROUND_CLASS_NAME:"fullScreenFix",SCREEN_CONTAINER_CLASS_NAME:"fullScreenContainer",RELEASE_NOTES_CLASS_NAME:"releaseNotes",MAIN_MENU_SCREEN_NAME:"mainMenu",MAIN_MENU_SCREEN_SOURCE:"menu.html",MAIN_MENU_CONTAINER_ID:"menuContainer",SINGLE_PLAYER_SCREEN_NAME:"singlePlayer",SINGLE_PLAYER_SCREEN_SOURCE:"menu.html",SINGLE_PLAYER_MENU_CONTAINER_ID:"menuContainer",MISSIONS_SCREEN_NAME:"missions",MISSIONS_SCREEN_SOURCE:"missions.html",MISSIONS_SCREEN_CSS:"missions.css",MISSIONS_LIST_CONTAINER_ID:"missionListContainer",MULTI_GAMES_SCREEN_NAME:"multiGames",MULTI_GAMES_SCREEN_SOURCE:"multi-games.html",MULTI_GAMES_SCREEN_CSS:"multi-games.css",MULTI_LOBBY_SCREEN_NAME:"multiLobby",MULTI_LOBBY_SCREEN_SOURCE:"multi-lobby.html",MULTI_LOBBY_SCREEN_CSS:"multi-lobby.css",MULTI_SCORE_SCREEN_NAME:"multiScore",MULTI_SCORE_SCREEN_SOURCE:"multi-score.html",MULTI_SCORE_SCREEN_CSS:"multi-score.css",BATTLE_SCREEN_NAME:"battle",BATTLE_SCREEN_SOURCE:"battle.html",BATTLE_SCREEN_CSS:"battle.css",DEBRIEFING_SCREEN_NAME:"debriefing",DEBRIEFING_SCREEN_SOURCE:"debriefing.html",DEBRIEFING_SCREEN_CSS:"debriefing.css",DATABASE_SCREEN_NAME:"database",DATABASE_SCREEN_SOURCE:"database.html",DATABASE_SCREEN_CSS:"database.css",SETTINGS_SCREEN_NAME:"settings",SETTINGS_SCREEN_SOURCE:"menu.html",SETTINGS_MENU_CONTAINER_ID:"menuContainer",GENERAL_SETTINGS_SCREEN_NAME:"generalSettings",GENERAL_SETTINGS_SCREEN_SOURCE:"general-settings.html",GENERAL_SETTINGS_SCREEN_CSS:"general-settings.css",GRAPHICS_SCREEN_NAME:"graphics",GRAPHICS_SCREEN_SOURCE:"graphics.html",GRAPHICS_SCREEN_CSS:"graphics.css",AUDIO_SCREEN_NAME:"audio",AUDIO_SCREEN_SOURCE:"audio.html",CONTROLS_SCREEN_NAME:"controls",CONTROLS_SCREEN_SOURCE:"controls.html",CONTROLS_SCREEN_CSS:"controls.css",GAMEPLAY_SETTINGS_SCREEN_NAME:"gameplaySettings",GAMEPLAY_SETTINGS_SCREEN_SOURCE:"gameplay-settings.html",GAMEPLAY_SETTINGS_SCREEN_CSS:"gameplay-settings.css",ABOUT_SCREEN_NAME:"about",ABOUT_SCREEN_SOURCE:"about.html",ABOUT_SCREEN_CSS:"about.css",INGAME_MENU_SCREEN_NAME:"ingameMenu",INGAME_MENU_SCREEN_SOURCE:"ingame-menu.html",INGAME_MENU_SCREEN_CSS:"ingame-menu.css",INGAME_MENU_CONTAINER_ID:"menuContainer",DIALOG_SCREEN_NAME:"dialog",DIALOG_SCREEN_SOURCE:"dialog.html",DIALOG_SCREEN_CSS:"dialog.css"};return a.initAudio=function(e){var i,l;i=t.getSoundEffect(n.getSetting(n.GENERAL_SETTINGS.BUTTON_SELECT_SOUND).name),l=t.getSoundEffect(n.getSetting(n.GENERAL_SETTINGS.BUTTON_CLICK_SOUND).name),s.initMusic("menu",a.MENU_THEME,!0),(i&&!i.isLoaded()&&!i.hasError()||l&&!l.isLoaded()&&!l.hasError())&&t.executeWhenReady(function(){o=i&&i.createSoundClip(t.SoundCategory.UI,n.getSetting(n.GENERAL_SETTINGS.BUTTON_SELECT_SOUND).volume),r=l&&l.createSoundClip(t.SoundCategory.UI,n.getSetting(n.GENERAL_SETTINGS.BUTTON_CLICK_SOUND).volume)}),t.requestResourceLoad(),e&&t.executeWhenReady(e)},a.playButtonSelectSound=function(e){o&&e&&o.play()},a.playButtonClickSound=function(e){r&&e&&r.play()},a.openDialog=function(t){e.getScreen(a.DIALOG_SCREEN_NAME).setup(t),e.setScreen(a.DIALOG_SCREEN_NAME,!0,a.SUPERIMPOSE_BACKGROUND_COLOR)},a.getSubParagraph=function(e){return'<p class="sub fadedText">'+e+"</p>"},a.setupFullscreenButton=function(){this.getElement("fullscreenButton").onclick=_toggleFullscreen},a.BUTTON_EVENT_HANDLERS={button:{mouseenter:function(){a.playButtonSelectSound(!this.classList.contains(i.DISABLED_CLASS_NAME))},mouseup:function(){a.playButtonClickSound(!this.classList.contains(i.DISABLED_CLASS_NAME))}}},a.MENU_EVENT_HANDLERS={show:a.setupFullscreenButton,optionselect:a.playButtonSelectSound,optionclick:a.playButtonClickSound},a.MENU_STYLE={menuClassName:a.MENU_CLASS_NAME,buttonContainerClassName:a.MENU_BUTTON_CONTAINER_CLASS_NAME,selectedButtonClassName:i.SELECTED_CLASS_NAME,disabledClassName:i.DISABLED_CLASS_NAME},a}),define("armada/logic/SpacecraftEvents",[],function(){"use strict";return{BEING_TARGETED:"beingTargeted",BEING_HIT:"beingHit",TARGET_HIT:"targetHit",ANY_SPACECRAFT_HIT:"anySpacecraftHit",TARGET_FIRED:"targetFired",FIRED:"fired",COLLIDED:"collided",DESTRUCTED:"destructed",JUMP_ENGAGED:"jumpEngaged",PREPARING_JUMP:"preparingJump",JUMP_OUT_STARTED:"jumpOutStarted",JUMPED_OUT:"jumpedOut",JUMPED_IN:"jumpedIn",ARRIVED:"arrived",JUMP_CANCELLED:"jumpCancelled",COMMAND_RECEIVED:"commandReceived",HUD:"hud"}}),define("armada/logic/equipment",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/physics","modules/media-resources","modules/pools","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","armada/graphics","armada/audio","armada/logic/classes","armada/logic/SpacecraftEvents","armada/configuration","armada/logic/constants","armada/logic/explosion","utils/polyfill"],function(e,t,i,n,s,o,r,a,l,c,h,u,d,p,_,g,m,f){"use strict";function handleGraphicsSettingsChanged(){X={},X[Y]=s.ShaderVariableType.MAT4,u.areLuminosityTexturesAvailable()&&(X[W]=s.ShaderVariableType.FLOAT),q=u.areDynamicLightsAvailable()&&u.getMaxPointLights()>0}function handleDifficultySet(e){G=e._playerSelfDamage,j=e._playerFriendlyFireDamage,k=e._hitboxOffset}
function setFriendlyFire(e){j=e}function _addThrusterBurn(e,t){var i;for(e.burn+=t,i=0;i<e.thrusters.length;i++)e.thrusters[i].addBurn(t)}function _getDefaultOffset(e,t){return t?k:0}function _checkHitForObject(e){var i,n,s,o,r,a,l,c;return s=e.pMo,l=b.isHostile(e),!!(s&&(e!==b&&(j||!e._piloted||l)||e===b&&Q)&&(c=K(e,J&&l),o=s.checkHit(L,N,D,c)))&&(t.setDiffTranslation3($,N,s._velocityMatrix),n=t.extractLength3($),i=t.prodMat4Vec3Aux(e.vMo.oM,$),r=t.prodVec4Mat4Aux(o,e.vMo.getModelMatrix()),a=t.diffVec3Mat4Aux(r,s.pM),Z(e,s,o,r,a,i,$,n,c),!0)}function _checkHit(e,t,i,n,s,o,r){L=e,N=t,D=n,b=s,K=o,Z=r,J=s._piloted,Q=H&&(G||!J),i.executeForObjects(Math.min(e[12],e[12]-t[12]*n*.001),Math.max(e[12],e[12]-t[12]*n*.001),Math.min(e[13],e[13]-t[13]*n*.001),Math.max(e[13],e[13]-t[13]*n*.001),Math.min(e[14],e[14]-t[14]*n*.001),Math.max(e[14],e[14]-t[14]*n*.001),_checkHitForObject)}function Projectile(e,t){this._class=null,this.vMo=null,this._velocityMatrix=i.identity4(),this._timeLeft=0,this._origin=null,this._lightSource=null,this._hitCallback=Projectile.prototype._hitCallback.bind(this),e&&this.init(e,t)}function TrailEmitter(e){this._descriptor=e,this._firstPoint=[0,0,0],this._lastPoint=[0,0,0],this._emitting=!1,this._lastSegment=null,this.vMo=null,this._lastScene=null}function Missile(e,t,n,s,r,a){this._class=null,this.vMo=null,this._trailEmitter=null,this.pMo=new o.PhysicalObject,this._timeLeft=0,this._origin=null,this._turningMatrix=i.identity4(),this._turningMatrixValid=!1,this._yawTarget=0,this._pitchTarget=0,this._turningLimit=0,this._thrusters=[],this._forward={burn:0,thrusters:[]},this._yawLeft={burn:0,thrusters:[]},this._yawRight={burn:0,thrusters:[]},this._pitchUp={burn:0,thrusters:[]},this._pitchDown={burn:0,thrusters:[]},this._burnForAngularVelocityChangeFactor=0,this._mainBurn=!1,this._started=!1,this._homing=!1,this._stopHoming=!1,this._t=null,this._tHitPosition=[0,0,0],this._tHitPositionValid=!1,this._lightSource=null,this._soundSource=d.createSoundSource(0,0,0),this._startSound=null,this._hitCallback=Missile.prototype._hitCallback.bind(this),this._getHitOffset=Missile.prototype._getHitOffset.bind(this),e&&this.init(e,t||i.IDENTITY4,n||i.IDENTITY4,s,r,a)}function Weapon(e,t,n){this._class=e,this._sc=t,this._slot=n,this._cooldown=0,this.vMo=null,this._origoPositionMatrix=i.identity4(),this._scaledOriMatrix=i.identity4(),this._rotationAngles=[0,0],this._rotationChanged=!1,this._transformMatrix=i.identity4(),this._fixed=this._class._fixed,this._lastAimStatus=this._fixed?U:B,this._tDistance=0,this._clear=!this._slot||this._slot.clear,this._aimBlockCalculated=this._fixed||this._clear,this._aimBlocked=new Array(this._class._barrels.length),this._aimBlocked.fill(!1),this._barrelMarkers=null}function MissileLauncher(e,t,i,n){this._class=e,this._sc=t,this._descriptor=i,this._mCount=n,this._cooldown=0,this._activeTubeIndex=0,this._salvo=!1,this._salvoLeft=0,this._salvoTarget=null,this.vMos=null}function TargetingComputer(e,t,i){this._sc=e,this._rangeSquared=0,this._t=null,this._scArray=t||null,this._tHitPosition=[0,0,0],this._tHitPositionValid=!1,this._orderedHostileTargets=null,this._orderedNonHostileTargets=null,this._timeUntilHostileOrderReset=0,this._timeUntilNonHostileOrderReset=0,this._mL=null,this._lockTime=1,this._lockTimeLeft=1,this._rangeFactor=i?i.getSensorRangeFactor():1,this._lockingTimeFactor=i?i.getLockingTimeFactor():1}function Thruster(e,t){this._propulsionClass=e,this._slot=t,this.vMo=null,this._shipModel=null,this._burnLevel=0,this._maxMoveBurnLevel=this._propulsionClass.getMaxMoveBurnLevel()}function Propulsion(e,t){this._class=e,this._drivenPhysicalObject=t,this._thrusters=[],this._forward={burn:0,thrusters:[]},this._reverse={burn:0,thrusters:[]},this._strafeLeft={burn:0,thrusters:[]},this._strafeRight={burn:0,thrusters:[]},this._raise={burn:0,thrusters:[]},this._lower={burn:0,thrusters:[]},this._yawLeft={burn:0,thrusters:[]},this._yawRight={burn:0,thrusters:[]},this._pitchUp={burn:0,thrusters:[]},this._pitchDown={burn:0,thrusters:[]},this._rollLeft={burn:0,thrusters:[]},this._rollRight={burn:0,thrusters:[]},this._thrusterSoundClip=null,this._thrustFactor=this._class.getThrust()/this._class.getMaxMoveBurnLevel(),this._angularThrustFactor=this._class.getAngularThrust()/this._class.getMaxTurnBurnLevel()}function ManeuveringComputer(e){this._sc=e,this._assisted=!0,this._restricted=!1,this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0,this._holdSpeed=!1,this._speedThrottled=!1,this._speedTarget=0,this._strafeTarget=0,this._liftTarget=0,this._locked=!1,this._speedIncrementPerSecond=0,this._speedIncrement=0,this._maxCombatForwardSpeed=0,this._maxCombatReverseSpeed=0,this._maxCruiseForwardSpeed=0,this._maxCruiseReverseSpeed=0,this._turningLimit=0,this._maxMoveBurnLevel=0,this._maxTurnBurnLevel=0,this._lastYawTarget=0,this._lastPitchTarget=0,this._lastRollTarget=0,this._lastStrafeTarget=0,this._lastLiftTarget=0,this.updateForNewPropulsion()}function JumpEngine(e,t){this._class=e,this._sc=t,this._state=JumpEngine.JumpState.NONE,this._timeLeft=0,this._soundClip=null,this._originalFlightMode=null,this._originalScalingMatrix=null}function Shield(e,t){var i;this._class=e,this._sc=t,this._capacity=e._capacity,this._timeSinceHit=0,this._timeSinceRecharge=e?e._rechargeAnimationDuration:0,this._state=[0,0,0,0],e&&(i=e._rechargeColor,this._state[0]=i[0],this._state[1]=i[1],this._state[2]=i[2]),this._soundClip=null}var S,T,y,E,C,M,I,A,x,v,O,R,b,L,N,D,P={FREE:"free",COMBAT:"combat",CRUISE:"cruise"},w={FORWARD:"forward",REVERSE:"reverse",STRAFE_LEFT:"strafeLeft",STRAFE_RIGHT:"strafeRight",RAISE:"raise",LOWER:"lower",YAW_LEFT:"yawLeft",YAW_RIGHT:"yawRight",PITCH_UP:"pitchUp",PITCH_DOWN:"pitchDown",ROLL_LEFT:"rollLeft",ROLL_RIGHT:"rollRight"},V=Math.radians(.05),F=1e3/o.ANGULAR_VELOCITY_MATRIX_DURATION,U=0,B=1,H=!1,G=!1,j=!1,k=0,W=null,Y=null,X=null,q=!1,z={yaw:0,pitch:0,roll:0},J=!1,Q=!1,K=null,Z=null,$=[0,0,0];return Object.freeze(P),Object.freeze(w),Projectile.prototype.init=function(e,t){this._class=e,this._timeLeft=e._duration,this._origin=t},Projectile.prototype.canBeReused=function(){return this._timeLeft<=0},Projectile.prototype.createVisualModel=function(){this.vMo=new l.Billboard},Projectile.prototype._initVisualModel=function(e,t,n,s){this.vMo||this.createVisualModel(),i.setIdentity4(this._velocityMatrix),this._origin&&i.copyTranslation4(this._velocityMatrix,this._origin.pMo._velocityMatrix),s&&(this._velocityMatrix[12]+=n[4]*s,this._velocityMatrix[13]+=n[5]*s,this._velocityMatrix[14]+=n[6]*s),this.vMo.init(this._class.getModel(),this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),this._class.getSize(),e,t||i.IDENTITY4,n||i.IDENTITY4,this._class.getInstancedShader())},Projectile.prototype.addToSceneNow=function(e,t,i,n,s,o){this._initVisualModel(t,i,n,s),e.addObject(this.vMo,!1,!0),o&&o(this.vMo)},Projectile.prototype.addToScene=function(e,t,i,n,s,o){r.executeWhenReady(this.addToSceneNow.bind(this,e,t,i,n,s,o))},Projectile.prototype.addResourcesToScene=function(e,t){var n,s="projectile/"+this._class._name;this._class.acquireResources({projectileOnly:!1,sound:!0}),r.executeWhenReady(function(){e.hasResourcesOfObject(s)||(this._initVisualModel(t),e.addResourcesOfObject(this.vMo,s),n=new f.Explosion(this._class._explosionClass,i.IDENTITY4,i.IDENTITY4,[0,0,0],!0),n.addResourcesToScene(e),n=new f.Explosion(this._class._shieldExplosionClass,i.IDENTITY4,i.IDENTITY4,[0,0,0],!0),n.addResourcesToScene(e))}.bind(this))},Projectile.prototype._hitCallback=function(e,n,s,o,r,a,l,c,h){var u,d;d=Math.min(this._timeLeft/this._class._dissipationDuration,1),n.applyForceAndTorque(r,l,d*c*this._class._mass*1e3,1,1),u=f.getExplosion(),u.init(e.getShieldIntegrity()>0?this._class._shieldExplosionClass:this._class._explosionClass,i.translation4vAux(o),i.IDENTITY4,t.scaled3Aux(l,-1),!0,!0,n._velocityMatrix),u.addToSceneNow(this.vMo._node.getScene()._rootNode,e._soundSource,!0),e.damage(d*this._class.getDamage(),s,t.scaled3(a,-1),this._origin,!1,h),this._timeLeft=0,this.vMo.markAsReusable(!0)},Projectile.prototype.simulate=function(e,t){var i,n;this.canBeReused()||(i=Math.min(e,this._timeLeft),o.getDrag()>0&&this._class._dragFactor>0&&o.applyDrag(this._velocityMatrix,i,this._class._dragFactor),this.vMo.translateByMatrixMul(this._velocityMatrix,.001*i),this._timeLeft<this._class._dissipationDuration&&(n=this._timeLeft/this._class._dissipationDuration,this.vMo.setDirectionW(n),this._lightSource&&(this._lightSource._objectIntensity=n*this._class._lightIntensity)),_checkHit(this.vMo.pM,this._velocityMatrix,t,i,this._origin,_getDefaultOffset,this._hitCallback),this._timeLeft-=e,this._timeLeft<=0&&this.vMo.markAsReusable(!0))},Projectile.prototype.destroy=function(){this._timeLeft=0,this._class=null,this._origin=null,this.vMo&&this.vMo._node&&this.vMo._node.markAsReusable(!0),this.vMo=null,this._velocityMatrix=null},TrailEmitter.prototype.getDescriptor=function(){return this._descriptor},TrailEmitter.prototype.addResourcesToScene=function(e){this._descriptor.acquireResources(),r.executeWhenReady(function(){e.addResourcesOfObject(new l.TrailSegment(this._descriptor.getModel(),this._descriptor.getShader(),this._descriptor.getTexturesOfTypes(this._descriptor.getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),this._descriptor.getSize(),!1,t.NULL3,t.NULL3,t.NULL3,t.NULL3,t.NULL4,0,0,0,this._descriptor.getInstancedShader()))}.bind(this))},TrailEmitter.prototype.startNew=function(e,i){t.setVector3(this._firstPoint,i),t.setVector3(this._lastPoint,i),this._emitting=!0,this._lastSegment=null,this.vMo=O.getObject(),this.vMo.init(this._descriptor.getSize()),e.addNode(this.vMo._node||new h.RenderableNode(this.vMo,!1,!0)),this._lastScene!==e&&(e.addObjectToMove(this),this._lastScene=e)},TrailEmitter.prototype.addPoint=function(e,i){var n,s,o;this.vMo.setPositionv(e),o=t.normalize3(t.diff3Aux(e,this._lastPoint)),s=this._lastSegment?this._lastSegment.getEndTimeLeft():0,n=R.getObject(),n.init(this._descriptor.getModel(),this._descriptor.getShader(),this._descriptor.getTexturesOfTypes(this._descriptor.getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),this._descriptor.getSize(),!1,this._lastPoint,this._lastSegment?this._lastSegment.getEndDirection():o,e,o,this._descriptor._color,this._descriptor._duration,s,Math.min(this._descriptor._duration,s+this._descriptor._growthRate*i),this._descriptor.getInstancedShader()),this.vMo._node.addSubnode(n._node||new h.RenderableNode(n,!1,!1,!0)),this.vMo.setSize(t.length3(t.diff3Aux(this._firstPoint,e))),t.setVector3(this._lastPoint,e),this._lastSegment=n},TrailEmitter.prototype.translatev=function(e){t.add3(this._lastPoint,e)},TrailEmitter.prototype.detach=function(){this._emitting=!1,this._lastSegment=null,this.vMo&&this.vMo.detach(),this.vMo=null},TrailEmitter.prototype.destroy=function(){this._descriptor=null,this._emitting=!1,this._firstPoint=null,this._lastPoint=null,this._lastSegment=null,this.vMo&&(this.vMo._node.markAsReusable(!0),this.vMo=null)},Missile.prototype.init=function(t,n,s,r,a,l){var c,h=i.identity4Aux();for(r&&i.copyTranslation4(h,r.pMo._velocityMatrix),a&&(h[12]+=s[4]*a,h[13]+=s[5]*a,h[14]+=s[6]*a),this._class=t,this.pMo.init(t._mass,n,s,t._modelScale,h,e.EMPTY_ARRAY,t._dragFactor),this._timeLeft=t._duration,this._timeLeftForIgnition=t._ignitionTime,this._origin=r,this._turningLimit=.2*t._angularAcceleration*o.ANGULAR_VELOCITY_MATRIX_DURATION_S,c=0;c<this._thrusters.length;c++)this._thrusters[c].destroy();this._thrusters.length=0,this._forward.thrusters.length=0,this._yawLeft.thrusters.length=0,this._yawRight.thrusters.length=0,this._pitchUp.thrusters.length=0,this._pitchDown.thrusters.length=0,this.addThrusters(t._thrusterSlots),this._homing=t._homingMode!==p.MissileHomingMode.NONE,this._burnForAngularVelocityChangeFactor=this._homing?1/o.ANGULAR_VELOCITY_MATRIX_DURATION_S*t._mass/t.getAngularThrust()*1e3:0,this._t=l||null,this._tHitPositionValid=!1,this._mainBurn=!1,this._started=!1,this._stopHoming=!1,this._startSound=null},Missile.prototype.canBeReused=function(){return this._timeLeft<=0},Missile.prototype.createVisualModel=function(){this.vMo=new l.ParameterizedMesh},Missile.prototype._initVisualModel=function(e,t,i,n){var s=i?u.getManagedShader(i):this._class.getShader();this.vMo||this.createVisualModel(),this.vMo.init(this._class.getModel(),s,this._class.getTexturesOfTypes(s.getTextureTypes(),u.getTextureQualityPreferenceList()),this.pMo.pM,this.pMo.oM,this.pMo.sM,e,t,void 0,X),this.vMo.hasParameterArray(Y)&&this.vMo.setParameterArray(Y,u.getGroupTransformIdentityArray()),u.areLuminosityTexturesAvailable()&&this.vMo.hasParameterArray(W)&&this.vMo.setParameterArray(W,this._class._defaultLuminosityFactors),n&&(this._trailEmitter=new TrailEmitter(this._class._trailDescriptor))},Missile.prototype.getTarget=function(){return this._t},Missile.prototype.getClass=function(){return this._class},Missile.prototype.addToSceneNow=function(e,i,n,s,o,r){var a;for(this._initVisualModel(i,n,s,o),e.addObject(this.vMo,!0),a=0;a<this._thrusters.length;a++)this._thrusters[a].addToScene(this.vMo._node,!0);q&&this._class._lightColor&&(this._lightSource||(this._lightSource=new c.PointLightSource(this._class._lightColor,0,t.NULL3,[this.vMo])),e.addPointLightSource(this._lightSource,m.MISSILE_LIGHT_PRIORITY)),r&&r(this.vMo)},Missile.prototype.addToScene=function(e,t,i,n,s,o){r.executeWhenReady(this.addToSceneNow.bind(this,e,t,i,n,s,o))},Missile.prototype.addResourcesToScene=function(e,t,n,s,o){var a,l="missile/"+this._class._name;this._class.acquireResources({missileOnly:!1,sound:!0,trail:o}),r.executeWhenReady(function(){e.hasResourcesOfObject(l)||(this._initVisualModel(t,n,s,o),e.addResourcesOfObject(this.vMo,l),o&&this._trailEmitter.addResourcesToScene(e),a=new f.Explosion(this._class._explosionClass,i.IDENTITY4,i.IDENTITY4,[0,0,0],!0),a.addResourcesToScene(e),a=new f.Explosion(this._class._shieldExplosionClass,i.IDENTITY4,i.IDENTITY4,[0,0,0],!0),a.addResourcesToScene(e))}.bind(this))},Missile.prototype.getThrusterUse=function(e){switch(e){case w.FORWARD:return this._forward;case w.YAW_LEFT:return this._yawLeft;case w.YAW_RIGHT:return this._yawRight;case w.PITCH_UP:return this._pitchUp;case w.PITCH_DOWN:return this._pitchDown;default:return n.showError("Invalid thruster use specified for missile: '"+e+"'!",n.ErrorSeverity.SEVERE),null}},Missile.prototype.addThrusters=function(e){var t,i,n,s;for(t=0;t<e.length;t++)for(n=new Thruster(this._class.getPropulsionClass(),e[t]),this._thrusters.push(n),i=0;i<e[t].uses.length;i++)(s=this.getThrusterUse(e[t].uses[i]))&&s.thrusters.push(n)},Missile.prototype.getTurningMatrix=function(){return this._turningMatrixValid||(i.updateProdRotationRotationInverse4(this._turningMatrix,i.prod3x3SubOf4Aux(this.pMo.oM,this.pMo._velocityMatrix),this.pMo.oM),this._turningMatrixValid=!0),this._turningMatrix},Missile.prototype.yawLeft=function(e){this._yawTarget=-e*this._turningLimit},Missile.prototype.yawRight=function(e){this._yawTarget=e*this._turningLimit},Missile.prototype.pitchDown=function(e){this._pitchTarget=-e*this._turningLimit},Missile.prototype.pitchUp=function(e){this._pitchTarget=e*this._turningLimit},Missile.prototype.resetThrusterBurn=function(){var e;for(this._forward.burn=0,this._yawLeft.burn=0,this._yawRight.burn=0,this._pitchUp.burn=0,this._pitchDown.burn=0,e=0;e<this._thrusters.length;e++)this._thrusters[e].resetBurn()},Missile.prototype.addThrusterBurnForward=function(e){_addThrusterBurn(this._forward,e)},Missile.prototype.addThrusterBurnYawLeft=function(e){_addThrusterBurn(this._yawLeft,e)},Missile.prototype.addThrusterBurnYawRight=function(e){_addThrusterBurn(this._yawRight,e)},Missile.prototype.addThrusterBurnPitchUp=function(e){_addThrusterBurn(this._pitchUp,e)},Missile.prototype.addThrusterBurnPitchDown=function(e){_addThrusterBurn(this._pitchDown,e)},Missile.prototype.getNeededBurnForAngularVelocityChange=function(e,t){return e*this._burnForAngularVelocityChangeFactor/t},Missile.prototype._controlTurnThrusters=function(e,t,i){var n;this._yawTarget-e>1e-5?this.addThrusterBurnYawRight(Math.min(1,this.getNeededBurnForAngularVelocityChange(this._yawTarget-e,i))):this._yawTarget-e<-1e-5?this.addThrusterBurnYawLeft(Math.min(1,this.getNeededBurnForAngularVelocityChange(e-this._yawTarget,i))):n=!0,this._pitchTarget-t>1e-5?this.addThrusterBurnPitchUp(Math.min(1,this.getNeededBurnForAngularVelocityChange(this._pitchTarget-t,i))):this._pitchTarget-t<-1e-5?this.addThrusterBurnPitchDown(Math.min(1,this.getNeededBurnForAngularVelocityChange(t-this._pitchTarget,i))):n&&this._stopHoming&&(this._homing=!1),this._yawTarget=0,this._pitchTarget=0},Missile.prototype._applyTurnThrust=function(e){var i,n;i=t.getRowC43Aux(this.pMo.oM),n=t.getRowA43Aux(this.pMo.oM),this._yawRight.burn>0?this.pMo.applyTorque(this._class.getAngularThrust()*this._yawRight.burn,i,e):this._yawLeft.burn>0&&this.pMo.applyTorque(-this._class.getAngularThrust()*this._yawLeft.burn,i,e),this._pitchUp.burn>0?this.pMo.applyTorque(-this._class.getAngularThrust()*this._pitchUp.burn,n,e):this._pitchDown.burn>0&&this.pMo.applyTorque(this._class.getAngularThrust()*this._pitchDown.burn,n,e)},Missile.prototype._getTargetHitPosition=function(){var e,i,n;return this._tHitPositionValid||(e=this._t.getPhysicalPositionVector(),i=t.diffTranslation3Aux(this._t.pMo._velocityMatrix,this.pMo._velocityMatrix),n=this._class.getTargetHitTime(this.pMo.pM,e,i),this._tHitPosition[0]=e[0]+n*i[0],this._tHitPosition[1]=e[1]+n*i[1],this._tHitPosition[2]=e[2]+n*i[2],this._tHitPositionValid=!0),this._tHitPosition},Missile.prototype._turn=function(e,t,i,n,s){var o,r,a,l;r=this._class._angularAcceleration,l=5e3/(r*s),o=i*F,a=Math.max(o*o/(2*r),V),e>a?this.yawLeft(Math.min(Math.max(0,l*(e-a)),1)):e<-a&&this.yawRight(Math.min(Math.max(0,l*(-e-a)),1)),o=n*F,a=Math.max(o*o/(2*r),V),t>a?this.pitchUp(Math.min(Math.max(0,l*(t-a)),1)):t<-a&&this.pitchDown(Math.min(Math.max(0,l*(-t-a)),1))},Missile.prototype._destruct=function(e,t,n,s,o,r){var a;this._t=null,a=f.getExplosion(),a.init(e,t,i.IDENTITY4,n,!0,!0,s),a.addToSceneNow(this.vMo._node.getScene()._rootNode,o,r),this.vMo.markAsReusable(!0),this._startSound&&(this._startSound.stopPlaying(d.SOUND_RAMP_DURATION),this._startSound=null),this._trailEmitter&&this._trailEmitter.detach()},Missile.prototype._getHitOffset=function(e){return this._origin.isHostile(e)?this._class._proximityRange:0},Missile.prototype._hitCallback=function(e,n,s,o,r,a,l,c,h){this._timeLeftForIgnition<=0?(n.applyForceAndTorque(r,l,c*this._class._kineticFactor*this.pMo._mass*1e3,1,1),this._destruct(e.getShieldIntegrity()>0?this._class._shieldExplosionClass:this._class._explosionClass,i.translation4vAux(o),t.scaled3Aux(l,-1),n._velocityMatrix,e._soundSource,!0),e.damage(this._class.getDamage(0),s,t.scaled3(a,-1),this._origin,!0,h),this._timeLeft=0):(n.applyForceAndTorque(r,l,c*this.pMo._mass*1200,1,1),this.pMo.applyForce(c*this.pMo._mass*1200,-l[0],-l[1],-l[2],1))},Missile.prototype.simulate=function(e,n){var s,o,r,a,l,c,h,u;if(!this.canBeReused()){if(a=Math.min(e,this._timeLeft),this._t&&this._homing&&!this._t._alive)this._t=null,this._timeLeftForIgnition<=0&&(this._timeLeft=0);else{if(this._mainBurn=!1,this._timeLeftForIgnition<=0&&this._t)for(o=this.pMo.oM,this.resetThrusterBurn(),this._homing&&!this._stopHoming&&(t.getYawAndPitch(z,t.normalize3(t.prodMat4Vec3Aux(o,t.diffVec3Mat4Aux(this._getTargetHitPosition(),this.pMo.pM)))),r=this._class._mainBurnAngleThreshold),(!this._homing||this._stopHoming||Math.abs(z.yaw)<r&&Math.abs(z.pitch)<r)&&(this.pMo.applyForce(this._class.getThrust(),o[4],o[5],o[6],a),this._mainBurn=!0,this.addThrusterBurnForward(1),this._started||(this._started=!0,this._class._homingMode===p.MissileHomingMode.INITIAL&&(this._stopHoming=!0),o=this.vMo.getPositionMatrixInCameraSpace(this.vMo._node.getScene()._camera),this._soundSource.setPositionImmediate(.1*Math.round(10*o[12]),.1*Math.round(10*o[13]),.1*Math.round(10*o[14])),this._startSound=this._class.playStartSound(this._soundSource))),this._homing&&(c=this.getTurningMatrix(),h=Math.sign(c[4])*t.angle2y(c[4],c[5]),u=Math.sign(c[6])*t.angle2x(c[5],c[6]),this._stopHoming||this._turn(z.yaw,z.pitch,h,u,a),this._controlTurnThrusters(h,u,a),this._applyTurnThrust(a)),s=0;s<this._thrusters.length;s++)this._thrusters[s].updateVisuals();this._started&&(o=this.vMo.getPositionMatrixInCameraSpace(this.vMo._node.getScene()._camera),this._soundSource.updatePosition(.1*Math.round(10*o[12]),.1*Math.round(10*o[13]),.1*Math.round(10*o[14]))),this._lightSource&&(this._lightSource._objectIntensity=this._mainBurn?this._class._lightIntensity:0),this.pMo.simulate(a),this._turningMatrixValid=!1,this._tHitPositionValid=!1,this.vMo.setPositionMatrix(this.pMo.pM),this.vMo.setOrientationMatrix(this.pMo.oM),this._trailEmitter&&(this._mainBurn?(l=this.vMo.getPositionVector(),t.add3(l,t.prodVec3Mat3Aux(this._class.getEnginePosition(),i.prodScalingRotation3Aux(this.vMo.sM,this.vMo.oM))),this._trailEmitter._emitting?this._trailEmitter.addPoint(l,a):this._trailEmitter.startNew(this.vMo._node.getScene(),l)):this._trailEmitter._emitting&&this._trailEmitter.detach()),a>0&&_checkHit(this.pMo.pM,this.pMo._velocityMatrix,n,a,this._origin,this._getHitOffset,this._hitCallback)}this._timeLeft-=e,this._timeLeftForIgnition-=e,this._timeLeft<=0&&(this._timeLeft=0,this.vMo.canBeReused()||(o=this.vMo.getPositionMatrixInCameraSpace(this.vMo._node.getScene()._camera),this._destruct(this._class._explosionClass,this.pMo.pM,t.scaled3Aux(t.normalize3(i.translationVector3(this.pMo._velocityMatrix)),-1),this.pMo._velocityMatrix,d.createSoundSource(o[12],o[13],o[14]),!1)))}},Missile.prototype.updateThrusterVisuals=function(){var e;for(e=0;e<this._thrusters.length;e++)this._thrusters[e].updateVisuals()},Missile.prototype.destroy=function(){var e;for(this._timeLeft=0,this._class=null,this._origin=null,this._turningMatrix=null,this._t=null,this._tHitPosition=null,e=0;e<this._thrusters.length;e++)this._thrusters[e].destroy();this._thrusters=null,this._forward=null,this._yawLeft=null,this._yawRight=null,this._pitchUp=null,this._pitchDown=null,this.vMo&&this.vMo._node&&this.vMo._node.markAsReusable(!0),this.vMo=null,this._trailEmitter&&(this._trailEmitter.destroy(),this._trailEmitter=null),this.pMo=null,this._startSound&&(this._startSound.stopPlaying(d.SOUND_RAMP_DURATION),this._startSound=null),this._soundSource=null,this._lightSource=null,this._hitCallback=null,this._getHitOffset=null},Weapon.prototype.getDisplayName=function(){return this._class.getDisplayName()},Weapon.prototype.getProjectileClass=function(){return this._class.getProjectileClass()},Weapon.prototype.getProjectileVelocity=function(){return this._class.getProjectileVelocity()},Weapon.prototype.getDamage=function(e){return this._class.getDamage(e)},Weapon.prototype.getFirepower=function(e){return this._class.getFirepower(e)},Weapon.prototype.getFireRate=function(){return this._class.getFireRate()},Weapon.prototype.getRange=function(e){return(this._class.getProjectileVelocity()+e)*this._class.getProjectileClass()._duration*.001},Weapon.prototype.getCooldown=function(){return this._class.getCooldown()},Weapon.prototype.getBasePointPosVector=function(e){var i,n=t.prodTranslationRotation3Aux(this._origoPositionMatrix,e);return t.addVec3Mat4(n,this._sc.pMo.pM),i=t.prodVec4Mat4Aux(this._class._basePoint,this._transformMatrix),t.mulVec3Mat4(i,this._scaledOriMatrix),t.mulVec3Mat4(i,e),t.add3(i,n),i},Weapon.prototype.getProjectileOrientationMatrix=function(){return i.setProd3x3SubOf4(Weapon._pOriMatrix,this._slot.orientationMatrix,this._sc.pMo.oM),this._fixed||i.setProd3x3SubOf4(Weapon._pOriMatrix,this._transformMatrix,i.matrix4Aux(Weapon._pOriMatrix)),Weapon._pOriMatrix},Weapon.prototype.acquireResources=function(e){this._class.acquireResources(e)},Weapon.prototype.addToSceneNow=function(e,n,s,o,a){var c,d,_,g,m,f,S;if(_=o.shaderName?u.getManagedShader(o.shaderName):this._class.getShader(),d=this._class.getModel()._scale/e._renderableObject.sM[0],i.setTranslatedByVector(this._origoPositionMatrix,this._slot?this._slot.positionMatrix:i.IDENTITY4,t.prodVec3Mat4Aux(t.scaled3Aux(this._class._attachmentPoint,-1),i.scaledRotationAux(d,this._slot?this._slot.orientationMatrix:i.IDENTITY4))),c=new l.ParameterizedMesh(this._class.getModel(),_,this._class.getTexturesOfTypes(_.getTextureTypes(),u.getTextureQualityPreferenceList()),this._slot?this._origoPositionMatrix:i.identity4(),o.orientationMatrix||(this._slot?this._slot.orientationMatrix:i.identity4()),i.scaling4(d),!0===s,n,void 0,X,this.vMo),e.addSubnode(new h.RenderableNode(c)),o.barrelMarkers){for(m=this._class._barrels,this._barrelMarkers=new h.RenderableNode(new l.ContainerObject(_),!1),g=0;g<m.length;g++)S=(o.barrelMarkerSize||1)/d*this.getProjectileClass()._muzzleFlash.getSize(),f=new l.ShadedLODMesh(r.getModel(p.MARKER_MODEL_NAME).getEgomModel(),u.getManagedShader(o.barrelMarkerShaderName),{},i.translation4v(m[g].getPositionVector()),i.rotationX4(.5*Math.PI),i.scaling4(S),!0,0,0),this._barrelMarkers.addSubnode(new h.RenderableNode(f));c._node.addSubnode(this._barrelMarkers),this._barrelMarkers.hide()}this.vMo||(c.hasParameterArray(Y)&&c.setParameterArray(Y,u.getGroupTransformIdentityArray()),u.areLuminosityTexturesAvailable()&&c.hasParameterArray(W)&&c.setParameterArray(W,this._class._defaultLuminosityFactors),this.vMo=c),i.setProdScalingRotation(this._scaledOriMatrix,this.vMo.sM,this._slot?this._slot.orientationMatrix:i.IDENTITY4),a&&a(c)},Weapon.prototype.addToScene=function(e,t,i,n,s){n.skipResources||(this.acquireResources({omitShader:!!n.shaderName,projectileResources:n.projectileResources,sound:n.sound,barrelMarkers:n.barrelMarkers,barrelMarkerShaderName:n.barrelMarkerShaderName}),n.shaderName&&u.getShader(n.shaderName)),r.executeWhenReady(this.addToSceneNow.bind(this,e,t,i,n,s))},Weapon.prototype._getMuzzleFlashForBarrel=function(e){var t=this._class.getProjectileClass()._muzzleFlash,n=A.getObject();return l.initDynamicParticle(n,t.getModel(),t.getShader(),t.getTexturesOfTypes(t.getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),t._color,t.getSize(),i.translation4vAux(e),t._duration||500,t.getInstancedShader()),n},Weapon.prototype.addProjectileResourcesToScene=function(e){var t,i="weapon/"+this._class._name;t=new Projectile(this.getProjectileClass()),t.addResourcesToScene(e),r.executeWhenReady(function(){var t;e.hasResourcesOfObject(i)||(t=this._getMuzzleFlashForBarrel([0,0,0]),e.addResourcesOfObject(t,i))}.bind(this))},Weapon.prototype.simulate=function(e){var n,s;if(this._cooldown=Math.max(this._cooldown-e,0),this._rotationChanged){for(i.setIdentity4(this._transformMatrix),s=this._class._rotators,n=0;n<s.length;n++)i.rotateAroundPoint4(this._transformMatrix,t.prodVec3Mat4Aux(s[n].center,this._transformMatrix),t.prodVec3Mat4Aux(s[n].axis,this._transformMatrix),this._rotationAngles[n]),this.vMo.setMat4Parameter(Y,s[n].transformGroupIndex,this._transformMatrix);this._rotationChanged=!1}},Weapon._wSlotPosMatrix=i.identity4(),Weapon._pPosMatrix=i.identity4(),Weapon._pOriMatrix=i.identity4(),Weapon._pTargetMatrix=i.identity4(),Weapon._pDirection=[0,0,0],Weapon._barrelPosVector=[0,0,0,1],Weapon._muzzleFlashPosVector=[0,0,0,1],Weapon.prototype.fire=function(e,n,s){var o,r,a,l,u,d,p,_,g,f,S=this.vMo._node.getScene();if(this._cooldown<=0&&(!n||this._lastAimStatus===U||5===this._lastAimStatus)){for(l=t.prodTranslationRotation3Aux(this._origoPositionMatrix,e),i.setTranslatedByVector(Weapon._wSlotPosMatrix,this._sc.pMo.pM,l),u=this.getProjectileOrientationMatrix(),t.setRowB43(Weapon._pDirection,u),d=this.getProjectileClass(),_=this._class._barrels,a=0,o=0;o<_.length;o++)t.setVector4(Weapon._barrelPosVector,_[o].getPositionVector()),this._fixed||t.mulVec4Mat4(Weapon._barrelPosVector,this._transformMatrix),t.setVector4(Weapon._muzzleFlashPosVector,Weapon._barrelPosVector),t.mulVec3Mat4(Weapon._barrelPosVector,i.prod3x3SubOf4Aux(this._scaledOriMatrix,e)),i.setTranslatedByVector(Weapon._pPosMatrix,Weapon._wSlotPosMatrix,Weapon._barrelPosVector),this._aimBlockCalculated||(i.setTranslatedByVector(Weapon._pTargetMatrix,Weapon._pPosMatrix,t.scaled3Aux(Weapon._pDirection,this._tDistance)),this._sc.pMo.checkHit(Weapon._pTargetMatrix,i.translation4vAux(Weapon._pDirection),1e3*this._tDistance,0)?this._aimBlocked[o]=!0:this._aimBlocked[o]=!1),this._aimBlocked[o]||(p=this._getMuzzleFlashForBarrel(Weapon._muzzleFlashPosVector),this.vMo._node.addSubnode(p._node||new h.RenderableNode(p,!1,!1,!0)),r=x.getObject(),r.init(d,this._sc),r.addToSceneNow(S,!1,Weapon._pPosMatrix,u,this.getProjectileVelocity()),q&&d._lightColor&&(f?f.addEmittingObject(r.vMo):(f=new c.PointLightSource(d._lightColor,d._lightIntensity,t.NULL3,[r.vMo]),r._lightSource=f)),this._sc.pMo.applyForceAndTorque(t.diffTranslation3Aux(Weapon._pPosMatrix,this._sc.pMo.pM),t.getRowB43ScaledAux(u,-1),this._class.getFireForce(),1,1),a++);return this._aimBlockCalculated=!0,a>0&&(this._cooldown=this._class.getCooldown(),f&&S.addPointLightSource(f,m.PROJECTILE_LIGHT_PRIORITY),s||(g=i.translationVector3(r.vMo.getPositionMatrixInCameraSpace(S._camera))),this._class.playFireSound(g,s,M,I)),a}return 0},Weapon.prototype.setRotation=function(t,i){this._fixed||(this._rotationAngles[0]=t*e.RAD,this._rotationAngles[1]=i*e.RAD,this._rotationChanged=!0,this._aimBlockCalculated=this._clear)},Weapon.prototype.rotateTo=function(t,i,n,s,o){var r,a,l,c,h;for(a=this._class._rotators,this._lastAimStatus=5,l=0;l<a.length;l++){switch(l){case 0:r=t-this._rotationAngles[0],this._class._rotationStyle===p.WeaponRotationStyle.ROLL_YAW&&Math.abs(r-Math.sign(r)*Math.PI)<Math.abs(r)&&(r-=Math.sign(r)*Math.PI,i=-i);break;case 1:r=i-this._rotationAngles[1]}a[l].restricted||(r>Math.PI?r-=e.DOUBLE_PI:r<-Math.PI&&(r+=e.DOUBLE_PI)),h=this._rotationAngles[l],c=0,Math.abs(r)>n&&(c=a[l].rotationRate*o/1e3,r>0?this._rotationAngles[l]+=Math.min(c,r):this._rotationAngles[l]-=Math.min(c,-r),Math.abs(r)-c>s&&(this._lastAimStatus=3)),
a[l].restricted?(this._rotationAngles[l]>a[l].range[1]&&(this._rotationAngles[l]=a[l].range[1],Math.abs(r)-c>s&&(this._lastAimStatus=2)),this._rotationAngles[l]<a[l].range[0]&&(this._rotationAngles[l]=a[l].range[0],Math.abs(r)-c>s&&(this._lastAimStatus=2))):(this._rotationAngles[l]>Math.PI&&(this._rotationAngles[l]-=e.DOUBLE_PI),this._rotationAngles[l]<-Math.PI&&(this._rotationAngles[l]+=e.DOUBLE_PI)),this._rotationAngles[l]!==h&&(this._rotationChanged=!0,this._aimBlockCalculated=this._clear)}},Weapon.prototype.aimTowards=function(e,i,n,s,o){var r,a,l,c;if(!this._fixed){switch(r=this.getBasePointPosVector(s),a=t.diff3Aux(e,r),l=t.prodMat4Vec3Aux(this._sc.pMo.oM,a),l=t.prodMat4Vec3Aux(this._slot.orientationMatrix,l),this._tDistance=t.extractLength3(l),c=this._tDistance<=this.getRange(0),this._class._rotationStyle){case p.WeaponRotationStyle.YAW_PITCH:t.getYawAndPitch(z,l),this.rotateTo(-z.yaw,-z.pitch,i,n,o);break;case p.WeaponRotationStyle.ROLL_YAW:t.getRollAndYaw(z,l,!1),this.rotateTo(z.roll,z.yaw,i,n,o)}c||5!==this._lastAimStatus||(this._lastAimStatus=4)}},Weapon.prototype.rotateToDefaultPosition=function(e,t){var i;this._fixed||(i=this._class._rotators,this.rotateTo(i[0].defaultAngle,i[1].defaultAngle,e,0,t),this._lastAimStatus=B)},Weapon.prototype.getScoreValue=function(){return this._class.getScoreValue()},Weapon.prototype.getMaxProjectileCount=function(){return this._class.getMaxProjectileCount()},Weapon.prototype.getMaxExplosionCount=function(){return this._class.getMaxExplosionCount()},Weapon.prototype.getMaxParticleCount=function(){return this._class.getMaxParticleCount()},Weapon.prototype.destroy=function(){this._class=null,this._sc=null,this._slot=null,this._origoPositionMatrix=null,this._scaledOriMatrix=null,this._barrelMarkers&&this._barrelMarkers.markAsReusable(!0),this._barrelMarkers=null,this.vMo&&this.vMo.markAsReusable(!0),this.vMo=null},MissileLauncher.prototype.getDisplayName=function(){return this._class.getDisplayName()},MissileLauncher.prototype.getDamage=function(e){return this._class.getDamage(e)},MissileLauncher.prototype.getFirepower=function(e){return this._mCount*this._class.getDamage(e)},MissileLauncher.prototype.getNominalRange=function(){return this._class.getNominalRange()},MissileLauncher.prototype.getFireRate=function(){return this._class.getFireRate()},MissileLauncher.prototype.getLockingTime=function(){return this._class.getLockingTime()},MissileLauncher.prototype.getCooldown=function(){return this._class.getCooldown()},MissileLauncher.prototype.getLoadRatio=function(){return this._mCount>this._salvoLeft?this._salvo?1-(this._salvoLeft+this._cooldown/this._class.getCooldown())/this._descriptor.salvo:1-this._cooldown/this._class.getCooldown():0},MissileLauncher.prototype.setSalvoMode=function(e){this._salvo=e&&this._descriptor.salvo>1},MissileLauncher.prototype.toggleSalvoMode=function(){return this._descriptor.salvo>1&&(this._salvo=!this._salvo,!0)},MissileLauncher.prototype.getSalvo=function(){return this._descriptor.salvo},MissileLauncher.prototype.setMinimumCooldown=function(e){this._cooldown<e&&(this._cooldown=e)},MissileLauncher.prototype.getMissileOrientationMatrix=function(){return i.setProd3x3SubOf4(MissileLauncher._mOriMatrix,this._descriptor.orientationMatrix,this._sc.pMo.oM),MissileLauncher._mOriMatrix},MissileLauncher.prototype.acquireResources=function(e){this._class.acquireResources(e)},MissileLauncher.prototype.addMissileResourcesToScene=function(e){var t,i="missileLauncher/"+this._class._name;t=new Missile(this._class),t.addResourcesToScene(e,!1,void 0,void 0,!0),r.executeWhenReady(function(){e.addResourcesOfObject(null,i)})},MissileLauncher.prototype.addToSceneNow=function(e,n,s,o,r){var a,c,d,p,_,g,m,f=!1;for(c=this._class.getModel()._scale/e._renderableObject.sM[0],d=o.shaderName?u.getManagedShader(o.shaderName):this._class.getShader(),p=this._class.getTexturesOfTypes(d.getTextureTypes(),u.getTextureQualityPreferenceList()),this.vMos||(this.vMos=[],f=!0),_=0;_<this._descriptor.tubePositions.length;_++)for(m=o.allMissiles?Math.floor(this._mCount/this._descriptor.tubePositions.length)+(this._mCount%this._descriptor.tubePositions.length>_?1:0):1,g=0;g<m;g++)a=new l.ParameterizedMesh(this._class.getModel(),d,p,i.translation4v(t.sum3Aux(this._descriptor.tubePositions[_],[0,-g*c*this._class._length,0])),i.identity4(),i.scaling4(c),!0===s,n,void 0,X),e.addSubnode(new h.RenderableNode(a)),a.hasParameterArray(Y)&&a.setParameterArray(Y,u.getGroupTransformIdentityArray()),u.areLuminosityTexturesAvailable()&&a.hasParameterArray(W)&&a.setParameterArray(W,this._class._defaultLuminosityFactors),f&&this.vMos.push(a),r&&r(a)},MissileLauncher.prototype.simulate=function(e){if(this._cooldown=Math.max(this._cooldown-e,0),this._salvoLeft>0&&this._cooldown<=0&&(this._mCount>0&&this._salvoTarget&&this._salvoTarget._alive?this.launch(this._sc.getScaledOriMatrix(),this._sc.getSoundSourceForFireSound(),!0)&&this._sc.handleSalvoMissileLaunched():(this._salvoLeft=0,this._salvoTarget=null)),null!==this.vMos)for(;this.vMos.length>this._mCount;)this.vMos.shift().markAsReusable(!0)},MissileLauncher._tubePosMatrix=i.identity4(),MissileLauncher._mOriMatrix=i.identity4(),MissileLauncher.prototype.launch=function(e,n,s){var o,r,a,l,c=this._sc.vMo._node.getScene();return this._mCount>0&&this._cooldown<=0&&(s||this._salvoLeft<=0)?(s||(this._salvo&&this._sc.getTarget()?(this._salvoLeft=this._descriptor.salvo,this._salvoTarget=this._sc.getTarget()):this._salvoLeft=1),this._mCount--,this._salvoLeft--,this._cooldown=this._salvoLeft>0?this._class._salvoCooldown:this._class.getCooldown(),r=t.prodVec3Mat4Aux(this._descriptor.tubePositions[this._activeTubeIndex],e),i.setTranslatedByVector(MissileLauncher._tubePosMatrix,this._sc.pMo.pM,r),a=this.getMissileOrientationMatrix(),o=v.getObject(),o.init(this._class,MissileLauncher._tubePosMatrix,a,this._sc,this._class._launchVelocity,s?this._salvoTarget:this._sc.getTarget()),o.addToSceneNow(c,!1,void 0,void 0,!0),this._sc.pMo.applyForceAndTorque(r,t.getRowB43ScaledAux(a,-1),this._class.getLaunchForce(),1,1),n||(l=i.translationVector3(o.vMo.getPositionMatrixInCameraSpace(c._camera))),this._class.playLaunchSound(l,n,M,I),this._activeTubeIndex=(this._activeTubeIndex+1)%this._descriptor.tubePositions.length,o):null},MissileLauncher.prototype.isReady=function(){return this._cooldown<=0&&this._salvoLeft<=0},MissileLauncher.prototype.isInLockingRange=function(e){var i,n,s,o,r,a,l,c,h;if(o=this._sc.pMo.oM,l=t.sumVec3Mat4Aux(t.getRowB43ScaledAux(o,this._class._launchVelocity),this._sc.pMo._velocityMatrix),c=t.diffMat4Vec3Aux(e.pMo._velocityMatrix,l),i=.001*this._class._ignitionTime,s=t.sum3Aux(e.getPhysicalPositionVector(),t.scaled3Aux(c,i)),this._class._homingMode===p.MissileHomingMode.NONE)a=0;else{if(t.getYawAndPitch(z,t.normalize3(t.prodMat4Vec3Aux(o,t.diffVec3Mat4Aux(s,this._sc.pMo.pM)))),z.yaw=Math.abs(z.yaw),z.pitch=Math.abs(z.pitch),this._class._lockingAngle>0&&Math.max(z.yaw,z.pitch)>this._class._lockingAngle)return!1;r=Math.max(0,Math.max(z.yaw,z.pitch)-this._class._mainBurnAngleThreshold),h=this._class._angularAcceleration,a=(.2*h*.2+r)/(.2*h),a<.4&&(a=Math.sqrt(4*r/h)),t.add3(s,t.scaled3Aux(c,a))}return n=.001*this._class._duration-i-a,this._class.getTargetHitTime(this._sc.pMo.pM,s,c)<n},MissileLauncher.prototype.getScoreValue=function(){return this._class.getScoreValue()*this._mCount},MissileLauncher.prototype.getMissileCount=function(){return this._mCount},MissileLauncher.prototype.hasMissilesLeftToLaunch=function(){return this._mCount>this._salvoLeft},MissileLauncher.prototype.getMaxMissileCount=function(){return Math.min(this._mCount,this._class.getMaxCount())},MissileLauncher.prototype.getMaxExplosionCount=function(){return this.getMaxMissileCount()},MissileLauncher.prototype.getMaxParticleCount=function(){return this.getMaxMissileCount()*this._class.getParticleCount()},MissileLauncher.prototype.destroy=function(){var e;if(this._class=null,this._sc=null,this._descriptor=null,this._salvoTarget=null,null!==this.vMos){for(e=0;e<this.vMos.length;e++)this.vMos[e].markAsReusable(!0);this.vMos=null}},TargetingComputer.prototype.updateSensors=function(e){var t=e?e.getRange():0;this._rangeSquared=t*t*this._rangeFactor*this._rangeFactor},TargetingComputer.prototype.isInRange=function(e){return i.distanceSquared(this._sc.pMo.pM,e.pMo.pM)<=this._rangeSquared},TargetingComputer.prototype._resetMissileLock=function(){this._lockTime=this._t&&this._mL?this._t.getLockingTimeFactor()*this._lockingTimeFactor*this._mL.getLockingTime():1,this._lockTimeLeft=this._lockTime},TargetingComputer.prototype.isMissileLocked=function(){return this._lockTimeLeft<=0},TargetingComputer.prototype.getMissileLockRatio=function(){return 1-this._lockTimeLeft/this._lockTime},TargetingComputer.prototype.setMissileLauncher=function(e){this._mL&&e&&e._class===this._mL._class?this._mL=e:(this._mL=e,this._resetMissileLock())},TargetingComputer.prototype.setTarget=function(e){var t,i,n,s;if(e!==this._t){if(this._t&&this._t.setBeingUntargeted(this._sc),this._t=e,this._tHitPositionValid=!1,this._sc.vMo)for(n=this._sc.vMo._node,s=n.getScene()._camera,i=n.getCameraConfigurationsWithName("target"),t=0;t<i.length;t++)s.getConfiguration()===i[t]&&s.transitionToSameConfiguration(300,"smooth"),i[t].setOrientationFollowedObjects(this._t?[this._t.vMo]:[],!0);this._t&&this._t.setBeingTargeted(this._sc),this._resetMissileLock()}},TargetingComputer.prototype._filterHostileTarget=function(e){return this._sc.isHostile(e)&&i.distanceSquared(this._sc.pMo.pM,e.pMo.pM)<=this._rangeSquared},TargetingComputer.prototype._filterNonHostileTarget=function(e){return e!==this._sc&&!this._sc.isHostile(e)&&i.distanceSquared(this._sc.pMo.pM,e.pMo.pM)<=this._rangeSquared},TargetingComputer.prototype._mapTargetByBearing=function(e,i){return{index:i,value:t.angle3u(t.getRowB43Aux(this._sc.pMo.oM),t.normalize3(t.diffTranslation3Aux(e.pMo.pM,this._sc.pMo.pM)))}},TargetingComputer.prototype._mapTargetToCombinedValue=function(e,i){var n=t.diffTranslation3Aux(e.pMo.pM,this._sc.pMo.pM);return{index:i,value:(t.extractLength3(n)+200*t.angle3u(t.getRowB43Aux(this._sc.pMo.oM),n))*(this._sc.isGoodAgainst(e)?.5:this._sc.isBadAgainst(e)?2:1)}},TargetingComputer._compareMappedTargets=function(e,t){return e.value-t.value},TargetingComputer.prototype._updateHostileOrder=function(e){var t,i,n;if(this._scArray){if(t=this._scArray.filter(this._filterHostileTarget,this),this._timeUntilHostileOrderReset<=0){for(i=t.map(e,this).sort(TargetingComputer._compareMappedTargets),this._orderedHostileTargets=[],n=0;n<i.length;n++)this._orderedHostileTargets.push(t[i[n].index]);return!0}for(n=0;n<t.length;n++)this._orderedHostileTargets.indexOf(t[n])<0&&this._orderedHostileTargets.push(t[n])}return!1},TargetingComputer.prototype._updateNonHostileOrder=function(){var e,t,i;if(this._scArray){if(e=this._scArray.filter(this._filterNonHostileTarget,this),this._timeUntilNonHostileOrderReset<=0){for(t=e.map(this._mapTargetByBearing,this).sort(TargetingComputer._compareMappedTargets),this._orderedNonHostileTargets=[],i=0;i<t.length;i++)this._orderedNonHostileTargets.push(e[t[i].index]);return!0}for(i=0;i<e.length;i++)this._orderedNonHostileTargets.indexOf(e[i])<0&&this._orderedNonHostileTargets.push(e[i])}return!1},TargetingComputer.prototype._isValidNewTarget=function(e){return e._alive&&!e._away&&e!==this._t},TargetingComputer.prototype._tNextHostile=function(e){var t,i,n,s=this._updateHostileOrder(e);if(this._orderedHostileTargets&&this._orderedHostileTargets.length>0){for(n=this._orderedHostileTargets.length,t=s?0:(this._orderedHostileTargets.indexOf(this._t)+1)%n,i=0;i<n&&!this._isValidNewTarget(this._orderedHostileTargets[t]);)t=(t+1)%n,i++;if(i<n)return this.setTarget(this._orderedHostileTargets[t]),this._timeUntilHostileOrderReset=750,!0}return this._timeUntilHostileOrderReset=0,!1},TargetingComputer.prototype._tPreviousHostile=function(e){var t,i,n,s=this._updateHostileOrder(e);if(this._orderedHostileTargets&&this._orderedHostileTargets.length>0){for(n=this._orderedHostileTargets.length,t=s?n-1:(this._orderedHostileTargets.indexOf(this._t)+n-1)%n,i=0;i<n&&!this._isValidNewTarget(this._orderedHostileTargets[t]);)t=(t+n-1)%n,i++;if(i<n)return this.setTarget(this._orderedHostileTargets[t]),this._timeUntilHostileOrderReset=750,!0}return this._timeUntilHostileOrderReset=0,!1},TargetingComputer.prototype.targetNextNearestHostile=function(){return this._tNextHostile(this._mapTargetByBearing)},TargetingComputer.prototype.targetPreviousNearestHostile=function(){return this._tPreviousHostile(this._mapTargetByBearing)},TargetingComputer.prototype.targetNextBestHostile=function(){return this._tNextHostile(this._mapTargetToCombinedValue)},TargetingComputer.prototype.targetNextNearestNonHostile=function(){var e,t,i,n=this._updateNonHostileOrder();if(this._orderedNonHostileTargets&&this._orderedNonHostileTargets.length>0){for(i=this._orderedNonHostileTargets.length,e=n?0:(this._orderedNonHostileTargets.indexOf(this._t)+1)%i,t=0;t<i&&!this._isValidNewTarget(this._orderedNonHostileTargets[e]);)e=(e+1)%i,t++;if(t<i)return this.setTarget(this._orderedNonHostileTargets[e]),this._timeUntilNonHostileOrderReset=750,!0}return this._timeUntilNonHostileOrderReset=0,!1},TargetingComputer.prototype.getTarget=function(){return!this._t||this._t._alive&&!this._t._away||this.setTarget(null),this._t},TargetingComputer.prototype.getTargetHitPosition=function(){var i,n,s,o,r,a,l,c,h;if(!this._tHitPositionValid){if(this._tHitPositionValid=!0,n=this._t.pMo.pM,o=this._sc._ws,0===o.length)return this._tHitPosition[0]=n[12],this._tHitPosition[1]=n[13],this._tHitPosition[2]=n[14],n;i=this._sc.pMo.pM,s=t.diffTranslation3Aux(this._t.pMo._velocityMatrix,this._sc.pMo._velocityMatrix),r=o[0].getProjectileVelocity(),a=r*r-(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),l=2*(s[0]*(i[12]-n[12])+s[1]*(i[13]-n[13])+s[2]*(i[14]-n[14])),c=-n[12]*n[12]-i[12]*i[12]+2*n[12]*i[12]-n[13]*n[13]-i[13]*i[13]+2*n[13]*i[13]-n[14]*n[14]-i[14]*i[14]+2*n[14]*i[14],h=e.getGreaterSolutionOfQuadraticEquation(a,l,c),this._tHitPosition[0]=n[12]+h*s[0],this._tHitPosition[1]=n[13]+h*s[1],this._tHitPosition[2]=n[14]+h*s[2]}return this._tHitPosition},TargetingComputer.prototype.simulate=function(e){0!==this._rangeSquared&&(!this._t||this._t._alive&&!this._t._away&&this.isInRange(this._t)||this.setTarget(null),this._tHitPositionValid=!1,this._timeUntilHostileOrderReset>0&&(this._timeUntilHostileOrderReset-=e),this._timeUntilNonHostileOrderReset>0&&(this._timeUntilNonHostileOrderReset-=e),this._t&&this._mL&&this._mL.hasMissilesLeftToLaunch()&&this._mL.isInLockingRange(this._t)?this._lockTimeLeft=Math.max(0,this._lockTimeLeft-e):this._resetMissileLock())},TargetingComputer.prototype.destroy=function(){this._sc=null,this._scArray=null,this._t=null,this._tHitPosition=null,this._orderedHostileTargets=null,this._orderedNonHostileTargets=null,this._mL=null},Thruster.PROPULSION_RESOURCE_PARAMS={sound:!0},Thruster.prototype.addToScene=function(e,t){var n;this._propulsionClass.acquireResources(Thruster.PROPULSION_RESOURCE_PARAMS),r.executeWhenReady(function(){n=l.staticParticle(this._propulsionClass._thrusterBurnParticle.getModel(),this._propulsionClass._thrusterBurnParticle.getShader(),this._propulsionClass._thrusterBurnParticle.getTexturesOfTypes(this._propulsionClass._thrusterBurnParticle.getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),this._propulsionClass._thrusterBurnParticle._color,this._slot.size,i.translation4v(this._slot.positionVector),this._propulsionClass._thrusterBurnParticle.getInstancedShader()),n.setRelativeSize(0),e.addSubnode(new h.RenderableNode(n,!1,!1,!0)),this.vMo&&!t||(this.vMo&&this.vMo.markAsReusable(!0),this.vMo=n,this._shipModel=e._renderableObject)}.bind(this))},Thruster.prototype.updateVisuals=function(){this.vMo.setRelativeSize(this._burnLevel),u.areLuminosityTexturesAvailable()&&this._shipModel.setFloatParameter(W,this._slot.group,Math.min(1,this._burnLevel/this._maxMoveBurnLevel))},Thruster.prototype.resetBurn=function(){this._burnLevel=0},Thruster.prototype.addBurn=function(e){this._burnLevel+=e},Thruster.prototype.destroy=function(){this._propulsionClass=null,this._slot=null,this.vMo&&this.vMo.markAsReusable(!0),this.vMo=null,this._shipModel=null},Propulsion.prototype.acquireResources=function(e){this._class.acquireResources(e)},Propulsion.prototype.getDisplayName=function(){return this._class.getDisplayName()},Propulsion.prototype.getThrust=function(){return this._class.getThrust()},Propulsion.prototype.getAngularThrust=function(){return this._class.getAngularThrust()},Propulsion.prototype.getMaxMoveBurnLevel=function(){return this._class.getMaxMoveBurnLevel()},Propulsion.prototype.getMaxTurnBurnLevel=function(){return this._class.getMaxTurnBurnLevel()},Propulsion.prototype.getThrusterUse=function(e){switch(e){case w.FORWARD:return this._forward;case w.REVERSE:return this._reverse;case w.STRAFE_LEFT:return this._strafeLeft;case w.STRAFE_RIGHT:return this._strafeRight;case w.RAISE:return this._raise;case w.LOWER:return this._lower;case w.YAW_LEFT:return this._yawLeft;case w.YAW_RIGHT:return this._yawRight;case w.PITCH_UP:return this._pitchUp;case w.PITCH_DOWN:return this._pitchDown;case w.ROLL_LEFT:return this._rollLeft;case w.ROLL_RIGHT:return this._rollRight;default:return n.showError("Invalid thruster use specified: '"+e+"'!",n.ErrorSeverity.SEVERE),null}},Propulsion.prototype.addThrusters=function(e){var t,i,n,s;for(t=0;t<e.length;t++)for(n=new Thruster(this._class,e[t]),this._thrusters.push(n),i=0;i<e[t].uses.length;i++)(s=this.getThrusterUse(e[t].uses[i]))&&s.thrusters.push(n)},Propulsion.prototype.addToScene=function(e){var t;for(t=0;t<this._thrusters.length;t++)this._thrusters[t].addToScene(e,!1)},Propulsion.prototype.addThrusterBurn=function(e,t){_addThrusterBurn(this.getThrusterUse(e),t)},Propulsion.prototype.addThrusterBurnForward=function(e){_addThrusterBurn(this._forward,e)},Propulsion.prototype.addThrusterBurnReverse=function(e){_addThrusterBurn(this._reverse,e)},Propulsion.prototype.addThrusterBurnLeft=function(e){_addThrusterBurn(this._strafeLeft,e)},Propulsion.prototype.addThrusterBurnRight=function(e){_addThrusterBurn(this._strafeRight,e)},Propulsion.prototype.addThrusterBurnUp=function(e){_addThrusterBurn(this._raise,e)},Propulsion.prototype.addThrusterBurnDown=function(e){_addThrusterBurn(this._lower,e)},Propulsion.prototype.addThrusterBurnYawLeft=function(e){_addThrusterBurn(this._yawLeft,e)},Propulsion.prototype.addThrusterBurnYawRight=function(e){_addThrusterBurn(this._yawRight,e)},Propulsion.prototype.addThrusterBurnPitchUp=function(e){_addThrusterBurn(this._pitchUp,e)},Propulsion.prototype.addThrusterBurnPitchDown=function(e){_addThrusterBurn(this._pitchDown,e)},Propulsion.prototype.addThrusterBurnRollLeft=function(e){_addThrusterBurn(this._rollLeft,e)},Propulsion.prototype.addThrusterBurnRollRight=function(e){_addThrusterBurn(this._rollRight,e)},Propulsion.prototype.resetThrusterBurn=function(){var e;for(this._forward.burn=0,this._reverse.burn=0,this._strafeLeft.burn=0,this._strafeRight.burn=0,this._raise.burn=0,this._lower.burn=0,this._yawLeft.burn=0,this._yawRight.burn=0,this._pitchUp.burn=0,this._pitchDown.burn=0,this._rollLeft.burn=0,this._rollRight.burn=0,e=0;e<this._thrusters.length;e++)this._thrusters[e].resetBurn()},Propulsion.prototype.updateVisuals=function(){var e;for(e=0;e<this._thrusters.length;e++)this._thrusters[e].updateVisuals()},Propulsion.prototype._getSoundVolume=function(){var e,t,i;return i=this._class.getMaxMoveBurnLevel(),e=i?Math.max(this._forward.burn,this._reverse.burn,this._strafeRight.burn,this._strafeLeft.burn,this._raise.burn,this._lower.burn)/i:0,i=this._class.getMaxTurnBurnLevel(),t=i?Math.max(this._yawRight.burn,this._yawLeft.burn,this._pitchUp.burn,this._pitchDown.burn,this._rollRight.burn,this._rollLeft.burn)/i:0,i=Math.round(3*(e+t))/3},Propulsion.prototype.simulate=function(e,i,n){var s,o,r;!1!==n&&(s=t.getRowB43Aux(this._drivenPhysicalObject.oM),o=t.getRowC43Aux(this._drivenPhysicalObject.oM),r=t.getRowA43Aux(this._drivenPhysicalObject.oM),this._forward.burn>0?this._drivenPhysicalObject.applyForce(this._thrustFactor*this._forward.burn,s[0],s[1],s[2],e):this._reverse.burn>0&&this._drivenPhysicalObject.applyForce(-this._thrustFactor*this._reverse.burn,s[0],s[1],s[2],e),this._strafeRight.burn>0?this._drivenPhysicalObject.applyForce(this._thrustFactor*this._strafeRight.burn,r[0],r[1],r[2],e):this._strafeLeft.burn>0&&this._drivenPhysicalObject.applyForce(-this._thrustFactor*this._strafeLeft.burn,r[0],r[1],r[2],e),this._raise.burn>0?this._drivenPhysicalObject.applyForce(this._thrustFactor*this._raise.burn,o[0],o[1],o[2],e):this._lower.burn>0&&this._drivenPhysicalObject.applyForce(-this._thrustFactor*this._lower.burn,o[0],o[1],o[2],e),this._yawRight.burn>0?this._drivenPhysicalObject.applyTorque(this._angularThrustFactor*this._yawRight.burn,o,e):this._yawLeft.burn>0&&this._drivenPhysicalObject.applyTorque(-this._angularThrustFactor*this._yawLeft.burn,o,e),this._pitchUp.burn>0?this._drivenPhysicalObject.applyTorque(-this._angularThrustFactor*this._pitchUp.burn,r,e):this._pitchDown.burn>0&&this._drivenPhysicalObject.applyTorque(this._angularThrustFactor*this._pitchDown.burn,r,e),this._rollRight.burn>0?this._drivenPhysicalObject.applyTorque(-this._angularThrustFactor*this._rollRight.burn,s,e):this._rollLeft.burn>0&&this._drivenPhysicalObject.applyTorque(this._angularThrustFactor*this._rollLeft.burn,s,e)),this._thrusterSoundClip||(this._thrusterSoundClip=this._class.createThrusterSoundClip(i),this._thrusterSoundClip&&(this._thrusterSoundClip.setVolume(0),this._thrusterSoundClip.play())),this._thrusterSoundClip&&this._thrusterSoundClip.rampVolume(this._getSoundVolume()*this._class.getThrusterSoundVolume(),.02,!0,!0)},Propulsion.prototype.getScoreValue=function(){return this._class.getScoreValue()},Propulsion.prototype.destroy=function(){this._class=null,this._drivenPhysicalObject=null,this._thrusters=null,this._forward=null,this._reverse=null,this._strafeLeft=null,this._strafeRight=null,this._raise=null,this._lower=null,this._yawLeft=null,this._yawRight=null,this._pitchUp=null,this._pitchDown=null,this._rollLeft=null,this._rollRight=null,this._thrusterSoundClip&&(this._thrusterSoundClip.stopPlaying(d.SOUND_RAMP_DURATION),setTimeout(function(){this._thrusterSoundClip.destroy(),this._thrusterSoundClip=null}.bind(this),d.SOUND_RAMP_DURATION))},ManeuveringComputer.prototype.prepareForControl=function(){this._speedThrottled=!1},ManeuveringComputer.prototype.updateSpeedIncrementPerSecond=function(){this._speedIncrementPerSecond=this._sc.getMaxAcceleration()||0},ManeuveringComputer.prototype.updateSpeedIncrement=function(e){this._speedIncrement=e*this._speedIncrementPerSecond/1e3},ManeuveringComputer.prototype.updateTurningLimit=function(){this._turningLimit=.2*this._sc.getMaxAngularAcceleration()*o.ANGULAR_VELOCITY_MATRIX_DURATION_S},ManeuveringComputer.prototype.updateForNewPropulsion=function(){var e=this._sc.getMaxAcceleration();this.updateSpeedIncrementPerSecond(),this._maxCombatForwardSpeed=S*e,this._maxCombatReverseSpeed=T*-e,this._maxCruiseForwardSpeed=y*e,this._maxCruiseReverseSpeed=E*-e,this.updateTurningLimit(),this._maxMoveBurnLevel=this._sc.getMaxThrusterMoveBurnLevel(),this._maxTurnBurnLevel=this._sc.getMaxThrusterTurnBurnLevel()},ManeuveringComputer.prototype.getRestrictedTurningLimit=function(e){return Math.min(this._turningLimit,this._sc.getMaxTurnRateAtSpeed(void 0===e?this._sc.getRelativeVelocityMatrix()[13]:e)*o.ANGULAR_VELOCITY_MATRIX_DURATION_S)},ManeuveringComputer.prototype.setLocked=function(e){this._locked=e,this._locked&&(this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0)},ManeuveringComputer.prototype.getFlightMode=function(){return this._assisted?this._restricted?P.CRUISE:P.COMBAT:P.FREE},ManeuveringComputer.prototype.changeFlightMode=function(e){if(this._locked)return!1;switch(e||(e=this._assisted?this._restricted?P.FREE:P.CRUISE:P.COMBAT),e){case P.COMBAT:this._speedTarget=Math.min(Math.max(this._maxCombatReverseSpeed,this._assisted?this._speedTarget:this._sc.getRelativeVelocityMatrix()[13]),this._maxCombatForwardSpeed),this._assisted=!0,this._restricted=!1;break;case P.CRUISE:this._speedTarget=Math.min(Math.max(this._maxCruiseReverseSpeed,this._assisted?this._speedTarget:this._sc.getRelativeVelocityMatrix()[13]),this._maxCruiseForwardSpeed),this._assisted=!0,this._restricted=!0;break;case P.FREE:this._assisted=!1,this._restricted=!1;break;default:return n.showError("Cannot switch to unknown flight mode: '"+e+"'!"),!1}return!0},ManeuveringComputer.prototype.toggleFlightAssist=function(){return this.changeFlightMode(this._assisted?P.FREE:P.COMBAT)},ManeuveringComputer.prototype.toggleCruise=function(){return this.changeFlightMode(this._restricted?P.COMBAT:P.CRUISE)},ManeuveringComputer.prototype.forward=function(e){var t;this._locked||(this._assisted?(t=this._restricted?this._maxCruiseForwardSpeed:this._maxCombatForwardSpeed,this._speedThrottled=void 0!==e,this._speedTarget=this._holdSpeed&&!this._speedThrottled?Math.min(Math.max(this._sc.getRelativeVelocityMatrix()[13],this._speedTarget)+this._speedIncrement,t):(e||1)*t):this._speedTarget=Number.MAX_VALUE)},ManeuveringComputer.prototype.stopForward=function(){var e;this._locked||(this._assisted?this._holdSpeed||this._speedTarget>0&&(this._speedTarget=0):(e=this._sc.getRelativeVelocityMatrix()[13],this._speedTarget>e&&(this._speedTarget=e)))},ManeuveringComputer.prototype.reverse=function(e){var t;this._locked||(this._assisted?(t=this._restricted?this._maxCruiseReverseSpeed:this._maxCombatReverseSpeed,this._speedThrottled=void 0!==e,this._speedTarget=this._holdSpeed&&!this._speedThrottled?Math.max(Math.min(this._sc.getRelativeVelocityMatrix()[13],this._speedTarget)-this._speedIncrement,t):(e||1)*t):this._speedTarget=-Number.MAX_VALUE)},ManeuveringComputer.prototype.stopReverse=function(){var e;this._locked||(this._assisted?this._holdSpeed||this._speedTarget<0&&(this._speedTarget=0):(e=this._sc.getRelativeVelocityMatrix()[13],this._speedTarget<e&&(this._speedTarget=e)))},ManeuveringComputer.prototype.strafeLeft=function(e){this._locked||(this._strafeTarget=this._restricted?0:this._assisted&&e?-e:-Number.MAX_VALUE)},ManeuveringComputer.prototype.stopLeftStrafe=function(){this._strafeTarget<0&&(this._strafeTarget=0)},ManeuveringComputer.prototype.strafeRight=function(e){this._locked||(this._strafeTarget=this._restricted?0:this._assisted&&e||Number.MAX_VALUE)},ManeuveringComputer.prototype.stopRightStrafe=function(){this._strafeTarget>0&&(this._strafeTarget=0)},ManeuveringComputer.prototype.lower=function(e){this._locked||(this._liftTarget=this._restricted?0:this._assisted&&e?-e:-Number.MAX_VALUE)},ManeuveringComputer.prototype.stopLower=function(){this._liftTarget<0&&(this._liftTarget=0)},ManeuveringComputer.prototype.raise=function(e){this._locked||(this._liftTarget=this._restricted?0:this._assisted&&e||Number.MAX_VALUE)},ManeuveringComputer.prototype.stopRaise=function(){this._liftTarget>0&&(this._liftTarget=0)},ManeuveringComputer.prototype.toggleSpeedHolding=function(){return!(this._locked||!this._assisted)&&(this._holdSpeed=!this._holdSpeed,this._holdSpeed&&(this._speedTarget=this._sc.getRelativeVelocityMatrix()[13],this._restricted?this._speedTarget=Math.min(Math.max(this._maxCruiseReverseSpeed,this._speedTarget),this._maxCruiseForwardSpeed):this._speedTarget=Math.min(Math.max(this._maxCombatReverseSpeed,this._speedTarget),this._maxCombatForwardSpeed)),!0)},ManeuveringComputer.prototype.setSpeedHolding=function(e){this._holdSpeed=e},ManeuveringComputer.prototype.resetSpeed=function(){this._locked||this._assisted&&this._holdSpeed&&(this._speedTarget=0)},ManeuveringComputer.prototype.setSpeedTarget=function(e){this._locked||this._assisted&&(this._speedTarget=e)},ManeuveringComputer.prototype.getSpeedTarget=function(){return this._speedTarget},ManeuveringComputer.prototype.hasSpeedTarget=function(){return this._assisted&&(this._holdSpeed||this._speedThrottled)},ManeuveringComputer.prototype.getMaxSpeed=function(){return this._assisted?this._restricted?this._maxCruiseForwardSpeed:this._maxCombatForwardSpeed:void 0},ManeuveringComputer.prototype.yawLeft=function(e){this._locked||(void 0===e?this._yawTarget=-this._turningLimit:e>0?this._yawTarget=-e*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._yawTarget<0&&(this._yawTarget=0))},ManeuveringComputer.prototype.yawRight=function(e){this._locked||(void 0===e?this._yawTarget=this._turningLimit:e>0?this._yawTarget=e*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._yawTarget>0&&(this._yawTarget=0))},ManeuveringComputer.prototype.pitchDown=function(e){this._locked||(void 0===e?this._pitchTarget=-this._turningLimit:e>0?this._pitchTarget=-e*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._pitchTarget<0&&(this._pitchTarget=0))},ManeuveringComputer.prototype.pitchUp=function(e){this._locked||(void 0===e?this._pitchTarget=this._turningLimit:e>0?this._pitchTarget=e*(this._restricted?this.getRestrictedTurningLimit():this._turningLimit):this._pitchTarget>0&&(this._pitchTarget=0))},ManeuveringComputer.prototype.rollLeft=function(e){this._locked||(void 0===e?this._rollTarget=-this._turningLimit:e>0?this._rollTarget=-e*this._turningLimit:this._rollTarget<0&&(this._rollTarget=0))},ManeuveringComputer.prototype.rollRight=function(e){this._locked||(void 0===e?this._rollTarget=this._turningLimit:e>0?this._rollTarget=e*this._turningLimit:this._rollTarget>0&&(this._rollTarget=0))},ManeuveringComputer.prototype.controlThrusters=function(e,i){var n,s,r,a,l=this._sc.getRelativeVelocityMatrix(),c=l[13],h=o.VELOCITY_MATRIX_ERROR_THRESHOLD,u=this._sc.getTurningMatrix(),d=o.ANGULAR_VELOCITY_MATRIX_ERROR_THRESHOLD,p=this._yawTarget,_=this._pitchTarget,g=this._sc._propulsion;g.resetThrusterBurn(),this._restricted&&0!==c&&(n=this.getRestrictedTurningLimit(c),p=Math.min(Math.max(p,-n),n),_=Math.min(Math.max(_,-n),n)),s=Math.sign(u[4])*t.angle2y(u[4],u[5]),
p-s>d?g.addThrusterBurnYawRight(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(p-s,e))):p-s<-d&&g.addThrusterBurnYawLeft(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(s-p,e))),r=Math.sign(u[6])*t.angle2x(u[5],u[6]),_-r>d?g.addThrusterBurnPitchUp(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(_-r,e))):_-r<-d&&g.addThrusterBurnPitchDown(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(r-_,e))),a=Math.sign(-u[2])*t.angle2x(u[0],u[2]),this._rollTarget-a>d?g.addThrusterBurnRollRight(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(this._rollTarget-a,e))):this._rollTarget-a<-d&&g.addThrusterBurnRollLeft(Math.min(this._maxTurnBurnLevel,this._sc.getNeededBurnForAngularVelocityChange(a-this._rollTarget,e))),this._speedTarget-c>h?g.addThrusterBurnForward(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(this._speedTarget-c,e))):this._speedTarget-c<-h&&g.addThrusterBurnReverse(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(c-this._speedTarget,e))),(this._assisted||0!==this._strafeTarget)&&(c=l[12],this._strafeTarget-c>h?g.addThrusterBurnRight(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(this._strafeTarget-c,e))):this._strafeTarget-c<-h&&g.addThrusterBurnLeft(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(c-this._strafeTarget,e)))),(this._assisted||0!==this._liftTarget)&&(c=l[14],this._liftTarget-c>h?g.addThrusterBurnUp(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(this._liftTarget-c,e))):this._liftTarget-c<-h&&g.addThrusterBurnDown(Math.min(this._maxMoveBurnLevel,this._sc.getNeededBurnForSpeedChange(c-this._liftTarget,e)))),g.updateVisuals(),this._lastYawTarget=this._yawTarget,this._lastPitchTarget=this._pitchTarget,this._lastRollTarget=this._rollTarget,this._lastStrafeTarget=this._strafeTarget,this._lastLiftTarget=this._liftTarget,i||(this._yawTarget=0,this._pitchTarget=0,this._rollTarget=0,this._strafeTarget=0,this._liftTarget=0)},ManeuveringComputer.prototype.destroy=function(){this._sc=null},JumpEngine.VELOCITY_TOLERANCE=1,JumpEngine.JumpState={NONE:0,ALIGNING_VELOCITY:1,PREPARING:2,JUMPING_OUT:3,JUMPING_IN:4},Object.freeze(JumpEngine.JumpOutState),JumpEngine.prototype.acquireResources=function(e){this._class.acquireResources(e)},JumpEngine.prototype.jumpOut=function(e){var t;switch(this._state){case JumpEngine.JumpState.NONE:this._state=JumpEngine.JumpState.ALIGNING_VELOCITY,this._originalFlightMode=this._sc.getFlightMode(),this._sc.changeFlightMode(P.CRUISE),this._sc.setSpeedTarget(this._class._prepareVelocity),this._sc.lockManeuvering(),this._sc.setJumping(!0),this._sc.handleEvent(_.JUMP_ENGAGED)&&(this._soundClip=this._class.createEngageSoundClip(),this._soundClip&&this._soundClip.play());break;case JumpEngine.JumpState.ALIGNING_VELOCITY:case JumpEngine.JumpState.PREPARING:e&&(t=this._state===JumpEngine.JumpState.PREPARING,this._state=JumpEngine.JumpState.NONE,this._sc.unlockManeuvering(),this._sc.changeFlightMode(this._originalFlightMode),this._sc.setJumping(!1),this._soundClip&&(this._soundClip.stopPlaying(d.SOUND_RAMP_DURATION),this._soundClip=null),this._sc.handleEvent(_.JUMP_CANCELLED)&&(this._soundClip=this._class.createDisengageSoundClip(),this._soundClip&&this._soundClip.play()),t&&(this._soundClip=this._class.createCancelSoundClip(),this._soundClip&&this._soundClip.play()))}},JumpEngine.prototype.jumpIn=function(){var e,n,s;this._state===JumpEngine.JumpState.NONE&&(this._state=JumpEngine.JumpState.JUMPING_IN,this._timeLeft=this._class._jumpInDuration,this._sc.unlockManeuvering(),this._sc.setSpeedTarget(0),this._sc.lockManeuvering(),this._sc.setJumping(!0),e=f.getExplosion(),e.init(this._class._jumpInExplosionClass,this._sc.pMo.pM,this._sc.pMo.oM,t.getRowC43Aux(this._sc.pMo.pM),!0,!0,i.IDENTITY4),e.addToSceneNow(this._sc.vMo._node.getScene()._rootNode,this._sc._soundSource),this._originalScalingMatrix=i.copy(this._sc.vMo.sM),n=this._sc.pMo,n.setVelocityv(t.getRowB43ScaledAux(n.oM,this._class._jumpInVelocity+this._class._jumpInDeceleration*this._class._jumpInDuration*.001)),n._dragFactor=0,this._sc.vMo.setPositionM4(n.pM),s=this._sc.getPositionMatrixInCameraSpace(),this._sc._soundSource.setPositionImmediate(.1*Math.round(10*s[12]),.1*Math.round(10*s[13]),.1*Math.round(10*s[14])),this._soundClip=this._class.createJumpInSoundClip(this._sc._soundSource),this._soundClip&&this._soundClip.play(),this._sc.setAway(!1),this._sc.handleEvent(_.JUMPED_IN))},JumpEngine.prototype.simulate=function(e){var n,s,o,r;switch(this._state){case JumpEngine.JumpState.ALIGNING_VELOCITY:n=this._sc.getRelativeVelocityMatrix(),r=this._sc.getTopSpeed()?Math.min(this._sc.getTopSpeed(),this._class._prepareVelocity):this._class._prepareVelocity,Math.abs(n[12])<JumpEngine.VELOCITY_TOLERANCE&&Math.abs(n[14])<JumpEngine.VELOCITY_TOLERANCE&&Math.abs(n[13]-r)<JumpEngine.VELOCITY_TOLERANCE&&(this._state=JumpEngine.JumpState.PREPARING,this._timeLeft=this._class._prepareDuration,this._soundClip=this._class.createPrepareSoundClip(this._sc._soundSource),this._soundClip&&this._soundClip.play());break;case JumpEngine.JumpState.PREPARING:this._sc.handleEvent(_.PREPARING_JUMP,{duration:this._class._prepareDuration,timeLeft:this._timeLeft}),this._timeLeft<=0&&(this._state=JumpEngine.JumpState.JUMPING_OUT,this._timeLeft=this._class._jumpOutDuration,this._soundClip=this._class.createJumpOutSoundClip(this._sc._soundSource),this._soundClip&&this._soundClip.play(),this._sc.pMo._dragFactor=0,this._sc.unlockManeuvering(),this._sc.setSpeedTarget(Number.MAX_VALUE),this._sc.lockManeuvering(),this._originalScalingMatrix=i.copy(this._sc.vMo.sM),this._sc.handleEvent(_.JUMP_OUT_STARTED)),this._timeLeft-=e;break;case JumpEngine.JumpState.JUMPING_OUT:this._sc.vMo.setScaling(this._originalScalingMatrix[0],this._originalScalingMatrix[5]*(1+(1-this._timeLeft/this._class._jumpOutDuration)*(this._class._jumpOutScaling-1)),this._originalScalingMatrix[10]),this._timeLeft<=0?(this._state=JumpEngine.JumpState.NONE,s=f.getExplosion(),s.init(this._class._jumpOutExplosionClass,this._sc.pMo.pM,this._sc.pMo.oM,t.getRowC43Aux(this._sc.pMo.pM),!0,!0,i.IDENTITY4),s.addToSceneNow(this._sc.vMo._node.getScene()._rootNode,this._sc._soundSource),this._sc.vMo.setScale(this._originalScalingMatrix[0]),this._sc.setAway(!0),this._sc.handleEvent(_.JUMPED_OUT)):(o=this._sc.pMo,n=o.oM,o.applyForce(o._mass*this._class._jumpOutAcceleration,n[4],n[5],n[6],Math.min(e,this._timeLeft))),this._timeLeft-=e;break;case JumpEngine.JumpState.JUMPING_IN:this._timeLeft<0?this._timeLeft=0:(o=this._sc.pMo,n=o.oM,o.applyForce(o._mass*this._class._jumpInDeceleration,-n[4],-n[5],-n[6],Math.min(e,this._timeLeft))),this._sc.vMo.setScaling(this._originalScalingMatrix[0],this._originalScalingMatrix[5]*(1+this._timeLeft/this._class._jumpInDuration*(this._class._jumpInScaling-1)),this._originalScalingMatrix[10]),this._timeLeft<=0&&(this._state=JumpEngine.JumpState.NONE,this._sc.unlockManeuvering(),this._sc.setJumping(!1),this._sc.handleEvent(_.ARRIVED),this._sc.resetDrag()),this._timeLeft-=e}},JumpEngine.prototype.destroy=function(){this._class=null,this._sc=null,this._soundClip&&(this._soundClip.destroy(),this._soundClip=null),this._originalScalingMatrix=null},Shield.prototype.acquireResources=function(e){this._class.acquireResources(e)},Shield.prototype.getDisplayName=function(){return this._class.getDisplayName()},Shield.prototype.getIntegrity=function(){return this._capacity/this._class._capacity},Shield.prototype.setIntegrity=function(e){var t=e*this._class._capacity;t<this._capacity&&(this._timeSinceHit=0),this._capacity=t},Shield.prototype.getRechargeRate=function(){return this._class.getRechargeRate()},Shield.prototype.damage=function(e,t){var i=Math.min(this._capacity,e);return this._timeSinceHit=0,t||(this._capacity-=i),e-i},Shield.prototype.startRecharge=function(){this._soundClip=this._class.createRechargeStartSoundClip(this._sc._soundSource),this._soundClip&&this._soundClip.play(),this._timeSinceRecharge=0},Shield.prototype.simulate=function(e,t){var i=this._class._rechargeAnimationDuration;this._capacity<this._class._capacity&&(this._timeSinceHit<this._class.getRechargeDelay()?(this._timeSinceHit+=e,this._timeSinceHit>=this._class.getRechargeDelay()&&this.startRecharge()):t||(this._capacity=Math.min(this._class._capacity,this._capacity+this._class.getRechargeRate()*e*.001))),this._timeSinceRecharge=Math.min(i,this._timeSinceRecharge+e),this._state[3]=this._timeSinceRecharge/i},Shield.prototype.getScoreValue=function(){return this._class.getScoreValue()},Shield.prototype.destroy=function(){this._class=null,this._sc=null,this._soundClip&&(this._soundClip.destroy(),this._soundClip=null)},A=a.getPool(m.PARTICLE_POOL_NAME,l.Particle),x=a.getPool(m.PROJECTILE_POOL_NAME,Projectile),v=a.getPool(m.MISSILE_POOL_NAME,Missile),O=a.getPool(m.TRAIL_POOL_NAME,l.Trail),R=a.getPool(m.TRAIL_SEGMENT_POOL_NAME,l.TrailSegment),g.executeWhenReady(function(){H=!0,S=2,T=1,y=4,E=2,C=!1,W="luminosityFactors",Y=g.getSetting(g.GENERAL_SETTINGS.UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME),M=.05,I=.5,u.executeWhenReady(handleGraphicsSettingsChanged),u.onSettingsChange(handleGraphicsSettingsChanged)}),{FlightMode:P,ThrusterUse:w,handleDifficultySet:handleDifficultySet,setFriendlyFire:setFriendlyFire,Projectile:Projectile,Missile:Missile,Weapon:Weapon,MissileLauncher:MissileLauncher,TargetingComputer:TargetingComputer,Propulsion:Propulsion,JumpEngine:JumpEngine,Shield:Shield,ManeuveringComputer:ManeuveringComputer}}),define("armada/control",["utils/utils","utils/types","modules/application","modules/control/control","modules/control/keyboard","modules/control/mouse","modules/control/gamepad","modules/control/touch","modules/camera-controller","modules/game","modules/media-resources","armada/screens/shared","armada/strings","armada/configuration","armada/logic/equipment"],function(e,t,i,n,s,o,r,a,l,c,h,u,d,p,_){"use strict";function GeneralController(e){n.Controller.call(this,e),this._mission=null,this._battle=null,this.setActionFunction("quit",!0,function(){this._battle.pauseBattle(),c.setScreen(u.INGAME_MENU_SCREEN_NAME,!0,u.SUPERIMPOSE_BACKGROUND_COLOR),n.exitPointerLock()}.bind(this)),this.setActionFunction("pause",!0,function(){c.getScreen().showMessage(d.get(d.BATTLE.MESSAGE_PAUSED))}),this.setActionFunction("toggleDevInfoVisibility",!0,function(){c.getScreen().toggleDevInfoVisibility()}),this.setActionFunction("toggleHUDVisibility",!0,function(){this._battle.toggleHUDVisibility()}.bind(this)),this.setActionFunction("toggleMouseControls",!0,function(){C.getInputInterpreter(A).toggleEnabled(),C.isInPilotMode()&&(C.getInputInterpreter(A).isEnabled()?(document.body.style.cursor="none",C.enableMouseTurning()):(document.body.style.cursor=c.getDefaultCursor(),n.exitPointerLock()))}),this.setActionFunction("toggleJoystickControls",!0,function(){C.getInputInterpreter(x).toggleEnabled()})}function FighterController(e){n.Controller.call(this,e),this._controlledSpacecraft=null,this._strafeSpeed=0,this._autoTargeting=!0,this._wAimThreshold=e.weaponAimThreshold,this.setActionFunction("fire",!0,function(e,t){this._controlledSpacecraft.requestFire(!1,e),t===M&&C.enableMouseTurning()}.bind(this)),this.setActionFunction("launchMissile",!0,function(e,t){this._controlledSpacecraft.launchMissile(e)||y&&y.play(),t===M&&C.enableMouseTurning()}.bind(this)),this.setActionFunction("changeMissile",!0,function(e){this._controlledSpacecraft.changeMissile(e)?T&&T.play():y&&y.play()}.bind(this)),this.setActionFunction("toggleSalvo",!0,function(e){this._controlledSpacecraft.toggleSalvo(e)?E&&E.play():y&&y.play()}.bind(this)),this.setActionFunction("changeFlightMode",!0,function(){this._controlledSpacecraft.changeFlightMode()&&S&&S.play()}.bind(this)),this.setActionFunction("toggleCruise",!0,function(){this._controlledSpacecraft.toggleCruise()&&S&&S.play()}.bind(this)),this.setActionFunction("toggleFlightAssist",!0,function(){this._controlledSpacecraft.toggleFlightAssist()&&S&&S.play()}.bind(this)),this.setActionFunction("nextNearestHostileTarget",!0,function(){this._controlledSpacecraft.targetNextNearestHostile()?m.play():f.play()}.bind(this)),this.setActionFunction("previousNearestHostileTarget",!0,function(){this._controlledSpacecraft.targetPreviousNearestHostile()?m.play():f.play()}.bind(this)),this.setActionFunction("nextNearestNonHostileTarget",!0,function(){this._controlledSpacecraft.targetNextNearestNonHostile()?m.play():f.play()}.bind(this)),this.setActionFunction("toggleAutoTargeting",!0,function(){this._autoTargeting=!this._autoTargeting}.bind(this)),this.setActionFunctions("forward",function(e){this._controlledSpacecraft.forward(e)}.bind(this),function(){this._controlledSpacecraft.stopForward()}.bind(this)),this.setActionFunctions("reverse",function(e){this._controlledSpacecraft.reverse(e)}.bind(this),function(){this._controlledSpacecraft.stopReverse()}.bind(this)),this.setActionFunctions("strafeLeft",function(e){(void 0===e||e>=N)&&this._controlledSpacecraft.getFlightMode()===_.FlightMode.CRUISE&&this._controlledSpacecraft.toggleCruise()&&S&&S.play(),this._controlledSpacecraft.strafeLeft((void 0!==e?e:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopLeftStrafe()}.bind(this)),this.setActionFunctions("strafeRight",function(e){(void 0===e||e>=N)&&this._controlledSpacecraft.getFlightMode()===_.FlightMode.CRUISE&&this._controlledSpacecraft.toggleCruise()&&S&&S.play(),this._controlledSpacecraft.strafeRight((void 0!==e?e:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopRightStrafe()}.bind(this)),this.setActionFunctions("raise",function(e){(void 0===e||e>=N)&&this._controlledSpacecraft.getFlightMode()===_.FlightMode.CRUISE&&this._controlledSpacecraft.toggleCruise()&&S&&S.play(),this._controlledSpacecraft.raise((void 0!==e?e:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopRaise()}.bind(this)),this.setActionFunctions("lower",function(e){(void 0===e||e>=N)&&this._controlledSpacecraft.getFlightMode()===_.FlightMode.CRUISE&&this._controlledSpacecraft.toggleCruise()&&S&&S.play(),this._controlledSpacecraft.lower((void 0!==e?e:1)*this._strafeSpeed)}.bind(this),function(){this._controlledSpacecraft.stopLower()}.bind(this)),this.setActionFunction("toggleSpeedHolding",!0,function(){this._controlledSpacecraft.toggleSpeedHolding()&&S&&S.play()}.bind(this)),this.setActionFunction("resetSpeed",!0,function(){this._controlledSpacecraft.resetSpeed()}.bind(this)),this.setActionFunction("yawLeft",!0,function(e,t){this._controlledSpacecraft.yawLeft(e),t!==M&&C.disableMouseTurning()}.bind(this)),this.setActionFunction("yawRight",!0,function(e,t){this._controlledSpacecraft.yawRight(e),t!==M&&C.disableMouseTurning()}.bind(this)),this.setActionFunction("pitchUp",!0,function(e,t){this._controlledSpacecraft.pitchUp(e),t!==M&&C.disableMouseTurning()}.bind(this)),this.setActionFunction("pitchDown",!0,function(e,t){this._controlledSpacecraft.pitchDown(e),t!==M&&C.disableMouseTurning()}.bind(this)),this.setActionFunction("rollLeft",!0,function(e){this._controlledSpacecraft.rollLeft(e)}.bind(this)),this.setActionFunction("rollRight",!0,function(e){this._controlledSpacecraft.rollRight(e)}.bind(this)),this.setActionFunction("jumpOut",!0,function(){this._controlledSpacecraft.jumpOut(!0)}.bind(this)),this.setActionFunction("toggleSpotlights",!0,function(){this._controlledSpacecraft.toggleSpotLights()}.bind(this))}function _initSound(e){return h.getSoundEffect(p.gHS(e).name).createSoundClip(h.SoundCategory.SOUND_EFFECT,p.gHS(e).volume)}function ArmadaControlContext(){n.ControlContext.call(this),this._pilotingMode=!1,this._mouseTurningDisabled=!1,this._pointerLockEnabled=!1,this.registerInputInterpreterType(I,s.KeyboardInputInterpreter),this.registerInputInterpreterType(A,o.MouseInputInterpreter),this.registerInputInterpreterType(x,r.GamepadInputInterpreter),e.areTouchEventsSupported()&&this.registerInputInterpreterType(O,a.TouchInputInterpreter),this.registerControllerType(R,GeneralController),this.registerControllerType(b,FighterController),this.registerControllerType(L,l.CameraController)}var g,m,f,S,T,y,E,C,M,I="keyboard",A="mouse",x="joystick",v=x,O="touch",R="general",b="fighter",L="camera",N=.1,D=function(){T&&T.play()};return s.setModulePrefix("armada_control_"),o.setModulePrefix("armada_control_"),r.setModulePrefix("armada_control_"),a.setModulePrefix("armada_control_"),GeneralController.prototype=new n.Controller,GeneralController.prototype.constructor=GeneralController,GeneralController.prototype.getType=function(){return"general"},GeneralController.prototype.setMission=function(e){this._mission=e},GeneralController.prototype.setBattle=function(e){this._battle=e},FighterController.prototype=new n.Controller,FighterController.prototype.constructor=FighterController,FighterController.prototype.getType=function(){return"fighter"},FighterController.prototype.setControlledSpacecraft=function(e){this._controlledSpacecraft=e,this._controlledSpacecraft&&(this._strafeSpeed=g*this._controlledSpacecraft.getMaxAcceleration())},FighterController.prototype.executeActions=function(e,t){this._controlledSpacecraft&&(this._controlledSpacecraft._alive?(this._controlledSpacecraft.prepareForControl(),n.Controller.prototype.executeActions.call(this,e),this._autoTargeting&&!this._controlledSpacecraft.getTarget()&&this._controlledSpacecraft.targetNextBestHostile()&&m.play(),this._controlledSpacecraft.aimWeapons(this._wAimThreshold,0,t)):this._controlledSpacecraft=null)},ArmadaControlContext.prototype=new n.ControlContext,ArmadaControlContext.prototype.constructor=ArmadaControlContext,ArmadaControlContext.prototype.loadSettingsFromJSON=function(e,t){n.ControlContext.prototype.loadSettingsFromJSON.call(this,e,t),n.isPointerLockSupported()&&(this._pointerLockEnabled=e.pointerLockEnabled),t&&localStorage.removeItem("armada_control_pointerLockEnabled")},ArmadaControlContext.prototype.loadSettingsFromLocalStorage=function(){n.isPointerLockSupported()&&void 0!==localStorage.armada_control_pointerLockEnabled&&(this._pointerLockEnabled=t.getBooleanValueFromLocalStorage("armada_control_pointerLockEnabled",{defaultValue:this._pointerLockEnabled})),n.ControlContext.prototype.loadSettingsFromLocalStorage.call(this)},ArmadaControlContext.prototype.isInPilotMode=function(){return this._pilotingMode},ArmadaControlContext.prototype.switchToPilotMode=function(e,t){e&&e._alive&&!this._pilotingMode&&(this._pilotingMode=!0,m=_initSound(p.BS.HUD.TARGET_SWITCH_SOUND),f=_initSound(p.BS.HUD.TARGET_SWITCH_DENIED_SOUND),S=_initSound(p.BS.HUD.FLIGHT_MODE_SWITCH_SOUND),T=_initSound(p.BS.HUD.MISSILE_CHANGE_SOUND),y=_initSound(p.BS.HUD.MISSILE_CHANGE_DENIED_SOUND),E=_initSound(p.BS.HUD.MISSILE_SALVO_SOUND),this.getController(b).setControlledSpacecraft(e),this.getController(L).setCameraToFollowObject(e.vMo,t?0:800,"smooth",p.getDefaultCameraConfigurationName(e)),this.disableAction("followNext"),this.disableAction("followPrevious"),c.getScreen(u.BATTLE_SCREEN_NAME).setHeaderContent(""),this.getInputInterpreter(A).isEnabled()&&(document.body.style.cursor="none"))},ArmadaControlContext.prototype.switchToSpectatorMode=function(e,t){(this._pilotingMode||t)&&(this._pilotingMode=!1,this.getController(b).setControlledSpacecraft(null),e&&this.getController(L).setToFreeCamera(!1),this.enableAction("followNext"),this.enableAction("followPrevious"),c.getScreen(u.BATTLE_SCREEN_NAME).setHeaderContent(d.get(d.BATTLE.SPECTATOR_MODE)),document.body.style.cursor=c.getDefaultCursor())},ArmadaControlContext.prototype.disableMouseTurning=function(){this._mouseTurningDisabled||(M.disableAction("yawLeft"),M.disableAction("yawRight"),M.disableAction("pitchUp"),M.disableAction("pitchDown"),M.disableAction("rollLeft"),M.disableAction("rollRight"),this._mouseTurningDisabled=!0)},ArmadaControlContext.prototype.enableMouseTurning=function(){this._mouseTurningDisabled&&(M.enableAction("yawLeft"),M.enableAction("yawRight"),M.enableAction("pitchUp"),M.enableAction("pitchDown"),M.enableAction("rollLeft"),M.enableAction("rollRight"),this._mouseTurningDisabled=!1),n.isPointerLocked()||c.getScreen()!==c.getScreen(u.BATTLE_SCREEN_NAME)||c.getScreen().requestPointerLock(!1)},ArmadaControlContext.prototype.isMouseTurningDisabled=function(){return this._mouseTurningDisabled},ArmadaControlContext.prototype.isPointerLockEnabled=function(){return this._pointerLockEnabled},ArmadaControlContext.prototype.setPointerLockEnabled=function(e,t){n.isPointerLockSupported()&&(void 0===t&&(t=!0),this._pointerLockEnabled=e,t&&(localStorage.armada_control_pointerLockEnabled=e.toString()))},C=new ArmadaControlContext,C.executeWhenReady(function(){M=C.getInputInterpreter(A)}),p.executeWhenReady(function(){g=1}),{KEYBOARD_NAME:I,MOUSE_NAME:A,JOYSTICK_NAME:x,GAMEPAD_NAME:v,GENERAL_CONTROLLER_NAME:R,FIGHTER_CONTROLLER_NAME:b,CAMERA_CONTROLLER_NAME:L,loadConfigurationFromJSON:C.loadConfigurationFromJSON.bind(C),loadSettingsFromJSON:C.loadSettingsFromJSON.bind(C),loadSettingsFromLocalStorage:C.loadSettingsFromLocalStorage.bind(C),restoreDefaults:C.restoreDefaults.bind(C),getControllers:C.getControllers.bind(C),getController:C.getController.bind(C),isControllerPriority:C.isControllerPriority.bind(C),getInputInterpreters:C.getInputInterpreters.bind(C),getInputInterpreter:C.getInputInterpreter.bind(C),control:C.control.bind(C),startListening:C.startListening.bind(C),stopListening:C.stopListening.bind(C),isListening:C.isListening.bind(C),setScreenCenter:C.setScreenCenter.bind(C),executeWhenReady:C.executeWhenReady.bind(C),isInPilotMode:C.isInPilotMode.bind(C),switchToPilotMode:C.switchToPilotMode.bind(C),switchToSpectatorMode:C.switchToSpectatorMode.bind(C),isMouseTurningDisabled:C.isMouseTurningDisabled.bind(C),isPointerLockSupported:n.isPointerLockSupported,isPointerLockEnabled:C.isPointerLockEnabled.bind(C),setPointerLockEnabled:C.setPointerLockEnabled.bind(C),exitPointerLock:n.exitPointerLock,playMissileChangeSound:D}}),define("armada/logic/formations",["utils/vectors","modules/application","armada/configuration"],function(e,t,i){"use strict";function resetRandomSeed(){n=Math.seed(4718)}function getPositionInFormation(i,o,r,a){var l,c,h;switch(i.type){case s.WEDGE:c=Math.ceil(o/2),l=[(o%2==1?1:-1)*c*i.spacing[0],c*i.spacing[1],c*i.spacing[2]];break;case s.LINE:l=[o*i.spacing[0],o*i.spacing[1],o*i.spacing[2]];break;case s.DIAMOND:h=o%3,c=2*Math.floor(o/3)+(h>0?1:0),l=[(0===h?0:1===h?1:-1)*i.spacing[0],c*i.spacing[1],c*i.spacing[2]];break;case s.RANDOM:l=[n()*i.spacing[0]-i.spacing[0]/2,n()*i.spacing[1]-i.spacing[1]/2,n()*i.spacing[2]-i.spacing[2]/2];break;default:return t.showError("Unknown formation type specified: '"+i.type+"!"),[0,0,0]}return a&&e.mulVec3Mat4(l,a),r&&e.add3(l,r),l}var n,s={WEDGE:"wedge",LINE:"line",DIAMOND:"diamond",RANDOM:"random"};return i.executeWhenReady(function(){resetRandomSeed()}),{FormationType:s,resetRandomSeed:resetRandomSeed,getPositionInFormation:getPositionInFormation}}),define("armada/networking",["modules/application","armada/logic/constants","armada/logic/formations"],function(e,t,i){"use strict";function _onMessage(e,t,i){p[e]=i?[]:p[e]||[],p[e].push(t)}function _sendJSONtoSocket(e,t,i){var n=JSON.stringify(e);c?(t&&_onMessage(e.type,t,i),l.send(n)):d.push([e,t,i])}function _playerIsMe(e){return e.name===_}function _playerIsPeer(e){return!0===e.peer}function _playerNotLeft(e){return!0!==e.left}function _findMe(){return f?f.players.find(_playerIsMe):null}function _getPlayerIndex(){return f?f.players.findIndex(_playerIsMe):-1}function _findPlayer(e){return f?f.players.find(function(t){return t.name===e}):null}function _getOtherPlayerIndices(){var e,t=[];if(f)for(e=0;e<f.players.length;e++)_playerIsMe(f.players[e])||t.push(e);return t}function _cancelHeartbeat(){-1!==fe&&(clearInterval(fe),fe=-1)}function _setupHeartbeat(){-1===fe&&(fe=setInterval(function(){c?l.send(JSON.stringify({type:ne})):_cancelHeartbeat()},H))}function _processGameUpdate(e){var t=new Float32Array(e.data);0===t.length?(l.binaryType="blob",l.onmessage=F):N&&N(t)}function _processPlayerStats(e){var t,i;if(f)for(t=0;t<e.players.length;t++)(i=_findPlayer(e.players[t].name))&&Object.assign(i.stats,e.players[t].stats)}function _closePeerConnection(e){_playerIsPeer(e)&&(e.messageChannel&&("open"===e.messageChannel.readyState&&e.messageChannel.close(),e.messageChannel=null),e.updateChannel&&("open"===e.updateChannel.readyState&&e.updateChannel.close(),e.updateChannel=null),e.connection&&(e.connection.close(),e.connection=null))}function _destroyGame(){f&&f.players.forEach(function(e){_playerIsMe(e)||_closePeerConnection(e)}),f=null,g=!1,S=!1,C=null,M=null,I=null,A=null,x=null,v=null,O=null,R=null,b=null,L=null,N=null,D=null,P=null,_cancelHeartbeat()}function _processMatchConcluded(e){_processPlayerStats(e),D&&D(),_destroyGame(),_sendJSONtoSocket({type:ae})}function leaveGame(){f&&(_sendJSONtoSocket({type:Q}),_destroyGame())}function _processGuestTimeout(e){var t;e.playerName===_?(P&&P(),leaveGame()):(t=_findPlayer(e.playerName))&&!t.left&&(t.left=!0,_closePeerConnection(t),M&&M(t))}function _setupMessageDataChannel(e,t){e.onopen=function(){t.peer=!0,g||(m=!0),c&&l.send(JSON.stringify({type:te,playerName:t.name})),x&&x(t)},e.onclose=function(){t.peer=!1,g||(m=!1),c&&l.send(JSON.stringify({type:ie,playerName:t.name})),x&&x(t)},e.onmessage=function(i){var n;switch(n=JSON.parse(i.data),n.type){case z:e.send(JSON.stringify({type:J}));break;case J:t.ping=performance.now()-V,t.waitPong=!1,x&&x(t);break;case re:_processPlayerStats(n);break;case ae:_processMatchConcluded(n);break;case le:_processGuestTimeout(n)}}}function _setupUpdateDataChannel(e){e.onopen=function(){},e.onclose=function(){},e.onmessage=_processGameUpdate}function _createPeerConnection(e,t){var i,n,s;s=new RTCPeerConnection({iceServers:[{urls:B}]}),e.connection=s,s.onicegatheringstatechange=function(){"complete"===s.iceGatheringState&&_sendJSONtoSocket(g?{type:Y,offer:s.localDescription,playerName:e.name}:{type:X,answer:s.localDescription})},s.ondatachannel=function(t){switch(t.channel.label){case"messageChannel":e.messageChannel=t.channel,_setupMessageDataChannel(e.messageChannel,e);break;case"updateChannel":e.updateChannel=t.channel,_setupUpdateDataChannel(e.updateChannel)}},g?(i=s.createDataChannel("messageChannel"),e.messageChannel=i,_setupMessageDataChannel(i,e),n=s.createDataChannel("updateChannel"),e.updateChannel=n,_setupUpdateDataChannel(n),s.createOffer().then(function(e){s.setLocalDescription(e)},function(){})):(s.setRemoteDescription(new RTCSessionDescription(t)),s.createAnswer(function(e){s.setLocalDescription(e)},function(){}))}function _hostSend(e,t){var i=[];f.players.forEach(function(t,n){0===n||t.left||(_playerIsPeer(t)?t.messageChannel.send(JSON.stringify(e)):i.push(n))}),(i.length>0||t)&&(e.recipients=i,l.send(JSON.stringify(e)))}function _guestSendFastest(e,t){var i,n=[];for(_playerIsPeer(f.players[0])?f.players[0].messageChannel.send(JSON.stringify(e)):n.push(0),i=1;i<f.players.length;i++)_playerIsMe(f.players[i])||n.push(i);(n.length>0||t)&&(e.recipients=n,l.send(JSON.stringify(e)))}function _isApiVersionCompatible(e){var t=parseInt(U.split(".")[0],10),i=parseInt(e.split(".")[0],10);return!isNaN(i)&&!isNaN(t)&&t===i}function disconnect(){h=!1,u=!1,-1!==n&&(clearTimeout(n),n=-1),d.length=0,l&&c&&(f&&_destroyGame(),c=!1,l.close())}function _sendGuestUpdate(e,t){m?f.players[0].updateChannel.send(t):l.send(t),Te.set(t),Se=e}function init(e){s=e,l=null,c=!1,n=-1,u=!1,d=[],p={},f=null,g=!1}function getClientApiVersion(){return U}function isConnected(){return l&&c}function connect(){h=!0,l||(c=!1,u=!1,l=new WebSocket(s),l.binaryType="blob",l.onopen=function(){if(c=!0,!h)return void disconnect();-1!==n&&clearTimeout(n),n=setTimeout(function(){h&&c&&!u&&(E&&E(ce),disconnect()),n=-1},G)},l.onclose=function(){y&&y(c),_destroyGame(),c=!1,l=null},l.onmessage=F)}function getServerPing(){return o}function getServerRegion(){return r}function getServerApiVersion(){return a}function getPlayerName(){return _}function setPlayerName(e){_=e}function getPlayerSettings(){return _findMe().settings}function updatePlayerSettings(e){_findMe().ready||(Object.assign(_findMe().settings,e),_sendJSONtoSocket({type:oe,settings:e}))}function isInGame(){return!!f}function isHost(){return g}function getGameName(){return f?f.name:""}function getGameMode(){return f?f.mode:null}function getGameSettings(){return f?f.settings:null}function getHostName(){return f?f.players[0].name:""}function listGames(e){w||(w=performance.now()),_sendJSONtoSocket({type:j},e,!0)}function createGame(e,t){_sendJSONtoSocket({type:k,playerName:_,gameName:e.gameName,gameMode:e.gameMode,settings:Object.assign({},_e,e.settings),maxPlayers:e.maxPlayers},function(e){var i=e.game;i&&(f={host:i.host,name:i.name,mode:i.mode,players:[{name:_,ping:0,peer:!1,ready:!1,me:!0,settings:i.players[0].settings,stats:i.players[0].stats}],maxPlayers:i.maxPlayers,settings:i.settings,started:!1},g=!0,t())},!0)}function updateGameSettings(e){g&&(Object.assign(f.settings,e),_sendJSONtoSocket({type:se,settings:e}))}function onConnect(e){T=e}function onDisconnect(e){y=e}function onError(e){E=e}function onPlayerJoin(e){C=e}function onPlayerLeave(e){M=e}function onPlayerReady(e){I=e}function onPlayerKicked(e){A=e}function onPlayerUpdate(e){x=e}function onGameSettingsChanged(e){v=e}function onKicked(e){O=e}function onText(e){R=e}function onHostLeft(e){b=e}function onGameStart(e){L=e}function onGameUpdate(e){N=e}function onMatchConcluded(e){D=e}function onGuestTimeout(e){P=e}function joinGame(e,t){_sendJSONtoSocket({type:W,playerName:_,gameName:e.gameName},function(e){var i;for(f={name:e.gameName,mode:e.gameMode,players:e.players,settings:e.settings,started:!1},i=0;i<f.players.length;i++)f.players[i].me=_playerIsMe(f.players[i]);g=!1,t()},!0)}function kickPlayer(e){g&&_sendJSONtoSocket({type:K,playerName:e})}function getPlayers(){return f?f.players:[]}function getActivePlayers(){return f?f.players.filter(_playerNotLeft):[]}function ping(){var e;if(f&&!f.started)if(g){for(e=1;e<f.players.length;e++){if(f.players[e].waitPong)return;f.players[e].waitPong=!0}V=performance.now(),_hostSend(ge,!0)}else{for(e=0;e<f.players.length;e++)if(!_playerIsMe(f.players[e])){if(f.players[e].waitPong)return;f.players[e].waitPong=!0}V=performance.now(),_guestSendFastest(ge,!0)}}function sendText(e,t){_sendJSONtoSocket({type:q,text:e,recipients:t||_getOtherPlayerIndices()})}function markReady(){var e=_findMe();e.ready||(_sendJSONtoSocket({type:Z}),e.ready=!0,x&&x(e))}function allPlayersReady(){var e;if(!f||f.players.length<2)return!1;for(e=1;e<f.players.length;e++)if(!f.players[e].ready)return!1;return!0}function startGame(){g&&allPlayersReady()&&_sendJSONtoSocket({type:$})}function markLoaded(){_sendJSONtoSocket({type:ee})}
function registerPlayerKill(e,t){var i,n,s=[];g&&(i=_findPlayer(e),i&&(i.stats.kills++,s.push({name:e,stats:i.stats})),n=_findPlayer(t),n&&(n.stats.deaths++,s.push({name:t,stats:n.stats})),s.length>0&&_hostSend({type:re,players:s}))}function concludeMatch(){g&&(_hostSend({type:ae,players:f.players.map(function(e){return{name:e.name,stats:e.stats}})},!0),_destroyGame())}function guestTimeout(e){var t;g&&(t=_findPlayer(e))&&!t.left&&(_hostSend({type:le,playerName:e},!0),t.left=!0,_closePeerConnection(t),M&&M(t))}function getMissionData(){var t,n,s,o,r=f.players.length,a=function(e){return e/r*Math.PI*2},l=_getPlayerIndex();switch(f.mode){case me.FFA:t=f.players.map(function(e,t){return{name:"Team "+(t+1),color:e.settings.color.concat(1)}}),n=f.players.map(function(e,t){var i=a(t);return{name:e.name,team:"Team "+(t+1),class:e.settings.spacecraft,piloted:t===l,multi:!(g&&0===t),multiPiloted:!0,position:[500*Math.sin(i),500*-Math.cos(i),0],rotations:["z-"+Math.round(Math.degrees(i))],loadout:f.settings.loadout}});break;case me.COOP:t=[{faction:"empire",color:f.players[0].settings.color.concat(1)},{faction:"pirates"}],o={type:i.FormationType.WEDGE,spacing:[40,-10,0]},n=f.players.map(function(e,t){return{name:e.name,squad:"alpha "+(t+1),team:"empire",class:e.settings.spacecraft,piloted:t===l,multi:!(g&&0===t),multiPiloted:!0,position:i.getPositionInFormation(o,t),loadout:f.settings.loadout}}),o={type:i.FormationType.WEDGE,spacing:[75,10,-10]},n.push({squad:"raider",team:"pirates",class:"wolf",loadout:"pirate-weak",ai:"fighter",multi:!g,position:[0,2500,0],rotations:[{axis:"Z",degrees:180}],count:f.settings.enemiesPerWave,formation:o}),n.push({squad:"marauder",team:"pirates",class:"wolf",loadout:"pirate-shielded",ai:"fighter",multi:!g,position:[0,3e3,0],rotations:[{axis:"Z",degrees:180}],formation:o,count:f.settings.enemiesPerWave,away:!0}),n.push({squad:"bandit",team:"pirates",class:"piranha",loadout:"pirate-shielded",ai:"fighter",multi:!g,position:[3e3,0,0],rotations:[{axis:"Z",degrees:270}],formation:o,count:f.settings.enemiesPerWave,away:!0}),n.push({squad:"brigand",team:"pirates",class:"stingray",loadout:"pirate-tier2",ai:"fighter",multi:!g,position:[-3e3,0,0],rotations:[{axis:"Z",degrees:90}],formation:o,count:f.settings.enemiesPerWave,away:!0}),s=[{trigger:{conditions:[{type:"destroyed",subjects:{squads:["raider"]}}],delay:1500},actions:[{type:"command",subjects:{squads:["marauder"]},params:{command:"jump"}}]},{trigger:{conditions:[{type:"destroyed",subjects:{squads:["marauder"]}}],delay:1500},actions:[{type:"command",subjects:{squads:["bandit"]},params:{command:"jump"}}]},{trigger:{conditions:[{type:"destroyed",subjects:{squads:["bandit"]}}],delay:1500},actions:[{type:"command",subjects:{squads:["brigand"]},params:{command:"jump"}}]}];break;default:return e.showError("Cannot create game! Unsupported game mode: "+f.mode+"!"),null}return{title:f.name,environment:f.settings.environment,teams:t,spacecrafts:n,events:s}}function sendHostUpdate(e){var t,i=new Float32Array(e.length*he),n=!1;for(t=0;t<e.length;t++)i.set(e[t].getMultiHostData(),t*he);for(t=1;t<f.players.length;t++)f.players[t].left||(_playerIsPeer(f.players[t])?f.players[t].updateChannel.send(i):n=!0);n&&l.send(i)}function sendGuestUpdate(e){var t,i=performance.now(),n=e.getMultiGuestData();if(e._alive){if(i-Se>de)return void _sendGuestUpdate(i,n);for(t=0;t<ue;t++)if(n[t]!==Te[t])return void _sendGuestUpdate(i,n)}else if(i-Se>pe)return void _sendGuestUpdate(i,n)}var n,s,o,r,a,l,c,h,u,d,p,_,g,m,f,S,T,y,E,C,M,I,A,x,v,O,R,b,L,N,D,P,w,V,F,U="2.0",B="stun:stun.l.google.com:19302",H=15e3,G=1e4,j=0,k=1,W=2,Y=3,X=4,q=5,z=6,J=7,Q=8,K=10,Z=11,$=12,ee=13,te=14,ie=15,ne=16,se=17,oe=18,re=19,ae=20,le=21,ce=1001,he=t.MULTI_HOST_DATA_LENGTH,ue=t.MULTI_GUEST_DATA_LENGTH,de=100,pe=1e3,_e={difficulty:"hard",friendlyFire:!1,environment:"reddim",loadout:"multi-tier1",enemiesPerWave:3},ge={type:z},me={FFA:"ffa",COOP:"coop"},fe=-1,Se=0,Te=new Float32Array(ue).fill(0);return F=function(e){var t,i,n,s,c,y;if("string"==typeof e.data){if(s=JSON.parse(e.data),!u){if(!h)return void disconnect();if(22===s.type){if(u=!0,a=s.apiVersion,_isApiVersionCompatible(s.apiVersion)){for(r=s.region,t=0;t<d.length;t++)c=d[t][0],d[t][1]&&_onMessage(c.type,d[t][1],d[t][2]),l.send(JSON.stringify(c));d.length=0,T&&T()}else E&&E(1e3),disconnect();return}if(9!==s.type)return}switch(s.type){case j:o=performance.now()-w,w=0;break;case W:f&&(i={name:s.player.name,peer:!1,ready:!1,me:!1,settings:s.player.settings,stats:s.player.stats},f.players.push(i),C&&C(s.player.name),g&&_createPeerConnection(i));break;case Q:f&&(n=f.players.findIndex(function(e){return e.name===s.playerName}),0===n?(b&&b(),_destroyGame()):n>0&&(i=f.players[n],_closePeerConnection(i),f.started?f.players[n].left=!0:f.players.splice(n,1),M&&M(i)));break;case 9:E&&E(s.errorCode);break;case Y:f&&_createPeerConnection(f.players[0],s.offer);break;case X:i=_findPlayer(s.playerName),i&&i.connection.setRemoteDescription(new RTCSessionDescription(s.answer));break;case q:R&&R(s);break;case z:l.send(JSON.stringify({type:J,recipient:s.sender}));break;case J:f&&(i=f.players[s.sender])&&(i.ping=performance.now()-V,i.waitPong=!1,x&&x(i));break;case K:f&&(s.playerName===_?(O&&O(),_destroyGame()):(n=f.players.findIndex(function(e){return e.name===s.playerName}),i=f.players[n],_closePeerConnection(i),f.players.splice(n,1),A&&A(i),x&&x(i)));break;case Z:f&&(i=_findPlayer(s.playerName))&&(i.ready=!0,I&&I(i),x&&x(i));break;case $:if(f){if(f.started){if(g){for(y=!1,t=1;t<f.players.length;t++)if(!_playerIsPeer(f.players[t])){y=!0;break}}else y=!m;y?S=!0:_setupHeartbeat()}else f.started=!0;L&&L()}break;case se:f&&!f.started&&(Object.assign(f.settings,s.settings),v&&v());break;case oe:f&&(i=_findPlayer(s.playerName))&&(Object.assign(i.settings,s.settings),x&&x(i));break;case re:_processPlayerStats(s);break;case ae:_processMatchConcluded(s);break;case le:_processGuestTimeout(s)}if(p[s.type]){for(t=0;t<p[s.type].length;t++)p[s.type][t](s);p[s.type].length=0}S&&(l.binaryType="arraybuffer",l.onmessage=_processGameUpdate)}},{ERROR_CODE_GAME_NOT_FOUND:0,ERROR_CODE_GAME_IS_FULL:1,ERROR_CODE_GAME_ALREADY_STARTED:2,ERROR_CODE_PLAYER_NAME_ALREADY_EXISTS:3,ERROR_CODE_GAME_NAME_ALREADY_EXISTS:4,ERROR_CODE_INVALID_GAME_SETTINGS:5,ERROR_CODE_INVALID_PLAYER_NAME:6,ERROR_CODE_INVALID_TEXT:7,ERROR_CODE_SERVER_IS_FULL:8,ERROR_CODE_INCOMPATIBLE_API_VERSION:1e3,ERROR_CODE_NO_WELCOME:ce,GameMode:me,init:init,getClientApiVersion:getClientApiVersion,isConnected:isConnected,connect:connect,disconnect:disconnect,getServerPing:getServerPing,getServerRegion:getServerRegion,getServerApiVersion:getServerApiVersion,getPlayerName:getPlayerName,setPlayerName:setPlayerName,getPlayerSettings:getPlayerSettings,updatePlayerSettings:updatePlayerSettings,isInGame:isInGame,isHost:isHost,getGameName:getGameName,getGameMode:getGameMode,getGameSettings:getGameSettings,getHostName:getHostName,listGames:listGames,createGame:createGame,updateGameSettings:updateGameSettings,joinGame:joinGame,onConnect:onConnect,onDisconnect:onDisconnect,onError:onError,onPlayerJoin:onPlayerJoin,onPlayerLeave:onPlayerLeave,onPlayerReady:onPlayerReady,onPlayerKicked:onPlayerKicked,onPlayerUpdate:onPlayerUpdate,onGameSettingsChanged:onGameSettingsChanged,onKicked:onKicked,onText:onText,onHostLeft:onHostLeft,onGameStart:onGameStart,leaveGame:leaveGame,kickPlayer:kickPlayer,getPlayers:getPlayers,getActivePlayers:getActivePlayers,ping:ping,sendText:sendText,markReady:markReady,allPlayersReady:allPlayersReady,startGame:startGame,markLoaded:markLoaded,registerPlayerKill:registerPlayerKill,concludeMatch:concludeMatch,guestTimeout:guestTimeout,getMissionData:getMissionData,sendHostUpdate:sendHostUpdate,sendGuestUpdate:sendGuestUpdate,onGameUpdate:onGameUpdate,onMatchConcluded:onMatchConcluded,onGuestTimeout:onGuestTimeout}}),define("armada/logic/spacecraft",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/managed-gl","modules/egom-model","modules/physics","modules/media-resources","modules/scene/renderable-objects","modules/scene/lights","modules/scene/scene-graph","armada/graphics","armada/audio","armada/logic/classes","armada/configuration","armada/strings","armada/control","armada/networking","armada/logic/constants","armada/logic/SpacecraftEvents","armada/logic/equipment","armada/logic/explosion","utils/polyfill"],function(e,t,i,n,s,o,r,a,l,c,h,u,d,p,_,g,m,f,S,T,y,E){"use strict";function handleGraphicsSettingsChanged(){b={},b[R]=s.ShaderVariableType.MAT4,u.areLuminosityTexturesAvailable()&&(b[O]=s.ShaderVariableType.FLOAT),L=u.areDynamicLightsAvailable()&&u.getMaxPointLights()>0}function setMultiGuest(e){N=e}function getSquadName(e){var t,i;return(t=e.lastIndexOf(" "))<0?e:(i=e.substring(t+1),isNaN(i)?e:e.substring(0,t))}function getSquadIndex(e){var t,i;return(t=e.lastIndexOf(" "))<0?0:(i=parseInt(e.substring(t+1),10),isNaN(i)?0:i)}function Blinker(e){this._descriptor=e,this.vMo=null,this._lightSource=null}function Spacecraft(e,t,n,s,o,r,a){this._class=null,this._id=null,this._name=null,this._displayName=null,this._alive=!0,this._away=!1,this._hitpoints=0,this._maxHitpoints=0,this.vMo=null,this._hitbox=null,this._blinkers=null,this._spotLights=null,this._initialBlinkTime=-1,this.pMo=null,this._physicalPositionVector=[0,0,0],this._relativeVelocityMatrix=i.identity4(),this._relativeVelocityMatrixValid=!1,this._turningMatrix=i.identity4(),this._turningMatrixValid=!1,this._scaledOriMatrix=i.identity4(),this._ws=null,this._mLs=[],this._activeMissileLauncherIndex=-1,this._mClasses=[],this._tC=null,this._propulsion=null,this._jumpEngine=null,this._shield=null,this._mC=null,this._firingDisabled=!1,this._isJumping=!1,this._activeDamageIndicators=[],this._explosion=null,this._eventHandlers=null,this._tedBy=null,this._hitData={spacecraft:null,hitPosition:null,hullDamage:0},this._anySpacecraftHitData={spacecraft:this},this._team=null,this._squad=null,this._indexInSquad=0,this._piloted=!1,this._humSoundClip=null,this._humSoundVolume=0,this._collisionSoundClip=null,this._timeSinceCollisionSoundPlayed=0,this._soundSource=d.createSoundSource(0,0,0),this._kills=0,this._score=0,this._damageDealt=0,this._mDamageDealt=0,this._shotsFired=0,this._hitsOnEnemies=0,this._msLaunched=0,this._mHitsOnEnemies=0,this._sensorsScoreValue=0,this._scoreValue=0,this._timeElapsedSinceDestruction=-1,this._burnForSpeedChangeFactor=0,this._burnForAngularVelocityChangeFactor=0,this._topSpeed=0,this._fired=!1,this._guestPiloted=!1,this._multiControlled=!1,this._multiHostData=new Float32Array(x),this._multiGuestData=new Float32Array(v),e&&this._init(e,t,n,s,o,r,a)}var C,M,I,A=[-1,-1,-1,-1],x=S.MULTI_HOST_DATA_LENGTH,v=S.MULTI_GUEST_DATA_LENGTH,O=null,R=null,b=null,L=!1,N=!1;return Blinker.prototype.addToScene=function(e,t){this.vMo=new l.Particle(this._descriptor._particle.getModel(),this._descriptor._particle.getShader(),this._descriptor._particle.getTexturesOfTypes(this._descriptor._particle.getShader().getTextureTypes(),u.getTextureQualityPreferenceList()),i.translation4v(this._descriptor._position),this._descriptor.getParticleStates(),!0,this._descriptor._particle.getInstancedShader(),0),e.addSubnode(new h.RenderableNode(this.vMo,!1,!1,!0)),L&&!0===t&&this._descriptor._intensity>0&&(this._lightSource=new c.PointLightSource(this._descriptor._lightColor,0,this._descriptor._position,[e._renderableObject],this._descriptor.getLightStates(),!0),e.getScene().addPointLightSource(this._lightSource,S.BLINKER_LIGHT_PRIORITY))},Blinker.prototype.setTime=function(e){this.vMo.setAnimationTime(e),this._lightSource&&this._lightSource.setAnimationTime(e)},Blinker.prototype.setRandomTime=function(){var e=Math.round(Math.random()*this._descriptor._period);return this.setTime(e),e},Spacecraft.prototype._init=function(e,t,n,s,o,a,l){var c,h;for(this._class=e,this._name=t||"",this._alive=!0,this._away=!1,this._hitpoints=this._class._hitpoints,this._maxHitpoints=this._class._hitpoints,this.pMo=new r.PhysicalObject(this._class._mass,n||i.IDENTITY4,s||i.IDENTITY4,1,i.IDENTITY4,this._class._bodies,this._class._dragFactor),this._ws=[],this._mLs=[],this._mClasses=[],this._activeMissileLauncherIndex=-1,this._tC=new y.TargetingComputer(this,a,l),this._firingDisabled=!1,this._isJumping=!1,this._mC=new y.ManeuveringComputer(this),this._blinkers=[],h=this._class._blinkerDescriptors,c=0;c<h.length;c++)this._blinkers.push(new Blinker(h[c]));this._spotLights=[],o&&this.equipLoadout(this._class.getLoadout(o)),this._tedBy=[],this._eventHandlers={},this._team=null,this._kills=0,this._score=0,this._damageDealt=0,this._mDamageDealt=0,this._shotsFired=0,this._hitsOnEnemies=0,this._msLaunched=0,this._mHitsOnEnemies=0,this._hitSounds={},this._hitSoundTimestamp=0,this._updateIDAndName(),this._updateScoreValue(),this._updateBurnNeedFactors()},Spacecraft.prototype._updateIDAndName=function(){this._id=this._name||!this._squad?this._name:this._squad+" "+this._indexInSquad.toString(),this._displayName=this._name||!this._squad?this._name:g.get(g.SQUAD.PREFIX,this._squad,this._squad)+" "+this._indexInSquad.toString()},Spacecraft.prototype._updateBurnNeedFactors=function(){this._burnForSpeedChangeFactor=this._propulsion?this.pMo._mass/this._propulsion.getThrust()*this._propulsion.getMaxMoveBurnLevel()*1e3:0,this._burnForAngularVelocityChangeFactor=this._propulsion?1/r.ANGULAR_VELOCITY_MATRIX_DURATION_S*this.pMo._mass/this._propulsion.getAngularThrust()*this._propulsion.getMaxTurnBurnLevel()*1e3:0},Spacecraft.prototype.setAway=function(e){var t;this._away!==e&&(this._away=e,this._away?(this.setTarget(null),t=this.pMo.pM,this.vMo&&(!this.vMo._wireframe||0===t[12]&&0===t[13]&&0===t[14])&&this.vMo._node.hide(),this.pMo&&this.pMo.reset(),this._humSoundClip&&this._humSoundClip.stopPlaying(d.SOUND_RAMP_DURATION),this._propulsion&&(this._propulsion.resetThrusterBurn(),this._propulsion.simulate(0,this._soundSource,!1))):this.vMo&&this.vMo._node.show())},Spacecraft.prototype.setSquad=function(e,t){this._squad=e,this._indexInSquad=t,this._updateIDAndName()},Spacecraft.prototype.isFriendly=function(e){return e._team===this._team},Spacecraft.prototype.isHostile=function(e){return e._team!==this._team},Spacecraft.prototype.setAsMultiControlled=function(e,t){this._guestPiloted=e,this._multiControlled=!e,this._multiGuestData[0]=t},Spacecraft.prototype.getClass=function(){return this._class},Spacecraft.prototype.isFighter=function(){return this._class.isFighterClass()},Spacecraft.prototype.getID=function(){return this._id},Spacecraft.prototype.getDisplayName=function(){return this._displayName},Spacecraft.prototype.getHullIntegrity=function(){return this._hitpoints/this._maxHitpoints},Spacecraft.prototype.setHullIntegrity=function(e){var t=Math.min(Math.max(0,e),1)*this._maxHitpoints,i=t>this._hitpoints;this._hitpoints=t,i&&this._updateDamageIndicators()},Spacecraft.prototype.hasShield=function(){return!!this._shield},Spacecraft.prototype.getShieldDisplayName=function(){return this._shield.getDisplayName()},Spacecraft.prototype.getShieldIntegrity=function(){return this._shield?this._shield.getIntegrity():0},Spacecraft.prototype.setShieldIntegrity=function(e){this._shield&&this._shield.setIntegrity(Math.min(Math.max(0,e),1))},Spacecraft.prototype.getShieldCapacity=function(){return this._shield?this._shield._capacity:0},Spacecraft.prototype.getShieldRechargeRate=function(){return this._shield?this._shield.getRechargeRate():0},Spacecraft.prototype.getShieldState=function(){return this._shield?this._shield._state:t.NULL4},Spacecraft.prototype.rechargeShield=function(){this._shield.startRecharge()},Spacecraft.prototype.multiplyMaxHitpoints=function(e){this._hitpoints*=e,this._maxHitpoints*=e},Spacecraft.prototype.getExplosion=function(){return this._explosion},Spacecraft.prototype.getClassName=function(){return this._class._name},Spacecraft.prototype.getTypeName=function(){return this._class._scType._name},Spacecraft.prototype.isGoodAgainst=function(e){return this._class._scType.isGoodAgainst(e.getClass()._scType)},Spacecraft.prototype.isBadAgainst=function(e){return this._class._scType.isBadAgainst(e.getClass()._scType)},Spacecraft.prototype.resetDrag=function(){return this.pMo._dragFactor=this._class._dragFactor},Spacecraft.prototype.getView=function(e){return this._class.getView(e)},Spacecraft.prototype.enableFiring=function(){this._firingDisabled=!1},Spacecraft.prototype.disableFiring=function(){this._firingDisabled=!0},Spacecraft.prototype.hasWeapons=function(){return this._ws&&this._ws.length>0},Spacecraft.prototype.getWeaponsDisplayText=function(e){var t,i,n,s="",o={};for(e=e||", ",t=0;t<this._ws.length;t++)i=this._ws[t].getDisplayName(),o[i]?o[i]+=1:o[i]=1;for(n=Object.keys(o),t=0;t<n.length;t++)s+=(t>0?e:"")+o[n[t]]+" × "+n[t];return s},Spacecraft.prototype.getWeaponRangesDisplayText=function(e){e=e||"/";var t,i,n=[];for(t=0;t<this._ws.length;t++)i=this._ws[t].getRange(0),n.indexOf(i)<0&&n.push(i);return n.join(e)},Spacecraft.prototype.getFirepower=function(e){var t,i=0;for(t=0;t<this._ws.length;t++)i+=this._ws[t].getFirepower(e);return i},Spacecraft.prototype.hasMissiles=function(){var e;if(this._mLs)for(e=0;e<this._mLs.length;e++)if(this._mLs[e].getMissileCount()>0)return!0;return!1},Spacecraft.prototype.getMissilesDisplayText=function(e){var t,i,n,s="",o={};for(e=e||", ",t=0;t<this._mLs.length;t++)i=this._mLs[t].getDisplayName(),o[i]?o[i]+=this._mLs[t].getMissileCount():o[i]=this._mLs[t].getMissileCount();for(n=Object.keys(o),t=0;t<n.length;t++)s+=(t>0?e:"")+o[n[t]]+" × "+n[t];return s},Spacecraft.prototype.getMissileRangesDisplayText=function(e){e=e||"/";var t,i,n=[];for(t=0;t<this._mLs.length;t++)i=this._mLs[t].getNominalRange().toFixed(0),n.indexOf(i)<0&&n.push(i);return n.join(e)},Spacecraft.prototype.getMissileFirepower=function(e){var t,i=0;for(t=0;t<this._mLs.length;t++)i+=this._mLs[t].getFirepower(e||0);return i},Spacecraft.prototype.canBeReused=function(){return!this._alive},Spacecraft.prototype.getHitRatio=function(){return this._shotsFired?this._hitsOnEnemies/this._shotsFired:0},Spacecraft.prototype.getKills=function(){return this._kills},Spacecraft.prototype.gainKill=function(){this._kills++},Spacecraft.prototype.getScore=function(){return this._score},Spacecraft.prototype.gainScore=function(e){this._score+=e},Spacecraft.prototype.getDamageDealt=function(){return this._damageDealt},Spacecraft.prototype.getMissileDamageDealt=function(){return this._mDamageDealt},Spacecraft.prototype.gainDamageDealt=function(e,t){this._damageDealt+=e,t&&(this._mDamageDealt+=e)},Spacecraft.prototype.getMissilesLaunched=function(){return this._msLaunched},Spacecraft.prototype.getMissileHitsOnEnemies=function(){return this._mHitsOnEnemies},Spacecraft.prototype.getMissileHitRatio=function(){return this._mHitsOnEnemies/this._msLaunched},Spacecraft.prototype.getScoreValue=function(){return this._scoreValue},Spacecraft.prototype.setPhysicalPosition=function(e){this.pMo.setPosition(e[0],e[1],e[2])},Spacecraft.prototype.getPhysicalPositionVector=function(){return this.pMo.copyPositionToVector(this._physicalPositionVector),this._physicalPositionVector},Spacecraft.prototype.updatePhysicalOrientationMatrix=function(e){this.pMo.updateOrientationMatrix(e)},Spacecraft.prototype.updateScaledOriMatrix=function(){i.setProd3x3SubOf4(this._scaledOriMatrix,this.pMo.sM,this.pMo.oM)},Spacecraft.prototype.getScaledOriMatrix=function(){return this._scaledOriMatrix},Spacecraft.prototype.getPositionMatrixInCameraSpace=function(){return this.vMo.getPositionMatrixInCameraSpace(this.vMo._node.getScene()._camera)},Spacecraft.prototype.getRelativeVelocityMatrix=function(){return this._relativeVelocityMatrixValid||(i.updateProdTranslationRotationInverse4(this._relativeVelocityMatrix,this.pMo._velocityMatrix,this.pMo.oM),this._relativeVelocityMatrixValid=!0),this._relativeVelocityMatrix},Spacecraft.prototype.getTurningMatrix=function(){return this._turningMatrixValid||(i.updateProdRotationRotationInverse4(this._turningMatrix,i.prod3x3SubOf4Aux(this.pMo.oM,this.pMo._velocityMatrix),this.pMo.oM),this._turningMatrixValid=!0),this._turningMatrix},Spacecraft.prototype.getMaxAcceleration=function(){return this._propulsion?this._propulsion.getThrust()/this.pMo._mass:null},Spacecraft.prototype.getMaxCombatSpeed=function(){return 2*this.getMaxAcceleration()||0},Spacecraft.prototype.getMaxAngularAcceleration=function(){return this._propulsion?this._propulsion.getAngularThrust()/this.pMo._mass:0},Spacecraft.prototype.getMaxCombatTurnRate=function(){return this.getMaxAngularAcceleration()*e.DEG*.2||0},Spacecraft.prototype.getMaxThrusterMoveBurnLevel=function(){return this._propulsion?this._propulsion.getMaxMoveBurnLevel():0},Spacecraft.prototype.getMaxThrusterTurnBurnLevel=function(){return this._propulsion?this._propulsion.getMaxTurnBurnLevel():0},Spacecraft.prototype.getMaxTurnRateAtSpeed=function(e){var t=Math.abs(this._propulsion.getThrust()/(this.pMo._mass*e));return t<=1?Math.asin(t):Number.MAX_VALUE},Spacecraft.prototype.getHitboxTextures=function(){var e=u.getManagedShader(_.getSetting(_.BS.HITBOX_SHADER_NAME)).getTextureTypes();return u.getTexture(_.getSetting(_.BS.HITBOX_TEXTURE_NAME),{types:e}).getManagedTexturesOfTypes(e,u.getTextureQualityPreferenceList())},Spacecraft.prototype.getNeededBurnForSpeedChange=function(e,t){return e*this._burnForSpeedChangeFactor/t},Spacecraft.prototype.getNeededBurnForAngularVelocityChange=function(e,t){return e*this._burnForAngularVelocityChangeFactor/t},Spacecraft.prototype.getTopSpeed=function(){return this._topSpeed},Spacecraft.prototype.loadFromJSON=function(e,t,n){var s;this._init(p.getSpacecraftClass(e.class),e.name,e.position?i.translation4v(e.position):null,i.rotation4FromJSON(e.rotations),void 0,t,n),e.squad&&this.setSquad(getSquadName(e.squad),getSquadIndex(e.squad)),e.loadout?this.equipLoadout(this._class.getLoadout(e.loadout)):e.equipment?(s=new p.Loadout(e.equipment,null,e.equipment.basedOn?this._class.getLoadout(e.equipment.basedOn):null),this.equipLoadout(s)):this._class._defaultLoadout&&this.equipLoadout(this._class.getLoadout(this._class._defaultLoadout)),e.away&&this.setAway(!0),this._initialBlinkTime=void 0!==e.initialBlinkTime?e.initialBlinkTime:-1},Spacecraft.prototype.prepareForControl=function(){this._mC.prepareForControl()},Spacecraft.prototype.isManeuveringLocked=function(){return this._mC._locked},Spacecraft.prototype.lockManeuvering=function(){this._mC.setLocked(!0)},Spacecraft.prototype.unlockManeuvering=function(){this._mC.setLocked(!1)},Spacecraft.prototype.getFlightMode=function(){return this._mC.getFlightMode()},Spacecraft.prototype.changeFlightMode=function(e){return this._mC.changeFlightMode(e)},Spacecraft.prototype.toggleFlightAssist=function(){return this._mC.toggleFlightAssist()},Spacecraft.prototype.toggleCruise=function(){return this._mC.toggleCruise()},Spacecraft.prototype.forward=function(e){this._mC.forward(e)},Spacecraft.prototype.stopForward=function(){this._mC.stopForward()},Spacecraft.prototype.reverse=function(e){this._mC.reverse(e)},Spacecraft.prototype.stopReverse=function(){this._mC.stopReverse()},Spacecraft.prototype.strafeLeft=function(e){this._mC.strafeLeft(e)},Spacecraft.prototype.stopLeftStrafe=function(){this._mC.stopLeftStrafe()},Spacecraft.prototype.strafeRight=function(e){this._mC.strafeRight(e)},Spacecraft.prototype.stopRightStrafe=function(){this._mC.stopRightStrafe()},Spacecraft.prototype.raise=function(e){this._mC.raise(e)},Spacecraft.prototype.stopRaise=function(){this._mC.stopRaise()},Spacecraft.prototype.lower=function(e){this._mC.lower(e)},Spacecraft.prototype.stopLower=function(){this._mC.stopLower()},Spacecraft.prototype.toggleSpeedHolding=function(){return this._mC.toggleSpeedHolding()},Spacecraft.prototype.setSpeedHolding=function(e){this._mC.setSpeedHolding(e)},Spacecraft.prototype.resetSpeed=function(){this._mC.resetSpeed()},Spacecraft.prototype.setSpeedTarget=function(e){this._mC.setSpeedTarget(e)},Spacecraft.prototype.getSpeedTarget=function(){return this._mC.getSpeedTarget()},Spacecraft.prototype.hasSpeedTarget=function(){return this._mC.hasSpeedTarget()},Spacecraft.prototype.getMaxSpeed=function(){return this._mC.getMaxSpeed()},Spacecraft.prototype.yawLeft=function(e){this._mC.yawLeft(e)},Spacecraft.prototype.yawRight=function(e){this._mC.yawRight(e)},Spacecraft.prototype.pitchUp=function(e){this._mC.pitchUp(e)},Spacecraft.prototype.pitchDown=function(e){this._mC.pitchDown(e)},Spacecraft.prototype.rollLeft=function(e){this._mC.rollLeft(e)},Spacecraft.prototype.rollRight=function(e){this._mC.rollRight(e)},Spacecraft.prototype._addHitboxModel=function(e){var t=a.getOrAddModel(o.cuboidModel("hitBox",1,1,1,C)),n=new l.ShadedLODMesh(t.getEgomModel(),u.getManagedShader(_.getSetting(_.BS.HITBOX_SHADER_NAME)),this.getHitboxTextures(),i.translation4m4(this._class._bodies[e].pM),this._class._bodies[e].oM,i.scaling4(this._class._bodies[e].getWidth(),this._class._bodies[e].getHeight(),this._class._bodies[e].getDepth()),!1);n.setUniformValueFunction(l.UNIFORM_COLOR_NAME,function(){return C}),n.setUniformValueFunction(R,function(){return u.getGroupTransformIdentityArray()}),this._hitbox.addSubnode(new h.RenderableNode(n,!1))},Spacecraft.prototype.getHitbox=function(){return this._hitbox},Spacecraft.prototype.acquireResources=function(e,t){e&&(u.getShader(_.getSetting(_.BS.HITBOX_SHADER_NAME)),u.getTexture(_.getSetting(_.BS.HITBOX_TEXTURE_NAME))),this._class.acquireResources(t),a.executeWhenReady(function(){this._alive&&this.pMo.setScaling(this._class.getModel()._scale)}.bind(this))},Spacecraft.prototype.addToSceneNow=function(e,s,o,r,a,d,p,_){var g,m,f,T,y,C,M,I,x,v,N,D,P;if(this._class){if(!1!==r.self?(m=a.shaderName?u.getManagedShader(a.shaderName):this._class.getShader(),I=new l.ParameterizedMesh(this._class.getModel(),m,this._class.getTexturesOfTypes(m.getTextureTypes(),u.getTextureQualityPreferenceList()),a.positionMatrix||this.pMo.pM,a.orientationMatrix||this.pMo.oM,a.scalingMatrix||i.scaling4(this._class.getModel()._scale),!0===o,s,a.smallestSizeWhenDrawn,b,a.replaceVisualModel?null:this.vMo),this._name&&(I._name=this._name),C=this._class._factionColor||A,M=a.factionColor||this._team&&this._team._color||C,I.setUniformValueFunction("originalFactionColor",function(){return C}),I.setUniformValueFunction("replacementFactionColor",function(){return M}),I.setUniformValueFunction("shieldState",function(){return this.getShieldState()}.bind(this)),this.vMo&&!a.replaceVisualModel||(I.hasParameterArray(R)&&I.setParameterArray(R,u.getGroupTransformIdentityArray()),u.areLuminosityTexturesAvailable()&&I.hasParameterArray(O)&&I.setParameterArray(O,this._class._defaultLuminosityFactors),this.vMo=I),f=e.addObject(I),a.visualModel&&n.showError("Attempting to specify a visual model for the Spacecraft.addToScene() operation while a new one is also created!",n.ErrorSeverity.MINOR)):(I=a.visualModel||this.vMo,f=I._node),!0===r.hitboxes){for(m=m||(a.shaderName?u.getManagedShader(a.shaderName):this._class.getShader()),this._hitbox=new h.RenderableNode(new l.ContainerObject(m),!1),g=0;g<this._class._bodies.length;g++)this._addHitboxModel(g);this._hitbox.hide(),f.addSubnode(this._hitbox)}if(!0===r.weapons)for(D={shaderName:a.shaderName},g=0;g<this._ws.length;g++)this._ws[g].addToSceneNow(f,s,o,D,p);if(!0===r.missilesInLaunchers)for(P={shaderName:a.shaderName,allMissiles:r.allMissilesInLaunchers},g=0;g<this._mLs.length;g++)this._mLs[g].addToSceneNow(f,s,o,P,_);if(!0===r.thrusterParticles&&this._propulsion&&this._propulsion.addToScene(f),!0===r.projectileResources)for(g=0;g<this._ws.length;g++)this._ws[g].addProjectileResourcesToScene(e);if(!0===r.missileResources)for(g=0;g<this._mLs.length;g++)this._mLs[g].addMissileResourcesToScene(e);if(!0===r.explosion&&(T=new E.Explosion(this._class._explosionClass,i.IDENTITY4,i.IDENTITY4,t.NULL3,!0),T.addResourcesToScene(e)),!0===r.cameraConfigurations&&this._addCameraConfigurationsForViews(),L&&!0===r.lightSources)for(y=this._class._lightSources,this._spotLights.length=0,v=[I],g=0;g<y.length;g++)y[g].spotDirection?this._piloted&&(x=new c.SpotLightSource(y[g].color,y[g].intensity,y[g].position,y[g].spotDirection,y[g].spotCutoffAngle,y[g].spotFullIntensityAngle,I),this._spotLights.push(x),e.addSpotLightSource(x)):(x=new c.PointLightSource(y[g].color,y[g].intensity,y[g].position,v),e.addPointLightSource(x,S.SPACECRAFT_LIGHT_PRIORITY));if(!0===r.blinkers)for(g=0;g<this._blinkers.length;g++)this._blinkers[g].addToScene(f,r.lightSources),this._initialBlinkTime>=0?this._blinkers[g].setTime(this._initialBlinkTime):a.randomAnimationTime&&(0===g?N=this._blinkers[g].setRandomTime():this._blinkers[g].setTime(N));this._away&&(this._away=!1,this.setAway(!0)),d&&d(I)}},Spacecraft.prototype.addToScene=function(e,t,i,n,s,o,r,l){var c,h,d,p;if(!s.skipResources){if(this.acquireResources(!0===n.hitboxes,{omitShader:!!s.shaderName,explosion:n.explosion,damageIndicators:n.damageIndicators,blinkers:n.blinkers,sound:n.sound}),s.shaderName&&u.getShader(s.shaderName),!0===n.weapons)for(d={omitShader:!!s.shaderName,projectileResources:n.projectileResources,sound:n.sound},c=0;c<this._ws.length;c++)this._ws[c].acquireResources(d);if(!0===n.missileResources)for(p={omitShader:!!s.shaderName,missileOnly:!1,sound:n.sound,trail:!0},c=0;c<this._mLs.length;c++)this._mLs[c].acquireResources(p);else if(!0===n.missilesInLaunchers)for(p={omitShader:!!s.shaderName,missileOnly:!0,sound:n.sound},c=0;c<this._mLs.length;c++)this._mLs[c].acquireResources(p);if(!0===n.thrusterParticles&&this._propulsion&&(this._propulsion.addThrusters(this._class._thrusterSlots),this._propulsion.acquireResources({sound:n.sound})),!0===n.jumpEngine&&this._jumpEngine&&this._jumpEngine.acquireResources({sound:n.sound}),!0===n.shield&&this._shield&&this._shield.acquireResources({sound:n.sound}),!0===n.explosion&&this._class._explosionClass.acquireResources({sound:n.sound}),!0===n.blinkers)for(h=this._class._blinkerDescriptors,c=0;c<h.length;c++)h[c].acquireResources()}a.executeWhenReady(this.addToSceneNow.bind(this,e,t,i,n,s,o,r,l))},Spacecraft.prototype.createCameraConfigurationForView=function(e){
return e.createCameraConfiguration(this.vMo,_.getDefaultCameraBaseOrientation(),_.getDefaultCameraPointToFallback(),_.getDefaultCameraFOV(),_.getDefaultCameraSpan())},Spacecraft.prototype._addCameraConfigurationsForViews=function(){var e;for(e=0;e<this._class._views.length;e++)this.vMo._node.addCameraConfiguration(this.createCameraConfigurationForView(this._class._views[e]))},Spacecraft.prototype._updateScoreValue=function(){var e;for(this._scoreValue=this._class.getScoreValue(),e=0;e<this._ws.length;e++)this._scoreValue+=this._ws[e].getScoreValue();for(e=0;e<this._mLs.length;e++)this._scoreValue+=this._mLs[e].getScoreValue();this._propulsion&&(this._scoreValue+=this._propulsion.getScoreValue()),this._scoreValue+=this._sensorsScoreValue,this._shield&&(this._scoreValue+=this._shield.getScoreValue())},Spacecraft.prototype._addWeapon=function(e,t){var i,n=this._class._wSlots;(void 0===t||t<0)&&(t=this._ws.length),t<n.length&&(i=n[t],this._ws.push(new y.Weapon(e,this,i)))},Spacecraft.prototype._setActiveMissileLauncherIndex=function(e){this._activeMissileLauncherIndex=e,this._tC.setMissileLauncher(this._activeMissileLauncherIndex>=0?this._mLs[this._activeMissileLauncherIndex]:null)},Spacecraft.prototype._addMissiles=function(e,t,i){var n,s=this._class._mLs;(void 0===i||i<0)&&(i=this._mLs.length),i<s.length&&(n=s[i],this._mLs.push(new y.MissileLauncher(e,this,n,t)),this._activeMissileLauncherIndex<0&&this._setActiveMissileLauncherIndex(0),this._mClasses.indexOf(e)<0&&this._mClasses.push(e))},Spacecraft.prototype._addPropulsion=function(e){this._propulsion=new y.Propulsion(e,this.pMo),this._mC.updateForNewPropulsion(),this._mC.updateTurningLimit(),this._topSpeed=r.getDrag()&&this._class._dragFactor?Math.sqrt(this.getMaxAcceleration()/(r.getDrag()*this._class._dragFactor)):0,this._updateBurnNeedFactors()},Spacecraft.prototype._addSensors=function(e){this._tC.updateSensors(e),this._sensorsScoreValue=e.getScoreValue()},Spacecraft.prototype._addJumpEngine=function(e){this._jumpEngine=new y.JumpEngine(e,this)},Spacecraft.prototype._addShield=function(e){this._shield=new y.Shield(e,this)},Spacecraft.prototype.unequip=function(){var e;for(e=0;e<this._ws.length;e++)this._ws[e].destroy();for(this._ws=[],e=0;e<this._mLs.length;e++)this._mLs[e].destroy();this._mLs=[],this._mClasses=[],this._setActiveMissileLauncherIndex(-1),this._propulsion&&this._propulsion.destroy(),this._propulsion=null,this._mC.updateForNewPropulsion(),this._mC.updateTurningLimit(),this._tC.updateSensors(),this._sensorsScoreValue=0,this._updateScoreValue()},Spacecraft.prototype.equipLoadout=function(e){var t,i,n;if(e){for(i=e._wDescriptors,t=0;t<i.length;t++)this._addWeapon(p.getWeaponClass(i[t].className),i[t].slotIndex);for(n=e._mDescriptors,t=0;t<n.length;t++)this._addMissiles(p.getMissileClass(n[t].className),n[t].amount,n[t].launcherIndex);null!==e._propulsionDescriptor&&this._addPropulsion(p.getPropulsionClass(e._propulsionDescriptor.className)),null!==e._sensorsDescriptor&&this._addSensors(p.getSensorsClass(e._sensorsDescriptor.className)),null!==e._jumpEngineDescriptor&&this._addJumpEngine(p.getJumpEngineClass(e._jumpEngineDescriptor.className)),null!==e._shieldDescriptor&&this._addShield(p.getShieldClass(e._shieldDescriptor.className))}this._updateScoreValue()},Spacecraft.prototype.getLoadoutNames=function(){return this._class.getLoadoutNames()},Spacecraft.prototype.getSoundSourceForFireSound=function(){var e;return e=this.getPositionMatrixInCameraSpace(),Math.abs(e[12])<=M&&Math.abs(e[13])<=M&&Math.abs(e[14])<=M?null:this._soundSource},Spacecraft.prototype.fire=function(e){var t,i,n,s,o=!1;if(!this._firingDisabled&&!this._isJumping){for(i=this.getScaledOriMatrix(),s=this.getSoundSourceForFireSound(),t=0;t<this._ws.length;t++)n=this._ws[t].fire(i,e,s),o=n>0||o,this._shotsFired+=n;if(o){for(t=0;t<this._tedBy.length;t++)this._tedBy[t].handleEvent(T.TARGET_FIRED);this.handleEvent(T.FIRED)}this._guestPiloted||(this._fired=!0)}},Spacecraft.prototype.requestFire=function(e){this._guestPiloted?this._fired=!0:this.fire(e)},Spacecraft.prototype._autoChangeMissileLauncher=function(){var e,t,i;e=this._activeMissileLauncherIndex,t=this._mLs[e]._class,i=this._mLs[e]._salvo;do{this._activeMissileLauncherIndex=(this._activeMissileLauncherIndex+1)%this._mLs.length}while(this._activeMissileLauncherIndex!==e&&(!this._mLs[this._activeMissileLauncherIndex].hasMissilesLeftToLaunch()||this._mLs[this._activeMissileLauncherIndex]._class!==t));if(this._activeMissileLauncherIndex===e&&!this._mLs[e].hasMissilesLeftToLaunch())do{this._activeMissileLauncherIndex=(this._activeMissileLauncherIndex+1)%this._mLs.length}while(this._activeMissileLauncherIndex!==e&&!this._mLs[this._activeMissileLauncherIndex].hasMissilesLeftToLaunch());this._activeMissileLauncherIndex===e?this._mLs[e].getMissileCount()<=0&&this._setActiveMissileLauncherIndex(-1):(this._setActiveMissileLauncherIndex(this._activeMissileLauncherIndex),this._mLs[this._activeMissileLauncherIndex]._class===t?this._mLs[this._activeMissileLauncherIndex].setSalvoMode(i):(this._mLs[this._activeMissileLauncherIndex].setMinimumCooldown(500),_.getBattleSetting(_.BS.DEFAULT_SALVO_MODE)&&this._mLs[this._activeMissileLauncherIndex].setSalvoMode(!0),m.playMissileChangeSound()))},Spacecraft.prototype.launchMissile=function(){var e,t,i;if(!this._firingDisabled&&!this._isJumping&&this._activeMissileLauncherIndex>=0&&this._tC.isMissileLocked()){if(t=this.getScaledOriMatrix(),i=this._mLs[this._activeMissileLauncherIndex].launch(t,this.getSoundSourceForFireSound(),!1)){for(this._msLaunched++,e=0;e<this._tedBy.length;e++)this._tedBy[e].handleEvent(T.TARGET_FIRED);this.handleEvent(T.FIRED),this._autoChangeMissileLauncher()}return i}return null},Spacecraft.prototype.handleSalvoMissileLaunched=function(){this._msLaunched++,this._activeMissileLauncherIndex>=0&&this._mLs[this._activeMissileLauncherIndex].getMissileCount()<=0&&this._autoChangeMissileLauncher()},Spacecraft.prototype.changeMissile=function(){var e,t,i;if(this._activeMissileLauncherIndex>=0){e=this._activeMissileLauncherIndex,t=this._mLs[e]._class;do{this._activeMissileLauncherIndex=(this._activeMissileLauncherIndex+1)%this._mLs.length}while(this._activeMissileLauncherIndex!==e&&(!this._mLs[this._activeMissileLauncherIndex].hasMissilesLeftToLaunch()||this._mLs[this._activeMissileLauncherIndex]._class===t));return i=this._activeMissileLauncherIndex!==e,i&&(this._setActiveMissileLauncherIndex(this._activeMissileLauncherIndex),_.getBattleSetting(_.BS.DEFAULT_SALVO_MODE)&&this._mLs[this._activeMissileLauncherIndex].setSalvoMode(!0)),i}return!1},Spacecraft.prototype.toggleSalvo=function(){return this._activeMissileLauncherIndex>=0&&this._mLs[this._activeMissileLauncherIndex].toggleSalvoMode()},Spacecraft.prototype.getActiveMissileLauncher=function(){return this._activeMissileLauncherIndex>=0?this._mLs[this._activeMissileLauncherIndex]:null},Spacecraft.prototype.getMissileCount=function(e){var t,i=0;for(t=0;t<this._mLs.length;t++)this._mLs[t]._class===e&&(i+=this._mLs[t].getMissileCount());return i},Spacecraft.prototype.increaseHitsOnEnemies=function(e){e?this._mHitsOnEnemies++:this._hitsOnEnemies++},Spacecraft.prototype.setBeingTargeted=function(e){this._tedBy&&(this._tedBy.push(e),this.handleEvent(T.BEING_TARGETED,{spacecraft:e}))},Spacecraft.prototype.setBeingUntargeted=function(e){this._tedBy&&this._tedBy.splice(this._tedBy.indexOf(e),1)},Spacecraft.prototype.setTarget=function(e){this._tC.setTarget(e)},Spacecraft.prototype.targetNextNearestHostile=function(){return this._tC.targetNextNearestHostile()},Spacecraft.prototype.targetPreviousNearestHostile=function(){return this._tC.targetPreviousNearestHostile()},Spacecraft.prototype.targetNextBestHostile=function(){return this._tC.targetNextBestHostile()},Spacecraft.prototype.targetNextNearestNonHostile=function(){return this._tC.targetNextNearestNonHostile()},Spacecraft.prototype.getTarget=function(){return this._tC.getTarget()},Spacecraft.prototype.getTargetHitPosition=function(){return this._tC.getTargetHitPosition()},Spacecraft.prototype.getMissileLockRatio=function(){return this._tC.getMissileLockRatio()},Spacecraft.prototype.getPropulsionDisplayName=function(){return this._propulsion.getDisplayName()},Spacecraft.prototype.resetThrusterBurn=function(){this._propulsion.resetThrusterBurn()},Spacecraft.prototype.addThrusterBurn=function(e,t){this._propulsion.addThrusterBurn(e,t)},Spacecraft.prototype.updatePropulsionVisuals=function(){this._propulsion.updateVisuals()},Spacecraft.prototype.isInSensorRange=function(e){return this._tC.isInRange(e)},Spacecraft.prototype.showHitbox=function(){this._hitbox.show()},Spacecraft.prototype.hideHitbox=function(){this._hitbox.hide()},Spacecraft.prototype.toggleHitboxVisibility=function(){this._hitbox.toggleVisibility()},Spacecraft.prototype.resetViewCameras=function(){this.vMo._node.resetCameraConfigurations()},Spacecraft.prototype.damage=function(e,n,s,o,r,a,l){var c,h,u,d,p,_,g,m,S,y;if(c=this._hitpoints,this._shield&&(e=this._shield.damage(e,N)),e=Math.max(0,e-this._class._armor),_=this._hitpoints>0,this._hitpoints-=e,this._hitpoints<=0)N||_&&o&&this.isHostile(o)&&(g=this.getScoreValue(),e+=this._hitpoints,o.gainDamageDealt(e,r),o.gainScore((1-I)*e/this._maxHitpoints*g),o.gainScore(I*g),o.gainKill(),f.isInGame()&&f.registerPlayerKill(o.getID(),this.getID())),this._hitpoints=0;else{for(h=this._activeDamageIndicators.length;h<this._class._damageIndicators.length;h++)u=this._class._damageIndicators[h],d=u.hullIntegrity/100*this._maxHitpoints,this._hitpoints<=d&&this._hitpoints+e>d&&(a>0?(m=[0,0,0,1],y=this.pMo.getBodySize(),t.setSum3(m,n,t.scaled3Aux(s,-y)),m=this.pMo.checkHitRelative(m,t.scaled3(s,-1),y,0),m||(S=t.scaled3(n,-1),y=t.extractLength3(S),m=this.pMo.checkHitRelative(t.NULL4W1,S,y,0)),!m||t.length3Squared(m,n)<.01?m=n:S&&(s=t.scaled3(S,-1))):m=n,p=E.getExplosion(),p.init(u.explosionClass,i.translation4vAux(m),i.IDENTITY4,s,!0),p.addToSceneNow(this.vMo._node,this._soundSource),this._activeDamageIndicators.push(p));N||_&&o&&o._alive&&this.isHostile(o)&&(o.gainDamageDealt(e,r),o.gainScore((1-I)*e/this._maxHitpoints*this.getScoreValue()))}this._hitData.spacecraft=o,this._hitData.hitPosition=n,this._hitData.hullDamage=e,l?this.handleEvent(T.COLLIDED,this._hitData):(this.handleEvent(T.BEING_HIT,this._hitData),o._alive&&!o._away&&(o.getTarget()===this&&o.handleEvent(T.TARGET_HIT),o.handleEvent(T.ANY_SPACECRAFT_HIT,this._anySpacecraftHitData))),N?this._hitpoints=c:!l&&this.isHostile(o)&&o.increaseHitsOnEnemies(r)},Spacecraft.prototype.aimWeapons=function(e,t,i){var n,s,o=this.getTarget();for(o&&this._ws.length>0&&(n=this.getTargetHitPosition()),s=0;s<this._ws.length;s++)!o||this._firingDisabled||this._isJumping?this._ws[s].rotateToDefaultPosition(e,i):this._ws[s].aimTowards(n,e,t,this.getScaledOriMatrix(),i)},Spacecraft.prototype.setJumping=function(e){this._isJumping=e},Spacecraft.prototype.jumpOut=function(e){!this._away&&this._jumpEngine&&this._jumpEngine.jumpOut(e)},Spacecraft.prototype.jumpIn=function(){this._away&&this._jumpEngine&&this._jumpEngine.jumpIn()},Spacecraft.prototype._startHumSound=function(){this._humSoundClip.setVolume(0),this._humSoundClip.play(),this._humSoundClip.rampVolume(this._humSoundVolume,.02,!0,!0)},Spacecraft.prototype.playCollisionSound=function(e){this._timeSinceCollisionSoundPlayed>=250&&(this._class.playCollisionSound(e),this._timeSinceCollisionSoundPlayed=0)},Spacecraft.prototype.respawn=function(e){var t;for(this._alive=!0,this._hitpoints=this._maxHitpoints,this._timeElapsedSinceDestruction=-1,this._humSoundClip&&this._startHumSound(),t=0;t<this._blinkers.length;t++)e?this._blinkers[t].setRandomTime():this._blinkers[t].setTime(0)},Spacecraft.prototype.setHitpointsToZero=function(){this._hitpoints=0},Spacecraft.prototype._updateDamageIndicators=function(){var e,t,i;for(e=this._activeDamageIndicators.length-1,t=this._class._damageIndicators;e>=0&&this._hitpoints>t[e].hullIntegrity/100*this._maxHitpoints;)e--;for(i=e+1;e<this._activeDamageIndicators.length-1;)e++,this._activeDamageIndicators[e].finish();this._activeDamageIndicators.length=i},Spacecraft.DEFAULT_SIMULATE_PARAMS={controlThrusters:!0,applyThrusterForces:!0},Spacecraft.prototype.simulate=function(e,n){var s,o,r;if(this._alive&&!this._away){if(n=n||Spacecraft.DEFAULT_SIMULATE_PARAMS,this._tC.simulate(e),o=this.getPositionMatrixInCameraSpace(),this._soundSource.updatePosition(.1*Math.round(10*o[12]),.1*Math.round(10*o[13]),.1*Math.round(10*o[14])),this._hitpoints<=0){if(this._timeElapsedSinceDestruction<0){for(this._timeElapsedSinceDestruction=0,this._humSoundClip&&this._humSoundClip.stopPlaying(d.SOUND_RAMP_DURATION),this._propulsion&&(this._propulsion.resetThrusterBurn(),this._propulsion.simulate(0,this._soundSource,!1)),this._explosion=E.getExplosion(),this._explosion.init(this._class._explosionClass,this.pMo.pM,this.pMo.oM,t.getRowC43Aux(this.pMo.pM),!0,!0,this.pMo._velocityMatrix),this._explosion.addToScene(this.vMo._node.getScene()._rootNode,this._soundSource),s=0;s<this._activeDamageIndicators.length;s++)this._activeDamageIndicators[s].finish();this._activeDamageIndicators.length=0,r=i.matrix4Aux(this.pMo._velocityMatrix),this.pMo.reset(),this.pMo.setVelocity(r[12],r[13],r[14])}else if(this._timeElapsedSinceDestruction+=e,this._timeElapsedSinceDestruction>this._class._explosionClass.getTotalDuration()*this._class._showTimeRatioDuringExplosion)return this._alive=!1,void(!1!==this.handleEvent(T.DESTRUCTED)&&this.destroy(!0))}else{for(s=0;s<this._ws.length;s++)this._ws[s].simulate(e);for(s=0;s<this._mLs.length;s++)this._mLs[s].simulate(e),this._activeMissileLauncherIndex<0&&this._mLs[s].hasMissilesLeftToLaunch()&&this._setActiveMissileLauncherIndex(s);this._propulsion&&(n.controlThrusters&&this._mC.controlThrusters(e,this._multiControlled),this._propulsion.simulate(e,this._soundSource,n.applyThrusterForces)),this._jumpEngine&&this._jumpEngine.simulate(e),this._shield&&this._shield.simulate(e,N),this._class.hasHumSound()&&(this._humSoundClip||(this._humSoundClip=this._class.createHumSoundClip(this._soundSource),this._humSoundVolume=this._humSoundClip.getVolume(),this._humSoundClip&&this._startHumSound())),this._timeSinceCollisionSoundPlayed<250&&(this._timeSinceCollisionSoundPlayed+=e)}this.pMo.simulate(e),this._relativeVelocityMatrixValid=!1,this._turningMatrixValid=!1,this.updateScaledOriMatrix(),this.vMo.setPositionMatrix(this.pMo.pM),this.vMo.setOrientationMatrix(this.pMo.oM),this._propulsion&&this._mC.updateSpeedIncrement(e)}},Spacecraft.prototype.addEventHandler=function(e,t){this._eventHandlers[e]=this._eventHandlers[e]||[],this._eventHandlers[e].push(t)},Spacecraft.prototype.handleEvent=function(e,t){var i,n;if(this._eventHandlers&&this._eventHandlers[e])for(n=!0,i=0;i<this._eventHandlers[e].length;i++)n=this._eventHandlers[e][i](t)&&n;return n},Spacecraft.prototype.getMaxProjectileCount=function(){var e,t=0;for(e=0;e<this._ws.length;e++)t+=this._ws[e].getMaxProjectileCount();return t},Spacecraft.prototype.getMaxMissileCount=function(){var e,t=0;for(e=0;e<this._mLs.length;e++)t+=this._mLs[e].getMaxMissileCount();return t},Spacecraft.prototype.getMaxExplosionCount=function(){var e,t=0;for(t+=1,t+=this._class._damageIndicators.length,e=0;e<this._ws.length;e++)t+=this._ws[e].getMaxExplosionCount();for(e=0;e<this._mLs.length;e++)t+=this._mLs[e].getMaxExplosionCount();return t},Spacecraft.prototype.getMaxParticleCount=function(){var e,t,i=0;for(i+=this._class._explosionClass.getMaxParticleCount(),t=this._class._damageIndicators,e=0;e<t.length;e++)i+=t[e].explosionClass.getMaxParticleCount();for(e=0;e<this._ws.length;e++)i+=this._ws[e].getMaxParticleCount();for(e=0;e<this._mLs.length;e++)i+=this._mLs[e].getMaxParticleCount();return i},Spacecraft.prototype.getLockingTimeFactor=function(){return this._class.getLockingTimeFactor()},Spacecraft.prototype.toggleSpotLights=function(){var e;if(this._spotLights.length>0)if(this._spotLights[0].isVisible())for(e=0;e<this._spotLights.length;e++)this._spotLights[e].hide();else for(e=0;e<this._spotLights.length;e++)this._spotLights[e].show()},Spacecraft.prototype.getMultiHostData=function(){var e,t,i;return this._alive?(e=this.pMo.pM,t=this.pMo.oM,i=this.pMo._velocityMatrix,this._multiHostData[0]=e[12],this._multiHostData[1]=e[13],this._multiHostData[2]=e[14],this._multiHostData[3]=t[4],this._multiHostData[4]=t[5],this._multiHostData[5]=t[6],this._multiHostData[6]=t[8],this._multiHostData[7]=t[9],this._multiHostData[8]=t[10],this._multiHostData[9]=this.getHullIntegrity(),this._multiHostData[10]=this.getShieldIntegrity(),this._multiHostData[11]=this._fired?1:0,this._multiHostData[12]=i[12],this._multiHostData[13]=i[13],this._multiHostData[14]=i[14],this._multiHostData[15]=i[0],this._multiHostData[16]=i[1],this._multiHostData[17]=i[2],this._multiHostData[18]=i[4],this._multiHostData[19]=i[5],this._multiHostData[20]=i[6],this._multiHostData[21]=i[8],this._multiHostData[22]=i[9],this._multiHostData[23]=i[10],this._multiHostData[24]=this._mC.getSpeedTarget(),this._multiHostData[25]=this._mC._lastStrafeTarget,this._multiHostData[26]=this._mC._lastLiftTarget,this._multiHostData[27]=this._mC._lastYawTarget,this._multiHostData[28]=this._mC._lastPitchTarget,this._multiHostData[29]=this._mC._lastRollTarget,this._fired=!1,this._multiHostData):this._multiHostData},Spacecraft.prototype.applyMultiHostData=function(e,t){this._alive&&(this.pMo.setPosition(e[t],e[t+1],e[t+2]),this.pMo.setOrientation(e[t+3],e[t+4],e[t+5],e[t+6],e[t+7],e[t+8]),this.setHullIntegrity(e[t+9]),this.setShieldIntegrity(e[t+10]),e[t+11]&&this.fire(!1),this.pMo.setVelocity(e[t+12],e[t+13],e[t+14]),this.pMo.setAngularVelocity(e[t+15],e[t+16],e[t+17],e[t+18],e[t+19],e[t+20],e[t+21],e[t+22],e[t+23]),this._multiControlled&&(this._mC.setSpeedTarget(e[t+24]),this._mC._strafeTarget=e[t+25],this._mC._liftTarget=e[t+26],this._mC._rollTarget=e[t+29],this._mC._yawTarget=e[t+27],this._mC._pitchTarget=e[t+28]))},Spacecraft.prototype.getMultiGuestData=function(){return this._alive?(this._multiGuestData[1]=this._mC.getSpeedTarget(),this._multiGuestData[2]=this._mC._lastStrafeTarget,this._multiGuestData[3]=this._mC._lastLiftTarget,this._multiGuestData[4]=this._mC._lastYawTarget,this._multiGuestData[5]=this._mC._lastPitchTarget,this._multiGuestData[6]=this._mC._lastRollTarget,this._multiGuestData[7]=this._fired?1:0,this._fired=!1,this._multiGuestData):this._multiGuestData},Spacecraft.prototype.applyMultiGuestData=function(e){this._alive&&(this._mC.setSpeedTarget(e[1]),this._mC._strafeTarget=e[2],this._mC._liftTarget=e[3],this._mC._yawTarget=e[4],this._mC._pitchTarget=e[5],this._mC._rollTarget=e[6],e[7]&&this.fire(!1))},Spacecraft.prototype.destroy=function(e){var t;if(e||(this._class=null),this._ws)for(t=0;t<this._ws.length;t++)this._ws[t]&&(this._ws[t].destroy(),this._ws[t]=null);if(this._ws=null,this._mLs)for(t=0;t<this._mLs.length;t++)this._mLs[t]&&(this._mLs[t].destroy(),this._mLs[t]=null);this._mLs=null,this._mClasses=null,this._propulsion&&(this._propulsion.destroy(),this._propulsion=null),this._jumpEngine&&(this._jumpEngine.destroy(),this._jumpEngine=null),this._shield&&(this._shield.destroy(),this._shield=null),this._mC&&(this._mC.destroy(),this._mC=null),this._tC&&(this._tC.destroy(),this._tC=null),this._tedBy=null,this._eventHandlers=null,this._explosion=null,this._hitbox&&this._hitbox.markAsReusable(!0),this._hitbox=null,this.vMo&&this.vMo._node&&!this.vMo._node.canBeReused()&&this.vMo._node.markAsReusable(!0),this.vMo=null,this._spotLights=null,this.pMo=null,this._activeDamageIndicators&&(this._activeDamageIndicators=null),this._alive=!1,this._humSoundClip&&(this._humSoundClip.destroy(),this._humSoundClip=null),this._soundSource&&(this._soundSource=null)},_.executeWhenReady(function(){O="luminosityFactors",R=_.getSetting(_.GENERAL_SETTINGS.UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME),C=_.getSetting(_.BS.HITBOX_COLOR),M=100,I=.5,u.executeWhenReady(handleGraphicsSettingsChanged),u.onSettingsChange(handleGraphicsSettingsChanged)}),{MULTI_HOST_DATA_LENGTH:x,MULTI_GUEST_DATA_LENGTH:v,setMultiGuest:setMultiGuest,getSquadName:getSquadName,getSquadIndex:getSquadIndex,Spacecraft:Spacecraft}}),define("armada/logic/ai",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/physics","armada/configuration","armada/logic/SpacecraftEvents","armada/logic/classes","armada/logic/equipment","armada/logic/formations","utils/polyfill"],function(e,t,i,n,s,o,r,a,l,c){"use strict";function getAITypes(){return Object.keys(_)}function resetJumpInPositionSeed(){h=Math.seed(4718)}function resetRandomSeeds(){resetJumpInPositionSeed(),u=Math.seed(4718),d=Math.seed(4718),p=Math.seed(4718)}function positionForInwardJump(n,s,o){var r;if(s.lead&&s.index>0&&s.jump.formation)n.setPhysicalPosition(c.getPositionInFormation(s.jump.formation,s.index,s.lead.getPhysicalPositionVector(),s.lead.pMo.oM)),n.updatePhysicalOrientationMatrix(s.lead.pMo.oM);else if(s.jump.anchor)if(s.clearCache&&(s.jump.anchorSpacecraft=null,s.clearCache=!1),r=s.jump.anchorSpacecraft||o.getSpacecraft(s.jump.anchor))s.jump.anchorSpacecraft=r,s.jump.distance?(n.updatePhysicalOrientationMatrix(i.prod3x3SubOf4Aux(i.rotationX4Aux((h()-.5)*Math.PI),i.rotationZ4Aux(h()*e.DOUBLE_PI))),n.setPhysicalPosition(t.getRowB43ScaledAux(n.pMo.oM,-s.jump.distance))):(s.jump.position&&n.setPhysicalPosition(s.jump.position),s.jump.rotations&&n.updatePhysicalOrientationMatrix(i.rotation4FromJSON(s.jump.rotations))),s.jump.relative&&(n.setPhysicalPosition(t.prodTranslationRotation3Aux(n.pMo.pM,r.pMo.oM)),n.updatePhysicalOrientationMatrix(i.prod3x3SubOf4Aux(n.pMo.oM,r.pMo.oM))),n.setPhysicalPosition(t.sum3Aux(n.getPhysicalPositionVector(),r.getPhysicalPositionVector()));else{if(!s.jump.fallbackPosition)return!1;n.setPhysicalPosition(s.jump.fallbackPosition),s.jump.fallbackRotations&&n.updatePhysicalOrientationMatrix(i.rotation4FromJSON(s.jump.fallbackRotations))}return!0}function SpacecraftAI(e,t){this._sc=e,this._mission=t,this._standingDown=!1,this._tList=null,this._priorityTargets=!1,this._hitCountByNonTarget=0,this._wRange=this._sc&&this._sc._ws.length>0?this._sc._ws[0].getRange(0):0,this._attackingTarget=!1,this._moveCommand=T.NONE,this._moveCommandTarget=null,this._moveCommandMinDistance=0,this._moveCommandMaxDistance=0,this._sc&&(this._sc.setSpeedHolding(!0),this._sc.addEventHandler(r.BEING_HIT,this._handleBeingHit.bind(this)),this._sc.addEventHandler(r.COMMAND_RECEIVED,this._handleCommand.bind(this)))}function FighterAI(e,t){var i=t._pilotedCraft&&t._pilotedCraft.isHostile(e)?t.getDifficultyLevel()._enemyReactionTimeFactor:1;SpacecraftAI.call(this,e,t),this._timeSinceLastRoll=0,this._timeSinceLastTargetHit=0,this._timeSinceLastClosingIn=0,this._evasiveManeuverDelayLeft=0,this._evasiveManeuverDelay=x*i,this._evasiveManeuverTime=-1,this._evasiveVelocityVector=[0,0],this._rollTime=-1,this._chargePhase=S.NONE,this._chargeDestination=[0,0,0],this._maxDistanceFactor=C,this._isBlockedBy=null,this._facingTarget=!1,this._tDistance=0,this._tOffset=[0,0,0],this._tOffsetUpdateTimeLeft=0,this._maxAimError=0,this._aimError=[0,0],this._fireDelayLeft=0,this._fireDelay=A*i,this._msOnTarget=[],this._sc.addEventHandler(r.TARGET_HIT,this._handleTargetHit.bind(this)),this._sc.addEventHandler(r.ANY_SPACECRAFT_HIT,this._handleAnySpacecraftHit.bind(this)),this._sc.addEventHandler(r.TARGET_FIRED,this._handleTargetFired.bind(this))}function ShipAI(e,t){SpacecraftAI.call(this,e,t)}function StationAI(e,t,i){SpacecraftAI.call(this,e,t),this._shouldTurn=!!i}function SentryAI(e,t){StationAI.call(this,e,t,!0)}function AIContext(){this._ais=[]}var h,u,d,p,_,g,m={JUMP:"jump",TARGET:"target",STAND_DOWN:"standDown",REACH_DISTANCE:"reachDistance",CANCEL_MOVE:"cancelMove"},f={IN:"in",OUT:"out"},S={NONE:-1,APPROACH_ATTACK:0,EVADE:1},T={NONE:-1,REACH_DISTANCE:0},y=1e3/s.ANGULAR_VELOCITY_MATRIX_DURATION,E=Math.radians(45),C=.3,M=Math.radians(45),I=Math.radians(2),A=350,x=200,v=0,O=0,R={yaw:0,pitch:0,roll:0},b=[0,0,0],L=[0,0,0];return SpacecraftAI.prototype.turn=function(e,i,n){var s,o,r,a,l;s=this._sc.getTurningMatrix(),r=this._sc.getMaxAngularAcceleration(),l=O/(r*n),o=Math.sign(s[4])*t.angle2y(s[4],s[5])*y,a=Math.max(o*o/(2*r),.002),e>a?this._sc.yawLeft(Math.min(Math.max(0,l*(e-a)),1)):e<-a&&this._sc.yawRight(Math.min(Math.max(0,l*(-e-a)),1)),o=Math.sign(s[6])*t.angle2x(s[5],s[6])*y,a=Math.max(o*o/(2*r),.002),i>a?this._sc.pitchUp(Math.min(Math.max(0,l*(i-a)),1)):i<-a&&this._sc.pitchDown(Math.min(Math.max(0,l*(-i-a)),1))},SpacecraftAI.prototype.rollAndYaw=function(e,i,n){var s,o,r,a,l;s=this._sc.getTurningMatrix(),r=this._sc.getMaxAngularAcceleration(),l=O/(r*n),o=Math.sign(s[2])*t.angle2x(s[0],s[2])*y,a=Math.max(o*o/(2*r),.002),e>a?this._sc.rollLeft(Math.min(Math.max(0,l*(e-a)),1)):e<-a&&this._sc.rollRight(Math.min(Math.max(0,l*(-e-a)),1)),o=Math.sign(s[4])*t.angle2y(s[4],s[5])*y,a=Math.max(o*o/(2*r),.002),i>a?this._sc.yawLeft(Math.min(Math.max(0,l*(i-a)),1)):i<-a&&this._sc.yawRight(Math.min(Math.max(0,l*(-i-a)),1))},SpacecraftAI.prototype.rollAndPitch=function(e,i,n){var s,o,r,a,l;s=this._sc.getTurningMatrix(),r=this._sc.getMaxAngularAcceleration(),l=O/(r*n),o=Math.sign(s[2])*t.angle2x(s[0],s[2])*y,a=Math.max(o*o/(2*r),.002),e>a?this._sc.rollLeft(Math.min(Math.max(0,l*(e-a)),1)):e<-a&&this._sc.rollRight(Math.min(Math.max(0,l*(-e-a)),1)),o=Math.sign(s[6])*t.angle2x(s[5],s[6])*y,a=Math.max(o*o/(2*r),.002),i>a?this._sc.pitchUp(Math.min(Math.max(0,l*(i-a)),1)):i<-a&&this._sc.pitchDown(Math.min(Math.max(0,l*(-i-a)),1))},SpacecraftAI.prototype.approach=function(e,t,i,n){var s,o;s=this._sc.getRelativeVelocityMatrix()[13],o=s*s/(2*this._sc.getMaxAcceleration()),s<0&&(o=-o),e-o>t?this._sc.setSpeedTarget(n):i>=0&&e-o<i?this._sc.setSpeedTarget(-n):this._sc.resetSpeed()},SpacecraftAI.prototype.orientToAttackPosition=function(i,n){var s,o,r,l;switch(s=this._sc.getClass()._attackVectorAngles,o=this._sc.getClass()._attackThresholdAngle,this._sc.getClass()._turnStyle){case a.SpacecraftTurnStyle.YAW_PITCH:(Math.abs(R.yaw-s[0])>o||Math.abs(R.pitch-s[1])>o)&&this.turn(R.yaw-s[0],R.pitch-s[1],n);break;case a.SpacecraftTurnStyle.ROLL_YAW:t.getRollAndYaw(R,i,!0),r=R.roll-s[0],l=R.yaw-s[1],(Math.abs(r)>o||Math.abs(l)>o)&&(Math.abs(l)>e.HALF_PI?r=0:Math.abs(r)>e.HALF_PI&&(l=0),this.rollAndYaw(r,l,n));break;case a.SpacecraftTurnStyle.ROLL_PITCH:t.getRollAndPitch(R,i,!0),r=R.roll-s[0],l=R.pitch-s[1],(Math.abs(r)>o||Math.abs(l)>o)&&(Math.abs(l)>e.HALF_PI?r=0:Math.abs(r-Math.sign(r)*Math.PI)<Math.abs(r)&&(r-=Math.sign(r)*Math.PI,R.pitch=-R.pitch),this.rollAndPitch(r,R.pitch-s[1],n))}},SpacecraftAI.prototype._handleTargetSwitch=function(){this._hitCountByNonTarget=0},SpacecraftAI._tListFilterFunction=function(e){return e._alive},SpacecraftAI.prototype._updateTarget=function(e){var t,i;if(this._standingDown)return void this._sc.setTarget(null);if(i=this._sc.getTarget(),this._tList&&(this._tList=this._tList.filter(SpacecraftAI._tListFilterFunction)),this._tList&&this._tList.length>0){if(this._priorityTargets){if(e)this._tList.indexOf(e)>=0&&this._sc.setTarget(e);else if(!i||this._tList.indexOf(i)<0){for(t=0;t<this._tList.length;t++)if(!this._tList[t]._away){this._sc.setTarget(this._tList[t]);break}!i&&t>=this._tList.length&&this._sc.targetNextBestHostile()}}else if(e)this._sc.setTarget(e);else if(!i){for(t=0;t<this._tList.length;t++)if(!this._tList[t]._away){this._sc.setTarget(this._tList[t]);break}t>=this._tList.length&&this._sc.targetNextBestHostile()}}else e?this._sc.setTarget(e):i||this._sc.targetNextBestHostile();this._sc.getTarget()!==i&&this._handleTargetSwitch()},SpacecraftAI.prototype._handleBeingHit=function(e){var t=e.spacecraft;this._sc&&this._sc._alive&&t._alive&&!t._away&&t.isHostile(this._sc)&&this._sc.getTarget()&&this._sc.getTarget()!==t&&(this._sc.getTarget().getTarget()===this._sc&&this._attackingTarget||this._updateTarget(t),this._hitCountByNonTarget++)},SpacecraftAI.prototype._handleCommand=function(e){var t,i;switch(e.command){case m.JUMP:if((e.jump&&e.jump.way?e.jump.way:this._sc._away?f.IN:f.OUT)===f.IN){if(this._sc._away){if(e.jump&&!positionForInwardJump(this._sc,e,this._mission))break;this._sc.jumpIn()}}else this._sc.jumpOut(!1);break;case m.TARGET:if(e.target){if(e.clearCache&&(e.target.targetSpacecrafts=null,e.clearCache=!1),e.target.targetSpacecrafts)this._tList=e.target.targetSpacecrafts.slice();else{if(e.target.single)(i=this._mission.getSpacecraft(e.target.single))&&(this._tList=[i]);else if(e.target.list)for(this._tList=[],t=0;t<e.target.list.length;t++)(i=this._mission.getSpacecraft(e.target.list[t]))&&this._tList.push(i);else if(e.target.squads)for(this._tList=[],t=0;t<e.target.squads.length;t++)this._tList=this._tList.concat(this._mission.getSpacecraftsInSquad(e.target.squads[t]));else e.target.none?this._tList=null:n.showError("'"+this._sc.getDisplayName()+"' has no target specified for targeting command!");this._tList&&(e.target.targetSpacecrafts=this._tList.slice())}
this._tList&&this._tList.length>0?(this._sc.setTarget(this._tList[0]),this._standingDown=!1):e.target.none&&this._sc.setTarget(null),this._priorityTargets=!0===e.target.priority}break;case m.STAND_DOWN:this._standingDown=!0,this._cancelMoveCommand();break;case m.REACH_DISTANCE:e.reachDistance&&(i=this._mission.getSpacecraft(e.reachDistance.target))&&i._alive&&!i._away&&(this._moveCommand=T.REACH_DISTANCE,this._moveCommandTarget=i,this._moveCommandMinDistance=e.reachDistance.minDistance||0,this._moveCommandMaxDistance=e.reachDistance.maxDistance||0);break;case m.CANCEL_MOVE:this._cancelMoveCommand();break;default:n.showError("Unknown spacecraft command: '"+e.command+"'!")}},SpacecraftAI.prototype._cancelMoveCommand=function(){this._moveCommand=T.NONE,this._moveCommandTarget=null},SpacecraftAI.prototype._executeMoveCommand=function(e,i,n,s){var o,r,a,c,h;switch(this._moveCommand){case T.REACH_DISTANCE:if(!this._moveCommandTarget||!this._moveCommandTarget._alive||this._moveCommandTarget._away)return void this._cancelMoveCommand();o=t.prodMat4Vec3Aux(i,t.diff3Aux(this._moveCommandTarget.getPhysicalPositionVector(),e)),r=t.extractLength3(o),h=!0,0!==this._moveCommandMaxDistance&&r>this._moveCommandMaxDistance&&(t.getYawAndPitch(R,o),a=Math.abs(R.yaw)<E&&Math.abs(R.pitch)<E,this.turn(R.yaw,R.pitch,s),c=r>this._moveCommandMaxDistance+1e3,this._sc.changeFlightMode(c?l.FlightMode.CRUISE:l.FlightMode.COMBAT),a?this.approach(r,this._moveCommandMaxDistance,0,n*(c?4:2)):this._sc.resetSpeed(),h=!1),0!==this._moveCommandMinDistance&&r<this._moveCommandMinDistance&&(t.scale3(o,-1),t.getYawAndPitch(R,o),a=Math.abs(R.yaw)<E&&Math.abs(R.pitch)<E,this.turn(R.yaw,R.pitch,s),c=r<this._moveCommandMinDistance-1e3,this._sc.changeFlightMode(c?l.FlightMode.CRUISE:l.FlightMode.COMBAT),a?this.approach(this._moveCommandMinDistance-r,0,0,n*(c?4:2)):this._sc.resetSpeed(),h=!1),h&&this._cancelMoveCommand()}},FighterAI.prototype=new SpacecraftAI,FighterAI.prototype.constructor=FighterAI,FighterAI.prototype._updateAimError=function(){this._aimError[0]=2*(u()-.5)*this._maxAimError,this._aimError[1]=2*(u()-.5)*this._maxAimError},FighterAI.prototype._startNewAttackRun=function(){this._chargePhase=S.NONE,this._sc.changeFlightMode(l.FlightMode.COMBAT),this._hitCountByNonTarget=0,this._timeSinceLastTargetHit=0,this._timeSinceLastClosingIn=0,this._timeSinceLastRoll=0,this._maxDistanceFactor=C,this._isBlockedBy=null,this._rollTime=-1,this._tOffset=[0,0,0],this._tOffsetUpdateTimeLeft=1500,this._maxAimError=I,this._fireDelayLeft=this._fireDelay,this._updateAimError()},FighterAI.prototype._handleTargetSwitch=function(){SpacecraftAI.prototype._handleTargetSwitch.call(this),this._msOnTarget.length=0,this._startNewAttackRun()},FighterAI.prototype._triggerEvasiveManeuver=function(){return this._evasiveManeuverTime<0&&(this._evasiveManeuverDelayLeft=this._evasiveManeuverDelay,this._evasiveManeuverTime=0,!0)},FighterAI.prototype._handleBeingHit=function(e){this._isBlockedBy||this._triggerEvasiveManeuver()&&(this._evasiveVelocityVector[0]=-e.hitPosition[0],this._evasiveVelocityVector[1]=-e.hitPosition[2],t.normalize2(this._evasiveVelocityVector)),SpacecraftAI.prototype._handleBeingHit.call(this,e)},FighterAI.prototype._handleTargetHit=function(){this._timeSinceLastTargetHit=0},FighterAI.prototype._handleAnySpacecraftHit=function(e){var t=e.spacecraft;this._sc&&this._sc._alive&&t!==this._sc&&this._chargePhase!==S.EVADE&&t!==this._sc.getTarget()&&(!this._isBlockedBy||this._isBlockedBy.isHostile(this._sc))&&(this._isBlockedBy=t,this._evasiveManeuverTime=-1,this._chargePhase=S.NONE,this._sc.changeFlightMode(l.FlightMode.COMBAT))},FighterAI.prototype._handleTargetFired=function(){var i;!this._isBlockedBy&&this._facingTarget&&this._sc&&this._sc.getTarget()&&this._sc.getTarget().getTarget()===this._sc&&this._tDistance>.5*this._wRange&&this._triggerEvasiveManeuver()&&(i=d()*e.DOUBLE_PI,this._evasiveVelocityVector[0]=1,this._evasiveVelocityVector[1]=0,t.rotate2(this._evasiveVelocityVector,i))},FighterAI.prototype.handleSceneMoved=function(e){t.add3(this._chargeDestination,e)},FighterAI.prototype.control=function(n){var s,o,r,a,c,h,u,_,g,m,f,y,C,A,x,O,N,D,P,w,V,F,U,B,H,G,j,k,W,Y,X;if(this._sc){if(!this._sc._alive)return void(this._sc=null);if(this._sc._away)return;for(k=!1,this._updateTarget(),C=this._sc.getMaxAcceleration(),m=this._sc.vMo.getScaledSize(),r=this._sc.getPhysicalPositionVector(),Y=this._sc.pMo.oM,O=this._sc.getRelativeVelocityMatrix()[13],s=this._sc.getTarget(),this._attackingTarget=!1,u=0;u<this._msOnTarget.length;u++)this._msOnTarget[u].getTarget()!==s&&(this._msOnTarget.splice(u,1),u--);if(this._executeMoveCommand(r,Y,C,n),this._moveCommand===T.NONE)if(this._chargePhase===S.EVADE)this._attackingTarget=!!s,t.setDiff3(L,this._chargeDestination,r),c=t.prodMat4Vec3Aux(Y,L),this._tDistance=t.extractLength3(c),t.getYawAndPitch(R,c),this.turn(R.yaw,R.pitch,n),this._sc.setSpeedTarget(2*C),(this._tDistance<=1||c[1]<0||O<0)&&this._startNewAttackRun();else if(s)if(X=s.pMo.pM,b[0]=X[12],b[1]=X[13],b[2]=X[14],this._tOffsetUpdateTimeLeft<=0?(this._tOffsetUpdateTimeLeft=1500,a=t.diff3Aux(this._sc.getTargetHitPosition(),b),t.length3Squared(t.diff3Aux(this._tOffset,a))<625?this._maxAimError*=.5:this._maxAimError=I,this._tOffset[0]=a[0],this._tOffset[1]=a[1],this._tOffset[2]=a[2],this._updateAimError()):this._tOffsetUpdateTimeLeft-=n,t.add3(b,this._tOffset),t.setDiff3(L,b,r),c=t.prodMat4Vec3Aux(Y,L),this._tDistance=t.extractLength3(c),t.getYawAndPitch(R,c),R.yaw+=this._aimError[0],R.pitch+=this._aimError[1],this._facingTarget=Math.abs(R.yaw)<E&&Math.abs(R.pitch)<E,this.turn(R.yaw,R.pitch,n),this._isBlockedBy&&(j=!1,this._isBlockedBy._alive&&this._facingTarget&&this._isBlockedBy.pMo.checkHit(i.translation4vAux(b),i.translation4vAux(L),1e3,.25*m)&&(h=t.prodMat4Vec3Aux(Y,t.diffVec3Mat4Aux(r,this._isBlockedBy.pMo.pM)),N=1*C,h[0]>0?(this._sc.strafeRight(N),j=!0):(this._sc.strafeLeft(N),j=!0),h[2]<0?(this._sc.lower(N),j=!0):(this._sc.raise(N),j=!0)),j||(this._isBlockedBy=null,this._sc.stopLeftStrafe(),this._sc.stopRightStrafe(),this._sc.stopLower(),this._sc.stopRaise()),k=!0),(W=this._sc._ws)&&W.length>0){if(f=s.vMo.getScaledSize(),y=Math.atan(.25*f/this._tDistance),B=W[0].getProjectileVelocity()+O,_=this._tDistance/B*1e3,P=W[0].getCooldown(),this._sc.aimWeapons(.002,y,n),this._facingTarget||(this._timeSinceLastClosingIn=0,this._timeSinceLastTargetHit=0,this._hitCountByNonTarget=0),G=W[0].getRange(O),t.length3Squared(t.diff3Aux(this._sc.getTargetHitPosition(),r))<=G*G?(this._attackingTarget=!0,Math.abs(R.yaw)<y&&Math.abs(R.pitch)<y&&(!this._isBlockedBy||this._isBlockedBy.isHostile(this._sc))?this._fireDelayLeft>0?this._fireDelayLeft-=n:(this._sc.fire(),this._isBlockedBy||(this._timeSinceLastRoll+=n,this._timeSinceLastTargetHit+=n,this._timeSinceLastClosingIn+=n,V=_+3*P,this._timeSinceLastRoll>V&&this._timeSinceLastTargetHit>V&&(this._rollTime=0),this._rollTime>=0&&(this._sc.rollLeft(),this._timeSinceLastRoll=0,this._rollTime+=n,F=this._sc.getMaxAngularAcceleration(),U=F*v,w=M>U*v?v+(M-U*v)/U:Math.sqrt(4*M/F)/2,this._rollTime>1e3*w&&(this._rollTime=-1)))):(this._timeSinceLastRoll=0,this._fireDelayLeft=this._fireDelay)):(this._timeSinceLastRoll=0,this._fireDelayLeft=this._fireDelay),this._sc.getActiveMissileLauncher())if(this._sc.getActiveMissileLauncher()._class._antiShip===s.isFighter())this._sc.changeMissile();else{for(g=s._hitpoints+s.getShieldCapacity(),u=0;u<this._msOnTarget.length;u++)g-=this._msOnTarget[u].getClass().getDamage(0);g>0&&(o=this._sc.launchMissile())&&this._msOnTarget.push(o)}this._chargePhase===S.NONE&&(this._hitCountByNonTarget>=4||this._timeSinceLastTargetHit>_+15*P)&&(this._chargePhase=S.APPROACH_ATTACK,this._sc.changeFlightMode(l.FlightMode.CRUISE)),this._chargePhase===S.NONE?(H=_+5*P,this._timeSinceLastClosingIn>H&&this._timeSinceLastTargetHit>H&&this._maxDistanceFactor>.125&&(this._maxDistanceFactor=Math.max(this._maxDistanceFactor-.05,.125),this._timeSinceLastClosingIn=0),D=.5*(m+f),x=D+this._maxDistanceFactor*this._wRange,A=D+.06*this._wRange,this._facingTarget?this.approach(this._tDistance,x,A,2*C):this._sc.resetSpeed()):this._chargePhase===S.APPROACH_ATTACK&&(x=Math.sqrt(2*(f+.5*m)/C)*C*4,this._facingTarget?(this._sc.setSpeedTarget(4*C),this._tDistance<=x&&(this._chargePhase=S.EVADE,this._sc.changeFlightMode(l.FlightMode.COMBAT),t.normalize3(L),t.setSum3(this._chargeDestination,r,t.scaled3Aux(t.diff3Aux(t.sum3Aux(b,t.scaled3Aux(t.normalize3(t.prodVec3Mat3Aux(t.perpendicular3(L),i.rotation3Aux(L,p()*e.DOUBLE_PI))),x)),r),1)))):(this._chargePhase=S.NONE,this._sc.changeFlightMode(l.FlightMode.COMBAT),this._sc.resetSpeed()))}else this._sc.resetSpeed();else this._facingTarget=!1,this._tDistance=0,this._sc.resetSpeed(),this._sc.aimWeapons(.002,0,n);k||(this._evasiveManeuverTime>=0&&this._evasiveManeuverDelayLeft<=0?(0===this._evasiveManeuverTime&&(this._evasiveVelocityVector[0]*=1*C,this._evasiveVelocityVector[1]*=1*C,t.rotate2(this._evasiveVelocityVector,(d()-.5)*Math.PI)),this._evasiveVelocityVector[0]>0?this._sc.strafeRight(this._evasiveVelocityVector[0]):this._evasiveVelocityVector[0]<0?this._sc.strafeLeft(-this._evasiveVelocityVector[0]):(this._sc.stopLeftStrafe(),this._sc.stopRightStrafe()),this._evasiveVelocityVector[1]>0?this._sc.raise(this._evasiveVelocityVector[1]):this._evasiveVelocityVector[1]<0?this._sc.lower(-this._evasiveVelocityVector[1]):(this._sc.stopLower(),this._sc.stopRaise()),this._evasiveManeuverTime+=n,this._evasiveManeuverTime>1e3&&(this._evasiveManeuverTime=-1)):(this._evasiveManeuverDelayLeft>0&&(this._evasiveManeuverDelayLeft-=n),this._sc.stopLeftStrafe(),this._sc.stopRightStrafe(),this._sc.stopLower(),this._sc.stopRaise()))}},ShipAI.prototype=new SpacecraftAI,ShipAI.prototype.constructor=ShipAI,ShipAI.prototype.handleSceneMoved=function(){},ShipAI.prototype.control=function(e){var i,n,s,o,r,a,l,c,h,u,d,p,_,g,m;if(this._sc){if(!this._sc._alive)return void(this._sc=null);if(this._sc._away)return;this._updateTarget(),c=this._sc.getMaxAcceleration(),r=this._sc.vMo.getScaledSize(),n=this._sc.getPhysicalPositionVector(),m=this._sc.pMo.oM,i=this._sc.getTarget(),this._attackingTarget=!1,this._executeMoveCommand(n,m,c,e),i?(_=i.isHostile(this._sc),s=t.prodMat4Vec3(m,t.diffTranslation3Aux(i.pMo.pM,this._sc.pMo.pM)),o=t.extractLength3(s),_&&(t.getYawAndPitch(R,s),p=Math.abs(R.yaw)<E&&Math.abs(R.pitch)<E),(g=this._sc._ws)&&g.length>0&&(a=i.vMo.getScaledSize(),l=Math.atan(.25*a/o),_&&(u=.25*r,h=u+.9*this._wRange),this._sc.aimWeapons(.002,l,e),_?(this._moveCommand===T.NONE&&(p?this.approach(o,h,0,2*c):this._sc.resetSpeed(),o>h?this.turn(R.yaw,R.pitch,e):this.orientToAttackPosition(s,e)),d=g[0].getRange(this._sc.getRelativeVelocityMatrix()[13]),t.length3Squared(t.diff3Aux(this._sc.getTargetHitPosition(),n))-u<=d*d&&(this._sc.fire(!0),this._attackingTarget=!0)):this._sc.resetSpeed())):(this._moveCommand===T.NONE&&this._sc.resetSpeed(),this._sc.aimWeapons(.002,0,e))}},StationAI.prototype=new SpacecraftAI,StationAI.prototype.constructor=StationAI,StationAI.prototype.handleSceneMoved=function(){},StationAI.prototype.control=function(e){var i,n,s,o,r,a,l,c,h,u,d,p,_;if(this._sc){if(!this._sc._alive)return void(this._sc=null);if(this._sc._away)return;this._updateTarget(),c=this._sc.getMaxAcceleration(),r=this._sc.vMo.getScaledSize(),n=this._sc.getPhysicalPositionVector(),_=this._sc.pMo.oM,i=this._sc.getTarget(),this._attackingTarget=!1,this._executeMoveCommand(n,_,c,e),i?(d=i.isHostile(this._sc),s=t.prodMat4Vec3(_,t.diffTranslation3Aux(i.pMo.pM,this._sc.pMo.pM)),o=t.extractLength3(s),this._shouldTurn&&this._moveCommand===T.NONE&&this.orientToAttackPosition(s,e),(p=this._sc._ws)&&p.length>0&&(a=i.vMo.getScaledSize(),l=Math.atan(.25*a/o),d&&(h=.25*r),this._sc.aimWeapons(.002,l,e),d&&(u=p[0].getRange(this._sc.getRelativeVelocityMatrix()[13]),t.length3Squared(t.diff3Aux(this._sc.getTargetHitPosition(),n))-h<=u*u&&(this._sc.fire(!0),this._attackingTarget=!0)))):this._sc.aimWeapons(.002,0,e),this._moveCommand===T.NONE&&this._sc.resetSpeed()}},SentryAI.prototype=new StationAI,SentryAI.prototype.constructor=SentryAI,AIContext.prototype.clearAIs=function(){this._ais=[]},AIContext.prototype.addAI=function(e,t,i){this._ais.push(new _[e](t,i))},AIContext.prototype.control=function(e){var t;for(t=0;t<this._ais.length;t++)this._ais[t].control(e)},AIContext.prototype.handleSceneMoved=function(e){var t;for(t=0;t<this._ais.length;t++)this._ais[t].handleSceneMoved(e)},_={},_.fighter=FighterAI,_.ship=ShipAI,_.station=StationAI,_.sentry=SentryAI,g=new AIContext(_),o.executeWhenReady(function(){v=.2,O=1e3/v,h=Math.seed(Math.random()),u=Math.seed(Math.random()),d=Math.seed(Math.random()),p=Math.seed(Math.random())}),{SpacecraftCommand:m,JumpCommandWay:f,getAITypes:getAITypes,resetJumpInPositionSeed:resetJumpInPositionSeed,resetRandomSeeds:resetRandomSeeds,positionForInwardJump:positionForInwardJump,clearAIs:g.clearAIs.bind(g),addAI:g.addAI.bind(g),control:g.control.bind(g),handleSceneMoved:g.handleSceneMoved.bind(g)}}),define("armada/logic/missions/conditions",["utils/utils","utils/matrices","modules/application","armada/strings","armada/logic/SpacecraftEvents","utils/polyfill"],function(e,t,i,n,s){"use strict";function SubjectGroup(e){this._descriptor=e||{},this._scs=null,this._shortString=null}function Condition(t){this._type=t?e.getSafeEnumValue(r,t.type,null):null,this._subjects=t?new SubjectGroup(t.subjects):null,t&&this._checkParams(t.params)}function DestroyedCondition(e){Condition.call(this,e)}function CountCondition(e){Condition.call(this,e)}function TimeCondition(e){Condition.call(this,e),this._running=!this._params||!this._params.start,this._trigger=null,this._timeElapsed=this._params?this._params.startValue||0:0,this._count=0,this._canBeImpossible=!!this._params&&(this._params.when===c.BEFORE||this._params.when===c.WITHIN||this._params.when===c.ONCE||this._params.when===c.REPEAT&&this._params.maxCount),this._before=!!this._params&&this._params.when===c.BEFORE,this._impossible=!1}function HullIntegrityCondition(t,i){var n;Condition.call(this,t),this._subjectIsSelf=!!i&&this._subjects.isPilotedSpacecraft(i),this._ts=this._subjects.getSpacecrafts(i),this._ts?(this._ts=this._ts.slice(),(n=this._ts.indexOf(i._pilotedCraft))>=0&&this._ts.splice(n,1)):this._ts=e.EMPTY_ARRAY}function ShieldIntegrityCondition(e){Condition.call(this,e)}function DistanceCondition(e){Condition.call(this,e),this._distanceSquared=0,this._lastSatisfied=!1,this._impossible=!1,this._active=!0}function HitCondition(e,t){var i,n,o;if(Condition.call(this,e),this._satisfied=!1,t&&this._subjects&&(n=this._subjects.getSpacecrafts(t))&&n.length>0)for(o=this._handleHit.bind(this,this._params&&this._params.by?new SubjectGroup(this._params.by).getSpacecrafts(t):null),i=0;i<n.length;i++)n[i].addEventHandler(s.BEING_HIT,o)}function CollisionCondition(e,t){var i,n,o;if(Condition.call(this,e),this._satisfied=!1,t&&this._subjects&&(n=this._subjects.getSpacecrafts(t))&&n.length>0)for(o=this._handleCollision.bind(this,this._params&&this._params.with?new SubjectGroup(this._params.with).getSpacecrafts(t):null),i=0;i<n.length;i++)n[i].addEventHandler(s.COLLIDED,o)}function AwayCondition(e){Condition.call(this,e)}function OnTeamCondition(e){Condition.call(this,e)}function MissionStateCondition(e){Condition.call(this,e)}function GetsTargetedCondition(e,t){var i,n,o;if(Condition.call(this,e),this._satisfied=!1,t&&this._subjects&&(n=this._subjects.getSpacecrafts(t))&&n.length>0)for(o=this._handleTargeted.bind(this,this._params&&this._params.by?new SubjectGroup(this._params.by).getSpacecrafts(t):null),i=0;i<n.length;i++)n[i].addEventHandler(s.BEING_TARGETED,o)}function IsTargetedCondition(e,t){Condition.call(this,e),this._by=null,t&&this._params&&this._params.by&&(this._by=new SubjectGroup(this._params.by).getSpacecrafts(t))}function createCondition(e,t){return new(o[e.type]||Condition)(e,t)}var o,r={DESTROYED:"destroyed",COUNT:"count",TIME:"time",HULL_INTEGRITY:"hullIntegrity",SHIELD_INTEGRITY:"shieldIntegrity",DISTANCE:"distance",HIT:"hit",COLLISION:"collision",AWAY:"away",ON_TEAM:"onTeam",MISSION_STATE:"missionState",GETS_TARGETED:"getsTargeted",IS_TARGETED:"isTargeted"},a={ALL:"all",ANY:"any"},l={BELOW:"below",ABOVE:"above",EQUALS:"equals"},c={BEFORE:"before",AFTER:"after",WITHIN:"within",ONCE:"once",REPEAT:"repeat"},h={NONE:0,BATTLE:1,IN_PROGRESS:2,COMPLETED:3,FAILED:4,DEFEAT:5,ENDED:6};return Object.freeze(r),Object.freeze(a),Object.freeze(l),Object.freeze(c),Object.freeze(h),SubjectGroup.prototype.has=function(e){return this._descriptor.spacecrafts&&this._descriptor.spacecrafts.indexOf(e.getID())>=0||this._descriptor.squads&&this._descriptor.squads.indexOf(e._squad)>=0||this._descriptor.teams&&e._team&&this._descriptor.teams.indexOf(e._team._name)>=0},SubjectGroup.prototype._cacheSpacecrafts=function(e){var t,i;for(this._scs=[],i=e.getSpacecrafts(),t=0;t<i.length;t++)this.has(i[t])&&this._scs.push(i[t])},SubjectGroup.prototype.getSpacecrafts=function(e,t){return!e||this._scs&&!t||this._cacheSpacecrafts(e),this._scs},SubjectGroup.prototype.isMulti=function(){return this._descriptor.spacecrafts&&this._descriptor.spacecrafts.length>1||this._descriptor.squads&&this._descriptor.squads.length>0||this._descriptor.teams&&this._descriptor.teams.length>0},SubjectGroup.prototype.isSingleSpacecraft=function(){return this._descriptor.spacecrafts&&1===this._descriptor.spacecrafts.length&&(!this._descriptor.squads||0===this._descriptor.squads.length)&&(!this._descriptor.teams||0===this._descriptor.teams.length)},SubjectGroup.prototype.isPilotedSpacecraft=function(e){var t;return!!this.isSingleSpacecraft()&&(t=this.getSpacecrafts(e),1===t.length&&t[0]===e._pilotedCraft)},SubjectGroup._mapSpacecraftID=function(e){return n.getDefiniteArticleForWord(e)+" <strong>"+e+"</strong>"},SubjectGroup._getMappedSpacecraftIDs=function(e){return n.getList(e.map(SubjectGroup._mapSpacecraftID))},SubjectGroup._mapSquadID=function(e){return e=n.get(n.SQUAD.PREFIX,e,e),n.getDefiniteArticleForWord(e)+" <strong>"+e+"</strong>"},SubjectGroup._getMappedSquadIDs=function(e){return n.getList(e.map(SubjectGroup._mapSquadID))},SubjectGroup._mapTeamID=function(e){return e=n.get(n.FACTION.PREFIX,e,e),n.getDefiniteArticleForWord(e)+" <strong>"+e+"</strong>"},SubjectGroup._getMappedTeamIDs=function(e){return n.getList(e.map(SubjectGroup._mapTeamID))},SubjectGroup.prototype.toString=function(){var t="";return this._descriptor.spacecrafts&&(t+=SubjectGroup._getMappedSpacecraftIDs(this._descriptor.spacecrafts)),this._descriptor.squads&&(t.length>0&&(t+="; "),t+=e.formatString(n.get(this._descriptor.squads.length>1?n.MISSIONS.OBJECTIVE_SUBJECTS_SQUADS:n.MISSIONS.OBJECTIVE_SUBJECTS_SQUAD),{ids:SubjectGroup._getMappedSquadIDs(this._descriptor.squads)})),this._descriptor.teams&&(t.length>0&&(t+="; "),t+=e.formatString(n.get(this._descriptor.teams.length>1?n.MISSIONS.OBJECTIVE_SUBJECTS_TEAMS:n.MISSIONS.OBJECTIVE_SUBJECTS_TEAM),{ids:SubjectGroup._getMappedTeamIDs(this._descriptor.teams)})),t},SubjectGroup.prototype.getLiveSubjectCount=function(e){var t,i=0;for(t=0;t<this._scs.length;t++)!this._scs[t]._alive||e&&this._scs[t]._away||i++;return i},SubjectGroup.prototype.getMinHullIntegrity=function(e){var t,i=100;for(t=0;t<this._scs.length;t++)!this._scs[t]._alive||e&&this._scs[t]._away||(i=Math.min(i,this._scs[t].getHullIntegrity()));return i},SubjectGroup.prototype.getMaxHullIntegrity=function(e){var t,i=0;for(t=0;t<this._scs.length;t++)!this._scs[t]._alive||e&&this._scs[t]._away||(i=Math.max(i,this._scs[t].getHullIntegrity()));return i},SubjectGroup.prototype.getShortString=function(){return this._shortString||(0===this._scs.length?this._shortString="-":!this._descriptor.spacecrafts||this._descriptor.squads||this._descriptor.teams?this._descriptor.spacecrafts||!this._descriptor.squads||this._descriptor.teams?this._descriptor.spacecrafts||this._descriptor.squads||!this._descriptor.teams?this._shortString=e.formatString(n.get(n.BATTLE.OBJECTIVE_SUBJECTS_SPACECRAFTS),{count:this._scs.length}):this._descriptor.teams.length>1?this._shortString=e.formatString(n.get(n.BATTLE.OBJECTIVE_SUBJECTS_TEAMS),{count:this._descriptor.teams.length}):this._shortString=n.get(n.FACTION.PREFIX,this._descriptor.teams[0],this._descriptor.teams[0]):this._descriptor.squads.length>1?this._shortString=e.formatString(n.get(n.BATTLE.OBJECTIVE_SUBJECTS_SQUADS),{count:this._descriptor.squads.length}):this._shortString=n.get(n.SQUAD.PREFIX,this._descriptor.squads[0],this._descriptor.squads[0]):this._scs.length>1?this._shortString=e.formatString(n.get(n.BATTLE.OBJECTIVE_SUBJECTS_SPACECRAFTS),{count:this._scs.length}):this._shortString=this._scs[0].getDisplayName()),this._shortString},Condition.prototype._handleWrongParams=function(){i.showError("Wrong parameters specified for condition of type: '"+this._type+"'!")},Condition.prototype.canBeImpossible=function(){return!1},Condition.prototype.isImpossible=function(){return!1},Condition.prototype.isActive=function(){return!0},Condition.prototype.canChangeMultipleTimes=function(){return!1},DestroyedCondition.prototype=new Condition,DestroyedCondition.prototype.constructor=DestroyedCondition,DestroyedCondition.prototype._checkParams=function(t){return this._params=t,this._params&&this._params.which&&!e.getSafeEnumValue(a,this._params.which)?(this._handleWrongParams(),!1):(this._all=!this._params||!this._params.which||this._params.which===a.ALL,!0)},DestroyedCondition.prototype.isSatisfied=function(e){var t,i=this._subjects.getSpacecrafts(e);for(t=0;t<i.length;t++)if(i[t]._alive===this._all)return!this._all;return this._all},DestroyedCondition.prototype.getObjectiveString=function(t){var i=e.formatString(n.get(t,this._subjects.isMulti()?this._all?n.OBJECTIVE.DESTROY_SUFFIX.name:n.OBJECTIVE.DESTROY_ANY_SUFFIX.name:n.OBJECTIVE.DESTROY_ONE_SUFFIX.name),{subjects:this._subjects.toString()});return i=i.charAt(0).toUpperCase()+i.slice(1)},DestroyedCondition.prototype.getObjectiveStateString=function(t){var i,s,o;return this._subjects.getSpacecrafts()?(s=this._subjects.getLiveSubjectCount(!0),o=s>1?" ("+s+")":"",i=e.formatString(n.get(t,n.OBJECTIVE.DESTROY_SUFFIX.name),{subjects:this._subjects.getShortString()})+o,i=i.charAt(0).toUpperCase()+i.slice(1)):""},DestroyedCondition.prototype.getTargetSpacecrafts=function(e){return this._subjects.getSpacecrafts(e)},DestroyedCondition.prototype.getEscortedSpacecrafts=function(e){return this._subjects.getSpacecrafts(e)},CountCondition.prototype=new Condition,CountCondition.prototype.constructor=CountCondition,CountCondition.prototype._checkParams=function(t){return this._params=t,!(!this._params||"number"!=typeof this._params.count||!e.getSafeEnumValue(l,this._params.relation))||(this._handleWrongParams(),!1)},CountCondition.prototype.isSatisfied=function(e){var t,i,n=this._subjects.getSpacecrafts(e);for(i=0,t=0;t<n.length;t++)n[t]._alive&&i++;switch(this._params.relation){case l.BELOW:return i<this._params.count;case l.ABOVE:return i>this._params.count;case l.EQUALS:return i===this._params.count}return!1},CountCondition.prototype.getObjectiveString=function(t){var s;return this._params.relation!==l.BELOW?(i.showError("Count conditions for mission objectives must have relation set to '"+l.BELOW+"'!"),null):(s=e.formatString(n.get(t,n.OBJECTIVE.COUNT_BELOW_SUFFIX.name),{subjects:this._subjects.toString(),count:this._params.count}),s=s.charAt(0).toUpperCase()+s.slice(1))},CountCondition.prototype.getObjectiveStateString=function(t){var i,s;return this._subjects.getSpacecrafts()?(s=this._subjects.getLiveSubjectCount(),i=e.formatString(n.get(t,n.OBJECTIVE.COUNT_BELOW_SUFFIX.name),{subjects:this._subjects.getShortString(),count:this._params.count,live:s,remaining:Math.max(0,s-this._params.count)}),i=i.charAt(0).toUpperCase()+i.slice(1)):""},CountCondition.prototype.getTargetSpacecrafts=function(e){return this._subjects.getSpacecrafts(e)},CountCondition.prototype.getEscortedSpacecrafts=function(e){return this._subjects.getSpacecrafts(e)},TimeCondition.prototype=new Condition,TimeCondition.prototype.constructor=TimeCondition,TimeCondition.prototype._checkParams=function(t){return this._params=t,!(!this._params||"number"!=typeof this._params.time||!e.getSafeEnumValue(c,this._params.when)||void 0!==this._params.start&&"string"!=typeof this._params.start||this._params.when!==c.REPEAT&&void 0!==this._params.maxCount||this._params.when===c.REPEAT&&void 0!==this._params.maxCount&&"number"!=typeof this._params.maxCount||void 0!==this._params.startValue&&"number"!=typeof this._params.startValue)||(this._handleWrongParams(),!1)},TimeCondition.prototype.isSatisfied=function(e,t){var i=!1;if(this._params.start&&!this._trigger&&(this._trigger=e.getEvent(this._params.start)&&e.getEvent(this._params.start)._trigger,this._trigger||(this._params.start=null)),!this._running&&!this._impossible&&this._trigger&&this._trigger.hasFired()&&(this._running=!0),this._running)switch(this._timeElapsed+=t,this._params.when){case c.BEFORE:case c.WITHIN:if(this._timeElapsed<this._params.time)return!0;this._impossible=!0;break;case c.AFTER:if(this._timeElapsed>this._params.time)return!0;break;case c.ONCE:if(this._timeElapsed>=this._params.time&&0===this._count)return this._running=!1,this._count=1,this._impossible=!0,!0;break;case c.REPEAT:if(!this._params.maxCount||this._count<this._params.maxCount){for(;this._timeElapsed>=this._params.time;)this._timeElapsed-=this._params.time,i=!0;if(i)return this._count++,!0}else this._running=!1,this._impossible=!0}return!!this._before&&this._timeElapsed<this._params.time},TimeCondition.prototype.getObjectiveString=function(t,s){var o;return s||this._params&&this._params.when===c.AFTER?s&&(!this._params||this._params.when!==c.BEFORE&&this._params.when!==c.WITHIN)?(i.showError("Time conditions used in combination with other conditions for mission objectives must have 'when' = '"+c.BEFORE+NaN+c.WITHIN+"'!"),null):(o=e.formatString(n.get(t,s?n.OBJECTIVE.TIME_MULTI_SUFFIX.name:n.OBJECTIVE.TIME_SUFFIX.name),{time:e.formatTimeToMinutes(this._params.time)}),s||(o=o.charAt(0).toUpperCase()+o.slice(1)),o):(i.showError("Single time conditions for mission objectives must have 'when' = '"+c.AFTER+"'!"),null)},TimeCondition.prototype.getObjectiveStateString=function(t,i){var s,o;return o=1e3*Math.ceil(.001*Math.max(0,this._params.time-this._timeElapsed)),s=e.formatString(n.get(t,i?n.OBJECTIVE.TIME_MULTI_SUFFIX.name:n.OBJECTIVE.TIME_SUFFIX.name),{time:e.formatTimeToMinutes(o)}),s=s.charAt(0).toUpperCase()+s.slice(1)},TimeCondition.prototype.getTargetSpacecrafts=function(){return e.EMPTY_ARRAY},TimeCondition.prototype.getEscortedSpacecrafts=function(){return e.EMPTY_ARRAY},TimeCondition.prototype.canBeImpossible=function(){return this._canBeImpossible},TimeCondition.prototype.isImpossible=function(){return this._impossible},TimeCondition.prototype.isActive=function(){return this._running&&(!this._params||this._timeElapsed<this._params.time)},TimeCondition.prototype.canChangeMultipleTimes=function(){return this._params.when===c.REPEAT},HullIntegrityCondition.prototype=new Condition,HullIntegrityCondition.prototype.constructor=HullIntegrityCondition,HullIntegrityCondition.prototype._checkParams=function(t){return this._params=t,this._params&&(this._params.which&&!e.getSafeEnumValue(a,this._params.which)||void 0!==this._params.minIntegrity&&(this._params.minIntegrity<0||this._params.minIntegrity>100)||void 0!==this._params.maxIntegrity&&(this._params.maxIntegrity<0||this._params.maxIntegrity>100))?(this._handleWrongParams(),!1):(this._all=!this._params||!this._params.which||this._params.which===a.ALL,!0)},HullIntegrityCondition.prototype.isSatisfied=function(e){var t,i,n=this._subjects.getSpacecrafts(e);for(t=0;t<n.length;t++)if(i=100*n[t].getHullIntegrity(),(void 0!==this._params.minIntegrity&&i<this._params.minIntegrity||void 0!==this._params.maxIntegrity&&i>this._params.maxIntegrity)===this._all)return!this._all;return this._all},HullIntegrityCondition.prototype.getObjectiveString=function(t){var s;return this._params&&void 0!==this._params.maxIntegrity&&void 0===this._params.minIntegrity?(s=e.formatString(n.get(t,this._subjectIsSelf?n.OBJECTIVE.MAX_HULL_INTEGRITY_SELF_SUFFIX.name:this._subjects.isMulti()?this._all?n.OBJECTIVE.MAX_HULL_INTEGRITY_SUFFIX.name:n.OBJECTIVE.MAX_HULL_INTEGRITY_ANY_SUFFIX.name:n.OBJECTIVE.MAX_HULL_INTEGRITY_ONE_SUFFIX.name),{subjects:this._subjects.toString(),maxIntegrity:this._params.maxIntegrity}),s=s.charAt(0).toUpperCase()+s.slice(1)):(i.showError("Hull integrity conditions for mission objectives must specify a maximum and no minimum integrity!"),null)},HullIntegrityCondition.prototype.getObjectiveStateString=function(t){var i,s;return this._subjects.getSpacecrafts()?(s=this._subjects.getLiveSubjectCount(!0)>0?" ("+Math.round(100*(this._all?this._subjects.getMaxHullIntegrity(!0):this._subjects.getMinHullIntegrity(!0)))+"/"+this._params.maxIntegrity+"%)":"",i=e.formatString(n.get(t,this._subjectIsSelf?n.OBJECTIVE.MAX_HULL_INTEGRITY_SELF_SUFFIX.name:n.OBJECTIVE.MAX_HULL_INTEGRITY_SUFFIX.name),{subjects:this._subjects.getShortString()})+s,i=i.charAt(0).toUpperCase()+i.slice(1)):""},HullIntegrityCondition.prototype.getTargetSpacecrafts=function(){return this._ts},HullIntegrityCondition.prototype.getEscortedSpacecrafts=function(){return this._ts},HullIntegrityCondition.prototype.canChangeMultipleTimes=function(){return!0},ShieldIntegrityCondition.prototype=new Condition,ShieldIntegrityCondition.prototype.constructor=ShieldIntegrityCondition,ShieldIntegrityCondition.prototype._checkParams=function(t){return this._params=t,this._params&&(this._params.which&&!e.getSafeEnumValue(a,this._params.which)||void 0!==this._params.minIntegrity&&(this._params.minIntegrity<0||this._params.minIntegrity>100)||void 0!==this._params.maxIntegrity&&(this._params.maxIntegrity<0||this._params.maxIntegrity>100))?(this._handleWrongParams(),!1):(this._all=!this._params||!this._params.which||this._params.which===a.ALL,!0)},ShieldIntegrityCondition.prototype.isSatisfied=function(e){var t,i,n=this._subjects.getSpacecrafts(e);for(t=0;t<n.length;t++)if(i=100*n[t].getShieldIntegrity(),(void 0!==this._params.minIntegrity&&i<this._params.minIntegrity||void 0!==this._params.maxIntegrity&&i>this._params.maxIntegrity)===this._all)return!this._all;return this._all},ShieldIntegrityCondition.prototype.getObjectiveString=function(){
return i.showError("Shield integrity conditions cannot be used as win/lose conditions!"),null},ShieldIntegrityCondition.prototype.getObjectiveStateString=function(){return i.showError("Shield integrity conditions cannot be used as win/lose conditions!"),null},ShieldIntegrityCondition.prototype.canChangeMultipleTimes=function(){return!0},DistanceCondition.prototype=new Condition,DistanceCondition.prototype.constructor=DistanceCondition,DistanceCondition.prototype._checkParams=function(t){return this._params=t,this._params&&(this._params.which&&!e.getSafeEnumValue(a,this._params.which)||void 0!==this._params.minDistance&&this._params.minDistance<=0||void 0!==this._params.maxDistance&&this._params.maxDistance<=0||!this._params.target)?(this._handleWrongParams(),!1):(this._all=!this._params||!this._params.which||this._params.which===a.ALL,this._minDistanceSquared=void 0!==this._params.minDistance?this._params.minDistance*this._params.minDistance:0,this._maxDistanceSquared=void 0!==this._params.maxDistance?this._params.maxDistance*this._params.maxDistance:0,this._t=new SubjectGroup({spacecrafts:[this._params.target]}),!0)},DistanceCondition.prototype.isSatisfied=function(e){var i,n,s,o=this._subjects.getSpacecrafts(e),r=e.getSpacecraft(this._params.target);if(this._distanceSquared=0,this._active=!0,!r||!r._alive||r._away)return this._active=!1,this._impossible=!r||!r._alive,this._lastSatisfied=!1;for(n=r.pMo.pM,s=0,i=0;i<o.length;i++)if(!o[i]._alive||o[i]._away){if(this._all)return this._active=!1,this._impossible=!o[i]._alive,this._lastSatisfied=!1;o[i]._alive||s++}else if(this._distanceSquared=t.distanceSquared(o[i].pMo.pM,n),(this._minDistanceSquared>0&&this._distanceSquared<this._minDistanceSquared||this._maxDistanceSquared>0&&this._distanceSquared>this._maxDistanceSquared)===this._all)return this._lastSatisfied=!this._all;return s===o.length?(this._active=!1,this._impossible=!0,this._lastSatisfied=!1):this._lastSatisfied=this._all},DistanceCondition.prototype.getObjectiveString=function(t,s,o){var r;return!this._params||void 0===this._params.minDistance&&void 0===this._params.maxDistance||void 0!==this._params.minDistance&&void 0!==this._params.maxDistance?(i.showError("Distance conditions for mission objectives must specify either a minimum or a maximum distance!"),null):this._subjects.isPilotedSpacecraft(o)||this._t.isPilotedSpacecraft(o)?(r=e.formatString(n.get(t,void 0!==this._params.minDistance?n.OBJECTIVE.DISTANCE_MIN_SUFFIX.name:n.OBJECTIVE.DISTANCE_MAX_SUFFIX.name),{minDistance:e.getLengthString(this._params.minDistance,!0),maxDistance:e.getLengthString(this._params.maxDistance,!0),target:this._t.isPilotedSpacecraft(o)?this._subjects.toString():this._t.toString()}),r=r.charAt(0).toUpperCase()+r.slice(1)):(i.showError("Distance conditions for mission objectives must specify the piloted spacecraft as the only subject or as the target!"),null)},DistanceCondition.prototype.getObjectiveStateString=function(t,i,s,o){var r,a,l,c;return(c=this._t.getSpacecrafts(s))&&this._subjects.getSpacecrafts()?(o&&!this._lastSatisfied&&this._distanceSquared>0?(l=Math.sqrt(this._distanceSquared),a=" ("+e.getLengthString(this._params.minDistance?this._params.minDistance-l:l-this._params.maxDistance,!0)+")"):a="",r=e.formatString(n.get(t,void 0!==this._params.minDistance?n.OBJECTIVE.DISTANCE_MIN_SUFFIX.name:n.OBJECTIVE.DISTANCE_MAX_SUFFIX.name),{target:c[0]===s._pilotedCraft?this._subjects.getShortString():this._t.getShortString()})+a,r=r.charAt(0).toUpperCase()+r.slice(1)):""},DistanceCondition.prototype.getTargetSpacecrafts=function(){return e.EMPTY_ARRAY},DistanceCondition.prototype.getEscortedSpacecrafts=function(){return e.EMPTY_ARRAY},DistanceCondition.prototype.canBeImpossible=function(){return!0},DistanceCondition.prototype.isImpossible=function(){return this._impossible},DistanceCondition.prototype.isActive=function(){return this._active},DistanceCondition.prototype.canChangeMultipleTimes=function(){return!0},HitCondition.prototype=new Condition,HitCondition.prototype.constructor=HitCondition,HitCondition.prototype._checkParams=function(e){return this._params=e,!0},HitCondition.prototype._handleHit=function(e,t){(!e||e.indexOf(t.spacecraft)>=0)&&(this._satisfied=!0)},HitCondition.prototype.isSatisfied=function(e,t){var i=this._satisfied;return t>0&&(this._satisfied=!1),i},HitCondition.prototype.getObjectiveString=function(){return i.showError("Hit conditions cannot be used as win/lose conditions!"),null},HitCondition.prototype.getObjectiveStateString=function(){return i.showError("Hit conditions cannot be used as win/lose conditions!"),null},HitCondition.prototype.getTargetSpacecrafts=function(){return e.EMPTY_ARRAY},HitCondition.prototype.getEscortedSpacecrafts=function(){return e.EMPTY_ARRAY},HitCondition.prototype.canChangeMultipleTimes=function(){return!0},CollisionCondition.prototype=new Condition,CollisionCondition.prototype.constructor=CollisionCondition,CollisionCondition.prototype._checkParams=function(e){return this._params=e,!0},CollisionCondition.prototype._handleCollision=function(e,t){(!e||e.indexOf(t.spacecraft)>=0)&&(this._satisfied=!0)},CollisionCondition.prototype.isSatisfied=function(e,t){var i=this._satisfied;return t>0&&(this._satisfied=!1),i},CollisionCondition.prototype.getObjectiveString=function(){return i.showError("Collision conditions cannot be used as win/lose conditions!"),null},CollisionCondition.prototype.getObjectiveStateString=function(){return i.showError("Collision conditions cannot be used as win/lose conditions!"),null},CollisionCondition.prototype.getTargetSpacecrafts=function(){return e.EMPTY_ARRAY},CollisionCondition.prototype.getEscortedSpacecrafts=function(){return e.EMPTY_ARRAY},CollisionCondition.prototype.canChangeMultipleTimes=function(){return!0},AwayCondition.prototype=new Condition,AwayCondition.prototype.constructor=AwayCondition,AwayCondition.prototype._checkParams=function(t){return this._params=t,this._params&&this._params.which&&!e.getSafeEnumValue(a,this._params.which)?(this._handleWrongParams(),!1):(this._all=!this._params||!this._params.which||this._params.which===a.ALL,this._away=!this._params||!1!==this._params.away,!0)},AwayCondition.prototype.isSatisfied=function(e){var t,i=this._subjects.getSpacecrafts(e);for(t=0;t<i.length;t++)if(i[t]._away===this._away!==this._all)return!this._all;return this._all},AwayCondition.prototype.getObjectiveString=function(){return i.showError("Away conditions cannot be used as win/lose conditions!"),null},AwayCondition.prototype.getObjectiveStateString=function(){return i.showError("Away conditions cannot be used as win/lose conditions!"),null},AwayCondition.prototype.getTargetSpacecrafts=function(){return e.EMPTY_ARRAY},AwayCondition.prototype.getEscortedSpacecrafts=function(){return e.EMPTY_ARRAY},AwayCondition.prototype.canChangeMultipleTimes=function(){return!0},OnTeamCondition.prototype=new Condition,OnTeamCondition.prototype.constructor=OnTeamCondition,OnTeamCondition.prototype._checkParams=function(t){return this._params=t,this._params&&(this._params.which&&!e.getSafeEnumValue(a,this._params.which)||!this._params.team)?(this._handleWrongParams(),!1):(this._all=!this._params||!this._params.which||this._params.which===a.ALL,!0)},OnTeamCondition.prototype.isSatisfied=function(e){var t,i=this._subjects.getSpacecrafts(e),n=e.getTeam(this._params.team);for(t=0;t<i.length;t++)if(i[t]._team===n!==this._all)return!this._all;return this._all},OnTeamCondition.prototype.getObjectiveString=function(){return i.showError("OnTeam conditions cannot be used as win/lose conditions!"),null},OnTeamCondition.prototype.getObjectiveStateString=function(){return i.showError("OnTeam conditions cannot be used as win/lose conditions!"),null},OnTeamCondition.prototype.getTargetSpacecrafts=function(){return e.EMPTY_ARRAY},OnTeamCondition.prototype.getEscortedSpacecrafts=function(){return e.EMPTY_ARRAY},OnTeamCondition.prototype.canChangeMultipleTimes=function(){return!0},MissionStateCondition.prototype=new Condition,MissionStateCondition.prototype.constructor=MissionStateCondition,MissionStateCondition.prototype._checkParams=function(t){return this._params=t,this._params&&this._params.missionStates&&this._params.missionStates.every(function(t){return void 0!==h[e.constantName(t)]})?(this._states=this._params.missionStates.map(function(t){return h[e.constantName(t)]}),!0):(this._handleWrongParams(),!1)},MissionStateCondition.prototype.isSatisfied=function(e){var t,i=e._state;for(t=0;t<this._states.length;t++)if(i===this._states[t])return!0;return!1},MissionStateCondition.prototype.getObjectiveString=function(){return i.showError("Mission state conditions cannot be used as win/lose conditions!"),null},MissionStateCondition.prototype.getObjectiveStateString=function(){return i.showError("Mission state conditions cannot be used as win/lose conditions!"),null},MissionStateCondition.prototype.getTargetSpacecrafts=function(){return e.EMPTY_ARRAY},MissionStateCondition.prototype.getEscortedSpacecrafts=function(){return e.EMPTY_ARRAY},MissionStateCondition.prototype.canChangeMultipleTimes=function(){return!0},GetsTargetedCondition.prototype=new Condition,GetsTargetedCondition.prototype.constructor=GetsTargetedCondition,GetsTargetedCondition.prototype._checkParams=function(e){return this._params=e,!0},GetsTargetedCondition.prototype._handleTargeted=function(e,t){(!e||e.indexOf(t.spacecraft)>=0)&&(this._satisfied=!0)},GetsTargetedCondition.prototype.isSatisfied=function(e,t){var i=this._satisfied;return t>0&&(this._satisfied=!1),i},GetsTargetedCondition.prototype.getObjectiveString=function(){return i.showError("GetsTargeted conditions cannot be used as win/lose conditions!"),null},GetsTargetedCondition.prototype.getObjectiveStateString=function(){return i.showError("GetsTargeted conditions cannot be used as win/lose conditions!"),null},GetsTargetedCondition.prototype.getTargetSpacecrafts=function(){return e.EMPTY_ARRAY},GetsTargetedCondition.prototype.getEscortedSpacecrafts=function(){return e.EMPTY_ARRAY},GetsTargetedCondition.prototype.canChangeMultipleTimes=function(){return!0},IsTargetedCondition.prototype=new Condition,IsTargetedCondition.prototype.constructor=IsTargetedCondition,IsTargetedCondition.prototype._checkParams=function(e){return this._params=e,this._all=!this._params||!this._params.which||this._params.which===a.ALL,!0},IsTargetedCondition.prototype.isSatisfied=function(e){var t,i,n,s=this._subjects.getSpacecrafts(e);if(null===this._by){for(t=0;t<s.length;t++)if(s[t]._tedBy.length>0!==this._all)return!this._all}else for(t=0;t<s.length;t++)for(n=s[t]._tedBy,i=0;i<this._by.length;i++)if(n.indexOf(this._by[i])>=0!==this._all)return!this._all;return this._all},IsTargetedCondition.prototype.getObjectiveString=function(){return i.showError("IsTargeted conditions cannot be used as win/lose conditions!"),null},IsTargetedCondition.prototype.getObjectiveStateString=function(){return i.showError("IsTargeted conditions cannot be used as win/lose conditions!"),null},IsTargetedCondition.prototype.getTargetSpacecrafts=function(){return e.EMPTY_ARRAY},IsTargetedCondition.prototype.getEscortedSpacecrafts=function(){return e.EMPTY_ARRAY},IsTargetedCondition.prototype.canChangeMultipleTimes=function(){return!0},o={},o[r.DESTROYED]=DestroyedCondition,o[r.COUNT]=CountCondition,o[r.TIME]=TimeCondition,o[r.HULL_INTEGRITY]=HullIntegrityCondition,o[r.SHIELD_INTEGRITY]=ShieldIntegrityCondition,o[r.DISTANCE]=DistanceCondition,o[r.HIT]=HitCondition,o[r.COLLISION]=CollisionCondition,o[r.AWAY]=AwayCondition,o[r.ON_TEAM]=OnTeamCondition,o[r.MISSION_STATE]=MissionStateCondition,o[r.GETS_TARGETED]=GetsTargetedCondition,o[r.IS_TARGETED]=IsTargetedCondition,{ConditionType:r,ConditionSubjectsWhich:a,CountConditionRelation:l,TimeConditionWhen:c,MissionState:h,SubjectGroup:SubjectGroup,createCondition:createCondition}}),define("armada/logic/missions/actions",["utils/utils","modules/application","modules/game","armada/strings","armada/logic/SpacecraftEvents","armada/logic/missions/conditions","utils/polyfill"],function(e,t,i,n,s,o){"use strict";function Action(t,i){this._type=t?e.getSafeEnumValue(a,t.type,null):null,this._delay=t?t.delay||0:0,this._trigger=i,this._trigger&&this._trigger.addFireHandler(this._addToExecutionQueue.bind(this)),this._subjects=t?new o.SubjectGroup(t.subjects):null,t&&this._checkParams(t.params)}function WinAction(e,t){Action.call(this,e,t)}function LoseAction(e,t){Action.call(this,e,t)}function MessageAction(e,t){Action.call(this,e,t)}function ClearMessagesAction(e,t){Action.call(this,e,t)}function CommandAction(e,t){Action.call(this,e,t)}function SetPropertiesAction(e,t){Action.call(this,e,t)}function RepairAction(e,t){Action.call(this,e,t)}function DamageAction(e,t){Action.call(this,e,t)}function HUDAction(e,t){Action.call(this,e,t)}function createAction(e,t){return new(r[e.type]||Action)(e,t)}var r,a={MESSAGE:"message",CLEAR_MESSAGES:"clearMessages",COMMAND:"command",SET_PROPERTIES:"setProperties",REPAIR:"repair",DAMAGE:"damage",HUD:"hud",WIN:"win",LOSE:"lose"};return Object.freeze(a),Action.prototype.getType=function(){return this._type},Action.prototype._handleWrongParams=function(){t.showError("Wrong parameters specified for action of type: '"+this._type+"'!")},Action.prototype._addToExecutionQueue=function(e){this._delay>0?e.queueAction(this,this._delay):this.execute(e)},Action.prototype.triggerCanBeImpossible=function(){return this._trigger.canBeImpossible()},WinAction.prototype=new Action,WinAction.prototype.constructor=WinAction,WinAction.prototype._checkParams=function(){return!0},WinAction.prototype.execute=function(e){e.completeMission()},WinAction.prototype.getObjectiveCount=function(){return this._trigger.getObjectiveCount(!0)},WinAction.prototype.getObjectiveStrings=function(e){return this._trigger.getObjectiveStrings(n.MISSIONS.OBJECTIVE_WIN_PREFIX,!0,e)},WinAction.prototype.getObjectivesState=function(e,t,i,n){return this._trigger.getObjectivesState(!0,e,t,i,n)},LoseAction.prototype=new Action,LoseAction.prototype.constructor=LoseAction,LoseAction.prototype._checkParams=function(){return!0},LoseAction.prototype.execute=function(e){e.failMission()},LoseAction.prototype.getObjectiveCount=function(){return this._trigger.getObjectiveCount(!1)},LoseAction.prototype.getObjectiveStrings=function(e){return this._trigger.getObjectiveStrings(n.MISSIONS.OBJECTIVE_LOSE_PREFIX,!1,e)},LoseAction.prototype.getObjectivesState=function(e,t,i,n){return this._trigger.getObjectivesState(!1,e,t,i,n)},MessageAction.prototype=new Action,MessageAction.prototype.constructor=MessageAction,MessageAction.prototype._checkParams=function(e){return this._params=e,!(!this._params||!this._params.text&&!this._params.textID||void 0!==this._params.text&&"string"!=typeof this._params.text&&"object"!=typeof this._params.text||void 0!==this._params.textID&&"string"!=typeof this._params.textID||void 0!==this._params.source&&"string"!=typeof this._params.source||void 0!==this._params.duration&&"number"!=typeof this._params.duration||void 0!==this._params.typewriter&&"boolean"!=typeof this._params.typewriter||void 0!==this._params.permanent&&"boolean"!=typeof this._params.permanent||void 0!==this._params.urgent&&"boolean"!=typeof this._params.urgent||void 0!==this._params.silent&&"boolean"!=typeof this._params.silent||void 0!==this._params.noBackground&&"boolean"!=typeof this._params.noBackground)&&(void 0===this._params.color||"object"==typeof this._params.color&&this._params.color instanceof Array)||(this._handleWrongParams(),!1)},MessageAction.prototype.execute=function(t){var s;this._params.source&&!(s=t.getSpacecraft(this._params.source))||i.getScreen().queueHUDMessage({text:(this._params.source?"{spacecrafts/"+this._params.source+"}: ":"")+n.get(n.MISSION.PREFIX,e.getFilenameWithoutExtension(t._name)+n.MISSION.MESSAGES_SUFFIX.name+this._params.textID,"object"==typeof this._params.text?this._params.text[n.getLanguage()]:this._params.text),duration:this._params.duration,appearAnimation:!1!==this._params.typewriter,permanent:this._params.permanent,color:this._params.color,silent:this._params.silent,noBackground:this._params.noBackground,source:s},this._params.urgent)},ClearMessagesAction.prototype=new Action,ClearMessagesAction.prototype.constructor=ClearMessagesAction,ClearMessagesAction.prototype._checkParams=function(){return!0},ClearMessagesAction.prototype.execute=function(){i.getScreen().clearHUDMessages()},CommandAction.prototype=new Action,CommandAction.prototype.constructor=CommandAction,CommandAction.prototype.getSpacecrafts=function(e){return this._subjects.getSpacecrafts(e,!0)},CommandAction.prototype._checkParams=function(e){return this._params=e,!(!this._params||void 0!==this._params.command&&"string"!=typeof this._params.command)||(this._handleWrongParams(),!1)},CommandAction.prototype.execute=function(e){var t,i=this._subjects.getSpacecrafts(e,!0);if(i.length>0)for(this._params.lead=i[0],this._params.clearCache=!0,t=0;t<i.length;t++)this._params.index=t,i[t].handleEvent(s.COMMAND_RECEIVED,this._params)},SetPropertiesAction.prototype=new Action,SetPropertiesAction.prototype.constructor=SetPropertiesAction,SetPropertiesAction.prototype._checkParams=function(e){return this._params=e,!(!this._params||void 0!==this._params.hull&&("number"!=typeof this._params.hull||this._params.hull<0||this._params.hull>100)||void 0!==this._params.shield&&("number"!=typeof this._params.shield||this._params.shield<0||this._params.shield>100)||void 0!==this._params.team&&"string"!=typeof this._params.team||void 0!==this._params.disableFiring&&"boolean"!=typeof this._params.disableFiring)||(this._handleWrongParams(),!1)},SetPropertiesAction.prototype.execute=function(e){var t,i,n=!1,s=this._subjects.getSpacecrafts(e,!0);if(void 0!==this._params.team&&(i=e.getTeam(this._params.team)),s.length>0)for(t=0;t<s.length;t++)void 0!==this._params.hull&&s[t].setHullIntegrity(.01*this._params.hull),void 0!==this._params.shield&&s[t].setShieldIntegrity(.01*this._params.shield),i&&(i.addSpacecraft(s[t]),n=!0),!0===this._params.disableFiring?s[t].disableFiring():!1===this._params.disableFiring&&s[t].enableFiring();n&&e.handleTeamsChanged()},RepairAction.prototype=new Action,RepairAction.prototype.constructor=RepairAction,RepairAction.prototype._checkParams=function(e){return this._params=e,!(!this._params||void 0!==this._params.hull&&("number"!=typeof this._params.hull||this._params.hull<0||this._params.hull>100)||void 0!==this._params.shield&&("number"!=typeof this._params.shield||this._params.shield<0||this._params.shield>100))||(this._handleWrongParams(),!1)},RepairAction.prototype.execute=function(e){var t,i=this._subjects.getSpacecrafts(e,!0);if(i.length>0)for(t=0;t<i.length;t++)void 0!==this._params.hull&&i[t].setHullIntegrity(i[t].getHullIntegrity()+.01*this._params.hull),void 0!==this._params.shield&&i[t].setShieldIntegrity(i[t].getShieldIntegrity()+.01*this._params.shield)},DamageAction.prototype=new Action,DamageAction.prototype.constructor=DamageAction,DamageAction.prototype._checkParams=function(e){return this._params=e,!(!this._params||void 0!==this._params.hull&&("number"!=typeof this._params.hull||this._params.hull<0||this._params.hull>100)||void 0!==this._params.shield&&("number"!=typeof this._params.shield||this._params.shield<0||this._params.shield>100))||(this._handleWrongParams(),!1)},DamageAction.prototype.execute=function(e){var t,i=this._subjects.getSpacecrafts(e,!0);if(i.length>0)for(t=0;t<i.length;t++)void 0!==this._params.hull&&i[t].setHullIntegrity(i[t].getHullIntegrity()-.01*this._params.hull),void 0!==this._params.shield&&i[t].setShieldIntegrity(i[t].getShieldIntegrity()-.01*this._params.shield)},HUDAction.prototype=new Action,HUDAction.prototype.constructor=HUDAction,HUDAction.prototype._checkParams=function(e){return this._params=e,!(!this._params||void 0!==this._params.state&&"string"!=typeof this._params.state)||(this._handleWrongParams(),!1)},HUDAction.prototype.execute=function(e){var t=e._pilotedCraft;t&&t.handleEvent(s.HUD,this._params)},r={},r[a.WIN]=WinAction,r[a.LOSE]=LoseAction,r[a.MESSAGE]=MessageAction,r[a.CLEAR_MESSAGES]=ClearMessagesAction,r[a.COMMAND]=CommandAction,r[a.SET_PROPERTIES]=SetPropertiesAction,r[a.REPAIR]=RepairAction,r[a.DAMAGE]=DamageAction,r[a.HUD]=HUDAction,{ActionType:a,createAction:createAction}}),define("armada/logic/missions/events",["utils/utils","modules/application","armada/strings","armada/logic/missions/conditions","armada/logic/missions/actions","utils/polyfill"],function(e,t,i,n,s){"use strict";function Trigger(i,s){var o,c,h;if(this._conditions=null,i.conditions&&i.conditions.length>0)for(this._conditions=[],o=0;o<i.conditions.length;o++)this._conditions.push(n.createCondition(i.conditions[o],s));if(h=e.getSafeEnumValue(r,i.which,r.ALL),this._all=h===r.ALL,c=e.getSafeEnumValue(a,i.when,a.BECOMES_TRUE),this._falsy=c===a.BECOMES_FALSE,this._all||(this._falsy=!this._falsy),this._once=!0,void 0!==i.once)this._once=i.once;else if(this._conditions)for(o=0;o<this._conditions.length;o++)if(this._conditions[o].canChangeMultipleTimes()){this._once=!1;break}if(this._delay=i.delay||0,this._countDown=!1,this._onFireHandlers=[],this._previousConditionState=!1,this._fired=!1,this._canBeImpossible=!0,this._objectiveState=null,this._conditions)for(this._objectiveState=new Array(this._conditions.length),o=0;o<this._conditions.length;o++)this._objectiveState[o]=l.IN_PROGRESS;if(!this._falsy&&this._conditions)for(this._canBeImpossible=!this._all,o=0;o<this._conditions.length;o++)if(this._conditions[o].canBeImpossible()){this._canBeImpossible=this._all;break}this._conditions||this._once||(t.showError("A trigger has no conditions, 'once' cannot be set to false!"),this._once=!0),!this._once&&this._delay&&(t.showError("Triggers without 'once' cannot have delays!"),this._delay=0)}function MissionEvent(e,t){var i;for(this._name=e.name,this._trigger=new Trigger(e.trigger,t),this._actions=[],i=0;i<e.actions.length;i++)this._actions.push(s.createAction(e.actions[i],this._trigger))}var o=n.MissionState,r={ALL:"all",ANY:"any"},a={BECOMES_TRUE:"becomesTrue",BECOMES_FALSE:"becomesFalse"},l={IN_PROGRESS:0,COMPLETED:1,FAILED:2};return Object.freeze(r),Object.freeze(a),Object.freeze(l),Trigger.prototype.addFireHandler=function(e){this._onFireHandlers.push(e)},Trigger.prototype.fire=function(e){var t;if(this._delay>0)return void(this._countDown=!0);for(t=0;t<this._onFireHandlers.length;t++)this._onFireHandlers[t](e);this._fired=!0},Trigger.prototype.hasFired=function(){return this._fired},Trigger.prototype.simulate=function(e,t){var i,n;if(this._once){if(this._fired)return;if(this._countDown)return this._delay-=t,void(this._delay<=0&&this.fire(e))}if(!this._conditions)return void this.fire(e);for(i=this._all,n=0;n<this._conditions.length;n++)this._conditions[n].isSatisfied(e,t)===this._falsy&&(i=!this._all);!1===this._previousConditionState&&!0===i&&this.fire(e),this._previousConditionState=i},Trigger.prototype.getObjectiveCount=function(e){return e?this._conditions.length:1},Trigger.prototype.getObjectiveStrings=function(e,i,n){var s,o,l,c=[];if(!this._conditions)return t.showError("Win and lose events must have conditions!"),null;if(!this._all)return t.showError("Triggers for mission objectives must be set to 'which' = '"+r.ALL+"'!"),null;if(this._falsy)return t.showError("Triggers for mission objectives must be set to 'when' = '"+a.BECOMES_TRUE+"'!"),null;if(o=this._conditions.length>1,i)for(s=0;s<this._conditions.length;s++)c.push(this._conditions[s].getObjectiveString(e,o,n));else{for(l="",s=0;s<this._conditions.length;s++)l+=(s>0?" ":"")+this._conditions[s].getObjectiveString(e,o,n);c.push(l)}return c},Trigger.prototype.getObjectivesState=function(e,t,n,s,r){var a,c,h,u,d=this._conditions.length>1;if(e)for(a=0;a<this._conditions.length;a++)this._objectiveState[a]===l.IN_PROGRESS&&(this._objectiveState[a]=this._conditions[a].isSatisfied(t,0)?this._conditions[a].canBeImpossible()&&!n?t._state===o.COMPLETED?l.COMPLETED:l.IN_PROGRESS:l.COMPLETED:this._conditions[a].isImpossible()?l.FAILED:l.IN_PROGRESS),(this._objectiveState[a]!==l.IN_PROGRESS||this._conditions[a].isActive()||n)&&(s[r].text=this._conditions[a].getObjectiveStateString(i.BATTLE.OBJECTIVE_WIN_PREFIX,d,t,this._objectiveState[a]===l.IN_PROGRESS),s[r].state=this._objectiveState[a],s[r].completable=!0,r++);else if(this._conditions.length>0){for(c=!0,h=!1,a=0;a<this._conditions.length;a++)if(!this._conditions[a].isSatisfied(t,0)&&(c=!1,this._conditions[a].isImpossible())){h=!0;break}if(this._objectiveState[0]!==l.FAILED&&(this._objectiveState[0]=c?l.FAILED:h||n||t._state===o.COMPLETED?l.COMPLETED:l.IN_PROGRESS),u=this._conditions[0].getObjectiveStateString(i.BATTLE.OBJECTIVE_LOSE_PREFIX,d,t,this._objectiveState[0]===l.IN_PROGRESS),this._objectiveState[0]===l.IN_PROGRESS)for(a=1;a<this._conditions.length;a++)this._conditions[a].isActive()&&(u+=" "+this._conditions[a].getObjectiveStateString(i.BATTLE.OBJECTIVE_LOSE_PREFIX,d,t,!0));u&&(s[r].text=u,s[r].state=this._objectiveState[0],s[r].completable=this._canBeImpossible,r++)}return r},Trigger.prototype.getTargetSpacecrafts=function(e){var t,i=[];for(t=0;t<this._conditions.length;t++)i=i.concat(this._conditions[t].getTargetSpacecrafts(e));return i},Trigger.prototype.getEscortedSpacecrafts=function(e){var t,i=[];for(t=0;t<this._conditions.length;t++)i=i.concat(this._conditions[t].getEscortedSpacecrafts(e));return i},Trigger.prototype.canBeImpossible=function(){return this._canBeImpossible},MissionEvent.prototype.getActions=function(){return this._actions},MissionEvent.prototype.simulate=function(e,t){this._trigger.simulate(e,t)},{TriggerWhen:a,TriggerWhich:r,MissionState:o,ObjectiveState:l,MissionEvent:MissionEvent}}),define("armada/logic/missions",["utils/utils","utils/types","utils/vectors","utils/matrices","modules/application","modules/async-resource","modules/resource-manager","modules/media-resources","modules/pools","modules/egom-model","modules/physics","modules/scene/camera","modules/scene/renderable-objects","armada/constants","armada/control","armada/graphics","armada/networking","armada/logic/classes","armada/configuration","armada/strings","armada/logic/constants","armada/logic/environments","armada/logic/SpacecraftEvents","armada/logic/spacecraft","armada/logic/equipment","armada/logic/formations","armada/logic/explosion","armada/logic/ai","armada/logic/missions/actions","armada/logic/missions/events","utils/polyfill"],function(e,t,i,n,s,o,r,a,l,c,h,u,d,p,_,g,m,f,S,T,y,E,C,M,I,A,x,v,O,R){"use strict";function _compareSpacecrafts(e,t){return e._indexInSquad-t._indexInSquad}function getIndividualSpacecraftDescriptors(t){var i,o,r,a,l,c,h,u,d,p,_,g,m,f,S=[],T={};for(i=0;i<t.length;i++)if(t[i].count){for(r=t[i].squad,T[r]=T[r]||0,a=t[i].names,l=t[i].loadouts,c=t[i].pilotedIndex,h=t[i].positions,u=t[i].formation,d=n.rotation4FromJSON(t[i].rotations),p=t[i].initialBlinkTime,_=t[i].initialBlinkTimeDelta,g=e.deepCopy(t[i]),delete g.count,delete g.names,delete g.loadouts,delete g.pilotedIndex,delete g.positions,delete g.formation,o=0;o<t[i].count;o++)m=e.deepCopy(g),r&&(m.squad=r+" "+(T[r]+o+1).toString()),a&&(m.name=a[o]),l&&(m.loadout=l[o%l.length]),c===o+1&&(m.piloted=!0,delete m.ai),h&&(m.position=h[o]),u&&(h&&s.showError("Both positions and formation have been defined for spacecraft group - formation will be used!",s.ErrorSeverity.MINOR),m.position=A.getPositionInFormation(u,o,m.position,d)),void 0!==p&&(m.initialBlinkTime=p+o*(_||0)),S.push(m);T[r]+=t[i].count}else t[i].squad?(r=M.getSquadName(t[i].squad),f=M.getSquadIndex(t[i].squad),f>0?(f<=T[r]&&s.showError("Spacecraft "+t[i].squad+" defined after squad "+r+" already having "+T[r]+" defined members!",s.ErrorSeverity.MINOR),T[r]=f,S.push(t[i])):(T[r]=T[r]||0,m=e.deepCopy(t[i]),m.squad=r+" "+(T[r]+1).toString(),T[r]+=1,S.push(m))):S.push(t[i]);return S}function getDebugInfo(){return k}function Team(e){this._name=null,this._faction=null,this._displayNameReplacements={index:-1},this._color=null,"string"==typeof e?(this._name=e,this._faction=e):"object"==typeof e?(this._name=e.name||e.faction||s.showError("Team defined without a name or faction!"),this._faction=e.faction,this._displayNameReplacements.index=e.index,this._color=e.color||null):s.showError("Invalid parameter specified for Team constructor!"),this._initialCount=0,this._squads=[]}function Octree(e,t,i,n){this._objects=e,this._centerX=0,this._centerY=0,this._centerZ=0,this._boundaries=null,this._objects.length>0&&this._calculateCenter(n),this._subnodes=t>0&&this._objects.length>i?this._generateSubnodes(t-1,i):null}function Mission(e){this._name=e,this._dataJSON=null,this._nextMissionName=null,this._environment=null,this._ownsEnvironment=!1,this._anticipationTheme=null,this._combatTheme=null,this._views=null,this._teams=null,this._events=null,this._actionQueue=null,this._winActions=null,this._loseActions=null,this._scs=null,this._pilotedCraft=null,this._hitObjects=null,this._state=U.NONE,this._defaultObjective=!0,this._objectivesState=null,this._referenceScore=0,this._tSpacecrafts=null,this._escortedSpacecrafts=null,this._difficultyLevel=null,this._onTeamsChanged=null,this._initialTeamMission=!1}function MissionDescriptor(e,t){r.JSONResource.call(this,e,t,!0),this._test=!0===this._dataJSON.test,this._custom=!0===this._dataJSON.custom,this._pilotedSpacecraftDescriptor=null,this._localData=JSON.parse(localStorage[this._getLocalStorageID()]||"{}"),this._initLocalData()}function DifficultyLevel(e){this._name=e.name,this._playerHitpointsFactor=e.playerHitpointsFactor,this._friendlyHitpointsFactor=e.friendlyHitpointsFactor,this._enemyReactionTimeFactor=e.enemyReactionTimeFactor,this._playerSelfDamage=e.playerSelfDamage,this._playerFriendlyFireDamage=e.playerFriendlyFireDamage,this._hitboxOffset=e.hitboxOffset}function MissionPerformanceLevel(e){this._name=e.name,this._referenceBaseScoreFactor=e.referenceBaseScoreFactor,this._referenceHitRatio=e.referenceHitRatio,this._referenceHullIntegrity=e.referenceHullIntegrity,this._referenceTeamSurvival=e.referenceTeamSurvival}function MissionContext(){o.AsyncResource.call(this),this._difficulty=null,this._difficultyLevels=null,this._missionPerformanceLevels=null,this._tipIDs=null,this._missionManager=new r.ResourceManager}var b,L,N,D,P,w,V,F,U=R.MissionState,B=R.ObjectiveState,H=p.LOCAL_STORAGE_PREFIX+"missions_",G=H+"difficulty",j=null,k="";return Team.prototype.getDisplayName=function(){return e.formatString(T.get(T.FACTION.PREFIX,this._faction,this._faction||this._name),this._displayNameReplacements)},Team.prototype.addSpacecraft=function(e){var t,i,n=e._team,o=e._squad;if(n&&n._removeSpacecraft(e),e._team=this,o){for(t=0;t<this._squads.length;t++)if(o===this._squads[t].name){this._squads[t].crafts.push(e),this._squads[t].crafts.sort(_compareSpacecrafts);break}t>=this._squads.length&&this._squads.push({name:o,crafts:[e]}),i=S.gHS(S.BS.HUD.WINGMEN_STATUS_CRAFT_POSITIONS).length,this._squads[t].crafts.length>i&&s.showError("Warning: squad '"+o+"' of team '"+this._name+"' has more than "+i+" members, and thus cannot be displayed correctly in the wingmen status panel!")}this._initialCount++},Team.prototype._removeSpacecraft=function(e){var t,i,n=e._squad;if(n)for(t=0;t<this._squads.length;t++)if(n===this._squads[t].name){i=this._squads[t].crafts.indexOf(e),this._squads[t].crafts.splice(i,1),0===this._squads[t].crafts.length&&this._squads.splice(t,1);break}this._initialCount--},Octree.prototype._calculateCenter=function(e){var t,i,n,s,o=0,r=0,a=0;for(e&&(n=this._objects[0].pMo.pM,s=this._objects[0].pMo.getSize(),this._boundaries=[n[0]-s,n[0]+s,n[1]-s,n[1]+s,n[2]-s,n[2]+s]),t=0,i=this._objects.length;t<i;t++)n=this._objects[t].pMo.pM,o+=n[12],r+=n[13],a+=n[14],
e&&(s=this._objects[t].pMo.getSize(),n[12]-s<this._boundaries[0]&&(this._boundaries[0]=n[12]-s),n[12]+s>this._boundaries[1]&&(this._boundaries[1]=n[12]+s),n[13]-s<this._boundaries[2]&&(this._boundaries[2]=n[13]-s),n[13]+s>this._boundaries[3]&&(this._boundaries[3]=n[13]+s),n[14]-s<this._boundaries[4]&&(this._boundaries[4]=n[14]-s),n[14]+s>this._boundaries[5]&&(this._boundaries[5]=n[14]+s));o/=i,r/=i,a/=i,this._centerX=o,this._centerY=r,this._centerZ=a},Octree.prototype._generateSubnodes=function(t,i){var n,s,o,r,a,l,c,h,u,d,p,_,g,m;for(n=0,s=this._objects.length;n<s;n++)r=this._objects[n],a=r.pMo.pM,o=r.pMo.getSize(),a[12]-o<this._centerX&&(a[13]-o<this._centerY&&(a[14]-o<this._centerZ&&(l=l||[],l.push(r)),a[14]+o>=this._centerZ&&(c=c||[],c.push(r))),a[13]+o>=this._centerY&&(a[14]-o<this._centerZ&&(h=h||[],h.push(r)),a[14]+o>=this._centerZ&&(u=u||[],u.push(r)))),a[12]+o>=this._centerX&&(a[13]-o<this._centerY&&(a[14]-o<this._centerZ&&(d=d||[],d.push(r)),a[14]+o>=this._centerZ&&(p=p||[],p.push(r))),a[13]+o>=this._centerY&&(a[14]-o<this._centerZ&&(_=_||[],_.push(r)),a[14]+o>=this._centerZ&&(g=g||[],g.push(r))));return m=new Array(8),m[0]=new Octree(l||e.EMPTY_ARRAY,t,i,!1),m[1]=new Octree(c||e.EMPTY_ARRAY,t,i,!1),m[2]=new Octree(h||e.EMPTY_ARRAY,t,i,!1),m[3]=new Octree(u||e.EMPTY_ARRAY,t,i,!1),m[4]=new Octree(d||e.EMPTY_ARRAY,t,i,!1),m[5]=new Octree(p||e.EMPTY_ARRAY,t,i,!1),m[6]=new Octree(_||e.EMPTY_ARRAY,t,i,!1),m[7]=new Octree(g||e.EMPTY_ARRAY,t,i,!1),m},Octree.prototype.executeForObjects=function(e,t,i,n,s,o,r){var a;if(!this._subnodes){for(a=0;a<this._objects.length;a++)if(r(this._objects[a]))return!0;return!1}if(this._boundaries&&(t<this._boundaries[0]||e>this._boundaries[1]||n<this._boundaries[2]||i>this._boundaries[3]||o<this._boundaries[4]||s>this._boundaries[5]))return!1;if(e<this._centerX){if(i<this._centerY){if(s<this._centerZ&&this._subnodes[0].executeForObjects(e,t,i,n,s,o,r))return!0;if(o>=this._centerZ&&this._subnodes[1].executeForObjects(e,t,i,n,s,o,r))return!0}if(n>=this._centerY){if(s<this._centerZ&&this._subnodes[2].executeForObjects(e,t,i,n,s,o,r))return!0;if(o>=this._centerZ&&this._subnodes[3].executeForObjects(e,t,i,n,s,o,r))return!0}}if(t>=this._centerX){if(i<this._centerY){if(s<this._centerZ&&this._subnodes[4].executeForObjects(e,t,i,n,s,o,r))return!0;if(o>=this._centerZ&&this._subnodes[5].executeForObjects(e,t,i,n,s,o,r))return!0}if(n>=this._centerY){if(s<this._centerZ&&this._subnodes[6].executeForObjects(e,t,i,n,s,o,r))return!0;if(o>=this._centerZ&&this._subnodes[7].executeForObjects(e,t,i,n,s,o,r))return!0}}return!1},Mission.prototype.getData=function(){return this._dataJSON},Mission.prototype.getId=function(){return this._dataJSON.id},Mission.prototype.getTitle=function(){return this._title},Mission.prototype.getNextMissionName=function(){return this._nextMissionName},Mission.prototype.getAnticipationTheme=function(){return this._anticipationTheme},Mission.prototype.getCombatTheme=function(){return this._combatTheme},Mission.prototype.getSpacecraft=function(e){var t;for(t=0;t<this._scs.length;t++)if(this._scs[t].getID()===e)return this._scs[t];return null},Mission.prototype.getSpacecrafts=function(){return this._scs},Mission.prototype.getSpacecraftsInSquad=function(e){var t,i=[];for(t=0;t<this._scs.length;t++)this._scs[t]._squad===e&&i.push(this._scs[t]);return i},Mission.prototype.applyToSpacecrafts=function(e){var t;for(t=0;t<this._scs.length;t++)e(this._scs[t])},Mission.prototype.isFinished=function(){return this._state===U.COMPLETED||this._state===U.FAILED||this._state===U.DEFEAT||this._state===U.ENDED},Mission.prototype.getTargetSpacecrafts=function(){return this._tSpacecrafts},Mission.prototype.getEscortedSpacecrafts=function(){return this._escortedSpacecrafts},Mission.prototype.getDifficultyLevel=function(){return this._difficultyLevel},Mission.prototype.completeMission=function(){this._state===U.IN_PROGRESS&&(this._state=U.COMPLETED)},Mission.prototype.failMission=function(){this._state!==U.IN_PROGRESS&&this._state!==U.COMPLETED||!this._pilotedCraft||this._pilotedCraft._away||(this._state=U.FAILED)},Mission.prototype._updateState=function(){var e,t;if(this._pilotedCraft){if(this._pilotedCraft._away||this._updateObjectivesState(),!this._pilotedCraft._alive)return void(this._state=U.DEFEAT);if(this._state===U.BATTLE){for(e=0;e<this._scs.length;e++)if(this._scs[e]&&this._scs[e]._alive&&this._pilotedCraft.isHostile(this._scs[e]))return;return void(this._state=U.COMPLETED)}if(this._state===U.IN_PROGRESS&&!this._pilotedCraft._away){for(t=!0,e=0;e<this._objectivesState.length;e++){if(this._objectivesState[e].state===B.FAILED)return void(this._state=U.FAILED);t=t&&(this._objectivesState[e].state===B.COMPLETED||!this._objectivesState[e].completable)&&this._objectivesState[e].text}if(t)return void(this._state=U.COMPLETED)}}else if(this._state===U.BATTLE&&this.noHostilesPresent())return void(this._state=U.ENDED)},Mission.prototype.noHostilesPresent=function(){var e,t,i=null;for(e=0;e<this._scs.length;e++)if(this._scs[e]&&this._scs[e]._alive){if((t=this._scs[e]._team)&&i&&t!==i)return!1;i=t}return!0},Mission.prototype.getSpacecraftCountForTeam=function(e){var t,i=0;for(t=0;t<this._scs.length;t++)this._scs[t]&&this._scs[t]._alive&&this._scs[t]._team===e&&i++;return i},Mission.prototype.getHostileSpacecraftCount=function(e,t){var i,n=0;for(i=0;i<this._scs.length;i++)!this._scs[i]||!this._scs[i]._alive||t&&this._scs[i]._away||this._scs[i].isHostile(e)&&n++;return n},Mission.prototype.getFollowedSpacecraftForScene=function(e){var t,i;if(e._camera.getFollowedNode())for(t=e._camera.getFollowedNode()._renderableObject,i=0;i<this._scs.length;i++)if(this._scs[i].vMo===t)return this._scs[i];return null},Mission.prototype.getEnvironment=function(){return this._environment},Mission.prototype.getTeam=function(e){var t;for(t=0;t<this._teams.length;t++)if(this._teams[t]._name===e)return this._teams[t];return s.showError("No team exists with name '"+e+"'!"),null},Mission.prototype.getEvent=function(e){var t;for(t=0;t<this._events.length;t++)if(this._events[t]._name===e)return this._events[t];return s.showError("No mission event exists with name '"+e+"'!"),null},Mission.prototype.getObjectives=function(){var e,t=[];for(this._defaultObjective&&t.push(T.get(T.MISSIONS.OBJECTIVE_WIN_PREFIX,T.OBJECTIVE.DESTROY_ALL_SUFFIX.name)),e=0;e<this._winActions.length;e++)t=t.concat(this._winActions[e].getObjectiveStrings(this));for(e=0;e<this._loseActions.length;e++)t=t.concat(this._loseActions[e].getObjectiveStrings(this));return t},Mission.prototype.getObjectivesState=function(e){return e&&this._updateObjectivesState(e),this._objectivesState},Mission.prototype._updateObjectivesState=function(e){var t,i,n,s,o=0;for(this._defaultObjective&&(s=this._pilotedCraft,i="",s&&(n=this.getHostileSpacecraftCount(s,!0))>0&&(i=" ("+n+")"),this._objectivesState[0].text=T.get(T.BATTLE.OBJECTIVE_WIN_PREFIX,T.OBJECTIVE.DESTROY_ALL_SUFFIX.name)+i,this._objectivesState[0].state=s&&s._alive?this.getHostileSpacecraftCount(s,!1)>0?B.IN_PROGRESS:B.COMPLETED:B.FAILED,this._objectivesState[0].completable=!0,o++),t=0;t<this._winActions.length;t++)o=this._winActions[t].getObjectivesState(this,e,this._objectivesState,o);for(t=0;t<this._loseActions.length;t++)o=this._loseActions[t].getObjectivesState(this,e,this._objectivesState,o);for(;o<this._objectivesState.length;)this._objectivesState[o].text="",o++},Mission.prototype.loadEnvironment=function(e){"string"==typeof e.environment?(this._environment=E.getEnvironment(e.environment),this._environment||s.showError("Cannot load environment '"+e.environment+"' for mission: no such environment exists!"),this._ownsEnvironment=!1):"object"==typeof e.environment?(this._environment=new E.Environment(e.environment),this._ownsEnvironment=!0):s.showError("Invalid environment specified for mission!")},Mission.prototype.loadObjectives=function(e){var t,i,n,s,o,r;if(!this._scs)for(this._scs=[],r=getIndividualSpacecraftDescriptors(e.spacecrafts),t=0;t<r.length;t++)if(r[t].piloted){this._pilotedCraft=new M.Spacecraft,this._pilotedCraft.loadFromJSON(r[t]),this._scs.push(this._pilotedCraft);break}if(this._events=[],e.events)for(t=0;t<e.events.length;t++)this._events.push(new R.MissionEvent(e.events[t],this));for(this._actionQueue=[],this._state=U.NONE,this._winActions=[],this._loseActions=[],t=0;t<this._events.length;t++)for(n=this._events[t].getActions(),i=0;i<n.length;i++)s=n[i].getType(),s===O.ActionType.WIN?this._winActions.push(n[i]):s===O.ActionType.LOSE&&this._loseActions.push(n[i]);if(this._defaultObjective=0===this._winActions.length,this._defaultObjective)for(t=0;t<this._loseActions.length;t++)if(this._loseActions[t].triggerCanBeImpossible()){this._defaultObjective=!1;break}if(o=this._defaultObjective?1:0,this._pilotedCraft){for(t=0;t<this._winActions.length;t++)o+=this._winActions[t].getObjectiveCount();for(t=0;t<this._loseActions.length;t++)o+=this._loseActions[t].getObjectiveCount()}for(this._objectivesState=new Array(o),t=0;t<o;t++)this._objectivesState[t]={};(this._winActions.length>0||this._loseActions.length>0)&&(this._state=U.IN_PROGRESS)},Mission.prototype.queueAction=function(e,t){this._actionQueue.push({action:e,delay:t})},Mission.prototype.getReferenceScore=function(){return this._referenceScore},Mission.prototype.hasShadows=function(){return this._environment.hasShadows()},Mission.prototype.loadFromJSON=function(e,t,i){var n,o,r,a,l,c,u,d,p,g,m;if(this._difficultyLevel=F.getDifficultyLevel(t),I.handleDifficultySet(this._difficultyLevel),A.resetRandomSeed(),this._dataJSON=e,this._title=e.title||"",this._nextMissionName=e.nextMission||null,this.loadEnvironment(e),h.setDrag(this._environment.getDrag(),this._environment._angularDrag),this._anticipationTheme=e.anticipationTheme,this._combatTheme=e.combatTheme,this._teams=[],e.teams)for(n=0;n<e.teams.length;n++)this._teams.push(new Team("string"==typeof e.teams[n]?e.teams[n]:Object.assign({index:(n+1).toString()},e.teams[n])));if(this._views=[],e.views)for(n=0;n<e.views.length;n++)this._views.push(new f.SceneView(e.views[n]));for(this._scs=[],this._hitObjects=[],v.clearAIs(),g=getIndividualSpacecraftDescriptors(e.spacecrafts),n=0;n<g.length;n++)r=new M.Spacecraft,r.loadFromJSON(g[n],this._hitObjects,this._environment),!i&&g[n].piloted&&(this._pilotedCraft=r,r.multiplyMaxHitpoints(this._difficultyLevel._playerHitpointsFactor),m=function(e,t){_.getInputInterpreter(_.GAMEPAD_NAME).vibrate(e.getHullIntegrity()<=0?"destroyed":t.hullDamage>0?"hull-hit":"shield-hit")}.bind(this,r),r.addEventHandler(C.BEING_HIT,m),r.addEventHandler(C.COLLIDED,m)),g[n].multi&&(r.setAsMultiControlled(g[n].piloted,n),!g[n].piloted&&g[n].multiPiloted&&r.multiplyMaxHitpoints(this._difficultyLevel._playerHitpointsFactor)),r._piloted=!!g[n].piloted||!!g[n].multiPiloted,a=g[n].team,a?(l=this.getTeam(a),l?l.addSpacecraft(r):s.showError("Invalid team ID '"+a+"' specified for "+r.getClassName()+"!")):i&&(l=new Team({faction:"numbered",index:(this._teams.length+1).toString()}),this._teams.push(l),r._team=l),this._scs.push(r);for(this._referenceScore=0,this._initialTeamMission=!1,l=this._pilotedCraft&&this._pilotedCraft._team,d=1,p=this._difficultyLevel._friendlyHitpointsFactor,n=0;n<g.length;n++)r=this._scs[n],g[n].initialTarget&&r.setTarget(this.getSpacecraft(g[n].initialTarget)),this._pilotedCraft&&(!g[n].excludeFromReferenceScore&&this._pilotedCraft.isHostile(r)&&(this._referenceScore+=r.getScoreValue()),this._pilotedCraft.isFriendly(r)&&r!==this._pilotedCraft&&(g[n].multiPiloted||r.multiplyMaxHitpoints(p),(r.hasWeapons()||r.hasMissiles())&&(this._initialTeamMission=!0,d++))),c=g[n].ai,!c&&i&&(c=r.isFighter()?"fighter":"ship"),c&&v.addAI(c,r,this);for(d>1&&(this._referenceScore/=d),this.loadObjectives(e),this._tSpacecrafts=[],n=0;n<this._events.length;n++)for(u=this._events[n].getActions(),o=0;o<u.length;o++)u[o].getType()===O.ActionType.WIN&&(this._tSpacecrafts=this._tSpacecrafts.concat(this._events[n]._trigger.getTargetSpacecrafts(this)));for(this._escortedSpacecrafts=[],n=0;n<this._events.length;n++)for(u=this._events[n].getActions(),o=0;o<u.length;o++)u[o].getType()===O.ActionType.LOSE&&(this._escortedSpacecrafts=this._escortedSpacecrafts.concat(this._events[n]._trigger.getEscortedSpacecrafts(this)));this._pilotedCraft||(this._state=U.NONE),this._state!==U.NONE||this.noHostilesPresent()||(this._state=U.BATTLE)},Mission.prototype.isTeamMission=function(){return this._pilotedCraft&&this._pilotedCraft._team&&this._pilotedCraft._team._initialCount>1},Mission.prototype.isInitialTeamMission=function(){return this._initialTeamMission},Mission.prototype.getScoreStatistics=function(e,t,i,n,s){var o,r,a,l,c=this.isTeamMission();return e=Math.round(e),o=Math.round((e||0)*(t||.5*(s||0))),r=Math.round(i*(c?100:200)),c&&(a=Math.round(100*n)),l=e+o+r+(c?a:0),{baseScore:e,hitRatioBonus:o,hullIntegrityBonus:r,teamSurvivalBonus:a,score:l}},Mission.prototype.getPerformanceStatistics=function(){var e=this._pilotedCraft,t=this.isTeamMission(),i=t?(this.getSpacecraftCountForTeam(e._team)-(e._alive?1:0))/(e._team._initialCount-1):0,n=this.getScoreStatistics(e.getScore(),e.getHitRatio(),e.getHullIntegrity(),i,e.getMissileHitRatio()),s=F.getPerformanceInfo(this,n.score);return{baseScore:n.baseScore,hitRatioBonus:n.hitRatioBonus,hullIntegrityBonus:n.hullIntegrityBonus,teamSurvival:t?i:void 0,teamSurvivalBonus:n.teamSurvivalBonus,score:n.score,performance:s.performance,nextPerformance:s.nextPerformance,nextPerformanceScore:s.nextPerformanceScore}},Mission.prototype.getPerformanceLevelScores=function(){return F.getPerformanceLevelScores(this)},Mission.prototype.createCameraConfigurationForSceneView=function(e,t){var i,s,o=n.getYawAndPitch(e.oM);return i=new u.CameraPositionConfiguration(!e.isMovable(),e.turnsAroundObjects(),e.movesRelativeToObject(),e.getPositionFollowedObjectsForScene(t),e.startsWithRelativePosition(),n.copy(e.pM),e.getDistanceRange(),e.getConfines(),e.resetsWhenLeavingConfines()),s=new u.CameraOrientationConfiguration(!e.isTurnable(),e.pointsTowardsObjects(),e.isFPS(),e.getOrientationFollowedObjectsForScene(t),n.copy(e.oM),Math.degrees(o.yaw),Math.degrees(o.pitch),e.getAlphaRange(),e.getBetaRange(),e.getBaseOrientation()||S.getDefaultCameraBaseOrientation(),e.getPointToFallback()||S.getDefaultCameraPointToFallback()),new u.CameraConfiguration(e._name,i,s,e.getFOV()||S.getDefaultCameraFOV(),e.getFOVRange(),e.getSpan()||S.getDefaultCameraSpan(),e.resetsOnFocusChange())},Mission.prototype._handleSpacecraftJumpIn=function(e){this._hitObjects.indexOf(e)<=0&&this._hitObjects.push(e)},Mission.prototype.getMaxProjectileCount=function(){var e,t=0;for(e=0;e<this._scs.length;e++)t+=this._scs[e].getMaxProjectileCount();return t},Mission.prototype.getMaxMissileCount=function(){var e,t=0;for(e=0;e<this._scs.length;e++)t+=this._scs[e].getMaxMissileCount();return t},Mission.prototype.getMaxExplosionCount=function(){var e,t=0;for(e=0;e<this._scs.length;e++)t+=this._scs[e].getMaxExplosionCount();return t},Mission.prototype.getMaxParticleCount=function(){var e,t=0;for(e=0;e<this._scs.length;e++)t+=this._scs[e].getMaxParticleCount();return t},Mission.prototype.addToScene=function(t,o,r){var l,h,u,p,_,m,f,T,y,E,M,I,A,x,R,b,F,U,B,H=!!r;for(this._environment.addToScene(t),H&&(U=new Map,v.resetJumpInPositionSeed(),g.getShader(r.gridShaderName),g.getShader(r.markerShaderName),x=r.markerColorPositive,R=r.markerColorNegative,b=r.jumpMarkerColor,a.getOrAddModel(c.gridModel("grid",2*r.smallestGridSize,2*r.smallestGridSize,2*r.smallestGridSize+1,2*r.smallestGridSize+1)),a.getOrAddModel(c.positionMarkerModel("marker",8)),a.getOrAddModel(c.lineModel("line",[1,1,1])),a.executeWhenReady(function(){var e,i,s,o=r.gridColor,a=g.getManagedShader(r.gridShaderName),l=g.getModel("grid").getEgomModel();for(i=r.smallestGridSize,e=0;e<r.gridCount;e++)s=new d.ShadedLODMesh(l,a,{},n.identity4(),n.identity4(),n.scaling4(i),!0,0,r.smallestSizeWhenDrawn),s.setUniformValueFunction(d.UNIFORM_COLOR_NAME,function(){return o}),s.setUniformValueFunction(j,function(){return g.getGroupTransformIdentityArray()}),t.addObject(s,!1),i*=r.smallestGridSize}),I=r.friendlyColor,A=r.hostileColor,B=function(e,t){return e._away?[r.awayColorFactor*t[0],r.awayColorFactor*t[1],r.awayColorFactor*t[2],r.awayAlphaFactor*t[3]]:t},F=function(e,s,o){var l,c=o.pM,h=B(e,s);o.setUniformValueFunction(d.UNIFORM_COLOR_NAME,function(){return h}),0!==c[14]&&(l=new d.ShadedLODMesh(a.getModel("marker").getEgomModel(),g.getManagedShader(r.markerShaderName),{},n.translation4(c[12],c[13],0),n.identity4(),n.scaling4(r.markerSize,r.markerSize,c[14]),!0,0,r.smallestSizeWhenDrawn),l.setUniformValueFunction(d.UNIFORM_COLOR_NAME,function(){return c[14]>0?x:R}),t.addObject(l,!1)),U.has(e)&&(l=new d.ShadedLODMesh(a.getModel("line").getEgomModel(),g.getManagedShader(r.markerShaderName),{},n.translation4(c[12],c[13],c[14]),n.identity4(),n.scaling4(U.get(e)[0],U.get(e)[1],U.get(e)[2]),!0,0,r.smallestSizeWhenDrawn),l.setUniformValueFunction(d.UNIFORM_COLOR_NAME,function(){return b}),l.setModelSize(i.length3(U.get(e))/Math.max(Math.abs(U.get(e)[0]),Math.abs(U.get(e)[1]),Math.abs(U.get(e)[2]))),t.addObject(l,!1)),++_===p&&r.callback&&r.callback()}),p=this._scs.length,_=0,l=0;l<this._scs.length;l++){if(H&&(m=this._scs[l],M=!this._pilotedCraft||!m.isHostile(this._pilotedCraft),m._away&&0===m.pMo.pM[12]&&0===m.pMo.pM[13]&&0===m.pMo.pM[14]))for(y=!1,h=0;h<this._events.length;h++){for(f=this._events[h].getActions(),u=0;u<f.length;u++)if(f[u].getType()===O.ActionType.COMMAND&&f[u]._params.command===v.SpacecraftCommand.JUMP&&(T=f[u]._params,T.jump&&T.jump.way!==v.JumpCommandWay.OUT&&T.jump.anchor&&(E=f[u].getSpacecrafts(this).indexOf(m))>=0)){T=e.deepCopy(T),T.lead=f[u].getSpacecrafts(this)[0],T.index=E,T.clearCache=!0,v.positionForInwardJump(m,T,this),y=!0,0===E&&(T.jump.anchorSpacecraft?U.set(m,i.diff3(T.jump.anchorSpacecraft.getPhysicalPositionVector(),m.getPhysicalPositionVector())):s.showError(m.getDisplayName()+" has invalid anchor: "+T.jump.anchor+"!"));break}if(y)break}this._scs[l].addToScene(t,void 0,H,{hitboxes:!1,weapons:!0,missilesInLaunchers:g.areMissilesInLaunchersVisible(),thrusterParticles:!H,projectileResources:!H,missileResources:!H,explosion:!H,damageIndicators:!H,cameraConfigurations:!H,lightSources:!H,blinkers:!H,jumpEngine:!H,shield:!H,sound:!H},{replaceVisualModel:H,randomAnimationTime:!0,smallestSizeWhenDrawn:H?r.smallestSizeWhenDrawn:void 0,shaderName:H?r.spacecraftShaderName:null},H?F.bind(this,this._scs[l],M?I:A):null),o&&this._scs[l].addToScene(o,g.getMaxLoadedLOD(),!0,{weapons:!0},{shaderName:S.gHS(S.BS.HUD.TARGET_VIEW_TARGET_ITEM_SHADER)}),this._scs[l]._away?this._scs[l].addEventHandler(C.JUMPED_IN,this._handleSpacecraftJumpIn.bind(this,this._scs[l])):this._hitObjects.push(this._scs[l])}H||a.executeWhenReady(function(){if(this._views.length>0)for(l=0;l<this._views.length;l++)t.addCameraConfiguration(this.createCameraConfigurationForSceneView(this._views[l],t)),0===l&&t._camera.followNode(null,!0,0);else this._pilotedCraft&&t._camera.followNode(this._pilotedCraft.vMo._node,!0,0,null,S.getDefaultCameraConfigurationName(this._pilotedCraft));t._camera.update(0),L.prefill(Math.ceil(.2*this.getMaxParticleCount())),N.prefill(Math.ceil(.75*this.getMaxProjectileCount()),function(e){e.createVisualModel()}),D.prefill(Math.ceil(.2*this.getMaxMissileCount()),function(e){e.createVisualModel()}),V.prefill(Math.ceil(.5*this.getMaxExplosionCount()),function(e){e.createVisualModel()}),P.prefill(Math.ceil(.2*this.getMaxMissileCount())),w.prefill(Math.ceil(.2*this.getMaxMissileCount()*50))}.bind(this))},Mission.prototype.toggleHitboxVisibility=function(){var e;for(e=0;e<this._scs.length;e++)this._scs[e].toggleHitboxVisibility()},Mission._handleProjectile=function(e,t,i,n){i.simulate(e,t),i.canBeReused()&&N.markAsFree(n)},Mission._handleMissile=function(e,t,i,n){i.simulate(e,t),i.canBeReused()&&D.markAsFree(n)},Mission._handleTrail=function(e,t){e.canBeReused()&&P.markAsFree(t)},Mission._handleTrailSegment=function(e,t){e.canBeReused()&&w.markAsFree(t)},Mission._handleExplosion=function(e,t){e.canBeReused()&&V.markAsFree(t)},Mission._handleParticle=function(e,t){e.canBeReused()&&L.markAsFree(t)},Mission._filterActionEntry=function(e){return e.delay>0},Mission.prototype.onTeamsChanged=function(e){this._onTeamsChanged=e},Mission.prototype.handleTeamsChanged=function(){this._onTeamsChanged&&this._onTeamsChanged()},Mission.prototype.prepareScene=function(e){return!!this._environment.addParticleEffectsToScene(e)&&(this._environment.simulate(),!0)},Mission.prototype.tick=function(e,t,n){var s,o,r,a,l,c,h,u,d,p;for(this._environment.simulate(),s=0;s<this._actionQueue.length;s++)this._actionQueue[s].delay-=e,this._actionQueue[s].delay<=0&&this._actionQueue[s].action.execute(this);for(this._actionQueue=this._actionQueue.filter(Mission._filterActionEntry),s=0;s<this._events.length;s++)this._events[s].simulate(this,this._pilotedCraft&&this._pilotedCraft._away?0:e);for(s=0;s<this._scs.length;s++)this._scs[s].simulate(e),this._scs[s]._alive&&!this._scs[s]._away||(l=this._hitObjects.indexOf(this._scs[s]),l>=0&&(this._hitObjects[l]=null,this._hitObjects.splice(l,1)),this._scs[s]._alive||(this._scs[s].destroy(!0),n||(this._scs[s]=null,this._scs.splice(s,1),s--)));for(s=0;s<this._scs.length-1;s++)if(this._scs[s]._hitpoints>0&&!this._scs[s]._away)for(o=s+1;o<this._scs.length;o++)this._scs[o]._hitpoints>0&&!this._scs[o]._away&&(c=this._scs[s].pMo.checkCollision(this._scs[o].pMo,e))&&(h=this._scs[c.reverse?o:s],u=this._scs[c.reverse?s:o],d=Math.min(Math.min(c.magnitude*c.magnitude*25e-5,this._scs[s].getClass()._hitpoints),this._scs[o].getClass()._hitpoints),p=i.prodVec4Mat4Aux(c.position,h.pMo.getModelMatrix()),h.damage(d,c.position,i.scaled3(c.direction,-1),u,!1,0,!0),u.damage(d,i.prodVec4Mat4Aux(p,u.pMo.getModelMatrixInverse()),i.normal3(i.prodMat4Vec3Aux(u.pMo.oM,i.prodVec3Mat4Aux(c.direction,h.pMo.oM))),h,!1,0,!0),i.mulVec3ModelMat4(p,t._camera.getViewMatrix()),(h.getClass()._mass<=u.getClass()._mass?h:u).playCollisionSound(p));N.hasLockedObjects()&&(a=new Octree(this._hitObjects,2,1,!0),N.executeForLockedObjects(Mission._handleProjectile.bind(this,e,a))),D.hasLockedObjects()&&(a=a||new Octree(this._hitObjects,2,1,!0),D.executeForLockedObjects(Mission._handleMissile.bind(this,e,a))),V.hasLockedObjects()&&V.executeForLockedObjects(Mission._handleExplosion),L.hasLockedObjects()&&L.executeForLockedObjects(Mission._handleParticle),P.hasLockedObjects()&&P.executeForLockedObjects(Mission._handleTrail),w.hasLockedObjects()&&w.executeForLockedObjects(Mission._handleTrailSegment),!t||n&&!m.isHost()||(r=t.moveCameraToOrigoIfNeeded(2e3))&&v.handleSceneMoved(r),this._updateState()},Mission.prototype.destroy=function(){var e;if(this._environment&&(this._ownsEnvironment?this._environment.destroy():this._environment.removeFromScene()),this._environment=null,this._views){for(e=0;e<this._views.length;e++)this._views[e]&&(this._views[e].destroy(),this._views[e]=null);this._views=null}if(this._scs){for(e=0;e<this._scs.length;e++)this._scs[e]&&(this._scs[e].destroy(),this._scs[e]=null);this._scs=null}this._pilotedCraft=null,this._hitObjects=null,L.clear(),N.clear(),D.clear(),V.clear(),P.clear(),w.clear()},MissionDescriptor.prototype=new r.JSONResource,MissionDescriptor.prototype.constructor=MissionDescriptor,MissionDescriptor.prototype._initLocalData=function(){var e,t,i=F.getDifficultyNames();for(e=0;e<i.length;e++)this._localData[i[e]]=this._localData[i[e]]||{},t=this._localData[i[e]],t.winCount=t.winCount||0,t.loseCount=t.loseCount||0},MissionDescriptor.prototype._getLocalStorageID=function(){return H+this._name},MissionDescriptor.prototype._saveLocalData=function(){localStorage[this._getLocalStorageID()]=JSON.stringify(this._localData)},MissionDescriptor.prototype.getTitle=function(){return this._dataJSON.title||""},MissionDescriptor.prototype.getDescription=function(){return this._dataJSON.description||""},MissionDescriptor.prototype.getAuthor=function(){return this._dataJSON.info?this._dataJSON.info.author:null},MissionDescriptor.prototype.getDisplayDescription=function(){return T.get(T.MISSION.PREFIX,e.getFilenameWithoutExtension(this._name)+T.MISSION.DESCRIPTION_SUFFIX.name,this.getDescription()?e.formatString(T.get(T.MISSIONS.NO_TRANSLATED_DESCRIPTION),{originalDescription:this.getDescription()}):T.get(T.MISSIONS.NO_DESCRIPTION))},MissionDescriptor.prototype.getPilotedSpacecraftDescriptor=function(){var e,t;if(!this._pilotedSpacecraftDescriptor)for(t=getIndividualSpacecraftDescriptors(this._dataJSON.spacecrafts),e=0;e<t.length;e++)if(t[e].piloted){this._pilotedSpacecraftDescriptor=t[e];break}return this._pilotedSpacecraftDescriptor},MissionDescriptor.prototype.getEnvironment=function(){var e=null;return this._readyToUse?(e=new Mission(this._name),e.loadEnvironment(this._dataJSON),e.getEnvironment()):(s.showError("Cannot get mission environment from mission descriptor that has not yet been initialized!"),null)},MissionDescriptor.prototype.getMissionObjectives=function(){var e=null;return this._readyToUse?(e=new Mission(this._name),e.loadObjectives(this._dataJSON),e.getObjectives()):(s.showError("Cannot get mission objectives from mission descriptor that has not yet been initialized!"),null)},MissionDescriptor.prototype.getTipIDs=function(){return this._dataJSON.tips},MissionDescriptor.prototype.createMission=function(e,t){var i=null;return this._readyToUse?(i=new Mission(this._name),i.loadFromJSON(this._dataJSON,e,t)):s.showError("Cannot create mission from descriptor that has not yet been initialized!"),i},MissionDescriptor.prototype.getBestScore=function(e){return e=e||F.getDifficulty(),this._localData[e].bestScore},MissionDescriptor.prototype.getBestPerformance=function(e){return e=e||F.getDifficulty(),this._localData[e].bestPerformance},MissionDescriptor.prototype.updateBestScore=function(e,t,i){i=i||F.getDifficulty();var n=this._localData[i];return(void 0===n.bestScore||e>n.bestScore)&&(n.bestScore=e,n.bestPerformance=t,this._saveLocalData(),!0)},MissionDescriptor.prototype.increasePlaythroughCount=function(e,t){t=t||F.getDifficulty(),e?this._localData[t].winCount++:this._localData[t].loseCount++,this._saveLocalData()},MissionDescriptor.prototype.getWinCount=function(e){return e=e||F.getDifficulty(),this._localData[e].winCount},MissionPerformanceLevel.prototype.getRequiredScore=function(e){return this._referenceBaseScoreFactor?e.getScoreStatistics(e.getReferenceScore()*(e.isInitialTeamMission()?this._referenceBaseScoreFactor:1),this._referenceHitRatio,this._referenceHullIntegrity,this._referenceTeamSurvival).score:0},MissionContext.prototype=new o.AsyncResource,MissionContext.prototype.constructor=MissionContext,MissionContext.prototype.getPerformanceInfo=function(e,t){var i,n={},s=this._missionPerformanceLevels.length;for(i=0;i<s&&!(t<this._missionPerformanceLevels[i].getRequiredScore(e));i++);return n.performance=i>0?this._missionPerformanceLevels[i-1]._name:"failed",n.nextPerformance=i<s?this._missionPerformanceLevels[i]._name:null,n.nextPerformanceScore=n.nextPerformance?this._missionPerformanceLevels[i].getRequiredScore(e):0,n},MissionContext.prototype.getPerformanceLevelScores=function(e){var t,i={};for(t=0;t<this._missionPerformanceLevels.length;t++)i[this._missionPerformanceLevels[t]._name]=this._missionPerformanceLevels[t].getRequiredScore(e);return i},MissionContext.prototype.loadConfigurationFromJSON=function(e){var t;for(this._difficultyLevels=[],t=0;t<e.difficultyLevels.length;t++)this._difficultyLevels.push(new DifficultyLevel(e.difficultyLevels[t]));for(this._missionPerformanceLevels=[],t=0;t<e.missionPerformanceLevels.length;t++)this._missionPerformanceLevels.push(new MissionPerformanceLevel(e.missionPerformanceLevels[t]));this._tipIDs=e.tips},MissionContext.prototype.loadSettingsFromLocalStorage=function(){var e,i;this._difficulty=F.getDifficultyNames()[0],void 0!==localStorage[G]&&(i={silentFallback:s.hasVersionChanged(),defaultValue:F.getDifficultyNames()[0]},e=t.getValueOfTypeFromLocalStorage({baseType:"enum",values:F.getDifficultyNames()},G,i),i.error&&!s.hasVersionChanged()||this.setDifficulty(e,!!i.error&&i.error!==t.Errors.INVALID_ENUM_OBJECT_ERROR))},MissionContext.prototype.requestLoad=function(e){var t={},i=function(){this.setToReady(),this._missionManager.setToReady()}.bind(this);t.missions=MissionDescriptor,this._missionManager.requestConfigLoad(S.getConfigurationSetting(S.CONFIGURATION.MISSION_FILES).filename,S.getConfigurationSetting(S.CONFIGURATION.MISSION_FILES).folder,t,e?function(){this._missionManager.requestAllResources(),this._missionManager.executeWhenReady(i),this._missionManager.requestResourceLoad()}.bind(this):i)},MissionContext.prototype.getDifficulty=function(){return this._difficulty},MissionContext.prototype.setDifficulty=function(e,t){void 0===t&&(t=!0),this._difficulty!==e&&(this._difficulty=e,t&&(localStorage[G]=e))},MissionContext.prototype.getDifficultyNames=function(){var e,t=[];for(e=0;e<this._difficultyLevels.length;e++)t.push(this._difficultyLevels[e]._name);return t},MissionContext.prototype.getDifficultyLevel=function(e){var t;for(t=0;t<this._difficultyLevels.length;t++)if(this._difficultyLevels[t]._name===e)return this._difficultyLevels[t];return null},MissionContext.prototype.getTipIDs=function(){return this._tipIDs},MissionContext.prototype.getMissionNames=function(e){var t=[];return this._missionManager.executeForAllResourcesOfType("missions",function(i){void 0!==e&&i._custom!==e||t.push(i._name)},!1,!0),t},MissionContext.prototype.getMissionDescriptors=function(e){var t=[];return this._missionManager.executeForAllResourcesOfType("missions",function(i){void 0!==e&&i._custom!==e||t.push(i)},!1,!0),t},MissionContext.prototype.getMissionDescriptor=function(e){return this._missionManager.getResource("missions",e)},MissionContext.prototype.requestMissionDescriptor=function(e,t,i){var n=this._missionManager.getResource("missions",e,i);n?(this._missionManager.requestResourceLoad(),this._missionManager.executeWhenReady(function(){t(n)})):t(null)},MissionContext.prototype.requestMission=function(e,t,i,n){var s=this._missionManager.getResource("missions",e);s?(this._missionManager.requestResourceLoad(),this._missionManager.executeWhenReady(function(){n(s.createMission(t,i))})):n(null)},MissionContext.prototype.createMissionDescriptor=function(e){this._missionManager.createResource("missions",e)},MissionContext.prototype.createMission=function(e,t,i){return new MissionDescriptor(e).createMission(t,i)},L=l.getPool(y.PARTICLE_POOL_NAME,d.Particle),N=l.getPool(y.PROJECTILE_POOL_NAME,I.Projectile),D=l.getPool(y.MISSILE_POOL_NAME,I.Missile),P=l.getPool(y.TRAIL_POOL_NAME,d.Trail),w=l.getPool(y.TRAIL_SEGMENT_POOL_NAME,d.TrailSegment),V=l.getPool(y.EXPLOSION_POOL_NAME,x.Explosion),F=new MissionContext,S.executeWhenReady(function(){b=!1,j=S.getSetting(S.GENERAL_SETTINGS.UNIFORM_GROUP_TRANSFORMS_ARRAY_NAME)}),{FAILED_MISSION_PERFORMACE:"failed",
MissionDescriptor:MissionDescriptor,loadConfigurationFromJSON:F.loadConfigurationFromJSON.bind(F),loadSettingsFromLocalStorage:F.loadSettingsFromLocalStorage.bind(F),requestLoad:F.requestLoad.bind(F),executeWhenReady:F.executeWhenReady.bind(F),getIndividualSpacecraftDescriptors:getIndividualSpacecraftDescriptors,getDebugInfo:getDebugInfo,getDifficulty:F.getDifficulty.bind(F),setDifficulty:F.setDifficulty.bind(F),getDifficultyNames:F.getDifficultyNames.bind(F),getTipIDs:F.getTipIDs.bind(F),getMissionNames:F.getMissionNames.bind(F),getMissionDescriptor:F.getMissionDescriptor.bind(F),getMissionDescriptors:F.getMissionDescriptors.bind(F),requestMissionDescriptor:F.requestMissionDescriptor.bind(F),requestMission:F.requestMission.bind(F),createMissionDescriptor:F.createMissionDescriptor.bind(F),createMission:F.createMission.bind(F)}}),define("editor/common",["utils/utils","modules/media-resources","armada/logic/classes","armada/logic/environments","armada/logic/missions"],function(e,t,i,n,s){"use strict";function getItemReference(e,o){var a,l=o?{allowNullResult:!0}:null;switch(e.type){case r.RESOURCE:return t.getResource(e.category,e.name,l);case r.CLASS:return i.getClass(e.category,e.name,l);case r.ENVIRONMENT:return n.getEnvironment(e.name);case r.MISSION:return s.requestMissionDescriptor(e.name,function(e){a=e},l),a;default:document.crash()}return null}function getItemReferencesOfSameCategory(e){var s,o,a=[];switch(e.type){case r.RESOURCE:for(s=t.getResourceNames(e.category),o=0;o<s.length;o++)a.push(t.getResource(e.category,s[o]));break;case r.CLASS:for(s=i.getClassNames(e.category),o=0;o<s.length;o++)a.push(i.getClass(e.category,s[o]));break;case r.ENVIRONMENT:for(s=n.getEnvironmentNames(),o=0;o<s.length;o++)a.push(n.getEnvironment(s[o]));break;case r.MISSION:break;default:document.crash()}return a}function createLabel(e){var t=document.createElement("span");return t.classList.add(a),t.innerHTML=e,t}function createButton(e,t,i){var n=document.createElement("button");return"string"==typeof e?n.textContent=e:(e.class&&(n.className=e.class),e.caption?n.textContent=e.caption:n.innerHTML="&nbsp;"),n.type="button",n.onclick=t,i&&(n.title=i),n}function createBooleanInput(e,t){var i=document.createElement("input");return i.type="checkbox",i.checked=e,i.onchange=t?function(){t(i.checked)}:null,i}function createNumericInput(e,t,i){var n=document.createElement("input");return n.classList.add(l),n.type=t.integer?"number":"text",t.integer&&(n.min=t.min,n.max=t.max),n.value=e,n.onchange=function(){var e=t.integer?parseInt(n.value,10):parseFloat(n.value);isNaN(e)&&(e=0),void 0!==t.min&&e<t.min&&(e=t.min),void 0!==t.max&&e>t.max&&(e=t.max),n.value=e.toString(),i&&i(e)},n}function setSelectorOptions(e,t){var i,n="";for(i=0;i<t.length;i++)"string"==typeof t[i]?n+='<option value="'+t[i]+'">'+t[i]+"</option>":"object"==typeof t[i]&&(n+='<option value="'+t[i].value+'" style="color: '+t[i].color+';">'+t[i].value+"</option>");e.innerHTML=n}function getSelectorOptions(e){var t,i=[];for(t=0;t<e.options.length;t++)i.push(e.options[t].value);return i}function createSelector(e,t,i,n){var s=document.createElement("select");return i&&(e=["none"].concat(e)),setSelectorOptions(s,e),t&&e.indexOf(t)>=0?s.value=t:(s.selectedIndex=0,t&&n&&n(s.value)),s.onchange=n,s}function createColorPicker(t,i){var n,s,o,r,a=document.createElement("div"),l=function(n,s){t[n]=s,r.value=e.getHexColor(t),i&&i()};for(a.classList.add(h),r=document.createElement("input"),r.type="color",r.classList.add(u),r.value=e.getHexColor(t),r.onchange=function(){var n,s=e.getColor3FromHex(r.value);for(n=0;n<s.length;n++)t[n]=s[n],o[n].value=s[n];i&&i()},a.appendChild(r),o=[],s=0;s<t.length;s++)n=createNumericInput(t[s],{min:0,max:1},l.bind(this,s)),n.classList.add(c),a.appendChild(n),o.push(n);return a}function setColorForPicker(t,i){var n,s=t.querySelector("."+u),o=t.querySelectorAll("."+c);for(s.value=e.getHexColor(i),n=0;n<o.length;n++)o[n].value=i[n]}function createColorPreview(t){var i=document.createElement("div");return i.className=d,i.style.backgroundColor=e.getHexColor(t),i}function createVectorEditor(e,t){var i,n,s,o=document.createElement("div"),r=function(i,n){e[i]=n,t&&t()};for(s=[],n=0;n<e.length;n++)i=createNumericInput(e[n],{},r.bind(this,n)),i.classList.add(p),o.appendChild(i),s.push(i);return o}function createRangeEditor(e,t,i){var n,s,o,r,a,l=document.createElement("div"),c=!!t.minRequired,h=!!t.maxRequired,u=t.elementType||{};return n=createBooleanInput(void 0!==e[0],function(){e[0]=n.checked?o.value:void 0,o.disabled=!n.checked,i&&i()}),n.classList.add(_),o=createNumericInput(e[0]||(u.min>0?u.min:0),u,function(t){e[0]=n.checked?t:void 0,i&&i()}),o.classList.add(g),void 0===e[0]&&(o.disabled=!0),s=createBooleanInput(void 0!==e[1],function(){e[1]=s.checked?r.value:void 0,r.disabled=!s.checked,i&&i()}),s.classList.add(_),r=createNumericInput(e[1]||(u.min>0?u.min:0),u,function(t){e[1]=s.checked?t:void 0,i&&i()}),r.classList.add(g),void 0===e[1]&&(r.disabled=!0),a=createLabel((u.unit?u.unit+" ":"")+"-"),c||l.appendChild(n),l.appendChild(o),l.appendChild(a),h||l.appendChild(s),l.appendChild(r),u.unit&&l.appendChild(createLabel(u.unit)),l}function Popup(t,i,n){this._setLeft=-1,this._setTop=-1,this._element=document.createElement("div"),this._element.classList.add(m),this._element.onmousedown=function(t){if(t.target===this._element){var i,n,s,o;t.which===e.MouseButton.LEFT&&(i=t.screenX,n=t.screenY,s=parseFloat(this._element.style.left),o=parseFloat(this._element.style.top),document.body.onmousemove=function(e){this.alignPosition(!0,s+e.screenX-i,o+e.screenY-n),e.preventDefault()}.bind(this),document.body.onmouseup=function(t){t.which===e.MouseButton.LEFT&&(document.body.onmousemove=null,this._setLeft=parseFloat(this._element.style.left),this._setTop=parseFloat(this._element.style.top))}.bind(this))}}.bind(this),this._element.hidden=!0,this._childPopups=[],this._invoker=t,this._parent=i,this._parent&&this._parent._childPopups.push(this),this._eventHandlers=n||{}}function removePopups(){var e;for(e=0;e<S.length;e++)S[e].remove(!0);S=[],o=f}function alignPopups(){var e;for(e=0;e<S.length;e++)S[e].alignPosition(!0)}var o,r={NONE:"none",RESOURCE:"resources",CLASS:"classes",ENVIRONMENT:"environments",MISSION:"missions"},a="label",l="numericInput",c="colorComponent",h="colorPicker",u="colorInput",d="colorPreview",p="vectorComponent",_="rangeCheckbox",g="rangeNumericInput",m="popup",f=1e3,S=[];return Popup.prototype.addToPage=function(){document.body.appendChild(this._element),this._parent||S.push(this)},Popup.prototype.isVisible=function(){return!this._element.hidden},Popup.prototype.alignPosition=function(e,t,i){var n,s,o,r;if(this.isVisible()){if(n=this._invoker.getBoundingClientRect(),this._element.style.left=(void 0!==t?t:this._setLeft>=0?this._setLeft:n.left)+"px",this._element.style.top=(void 0!==i?i:this._setTop>=0?this._setTop:n.bottom)+"px",this._element.style.width="",this._element.style.height="",s=this._element.getBoundingClientRect(),s.right>window.innerWidth-4)for(this._element.style.left=window.innerWidth-(s.right-s.left)-4+"px",s=this._element.getBoundingClientRect(),o=s.left;o>0&&s.right>window.innerWidth-4;)o-=4,this._element.style.left=o+"px",s=this._element.getBoundingClientRect();if(s.bottom>window.innerHeight-4&&(void 0===t&&void 0===i&&n.top-s.height>4?this._element.style.top=n.top-s.height+"px":(this._element.style.height=window.innerHeight-s.top-10-4+"px",s=this._element.getBoundingClientRect(),this._element.style.left=s.left-21+"px",this._element.style.width=s.right-s.left+16+"px")),s=this._element.getBoundingClientRect(),e)for(r=0;r<this._childPopups.length;r++)this._childPopups[r].alignPosition(!0)}},Popup.prototype.show=function(){var e;if(!this.isVisible()){if(this._parent)for(e=0;e<this._parent._childPopups.length;e++)this._parent._childPopups[e]!==this&&this._parent._childPopups[e].hide();else for(e=0;e<S.length;e++)S[e]!==this&&S[e].hide();this._element.hidden=!1,this._setLeft=-1,this._setTop=-1,this.alignPosition(),this._element.style.zIndex=o,o++,this._eventHandlers.show&&this._eventHandlers.show()}},Popup.prototype.hideChildren=function(){var e;for(e=0;e<this._childPopups.length;e++)this._childPopups[e].hide()},Popup.prototype.hide=function(){this.isVisible()&&(this.hideChildren(),this._element.hidden=!0,this._eventHandlers.hide&&this._eventHandlers.hide())},Popup.prototype.toggle=function(){this.isVisible()?this.hide():this.show()},Popup.prototype.remove=function(e){var t;for(t=0;t<this._childPopups.length;t++)this._childPopups[t].remove();this.isVisible()&&this._eventHandlers.removeHide&&this._eventHandlers.removeHide(),this._element.parentNode&&this._element.parentNode.removeChild(this._element),e||this._parent||S.splice(S.indexOf(this),1)},{STRING_INPUT_CLASS:"stringInput",ItemType:r,getItemReference:getItemReference,getItemReferencesOfSameCategory:getItemReferencesOfSameCategory,createLabel:createLabel,createButton:createButton,createBooleanInput:createBooleanInput,createNumericInput:createNumericInput,setSelectorOptions:setSelectorOptions,getSelectorOptions:getSelectorOptions,createSelector:createSelector,createColorPicker:createColorPicker,setColorForPicker:setColorForPicker,createColorPreview:createColorPreview,createVectorEditor:createVectorEditor,createRangeEditor:createRangeEditor,Popup:Popup,removePopups:removePopups,alignPopups:alignPopups}}),define("modules/screens",["utils/utils","utils/types","modules/application","modules/async-resource","modules/components","modules/managed-gl","modules/media-resources","modules/strings"],function(e,t,i,n,s,o,r,a){"use strict";function _getColor(t){var i;return m.enabled?(i=e.getLuminance(t),e.getMixedColor(e.gammaCorrect(e.filterColor([i,i,i,t[3]],m.filter),m.gamma),t,m.originalColorRatio)):t}function HTMLScreen(e,t,i,s,o,r){n.AsyncResource.call(this),this._name=e,this._htmlFilename=t,this._style=i||{},this._cssLoaded=!1,this._model=null,this._background=null,this._container=null,this._superImposed=!1,this._simpleComponents=[],this._externalComponentBindings=[],this._externalComponentsLoaded=0,this._externalComponentsToLoad=0,this._visible=!1,this._onShow=s?s[l]:null,this._onHide=s?s[c]:null,this._onActivate=s?s[h]:null,this._keyDownHandler=o?this._getKeyDownHandler(o):null,this._elementEventHandlers=r||null,t&&this.requestModelLoad()}function ClipSpaceLayout(n){this._left=n.left,this._centerX=n.centerX,this._right=n.right,this._top=n.top,this._centerY=n.centerY,this._bottom=n.bottom,this._width=n.width,this._height=n.height,this._scaleMode=t.getEnumValue(e.ScaleMode,n.scaleMode),this._xScaleMode=t.getEnumValue(e.ScaleMode,n.xScaleMode||e.ScaleMode.ASPECT),this._yScaleMode=t.getEnumValue(e.ScaleMode,n.yScaleMode||e.ScaleMode.ASPECT),this._isValid()||i.showError("Invalid layout specified!")}function CanvasText(n,s,o,r,a,l,c,h){this._x=n[0],this._y=n[1],this._text=null,this._font=o,this._size=r,this._scaleMode=t.getEnumValue(e.ScaleMode,a),this._scaleMode===e.ScaleMode.ASPECT&&i.showError("Cannot set the scaling mode to aspect for fonts!"),this._color=null,this._align=c||"left",this._boxLayout=h?new ClipSpaceLayout(h):null,this._boxLeft=-1,this._boxTop=-1,this._boxWidth=-1,this._boxHeight=-1,this._boxValid=!1,this._boxCleared=!1,this._visible=!0,this._lastWidth=-1,this._lastHeight=-1,this._textWidth=-1,this._cssFont=null,this._cssColor=null,this._words=null,this._sections=null,this._textLength=0,this._revealState=1,this._lineHeight=-1,this.setText(s),this.setColor(l)}function TextLayer(e){this._canvas=document.createElement("canvas"),this._clipSpaceLayout=new ClipSpaceLayout(e),this._context=this._canvas.getContext("2d",{alpha:!0}),this._context.textBaseline="top",this._texts=[],this._visible=!0,this._cleared=!0,this._viewportWidth=-1,this._viewportHeight=-1}function ScreenCanvas(e,i,n,s){this._canvas=e,this._resizeable=e.classList.contains(d),this._antialiasing=i,this._alpha=n,this._filtering=t.getEnumValue(o.TextureFiltering,s,{name:"ScreenCanvas.filtering"}),this._context=null,this._textLayers=[]}function HTMLScreenWithCanvases(e,i,n,s,r,a,l,c,h,u){HTMLScreen.call(this,e,i,n,c,h,u),this._antialiasing=s,this._alpha=r,this._filtering=i?t.getEnumValue(o.TextureFiltering,a,{name:"HTMLScreenWithCanvases.filtering"}):null,this._canvases={},this._sceneCanvasBindings=[],this._renderLoop=p,this._renderTimes=[],this._minFPS=0,this._maxFPS=0,this._fpsSum=0,this._fpsFrameCount=0,this._resizeEventListener=null,this._useRequestAnimFrame=l}function MenuScreen(e,t,i,n,o,r,a,l,c,h){HTMLScreen.call(this,e,t,i,l,this._getKeyCommands(c),h),this._menuOptions=r,this._menuContainerID=a,this._menuComponent=this.registerExternalComponent(new s.MenuComponent(_,n,o,this._menuOptions,l),this._menuContainerID)}function setAnaglyphTextRendering(e,t,i,n){m.enabled=e,m.originalColorRatio=t,m.filter[1]=i,m.filter[2]=i,m.gamma=n}var l=s.SHOW_EVENT_NAME,c=s.HIDE_EVENT_NAME,h="activate",u=s.ELEMENT_ID_SEPARATOR,d="resizeable",p=-1,_="menu",g={name:"error.antialiasingChange",defaultValue:"The antialiasing setting has been changed. Please restart the application to apply the new setting!"},m={enabled:!1,originalColorRatio:.5,filter:[1,1,1,1],gamma:1};return HTMLScreen.prototype=new n.AsyncResource,HTMLScreen.prototype.constructor=HTMLScreen,HTMLScreen.prototype._isLoaded=function(){return this._model&&this._cssLoaded&&this._externalComponentsLoaded===this._externalComponentsToLoad},HTMLScreen.prototype._getKeyDownHandler=function(t){var i,n,s={};for(i=Object.keys(t),n=0;n<i.length;n++)s[e.getKeyCodeOf(i[n])]=t[i[n]];return function(e){s[e.keyCode]&&s[e.keyCode].call(this,e)}.bind(this)},HTMLScreen.prototype._addEventListeners=function(){this._keyDownHandler&&document.addEventListener("keydown",this._keyDownHandler)},HTMLScreen.prototype._removeEventListeners=function(){this._keyDownHandler&&document.removeEventListener("keydown",this._keyDownHandler)},HTMLScreen.prototype.requestModelLoad=function(){i.requestTextFile("screen",this._htmlFilename,function(e){var t;this._model=document.createDocumentFragment(),t=document.createElement("div"),t.innerHTML=e,this._model.appendChild(t.firstElementChild),this._isLoaded()&&this.setToReady()}.bind(this)),this._style.cssFilename?(this._cssLoaded=!1,i.requestCSSFile("css",this._style.cssFilename,function(){this._cssLoaded=!0,this._isLoaded()&&this.setToReady()}.bind(this))):this._cssLoaded=!0},HTMLScreen.prototype.setActive=function(e){e?(this._addEventListeners(),this._onActivate&&this._onActivate()):this._removeEventListeners()},HTMLScreen.prototype._addElementEventListeners=function(e){var t,i,n,s,o,r;if(this._elementEventHandlers)for(e=e||this._container,o=Object.keys(this._elementEventHandlers),i=0;i<o.length;i++)for(t=e.querySelectorAll(o[i]),r=Object.keys(this._elementEventHandlers[o[i]]),n=0;n<t.length;n++)for(s=0;s<r.length;s++)t[n].addEventListener(r[s],this._elementEventHandlers[o[i]][r[s]])},HTMLScreen.prototype.addScreenToPage=function(e,t,i,n){n=n||document.body,this.executeWhenReady(function(){var s,o;for(t&&(this._background=document.createElement("div"),this._background.setAttribute("id",this._getElementID("screenBackground")),this._background.className=this._style.backgroundClassName||"screenBackground",this._background.hidden=!0),this._container=document.createElement("div"),this._container.setAttribute("id",this._getElementID("screenContainer")),this._container.className=this._style.containerClassName||"screenContainer",this._container.hidden=!0,i?this._container.appendChild(this._model.firstElementChild.cloneNode(!0)):this._container.appendChild(this._model.firstElementChild),s=this._container.querySelectorAll("[id]"),o=0;o<s.length;o++)s[o].setAttribute("id",this._getElementID(s[o].getAttribute("id")));for(s=this._container.querySelectorAll("[for]"),o=0;o<s.length;o++)s[o].setAttribute("for",this._getElementID(s[o].getAttribute("for")));this._background&&n.appendChild(this._background),n.appendChild(this._container),this._visible=!1,this._initializeComponents(),this._addElementEventListeners(),e&&e(),i||(this._model=null)})},HTMLScreen.prototype.isVisible=function(){return this._visible},HTMLScreen.prototype.show=function(){if(!this._visible){if(this._container)return this._container.hidden=!1,this._visible=!0,this._onShow&&this._onShow(),!0;i.showError("Attempting to show screen '"+this._name+"' before adding it to the page!")}return!1},HTMLScreen.prototype.superimposeOnPage=function(t,i){this._container&&(i=i||document.body,this._background&&(t&&(this._background.style.backgroundColor=e.getCSSColor(t)),this._background.hidden=!1,i.appendChild(this._background)),i.appendChild(this._container),this._superImposed=!0),this.show()},HTMLScreen.prototype.hide=function(){if(this._visible){if(this._container)return this._container.hidden=!0,this._background&&(this._background.hidden=!0),this._visible=!1,this._superImposed=!1,this.setActive(!1),this._onHide&&this._onHide(),!0;i.showError("Attempting to hide screen '"+this._name+"' before adding it to the page!")}return!1},HTMLScreen.prototype.isSuperimposed=function(){return this._superImposed},HTMLScreen.prototype._initializeComponents=function(){var e,t;for(e=0;e<this._simpleComponents.length;e++)this._simpleComponents[e].initComponent();for(e=0;e<this._externalComponentBindings.length;e++)t=this._externalComponentBindings[e].parentNodeID?this.getElement(this._externalComponentBindings[e].parentNodeID):null,this.addExternalComponent(this._externalComponentBindings[e].component,t);this._updateComponents()},HTMLScreen.prototype._getElementID=function(e){return this._name+u+e},HTMLScreen.prototype._getOriginalElementID=function(e){return e.getAttribute("id").substr(this._name.length+u.length)},HTMLScreen.prototype._updateComponents=function(){var e,t;if(this._container){for(e=this._container.querySelectorAll(".translatable, ["+s.TRANSLATION_KEY_ATTRIBUTE+"]"),t=0;t<e.length;t++)e[t].innerHTML=a.get({name:e[t].getAttribute(s.TRANSLATION_KEY_ATTRIBUTE)||this._name+"."+this._getOriginalElementID(e[t]),defaultValue:e[t].innerHTML});for(t=0;t<this._externalComponentBindings.length;t++)this._externalComponentBindings[t].component.updateComponents()}},HTMLScreen.prototype.updateScreen=function(){this._updateComponents()},HTMLScreen.prototype.registerSimpleComponent=function(e){var t=new s.SimpleComponent(e,this._getElementID(e));return this._simpleComponents.push(t),t},HTMLScreen.prototype.registerExternalComponent=function(e,t){return this._externalComponentsToLoad++,this._externalComponentBindings.push({component:e,parentNodeID:t}),e.setRootElementID(this._getElementID(e._name)),e.executeWhenReady(function(){this._externalComponentsLoaded++,this._isLoaded()&&this.setToReady()}.bind(this)),e},HTMLScreen.prototype.addExternalComponent=function(e,t){return e.appendToPage(t),e},HTMLScreen.prototype.updateStatus=function(e){this._status?this._status.setContent(e):alert(e)},HTMLScreen.prototype.getElement=function(e){return this._container.querySelector("#"+this._getElementID(e))},ClipSpaceLayout.prototype._isValid=function(){var t;if(void 0!==this._width){if(t=0,void 0!==this._left&&t++,void 0!==this._centerX&&t++,void 0!==this._right&&t++,1!==t)return!1}else{if(void 0===this._left||void 0!==this._centerX||void 0===this._right)return!1;if(this._scaleMode!==e.ScaleMode.ASPECT||this._xScaleMode!==e.ScaleMode.ASPECT)return!1}if(void 0!==this._height){if(t=0,void 0!==this._top&&t++,void 0!==this._centerY&&t++,void 0!==this._bottom&&t++,1!==t)return!1}else{if(void 0===this._top||void 0!==this._centerY||void 0===this._bottom)return!1;if(this._scaleMode!==e.ScaleMode.ASPECT||this._yScaleMode!==e.ScaleMode.ASPECT)return!1}return!0},ClipSpaceLayout.prototype.getClipSpaceCenterX=function(){return void 0!==this._centerX?this._centerX:void 0!==this._width?void 0!==this._left?this._left+this._width/2:this._right-this._width/2:(this._left+this._right)/2},ClipSpaceLayout.prototype.getClipSpaceCenterY=function(){return void 0!==this._centerY?this._centerY:void 0!==this._height?void 0!==this._bottom?this._bottom+this._height/2:this._top-this._height/2:(this._bottom+this._top)/2},ClipSpaceLayout.prototype.getClipSpacePosition=function(){return[this.getClipSpaceCenterX(),this.getClipSpaceCenterY()]},ClipSpaceLayout.prototype.getClipSpaceWidth=function(){return void 0!==this._width?this._width:this._right-this._left},ClipSpaceLayout.prototype.getClipSpaceHeight=function(){return void 0!==this._height?this._height:this._top-this._bottom},ClipSpaceLayout.prototype.getClipSpaceSize=function(){return[this.getClipSpaceWidth(),this.getClipSpaceHeight()]},ClipSpaceLayout.prototype.getClipSpaceLeft=function(){return void 0!==this._left?this._left:this.getClipSpaceCenterX()-this.getClipSpaceWidth()/2},ClipSpaceLayout.prototype.getClipSpaceRight=function(){return void 0!==this._right?this._right:this.getClipSpaceCenterX()+this.getClipSpaceWidth()/2},ClipSpaceLayout.prototype.getClipSpaceBottom=function(){return void 0!==this._bottom?this._bottom:this.getClipSpaceCenterY()-this.getClipSpaceHeight()/2},ClipSpaceLayout.prototype.getClipSpaceTop=function(){return void 0!==this._top?this._top:this.getClipSpaceCenterY()+this.getClipSpaceHeight()/2},ClipSpaceLayout.prototype.getWidth=function(t,i){return this.getClipSpaceWidth()/2*(e.xScalesWithWidth(this._scaleMode,t,i)?t:i)},ClipSpaceLayout.prototype.getHeight=function(t,i){return this.getClipSpaceHeight()/2*(e.yScalesWithHeight(this._scaleMode,t,i)?i:t)},ClipSpaceLayout.prototype.getSize=function(e,t){return[this.getWidth(e,t),this.getHeight(e,t)]},ClipSpaceLayout.prototype.getCenterX=function(t,i){var n;return n=e.xScalesWithWidth(this._xScaleMode,t,i)?t:i,void 0!==this._left?(this.getClipSpaceLeft()+1)/2*n+this.getWidth(t,i)/2:void 0!==this._centerX?t/2+this.getClipSpaceCenterX()/2*n:t-(1-this.getClipSpaceRight())/2*n-this.getWidth(t,i)/2},ClipSpaceLayout.prototype.getCenterY=function(t,i){var n;return n=e.yScalesWithHeight(this._yScaleMode,t,i)?i:t,void 0!==this._top?(1-this.getClipSpaceTop())/2*n+this.getHeight(t,i)/2:void 0!==this._centerY?i/2-this.getClipSpaceCenterY()/2*n:i-(this.getClipSpaceBottom()+1)/2*n-this.getHeight(t,i)/2},ClipSpaceLayout.prototype.setPosition=function(e,t){this._centerX=e,this._centerY=t},ClipSpaceLayout.prototype.getPosition=function(e,t){return[this.getCenterX(e,t),this.getCenterY(e,t)]},ClipSpaceLayout.prototype.getLeft=function(t,i){var n;return n=e.xScalesWithWidth(this._xScaleMode,t,i)?t:i,void 0!==this._left?(this.getClipSpaceLeft()+1)/2*n:void 0!==this._centerX?t/2+this.getClipSpaceCenterX()/2*n-this.getWidth(t,i)/2:t-(1-this.getClipSpaceRight())/2*n-this.getWidth(t,i)},ClipSpaceLayout.prototype.getTop=function(t,i){var n;return n=e.yScalesWithHeight(this._yScaleMode,t,i)?i:t,void 0!==this._top?(1-this.getClipSpaceTop())/2*n:void 0!==this._centerY?i/2-this.getClipSpaceCenterY()/2*n-this.getHeight(t,i)/2:i-(this.getClipSpaceBottom()+1)/2*n-this.getHeight(t,i)},ClipSpaceLayout.prototype.getBottom=function(t,i){var n;return n=e.yScalesWithHeight(this._yScaleMode,t,i)?i:t,void 0!==this._top?(1-this.getClipSpaceTop())/2*n+this.getHeight(t,i):void 0!==this._centerY?i/2-this.getClipSpaceCenterY()/2*n+this.getHeight(t,i)/2:i-(this.getClipSpaceBottom()+1)/2*n},ClipSpaceLayout.prototype.getPositiveLeft=function(e,t){return this.getLeft(e,t)/e},ClipSpaceLayout.prototype.getPositiveBottom=function(e,t){return 1-this.getBottom(e,t)/t},ClipSpaceLayout.prototype.getPositiveWidth=function(e,t){return this.getWidth(e,t)/e},ClipSpaceLayout.prototype.getPositiveHeight=function(e,t){return this.getHeight(e,t)/t},CanvasText.prototype._updateCSSFont=function(t,i){e.scalesWithWidth(this._scaleMode,t,i)?this._cssFont=this._size*t+"px":this._cssFont=this._size*i+"px",this._cssFont=this._cssFont+" "+this._font},CanvasText.prototype.invalidateLayout=function(){this._boxValid=!1},CanvasText.prototype._updateLayout=function(){this._boxLayout&&!this._boxValid&&(this._boxTop=this._boxLayout.getTop(this._lastWidth,this._lastHeight),this._boxLeft=this._boxLayout.getLeft(this._lastWidth,this._lastHeight),this._boxWidth=this._boxLayout.getWidth(this._lastWidth,this._lastHeight),this._boxHeight=this._boxLayout.getHeight(this._lastWidth,this._lastHeight),this._boxValid=!0)},CanvasText.prototype._updateSize=function(e,t){e===this._lastWidth&&t===this._lastHeight||(this._lastWidth=e,this._lastHeight=t,this._updateCSSFont(e,t),this._textWidth=-1,this._boxValid=!1)},CanvasText.prototype._clearBox=function(e){this._boxLayout&&this._boxWidth>=0&&!this._boxCleared&&(e.clearRect(this._boxLeft,this._boxTop,this._boxWidth,this._boxHeight),this._boxCleared=!0)},CanvasText.prototype._breakIntoSections=function(e){var t,n,s,o,r,a,l,c,h,u,d,p,_,g,m,f,S,T,y,E,C,M,I,A=function(){var e;for(e=_;e<o.length;e++)switch(r){case"right":o[e].xOffset-=h;break;case"center":o[e].xOffset-=.5*h}},x=function(t){A(),l++,o.push({text:t,xOffset:0,yOffset:l*p,color:g&&g.color}),g&&(g.length=g.text.length,g.startIndex=I,I+=g.length),g=o[o.length-1],_=o.length-1,T=0,h=t.length>0?e.measureText(t).width:0,S=!1},v=function(t){T+=e.measureText(g.text).width,o.push({text:"",xOffset:T,yOffset:l*p,color:t}),g.length=g.text.length,g.startIndex=I,I+=g.length,g=o[o.length-1]},O=function(){if(C.length<2)g.text.length>0?v():delete g.color;else switch(C[0]){case"color":M=C[1].split(",").map(parseFloat),g.text.length>0?v(M):g.color=M;break;default:i.showError("Unrecognized text modifier: '"+C[0]+"'!")}};for(s=this._text.split("\n"),this._words=[],t=0;t<s.length;t++)this._words.push(s[t].split(" "));for(d=this._boxLayout?this._boxWidth:this._lastWidth,this._textWidth=e.measureText(this._text).width,this._lineHeight=1.2*e.measureText("M").width,this._sections=[],o=this._sections,p=this._lineHeight,r=this._align,l=-1,T=0,h=0,_=0,I=0,t=0;t<this._words.length;t++)for(x(""),n=0;n<this._words[t].length;n++){if(m=this._words[t][n],(y=m.indexOf("["))>=0){if(E=m.indexOf("]"),C=m.substring(y+1,E).split(":"),0===y){if(O(),m.length>E+1){this._words[t][n]=m.substr(E+1),n--;continue}continue}f=E<m.length-1?m.substr(E+1):null,m=m.substring(0,y)}else f=null;a=g.text,c=a+(h>0&&!S?" ":"")+m,u=T+e.measureText(c).width,0===n||u<d?(g.text=c,h=u):x(m),S=!1,y>0&&O(),f&&(this._words[t][n]=f,n--,S=!0)}g&&(g.length=g.text.length,g.startIndex=I,I+=g.length),this._textLength=I,A()},CanvasText.prototype.render=function(t){var i,n,s,o,r;if(this._visible){for(this._clearBox(t),t.fillStyle=this._cssColor,this._updateSize(t.canvas.width,t.canvas.height),this._updateLayout(),t.font=this._cssFont,t.textAlign="left",this._boxLayout&&this._boxWidth>=0&&(t.save(),t.rect(this._boxLeft,this._boxTop,this._boxWidth,this._boxHeight),t.clip()),this._textWidth<0&&this._breakIntoSections(t),n=this._cssColor,o=Math.round(this._revealState*this._textLength),i=0;i<this._sections.length&&this._sections[i].startIndex<=o;i++)s=this._sections[i].color?e.getCSSColor(_getColor(this._sections[i].color)):this._cssColor,n!==s&&(n=s,t.fillStyle=n),r=this._sections[i].startIndex+this._sections[i].length-1>o?this._sections[i].text.substring(0,o-this._sections[i].startIndex+1):this._sections[i].text,t.fillText(r,(this._x+1)/2*this._lastWidth+this._sections[i].xOffset,(1-this._y)/2*this._lastHeight+this._sections[i].yOffset);return this._boxLayout?(t.restore(),this._boxCleared=0===this._text.length,!1):this._text.length>0}return this._clearBox(t),!1},CanvasText.prototype.invalidate=function(){this._lastWidth=-1,this._lastHeight=-1,this._textWidth=-1},CanvasText.prototype.setPosition=function(e){this._x=e[0],this._y=e[1]},CanvasText.prototype.setText=function(t,i){(t=i?e.formatString(t,i):t)!==this._text&&(this._text=t,this._textWidth=-1)},CanvasText.prototype.setColor=function(t){this._color=t,this._cssColor=e.getCSSColor(_getColor(t))},CanvasText.prototype.isVisible=function(){return this._visible},CanvasText.prototype.show=function(){this._visible||(this._visible=!0,this.invalidate())},CanvasText.prototype.hide=function(){this._visible&&(this._visible=!1,this.invalidate())},TextLayer.prototype.clearContext=function(e){this._cleared||(this._context.clearRect(0,0,this._canvas.width,this._canvas.height),e&&(this._context.strokeStyle=e,this._context.strokeRect(0,0,this._canvas.width,this._canvas.height)),this._cleared=!0)},TextLayer.prototype.addText=function(e){this._texts.push(e)},TextLayer.prototype.render=function(){var e;if(this._visible)for(this.clearContext(),e=0;e<this._texts.length;e++)this._cleared=!this._texts[e].render(this._context)&&this._cleared},TextLayer.prototype.updateLayout=function(){this._canvas.style.top=this._clipSpaceLayout.getTop(this._viewportWidth,this._viewportHeight)+"px",this._canvas.style.left=this._clipSpaceLayout.getLeft(this._viewportWidth,this._viewportHeight)+"px",this._canvas.width=this._clipSpaceLayout.getWidth(this._viewportWidth,this._viewportHeight),this._canvas.height=this._clipSpaceLayout.getHeight(this._viewportWidth,this._viewportHeight),this._cleared=!1},TextLayer.prototype.handleResize=function(e,t){this._viewportWidth=e,this._viewportHeight=t,this.updateLayout()},TextLayer.prototype.setContainer=function(e){this.handleResize(e.width,e.height),e.parentNode.appendChild(this._canvas),this._canvas.style.position="absolute",this._canvas.zIndex=e.zIndex+1},TextLayer.prototype.isVisible=function(){return this._visible},TextLayer.prototype.show=function(){var e;if(!this._visible){for(e=0;e<this._texts.length;e++)this._texts[e].invalidate();this._visible=!0,this._canvas.hidden=!1}},TextLayer.prototype.hide=function(){var e;if(this._visible){for(this.clearContext(),e=0;e<this._texts.length;e++)this._texts[e].invalidate();this._visible=!1,this._canvas.hidden=!0}},TextLayer.prototype.getLayout=function(){return this._clipSpaceLayout},ScreenCanvas.prototype.getCanvasElement=function(){return this._canvas},ScreenCanvas.prototype.isResizeable=function(){return this._resizeable},ScreenCanvas.prototype.getManagedContext=function(){return this._context||(this._context=new o.ManagedGLContext(this._canvas.getAttribute("id"),this._canvas,this._antialiasing,this._alpha,this._filtering)),this._context},ScreenCanvas.prototype.clearManagedContext=function(){this._context&&this._context.clear()},ScreenCanvas.prototype.setAntialiasing=function(e){if(e!==this._antialiasing){if(this._context)return i.showError(a.get(g)),!1;this._antialiasing=e}return!0},ScreenCanvas.prototype.setFiltering=function(e){e!==this._filtering&&(this._filtering=e,this._context&&this._context.setFiltering(this._filtering))},ScreenCanvas.prototype.handleResize=function(){var e,t=this._canvas.clientWidth,i=this._canvas.clientHeight;if(this._canvas.width!==t||this._canvas.height!==i)for(this._canvas.width=t,this._canvas.height=i,e=0;e<this._textLayers.length;e++)this._textLayers[e].handleResize(t,i)},ScreenCanvas.prototype.addTextLayer=function(e){this._textLayers.push(e),e.setContainer(this._canvas)},ScreenCanvas.prototype.renderTextLayers=function(){var e;for(e=0;e<this._textLayers.length;e++)this._textLayers[e].render()},HTMLScreenWithCanvases.prototype=new HTMLScreen,HTMLScreenWithCanvases.prototype.constructor=HTMLScreenWithCanvases,HTMLScreenWithCanvases.prototype.handleResize=function(){this.resizeCanvases(),this._renderLoop===p&&this.render()},HTMLScreenWithCanvases.prototype.clearSceneCanvasBindings=function(){var e;for(e=0;e<this._sceneCanvasBindings.length;e++)this._sceneCanvasBindings[e].canvas.clearManagedContext();this._sceneCanvasBindings=[]},HTMLScreenWithCanvases.prototype.hide=function(){return!!HTMLScreen.prototype.hide.call(this)&&(this.stopRenderLoop(),!0)},HTMLScreenWithCanvases.prototype._getAlphaForCanvas=function(e){return"boolean"==typeof this._alpha?this._alpha:"boolean"==typeof this._alpha[e]?this._alpha[e]:(i.showError("No alpha channel support is defined for canvas '"+e+"' of screen '"+this._name+"'!"),!1)},HTMLScreenWithCanvases.prototype._initializeComponents=function(){var e,t;for(HTMLScreen.prototype._initializeComponents.call(this),
e=this._container.getElementsByTagName("canvas"),t=0;t<e.length;t++)this._canvases[e[t].getAttribute("id")]=new ScreenCanvas(e[t],this._antialiasing,this._getAlphaForCanvas(this._getOriginalElementID(e[t])),this._filtering);this._resizeEventListener=this.handleResize.bind(this),window.addEventListener("resize",this._resizeEventListener)},HTMLScreenWithCanvases.prototype.getScreenCanvas=function(e){return this._canvases[this._getElementID(e)]},HTMLScreenWithCanvases.prototype.bindSceneToCanvas=function(e,t){var i,n=!1;for(i=0;i<this._sceneCanvasBindings.length;i++)this._sceneCanvasBindings[i].scene===e&&this._sceneCanvasBindings[i].canvas===t&&(n=!0);!1===n&&this._sceneCanvasBindings.push({scene:e,canvas:t}),e.addToContext(t.getManagedContext()),this._renderLoop!==p&&t.getManagedContext().setup()},HTMLScreenWithCanvases.prototype.setAntialiasing=function(e){var t;if(e!==this._antialiasing){this._antialiasing=e;for(t in this._canvases)if(this._canvases.hasOwnProperty(t)&&!this._canvases[t].setAntialiasing(this._antialiasing))return}},HTMLScreenWithCanvases.prototype.setFiltering=function(e){var i;if((e=t.getEnumValue(o.TextureFiltering,e,{name:"HTMLScreenWithCanvases.filtering",defaultValue:this._filtering}))!==this._filtering){this._filtering=e;for(i in this._canvases)this._canvases.hasOwnProperty(i)&&this._canvases[i].setFiltering(this._filtering)}},HTMLScreenWithCanvases.prototype._render=function(e){var t,i;for(i=Object.keys(this._canvases),t=0;t<this._sceneCanvasBindings.length;t++)this._sceneCanvasBindings[t].scene.render(this._sceneCanvasBindings[t].canvas.getManagedContext(),e);for(t=0;t<i.length;t++)this._canvases[i[t]].renderTextLayers()},HTMLScreenWithCanvases.prototype.render=function(){var e,t,i,n;if(e=performance.now(),t=this._renderTimes&&this._renderTimes.length>0?e-this._renderTimes[this._renderTimes.length-1]:0,this._render(t),this._renderLoop!==p){for(this._renderTimes.push(e),i=!1;this._renderTimes.length>1&&e-this._renderTimes[0]>1e3;)this._renderTimes.shift(),i=!0;i&&(n=this._renderTimes.length,(0===this._minFPS||this._minFPS>n)&&(this._minFPS=n),(0===this._maxFPS||this._maxFPS<n)&&(this._maxFPS=n),this._fpsSum+=n,this._fpsFrameCount++)}},HTMLScreenWithCanvases.prototype._renderRequestAnimFrame=function(e){var t,i,n;if(this._renderLoop!==p){for(t=this._renderTimes&&this._renderTimes.length>0?e-this._renderTimes[this._renderTimes.length-1]:0,this._render(t),this._renderTimes.push(e),i=!1;this._renderTimes.length>1&&e-this._renderTimes[0]>1e3;)this._renderTimes.shift(),i=!0;i&&(n=this._renderTimes.length,(0===this._minFPS||this._minFPS>n)&&(this._minFPS=n),(0===this._maxFPS||this._maxFPS<n)&&(this._maxFPS=n),this._fpsSum+=n,this._fpsFrameCount++),window.requestAnimationFrame(this._renderRequestAnimFrame.bind(this))}},HTMLScreenWithCanvases.prototype.startRenderLoop=function(e){var t;if(this._renderLoop===p){for(t=0;t<this._sceneCanvasBindings.length;t++)this._sceneCanvasBindings[t].canvas.getManagedContext().setup();this._renderTimes=[performance.now()],this._minFPS=0,this._maxFPS=0,this._fpsSum=0,this._fpsFrameCount=0,this._useRequestAnimFrame?(this._renderLoop=-2,window.requestAnimationFrame(this._renderRequestAnimFrame.bind(this))):this._renderLoop=setInterval(function(){this.render()}.bind(this),e)}},HTMLScreenWithCanvases.prototype.stopRenderLoop=function(){this._renderLoop!==p&&(this._useRequestAnimFrame||clearInterval(this._renderLoop),this._renderLoop=p,this._renderTimes=[])},HTMLScreenWithCanvases.prototype.getFPS=function(){return this._renderTimes.length},HTMLScreenWithCanvases.prototype.getFPSStats=function(){return this._renderTimes.length+" ("+(this._fpsFrameCount>0?Math.round(this._fpsSum/this._fpsFrameCount):"0")+", "+this._minFPS+"-"+this._maxFPS+")"},HTMLScreenWithCanvases.prototype.resizeCanvases=function(){var e;for(e in this._canvases)this._canvases.hasOwnProperty(e)&&!0===this._canvases[e].isResizeable()&&this._canvases[e].handleResize()},MenuScreen.prototype=new HTMLScreen,MenuScreen.prototype.constructor=MenuScreen,MenuScreen.prototype._getKeyCommands=function(e){return e=e||{},e.up=e.up||function(){this._menuComponent.selectPrevious()}.bind(this),e.down=e.down||function(){this._menuComponent.selectNext()}.bind(this),e.enter=e.enter||function(){this._menuComponent.activateSelected()}.bind(this),e},MenuScreen.prototype.setActive=function(e){HTMLScreen.prototype.setActive.call(this,e),this._menuComponent.unselect(),e&&this._menuComponent.refresh()},{ELEMENT_ID_SEPARATOR:u,HTMLScreen:HTMLScreen,CanvasText:CanvasText,ClipSpaceLayout:ClipSpaceLayout,TextLayer:TextLayer,HTMLScreenWithCanvases:HTMLScreenWithCanvases,MenuScreen:MenuScreen,setAnaglyphTextRendering:setAnaglyphTextRendering}}),define("modules/analytics",["modules/application"],function(e){"use strict";function init(e){n=e,t=localStorage.analytics_id,i=localStorage.analytics_user_id,s=!localStorage.analytics_enabled||localStorage.analytics_enabled===(!0).toString()}function login(){var n=!(t&&i);o||(o=!0,c("start"+(n?"":"/"+t+"/"+i)+"?version="+e.getVersion().split(" ")[0]+"&platform="+e.getPlatform(),1e3,!1,function(e){var n=JSON.parse(e.responseText);n.error||n.newlyCreated&&n.id&&n.userID&&(t=n.id,i=n.userID,localStorage.analytics_id=t,localStorage.analytics_user_id=i)}))}function sendEvent(n,o,r){var a,h,u;s&&l(function(){if(t&&i){if(a=n+"/"+t+"/"+i,o)for(h=0;h<o.length;h++)a+="/"+o[h];if(a+="?version="+e.getVersion().split(" ")[0],r)for(a+="&",u=Object.keys(r),h=0;h<u.length;h++)a+=u[h]+"="+r[u[h]]+"&";c(a,1e3,!1,function(){})}})}function isEnabled(){return s}function enable(){s||(s=!0,localStorage.analytics_enabled=(!0).toString(),sendEvent("enable"))}function disable(){s&&(sendEvent("disable"),s=!1,localStorage.analytics_enabled=(!1).toString())}function setEnabled(e){e?enable():disable()}var t,i,n=null,s=!1,o=!1,r=[],a=function(){var e;r.shift(),(e=r[0])&&(e.callback?(e.callback(),a()):e.request&&e.request.send(null))},l=function(e){0===r.length?e():r.push({callback:e})},c=function(e,t,i,o,l){var h=new XMLHttpRequest,u=function(n){l&&(l(h)||(t=0)),t>0?setTimeout(function(){c(e,Math.min(2*t,3e4),!0,function(e){o(e),i||a()},l)},t):i||a()};s&&(h.onload=function(){o(h),i||a()}.bind(this),h.onerror=function(){u(h.statusText)}.bind(this),h.ontimeout=function(){u(0)}.bind(this),h.overrideMimeType("text/plain; charset=utf-8"),h.open("POST",n+e,!0),i?h.send(null):(r.push({request:h}),1===r.length&&h.send(null)))};return{init:init,login:login,sendEvent:sendEvent,isEnabled:isEnabled,enable:enable,disable:disable,setEnabled:setEnabled}}),define("armada/logic/mission-hub",["modules/application","modules/analytics","armada/constants","armada/logic/missions"],function(e,t,i,n){"use strict";function isReady(){return!!a}function isSubmitter(){return!!localStorage[c]&&!!localStorage[h]}function retrieveMissions(e,t){var i;m||(m=!0,i=new XMLHttpRequest,i.onload=function(){var s;return m=!1,"{"!==i.responseText[0]?void t({error:_}):(s=JSON.parse(i.responseText),s.error?void t(s):s.missions&&Array.isArray(s.missions)?(a=s.missions.map(function(e){var t=JSON.parse(e.mission);return t.name=t.info.name+".json",t.custom=!0,t.id=e.id,new n.MissionDescriptor(t)}),r=a.map(function(e){return e.getTitle()}),void e()):void t({error:_}))}.bind(this),i.onerror=function(){m=!1,t({error:u})}.bind(this),i.ontimeout=function(){m=!1,t({error:d})}.bind(this),i.overrideMimeType("text/plain; charset=utf-8"),i.open("GET",s+"missions?"+o,!0),i.send(null))}function init(t){s=t,o="version="+e.getVersion().split(" ")[0]}function submitMission(e,t,i){var n=e.sender,r=new XMLHttpRequest;r.onload=function(){var e;return"{"!==r.responseText[0]?void i({error:p}):(e=JSON.parse(r.responseText),e.error?void i(e):e.token?(localStorage[c]=n,localStorage[h]=e.token,void t()):void i({error:p}))}.bind(this),r.onerror=function(){i({error:u})}.bind(this),r.ontimeout=function(){i({error:d})}.bind(this),r.overrideMimeType("text/plain; charset=utf-8"),r.open("POST",s+"submit?"+o,!0),r.setRequestHeader("Content-Type","application/json"),r.send(JSON.stringify(e))}function getSubmissions(e,t){var i,n=localStorage[c],r=localStorage[h];if(n&&r){if(m)return;m=!0,i=new XMLHttpRequest,i.onload=function(){var n;return m=!1,"{"!==i.responseText[0]?void t({error:_}):(n=JSON.parse(i.responseText),n.error?void t(n):n.missions&&Array.isArray(n.missions)?void e(n.missions):void t({error:_}))}.bind(this),i.onerror=function(){m=!1,t({error:u})}.bind(this),i.ontimeout=function(){m=!1,t({error:d})}.bind(this),i.overrideMimeType("text/plain; charset=utf-8"),i.open("GET",s+"missions/"+n+"?"+o+"&token="+r,!0),i.send(null)}}function deleteSubmission(e,t,i){var n,r=localStorage[c],a=localStorage[h];r&&a&&(n=new XMLHttpRequest,n.onload=function(){var e;return"{"!==n.responseText[0]?void i({error:g}):(e=JSON.parse(n.responseText),e.error?void i(e):!0!==e.success?void i({error:g}):void t())}.bind(this),n.onerror=function(){i({error:u})}.bind(this),n.ontimeout=function(){i({error:d})}.bind(this),n.overrideMimeType("text/plain; charset=utf-8"),n.open("POST",s+"delete/"+e+"?"+o+"&token="+a,!0),n.setRequestHeader("Content-Type","application/json"),n.send(JSON.stringify({username:r})))}function sendEvent(e,i,n){var r,a,l,c;if(t.isEnabled()){if(r=e,i)for(a=0;a<i.length;a++)r+="/"+i[a];if(r+="?"+o,n)for(r+="&",l=Object.keys(n),a=0;a<l.length;a++)r+=l[a]+"="+n[l[a]]+"&";c=new XMLHttpRequest,c.overrideMimeType("text/plain; charset=utf-8"),c.open("POST",s+r,!0),c.send(null)}}function getMissionNames(){return r||[]}function getMissionDescriptors(){return a||[]}function getMissionDescriptor(e){return a.find(function(t){return t.getTitle()===e})}function requestMissionDescriptor(e,t){t(a.find(function(t){return t.getTitle()===e}))}var s,o,r,a,l=i.LOCAL_STORAGE_PREFIX+"missionHub_",c=l+"username",h=l+"token",u=1001,d=1002,p=1003,_=1004,g=1005,m=!1;return{init:init,isReady:isReady,isSubmitter:isSubmitter,retrieveMissions:retrieveMissions,submitMission:submitMission,getSubmissions:getSubmissions,deleteSubmission:deleteSubmission,sendEvent:sendEvent,getMissionNames:getMissionNames,getMissionDescriptor:getMissionDescriptor,getMissionDescriptors:getMissionDescriptors,requestMissionDescriptor:requestMissionDescriptor}}),define("armada/screens/battle",["utils/utils","utils/vectors","utils/matrices","modules/application","modules/game","modules/components","modules/screens","modules/media-resources","modules/egom-model","modules/scene/renderable-objects","modules/scene/scene-graph","modules/analytics","armada/strings","armada/screens/shared","armada/graphics","armada/audio","armada/networking","armada/logic/classes","armada/configuration","armada/control","armada/logic/SpacecraftEvents","armada/logic/missions","armada/logic/missions/events","armada/logic/mission-hub","armada/logic/equipment","armada/logic/spacecraft","armada/logic/ai","utils/polyfill"],function(e,t,i,n,s,o,r,a,l,c,h,u,d,p,_,g,m,f,S,T,y,E,C,M,I,A,x){"use strict";function _refreshWingmanStatusPanel(){ie=te._team?te._team._squads:[],Tt=[]}function _simulationLoopFunction(){var e,t,i,n,o;if(Sn!==sn){if(t=performance.now(),i=t-D,R+=i,T.control(i),Y&&!m.isHost()&&m.sendGuestUpdate(v._pilotedCraft),x.control(i),e=v.getFollowedSpacecraftForScene(O),!P){if(v.tick(i,O,Y),Y)if(m.isHost())for(R>=on&&(R=0,m.sendHostUpdate(v.getSpacecrafts())),o=m.getPlayers(),n=1;n<o.length;n++)o[n].left||(b[n]+=i,b[n]>Ge&&m.guestTimeout(o[n].name));else R>Ge?(Y=!1,s.getScreen(p.MULTI_SCORE_SCREEN_NAME).updateData(),m.leaveGame(),U.showMessage(d.get(d.MULTI_BATTLE.CONNECTION_TIMEOUT),function(){s.setScreen(p.MULTI_SCORE_SCREEN_NAME)})):R>2e3?L!==Zi.LOST&&(L=Zi.LOST,U.clearHUDMessages(pn),U.queueHUDMessage({text:d.get(d.MULTI_BATTLE.CONNECTION_LOST),color:qi.colors.connectionLost,queue:pn,permanent:!0,silent:!0},!0),Pe.play()):R>500?L!==Zi.SLOW&&(L=Zi.SLOW,U.clearHUDMessages(pn),U.queueHUDMessage({text:d.get(d.MULTI_BATTLE.SLOW_CONNECTION),color:qi.colors.slowConnection,queue:pn,permanent:!0,silent:!0},!0),Pe.play()):L!==Zi.GOOD&&(L=Zi.GOOD,U.clearHUDMessages(pn));J+=i,v.isFinished()||v.noHostilesPresent()||(Ue+=i)>Be&&g.playMusic(q)}e&&(!e._alive||e._away?T.isInPilotMode()?T.switchToSpectatorMode(!0):W&&(O._camera.followNextNode()||T.switchToSpectatorMode(!0,!0),Q=0):W&&S.getBattleSetting(S.BS.DEMO_VIEW_SWITCHING)&&(Q+=i)>6e3&&(Q=0,O._camera.changeToNextView(),Math.random()<.5&&O._camera.changeToNextView())),D=t}}function _clearData(){v&&v.destroy(),v=null,O&&O.clear(!0),O=null,st&&st.clear(!0),st=null,Te=null,Le=null,De=0,we=null,g.playMusic(null),ue=0,de=0,pe=0,_e=0,ge=0,me=0,fe=0,X="",zi=null}function _chooseTipText(){var e=H&&E.getMissionDescriptor(H).getTipIDs()||E.getTipIDs(),t=Math.min(Math.floor(Math.random()*e.length),e.length-1);X=d.get(d.TIP.PREFIX,e[t])}function stopTime(){P=!0,O&&O.setShouldAnimate(!1)}function resumeTime(){O&&O.setShouldAnimate(!0),P=!1}function toggleTime(){P?resumeTime():stopTime()}function hideHUD(){je=!1}function showHUD(){je=!0}function toggleHUDVisibility(){je=!je}function handleGraphicsSettingsChanged(){var e;for(e=0;e<En.length;e++)En[e].handleGraphicsSettingsChanged()}function _handleSpacecraftFired(){var e=this.getTarget();e&&e.isHostile(this)&&!v.isFinished()&&(Ue=0,z&&g.playMusic(z))}function _handlePilotedSpacecraftJumpEngaged(){return be={text:d.get(d.BATTLE.MESSAGE_JUMP_ENGAGED),color:qi.colors.jump,queue:dn,permanent:!0,silent:!0},U.queueHUDMessage(be,!0),Se=O._camera.getConfiguration(),!0}function _handlePilotedSpacecraftJumpCancelled(){return U.clearHUDMessages(dn),O._camera.startTransitionToConfiguration(Se),!0}function _switchToCameraConfig(e,t,i){var n=e.vMo._node.getCameraConfigurationsWithName(t);return n.length>0&&(O._camera.startTransitionToConfiguration(n[0],i),!0)}function _handlePilotedSpacecraftPreparingJump(t){t.duration===t.timeLeft&&_switchToCameraConfig(this,"jump",t.duration),t.timeLeft<=0?(hideHUD(),_switchToCameraConfig(this,"flyby",0)||O._camera.setToFreeCamera()):U.queueHUDMessage({text:e.formatString(d.get(d.BATTLE.MESSAGE_JUMP_PREPARING),{timeLeft:e.formatTimeToSeconds(t.timeLeft)}),color:qi.colors.jump,duration:1,queue:dn,silent:!0},!0)}function _handleSpacecraftJumpOutStarted(){this===v.getFollowedSpacecraftForScene(O)&&(W?_switchToCameraConfig(this,"flyby",0):O._camera.setToFreeCamera())}function _handleSpacecraftArrived(){var e=v._pilotedCraft;e&&e._alive&&!e._away&&e.isHostile(this)&&(!Le||De<=0?(Le&&(Le.timeLeft=0),Le={text:"\n\n"+d.get(d.BATTLE.MESSAGE_NEW_HOSTILES),color:qi.colors.alert,blinkInterval:S.gHS(S.BS.HUD.NEW_HOSTILES_ALERT_BLINK_INTERVAL),duration:S.gHS(S.BS.HUD.NEW_HOSTILES_ALERT_DURATION),silent:!0,noBackground:!0,queue:un},U.queueHUDMessage(Le,!0),we=[this],Ne.play()):we.push(this),De=Le.duration)}function _handleHUDEvent(t){var i,n;if(n=Ki[e.constantName(t.state)],t.section)zi[Qi[e.constantName(t.section)]]=n;else for(i=0;i<zi.length;i++)zi[i]=n}function HUDElement(e,t,i,n,s,o,r,a){this._class=new f.TexturedModelClass({name:rn,shader:e,texture:t}),this._position=i,this._scale=[.5*n[0],.5*n[1]],this._scaleMode=s,this._color=o,this._angle=0,this._clipCoordinates=c.CLIP_COORDINATES_NO_CLIP.slice(),this._clipColor=r||[0,0,0,0],this._textureCoordinates=a,this.vMo=null,this._node=null}function _addHUDElement(e){return En.push(e),e}function _createShipIndicator(){return _addHUDElement(new HUDElement(ln,S.gHS(S.BS.HUD.SHIP_INDICATOR).texture,[0,0,0],S.gHS(S.BS.HUD.SHIP_INDICATOR).sizes.maximum,S.gHS(S.BS.HUD.SHIP_INDICATOR).scaleMode,S.gHS(S.BS.HUD.SHIP_INDICATOR).colors.hostile,void 0,S.gHS(S.BS.HUD.SHIP_INDICATOR).mapping))}function _createShipStatusIndicator(e){return _addHUDElement(new HUDElement(an,S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).texture,[0,0],S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).sizes.reticle,S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).scaleMode,S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).colors.friendly,void 0,S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).mappings[e]))}function _createShipArrow(){return _addHUDElement(new HUDElement(an,S.gHS(S.BS.HUD.SHIP_ARROW).texture,[0,0],S.gHS(S.BS.HUD.SHIP_ARROW).sizes.default,S.gHS(S.BS.HUD.SHIP_ARROW).scaleMode,S.gHS(S.BS.HUD.SHIP_ARROW).colors.hostile,void 0,S.gHS(S.BS.HUD.SHIP_ARROW).mapping))}function _createMissileLockIndicator(){return _addHUDElement(new HUDElement(an,S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR).texture,[0,0],[1,1],S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR).scaleMode,S.gHS(S.BS.HUD.SHIP_ARROW).colors.hostile,void 0,S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR).mapping))}function _createWeaponImpactIndicator(){return _addHUDElement(new HUDElement(ln,S.gHS(S.BS.HUD.WEAPON_IMPACT_INDICATOR).texture,[0,0,0],S.gHS(S.BS.HUD.WEAPON_IMPACT_INDICATOR).size,S.gHS(S.BS.HUD.WEAPON_IMPACT_INDICATOR).scaleMode,S.gHS(S.BS.HUD.WEAPON_IMPACT_INDICATOR).colors.normal,void 0,S.gHS(S.BS.HUD.WEAPON_IMPACT_INDICATOR).mapping))}function _createWingmanCraftIndicatorLayout(t,i,n){var s,o,a;return s=e.deepCopy(S.gHS(S.BS.HUD.WINGMEN_STATUS_SQUAD_LAYOUT)),s.right+=s.width*t,o=S.gHS(S.BS.HUD.WINGMEN_STATUS_CRAFT_POSITIONS)[i-1][n],a=Yi.size,s.right-=s.width*(.5-.5*(o[0]+a[0])),s.top-=s.height*(.5-.5*(o[1]+a[1])),s.width*=a[0],s.height*=a[1],new r.ClipSpaceLayout(s)}function _createWingmanCraftIndicator(e,t,i){var n,s;return n=Yi.mappings,s=new HUDElement(cn,Yi.texture,e.getClipSpacePosition(),e.getClipSpaceSize(),e._scaleMode,Yi.colors.fullIntegrity,void 0,t&&n[t]||n.general),i||_addHUDElement(s),s}function _createWingmenStatusSquadText(e){var t=S.gHS(S.BS.HUD.WINGMEN_STATUS_SQUAD_TEXT).position;return t=[t[0]+2*e*S.gHS(S.BS.HUD.WINGMEN_STATUS_SQUAD_LAYOUT).width/S.gHS(S.BS.HUD.WINGMEN_STATUS_BACKGROUND).layout.width,t[1]],new r.CanvasText(t,"",S.gHS(S.BS.HUD.WINGMEN_STATUS_SQUAD_TEXT).fontName,S.gHS(S.BS.HUD.WINGMEN_STATUS_SQUAD_TEXT).fontSize,ui._scaleMode,S.gHS(S.BS.HUD.WINGMEN_STATUS_SQUAD_TEXT).color,"center")}function _addHUDToScene(){var t,i,n,s,o,l,c;for(ke=ke||_addHUDElement(new HUDElement(an,S.gHS(S.BS.HUD.CENTER_CROSSHAIR).texture,[0,0],S.gHS(S.BS.HUD.CENTER_CROSSHAIR).size,ai,S.gHS(S.BS.HUD.CENTER_CROSSHAIR).color,void 0,S.gHS(S.BS.HUD.CENTER_CROSSHAIR).mapping)),ke.addToScene(O),Rt=Rt||_addHUDElement(new HUDElement(an,S.gHS(S.BS.HUD.DRIFT_ARROW).texture,[0,0],S.gHS(S.BS.HUD.DRIFT_ARROW).size,S.gHS(S.BS.HUD.DRIFT_ARROW).scaleMode,S.gHS(S.BS.HUD.DRIFT_ARROW).colors.maxSpeed,void 0,S.gHS(S.BS.HUD.DRIFT_ARROW).mapping)),Rt.addToScene(O),Qe||(Qe=[_createShipArrow()]),t=0;t<Qe.length;t++)Qe[t].addToScene(O);if(!it)for(it=[],s=Object.keys(S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).mappings),t=0;t<s.length;t++)it.push(_createShipStatusIndicator(s[t]));for(t=0;t<it.length;t++)it[t].addToScene(O);if(!Ke)for(Ke=[],t=0;t<S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR_COUNT);t++)Ke.push(_createMissileLockIndicator());for(t=0;t<S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR_COUNT);t++)Ke[t].addToScene(O);for(Je||(Je=[_createShipIndicator()]),t=0;t<Je.length;t++)Je[t].addToScene(O);for(nt=nt||_addHUDElement(new HUDElement(ln,S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).texture,[0,0,0],S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).size,S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).scaleMode,S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).colors.hostile,void 0,S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).mapping)),nt.addToScene(O),We||(We=[_createWeaponImpactIndicator()]),t=0;t<We.length;t++)We[t].addToScene(O);for(ct=ct||_addHUDElement(new HUDElement(cn,S.gHS(S.BS.HUD.TARGET_INFO_BACKGROUND).texture,hi.getClipSpacePosition(),hi.getClipSpaceSize(),hi._scaleMode,S.gHS(S.BS.HUD.TARGET_INFO_BACKGROUND).color,void 0,S.gHS(S.BS.HUD.TARGET_INFO_BACKGROUND).mapping)),ct.addToScene(O),_t=_t||_addHUDElement(new HUDElement(cn,S.gHS(S.BS.HUD.WINGMEN_STATUS_BACKGROUND).texture,ui.getClipSpacePosition(),ui.getClipSpaceSize(),ui._scaleMode,S.gHS(S.BS.HUD.WINGMEN_STATUS_BACKGROUND).color,void 0,S.gHS(S.BS.HUD.WINGMEN_STATUS_BACKGROUND).mapping)),_t.addToScene(O),Nt=Nt||_addHUDElement(new HUDElement(cn,S.gHS(S.BS.HUD.FLIGHT_MODE_INDICATOR_BACKGROUND).texture,Ti.getClipSpacePosition(),Ti.getClipSpaceSize(),Ti._scaleMode,S.gHS(S.BS.HUD.FLIGHT_MODE_INDICATOR_BACKGROUND).color,void 0,S.gHS(S.BS.HUD.FLIGHT_MODE_INDICATOR_BACKGROUND).mapping)),Nt.addToScene(O),Vt=Vt||_addHUDElement(new HUDElement(cn,S.gHS(S.BS.HUD.MISSILE_INFO_BACKGROUND).texture,yi.getClipSpacePosition(),yi.getClipSpaceSize(),yi._scaleMode,S.gHS(S.BS.HUD.MISSILE_INFO_BACKGROUND).color,void 0,S.gHS(S.BS.HUD.MISSILE_INFO_BACKGROUND).mapping)),Vt.addToScene(O),Qt=Qt||_addHUDElement(new HUDElement(cn,S.gHS(S.BS.HUD.OBJECTIVES_BACKGROUND).texture,Mi.getClipSpacePosition(),Mi.getClipSpaceSize(),Mi._scaleMode,S.gHS(S.BS.HUD.OBJECTIVES_BACKGROUND).color,void 0,S.gHS(S.BS.HUD.OBJECTIVES_BACKGROUND).mapping)),Qt.addToScene(O),ei=ei||_addHUDElement(new HUDElement(cn,S.gHS(S.BS.HUD.ESCORTS_BACKGROUND).texture,Ii.getClipSpacePosition(),Ii.getClipSpaceSize(),Ii._scaleMode,S.gHS(S.BS.HUD.ESCORTS_BACKGROUND).color,void 0,S.gHS(S.BS.HUD.ESCORTS_BACKGROUND).mapping)),ei.addToScene(O),Yt=Yt||_addHUDElement(new HUDElement(cn,S.gHS(S.BS.HUD.MESSAGE_BACKGROUND).texture,Ai.getClipSpacePosition(),Ai.getClipSpaceSize(),Ai._scaleMode,S.gHS(S.BS.HUD.MESSAGE_BACKGROUND).color,void 0,S.gHS(S.BS.HUD.MESSAGE_BACKGROUND).mapping)),Yt.addToScene(O),St||(Tt=[],St=[]),t=0;t<St.length;t++)St[t].body.addToScene(O),St[t].shield.addToScene(O);if(ft&&ft.addToScene(O),ht=ht||_addHUDElement(new HUDElement(hn,S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_BAR).texture,di.getClipSpacePosition(),di.getClipSpaceSize(),di._scaleMode,S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_BAR).colors.filled,S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_BAR).colors.empty,S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_BAR).mapping)),ht.addToScene(O),ut=ut||_addHUDElement(new HUDElement(hn,S.gHS(S.BS.HUD.TARGET_SHIELD_BAR).texture,pi.getClipSpacePosition(),pi.getClipSpaceSize(),pi._scaleMode,S.gHS(S.BS.HUD.TARGET_SHIELD_BAR).colors.filled,S.gHS(S.BS.HUD.TARGET_SHIELD_BAR).colors.empty,S.gHS(S.BS.HUD.TARGET_SHIELD_BAR).mapping)),ut.addToScene(O),Et=Et||_addHUDElement(new HUDElement(hn,S.gHS(S.BS.HUD.SPEED_BAR).texture,_i.getClipSpacePosition(),_i.getClipSpaceSize(),_i._scaleMode,S.gHS(S.BS.HUD.SPEED_BAR).colors.combatFilled,S.gHS(S.BS.HUD.SPEED_BAR).colors.combatEmpty,S.gHS(S.BS.HUD.SPEED_BAR).mapping)),Et.addToScene(O),Ct=Ct||_addHUDElement(new HUDElement(hn,S.gHS(S.BS.HUD.SPEED_TARGET_INDICATOR).texture,_i.getClipSpacePosition(),_i.getClipSpaceSize(),_i._scaleMode,S.gHS(S.BS.HUD.SPEED_TARGET_INDICATOR).color,void 0,S.gHS(S.BS.HUD.SPEED_TARGET_INDICATOR).mapping)),Ct.addToScene(O),Mt=Mt||_addHUDElement(new HUDElement(hn,S.gHS(S.BS.HUD.MISSILE_INDICATOR).texture,mi.getClipSpacePosition(),mi.getClipSpaceSize(),mi._scaleMode,S.gHS(S.BS.HUD.MISSILE_INDICATOR).colors.loading,S.gHS(S.BS.HUD.MISSILE_INDICATOR).colors.loading,S.gHS(S.BS.HUD.MISSILE_INDICATOR).mappings.single)),Mt.addToScene(O),c=new HUDElement(hn,S.gHS(S.BS.HUD.MISSILE_INDICATOR).texture,mi.getClipSpacePosition(),mi.getClipSpaceSize(),mi._scaleMode,S.gHS(S.BS.HUD.MISSILE_INDICATOR).colors.loading,S.gHS(S.BS.HUD.MISSILE_INDICATOR).colors.loading,S.gHS(S.BS.HUD.MISSILE_INDICATOR).mappings.salvo),c.addResourcesToScene(O),bt=bt||_addHUDElement(new HUDElement(hn,S.gHS(S.BS.HUD.HULL_INTEGRITY_BAR).texture,fi.getClipSpacePosition(),fi.getClipSpaceSize(),fi._scaleMode,S.gHS(S.BS.HUD.HULL_INTEGRITY_BAR).colors.filled,S.gHS(S.BS.HUD.HULL_INTEGRITY_BAR).colors.empty,S.gHS(S.BS.HUD.HULL_INTEGRITY_BAR).mapping)),bt.addToScene(O),Lt=Lt||_addHUDElement(new HUDElement(hn,S.gHS(S.BS.HUD.SHIELD_BAR).texture,Si.getClipSpacePosition(),Si.getClipSpaceSize(),Si._scaleMode,S.gHS(S.BS.HUD.SHIELD_BAR).colors.filled,S.gHS(S.BS.HUD.SHIELD_BAR).colors.empty,S.gHS(S.BS.HUD.SHIELD_BAR).mapping)),Lt.addToScene(O),Ye=Ye||_addHUDElement(new HUDElement(hn,S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR).texture,Ei.getClipSpacePosition(),Ei.getClipSpaceSize(),Ei._scaleMode,S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR).colors.hostileFilled,void 0,S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR).mapping)),Ye.addToScene(O),Xe=Xe||_addHUDElement(new HUDElement(hn,S.gHS(S.BS.HUD.TARGET_SHIELD_QUICK_VIEW_BAR).texture,Ci.getClipSpacePosition(),Ci.getClipSpaceSize(),Ci._scaleMode,S.gHS(S.BS.HUD.TARGET_SHIELD_QUICK_VIEW_BAR).colors.filled,void 0,S.gHS(S.BS.HUD.TARGET_SHIELD_QUICK_VIEW_BAR).mapping)),Xe.addToScene(O),i=S.gHS(S.BS.HUD.MAX_ESCORTS_DISPLAYED),!si)for(si=[],t=0;t<i;t++)si.push({}),l=e.deepCopy(Wi.layouts.hull),l.top+=t*S.gHS(S.BS.HUD.ESCORTS_TEXT_OFFSET)*Ii.getClipSpaceHeight()*.5,si[t].hullLayout=new r.ClipSpaceLayout(l),si[t].hull=_addHUDElement(new HUDElement(hn,Wi.texture,si[t].hullLayout.getClipSpacePosition(),si[t].hullLayout.getClipSpaceSize(),si[t].hullLayout._scaleMode,Wi.colors.fullHull,Wi.colors.destroyed,Wi.mapping)),l=e.deepCopy(Wi.layouts.shield),l.top+=t*S.gHS(S.BS.HUD.ESCORTS_TEXT_OFFSET)*Ii.getClipSpaceHeight()*.5,si[t].shieldLayout=new r.ClipSpaceLayout(l),si[t].shield=_addHUDElement(new HUDElement(hn,Wi.texture,si[t].shieldLayout.getClipSpacePosition(),si[t].shieldLayout.getClipSpaceSize(),si[t].shieldLayout._scaleMode,Wi.colors.shield,Wi.colors.lostShield,Wi.mapping));for(t=0;t<i;t++)si[t].hull.addToScene(O),si[t].shield.addToScene(O);for(qe=qe||_addHUDElement(new HUDElement(an,S.gHS(S.BS.HUD.CURSOR).texture,[0,0],S.gHS(S.BS.HUD.CURSOR).size,S.gHS(S.BS.HUD.CURSOR).scaleMode,S.gHS(S.BS.HUD.CURSOR).color,void 0,S.gHS(S.BS.HUD.CURSOR).mappings.still)),qe.addToScene(O),ze=ze||_addHUDElement(new HUDElement(an,S.gHS(S.BS.HUD.CURSOR).texture,[0,0],S.gHS(S.BS.HUD.CURSOR).size,S.gHS(S.BS.HUD.CURSOR).scaleMode,S.gHS(S.BS.HUD.CURSOR).color,void 0,S.gHS(S.BS.HUD.CURSOR).mappings.turn)),ze.addToScene(O),n=_createWingmanCraftIndicatorLayout(0,1,0),s=Object.keys(Yi.mappings),t=0;t<s.length;t++)o=_createWingmanCraftIndicator(n,s[t],!0),o.addResourcesToScene(O);a.getSoundEffect(S.gHS(S.BS.HUD.TARGET_SWITCH_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.TARGET_SWITCH_DENIED_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.FLIGHT_MODE_SWITCH_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_CHANGE_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_CHANGE_DENIED_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_SALVO_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_LOADED_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_LOCKING_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_LOCKED_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.MESSAGE_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.MESSAGE_TYPE_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.NEW_HOSTILES_ALERT_SOUND).name),a.getSoundEffect(S.gHS(S.BS.HUD.CONNECTION_WARNING_SOUND).name)}function _getMenuKeyHTMLString(){return"<span class='highlightedText'>"+T.getInputInterpreter(T.KEYBOARD_NAME).getControlStringForAction("quit")+"</span>"}function _scShouldBeIndicated(e){return e._alive&&!e._away&&e!==te}function _escortShouldBeIndicated(e){return e!==te}function _getDistanceString(e){return e>1e3?(e/1e3).toPrecision(3)+"k":Math.round(e).toString()}function _getHullIntegrityColor(t,i,n,s){return t>.5?e.getMixedColor(n,i,2*(t-.5)):e.getMixedColor(s,n,2*t)}function _tViewAddCallback(e){e.setUniformValueFunction(c.UNIFORM_COLOR_NAME,function(){return lt}),e.setScale(1/e.getSize()),rt=e}function _hudSectionIsVisible(e){return zi[e]===Ki.VISIBLE||zi[e]===Ki.HIGHLIGHTED&&Fe}function BattleScreen(){r.HTMLScreenWithCanvases.call(this,p.BATTLE_SCREEN_NAME,p.BATTLE_SCREEN_SOURCE,{cssFilename:p.BATTLE_SCREEN_CSS,backgroundClassName:p.SCREEN_BACKGROUND_CLASS_NAME,containerClassName:p.SCREEN_CONTAINER_CLASS_NAME},_.getAntialiasing(),!0,_.getFiltering(),!0,{activate:function(){oi=S.gHS(S.BS.HUD.AIM_ASSIST_CROSSHAIRS),ri=S.gHS(S.BS.HUD.RELATIVE_TARGET_ORIENTATION),jt&&(S.gHS(S.BS.HUD.SHOW_VERSION_INFO)?jt.show():jt.hide()),S.gHS(S.BS.HUD.SHOW_FPS_COUNTER)?this._stats.show():this._stats.hide()}}),this._stats=this.registerSimpleComponent($i),this._touchControlSheet=this.registerSimpleComponent(en),this._loadingBox=this.registerExternalComponent(new o.LoadingBox(tn,p.LOADING_BOX_SOURCE,{cssFilename:p.LOADING_BOX_CSS},d.LOADING.HEADER.name)),this._infoBox=this.registerExternalComponent(new o.InfoBox(nn,p.INFO_BOX_SOURCE,{cssFilename:p.INFO_BOX_CSS},d.INFO_BOX.HEADER.name,d.INFO_BOX.OK_BUTTON.name,{show:function(){if(U.isVisible()){for(;s.getScreen()!==U;)s.closeSuperimposedScreen();this.pauseBattle()}}.bind(this),hide:function(){s.getScreen()===U&&this._doStartBattle()}.bind(this),buttonselect:p.playButtonSelectSound,buttonclick:p.playButtonClickSound}))}function _mapObjectiveState(e){return e.state===Ji.COMPLETED}function _goToDebriefing(){var t,i,n,o,r,a=!1;if(Y)return s.setScreen(p.MULTI_SCORE_SCREEN_NAME),void m.leaveGame();i=v._pilotedCraft,t=v._state===C.MissionState.COMPLETED,n=i?i.getHitRatio():0,o=i?v.getPerformanceStatistics():{},H?(r=E.getMissionDescriptor(v._name),
v._state!==C.MissionState.NONE&&r.increasePlaythroughCount(t),t&&!r._custom&&(a=r.updateBestScore(o.score,o.performance),u.sendEvent("score",[e.getFilenameWithoutExtension(H)],{difficulty:k,score:o.score}))):t&&v.getId()&&M.sendEvent("score",[v.getId()],{difficulty:k,score:o.score}),s.getScreen(p.DEBRIEFING_SCREEN_NAME).setData({missionState:v._state,objectives:v.getObjectives(),objectivesCompleted:v.getObjectivesState(!0).map(_mapObjectiveState),performance:t?o.performance:E.FAILED_MISSION_PERFORMACE,nextPerformance:t?o.nextPerformance:null,nextPerformanceScore:t?o.nextPerformanceScore:0,score:t?o.score:0,isRecord:a,elapsedTime:J,kills:i?i.getKills():0,damageDealt:i?Math.round(i.getDamageDealt()):0,baseScore:o.baseScore||0,hitRatio:n,hitRatioBonus:o.hitRatioBonus,missileDamageDealt:i?Math.round(i.getMissileDamageDealt()):0,missilesLaunched:i?Math.round(i.getMissilesLaunched()):0,missilesHit:i?Math.round(i.getMissileHitsOnEnemies()):0,hullIntegrity:i?i.getHullIntegrity():0,hullIntegrityBonus:o.hullIntegrityBonus,teamSurvival:o.teamSurvival,teamSurvivalBonus:o.teamSurvivalBonus,nextMissionName:t?v.getNextMissionName():null}),s.setScreen(p.DEBRIEFING_SCREEN_NAME)}var v,O,R,b,L,N,D,P,w,V,F,U,B,H,G,j,k,W,Y,X,q,z,J,Q,K,Z,$,ee,te,ie,ne,se,oe,re,ae,le,ce,he,ue,de,pe,_e,ge,me,fe,Se,Te,ye,Ee,Ce,Me,Ie,Ae,xe,ve,Oe,Re,be,Le,Ne,De,Pe,we,Ve,Fe,Ue,Be,He,Ge,je,ke,We,Ye,Xe,qe,ze,Je,Qe,Ke,Ze,$e,et,tt,it,nt,st,ot,rt,at,lt,ct,ht,ut,dt,pt,_t,gt,mt,ft,St,Tt,yt,Et,Ct,Mt,It,At,xt,vt,Ot,Rt,bt,Lt,Nt,Dt,Pt,wt,Vt,Ft,Ut,Bt,Ht,Gt,jt,kt,Wt,Yt,Xt,qt,zt,Jt,Qt,Kt,Zt,$t,ei,ti,ii,ni,si,oi,ri,ai,li,ci,hi,ui,di,pi,_i,gi,mi,fi,Si,Ti,yi,Ei,Ci,Mi,Ii,Ai,xi,vi,Oi,Ri,bi,Li,Ni,Di,Pi,wi,Vi,Fi,Ui,Bi,Hi,Gi,ji,ki,Wi,Yi,Xi,qi,zi,Ji=C.ObjectiveState,Qi={TARGET_INFO:0,TARGET_INDICATOR:1,SHIP_INDICATORS:2,AIM_ASSIST_INDICATOR:3,WEAPON_IMPACT_INDICATORS:4,HULL_BAR:5,SHIELD_BAR:6,SPEED_BAR:7,DRIFT_ARROW:8,FLIGHT_MODE:9,WINGMEN_INFO:10,MISSILE_INFO:11,MISSILE_INDICATOR:12,OBJECTIVES:13,ESCORTS:14,SCORE:15},Ki={VISIBLE:0,HIDDEN:1,HIGHLIGHTED:2},Zi={GOOD:0,SLOW:1,LOST:2},$i="stats",en="touchControlSheet",tn="loadingBox",nn="infoBox",sn=-1,on=50,rn="hudElementClass",an="ui2d",ln="ui3d",cn="ui2d-mix-viewport",hn="ui2d-clip-viewport",un="hostileAlert",dn="system",pn="connection",_n=[pn,dn,"mission","info",un],gn=["name","class","team","firepower","distance","velocity"],mn={weapons:!0},fn=!!navigator.wakeLock,Sn=sn,Tn=-1,yn={},En=[],Cn=i.identity4();return Object.freeze(Qi),Object.freeze(Ki),HUDElement.prototype._getModelName=function(){return"squareModel"+(this._textureCoordinates?"-"+this._textureCoordinates[0].join("-")+"-"+this._textureCoordinates[1].join("-"):"")},HUDElement.prototype._acquireResources=function(){var e,t;e=this._getModelName(),t=a.getModel(e,{allowNullResult:!0}),this._class.acquireResources({model:t||l.squareModel(e,this._textureCoordinates)})},HUDElement.prototype._initVisualModel=function(){this.vMo?this.vMo.init(this._class.getModel(),this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),_.getTextureQualityPreferenceList()),this._position,this._scale,this._scaleMode,this._color,Math.degrees(this._angle),this._clipCoordinates,this._clipColor):this.vMo=new c.UIElement(this._class.getModel(),this._class.getShader(),this._class.getTexturesOfTypes(this._class.getShader().getTextureTypes(),_.getTextureQualityPreferenceList()),this._position,this._scale,this._scaleMode,this._color,Math.degrees(this._angle),this._clipCoordinates,this._clipColor)},HUDElement.prototype.addToScene=function(e){this._acquireResources(),a.executeWhenReady(function(){this._initVisualModel(),this._node=e.addUIObject(this.vMo)}.bind(this))},HUDElement.prototype.addResourcesToScene=function(e){this._acquireResources(),a.executeWhenReady(function(){this._initVisualModel(),e.addResourcesOfObject(this.vMo)}.bind(this))},HUDElement.prototype.hide=function(){this._node.hide()},HUDElement.prototype.show=function(){this._node.show()},HUDElement.prototype.isVisible=function(){return this._node.isVisible()},HUDElement.prototype.setPosition=function(e){this._position=e,this.vMo&&this.vMo.setPosition(e)},HUDElement.prototype.setSize=function(e){this._scale[0]=.5*e[0],this._scale[1]=.5*e[1],this.vMo&&this.vMo.setSize(this._scale)},HUDElement.prototype.setAngle=function(e){this._angle=e,this.vMo&&this.vMo.setAngle(e)},HUDElement.prototype.setColor=function(e){this._color=e,this.vMo&&this.vMo.setColor(e)},HUDElement.prototype.clipX=function(t,i){this._textureCoordinates&&(t=e.getLinearMix(this._textureCoordinates[0][0],this._textureCoordinates[1][0],t),i=e.getLinearMix(this._textureCoordinates[0][0],this._textureCoordinates[1][0],i)),this._clipCoordinates[0]=t,this._clipCoordinates[1]=i,this.vMo&&this.vMo.clipX(t,i)},HUDElement.prototype.clipY=function(t,i){this._textureCoordinates&&(t=1-e.getLinearMix(this._textureCoordinates[1][1],this._textureCoordinates[0][1],t),i=1-e.getLinearMix(this._textureCoordinates[1][1],this._textureCoordinates[0][1],i)),this._clipCoordinates[2]=1-i,this._clipCoordinates[3]=1-t,this.vMo&&this.vMo.clipY(t,i)},HUDElement.prototype.setClipColor=function(e){this._clipColor=e,this.vMo&&this.vMo.setClipColor(e)},HUDElement.prototype.setTextureCoordinates=function(e){this._textureCoordinates=e,this.vMo&&this.vMo.setModel(_.getModel(this._getModelName()).getEgomModel())},HUDElement.prototype.setScaleMode=function(e){this._scaleMode=e,this.vMo&&this.vMo.setScaleMode(e)},HUDElement.prototype.applyLayout=function(e,t,i){this.setPosition(e.getPosition(t,i)),this.setSize(e.getSize(t,i))},HUDElement.prototype.handleGraphicsSettingsChanged=function(){this._class.handleGraphicsSettingsChanged()},BattleScreen.prototype=new r.HTMLScreenWithCanvases,BattleScreen.prototype.constructor=BattleScreen,BattleScreen.prototype.show=function(){return!!r.HTMLScreenWithCanvases.prototype.show.call(this)&&(document.getElementById(p.GAME_VERSION_LABEL_ID).hidden=!0,!0)},BattleScreen.prototype.hide=function(){var e;return!!r.HTMLScreenWithCanvases.prototype.hide.call(this)&&(Y&&(Y=!1),this.pauseBattle(!0),_clearData(),e=_.isShadowMappingEnabled(),_.setShadowMapping(),e!==_.isShadowMappingEnabled()&&_.handleSettingsChanged(),document.getElementById(p.GAME_VERSION_LABEL_ID).hidden=!1,!0)},BattleScreen.prototype.setActive=function(e){r.HTMLScreen.prototype.setActive.call(this,e),e?(fn&&!B&&navigator.wakeLock.request("screen").then(function(e){B=e,B.onrelease=function(){B=null}}).catch(function(){}),V&&document.removeEventListener("visibilitychange",V),V=V||function(){"visible"===document.visibilityState||this._touchControlSheet.isVisible()||this._infoBox.isVisible()||T.getController(T.GENERAL_CONTROLLER_NAME).executeAction("quit")}.bind(this),document.addEventListener("visibilitychange",V)):(T.exitPointerLock(),B&&B.release(),V&&(document.removeEventListener("visibilitychange",V),V=null))},BattleScreen.prototype._initializeComponents=function(){var e;r.HTMLScreenWithCanvases.prototype._initializeComponents.call(this),e=this.getScreenCanvas("battleCanvas").getCanvasElement(),w&&window.removeEventListener("resize",w),w=w||function(){T.setScreenCenter(e.width/2,e.height/2)},window.addEventListener("resize",w),this._touchControlSheet.hide(),this._touchControlSheet._element.onclick=function(){this._touchControlSheet.hide(),this._doStartBattle()}.bind(this),w()},BattleScreen.prototype._updateComponents=function(){r.HTMLScreenWithCanvases.prototype._updateComponents.call(this)},BattleScreen.prototype._doStartBattle=function(){this.resumeBattle(),resumeTime(),W?(T.switchToSpectatorMode(!1,!0),O._camera.followNextNode(),Q=0):T.switchToPilotMode(v._pilotedCraft,!0)},BattleScreen.prototype.pauseBattle=function(e,t,i){T.stopListening(),N=document.body.style.cursor,document.body.style.cursor=s.getDefaultCursor(),Y&&!e||(-2!==Sn&&clearInterval(Sn),Sn=sn,O&&O.setShouldAnimate(!1),this.stopRenderLoop()),!1!==t&&(g.resetMusicVolume(),g.setMusicVolume(.5*g.getMusicVolume(),!1)),!1!==i&&(g.resetSFXVolume(),g.setSFXVolume(.1*g.getSFXVolume(),!1)),Ce&&Ce.stopPlaying(.01)},BattleScreen.prototype.resumeBattle=function(e,t){document.body.style.cursor=N||s.getDefaultCursor(),Y&&!e?T.startListening():Sn===sn?(D=performance.now(),O&&(P||O.setShouldAnimate(!0)),Sn=-2,T.startListening(),t&&T.getInputInterpreter(T.KEYBOARD_NAME).setEscapeToPressed(),this.startRenderLoop(1e3/60)):n.showError("Trying to resume simulation while it is already going on!",n.ErrorSeverity.MINOR,"No action was taken, to avoid double-running the simulation."),g.resetMusicVolume(),g.resetSFXVolume(),T.getInputInterpreter(T.MOUSE_NAME).isEnabled()&&this.requestPointerLock(!0)},BattleScreen.prototype._updateLoadingStatus=function(e,t){void 0!==e&&this._loadingBox.updateStatus(X+p.getSubParagraph(e)),void 0!==t&&this._loadingBox.updateProgress(t)},BattleScreen.prototype._updateLoadingBoxForResourceLoad=function(t,i,n,s){this._updateLoadingStatus(e.formatString(d.get(d.LOADING.RESOURCE_READY),{resource:t,resourceType:i,loaded:s,total:n}),20+s/n*60)},BattleScreen.prototype._addUITexts=function(){var e,t,i,n=this.getScreenCanvas("battleCanvas"),s=function(e,t,i,n){var s,o;return s=S.gHS(e),o=new r.CanvasText(s.position,"",s.fontName,s.fontSize,t._scaleMode,s.color||s.colors[Object.keys(s.colors)[0]],n),i.addText(o),o},o=function(e){return new r.CanvasText(e,"",S.gHS(S.BS.HUD.SPEED_TEXT).fontName,S.gHS(S.BS.HUD.SPEED_TEXT).fontSize,_i._scaleMode,S.gHS(S.BS.HUD.SPEED_TEXT).colors.combatForward)};if(et||(et=new r.TextLayer(S.gHS(S.BS.HUD.DISTANCE_TEXT_LAYER_LAYOUT)),n.addTextLayer(et)),tt||(tt=new r.CanvasText(S.gHS(S.BS.HUD.DISTANCE_TEXT).position,"",S.gHS(S.BS.HUD.DISTANCE_TEXT).fontName,S.gHS(S.BS.HUD.DISTANCE_TEXT).fontSize,new r.ClipSpaceLayout(li)._scaleMode,S.gHS(S.BS.HUD.DISTANCE_TEXT).colors.hostile,"left",S.gHS(S.BS.HUD.DISTANCE_TEXT).layout),et.addText(tt)),dt||(dt=new r.TextLayer(S.gHS(S.BS.HUD.TARGET_INFO_TEXT_LAYER_LAYOUT)),n.addTextLayer(dt)),!pt)for(pt={},e=0;e<gn.length;e++)pt[gn[e]]=function(e){return new r.CanvasText(S.gHS(S.BS.HUD.TARGET_INFO_TEXT).positions[e],"",S.gHS(S.BS.HUD.TARGET_INFO_TEXT).fontName,S.gHS(S.BS.HUD.TARGET_INFO_TEXT).fontSizes["name"===e?"name":"others"],hi._scaleMode,S.gHS(S.BS.HUD.TARGET_INFO_TEXT).colors.friendly)}(gn[e]),dt.addText(pt[gn[e]]);if(gt||(gt=new r.TextLayer(S.gHS(S.BS.HUD.WINGMEN_STATUS_BACKGROUND).layout),n.addTextLayer(gt)),mt=mt||s(S.BS.HUD.WINGMEN_STATUS_HEADER_TEXT,ui,gt),mt.setText(d.get(d.BATTLE.HUD_WINGMEN_HEADER)),yt||(yt=[]),xt||(xt=new r.TextLayer(S.gHS(S.BS.HUD.SPEED_TEXT_LAYER_LAYOUT)),n.addTextLayer(xt)),vt||(vt=o(S.gHS(S.BS.HUD.SPEED_TEXT).positions.maxForward),xt.addText(vt)),Ot||(Ot=o(S.gHS(S.BS.HUD.SPEED_TEXT).positions.maxReverse),xt.addText(Ot)),It||(It=new r.TextLayer(S.gHS(S.BS.HUD.MISSILE_INDICATOR_TEXT_LAYOUT)),n.addTextLayer(It)),At||(At=new r.CanvasText(S.gHS(S.BS.HUD.MISSILE_INDICATOR_TEXT).position,"",S.gHS(S.BS.HUD.MISSILE_INDICATOR_TEXT).fontName,S.gHS(S.BS.HUD.MISSILE_INDICATOR_TEXT).fontSize,mi._scaleMode,S.gHS(S.BS.HUD.MISSILE_INDICATOR_TEXT).colors.ready,"right"),It.addText(At)),Dt||(Dt=new r.TextLayer(S.gHS(S.BS.HUD.FLIGHT_MODE_INDICATOR_BACKGROUND).layout),n.addTextLayer(Dt)),Pt=Pt||s(S.BS.HUD.FLIGHT_MODE_HEADER_TEXT,Ti,Dt),Pt.setText(d.get(d.BATTLE.HUD_FLIGHT_MODE)),wt||(wt=new r.CanvasText(S.gHS(S.BS.HUD.FLIGHT_MODE_TEXT).position,"",S.gHS(S.BS.HUD.FLIGHT_MODE_TEXT).fontName,S.gHS(S.BS.HUD.FLIGHT_MODE_TEXT).fontSize,Ti._scaleMode,S.gHS(S.BS.HUD.FLIGHT_MODE_TEXT).colors.combat),Dt.addText(wt)),Ft||(Ft=new r.TextLayer(S.gHS(S.BS.HUD.MISSILE_INFO_BACKGROUND).layout),n.addTextLayer(Ft)),Ut=Ut||s(S.BS.HUD.MISSILE_INFO_HEADER_TEXT,yi,Ft),Ut.setText(d.get(d.BATTLE.HUD_MISSILES)),!Bt)for(Bt=[],Ht=[],t=S.gHS(S.BS.HUD.MAX_MISSILE_INFO_DISPLAYED),e=0;e<t;e++)Bt.push(function(e){var t=S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).positions.name;return t=[t[0],t[1]+e*S.gHS(S.BS.HUD.MISSILE_INFO_TEXT_OFFSET)],new r.CanvasText(t,"",S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).fontName,S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).fontSize,yi._scaleMode,S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).colors.notSelected)}(e)),Ft.addText(Bt[e]),Ht.push(function(e){var t=S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).positions.count;return t=[t[0],t[1]+e*S.gHS(S.BS.HUD.MISSILE_INFO_TEXT_OFFSET)],new r.CanvasText(t,"",S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).fontName,S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).fontSize,yi._scaleMode,S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).colors.notSelected,"right")}(e)),Ft.addText(Ht[e]);if(Gt||(Gt=new r.TextLayer(S.gHS(S.BS.HUD.HEADER_TEXT_LAYER_LAYOUT)),n.addTextLayer(Gt)),jt=jt||s(S.BS.HUD.SMALL_HEADER_TEXT,Gt.getLayout(),Gt,"center"),kt=kt||s(S.BS.HUD.BIG_HEADER_TEXT,Gt.getLayout(),Gt,"center"),Wt=Wt||s(S.BS.HUD.SUBHEADER_TEXT,Gt.getLayout(),Gt,"center"),Xt||(i=S.gHS(S.BS.HUD.MESSAGE_BACKGROUND).layout,i.width-=S.gHS(S.BS.HUD.MESSAGE_TEXT_MARGIN),Xt=new r.TextLayer(i),n.addTextLayer(Xt)),qt=qt||s(S.BS.HUD.MESSAGE_TEXT,Xt.getLayout(),Xt,"center"),zt||(zt=new r.TextLayer(S.gHS(S.BS.HUD.TOP_LEFT_TEXT_LAYER_LAYOUT)),n.addTextLayer(zt)),Jt=Jt||s(S.BS.HUD.SCORE_TEXT,zt.getLayout(),zt,"left"),Kt||(Kt=new r.TextLayer(S.gHS(S.BS.HUD.OBJECTIVES_BACKGROUND).layout),n.addTextLayer(Kt)),Zt=Zt||s(S.BS.HUD.OBJECTIVES_HEADER_TEXT,Mi,Kt),Zt.setText(d.get(d.BATTLE.HUD_OBJECTIVES)),!$t)for($t=[],t=S.gHS(S.BS.HUD.MAX_OBJECTIVES_DISPLAYED),e=0;e<t;e++)$t.push(function(e){var t=S.gHS(S.BS.HUD.OBJECTIVES_TEXT).position;return t=[t[0],t[1]+e*S.gHS(S.BS.HUD.OBJECTIVES_TEXT_OFFSET)],new r.CanvasText(t,"",S.gHS(S.BS.HUD.OBJECTIVES_TEXT).fontName,S.gHS(S.BS.HUD.OBJECTIVES_TEXT).fontSize,Mi._scaleMode,S.gHS(S.BS.HUD.OBJECTIVES_TEXT).colors.inProgress)}(e)),Kt.addText($t[e]);if(ti||(ti=new r.TextLayer(S.gHS(S.BS.HUD.ESCORTS_BACKGROUND).layout),n.addTextLayer(ti)),ii=ii||s(S.BS.HUD.ESCORTS_HEADER_TEXT,Ii,ti),ii.setText(d.get(d.BATTLE.HUD_ESCORTED_SHIPS_HEADER)),!ni)for(ni=[],t=S.gHS(S.BS.HUD.MAX_ESCORTS_DISPLAYED),e=0;e<t;e++)ni.push(function(e){var t=S.gHS(S.BS.HUD.ESCORTS_TEXT).position;return t=[t[0],t[1]+e*S.gHS(S.BS.HUD.ESCORTS_TEXT_OFFSET)],new r.CanvasText(t,"",S.gHS(S.BS.HUD.ESCORTS_TEXT).fontName,S.gHS(S.BS.HUD.ESCORTS_TEXT).fontSize,Ii._scaleMode,S.gHS(S.BS.HUD.ESCORTS_TEXT).colors.alive)}(e)),ti.addText(ni[e])},BattleScreen.prototype.toggleDevInfoVisibility=function(){jt.isVisible()?(jt.hide(),S.setHUDSetting(S.BS.HUD.SHOW_VERSION_INFO,!1)):this._stats.isVisible()?(this._stats.hide(),S.setHUDSetting(S.BS.HUD.SHOW_FPS_COUNTER,!1)):(this._stats.show(),jt.show(),S.setHUDSetting(S.BS.HUD.SHOW_VERSION_INFO,!0),S.setHUDSetting(S.BS.HUD.SHOW_FPS_COUNTER,!0))},BattleScreen.prototype.showMessage=function(e,t,i){this._infoBox.updateMessage(e,void 0,i),this._infoBox.onButtonClick(function(){p.playButtonClickSound(),t&&t()}),this._infoBox.show(),T.exitPointerLock()},BattleScreen.prototype.setHeaderContent=function(e,t){kt&&kt.setText(e,t)},BattleScreen.prototype.setSubheaderContent=function(e,t){Wt&&Wt.setText(e,t)},BattleScreen.prototype.queueHUDMessage=function(e,t){var i,s,o,r,a,l,c,h,u;for(i=e.text,s=i.indexOf("{");s>=0;s=i.indexOf("{"))if((o=i.indexOf("}"))>=0){switch(l=i.substring(s+1,o).split("/"),l[0]){case"controlStrings":c="[color:"+qi.colors.controlString.join(",")+"]"+T.getInputInterpreter(l[1]).getControlStringForAction(l[2])+"[]";break;case"spacecrafts":u=v.getSpacecraft(l[1]),c="[color:"+(te.isHostile(u)?qi.colors.hostileSpacecraft:qi.colors.friendlySpacecraft).join(",")+"]"+u.getDisplayName()+"[]";break;default:n.showError("Unknown reference type specified in HUD message: '"+l[0]+"'!"),c=""}i=i.substring(0,s)+c+i.substr(o+1)}else n.showError("Unclosed reference in HUD message: '"+e.text+"'!");for(a=0,h=!1,r=0;r<i.length;r++)"["===i[r]?h=!0:"]"===i[r]?h=!1:!1===h&&"\n"!==i[r]&&a++;e.text=i,e.new=!0,e.timeLeft=e.duration||Math.round(70*a+400),e.appearDuration=e.appearAnimation?Math.round(7*a):0,e.appearTimeLeft=e.appearDuration||0,e.queue=e.queue||"info",t?Te[e.queue].unshift(e):Te[e.queue].push(e)},BattleScreen.prototype.clearHUDMessages=function(e){Te[e||"info"]=[]},BattleScreen.prototype.clearHUDMessageQueues=function(){var e;for(e=0;e<_n.length;e++)Te[_n[e]]=[]},BattleScreen.prototype._updateHUD=function(s){var o,r,a,l,c,h,u,p,g,m,f,y,E,C,M,A,x,R,b,L,N,D,P,w,V,F,U,B,H,G,j,k,Y,X,q,z,J,Q,K,Z,$,ee,Se,be,Ne,Pe,Ue,Be,Ge,mt,Pt,Ut,Gt,jt,zt,Zt,ii,zi,Ki,Zi,$i,en,tn,nn,sn,on,rn,an,ln,cn,hn,un,dn,pn,gn,fn,Sn,Tn,yn,En,Cn,Mn,In,An,xn,vn,On,Rn,bn,Ln=v?v.getFollowedSpacecraftForScene(O):null,Nn=this.getScreenCanvas("battleCanvas").getCanvasElement();if(fn=!1,Ln&&je){if(Ve=(Ve+s)%He,Fe=Ve<.5*He,sn=Ln.getView(O._camera.getConfiguration()._name)._isAimingView,kt.show(),T.isInPilotMode()?(Wt.hide(),_hudSectionIsVisible(Qi.SCORE)?(Jt.setText(e.formatString(d.get(d.BATTLE.SCORE),{score:Math.round(Ln.getScore())})),Jt.show()):Jt.hide()):(Wt.setText(Ln.getDisplayName()||Ln.getClass().getDisplayName()),Wt.show(),Jt.hide()),sn?ke.show():ke.hide(),Mn=T.getInputInterpreter(T.MOUSE_NAME),T.isListening()&&Mn.isEnabled()&&T.isInPilotMode()&&!T.isControllerPriority(T.CAMERA_CONTROLLER_NAME)&&!T.isMouseTurningDisabled()&&!Ln.isManeuveringLocked()?(z=Mn._mousePosition,z=[2*(z[0]/Nn.width-.5),2*(.5-z[1]/Nn.height)],Mn.isMouseDisplaced()?(qe.hide(),ze.show(),ze.setPosition(z),Y=t.angle2y(z[0]*Nn.width/Nn.height,z[1]),ze.setAngle(Y*(z[0]<0?-1:1))):(qe.show(),ze.hide(),qe.setPosition(z))):(qe.hide(),ze.hide()),Ge=Ln.getRelativeVelocityMatrix(),_hudSectionIsVisible(Qi.SPEED_BAR)){if(b=Ge[13],L=Math.abs(b),R=Ln.getMaxAcceleration(),!(N=Ln.getMaxSpeed()))for(N=S.gHS(S.BS.HUD.SPEED_BAR_BASE_MAX_SPEED_FACTOR)*R||S.gHS(S.BS.HUD.SPEED_BAR_DEFAULT_BASE_MAX_SPEED),D=S.gHS(S.BS.HUD.SPEED_BAR_MAX_SPEED_STEP_FACTOR),P=S.gHS(S.BS.HUD.SPEED_BAR_MAX_SPEED_STEP_BUFFER);N+P<L;)N*=D;Ln.hasSpeedTarget()&&(V=Ln.getSpeedTarget(),V=b*V>=0?Math.abs(V):0),w=Math.min(L/N,1),Q=S.gHS(S.BS.HUD.SPEED_TEXT).positions.maxForward,K=S.gHS(S.BS.HUD.SPEED_TEXT).positions.maxReverse,en=S.gHS(S.BS.HUD.SPEED_BAR).colors,In=Ln.getFlightMode(),b>=0?(Et.setColor(en[In+"Filled"]),Et.setClipColor(en[In+"Empty"]),Et.clipY(0,w),vt.setPosition(Q),vt.setColor(S.gHS(S.BS.HUD.SPEED_TEXT).colors[In+"Forward"]),vt.setText(Math.max(N,b).toFixed()),Ot.setPosition([Q[0],K[1]+(Q[1]-K[1])*w]),Ot.setColor(S.gHS(S.BS.HUD.SPEED_TEXT).colors[In+"Forward"]),Ot.setText(L.toFixed()),Ct.clipX(.5-gi[0]/2,.5+gi[0]/2),Ln.hasSpeedTarget()?(Ct.clipY(V/N-gi[1]/2,V/N+gi[1]/2),Ct.show()):Ct.hide()):(Et.setColor(en[In+"ReverseFilled"]),Et.setClipColor(en[In+"ReverseEmpty"]),Et.clipY(1-w,1),vt.setPosition(K),vt.setColor(S.gHS(S.BS.HUD.SPEED_TEXT).colors[In+"Reverse"]),vt.setText(Math.min(-N,b).toFixed()),Ot.setPosition([Q[0],Q[1]-(Q[1]-K[1])*w]),Ot.setColor(S.gHS(S.BS.HUD.SPEED_TEXT).colors[In+"Reverse"]),Ot.setText("-"+L.toFixed()),Ct.clipX(.5-gi[0]/2,.5+gi[0]/2),Ln.hasSpeedTarget()?(Ct.clipY(1-(V/N+gi[1]/2),1-(V/N-gi[1]/2)),Ct.show()):Ct.hide()),Et.applyLayout(_i,Nn.width,Nn.height),Et.show(),Ct.applyLayout(_i,Nn.width,Nn.height),xt.show()}else Et.hide(),Ct.hide(),xt.hide();if(sn&&_hudSectionIsVisible(Qi.DRIFT_ARROW)?(J=[Ge[12],Ge[14]],F=t.extractLength2(J),F>ji?(Rt.show(),c=O._camera._aspect,B=S.gHS(S.BS.HUD.DRIFT_ARROW_POSITION_RADIUS)*(e.yScalesWithHeight(ai,Nn.width,Nn.height)?1:c),Rt.setPosition(t.scaled2([J[0]/c,J[1]],B)),Rt.setAngle(Math.acos(J[1])*(J[0]<0?-1:1)),U=ki*R,0===U&&(U=N),Rt.setColor(e.getMixedColor(S.gHS(S.BS.HUD.DRIFT_ARROW).colors.minSpeed,S.gHS(S.BS.HUD.DRIFT_ARROW).colors.maxSpeed,Math.min((F-ji)/(U-ji),1)))):Rt.hide()):Rt.hide(),A=Ln.getHullIntegrity(),x=Ln.getShieldIntegrity(),Ln!==te?(te=Ln,_refreshWingmanStatusPanel(),ne=Ln._mClasses,re=A,ae=x,f=0,y=0,ue=0,de=0):(A<re?(ue=Oi,f=1):ue>0&&(ue-=s,f=ue/Oi),re=A,x<ae?(de=Ri,y=1):de>0&&(de-=s,y=de/Ri),ae=x),en=S.gHS(S.BS.HUD.HULL_INTEGRITY_BAR).colors,_hudSectionIsVisible(Qi.HULL_BAR)?(ue>0?(bt.setColor(e.getMixedColor(en.filled,en.filledWhenDecreasing,f)),bt.setClipColor(e.getMixedColor(en.empty,en.emptyWhenDecreasing,f))):(bt.setColor(en.filled),bt.setClipColor(en.empty)),bt.clipY(0,A),bt.applyLayout(fi,Nn.width,Nn.height),bt.show()):bt.hide(),Ln.hasShield()&&_hudSectionIsVisible(Qi.SHIELD_BAR)?(en=S.gHS(S.BS.HUD.SHIELD_BAR).colors,de>0?(Lt.setColor(e.getMixedColor(en.filled,en.filledWhenDecreasing,y)),Lt.setClipColor(e.getMixedColor(en.empty,en.emptyWhenDecreasing,y))):(Lt.setColor(en.filled),Lt.setClipColor(en.empty)),Lt.clipY(0,x),Lt.applyLayout(Si,Nn.width,Nn.height),Lt.show()):Lt.hide(),_hudSectionIsVisible(Qi.FLIGHT_MODE)){switch(Nt.applyLayout(Ti,Nn.width,Nn.height),Nt.show(),wt.setText(d.get(d.FLIGHT_MODE.PREFIX,Ln.getFlightMode(),Ln.getFlightMode())),en=S.gHS(S.BS.HUD.FLIGHT_MODE_TEXT).colors,Ln.getFlightMode()){case I.FlightMode.FREE:wt.setColor(en.free);break;case I.FlightMode.COMBAT:wt.setColor(en.combat);break;case I.FlightMode.CRUISE:wt.setColor(en.cruise);break;default:n.showError("Unknown flight mode: "+Ln.getFlightMode()+"!")}Dt.show()}else Nt.hide(),Dt.hide();if(X=0,ne.length>0){for(en=S.gHS(S.BS.HUD.MISSILE_INFO_TEXT).colors,a=Ln.getActiveMissileLauncher(),G=0,h=0;h<Bt.length;h++)h<ne.length?(In=ne[h]._shortName,p=Ln.getMissileCount(ne[h]),Ht[h].setText(p.toString()),p<=0?Ut=en.empty:a&&a._class===ne[h]?(Ln.getTarget()&&(X=Ln.getMissileLockRatio()),rn=X>=1,Sn=a.isReady(),Ut=Sn?rn?en.readySelected:en.lockingSelected:en.loadingSelected,a._salvo&&(In+=" (×"+Math.min(a.getSalvo(),a.getMissileCount())+")"),G=p,rn?(Re?Sn&&!Ie&&Me.play():Oe.play(),Re=!0):(w=X*xe,w<=0?ve=0:(w=Math.floor(w)+1,w>ve?(ve++,Ae.play()):w<ve&&(ve=0)),Re=!1),Ie=Sn):Ut=en.notSelected,Bt[h].setText(In),Bt[h].setColor(Ut),Ht[h].setColor(Ut),Bt[h].show(),Ht[h].show()):(Bt[h].hide(),Ht[h].hide());_hudSectionIsVisible(Qi.MISSILE_INFO)?(Vt.applyLayout(yi,Nn.width,Nn.height),Vt.show(),Ft.show()):(Vt.hide(),Ft.hide()),G>0&&_hudSectionIsVisible(Qi.MISSILE_INDICATOR)?(Mt.setTextureCoordinates(S.gHS(S.BS.HUD.MISSILE_INDICATOR).mappings[a._salvo?"salvo":"single"]),en=S.gHS(S.BS.HUD.MISSILE_INDICATOR).colors,w=a.getLoadRatio(),w<1?(Mt.setColor(en.locking),Mt.setClipColor(en.loading),Mt.clipY(0,w)):(Mt.setColor(en.ready),Mt.setClipColor(en.locking),Mt.clipY(0,X)),Mt.applyLayout(mi,Nn.width,Nn.height),Mt.show(),At.setText(G.toString()),en=S.gHS(S.BS.HUD.MISSILE_INDICATOR_TEXT).colors,At.setColor(w>=1?rn?en.ready:en.locking:en.loading),It.show()):(Mt.hide(),It.hide())}else Vt.hide(),Ft.hide(),Mt.hide(),It.hide();if(!W&&T.isInPilotMode()){if(_hudSectionIsVisible(Qi.OBJECTIVES)){for(Qt.applyLayout(Mi,Nn.width,Nn.height),Qt.show(),An=v.getObjectivesState(),en=S.gHS(S.BS.HUD.OBJECTIVES_TEXT).colors,h=0;h<$t.length;h++)if(h<An.length){switch($t[h].setText(An[h].text),An[h].state){case Ji.IN_PROGRESS:$t[h].setColor(en.inProgress);break;case Ji.COMPLETED:$t[h].setColor(en.completed);break;case Ji.FAILED:$t[h].setColor(en.failed)}$t[h].show()}else $t[h].hide();Kt.show()}else Qt.hide(),Kt.hide();if(On=se.filter(_escortShouldBeIndicated),On.length>0&&_hudSectionIsVisible(Qi.ESCORTS)){for(ei.applyLayout(Ii,Nn.width,Nn.height),ei.show(),h=0;h<ni.length;h++)h<On.length?(ni[h].setText(On[h].getDisplayName()||d.get(d.BATTLE.HUD_SPACECRAFT_NAME_UNKNOWN)),pn=On[h]._away,en=S.gHS(S.BS.HUD.ESCORTS_TEXT).colors,ni[h].setColor(On[h]._alive?pn?en.away:en.alive:en.destroyed),si[h].hull.setColor(pn?Wi.colors.awayHull:_getHullIntegrityColor(On[h].getHullIntegrity(),Wi.colors.fullHull,Wi.colors.halfHull,Wi.colors.zeroHull)),si[h].hull.clipX(0,On[h].getHullIntegrity()),si[h].hull.applyLayout(si[h].hullLayout,Nn.width,Nn.height),ni[h].show(),si[h].hull.show(),On[h].hasShield()&&!pn?(si[h].shield.clipX(0,On[h].getShieldIntegrity()),si[h].shield.applyLayout(si[h].shieldLayout,Nn.width,Nn.height),si[h].shield.show()):si[h].shield.hide()):(ni[h].hide(),si[h].hull.hide(),si[h].shield.hide());ti.show()}else for(ei.hide(),ti.hide(),h=0;h<si.length;h++)si[h].hull.hide(),si[h].shield.hide()}else for(Qt.hide(),Kt.hide(),ei.hide(),ti.hide(),h=0;h<si.length;h++)si[h].hull.hide(),si[h].shield.hide();for(h=0;h<_n.length&&0===Te[_n[h]].length;)h++;if(T.isInPilotMode()&&h<_n.length?(bn=Te[_n[h]],bn[0].new&&(bn[0].silent||bn[0].appearTimeLeft||Ee.play(),bn[0].new=!1),qt.setText(bn[0].text),bn[0].appearTimeLeft>0?(qt._revealState=1-bn[0].appearTimeLeft/bn[0].appearDuration,bn[0].appearTimeLeft-=s,bn[0].silent||(Ce.setVolume(S.gHS(S.BS.HUD.MESSAGE_TYPE_SOUND).volume),Ce.play())):(qt._revealState=1,Ce.stopLoop()),Ut=bn[0].color?bn[0].color:qi.colors.default,bn[0].blinkInterval>0&&(Ut=Ut.slice(),Ut[3]=Ut[3]*Math.abs((bn[0].duration-bn[0].timeLeft)%bn[0].blinkInterval/bn[0].blinkInterval-.5)*2),qt.setColor(Ut),ye=bn[0].source,dn=!1,bn[0].permanent||(bn[0]===Le?(bn[0].timeLeft=De,De<=0&&(dn=!0)):bn[0].timeLeft-=s),dn?(Xt.hide(),Yt.hide()):(bn[0].noBackground?Yt.hide():(Yt.applyLayout(Ai,Nn.width,Nn.height),Yt.show()),Xt.show()),bn[0].timeLeft<=0&&(bn.shift(),bn.length>0&&(bn[0].new=!0))):(Xt.hide(),Yt.hide(),Ce.stopPlaying(.01),ye=null),De>0&&(De-=s),o=Ln.getTarget(),le!==o?(le=o,ln=!0,ge=xi,C=1):ge>0?(ge-=s,C=ge/xi):C=0,E=me>0?me/vi:0,Tn=!1,yn=!1,En=!1,Cn=!1,o){if(be=o.getPhysicalPositionVector(),Se=Ln.getPhysicalPositionVector(),Ne=t.diff3(be,Se),l=t.length3(Ne),q=Ln._ws,an=o.isHostile(Ln),q.length>0){for(Pe=Ln.getTargetHitPosition(),!oi&&_hudSectionIsVisible(Qi.AIM_ASSIST_INDICATOR)&&(nt.setPosition(Pe),Ut=an?S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).colors.hostile:S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).colors.friendly,ge>0||me>0?(f=Math.max(C,E),nt.setColor(e.getMixedColor(Ut,S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).colors.appear,f)),nt.setSize(t.scaled2(Hi,1+(Gi-1)*f))):(nt.setColor(Ut),nt.setSize(Hi)),nt.show(),Tn=!0),m=t.length3(t.diff3Aux(Pe,Se)),tn=Ln.pMo.oM,g=Ln.vMo.sM[0],nn=Ln.getScaledOriMatrix(),rn=!1,h=0;h<q.length;h++)We.length<=h&&(We.push(_createWeaponImpactIndicator()),We[h].addToScene(O)),q[h]._fixed?(Ue=q[h]._origoPositionMatrix,mt=t.sum3(Se,t.getRowB43ScaledAux(tn,m)),t.add3(mt,t.scaled3Aux(t.getRowA43Aux(tn),Ue[12]*g)),t.add3(mt,t.getRowC43ScaledAux(tn,Ue[14]*g))):(Be=q[h].getBasePointPosVector(nn),mt=t.sum3(Be,t.getRowB43ScaledAux(q[h].getProjectileOrientationMatrix(),t.length3(t.diff3Aux(Pe,Be))))),oi&&t.sub3(mt,t.diff3Aux(Pe,be)),We[h].setPosition(mt),m<=q[h].getRange(b)?(We[h].setColor(S.gHS(S.BS.HUD.WEAPON_IMPACT_INDICATOR).colors.normal),rn=!0):We[h].setColor(S.gHS(S.BS.HUD.WEAPON_IMPACT_INDICATOR).colors.outOfRange),ge>0?We[h].setSize(t.scaled2(Ui,1+(Bi-1)*C)):We[h].setSize(Ui),We[h].show();if(_hudSectionIsVisible(Qi.WEAPON_IMPACT_INDICATORS)){for(;h<We.length;)We[h].hide(),h++;yn=!0}!rn||Ln.isFighter()&&t.dot3(t.getRowB43Aux(tn),Ne)<0?(Tn=!1,me=vi):me-=s}A=o.getHullIntegrity(),x=o.getShieldIntegrity(),_hudSectionIsVisible(Qi.TARGET_INFO)&&(ct.applyLayout(hi,Nn.width,Nn.height),ct.show(),lt=_getHullIntegrityColor(A,S.gHS(S.BS.HUD.TARGET_VIEW_TARGET_ITEM_FULL_INTEGRITY_COLOR),S.gHS(S.BS.HUD.TARGET_VIEW_TARGET_ITEM_HALF_INTEGRITY_COLOR),S.gHS(S.BS.HUD.TARGET_VIEW_TARGET_ITEM_ZERO_INTEGRITY_COLOR)),ot!==o&&(st.clearNodes(!0),rt=null,ot=o,ot.addToScene(st,_.getMaxLoadedLOD(),!0,mn,at,_tViewAddCallback)),rt&&rt.setOrientationM4(ri?i.prod3x3SubOf4Aux(o.pMo.oM,i.inverseOfRotation4Aux(i.lookTowards4Aux(t.normalize3(t.diffTranslation3Aux(Ln.pMo.pM,o.pMo.pM)),t.getRowC43Aux(Ln.pMo.oM)))):i.IDENTITY4),st.setRelativeViewport(ci.getPositiveLeft(Nn.width,Nn.height),ci.getPositiveBottom(Nn.width,Nn.height),ci.getPositiveWidth(Nn.width,Nn.height),ci.getPositiveHeight(Nn.width,Nn.height)),ht.clipX(0,A),ht.applyLayout(di,Nn.width,Nn.height),ht.show(),o.hasShield()?(ut.clipX(0,x),ut.applyLayout(pi,Nn.width,Nn.height),ut.show()):ut.hide(),Gt=an?S.gHS(S.BS.HUD.TARGET_INFO_TEXT).colors.hostile:S.gHS(S.BS.HUD.TARGET_INFO_TEXT).colors.friendly,pt.name.setColor(Gt),pt.name.setText(o.getDisplayName()||d.get(d.BATTLE.HUD_SPACECRAFT_NAME_UNKNOWN)),pt.team.setColor(Gt),pt.team.setText(o._team?o._team.getDisplayName():d.get(d.BATTLE.HUD_TEAM_UNKNOWN)),pt.class.setColor(Gt),pt.class.setText(o.getClass().getDisplayName()),pt.firepower.setColor(Gt),H=o.getTarget()&&o.getTarget().getClass()._armor,pt.firepower.setText(d.get(d.BATTLE.HUD_FIREPOWER)+": "+(H?o.getFirepower(H).toFixed(1)+" / ":"")+o.getFirepower().toFixed(1)),pt.distance.setColor(Gt),pt.distance.setText(d.get(d.BATTLE.HUD_DISTANCE)+": "+e.getLengthString(l)),pt.velocity.setColor(Gt),pt.velocity.setText(d.get(d.BATTLE.HUD_VELOCITY)+": "+i.translationLength(o.pMo._velocityMatrix).toFixed()+" m/s"),dt.show(),En=!0),sn&&(Ye.clipX(.5-A/2,.5+A/2),Ye.applyLayout(Ei,Nn.width,Nn.height),o.hasShield()?(Xe.clipX(.5-x/2,.5+x/2),Xe.applyLayout(Ci,Nn.width,Nn.height),Xe.show()):Xe.hide(),ln?(ce=A,he=x,pe=0,_e=0,f=0,y=0):(A<ce?(pe=bi,f=1):pe>0&&(pe-=s,f=pe/bi),ce=A,x<he?(_e=Li,y=1):_e>0&&(_e-=s,y=_e/Li),he=x),en=S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR).colors,jt=an?en.hostileFilled:en.friendlyFilled,zt=an?en.hostileEmpty:en.friendlyEmpty,pe>0?Ye.setColor(e.getMixedColor(jt,en.filledWhenDecreasing,f)):Ye.setColor(jt),Ye.setClipColor(zt),Ye.show(),o.hasShield()?(en=S.gHS(S.BS.HUD.TARGET_SHIELD_QUICK_VIEW_BAR).colors,_e>0?Xe.setColor(e.getMixedColor(en.filled,en.filledWhenDecreasing,y)):Xe.setColor(en.filled),Xe.setClipColor(en.empty),Xe.show()):Xe.hide(),Cn=_hudSectionIsVisible(Qi.TARGET_INDICATOR))}if(Tn||nt.hide(),!yn)for(h=0;h<We.length;h++)We[h].hide();if(En||(ct.hide(),ot&&(st.clearNodes(!0),ot=null,rt=null),ht.hide(),ut.hide(),dt.hide()),Cn||(Ye.hide(),
Xe.hide(),et.hide()),ie.length>0&&_hudSectionIsVisible(Qi.WINGMEN_INFO)){for(_t.applyLayout(ui,Nn.width,Nn.height),_t.show(),gt.show(),p=0,hn=!1,h=0;h<ie.length;h++)for(yt.length<=h&&(yt.push(_createWingmenStatusSquadText(h)),gt.addText(yt[h])),yt[h].setText(d.get(d.SQUAD.PREFIX,ie[h].name,ie[h].name)),yt[h].show(),G=Math.min(ie[h].crafts.length,Xi),u=0;u<G;u++)r=ie[h].crafts[u],Tt.length<=p&&(Tt.push(_createWingmanCraftIndicatorLayout(h,G,u)),St.length>p&&St[p].body.setTextureCoordinates(Yi.mappings[r.getTypeName()]||Yi.mappings.general)),St.length<=p&&(St.push({body:_createWingmanCraftIndicator(Tt[p],r.getTypeName()),shield:_createWingmanCraftIndicator(Tt[p],"shield")}),St[p].body.addToScene(O),St[p].shield.addToScene(O)),St[p].body.applyLayout(Tt[p],Nn.width,Nn.height),St[p].shield.applyLayout(Tt[p],Nn.width,Nn.height),St[p].body.setColor(r._alive?r._away?Yi.colors.away:_getHullIntegrityColor(r.getHullIntegrity(),Yi.colors.fullIntegrity,Yi.colors.halfIntegrity,Yi.colors.zeroIntegrity):Yi.colors.destroyed),St[p].body.show(),r._alive&&!r._away&&r.hasShield()?(St[p].shield.setColor(_getHullIntegrityColor(r.getShieldIntegrity(),Yi.colors.fullShieldIntegrity,Yi.colors.halfShieldIntegrity,Yi.colors.zeroShieldIntegrity)),St[p].shield.show()):St[p].shield.hide(),r===Ln&&(ft||(ft=_createWingmanCraftIndicator(Tt[p],"player"),ft.addToScene(O)),ft.applyLayout(Tt[p],Nn.width,Nn.height),ft.setColor(St[p].body._color),ft.show(),hn=!0),p++;for(;h<yt.length;)yt[h].hide(),h++;for(h=p;h<St.length;h++)St[h].body.hide(),St[h].shield.hide();!hn&&ft&&ft.hide()}else{for(_t.hide(),gt.hide(),h=0;h<St.length;h++)St[h].body.hide(),St[h].shield.hide();ft&&ft.hide()}for(On=v.getSpacecrafts().filter(_scShouldBeIndicated),Rn=Ln._tedBy.filter(_scShouldBeIndicated),c=O._camera._aspect,f=Math.abs(2*fe/Ni-1),en=S.gHS(S.BS.HUD.SHIP_INDICATOR).colors,Zt=e.getMixedColor(en.hostile,en.hostileHighlight,f),ii=e.getMixedColor(en.friendly,en.friendlyHighlight,f),en=S.gHS(S.BS.HUD.SHIP_ARROW).colors,zi=e.getMixedColor(en.hostile,en.hostileHighlight,f),Ki=e.getMixedColor(en.friendly,en.friendlyHighlight,f),T.isInPilotMode()&&Le&&De>0?(un=!0,f=2*Math.abs((Le.duration-De)%Le.blinkInterval/Le.blinkInterval-.5),Zi=e.getMixedColor(S.gHS(S.BS.HUD.SHIP_INDICATOR).colors.hostile,S.gHS(S.BS.HUD.SHIP_INDICATOR).colors.newHostile,f),$i=e.getMixedColor(S.gHS(S.BS.HUD.SHIP_ARROW).colors.hostile,S.gHS(S.BS.HUD.SHIP_ARROW).colors.newHostile,f)):un=!1,k=0,h=0;h<On.length;h++){if(Tn=On[h]===o&&_hudSectionIsVisible(Qi.TARGET_INDICATOR)||On[h]!==o&&_hudSectionIsVisible(Qi.SHIP_INDICATORS)&&Ln.isInSensorRange(On[h]),gn=On[h]===ye,Je.length<=h&&(Je.push(_createShipIndicator()),Je[h].addToScene(O)),be=On[h].getPhysicalPositionVector(),vn=Je[h],vn.setPosition(be),an=On[h].isHostile(Ln),M=On[h].vMo.updateVisibleSize({camera:O._camera},!0).width*Pi,$=On[h]===o?Di.targetMinimum:Di.minimum,Z=[Math.min(Math.max($[0],M),Di.maximum[0]),Math.min(Math.max($[1],M),Di.maximum[1])],en=S.gHS(S.BS.HUD.SHIP_INDICATOR).colors,gn&&vn.setColor(en.transmission),On[h]===o?(gn||vn.setColor(an?un&&we.indexOf(On[h])>=0?e.getMixedColor(en.hostileTarget,en.newHostile,f):en.hostileTarget:en.friendlyTarget),ge>0?vn.setSize(t.scaled2(Z,1+(wi-1)*C)):vn.setSize(Z)):(gn||vn.setColor(un&&we.indexOf(On[h])>=0?Zi:Rn.indexOf(On[h])>=0?an?Zt:ii:an?en.hostile:en.friendly),vn.setSize(Z)),Tn?vn.show():vn.hide(),Qe.length<=h&&(Qe.push(_createShipArrow()),Qe[h].addToScene(O)),Pt=i.getRowD4(i.prod34Aux(On[h].pMo.pM,O._camera.getViewMatrix(),O._camera.getProjectionMatrix())),on=Pt[3]<0,t.normalize4D(Pt),vn=Qe[h],on||Pt[0]<-1||Pt[0]>1||Pt[1]<-1||Pt[1]>1)Tn?vn.show():vn.hide(),Pt[0]*=c,t.normalize2(Pt),on&&(Pt[0]*=-1,Pt[1]*=-1),B=S.gHS(S.BS.HUD.SHIP_ARROW_POSITION_RADIUS)*(e.yScalesWithHeight(ai,Nn.width,Nn.height)?1/c:1),vn.setPosition(t.scaled2([Pt[0],Pt[1]*c],B)),vn.setAngle(Math.acos(Pt[1])*(Pt[0]<0?-1:1)),en=S.gHS(S.BS.HUD.SHIP_ARROW).colors,gn&&vn.setColor(en.transmission),On[h]===o?(gn||vn.setColor(an?un&&we.indexOf(On[h])>=0?e.getMixedColor(en.hostileTarget,en.newHostile,f):en.hostileTarget:en.friendlyTarget),ge>0?vn.setSize(t.scaled2(Vi.target,1+(Fi-1)*C)):vn.setSize(Vi.target),et.hide()):(gn||vn.setColor(un&&we.indexOf(On[h])>=0?$i:Rn.indexOf(On[h])>=0?an?zi:Ki:an?en.hostile:en.friendly),vn.setSize(Vi.default));else if(vn.hide(),On[h]===o&&Tn&&(tt.setText(_getDistanceString(l)),tt.setColor(an?S.gHS(S.BS.HUD.DISTANCE_TEXT).colors.hostile:S.gHS(S.BS.HUD.DISTANCE_TEXT).colors.friendly),j=.5*Z[1]*(e.scalesWithWidth(Je[h]._scaleMode,c,1)?c:1),z=[Pt[0],Pt[1]-j],cn=e.scalesWithWidth(tt._boxLayout._scaleMode,c,1),ee=[li.width/(cn?1:c),li.height*(cn?c:1)],tt._boxLayout.setPosition(z[0]+.5*ee[0],z[1]-.5*ee[1]),tt.invalidateLayout(),tt.setPosition([z[0]+.05*ee[0],z[1]-.95*ee[1]]),et.show(),S.gHS(S.BS.HUD.ALWAYS_SHOW_TARGET_HULL_BAR_AT_CENTER)||(z[1]=Pt[1]+j,Ye.setPosition([(.5+.5*z[0])*Nn.width,(.5-.5*(z[1]+1.5*Ei.getClipSpaceHeight()))*Nn.height]),Xe.setPosition([(.5+.5*z[0])*Nn.width,(.5-.5*(z[1]+1.75*Ei.getClipSpaceHeight()+Ci.getClipSpaceHeight()))*Nn.height])),X>0)){for(B=.5*Z[1]*S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR_RADIUS)*(e.yScalesWithHeight(Je[h]._scaleMode,Nn.width,Nn.height)?1/c:1),X<1?(Ze+=s*S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR_ROTATION_SPEED),$e=0):(Ze=Math.radians(S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR_ANGLE)),$e=($e+s/S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR_BLINK_INTERVAL))%1),Y=Ze,en=S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR).colors,Ut=an?en.hostileTarget:en.friendlyTarget,ee=t.scaled2(Z,S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR_SIZE)),u=0;u<Ke.length;u++)vn=Ke[u],X<1||$e>.25&&$e<.75?(vn.setPosition([Pt[0]+Math.cos(Y)*B,Pt[1]+Math.sin(Y)*c*B]),vn.setSize(ee),vn.setAngle(-.5*Math.PI-Y),vn.setColor(Ut),vn.show(),Y+=2*Math.PI/S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR_COUNT)):vn.hide();fn=!0}for(u=0;u<On.length&&(!On[u].isHostile(Ln)||oe.indexOf(On[u])>=0);)u++;if(xn=[],gn&&xn.push("transmission"),se.indexOf(On[h])>=0&&xn.push("protect"),u<On.length&&oe.indexOf(On[h])>=0&&xn.push("destroy"),xn.length>0&&Tn)if(Qe[h].isVisible())it.length<=k&&(it.push(_createShipStatusIndicator(xn[0])),it[k].addToScene(O)),vn=it[k],k++,vn.setColor(S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).colors[xn[0]]||Qe[h]._color),vn.setScaleMode(Qe[h]._scaleMode),vn.setSize(S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).sizes.arrow),vn.setPosition(t.scaled2([Pt[0],Pt[1]*c],(S.gHS(S.BS.HUD.SHIP_ARROW_POSITION_RADIUS)+1.5*Qe[h]._scale[0])*(e.yScalesWithHeight(ai,Nn.width,Nn.height)?1/c:1))),vn.setTextureCoordinates(S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).mappings[xn[0]]),vn.show();else for(cn=e.scalesWithWidth(Je[h]._scaleMode,c,1),j=.5*Z[1]*(cn?c:1),z=[Pt[0],Pt[1]-j],ee=S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).sizes.reticle,ee=[.5*ee[0]/(cn?1:c),.5*ee[1]*(cn?c:1)],u=0;u<xn.length;u++)it.length<=k&&(it.push(_createShipStatusIndicator(xn[u])),it[k].addToScene(O)),vn=it[k],k++,vn.setColor(S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).colors[xn[u]]||Je[h]._color),vn.setScaleMode(Je[h]._scaleMode),vn.setSize(S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).sizes.reticle),vn.setPosition([z[0]-ee[0]*(1.2+2.1*(xn.length-1-u)),z[1]-1.2*ee[1]]),vn.setTextureCoordinates(S.gHS(S.BS.HUD.SHIP_STATUS_INDICATOR).mappings[xn[u]]),vn.show()}for(;h<Je.length;)Je[h].hide(),Qe[h].hide(),h++;for(;k<it.length;)it[k].hide(),k++;O.showUI()}else je?kt.show():kt.hide(),Wt.hide(),Jt.hide(),O.hideUI(),st.clearNodes(!0),ot=null,rt=null,dt.hide(),xt.hide(),Dt.hide(),Ft.hide(),It.hide(),Kt.hide(),ti.hide(),Xt.hide(),Ce.stopPlaying(.01),et.hide(),gt.hide();if(fe=(fe+s)%Ni,!fn)for(Ze=Math.radians(S.gHS(S.BS.HUD.MISSILE_LOCK_INDICATOR_ANGLE)),$e=0,h=0;h<Ke.length;h++)Ke[h].hide()},BattleScreen.prototype._render=function(t){var i,n,o,a;if(-2===Sn&&_simulationLoopFunction(),O&&(O._camera.update(Sn!==sn?t:0),this._updateHUD(t)),r.HTMLScreenWithCanvases.prototype._render.call(this,t),O&&this._stats.isVisible()&&this._stats.setTextContent(this.getFPSStats()),Sn!==sn)if(W)v&&K!==v._state&&(K=v._state)===C.MissionState.ENDED&&g.playMusic("ambient");else{if((n=v._pilotedCraft)&&n._alive&&n._away)return void(ee>1500?_goToDebriefing():ee+=t);v&&K!==v._state?(K=v._state,Z=0):Z<2e3&&(Z+=t)>=2e3&&(i=v._state===C.MissionState.COMPLETED,o=Math.round(J/1e3),(H&&!E.getMissionDescriptor(v._name)._custom||v.getId())&&(a={difficulty:k,time:o},F&&(F.win?a.prevwin=!0:a.prevlose=!0,a.prevdifficulty=F.difficulty,a.prevtime=F.time),v.getId()?M.sendEvent(i?"win":"lose",[v.getId()],a):u.sendEvent(i?"win":"lose",[e.getFilenameWithoutExtension(H)],a),F={win:i,difficulty:k,time:o}),n&&n._alive?this.queueHUDMessage({text:d.get(i?d.BATTLE.MESSAGE_VICTORY:d.BATTLE.MESSAGE_FAIL),queue:"mission",permanent:!0},!0):Y?O._camera.followNextNode()||T.switchToSpectatorMode(!0,!0):(this.pauseBattle(!1,!1,!0),p.openDialog({header:d.get(d.BATTLE.MESSAGE_DEFEAT_HEADER),message:d.get(d.BATTLE.MESSAGE_DEFEAT_MESSAGE),buttons:[{caption:d.get(d.BATTLE.MESSAGE_DEFEAT_DEBRIEFING),action:_goToDebriefing},{caption:d.get(d.BATTLE.MESSAGE_DEFEAT_RESTART),action:function(){s.closeSuperimposedScreen(),this.startNewBattle({restart:!0})}.bind(this)},{caption:d.get(d.BATTLE.MESSAGE_DEFEAT_SPECTATE),action:function(){s.closeSuperimposedScreen(),this.resumeBattle()}.bind(this)}],onClose:function(){this.resumeBattle()}.bind(this)})),g.playMusic(i?"victory":"defeat",i?"ambient":null,.2)),Y&&m.isHost()&&v&&v.noHostilesPresent()&&($+=t)>=2e3&&(s.setScreen(p.MULTI_SCORE_SCREEN_NAME),m.concludeMatch())}},BattleScreen.prototype._startBattle=function(t){var i,o,r,l,c,f,L,D,P,w,V;for(w=this.getScreenCanvas("battleCanvas").getCanvasElement(),v=t,oe=v.getTargetSpacecrafts(),se=v.getEscortedSpacecrafts(),H?(i=E.getMissionDescriptor(v._name),o=i._custom,W||(v._pilotedCraft&&v._state!==C.MissionState.NONE||i.increasePlaythroughCount(!0),o?u.sendEvent("customstart"):(F=null,u.sendEvent("start",[e.getFilenameWithoutExtension(H)],{difficulty:k})))):(o=!0,t.getId()&&(F=null,M.sendEvent("start",[t.getId()]))),K=v._state,Z=2e3,$=0,ee=0,this._updateLoadingStatus(d.get(d.BATTLE.LOADING_BOX_BUILDING_SCENE),10),Y&&(I.setFriendlyFire(m.getGameSettings().friendlyFire),x.resetRandomSeeds()),V=_.isShadowMappingEnabled(),v.hasShadows()?_.setShadowMapping():_.setShadowMapping(!1,!1),V!==_.isShadowMappingEnabled()&&_.handleSettingsChanged(),_.shouldUseShadowMapping()&&_.getShadowMappingShader(),O=new h.Scene(0,0,1,1,!0,[!0,!0,!0,!0],[0,0,0,1],!0,_.getLODContext(),_.getMaxDirLights(),_.getMaxPointLights(),_.getMaxSpotLights(),{useVerticalValues:!0,viewDistance:5e3,fov:40,span:.2,transitionDuration:1e3,transitionStyle:"smooth"}),O.setShouldUpdateCamera(!1),st=new h.Scene(ci.getPositiveLeft(w.width,w.height),ci.getPositiveBottom(w.width,w.height),ci.getPositiveWidth(w.width,w.height),ci.getPositiveHeight(w.width,w.height),!1,[!0,!0,!0,!0],[0,0,0,0],!0,_.getLODContext(),0,0,0,{useVerticalValues:!0,viewDistance:S.gHS(S.BS.HUD.TARGET_VIEW_VIEW_DISTANCE),fov:S.gHS(S.BS.HUD.TARGET_VIEW_FOV),span:.2,transitionDuration:1e3,transitionStyle:"smooth"},!1),st._camera.moveToPosition([0,0,S.gHS(S.BS.HUD.TARGET_VIEW_CAMERA_DISTANCE)],0),v.addToScene(O,st),_addHUDToScene(),zi=new Array(Object.keys(Qi).length),P=0;P<zi.length;P++)zi[P]=Ki.VISIBLE;Ve=0,fe=0,this._addUITexts(),Te=Te||{},this.clearHUDMessageQueues(),v.onTeamsChanged(_refreshWingmanStatusPanel),g.initMusic("ambient","ambient",!0),r=S.getSetting(S.BS.ANTICIPATION_MUSIC),l=v.getAnticipationTheme(),l?c=r.indexOf(r):(c=Math.min(Math.floor(Math.random()*r.length),r.length-1),l=r[c]),q=c>=0?"anticipation"+c:l,f=S.getSetting(S.BS.COMBAT_MUSIC),L=v.getCombatTheme(),L?D=f.indexOf(L):(D=Math.min(Math.floor(Math.random()*f.length),f.length-1),L=f[D]),z=D>=0?"combat"+D:L,g.initMusic(l,q,!0),g.initMusic(L,z,!0),g.initMusic("victory","victory",!1),g.initMusic("defeat","defeat",!1),g.initMusic("debriefing_victory",p.DEBRIEFING_VICTORY_THEME,!0),g.initMusic("debriefing_defeat",p.DEBRIEFING_DEFEAT_THEME,!0),T.getController(T.GENERAL_CONTROLLER_NAME).setMission(v),T.getController(T.GENERAL_CONTROLLER_NAME).setBattle(yn),T.getController(T.CAMERA_CONTROLLER_NAME)._controlledCamera=O._camera,this._updateLoadingStatus(d.get(d.LOADING.RESOURCES_START),20),a.executeOnResourceLoad(this._updateLoadingBoxForResourceLoad.bind(this)),a.executeWhenReady(function(){O.setShadowMapping(v.hasShadows()?_.getShadowMappingSettings():null),this._updateLoadingStatus(d.get(d.LOADING.INIT_WEBGL),80),e.executeAsync(function(){if(this.setAntialiasing(_.getAntialiasing()),this.setFiltering(_.getFiltering()),this.clearSceneCanvasBindings(),this.bindSceneToCanvas(O,this.getScreenCanvas("battleCanvas")),this.bindSceneToCanvas(st,this.getScreenCanvas("battleCanvas")),st.clearNodes(!0),this._updateLoadingStatus(d.get(d.LOADING.READY),100),n.log("Game data loaded in "+((performance.now()-j)/1e3).toFixed(3)+" seconds!",1),jt.setText(d.get(d.BATTLE.DEVELOPMENT_VERSION_NOTICE),{version:n.getVersion()}),S.gHS(S.BS.HUD.SHOW_VERSION_INFO)||jt.hide(),document.body.classList.remove("wait"),T.switchToSpectatorMode(!1,!0),this.setHeaderContent(o?v.getTitle()||H&&e.getFilenameWithoutExtension(H)||v._name:d.get(d.MISSION.PREFIX,e.getFilenameWithoutExtension(H)+d.MISSION.NAME_SUFFIX.name)),N=document.body.style.cursor,!Y&&S.getBattleSetting(S.BS.SHOW_READY_MESSAGE)&&(e.areTouchEventsSupported()?this._touchControlSheet.show():this.showMessage(e.formatString(d.get(d.BATTLE.MESSAGE_READY),{menuKey:_getMenuKeyHTMLString()}),void 0,!0)),v.applyToSpacecrafts(function(e){e.addEventHandler(y.FIRED,_handleSpacecraftFired.bind(e)),e===v._pilotedCraft?(e.addEventHandler(y.JUMP_ENGAGED,_handlePilotedSpacecraftJumpEngaged.bind(e)),e.addEventHandler(y.JUMP_CANCELLED,_handlePilotedSpacecraftJumpCancelled.bind(e)),e.addEventHandler(y.PREPARING_JUMP,_handlePilotedSpacecraftPreparingJump.bind(e)),e.addEventHandler(y.HUD,_handleHUDEvent.bind(e))):(e.addEventHandler(y.JUMP_OUT_STARTED,_handleSpacecraftJumpOutStarted.bind(e)),e.addEventHandler(y.ARRIVED,_handleSpacecraftArrived.bind(e)))}),Me=a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_LOADED_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,S.gHS(S.BS.HUD.MISSILE_LOADED_SOUND).volume),ve=0,Ae=a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_LOCKING_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,S.gHS(S.BS.HUD.MISSILE_LOCKING_SOUND).volume),Oe=a.getSoundEffect(S.gHS(S.BS.HUD.MISSILE_LOCKED_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,S.gHS(S.BS.HUD.MISSILE_LOCKED_SOUND).volume),Ee=a.getSoundEffect(S.gHS(S.BS.HUD.MESSAGE_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,S.gHS(S.BS.HUD.MESSAGE_SOUND).volume),Ce=a.getSoundEffect(S.gHS(S.BS.HUD.MESSAGE_TYPE_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,S.gHS(S.BS.HUD.MESSAGE_TYPE_SOUND).volume,!0),Ne=a.getSoundEffect(S.gHS(S.BS.HUD.NEW_HOSTILES_ALERT_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,S.gHS(S.BS.HUD.NEW_HOSTILES_ALERT_SOUND).volume),Pe=a.getSoundEffect(S.gHS(S.BS.HUD.CONNECTION_WARNING_SOUND).name).createSoundClip(a.SoundCategory.SOUND_EFFECT,S.gHS(S.BS.HUD.CONNECTION_WARNING_SOUND).volume),Y?(this._updateLoadingStatus(d.get(d.MULTI_BATTLE.WAITING_FOR_OTHER_PLAYERS)),m.onGameStart(function(){var e,t;if(this._loadingBox.hide(),this.resumeBattle(!0),resumeTime(),R=0,m.isHost())for(b=[],t=m.getPlayers(),e=0;e<t.length;e++)b.push(0);T.switchToPilotMode(v._pilotedCraft,!0),m.onGameUpdate(m.isHost()?function(e){v.getSpacecrafts()[e[0]].applyMultiGuestData(e),b[e[0]]=0}:function(e){var t,i=v.getSpacecrafts();for(t=0;t<i.length;t++)i[t].applyMultiHostData(e,t*A.MULTI_HOST_DATA_LENGTH);R=0})}.bind(this)),m.onDisconnect(function(){Y=!1,s.getScreen()===U&&(s.getScreen(p.MULTI_SCORE_SCREEN_NAME).updateData(),this.showMessage(d.get(d.MULTI_GAMES.DISCONNECT_MESSAGE),function(){s.setScreen(p.MULTI_SCORE_SCREEN_NAME)}))}.bind(this)),m.onHostLeft(function(){Y=!1,s.getScreen(p.MULTI_SCORE_SCREEN_NAME).updateData(),this.showMessage(e.formatString(d.get(d.MULTI_BATTLE.HOST_LEFT_MESSAGE),{host:m.getHostName()}),function(){s.setScreen(p.MULTI_SCORE_SCREEN_NAME)})}.bind(this)),m.onPlayerLeave(function(i){var n;U.queueHUDMessage({text:e.formatString(d.get(d.MULTI_BATTLE.PLAYER_LEFT_MESSAGE),{player:i.name})}),m.isHost()&&(n=t.getSpacecraft(i.name))&&n._alive&&n.setHullIntegrity(0),m.getActivePlayers().length<=1&&(Y=!1,this.showMessage(d.get(d.MULTI_BATTLE.ALL_PLAYERS_LEFT_MESSAGE),function(){s.setScreen(p.MULTI_SCORE_SCREEN_NAME),m.leaveGame()}))}.bind(this)),m.onMatchConcluded(function(){s.setScreen(p.MULTI_SCORE_SCREEN_NAME)}),m.onGuestTimeout(function(){Y=!1,s.getScreen(p.MULTI_SCORE_SCREEN_NAME).updateData(),U.showMessage(d.get(d.MULTI_BATTLE.CONNECTION_TIMEOUT),function(){s.setScreen(p.MULTI_SCORE_SCREEN_NAME)})}),m.markLoaded()):this._loadingBox.hide(),showHUD(),this.startRenderLoop(1e3/60),J=0,Ue=0,Re=!1,g.playMusic(v.noHostilesPresent()?"ambient":q),v.prepareScene(O)){for(O.setShouldAnimate(!0),P=0;P<20;P++)this._render(100);O.setShouldAnimate(!1)}Y||S.getBattleSetting(S.BS.SHOW_READY_MESSAGE)||this._doStartBattle()}.bind(this))}.bind(this)),a.requestResourceLoad()},BattleScreen.prototype.startNewBattle=function(e){var t;j=performance.now(),t=this.getScreenCanvas("battleCanvas").getCanvasElement(),e=e||{},e.restart&&this.pauseBattle(),void 0!==e.missionData?(H=null,G=e.missionData):void 0!==e.missionSourceFilename&&(H=e.missionSourceFilename),void 0!==e.difficulty&&(k=e.difficulty),void 0!==e.demoMode&&(W=e.demoMode),Y=e.multi,A.setMultiGuest(Y&&!m.isHost()),_clearData(),_chooseTipText(),document.body.classList.add("wait"),this._loadingBox.show(),this.resizeCanvases(),T.setScreenCenter(t.width/2,t.height/2),this._updateLoadingStatus(d.get(d.BATTLE.LOADING_BOX_LOADING_MISSION),0),H?E.requestMission(H,k,W,this._startBattle.bind(this)):this._startBattle(E.createMission(G,k,W))},BattleScreen.prototype.requestPointerLock=function(e){var t;T.isPointerLockEnabled()&&document.pointerLockElement!==this.getScreenCanvas("battleCanvas").getCanvasElement()&&(-1!==Tn&&(clearInterval(Tn),Tn=-1),(t=this.getScreenCanvas("battleCanvas").getCanvasElement().requestPointerLock())instanceof Promise&&t.catch(function(){e&&(Tn=setTimeout(function(){Tn=-1,s.getScreen()===this&&T.getInputInterpreter(T.MOUSE_NAME).isEnabled()&&this.requestPointerLock(!1)}.bind(this),1e3))}.bind(this)))},T.isPointerLockSupported()&&document.addEventListener("pointerlockchange",function(){-1!==Tn&&(clearInterval(Tn),Tn=-1)}),S.executeWhenReady(function(){ai=S.gHS(S.BS.HUD.CENTER_CROSSHAIR).scaleMode,gi=S.gHS(S.BS.HUD.SPEED_TARGET_INDICATOR).size,li=S.gHS(S.BS.HUD.DISTANCE_TEXT).layout,ci=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.TARGET_VIEW_LAYOUT)),hi=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.TARGET_INFO_BACKGROUND).layout),ui=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.WINGMEN_STATUS_BACKGROUND).layout),di=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_BAR).layout),pi=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.TARGET_SHIELD_BAR).layout),_i=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.SPEED_BAR).layout),mi=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.MISSILE_INDICATOR).layout),fi=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.HULL_INTEGRITY_BAR).layout),Si=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.SHIELD_BAR).layout),Ti=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.FLIGHT_MODE_INDICATOR_BACKGROUND).layout),yi=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.MISSILE_INFO_BACKGROUND).layout),Mi=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.OBJECTIVES_BACKGROUND).layout),Ii=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.ESCORTS_BACKGROUND).layout),Ai=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.MESSAGE_BACKGROUND).layout),xi=S.gHS(S.BS.HUD.TARGET_SWITCH_ANIMATION_DURATION),vi=S.gHS(S.BS.HUD.AIM_ASSIST_APPEAR_ANIMATION_DURATION),Oi=S.gHS(S.BS.HUD.HULL_INTEGRITY_DECREASE_ANIMATION_DURATION),Ri=S.gHS(S.BS.HUD.SHIELD_DECREASE_ANIMATION_DURATION),bi=S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_DECREASE_ANIMATION_DURATION),Li=S.gHS(S.BS.HUD.TARGET_SHIELD_DECREASE_ANIMATION_DURATION),Ni=S.gHS(S.BS.HUD.SHIP_INDICATOR_HIGHLIGHT_ANIMATION_INTERVAL),Di=S.gHS(S.BS.HUD.SHIP_INDICATOR).sizes,Pi=S.gHS(S.BS.HUD.SHIP_INDICATOR_SIZE_FACTOR),wi=S.gHS(S.BS.HUD.TARGET_INDICATOR_SWITCH_SCALE),Hi=S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR).size,Gi=S.gHS(S.BS.HUD.AIM_ASSIST_INDICATOR_APPEAR_SCALE),Vi=S.gHS(S.BS.HUD.SHIP_ARROW).sizes,Fi=S.gHS(S.BS.HUD.TARGET_ARROW_SWITCH_SCALE),Ui=S.gHS(S.BS.HUD.WEAPON_IMPACT_INDICATOR).size,Bi=S.gHS(S.BS.HUD.WEAPON_IMPACT_INDICATOR_SWITCH_SCALE),ji=S.gHS(S.BS.HUD.DRIFT_ARROW_MIN_SPEED),ki=S.gHS(S.BS.HUD.DRIFT_ARROW_MAX_SPEED_FACTOR),Ei=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.TARGET_HULL_INTEGRITY_QUICK_VIEW_BAR).layout),Ci=new r.ClipSpaceLayout(S.gHS(S.BS.HUD.TARGET_SHIELD_QUICK_VIEW_BAR).layout),Wi=S.gHS(S.BS.HUD.ESCORTS_INTEGRITY_BARS),Yi=S.gHS(S.BS.HUD.WINGMEN_STATUS_CRAFT_INDICATOR),Xi=S.gHS(S.BS.HUD.WINGMEN_STATUS_CRAFT_POSITIONS).length,qi=S.gHS(S.BS.HUD.MESSAGE_TEXT),xe=S.gHS(S.BS.HUD.MISSILE_LOCKING_SOUND_COUNT),at={shaderName:S.gHS(S.BS.HUD.TARGET_VIEW_TARGET_ITEM_SHADER),positionMatrix:i.IDENTITY4,orientationMatrix:Cn,skipResources:!0},He=S.gHS(S.BS.HUD.HIGHLIGHT_INTERVAL),Be=1e4,Ge=1e4}),_.executeWhenReady(function(){}),_.onSettingsChange(handleGraphicsSettingsChanged),yn.getBattleScreen=function(){return U||(U=new BattleScreen,yn.pauseBattle=U.pauseBattle.bind(U),yn.resumeBattle=U.resumeBattle.bind(U)),U},yn.stopTime=stopTime,yn.resumeTime=resumeTime,yn.toggleTime=toggleTime,yn.showHUD=showHUD,yn.hideHUD=hideHUD,yn.toggleHUDVisibility=toggleHUDVisibility,yn.HUDSection=Qi,yn.HUDSectionState=Ki,yn}),define("editor/descriptors",["utils/utils","modules/managed-gl","modules/egom-model","modules/scene/camera","modules/media-resources","armada/configuration","armada/graphics","armada/strings","armada/logic/classes","armada/logic/environments","armada/logic/missions","armada/logic/missions/conditions","armada/logic/missions/actions","armada/logic/missions/events","armada/logic/equipment","armada/logic/formations","armada/logic/spacecraft","armada/logic/ai","armada/screens/battle","editor/common"],function(e,t,i,n,s,o,r,a,l,c,h,u,d,p,_,g,m,f,S,T){"use strict";function Type(e){this._descriptor="string"==typeof e?{baseType:e}:e,this._descriptor.baseType||(this._descriptor={baseType:I.OBJECT,properties:this._descriptor})}function getPropertyValues(t,i,n,s){var o=new Type(t.type).getValues(!1,i,n,s);return i&&t.name===N&&(o=o.slice(),e.removeFromArray(o,i[L])),o}var y=u.ConditionType,E=d.ActionType,C=p.TriggerWhen,M=p.TriggerWhich,I={BOOLEAN:"boolean",NUMBER:"number",STRING:"string",ARRAY:"array",OBJECT:"object",ENUM:"enum",ASSOCIATIVE_ARRAY:"associativeArray",COLOR3:"color3",COLOR4:"color4",VECTOR3:"vector3",RANGE:"range",PAIRS:"pairs",ROTATIONS:"rotations",SET:"set",CONFINES:"confines"},A={TIMES:"×",METERS:"m",METERS_PER_SECOND:"m/s",METERS_PER_SECOND_SQUARED:"m/s²",SECONDS:"s",MILLISECONDS:"ms",PER_SECOND:"/s",DEGREES:"°",DEGREES_PER_SECOND:"°/s",DEGREES_PER_SECOND_SQUARED:"°/s²",KILOGRAMS:"kg",PERCENT:"%"},x={X:"X",Y:"Y",Z:"Z"},v=_.ThrusterUse,O=function(e,t,i,n){return{baseType:I.ARRAY,elementType:e,fixedLength:t&&t.fixed,minLength:t&&t.min,maxLength:t&&t.max,getPreviewText:i||(n?function(e){if(e.length>0&&e.length<=n)return"["+e.join(", ")+"]"}:void 0)}},R=function(e){return{baseType:I.ASSOCIATIVE_ARRAY,elementType:e}},b=function(e,t,i){return{baseType:I.RANGE,minRequired:e,maxRequired:t,elementType:i}},L="name",N="basedOn",D=O(I.STRING),P=R(I.STRING),w={baseType:I.STRING,long:!0},V={baseType:I.NUMBER,unit:A.TIMES},F={baseType:I.NUMBER,unit:A.TIMES,min:0},U={baseType:I.NUMBER,unit:A.TIMES,min:1},B={baseType:I.NUMBER,unit:A.TIMES,min:.001},H={baseType:I.NUMBER,unit:A.METERS,min:0},G={baseType:I.NUMBER,unit:A.METERS,min:1},j={baseType:I.NUMBER,unit:A.METERS,min:.001},k={baseType:I.NUMBER,unit:A.METERS_PER_SECOND},W={baseType:I.NUMBER,unit:A.METERS_PER_SECOND,min:0},Y={baseType:I.NUMBER,unit:A.METERS_PER_SECOND,min:.001},X={baseType:I.NUMBER,unit:A.METERS_PER_SECOND_SQUARED},q={baseType:I.NUMBER,unit:A.METERS_PER_SECOND_SQUARED,min:.001},z={baseType:I.NUMBER,unit:A.MILLISECONDS,integer:!0},J={baseType:I.NUMBER,unit:A.MILLISECONDS,integer:!0,min:0},Q={baseType:I.NUMBER,unit:A.MILLISECONDS,integer:!0,min:1},K={baseType:I.NUMBER,unit:A.MILLISECONDS,integer:!0,min:10},Z={baseType:I.NUMBER,unit:A.PER_SECOND,min:.001},$={baseType:I.NUMBER,unit:A.DEGREES,min:-360,max:360},ee={baseType:I.NUMBER,unit:A.DEGREES,min:0,max:360},te={baseType:I.NUMBER,unit:A.DEGREES,min:0,max:180},ie={baseType:I.NUMBER,unit:A.DEGREES,min:.1,max:180},ne={baseType:I.NUMBER,unit:A.DEGREES,min:-90,max:90},se={baseType:I.NUMBER,unit:A.DEGREES_PER_SECOND,min:.001},oe={baseType:I.NUMBER,unit:A.DEGREES_PER_SECOND_SQUARED,min:.001},re={baseType:I.NUMBER,unit:A.KILOGRAMS,min:.001},ae={baseType:I.NUMBER,unit:A.PERCENT,integer:!0,min:1,max:100},le={baseType:I.NUMBER,unit:A.PERCENT,integer:!0,min:0,max:100},ce={baseType:I.NUMBER,integer:!0,min:0},he={baseType:I.NUMBER,integer:!0,min:1},ue={baseType:I.NUMBER,min:0,max:1},de={baseType:I.NUMBER,min:.001,max:1},pe={baseType:I.NUMBER,min:0},_e={baseType:I.NUMBER,min:.001},ge={baseType:I.NUMBER,integer:!0,min:0,max:1},me={baseType:I.NUMBER,integer:!0,min:0,max:19},fe=O(J,{min:1}),Se={baseType:I.ENUM,resourceReference:"models"},Te={baseType:I.ENUM,resourceReference:"shaders"},ye={baseType:I.ENUM,resourceReference:"textures"},Ee={baseType:I.ENUM,resourceReference:"cubemaps"},Ce={baseType:I.ENUM,resourceReference:"soundEffects"},Me={baseType:I.ENUM,resourceReference:"music"},Ie={baseType:I.ENUM,classReference:"skyboxClasses"},Ae={baseType:I.ENUM,classReference:"backgroundObjectClasses"},xe={baseType:I.ENUM,classReference:"dustCloudClasses"},ve={baseType:I.ENUM,classReference:"spacecraftTypes"},Oe={baseType:I.ENUM,classReference:"spacecraftClasses"},Re={baseType:I.ENUM,classReference:"explosionClasses"},be={baseType:I.ENUM,classReference:"projectileClasses"},Le={baseType:I.ENUM,classReference:"missileClasses"},Ne={baseType:I.ENUM,classReference:"weaponClasses"},De={baseType:I.ENUM,classReference:"propulsionClasses"},Pe={baseType:I.ENUM,classReference:"sensorsClasses"},we={baseType:I.ENUM,classReference:"jumpEngineClasses"},Ve={baseType:I.ENUM,classReference:"shieldClasses"},Fe={baseType:I.ENUM,environmentReference:"environments"},Ue={baseType:I.ENUM,missionReference:"missions"},Be={baseType:I.PAIRS,first:{name:"group",type:me},second:{name:"luminosity",type:ue}},He={baseType:I.ENUM,values:x},Ge={baseType:I.ENUM,values:{PNG:"png",JPG:"jpg",JPEG:"jpeg",WEBP:"webp"}},je={NAME:{name:"name",type:I.STRING},BASEPATH:{name:"basepath",type:I.STRING},FORMAT:{name:"format",type:Ge},USE_MIPMAP:{name:"useMipmap",type:I.BOOLEAN},TYPE_SUFFIXES:{name:"typeSuffixes",type:P},QUALITY_SUFFIXES:{name:"qualitySuffixes",type:P}},ke={baseType:I.OBJECT,name:"CubemapImageNames",properties:{POS_X:{name:"posX",type:I.STRING},NEG_X:{name:"negX",type:I.STRING},POS_Y:{name:"posY",type:I.STRING},NEG_Y:{name:"negY",type:I.STRING},POS_Z:{name:"posZ",type:I.STRING},NEG_Z:{name:"negZ",type:I.STRING}}},We={NAME:{name:"name",type:I.STRING},BASEPATH:{name:"basepath",type:I.STRING},FORMAT:{name:"format",type:Ge},IMAGE_NAMES:{name:"imageNames",type:ke},QUALITY_SUFFIXES:{name:"qualitySuffixes",type:P}},Ye={baseType:I.ASSOCIATIVE_ARRAY,validKeys:[r.SHADER_VARIANT_WITHOUT_SHADOWS_NAME,r.SHADER_VARIANT_WITHOUT_DYNAMIC_LIGHTS_NAME,l.SHADER_VARIANT_INSTANCED_NAME],elementType:Te},Xe={baseType:I.ENUM,values:t.ShaderBlendMode},qe={baseType:I.ENUM,name:"VertexAttributeRole",values:i.VertexAttributeRole},ze={NAME:{name:"name",type:I.STRING},VARIANTS:{name:"variants",type:Ye,optional:!0},VERTEX_SHADER_SOURCE:{name:"vertexShaderSource",type:I.STRING},FRAGMENT_SHADER_SOURCE:{name:"fragmentShaderSource",type:I.STRING},BLEND_MODE:{name:"blendMode",type:Xe},VERTEX_ATTRIBUTE_ROLES:{name:"vertexAttributeRoles",type:R(qe)},INSTANCE_ATTRIBUTE_ROLES:{name:"instanceAttributeRoles",type:P,optional:!0}},Je={baseType:I.OBJECT,name:"ModelFileDescriptor",properties:{SUFFIX:{name:"suffix",type:I.STRING},MAX_LOD:{name:"maxLOD",type:ce}}},Qe={baseType:I.ENUM,values:{EGM:"egm"}},Ke={NAME:{name:"name",type:I.STRING},BASEPATH:{name:"basepath",type:I.STRING},FORMAT:{name:"format",type:Qe},FILES:{name:"files",type:O(Je)}},Ze={NAME:{name:"name",type:I.STRING},SAMPLES:{name:"samples",type:D}},$e={NAME:{name:"name",type:I.STRING},SAMPLES:{name:"sample",type:I.STRING}},et={NAME:{name:"name",type:I.STRING},SHADER:{name:"shader",type:Te,newValue:"skybox"},CUBEMAP:{name:"cubemap",type:Ee}},tt={baseType:I.OBJECT,name:"Layer",properties:{SIZE:{name:"size",type:B,defaultValue:1},SHADER:{name:"shader",type:Te,newValue:"backgroundBillboard"},TEXTURE:{name:"texture",type:ye},COLOR:{name:"color",type:I.COLOR4,defaultValue:[1,1,1,1]}}},it={NAME:{name:"name",type:I.STRING},LIGHT_COLOR:{name:"lightColor",type:I.COLOR3,optional:!0,defaultText:"no light emitted"},LAYERS:{name:"layers",type:O(tt,{min:1})}},nt={NAME:{name:"name",type:I.STRING},SHADER:{name:"shader",type:Te,newValue:"dust"},NUMBER_OF_PARTICLES:{name:"numberOfParticles",type:he},RANGE:{name:"range",type:G},COLOR:{name:"color",type:I.COLOR3,defaultValue:[1,1,1]}},st={baseType:I.ENUM,values:l.ParticleEmitterType},ot=function(e,t){return e!==t.particleStates[0]},rt={baseType:I.OBJECT,name:"ParticleState",properties:{COLOR:{name:"color",type:I.COLOR4,defaultValue:[1,1,1,1]},SIZE:{name:"size",type:pe,defaultValue:1},TIME_TO_REACH:{name:"timeToReach",type:J,defaultValue:0,isValid:ot}}},at=function(e){return e.hasProjectileModel},lt=function(e){return e.type&&e.type!==l.ParticleEmitterType.OMNIDIRECTIONAL},ct=function(e){return e.spawnNumber>0},ht={baseType:I.OBJECT,name:"ParticleEmitter",properties:{TYPE:{name:"type",type:st,defaultValue:l.ParticleEmitterType.OMNIDIRECTIONAL},HAS_PROJECTILE_MODEL:{name:"hasProjectileModel",type:I.BOOLEAN,defaultValue:!1},PROJECTILE_MODEL_WIDTH:{name:"projectileModelWidth",type:ue,optional:!0,defaultValue:1,isValid:at},PROJECTILE_MODEL_INTERSECTION:{name:"projectileModelIntersection",
type:I.NUMBER,optional:!0,defaultValue:0,isValid:at},DIMENSIONS:{name:"dimensions",type:I.VECTOR3,defaultValue:[0,0,0]},DIRECTION_SPREAD:{name:"directionSpread",type:ee,defaultValue:0,isValid:lt},VELOCITY:{name:"velocity",type:k,defaultValue:0},VELOCITY_SPREAD:{name:"velocitySpread",type:W,defaultValue:0},INITIAL_NUMBER:{name:"initialNumber",type:ce,defaultValue:0},SPAWN_NUMBER:{name:"spawnNumber",type:ce,defaultValue:0},SPAWN_TIME:{name:"spawnTime",type:K,newValue:1e3,isRequired:ct,isValid:ct},DURATION:{name:"duration",type:Q,optional:!0,isValid:ct,defaultText:"infinite"},DELAY:{name:"delay",type:J,defaultValue:0},SHADER:{name:"shader",type:Te,newValue:"particle"},TEXTURE:{name:"texture",type:ye},PARTICLE_STATES:{name:"particleStates",type:O(rt,{min:2})}}},ut={baseType:I.OBJECT,name:"LightState",properties:{COLOR:{name:"color",type:I.COLOR3,newValue:[1,1,1]},INTENSITY:{name:"intensity",type:pe},TIME_TO_REACH:{name:"timeToReach",type:J}}},dt={baseType:I.OBJECT,name:"SoundDescriptor",getPreviewText:function(e){return"(("+(e.name.length>18?e.name.substring(0,15)+"...":e.name)+" | "+(void 0!==e.volume?e.volume:1)+"))"},properties:{NAME:{name:"name",type:Ce},VOLUME:{name:"volume",type:pe,defaultValue:1}}},pt={NAME:{name:"name",type:I.STRING},PARTICLE_EMITTERS:{name:"particleEmitters",type:O(ht,{min:1})},LIGHT_STATES:{name:"lightStates",type:O(ut,{min:1}),optional:!0,defaultText:"no light emitted"},SOUND_EFFECT:{name:"soundEffect",type:dt,optional:!0,defaultText:"no sound"}},_t={baseType:I.OBJECT,name:"ParticleDescriptor",properties:{SHADER:{name:"shader",type:Te,newValue:"particle"},TEXTURE:{name:"texture",type:ye},COLOR:{name:"color",type:I.COLOR4,defaultValue:[1,1,1,1]},SIZE:{name:"size",type:B,defaultValue:1},DURATION:{name:"duration",type:Q}}},gt={baseType:I.OBJECT,name:"TrailDescriptor",properties:{SHADER:{name:"shader",type:Te,newValue:"trail"},TEXTURE:{name:"texture",type:ye},COLOR:{name:"color",type:I.COLOR4,defaultValue:[1,1,1,1]},SIZE:{name:"size",type:B,defaultValue:1},DURATION:{name:"duration",type:Q,newValue:500},GROWTH_RATE:{name:"growthRate",type:U,newValue:2}}},mt=function(e){return!!e.lightColor},ft={NAME:{name:"name",type:I.STRING},DAMAGE:{name:"damage",type:I.NUMBER,defaultValue:0},SHADER:{name:"shader",type:Te,newValue:"billboard"},TEXTURE:{name:"texture",type:ye},SIZE:{name:"size",type:B,defaultValue:1},MASS:{name:"mass",type:re},DRAG_FACTOR:{name:"dragFactor",type:F,defaultValue:0},DURATION:{name:"duration",type:Q},DISSIPATION_DURATION:{name:"dissipationDuration",type:Q},INTERSECTION_POSITIONS:{name:"intersectionPositions",type:O(I.NUMBER,{min:1}),optional:!0,defaultText:"no intersections"},WIDTH:{name:"width",type:de,defaultValue:1},MUZZLE_FLASH:{name:"muzzleFlash",type:_t},LIGHT_COLOR:{name:"lightColor",type:I.COLOR3,optional:!0,newValue:[1,1,1],defaultText:"no light emitted"},LIGHT_INTENSITY:{name:"lightIntensity",type:_e,isValid:mt},EXPLOSION:{name:"explosion",type:Re},SHIELD_EXPLOSION:{name:"shieldExplosion",type:Re}},St={baseType:I.OBJECT,name:"Thruster",properties:{POSITION:{name:"position",type:I.VECTOR3},SIZE:{name:"size",type:B,newValue:1}}},Tt={baseType:I.SET,name:"ThrusterUses",values:v},yt=function(e){return!e.count},Et=function(e){return e.count>0},Ct={baseType:I.OBJECT,name:"ThrusterSlot",properties:{GROUP:{name:"group",type:me},USES:{name:"uses",type:Tt},THRUSTERS:{name:"thrusters",type:O(St,{min:1}),isValid:yt},COUNT:{name:"count",type:he,optional:!0,defaultText:"not an array"},POSITION:{name:"position",type:I.VECTOR3,isValid:Et},VECTOR:{name:"vector",type:I.VECTOR3,isValid:Et},SIZE:{name:"size",type:B,newValue:1,isValid:Et}}},Mt={baseType:I.ENUM,values:e.getEnumObject(e.getEnumKeys(l.MissileSize))},It={baseType:I.ENUM,values:e.getEnumObject(e.getEnumKeys(l.MissileHomingMode))},At=function(e){return e.name},xt=function(e){return(e.fullName||e.name).split(" ")[0].substring(0,5)},vt=function(t){return!!t.homingMode&&l.MissileHomingMode[e.constantName(t.homingMode)]!==l.MissileHomingMode.NONE},Ot=function(e){return!!e.lockingTime},Rt={NAME:{name:"name",type:I.STRING},FULL_NAME:{name:"fullName",type:I.STRING,getDerivedDefault:At,updateOnValidate:!0},SHORT_NAME:{name:"shortName",type:I.STRING,getDerivedDefault:xt,updateOnValidate:!0},MODEL:{name:"model",type:Se,newValue:"mediumMissile"},MODEL_SCALE:{name:"modelScale",type:B,optional:!0,defaultValue:1},SHADER:{name:"shader",type:Te,newValue:"ship"},TEXTURE:{name:"texture",type:ye},ANTI_SHIP:{name:"antiShip",type:I.BOOLEAN,defaultValue:!1},DAMAGE:{name:"damage",type:I.NUMBER,defaultValue:0},SIZE:{name:"size",type:Mt},CAPACITY:{name:"capacity",type:he,defaultValue:1},LENGTH:{name:"length",type:j,newValue:1},HOMING_MODE:{name:"homingMode",type:It,optional:!0,defaultText:"not homing"},MASS:{name:"mass",type:re,newValue:1},DRAG_FACTOR:{name:"dragFactor",type:F,defaultValue:1},LAUNCH_VELOCITY:{name:"launchVelocity",type:W,defaultValue:0},IGNITION_TIME:{name:"ignitionTime",type:J,defaultValue:0},ACCELERATION:{name:"acceleration",type:q,newValue:100},ANGULAR_ACCELERATION:{name:"angularAcceleration",type:oe,newValue:90,isRequired:vt,isValid:vt},MAIN_BURN_ANGLE_THRESHOLD:{name:"mainBurnAngleThreshold",type:ie,newValue:1,isRequired:vt,isValid:vt},DURATION:{name:"duration",type:Q,newValue:1e3},LOCKING_TIME:{name:"lockingTime",type:J,defaultValue:0,isValid:vt},LOCKING_ANGLE:{name:"lockingAngle",type:ie,optional:!0,defaultText:"unlimited",isValid:Ot},COOLDOWN:{name:"cooldown",type:Q,newValue:1e3},SALVO_COOLDOWN:{name:"salvoCooldown",type:Q,optional:!0,defaultText:"same as cooldown"},PROXIMITY_RANGE:{name:"proximityRange",type:H,defaultValue:0},KINETIC_FACTOR:{name:"kineticFactor",type:B,defaultValue:1},LIGHT_COLOR:{name:"lightColor",type:I.COLOR3,optional:!0,newValue:[1,1,1],defaultText:"no light emitted"},LIGHT_INTENSITY:{name:"lightIntensity",type:_e,isValid:mt},TRAIL:{name:"trail",type:gt},EXPLOSION:{name:"explosion",type:Re},SHIELD_EXPLOSION:{name:"shieldExplosion",type:Re},LAUNCH_SOUND:{name:"launchSound",type:dt},START_SOUND:{name:"startSound",type:dt},PROPULSION:{name:"propulsion",type:De},THRUSTER_SLOTS:{name:"thrusterSlots",type:O(Ct)},SCORE_VALUE:{name:"scoreValue",type:ce,defaultValue:0}},bt={baseType:I.OBJECT,name:"Barrel",properties:{POSITION:{name:"position",type:I.VECTOR3}}},Lt={baseType:I.ENUM,values:l.WeaponRotationStyle},Nt={baseType:I.OBJECT,name:"WeaponRotator",properties:{AXIS:{name:"axis",type:I.VECTOR3,newValue:[0,0,1]},CENTER:{name:"center",type:I.VECTOR3},RANGE:{name:"range",type:b(!0,!0,$),optional:!0,defaultText:"360°"},DEFAULT_ANGLE:{name:"defaultAngle",type:$,defaultValue:0},ROTATION_RATE:{name:"rotationRate",type:se,newValue:1},TRANSFORM_GROUP_INDEX:{name:"transformGroupIndex",type:ge}}},Dt=function(e){return e.rotationStyle&&e.rotationStyle!==l.WeaponRotationStyle.NONE},Pt={NAME:{name:"name",type:I.STRING},FULL_NAME:{name:"fullName",type:I.STRING,getDerivedDefault:At,updateOnValidate:!0},SHADER:{name:"shader",type:Te,newValue:"ship"},MODEL:{name:"model",type:Se},TEXTURE:{name:"texture",type:ye},DEFAULT_LUMINOSITY_FACTORS:{name:"defaultLuminosityFactors",type:Be,optional:!0,defaultText:"all zeros"},PROJECTILE:{name:"projectile",type:be},PROJECTILE_VELOCITY:{name:"projectileVelocity",type:Y,newValue:1},COOLDOWN:{name:"cooldown",type:Q},BARRELS:{name:"barrels",type:O(bt,{min:1})},ATTACHMENT_POINT:{name:"attachmentPoint",type:I.VECTOR3,defaultValue:[0,0,0]},ROTATION_STYLE:{name:"rotationStyle",type:Lt,defaultValue:l.WeaponRotationStyle.NONE},BASE_POINT:{name:"basePoint",type:I.VECTOR3,defaultValue:[0,0,0],isValid:Dt},ROTATORS:{name:"rotators",type:O(Nt,{fixed:2}),isRequired:Dt,isValid:Dt},FIRE_SOUND:{name:"fireSound",type:dt},SCORE_VALUE:{name:"scoreValue",type:ce,defaultValue:0}},wt={NAME:{name:"name",type:I.STRING},FULL_NAME:{name:"fullName",type:I.STRING,getDerivedDefault:At,updateOnValidate:!0},SHADER:{name:"shader",type:Te,newValue:"particle"},TEXTURE:{name:"texture",type:ye},COLOR:{name:"color",type:I.COLOR4,newValue:[1,1,1,1]},REFERENCE_MASS:{name:"referenceMass",type:re,newValue:1},THRUST:{name:"thrust",type:q,newValue:1},ANGULAR_THRUST:{name:"angularThrust",type:oe,newValue:1},MAX_MOVE_BURN_LEVEL:{name:"maxMoveBurnLevel",type:de,newValue:.5},MAX_TURN_BURN_LEVEL:{name:"maxTurnBurnLevel",type:de,newValue:.5},THRUSTER_SOUND:{name:"thrusterSound",type:dt},SCORE_VALUE:{name:"scoreValue",type:ce,defaultValue:0}},Vt={NAME:{name:"name",type:I.STRING},FULL_NAME:{name:"fullName",type:I.STRING,getDerivedDefault:At,updateOnValidate:!0},RANGE:{name:"range",type:G,newValue:1},SCORE_VALUE:{name:"scoreValue",type:ce,defaultValue:0}},Ft=function(e){return e.jumpOutAcceleration+" "+X.unit},Ut=function(e){return e.jumpOutDuration+" "+z.unit},Bt=function(e){return e.prepareVelocity+" "+k.unit},Ht=function(e){return(e.jumpOutScaling||1)+" "+V.unit},Gt=function(e){return dt.getPreviewText(e.jumpOutSound)},jt=function(e){return e.jumpOutExplosion},kt={NAME:{name:"name",type:I.STRING},ENGAGE_SOUND:{name:"engageSound",type:dt},DISENGAGE_SOUND:{name:"disengageSound",type:dt},PREPARE_VELOCITY:{name:"prepareVelocity",type:W},PREPARE_DURATION:{name:"prepareDuration",type:J},PREPARE_SOUND:{name:"prepareSound",type:dt},CANCEL_SOUND:{name:"cancelSound",type:dt},JUMP_OUT_ACCELERATION:{name:"jumpOutAcceleration",type:q},JUMP_OUT_DURATION:{name:"jumpOutDuration",type:Q},JUMP_OUT_SCALING:{name:"jumpOutScaling",type:B,defaultValue:1},JUMP_OUT_SOUND:{name:"jumpOutSound",type:dt},JUMP_OUT_EXPLOSION:{name:"jumpOutExplosion",type:Re},JUMP_IN_DECELERATION:{name:"jumpInDeceleration",type:q,getDerivedDefault:Ft,updateOnValidate:!0},JUMP_IN_DURATION:{name:"jumpInDuration",type:Q,getDerivedDefault:Ut,updateOnValidate:!0},JUMP_IN_VELOCITY:{name:"jumpInVelocity",type:k,getDerivedDefault:Bt,updateOnValidate:!0},JUMP_IN_SCALING:{name:"jumpInScaling",type:B,getDerivedDefault:Ht,updateOnValidate:!0},JUMP_IN_SOUND:{name:"jumpInSound",type:dt,getDerivedDefault:Gt,updateOnValidate:!0},JUMP_IN_EXPLOSION:{name:"jumpInExplosion",type:Re,getDerivedDefault:jt,updateOnValidate:!0}},Wt={NAME:{name:"name",type:I.STRING},FULL_NAME:{name:"fullName",type:I.STRING,getDerivedDefault:At,updateOnValidate:!0},CAPACITY:{name:"capacity",type:he},RECHARGE_DELAY:{name:"rechargeDelay",type:J},RECHARGE_RATE:{name:"rechargeRate",type:Z},RECHARGE_COLOR:{name:"rechargeColor",type:I.COLOR3,defaultValue:[1,1,1]},RECHARGE_ANIMATION_DURATION:{name:"rechargeAnimationDuration",type:Q},RECHARGE_START_SOUND:{name:"rechargeStartSound",type:dt},SCORE_VALUE:{name:"scoreValue",type:ce,defaultValue:0}},Yt={baseType:I.SET,name:"SpacecraftTypes",classReference:"spacecraftTypes"},Xt={NAME:{name:"name",type:I.STRING},IS_FIGHTER_TYPE:{name:"isFighterType",type:I.BOOLEAN,defaultValue:!1},FULL_NAME:{name:"fullName",type:I.STRING,getDerivedDefault:At,updateOnValidate:!0},DESCRIPTION:{name:"description",type:w},GOOD_AGAINST:{name:"goodAgainst",type:Yt,optional:!0,defaultText:"none"},BAD_AGAINST:{name:"badAgainst",type:Yt,optional:!0,defaultText:"none"}},qt={baseType:I.ENUM,values:l.SpacecraftTurnStyle},zt={baseType:I.OBJECT,name:"Body",properties:{POSITION:{name:"position",type:I.VECTOR3},ROTATIONS:{name:"rotations",type:I.ROTATIONS,optional:!0},SIZE:{name:"size",type:I.VECTOR3}}},Jt=function(e){return e.count>1},Qt={baseType:I.OBJECT,name:"WeaponSlot",properties:{POSITION:{name:"position",type:I.VECTOR3},COUNT:{name:"count",type:he,defaultValue:1},VECTOR:{name:"vector",type:I.VECTOR3,isValid:Jt,isRequired:Jt},ROTATIONS:{name:"rotations",type:I.ROTATIONS,optional:!0},CLEAR:{name:"clear",description:"Whether a turret installed at this slot can freely fire in 360 degrees without hitting the ship",type:I.BOOLEAN,defaultValue:!1}}},Kt={baseType:I.OBJECT,name:"MissileTube",properties:{POSITION:{name:"position",type:I.VECTOR3},VECTOR:{name:"vector",type:I.VECTOR3,isValid:Jt,isRequired:Jt},COUNT:{name:"count",type:he,defaultValue:1}}},Zt={baseType:I.OBJECT,name:"MissileLauncher",properties:{TUBES:{name:"tubes",type:O(Kt,{min:1})},SIZE:{name:"size",type:Mt},CAPACITY:{name:"capacity",type:he},SALVO:{name:"salvo",type:he,defaultValue:1}}},$t={baseType:I.ENUM,values:n.CameraOrientationConfiguration.BaseOrientation},ei={baseType:I.ENUM,values:n.CameraOrientationConfiguration.PointToFallback},ti={baseType:I.ENUM,values:l.ObjectViewLookAtMode},ii=function(e){return!!e.fps},ni=function(e){return e.lookAt!==l.ObjectViewLookAtMode.SELF},si=function(e){return void 0!==e.followsPosition?e.followsPosition:ni(e)},oi=function(e){return!!e.lookAt&&e.lookAt!==l.ObjectViewLookAtMode.NONE},ri=function(e){return!si(e)||e.movable},ai=function(e){return!oi(e)},li=function(e){return void 0!==e.followsOrientation?e.followsOrientation:ai(e)},ci=function(e){return ni(e)&&si(e)&&(!li(e)||e.turnable||e.rotations)},hi=function(e){return ii(e)&&!!e.turnable},ui=function(e){return!li(e)&&!e.turnable},di=function(e){return!si(e)&&!e.rotationCenterIsObject},pi=function(e){return si(e)||e.startsWithRelativePosition},_i=function(e){return(e.distanceRange||e.confines)&&pi(e)},gi=function(e){return(e.rotationCenterIsObject||oi(e))&&e.movable},mi=function(e){return si(e)&&li(e)&&!e.rotationCenterIsObject&&e.movable},fi=function(e){return ri(e)&&(pi(e)||ai(e)||!e.confines)},Si=function(e){return ri(e)&&(pi(e)||ai(e)||!e.distanceRange)},Ti=function(e){return(ri(e)||e.turnable)&&!(oi(e)&&e.startsWithRelativePosition)},yi={baseType:I.OBJECT,name:"View",properties:{NAME:{name:"name",type:I.STRING},AIMING_VIEW:{name:"aimingView",type:I.BOOLEAN,defaultValue:!1},FOV:{name:"fov",type:ie,getDerivedDefault:o.getDefaultCameraFOV},FOV_RANGE:{name:"fovRange",type:b(!0,!0,ie),optional:!0,defaultText:"fixed"},SPAN:{name:"span",type:j,getDerivedDefault:o.getDefaultCameraSpan},FPS:{name:"fps",type:I.BOOLEAN,defaultValue:!1},FOLLOWS_POSITION:{name:"followsPosition",type:I.BOOLEAN,defaultValue:!0,isValid:ni},FOLLOWS_ORIENTATION:{name:"followsOrientation",type:I.BOOLEAN,defaultValue:!0,isValid:ai},BASE_ORIENTATION:{name:"baseOrientation",type:$t,getDerivedDefault:o.getDefaultCameraBaseOrientation,isValid:ii},POINT_TO_FALLBACK:{name:"pointToFallback",type:ei,getDerivedDefault:o.getDefaultCameraPointToFallback,isValid:oi},STARTS_WITH_RELATIVE_POSITION:{name:"startsWithRelativePosition",type:I.BOOLEAN,defaultValue:!1,isValid:di},LOOK_AT:{name:"lookAt",type:ti,defaultValue:l.ObjectViewLookAtMode.NONE,isValid:ui},MOVABLE:{name:"movable",type:I.BOOLEAN,defaultValue:!1},TURNABLE:{name:"turnable",type:I.BOOLEAN,defaultValue:!1,isValid:ai},ALPHA_RANGE:{name:"alphaRange",type:b(!0,!0,$),optional:!0,defaultText:"unlimited",isValid:hi},BETA_RANGE:{name:"betaRange",type:b(!0,!0,ne),defaultValue:[-90,90],isValid:hi},ROTATION_CENTER_IS_OBJECT:{name:"rotationCenterIsObject",type:I.BOOLEAN,defaultValue:!1,isValid:ci},DISTANCE_RANGE:{name:"distanceRange",type:b(!1,!1,H),isRequired:gi,updateOnValidate:!0,defaultText:"unlimited",isValid:fi},CONFINES:{name:"confines",type:I.CONFINES,optional:!0,defaultText:"no confines",isValid:Si},RESETS_WHEN_LEAVING_CONFINES:{name:"resetsWhenLeavingConfines",type:I.BOOLEAN,defaultValue:!1,isValid:_i},POSITION:{name:"position",type:I.VECTOR3},ROTATIONS:{name:"rotations",type:I.ROTATIONS,optional:!0},MOVES_RELATIVE_TO_OBJECT:{name:"movesRelativeToObject",type:I.BOOLEAN,defaultValue:!1,isValid:mi},RESETS_ON_FOCUS_CHANGE:{name:"resetsOnFocusChange",type:I.BOOLEAN,defaultValue:!1,isValid:Ti},EXCLUDE_FROM_CYCLE:{name:"excludeFromCycle",type:I.BOOLEAN,defaultValue:!1}}},Ei={baseType:I.OBJECT,name:"Weapon",getName:function(e){return e.class},properties:{CLASS:{name:"class",type:Ne},SLOT_INDEX:{name:"slotIndex",type:ce,optional:!0,defaultText:"auto"}}},Ci={baseType:I.OBJECT,name:"Missile",getName:function(e){return e.class+" ("+e.amount+")"},properties:{CLASS:{name:"class",type:Le},AMOUNT:{name:"amount",type:he},LAUNCHER_INDEX:{name:"launcherIndex",type:ce,optional:!0,defaultText:"auto"}}},Mi={baseType:I.OBJECT,name:"Propulsion",getPreviewText:function(e){return e.class},properties:{CLASS:{name:"class",type:De}}},Ii={baseType:I.OBJECT,name:"Sensors",getPreviewText:function(e){return e.class},properties:{CLASS:{name:"class",type:Pe}}},Ai={baseType:I.OBJECT,name:"JumpEngine",getPreviewText:function(e){return e.class},properties:{CLASS:{name:"class",type:we}}},xi={baseType:I.OBJECT,name:"Shield",getPreviewText:function(e){return e.class},properties:{CLASS:{name:"class",type:Ve}}},vi={baseType:I.ENUM,getValues:function(e,t){var i;if(t.loadouts)return t.loadouts.map(function(e){return e.name});if(t.spacecrafts)for(i=0;i<t.spacecrafts.length;i++)if(t.spacecrafts[i].equipment===e)return l.getSpacecraftClass(t.spacecrafts[i].class).getLoadoutNames();return[]}},Oi=function(e,t){return!!t.loadouts},Ri={baseType:I.OBJECT,name:"Loadout",properties:{NAME:{name:"name",type:I.STRING,isValid:Oi},BASED_ON:{name:"basedOn",type:vi,optional:!0,defaultText:"none"},WEAPONS:{name:"weapons",type:O(Ei),optional:!0,defaultText:"none"},MISSILES:{name:"missiles",type:O(Ci),optional:!0,defaultText:"none"},PROPULSION:{name:"propulsion",type:Mi,optional:!0,defaultText:"none"},SENSORS:{name:"sensors",type:Ii,optional:!0,defaultText:"none"},JUMP_ENGINE:{name:"jumpEngine",type:Ai,optional:!0,defaultText:"none"},SHIELD:{name:"shield",type:xi,optional:!0,defaultText:"none"}}},bi={baseType:I.OBJECT,name:"DamageIndicator",getName:function(e){return e.hullIntegrity+"% - "+e.class},properties:{HULL_INTEGRITY:{name:"hullIntegrity",type:ae,newValue:50},CLASS:{name:"class",type:Re}}},Li=function(e){return!!e.spotDirection},Ni={baseType:I.OBJECT,name:"Light",properties:{POSITION:{name:"position",type:I.VECTOR3},COLOR:{name:"color",type:I.COLOR3,defaultValue:[1,1,1]},INTENSITY:{name:"intensity",type:_e,newValue:10},SPOT_DIRECTION:{name:"spotDirection",type:I.VECTOR3,optional:!0,newValue:[0,1,0],defaultText:"point light"},SPOT_CUTOFF_ANGLE:{name:"spotCutoffAngle",type:ee,isValid:Li,newValue:25},SPOT_FULL_INTENSITY_ANGLE:{name:"spotFullIntensityAngle",type:ee,isValid:Li,newValue:5}}},Di={baseType:I.OBJECT,name:"Blinker",properties:{PARTICLE:{name:"particle",type:_t},POSITION:{name:"position",type:I.VECTOR3},PERIOD:{name:"period",type:Q,newValue:1e3},BLINKS:{name:"blinks",type:fe},INTENSITY:{name:"intensity",type:_e,newValue:10}}},Pi={baseType:I.ENUM,getValues:function(e){return e.loadouts?e.loadouts.map(function(e){return e.name}):e.basedOn?l.getSpacecraftClass(e.basedOn).getLoadoutNames():[]}},wi=function(e){return!1!==e.showInDatabase},Vi=function(e){return!!e.type&&!l.getSpacecraftType(e.type)._isFighterType},Fi=function(e){return!!e.loadouts&&e.loadouts.length>0||e.basedOn&&l.getSpacecraftClass(e.basedOn).getLoadoutNames().length>0},Ui={NAME:{name:"name",type:I.STRING},BASED_ON:{name:"basedOn",type:Oe,optional:!0,defaultText:"none"},TYPE:{name:"type",type:ve},FULL_NAME:{name:"fullName",type:I.STRING,getDerivedDefault:At,updateOnValidate:!0},SHOW_IN_DATABASE:{name:"showInDatabase",type:I.BOOLEAN,defaultValue:!0},DESCRIPTION:{name:"description",type:w,isValid:wi,newValue:"-"},HITPOINTS:{name:"hitpoints",type:he},ARMOR:{name:"armor",type:pe,defaultValue:0},TURN_STYLE:{name:"turnStyle",type:qt,isValid:Vi,defaultValue:l.SpacecraftTurnStyle.YAW_PITCH},ATTACK_VECTOR:{name:"attackVector",type:I.VECTOR3,isValid:Vi,defaultValue:[0,1,0]},ATTACK_THRESHOLD_ANGLE:{name:"attackThresholdAngle",type:te,isValid:Vi,defaultValue:0},MODEL:{name:"model",type:Se},SHADER:{name:"shader",type:Te},TEXTURE:{name:"texture",type:ye},FACTION_COLOR:{name:"factionColor",type:I.COLOR4,optional:!0,defaultText:"none"},DEFAULT_LUMINOSITY_FACTORS:{name:"defaultLuminosityFactors",type:Be,optional:!0,defaultText:"all zeros"},MASS:{name:"mass",type:re,newValue:1e4},DRAG_FACTOR:{name:"dragFactor",type:F,defaultValue:1},LOCKING_TIME_FACTOR:{name:"lockingTimeFactor",type:F,defaultValue:1},BODIES:{name:"bodies",type:O(zt,{min:1})},WEAPON_SLOTS:{name:"weaponSlots",type:O(Qt,{min:1}),optional:!0,defaultText:"none"},MISSILE_LAUNCHERS:{name:"missileLaunchers",type:O(Zt,{min:1}),optional:!0,defaultText:"none"},THRUSTER_SLOTS:{name:"thrusterSlots",type:O(Ct,{min:1}),optional:!0,defaultText:"none"},VIEWS:{name:"views",type:O(yi,{min:1})},LOADOUTS:{name:"loadouts",type:O(Ri,{min:1}),optional:!0,defaultText:"none"},DEFAULT_LOADOUT:{name:"defaultLoadout",type:Pi,isValid:Fi,optional:!0,defaultText:"none",updateOnValidate:!0},HUM_SOUND:{name:"humSound",type:dt,optional:!0,defaultText:"none"},COLLISION_SOUND:{name:"collisionSound",type:dt,optional:!0,defaultText:"none"},EXPLOSION:{name:"explosion",type:Re},SHOW_TIME_RATIO_DURING_EXPLOSION:{name:"showTimeRatioDuringExplosion",type:ue,newValue:.5},DAMAGE_INDICATORS:{name:"damageIndicators",type:O(bi,{min:1}),optional:!0,defaultText:"none"},LIGHTS:{name:"lights",type:O(Ni,{min:1}),optional:!0,defaultText:"none"},BLINKERS:{name:"blinkers",type:O(Di,{min:1}),optional:!0,defaultText:"none"},SCORE_VALUE:{name:"scoreValue",type:ce,defaultValue:0}},Bi={baseType:I.OBJECT,name:"Skybox",getName:function(e){return e.class},properties:{CLASS:{name:"class",type:Ie}}},Hi={baseType:I.OBJECT,name:"BackgroundObjectPosition",getPreviewText:function(e){return(e.angleAlpha||0)+"°, "+(e.angleBeta||0)+"°"+(void 0!==e.angleGamma?", "+e.angleGamma+"°":"")},properties:{ANGLE_ALPHA:{name:"angleAlpha",type:$,defaultValue:0},ANGLE_BETA:{name:"angleBeta",type:$,defaultValue:0},ANGLE_GAMMA:{name:"angleGamma",type:$,defaultValue:0}}},Gi={baseType:I.OBJECT,name:"BackgroundObject",getName:function(e){return e.class+" ("+e.size+")"},properties:{CLASS:{name:"class",type:Ae},SIZE:{name:"size",type:B,newValue:100},POSITION:{name:"position",type:Hi}}},ji={baseType:I.OBJECT,name:"DustCloud",getName:function(e){return e.class},properties:{CLASS:{name:"class",type:xe}}},ki=function(e){return!1!==e.relativeToCamera},Wi={baseType:I.OBJECT,name:"ParticleEffect",getName:function(e){return e.class},properties:{CLASS:{name:"class",type:Re,newValue:"blueNebula"},POSITION:{name:"position",type:I.VECTOR3,defaultValue:[0,0,0]},RELATIVE_TO_CAMERA:{name:"relativeToCamera",type:I.BOOLEAN,defaultValue:!0},DIRECTION:{name:"direction",type:I.VECTOR3,defaultValue:[0,0,1]},RELATIVE_DIRECTION:{name:"relativeDirection",type:I.BOOLEAN,defaultValue:!1,isValid:ki}}},Yi={NAME:{name:"name",type:I.STRING},LOCATION:{name:"location",type:I.STRING},COLOR:{name:"color",type:I.COLOR4,defaultValue:[0,0,0,0]},SKYBOXES:{name:"skyboxes",type:O(Bi,{min:1}),optional:!0,defaultText:"none"},BACKGROUND_OBJECTS:{name:"backgroundObjects",type:O(Gi,{min:1}),optional:!0,defaultText:"none"},DUST_CLOUDS:{name:"dustClouds",type:O(ji,{min:1}),optional:!0,defaultText:"none"},PARTICLE_EFFECTS:{name:"particleEffects",type:O(Wi,{min:1}),optional:!0,defaultText:"none"},SHADOWS:{name:"shadows",type:I.BOOLEAN,defaultValue:!0},AMBIENT_COLOR:{name:"ambientColor",type:I.COLOR3,defaultValue:[0,0,0]},DRAG:{name:"drag",type:pe,defaultValue:0},ANGULAR_DRAG:{name:"angularDrag",type:pe,defaultValue:0},SENSOR_RANGE_FACTOR:{name:"sensorRangeFactor",type:F,defaultValue:1},LOCKING_TIME_FACTOR:{name:"lockingTimeFactor",type:F,defaultValue:1}},Xi={baseType:I.ENUM,getValues:function(){var e=a.FACTION.PREFIX.name,t=e.length;return a.getKeys(e).map(function(e){return e.substring(t)})}},qi=function(e){return!e.name},zi=function(e){return!e.faction},Ji=function(e){return e.faction},Qi={baseType:I.OBJECT,name:"Team",unpack:function(e){return{name:e,faction:e}},getName:function(e){return e.name||e.faction},properties:{NAME:{name:"name",type:I.STRING,isRequired:zi,getDerivedDefault:Ji,updateOnValidate:!0},FACTION:{name:"faction",type:Xi,isRequired:qi,updateOnValidate:!0},COLOR:{name:"color",type:I.COLOR4,optional:!0}}},Ki={baseType:I.ENUM,values:y},Zi={baseType:I.ENUM,name:"Spacecraft",getValues:function(e,t){var i,n,s,o=[];if(t.spacecrafts)for(n=h.getIndividualSpacecraftDescriptors(t.spacecrafts),i=0;i<n.length;i++)s=n[i],s.name?o.push(s.name):s.squad&&o.push(s.squad);return o}},$i={baseType:I.ENUM,name:"Squad",getValues:function(e,t){var i,n,s,o=[];if(t.spacecrafts)for(i=0;i<t.spacecrafts.length;i++)n=t.spacecrafts[i],n.squad&&(s=m.getSquadName(n.squad),o.indexOf(s)<0&&o.push(s));return o}},en={baseType:I.ENUM,name:"Team",getValues:function(e,t){return t.teams?t.teams.filter(function(e){return!!e.name||!!e.faction}).map(function(e){return e.name||e.faction}):[]}},tn={baseType:I.OBJECT,name:"SubjectGroup",getPreviewText:function(e,t){var i="",n=[];return t&&t.params&&t.params.which===u.ConditionSubjectsWhich.ANY&&(i="any of "),e.spacecrafts&&(n=n.concat(e.spacecrafts)),e.squads&&(n=n.concat(e.squads)),e.teams&&(n=n.concat(e.teams)),0===n.length?"none":1===n.length?n[0]:2===n.length?i+n[0]+", "+n[1]:3===n.length&&n[2]&&n[2].length<9?i+n.join(", "):i+n[0]+", "+n[1]+"... ("+(n.length-2)+" more)"},properties:{SPACECRAFTS:{name:"spacecrafts",type:O(Zi,void 0,void 0,2),optional:!0},SQUADS:{name:"squads",type:O($i,void 0,void 0,3),optional:!0},TEAMS:{name:"teams",type:O(en,void 0,void 0,3),optional:!0}}},nn={baseType:I.ENUM,values:u.ConditionSubjectsWhich},sn={baseType:I.ENUM,values:u.CountConditionRelation},on={baseType:I.ENUM,values:u.TimeConditionWhen},rn={baseType:I.ENUM,getValues:function(e,t){return t.events?t.events.filter(function(e){return!!e.name}).map(function(e){return e.name}):[]}},an=function(e,t){return!!t&&(t.type===y.DESTROYED||t.type===y.HULL_INTEGRITY||t.type===y.SHIELD_INTEGRITY||t.type===y.DISTANCE||t.type===y.AWAY||t.type===y.ON_TEAM||t.type===y.IS_TARGETED)},ln=function(e,t){return!!t&&t.type===y.COUNT},cn=function(e,t){return!!t&&t.type===y.TIME},hn=function(e,t){return!!t&&(t.type===y.HULL_INTEGRITY||t.type===y.SHIELD_INTEGRITY)},un=function(e,t){return!!t&&t.type===y.DISTANCE},dn=function(e,t){return!!t&&(t.type===y.HIT||t.type===y.GETS_TARGETED||t.type===y.IS_TARGETED)},pn=function(e,t){return!!t&&t.type===y.COLLISION},_n=function(e,t){return!!t&&t.type===y.AWAY},gn=function(e,t){return!!t&&t.type===y.ON_TEAM},mn=function(e,t){return!!t&&t.type===y.MISSION_STATE},fn=function(e,t){return cn(0,t)&&e.when===u.TimeConditionWhen.REPEAT},Sn={baseType:I.SET,name:"MissionStates",values:p.MissionState},Tn={baseType:I.OBJECT,name:"ConditionParams",getPreviewText:function(t,i){var n="";return void 0!==t.minIntegrity||void 0!==t.maxIntegrity?(void 0!==t.minIntegrity&&(n+=t.minIntegrity+"% < "),n+=i&&i.type===y.SHIELD_INTEGRITY?"shield of ":"hull of ",i&&i.subjects?n+=tn.getPreviewText(i.subjects,i):t.which===u.ConditionSubjectsWhich.ANY?n+="any subjects":n+="all subjects",void 0!==t.maxIntegrity&&(n+=" < "+t.maxIntegrity+"%"),n):void 0!==t.minDistance||void 0!==t.maxDistance?(void 0!==t.minDistance&&(n+=e.getLengthString(t.minDistance)+" < "),n+="distance to "+t.target,void 0!==t.maxDistance&&(n+=" < "+e.getLengthString(t.maxDistance)),n):t.team?t.which?t.which+" on "+t.team:"on "+t.team:void 0!==t.by?(t.which&&(n=t.which+", "),n+"by "+tn.getPreviewText(t.by)):void 0!==t.with?n+"with "+tn.getPreviewText(t.with):t.which?void 0!==t.away?t.which+" "+(t.away?"away":"present"):t.which:void 0!==t.away?t.away?"away":"present":void 0!==t.relation?t.relation+" "+t.count:void 0!==t.when?t.when+(t.maxCount?" ("+t.maxCount+"x)":"")+": "+e.getTimeString(t.time)+(t.start?" after "+t.start:""):void 0!==t.missionStates?"state is "+(t.missionStates.join(" or ")||"unknown"):"none"},properties:{WHICH:{name:"which",type:nn,isRequired:an,isValid:an},COUNT:{name:"count",type:ce,isRequired:ln,isValid:ln},RELATION:{name:"relation",type:sn,isRequired:ln,isValid:ln},TIME:{name:"time",type:J,isRequired:cn,isValid:cn},WHEN:{name:"when",type:on,isRequired:cn,isValid:cn},START:{name:"start",type:rn,optional:!0,isValid:cn,defaultText:"mission start"},MAX_COUNT:{name:"maxCount",type:he,optional:!0,isValid:fn,defaultText:"infinite"},START_VALUE:{name:"startValue",type:z,optional:!0,isValid:fn,defaultValue:0},MIN_INTEGRITY:{name:"minIntegrity",type:le,optional:!0,isValid:hn,defaultText:"0%"},MAX_INTEGRITY:{name:"maxIntegrity",type:le,optional:!0,isValid:hn,defaultText:"100%"},TARGET:{name:"target",type:Zi,isValid:un,isRequired:un},MIN_DISTANCE:{name:"minDistance",type:G,optional:!0,isValid:un,defaultText:"0"},MAX_DISTANCE:{name:"maxDistance",type:G,optional:!0,isValid:un,defaultText:"infinity"},BY:{name:"by",type:tn,optional:!0,isValid:dn,defaultText:"any"},WITH:{name:"with",type:tn,optional:!0,isValid:pn,defaultText:"any"},AWAY:{name:"away",type:I.BOOLEAN,optional:!0,isValid:_n,defaultValue:!0},TEAM:{name:"team",type:en,isValid:gn,isRequired:gn},MISSION_STATES:{name:"missionStates",type:Sn,isValid:mn,isRequired:mn}}},yn=function(e){return e.type===y.DESTROYED||e.type===y.COUNT||e.type===y.HULL_INTEGRITY||e.type===y.SHIELD_INTEGRITY||e.type===y.DISTANCE||e.type===y.HIT||e.type===y.COLLISION||e.type===y.AWAY||e.type===y.ON_TEAM||e.type===y.GETS_TARGETED||e.type===y.IS_TARGETED},En=function(e){return e.type===y.DESTROYED&&e.subjects&&new u.SubjectGroup(e.subjects).isMulti()||e.type===y.COUNT||e.type===y.TIME||e.type===y.HULL_INTEGRITY||e.type===y.SHIELD_INTEGRITY||e.type===y.DISTANCE||e.type===y.HIT||e.type===y.COLLISION||e.type===y.AWAY||e.type===y.ON_TEAM||e.type===y.MISSION_STATE||e.type===y.GETS_TARGETED||e.type===y.IS_TARGETED},Cn=function(e){return e.type===y.COUNT||e.type===y.TIME||e.type===y.HULL_INTEGRITY||e.type===y.SHIELD_INTEGRITY||e.type===y.DISTANCE||e.type===y.ON_TEAM||e.type===y.MISSION_STATE},Mn=function(e){switch(e.type){case y.DESTROYED:return"all";case y.AWAY:return"all away";default:return"none"}},In={baseType:I.OBJECT,name:"Condition",getName:function(e){return e.type?e.type:"condition"},getPreviewText:function(t){if(t.type){switch(t.type){case y.COUNT:return"count of "+tn.getPreviewText(t.subjects||e.EMPTY_OBJECT,t)+" "+Tn.getPreviewText(t.params||e.EMPTY_OBJECT,t);case y.DESTROYED:return tn.getPreviewText(t.subjects||e.EMPTY_OBJECT,t)+" destroyed";case y.TIME:return t.params?Tn.getPreviewText(t.params,t):"time";case y.HULL_INTEGRITY:return!t.params||void 0===t.params.minIntegrity&&void 0===t.params.maxIntegrity?"incomplete hull condition":Tn.getPreviewText(t.params,t);case y.SHIELD_INTEGRITY:return!t.params||void 0===t.params.minIntegrity&&void 0===t.params.maxIntegrity?"incomplete shield condition":Tn.getPreviewText(t.params,t);case y.DISTANCE:return!t.params||void 0===t.params.minDistance&&void 0===t.params.maxDistance?"incomplete distance condition":tn.getPreviewText(t.subjects||e.EMPTY_OBJECT,t)+": "+Tn.getPreviewText(t.params,t);case y.HIT:return tn.getPreviewText(t.subjects||e.EMPTY_OBJECT,t)+" hit"+(t.params&&t.params.by?" "+Tn.getPreviewText(t.params,t):"");case y.COLLISION:return tn.getPreviewText(t.subjects||e.EMPTY_OBJECT,t)+" collides"+(t.params&&t.params.with?" "+Tn.getPreviewText(t.params,t):"");case y.AWAY:return tn.getPreviewText(t.subjects||e.EMPTY_OBJECT,t)+" "+(t.params&&!1===t.params.away?"present":"away");case y.ON_TEAM:return tn.getPreviewText(t.subjects||e.EMPTY_OBJECT,t)+" on "+(t.params&&t.params.team||"unknown");case y.MISSION_STATE:return"mission state is "+(t.params&&t.params.missionStates&&t.params.missionStates.join(" or ")||"unknown");case y.GETS_TARGETED:return tn.getPreviewText(t.subjects||e.EMPTY_OBJECT,t)+" gets targeted"+(t.params&&t.params.by?" "+Tn.getPreviewText(t.params,t):"");case y.IS_TARGETED:return tn.getPreviewText(t.subjects||e.EMPTY_OBJECT,t)+" is targeted"+(t.params&&t.params.by?" by "+tn.getPreviewText(t.params.by):"")}return t.type}return"condition"},properties:{TYPE:{name:"type",type:Ki},SUBJECTS:{name:"subjects",type:tn,isRequired:yn,isValid:yn},PARAMS:{name:"params",type:Tn,isRequired:Cn,isValid:En,updateOnValidate:!0,getDerivedDefault:Mn}}},An={baseType:I.ENUM,values:M},xn={baseType:I.ENUM,values:C},vn=function(e){return e.conditions&&e.conditions.length>0},On=function(e){return e.conditions&&e.conditions.length>1},Rn=function(e){var t;if(e.conditions)for(t=0;t<e.conditions.length;t++)if(u.createCondition(e.conditions[t]).canChangeMultipleTimes())return!1;return!0},bn=function(e){return!Rn(e)},Ln=function(e){return!0===e.once||void 0===e.once&&Rn(e)},Nn=function(e,t){return!!t.actions&&t.actions.some(function(e){return e.type===E.WIN||e.type===E.LOSE})
},Dn={baseType:I.OBJECT,name:"Trigger",getPreviewText:function(t){var i=t.which===M.ANY,n=t.when===C.BECOMES_FALSE,s=t.delay?e.getTimeString(t.delay)+" after ":"";return t.conditions&&t.conditions.length>0?s=t.conditions.length>2?s+(i?"any of ":"")+t.conditions.length+" conditions"+(n?" become false":""):t.conditions.length>1?s+(n?i?"not ":"neither ":"")+t.conditions.map(In.getPreviewText).join(n?i?" and ":" nor ":i?" or ":" and "):s+(n?"not ":"")+In.getPreviewText(t.conditions[0],t):s+"mission start"},properties:{CONDITIONS:{name:"conditions",type:O(In,{min:1},function(e){if(e.length>0&&e.length<=2)return"["+e.map(In.getPreviewText).join(", ")+"]"}),defaultText:"none",isRequired:Nn,updateOnValidate:!0},WHICH:{name:"which",type:An,defaultValue:M.ALL,isValid:On},WHEN:{name:"when",type:xn,defaultValue:C.BECOMES_TRUE,isValid:vn},ONCE:{name:"once",type:I.BOOLEAN,getDerivedDefault:Rn,isValid:bn},DELAY:{name:"delay",type:J,defaultValue:0,isValid:Ln}}},Pn={baseType:I.ENUM,getValues:function(e,t){var i,n=Object.values(E);for(i=0;i<t.events.length;i++)if(t.events[i].actions&&t.events[i].actions.indexOf(e)>=0&&(!t.events[i].trigger.conditions||0===t.events[i].trigger.conditions.length)){n.splice(n.indexOf(E.WIN),1),n.splice(n.indexOf(E.LOSE),1);break}return n}},wn={baseType:I.ENUM,values:f.SpacecraftCommand},Vn={baseType:I.ENUM,values:f.JumpCommandWay},Fn={baseType:I.ENUM,values:g.FormationType},Un={baseType:I.OBJECT,name:"SpacecraftFormation",getPreviewText:function(e){return e.type+(e.spacing?" ("+e.spacing.join(", ")+")":"")},properties:{TYPE:{name:"type",type:Fn},SPACING:{name:"spacing",type:I.VECTOR3}}},Bn=function(e){return e.way!==f.JumpCommandWay.OUT},Hn=function(e){return Bn(e)&&!!e.anchor},Gn=function(e){return Hn(e)&&!e.position},jn=function(e){return Hn(e)&&void 0===e.distance},kn=function(e){return Hn(e)&&!!e.position},Wn=function(e){return Hn(e)&&!!e.fallbackPosition},Yn={baseType:I.OBJECT,name:"JumpCommandParams",getPreviewText:function(t){return(t.way||"")+(t.anchor?" ("+(t.distance?e.getLengthString(t.distance)+" from ":"")+t.anchor+")":"")},properties:{WAY:{name:"way",type:Vn,optional:!0,defaultText:"automatic",description:"Whether to jump out or in. If not given, spacecrafts which are present will jump out and spacecrafts that are away will jump in."},FORMATION:{name:"formation",type:Un,optional:!0,defaultText:"none",isValid:Bn,description:"The subject spacecrafts will jump in arranged in this formation."},ANCHOR:{name:"anchor",type:Zi,optional:!0,defaultText:"none",isValid:Bn,description:"The spacecraft to jump in relative to."},DISTANCE:{name:"distance",type:H,optional:!0,isValid:Gn,description:"The subjects will jump in facing towards the anchor this distance away from it in a random direction."},POSITION:{name:"position",type:I.VECTOR3,optional:!0,isValid:jn,description:"This position will be added to the anchor's position to set the jump in coordinates."},ROTATIONS:{name:"rotations",type:I.ROTATIONS,optional:!0,isValid:kn,description:"The subject spacecrafts will be rotated accordingly for the jump."},RELATIVE:{name:"relative",type:I.BOOLEAN,defaultValue:!1,isValid:Hn,description:"If set, the given position and rotations will be rotated according to where the anchor is facing."},FALLBACK_POSITION:{name:"fallbackPosition",type:I.VECTOR3,optional:!0,isValid:Hn,description:"If the anchor is destroyed, this position will be used to place the spacecrafts for inward jump. It is not a universal position, but approximately relative to the camera."},FALLBACK_ROTATIONS:{name:"fallbackRotations",type:I.ROTATIONS,optional:!0,isValid:Wn,description:"If the fallback position is used to place the spacecrafts, these rotations will also be applied to them."}}},Xn={baseType:I.OBJECT,name:"TargetCommandParams",getPreviewText:function(e){var t;return e.single?t=e.single:e.list?t=e.list.length<4?e.list.join(", "):"list ("+e.list.length+")":e.squads?t=e.squads.length<4?e.squads.join(", "):e.squads.length+" squads":e.none&&(t="none"),e.priority&&(t+="!"),t},properties:{SINGLE:{name:"single",type:Zi,optional:!0},LIST:{name:"list",type:O(Zi),optional:!0},SQUADS:{name:"squads",type:O($i),optional:!0},NONE:{name:"none",type:I.BOOLEAN,optional:!0},PRIORITY:{name:"priority",type:I.BOOLEAN,optional:!0}}},qn={baseType:I.OBJECT,name:"ReachDistanceCommandParams",getPreviewText:function(e){var t="";return e.minDistance&&(t+=e.minDistance+" m < "),t+="distance",e.target&&(t+=" to "+e.target),e.maxDistance&&(t+=" < "+e.maxDistance+" m"),t},properties:{TARGET:{name:"target",type:Zi},MIN_DISTANCE:{name:"minDistance",type:G,optional:!0},MAX_DISTANCE:{name:"maxDistance",type:G,optional:!0}}},zn={baseType:I.ENUM,values:S.HUDSection},Jn={baseType:I.ENUM,values:S.HUDSectionState},Qn={baseType:I.ENUM,getValues:function(t,i,n){var s=a.MISSION.PREFIX.name+e.getFilenameWithoutExtension(n)+a.MISSION.MESSAGES_SUFFIX.name,o=s.length;return a.getKeys(s).map(function(e){return e.substring(o)})}},Kn=function(e,t){return!!t&&t.type===E.MESSAGE},Zn=function(e,t){return Kn(0,t)&&!e.permanent},$n=function(e,t){return Kn(0,t)&&void 0===e.duration},es=function(e,t){return!!t&&t.type===E.COMMAND},ts=function(e,t){return!!t&&t.type===E.SET_PROPERTIES},is=function(e,t){return!!t&&t.type===E.SET_PROPERTIES||t.type===E.REPAIR||t.type===E.DAMAGE},ns=function(e,t){return es(0,t)&&e.command===f.SpacecraftCommand.JUMP},ss=function(e,t){return es(0,t)&&e.command===f.SpacecraftCommand.TARGET},os=function(e,t){return es(0,t)&&e.command===f.SpacecraftCommand.REACH_DISTANCE},rs=function(e,t){return!!t&&t.type===E.HUD},as=function(t,i,n){var s=a.MISSION.PREFIX.name+e.getFilenameWithoutExtension(n)+a.MISSION.MESSAGES_SUFFIX.name;return!!i&&i.type===E.MESSAGE&&a.getKeys(s).length>0},ls=function(e,t,i){return Kn(0,t)&&!as(0,t,i)},cs=function(e){return e.length>0?e.substr(0,12)+(e.length>12?"...":""):"..."},hs=function(e,t){var i=[];return t=t||"=",void 0!==e.hull&&i.push("hull"+t+e.hull+"%"),void 0!==e.shield&&i.push("shield"+t+e.shield+"%"),void 0!==e.team&&i.push("team"+t+e.team),void 0!==e.disableFiring&&i.push((e.disableFiring?"disable":"enable")+" firing"),i.join(", ")},us=function(t,i,n){if(t.textID)return a.get(a.MISSION.PREFIX,e.getFilenameWithoutExtension(n)+a.MISSION.MESSAGES_SUFFIX.name+t.textID)},ds=function(){return o.gHS(o.BS.HUD.MESSAGE_TEXT).colors.default},ps={baseType:I.OBJECT,name:"ActionParams",getPreviewText:function(e){if(void 0!==e.text||void 0!==e.textID)return"message: "+(e.text?'"'+cs(e.text)+'"':e.textID?e.textID:"");if(void 0!==e.command){if(e.jump&&e.jump.way)return e.command+" "+e.jump.way;if(e.target)return e.command+" "+Xn.getPreviewText(e.target,e);if(e.reachDistance){if(e.reachDistance.minDistance)return e.reachDistance.maxDistance?"get to "+e.reachDistance.minDistance+"-"+e.reachDistance.maxDistance+" m from "+e.reachDistance.target:"get away to "+e.reachDistance.minDistance+" m from "+e.reachDistance.target;if(e.reachDistance.maxDistance)return"approach "+e.reachDistance.target+" to "+e.reachDistance.maxDistance+" m"}return e.command}return void 0!==e.hull||void 0!==e.shield||void 0!==e.team||void 0!==e.disableFiring?hs(e,": "):void 0!==e.state?"HUD: "+(e.section?e.section+" ":"")+e.state:"none"},properties:{TEXT:{name:"text",type:w,newValue:"Test",isRequired:ls,isValid:Kn,getDerivedDefault:us,updateOnValidate:!0},TEXT_ID:{name:"textID",type:Qn,isRequired:as,isValid:as},SOURCE:{name:"source",type:Zi,optional:!0,defaultText:"none",isValid:Kn},DURATION:{name:"duration",type:Q,optional:!0,defaultText:"automatic",isValid:Zn},PERMANENT:{name:"permanent",type:I.BOOLEAN,defaultValue:!1,isValid:$n},URGENT:{name:"urgent",type:I.BOOLEAN,defaultValue:!1,isValid:Kn},TYPEWRITER:{name:"typewriter",type:I.BOOLEAN,defaultValue:!0,isValid:Kn},SILENT:{name:"silent",type:I.BOOLEAN,defaultValue:!1,isValid:Kn},NO_BACKGROUND:{name:"noBackground",type:I.BOOLEAN,defaultValue:!1,isValid:Kn},COLOR:{name:"color",type:I.COLOR4,getDerivedDefault:ds,isValid:Kn},COMMAND:{name:"command",type:wn,isRequired:es,isValid:es},JUMP:{name:"jump",type:Yn,optional:!0,isValid:ns},TARGET:{name:"target",type:Xn,optional:!0,isValid:ss},REACH_DISTANCE:{name:"reachDistance",type:qn,optional:!0,isValid:os},HULL:{name:"hull",type:le,optional:!0,defaultText:"unchanged",isValid:is},SHIELD:{name:"shield",type:le,optional:!0,defaultText:"unchanged",isValid:is},TEAM:{name:"team",type:en,optional:!0,defaultText:"unchanged",isValid:ts},DISABLE_FIRING:{name:"disableFiring",type:I.BOOLEAN,optional:!0,defaultText:"unchanged",isValid:ts},SECTION:{name:"section",type:zn,optional:!0,isValid:rs},STATE:{name:"state",type:Jn,isRequired:rs,isValid:rs}}},_s=function(e){return e.type===E.COMMAND||e.type===E.SET_PROPERTIES||e.type===E.REPAIR||e.type===E.DAMAGE},gs=function(e){return[E.MESSAGE,E.COMMAND,E.SET_PROPERTIES,E.REPAIR,E.DAMAGE,E.HUD].indexOf(e.type)>=0},ms={baseType:I.OBJECT,name:"Action",getName:function(t){var i="";if(t.delay&&(i=e.getTimeString(t.delay)+" | "),t.type)switch(t.type){case E.MESSAGE:t.params&&(i+=ps.getPreviewText(t.params,t));break;case E.COMMAND:t.subjects&&t.params?i=i+tn.getPreviewText(t.subjects,t)+": "+ps.getPreviewText(t.params,t):i+=t.type;break;case E.HUD:t.params&&(i+=ps.getPreviewText(t.params,t));break;case E.SET_PROPERTIES:t.params||(i+="set properties"),i=i+(t.subjects?tn.getPreviewText(t.subjects,t):"set")+":"+hs(t.params);break;case E.REPAIR:t.params||(i+="repair"),i=i+(t.subjects?tn.getPreviewText(t.subjects,t):"repair")+":"+hs(t.params,"+");break;case E.DAMAGE:t.params||(i+="damage"),i=i+(t.subjects?tn.getPreviewText(t.subjects,t):"damage")+":"+hs(t.params,"-");break;default:i+=t.type}else i+="action";return i},properties:{TYPE:{name:"type",type:Pn},DELAY:{name:"delay",type:J,defaultValue:0},SUBJECTS:{name:"subjects",type:tn,isRequired:_s,isValid:_s},PARAMS:{name:"params",type:ps,isRequired:gs,isValid:gs,updateOnValidate:!0}}},fs={baseType:I.OBJECT,name:"MissionEvent",getName:function(e){if(e.name)return e.name;if(e.actions&&e.actions.length>0&&e.actions[0].type===E.WIN)return"win";if(e.actions&&e.actions.length>0&&e.actions[0].type===E.LOSE)return"lose";if(e.trigger&&(!e.trigger.conditions||0===e.trigger.conditions.length))return"start";if(e.actions){if(e.actions.length>1)return e.trigger&&e.trigger.conditions&&1===e.trigger.conditions.length?In.getPreviewText(e.trigger.conditions[0]):e.actions.length+" actions";if(1===e.actions.length)return ms.getName(e.actions[0])}return"event"},properties:{NAME:{name:"name",type:I.STRING,optional:!0},TRIGGER:{name:"trigger",type:Dn,updateOnValidate:!0},ACTIONS:{name:"actions",type:O(ms)}}},Ss={baseType:I.ENUM,values:l.SceneViewLookAtMode},Ts={baseType:I.OBJECT,name:"SceneView",properties:{NAME:{name:"name",type:I.STRING},FOV:{name:"fov",type:$,getDerivedDefault:o.getDefaultCameraFOV},FOV_RANGE:{name:"fovRange",type:I.RANGE,optional:!0,defaultText:"fixed"},SPAN:{name:"span",type:H,getDerivedDefault:o.getDefaultCameraSpan},FPS:{name:"fps",type:I.BOOLEAN,defaultValue:!1},BASE_ORIENTATION:{name:"baseOrientation",type:$t,getDerivedDefault:o.getDefaultCameraBaseOrientation,isValid:ii},POINT_TO_FALLBACK:{name:"pointToFallback",type:ei,optional:!0},MOVABLE:{name:"movable",type:I.BOOLEAN},TURNABLE:{name:"turnable",type:I.BOOLEAN},ALPHA_RANGE:{name:"alphaRange",type:b(!0,!0,$),optional:!0,defaultText:"unlimited",isValid:hi},BETA_RANGE:{name:"betaRange",type:b(!0,!0,ne),defaultValue:[-90,90],isValid:hi},CONFINES:{name:"confines",type:I.CONFINES,optional:!0},RESETS_WHEN_LEAVING_CONFINES:{name:"resetsWhenLeavingConfines",type:I.BOOLEAN,optional:!0},POSITION:{name:"position",type:I.VECTOR3},ROTATIONS:{name:"rotations",type:I.ROTATIONS,optional:!0},EXCLUDE_FROM_CYCLE:{name:"excludeFromCycle",type:I.BOOLEAN,optional:!0},TURN_AROUND_ALL:{name:"turnAroundAll",type:I.BOOLEAN,defaultValue:!1},LOOK_AT:{name:"lookAt",type:Ss},DISTANCE_RANGE:{name:"distanceRange",type:I.RANGE,optional:!0},STARTS_WITH_RELATIVE_POSITION:{name:"startsWithRelativePosition",type:I.BOOLEAN,optional:!0}}},ys={baseType:I.ENUM,values:e.getEnumObject(f.getAITypes())},Es={name:"loadout",baseType:I.ENUM,getValues:function(e){var t;return e.class?(t=l.getSpacecraftClass(e.class),t.getLoadoutNames()):[]}},Cs={baseType:I.NUMBER,integer:!0,min:1,max:9},Ms=function(e){return!e.count||1===e.count},Is=function(e){return e.count&&e.count>1},As=function(e){return Ms(e)&&!e.away},xs=function(e){return Is(e)&&!e.away},vs=function(e){return Is(e)&&!e.loadout&&!e.equipment},Os=function(e){return!e.loadouts||0===e.loadouts.length},Rs=function(e){return Os(e)&&!e.equipment},bs=function(e){return Os(e)&&!e.loadout},Ls=function(e){var t;if(e.class)return t=l.getSpacecraftClass(e.class),t._defaultLoadout||"none"},Ns=function(e){return!e.piloted&&!e.pilotedIndex},Ds=function(e){return!e.piloted},Ps=function(e){return Is(e)&&!e.position&&!e.formation},ws=function(e){return!e.positions},Vs=function(e){return e.count&&ws(e)},Fs=function(e){return Is(e)&&void 0!==e.initialBlinkTime},Us={baseType:I.OBJECT,name:"Spacecraft",getName:function(e){return e.name||(e.squad||e.class)+(e.count?" ("+e.count+")":"")},getColor:function(e){return e.away?"#666666":void 0},properties:{NAME:{name:"name",type:I.STRING,optional:!0,isValid:Ms},SQUAD:{name:"squad",type:I.STRING,optional:!0,getSuggestions:function(){return a.getKeys("squad").map(function(e){return e.substring(6)})},defaultText:"none",description:"\nIf 'count' is set: the name of the squad, or one of the automatically translated squad IDs (as suggested)\nFor single ships: the name of the squad to add the ship to and the squad index separated by a space. e.g. 'Alpha 5'"},TEAM:{name:"team",type:en,optional:!0},CLASS:{name:"class",type:Oe},AI:{name:"ai",type:ys,optional:!0,defaultText:"none",isValid:Ds,description:"The type of AI that should control this station.\nfighter: attacks the target head on, does charge attacks and evasive maneuvers if it gets hit\nship: approaches to weapon range and then turns according to the attack vector of the spacecraft class to attack the target with rotating weapons\nstation: does not move or turn, just attacks with its rotating weapons\nsentry: does not move, but turns according to its attack vector and attacks if the target comes within range"},POSITION:{name:"position",type:I.VECTOR3,optional:!0,isValid:ws,defaultValue:[0,0,0]},ROTATIONS:{name:"rotations",type:I.ROTATIONS,optional:!0},LOADOUT:{name:"loadout",type:Es,isValid:Rs,getDerivedDefault:Ls,updateOnValidate:!0},EQUIPMENT:{name:"equipment",type:Ri,optional:!0,isValid:bs,defaultText:"from loadout",updateOnValidate:!0},AWAY:{name:"away",type:I.BOOLEAN,defaultValue:!1,isValid:Ns},PILOTED:{name:"piloted",type:I.BOOLEAN,defaultValue:!1,isValid:As},INITIAL_TARGET:{name:"initialTarget",type:Zi,optional:!0},EXCLUDE_FROM_REFERENCE_SCORE:{name:"excludeFromReferenceScore",type:I.BOOLEAN,defaultValue:!1,isValid:Ns},INITIAL_BLINK_TIME:{name:"initialBlinkTime",type:J,optional:!0,defaultText:"random"},COUNT:{name:"count",type:Cs,optional:!0,defaultText:"single ship"},NAMES:{name:"names",type:D,optional:!0,isValid:Is},LOADOUTS:{name:"loadouts",type:O(Es),optional:!0,isValid:vs,updateOnValidate:!0},PILOTED_INDEX:{name:"pilotedIndex",type:Cs,optional:!0,isValid:xs},POSITIONS:{name:"positions",type:O(I.VECTOR3),optional:!0,isValid:Ps},FORMATION:{name:"formation",type:Un,optional:!0,isValid:Vs},INITIAL_BLINK_TIME_DELTA:{name:"initialBlinkTimeDelta",type:z,optional:!0,defaultText:"0",isValid:Fs}}},Bs={baseType:I.SET,values:[]},Hs={TITLE:{name:"title",type:I.STRING,optional:!0},DESCRIPTION:{name:"description",type:w},NEXT_MISSION:{name:"nextMission",type:Ue,optional:!0},TIPS:{name:"tips",type:Bs,optional:!0},ENVIRONMENT:{name:"environment",type:Fe},ANTICIPATION_THEME:{name:"anticipationTheme",type:Me,optional:!0},COMBAT_THEME:{name:"combatTheme",type:Me,optional:!0},TEAMS:{name:"teams",type:O(Qi,void 0,function(e){if(e.length>0&&e.length<=2)return"["+e.map(Qi.getName).join(", ")+"]"}),optional:!0},EVENTS:{name:"events",type:O(fs),optional:!0},VIEWS:{name:"views",type:O(Ts),optional:!0},SPACECRAFTS:{name:"spacecrafts",type:O(Us)}};return Type.prototype.hasNameProperty=function(){var e,t;if(!this._descriptor.properties)return!1;if(this._descriptor.getName)return!0;for(e=Object.keys(this._descriptor.properties),t=0;t<e.length;t++)if(this._descriptor.properties[e[t]].name===L)return!0;return!1},Type.prototype.getInstanceName=function(e){return this._descriptor.getName?this._descriptor.getName(e):e[L]},Type.prototype.getInstanceColor=function(e){if(this._descriptor.getColor)return this._descriptor.getColor(e)},Type.prototype.getName=function(){return this._descriptor.name},Type.prototype.getDescriptor=function(){return this._descriptor},Type.prototype.getDisplayName=function(){return this._descriptor.name?this._descriptor.name:this._descriptor.resourceReference?this._descriptor.resourceReference:this._descriptor.classReference?this._descriptor.classReference:this._descriptor.environmentReference?this._descriptor.environmentReference:this._descriptor.missionReference?this._descriptor.missionReference:this._descriptor.baseType},Type.prototype.getPreviewText=function(e,t){var i;return this._descriptor.baseType===I.ARRAY?(this._descriptor.getPreviewText&&(i=this._descriptor.getPreviewText(e,t)),i||(i=0===e.length?"empty list":1===e.length&&this._descriptor.elementType.getName?"["+this._descriptor.elementType.getName(e[0])+"]":1===e.length&&"string"==typeof e[0]?"["+e[0]+"]":e.length<=3&&"number"==typeof e[0]?"["+e.join(", ")+"]":this.getElementType().getDisplayName()+" ["+e.length+"]"),i):this._descriptor.getPreviewText?this._descriptor.getPreviewText(e,t):this._descriptor.name},Type.prototype.getBaseType=function(){return this._descriptor.baseType},Type.prototype.getUnit=function(){return this._descriptor.unit},Type.prototype.getMin=function(){return this._descriptor.min},Type.prototype.getMax=function(){return this._descriptor.max},Type.prototype.isInteger=function(){return!!this._descriptor.integer},Type.prototype.getFixedLength=function(){return this._descriptor.fixedLength},Type.prototype.getMinLength=function(){return this._descriptor.minLength},Type.prototype.getMaxLength=function(){return this._descriptor.maxLength},Type.prototype.isItemReference=function(){return!!(this._descriptor.resourceReference||this._descriptor.classReference||this._descriptor.environmentReference||this._descriptor.missionReference)},Type.prototype.getResourceReference=function(){return this._descriptor.resourceReference},Type.prototype.getClassReference=function(){return this._descriptor.classReference},Type.prototype.getEnvironmentReference=function(){return this._descriptor.environmentReference},Type.prototype.getMissionReference=function(){return this._descriptor.missionReference},Type.prototype.getReferenceItemType=function(){return this.getResourceReference()?T.ItemType.RESOURCE:this.getClassReference()?T.ItemType.CLASS:this.getEnvironmentReference()?T.ItemType.ENVIRONMENT:this.getMissionReference()?T.ItemType.MISSION:T.ItemType.NONE},Type.prototype.getReferenceItemCategory=function(){return this._descriptor.resourceReference||this._descriptor.classReference||this._descriptor.environmentReference||this._descriptor.missionReference},Type.prototype.isLong=function(){return this._descriptor.long},Type.prototype.getValues=function(t,i,n,o){var r;return this._descriptor.values?(r=e.getEnumValues(this._descriptor.values),"number"==typeof r[0]?e.getEnumKeys(this._descriptor.values):r):this._descriptor.getValues?this._descriptor.getValues(i,n,o):this._descriptor.resourceReference?s.getResourceNames(this._descriptor.resourceReference):this._descriptor.classReference?l.getClassNames(this._descriptor.classReference):this._descriptor.environmentReference?c.getEnvironmentNames():this._descriptor.missionReference?h.getMissionNames():t?null:void document.crash()},Type.prototype.getProperties=function(){return this._descriptor.properties},Type.prototype.getValidKeys=function(){return this._descriptor.validKeys},Type.prototype.getElementType=function(){return new Type(this._descriptor.elementType)},Type.prototype.getFirstType=function(){return new Type(this._descriptor.first.type)},Type.prototype.getSecondType=function(){return new Type(this._descriptor.second.type)},r.executeWhenReady(function(){Ye.validKeys=r.getShaderComplexities().concat(Ye.validKeys)}),h.executeWhenReady(function(){Bs.values=h.getTipIDs()}),{BaseType:I,Unit:A,ThrusterUse:v,NAME_PROPERTY_NAME:L,BASED_ON_PROPERTY_NAME:N,AXIS:He,itemDescriptors:{textures:je,cubemaps:We,shaders:ze,models:Ke,soundEffects:Ze,music:$e,skyboxClasses:et,backgroundObjectClasses:it,dustCloudClasses:nt,explosionClasses:pt,projectileClasses:ft,missileClasses:Rt,weaponClasses:Pt,propulsionClasses:wt,sensorsClasses:Vt,jumpEngineClasses:kt,shieldClasses:Wt,spacecraftTypes:Xt,spacecraftClasses:Ui,environments:Yi,missions:Hs},Type:Type,getPropertyValues:getPropertyValues}}),define("editor/properties",["utils/utils","modules/application","armada/configuration","editor/descriptors","editor/common"],function(e,t,i,n,s){"use strict";function _updateBasedOn(){var e=r.data[n.BASED_ON_PROPERTY_NAME]?s.getItemReference({type:r.type,category:r.category,name:r.data[n.BASED_ON_PROPERTY_NAME]}):null;return e!==a&&(a=e,!0)}function _updateData(e){var t,i;for(r.reference.reloadData(),t=s.getItemReferencesOfSameCategory(r),i=0;i<t.length;i++)t[i].getData()[n.BASED_ON_PROPERTY_NAME]===r.data[n.NAME_PROPERTY_NAME]&&t[i].reloadData();_updateBasedOn()&&(o.innerHTML="",_(o,r,l,c)),l&&l.handleDataChanged(e)}function _changeData(e,t,i,n,s){i?i[n]=t:r.data[e]=t,s&&s(t),_updateData(e)}function _createBooleanControl(e,t,i,n,o){return s.createBooleanInput(t,function(t){_changeData(e,t,i,n,o)})}function _createStringControl(e,t,i,n,o,r){var a,l,c,h,u=document.createElement("input");if(u.type="text",u.className=s.STRING_INPUT_CLASS,u.value=t,u.onchange=function(){_changeData(e,u.value,i,n,r)},o){for(c="dl-"+e+"-"+n,a=document.getElementById(c),a?a.innerHTML="":(a=document.createElement("datalist"),a.id=c),h=0;h<o.length;h++)l=document.createElement("option"),l.value=o[h],l.textContent=o[h],a.appendChild(l);document.body.appendChild(a),u.setAttribute("list",c)}return u}function _createPopup(e,t,i,n,o){return new s.Popup(e,t,{show:function(){l&&!t&&l.handleStartEdit(i,0),n&&n()},hide:function(){l&&!t&&l.handleStopEdit(i),o&&o()},removeHide:function(){l&&!t&&l.handleStopEdit(i)}})}function _getStringPreview(e){return e.length>0?e.substr(0,C)+(e.length>C?"...":""):"..."}function _createLongStringControl(e,t,i,n,o,r){var a,l,c=document.createElement("textarea");return a=s.createButton(_getStringPreview(t),function(){l.toggle()}),l=_createPopup(a,o,e,null,function(){_changeData(e,c.value,i,n,r),a.textContent=_getStringPreview(c.value),o&&o.alignPosition()}),c.value=t,c.cols=E,c.rows=y,c.spellcheck=!1,c.autocomplete="off",c.autocorrect="off",c.autocapitalize="off",l._element.appendChild(c),l.addToPage(),a.popup=l,a}function _createNumberControl(e,t,i,n,o,r,a,l,c){var h=document.createElement("div"),u=s.createNumericInput(t,{integer:i,min:l,max:c},function(t){_changeData(e,t,o,r,n)});return h.appendChild(u),a&&h.appendChild(s.createLabel(a)),h}function _createEnumControl(e,t,i,n,o,r){var a=s.createSelector(t,i,!1,function(t){_changeData(e,a?a.value:t,n,o,r)});return a}function _createColorControl(e,t){return s.createColorPicker(t,function(){_updateData(e)})}function _createVectorControl(e,t){return s.createVectorEditor(t,function(){_updateData(e)})}function _createRangeControl(e,t,i){return"object"!=typeof t&&(t={}),s.createRangeEditor(i,t,function(){_updateData(e)})}function _getDefaultValue(t,i,o,a,l,c,h,u,d,p){var _,g,m,f,S,T,y;if(g=new n.Type(t.type),T=t.optional||t.isRequired&&!t.isRequired(o,a,r.name),t.name===n.NAME_PROPERTY_NAME&&u&&g.getBaseType()===n.BaseType.STRING)return void 0!==d?u+" "+(d+1).toString():j+u;if(!(c&&T&&void 0===t.defaultValue&&void 0===t.getDerivedDefault||h&&(T||void 0!==t.defaultValue||void 0!==t.getDerivedDefault))){if(i)return _=e.deepCopy(i.getData()[t.name]),void 0===_?_getDefaultValue(t,i.getData()[n.BASED_ON_PROPERTY_NAME]?s.getItemReference({type:r.type,category:r.category,name:i.getData()[n.BASED_ON_PROPERTY_NAME]}):null,null,null,l,c,h):_;if(t.newValue)return e.deepCopy(t.newValue);if(t.defaultValue)return e.deepCopy(t.defaultValue);switch(g.getBaseType()){case n.BaseType.BOOLEAN:return!1;case n.BaseType.NUMBER:return void 0!==g.getMin()?Math.max(g.getMin(),0):0;case n.BaseType.STRING:return"";case n.BaseType.ARRAY:for(_=[],y=0,g.getFixedLength()?y=g.getFixedLength():g.getMinLength()&&(y=g.getMinLength());y>0;)_.push(_getDefaultValue({type:t.type.elementType},null,_,o,l,!0)),y--;return _;case n.BaseType.PAIRS:case n.BaseType.ROTATIONS:case n.BaseType.SET:return[];case n.BaseType.OBJECT:for(_={},m=g.getProperties(),f=Object.keys(m),S=0;S<f.length;S++)_[m[f[S]].name]=_getDefaultValue(m[f[S]],null,_,o,l,!0,!0,g._name,p?void 0:d,void 0!==d);return _;case n.BaseType.ENUM:return n.getPropertyValues(t,o,l,r?r.name:null)[0];case n.BaseType.COLOR3:case n.BaseType.VECTOR3:return[0,0,0];case n.BaseType.COLOR4:return[0,0,0,1];case n.BaseType.RANGE:return[0,0];case n.BaseType.CONFINES:return[[0,0],[0,0],[0,0]];case n.BaseType.ASSOCIATIVE_ARRAY:return{}}document.crash()}}function getDefaultItemData(e,t,i,s){var o,a,l={},c=Object.keys(e);for(r={type:i,name:t,category:s,reference:null,data:null},o=0;o<c.length;o++)a=e[c[o]],a.name===n.NAME_PROPERTY_NAME?l[a.name]=t:l[a.name]=_getDefaultValue(a,null,l,null,null,!0,!0);return l}function _addPropertyEditorHeader(e,t,i){var n,s=document.createElement("div");for(s.classList.add(f),n=0;n<t.length;n++)s.appendChild(t[n]);for(n=0;n<i.length;n++)i[n].classList.add(S),s.appendChild(i[n]);s.onmousedown=function(t){var i;"DIV"!==t.target.tagName&&"SPAN"!==t.target.tagName||(i=new MouseEvent("mousedown",{screenX:t.screenX,screenY:t.screenY}),e._element.dispatchEvent(i))},e._element.appendChild(s)}function _createObjectControl(t,i,o,r,a,c,h,u,d){var _,g,m,f,S,T,y,E,C,I,A,x,v,O,R,b,j,W,Y,X=document.createElement("button"),q=_createPopup(X,h,t),z=r instanceof Array,J=new n.Type(o),Q=d?d.getMinLength()||0:0,K=d?d.getMaxLength()||0:0;if(x=function(e){var t=e>=0&&r[e]?J.getInstanceName(r[e]):"";return(e+1).toString()+(t?": "+t:"")},v=function(e){return e>=0&&r[e]?J.getInstanceColor(r[e]):void 0},j=function(){return s.setSelectorOptions(f,r.map(function(e,t){return S=v(t),S?{value:x(t),color:S}:x(t)}))},Y=function(e){f.options[e].text=x(e),f.options[e].style.color=v(e)||"inherit"},O=function(e){A=p(q._element,void 0===e?r:r[e],o.properties,t,a,c,q,W)},R=function(){var e=f.selectedIndex;q.hideChildren(),A&&(q._element.removeChild(A),A=null),e>=0?(l&&!h&&l.handleStartEdit(t,e),O(e),m.textContent=o.name,f.hidden=!1,T.hidden=!!K&&r.length>=K,y.hidden=r.length<=Q,I.hidden=!1,E.hidden=r.length<2||0===e,C.hidden=r.length<2||e===r.length-1):(m.textContent=M,f.hidden=!0,T.hidden=!1,y.hidden=!0,I.hidden=!0,E.hidden=!0,C.hidden=!0),q.alignPosition()},b=function(){X.textContent=(d?d.getPreviewText(r,a):J.getPreviewText(r,a))||"...",h&&h.alignPosition()},W=function(){b(),f&&f.selectedIndex>=0&&Y(f.selectedIndex),u&&u()},z){if(o.unpack)for(_=0;_<r.length;_++)"string"==typeof r[_]&&(r[_]=o.unpack(r[_]));for(g=[];g.length<r.length;)S=v(g.length),g.push(S?{value:x(g.length),color:S}:x(g.length));m=s.createLabel(r.length>0?o.name:M),f=s.createSelector(g,g[0],!1,R),T=s.createButton({class:L},function(){var e;r.push(_getDefaultValue({type:o},null,null,null,c,!0,void 0,void 0,r.length)),e=document.createElement("option"),e.value=x(r.length-1),e.text=e.value,e.style.color=v(r.length-1),f.add(e),_updateData(t),f.selectedIndex=r.length-1,W(),R()},e.formatString(N,{element:o.name})),y=s.createButton({class:B},function(){l&&!h&&l.handleStopEdit(t),r.splice(f.selectedIndex,1),_updateData(t),j(),W(),R()},e.formatString(H,{element:o.name})),I=s.createButton({class:D},function(){var i;r.push(e.deepCopy(r[f.selectedIndex])),J.hasNameProperty()&&r[r.length-1][n.NAME_PROPERTY_NAME]&&(r[r.length-1][n.NAME_PROPERTY_NAME]+=k),i=document.createElement("option"),i.value=x(r.length-1),i.text=i.value,i.style.color=v(r.length-1),f.add(i),_updateData(t),f.selectedIndex=r.length-1,W(),R()},e.formatString(P,{element:o.name})),E=s.createButton({class:w},function(){r.splice(f.selectedIndex-1,2,r[f.selectedIndex],r[f.selectedIndex-1]),b(),_updateData(t),Y(f.selectedIndex),Y(f.selectedIndex-1),f.selectedIndex-=1,R()},e.formatString(V,{element:o.name})),C=s.createButton({class:F},function(){r.splice(f.selectedIndex,2,r[f.selectedIndex+1],r[f.selectedIndex]),b(),_updateData(t),Y(f.selectedIndex),Y(f.selectedIndex+1),f.selectedIndex+=1,R()},e.formatString(U,{element:o.name})),_addPropertyEditorHeader(q,[m,f],d&&d.getFixedLength()?[E,C]:[T,I,E,C,y]),r.length>0?O(0):(f.hidden=!0,E.hidden=!0,C.hidden=!0,y.hidden=!0)}else O();return q.addToPage(),X.type="button",b(),X.edit=function(e){void 0===e?q.toggle():e<0?q.hide():q.show(),!z||void 0!==e&&e===f.selectedIndex||(f.selectedIndex=e||0,q.isVisible()&&R()),b()},X.onclick=function(){X.edit()},X.popup=q,X.title=e.formatString(G,{property:i}),X}function _addRow(e,t){var i,n,s;for(i=document.createElement("tr"),s=0;s<t.length;s++)t[s]&&(n=document.createElement("td"),n.appendChild(t[s]),i.appendChild(n));e.appendChild(i)}function _setPopupTogglerButton(e,t,i){e.type="button",e.innerHTML=t,e.onclick=function(){i.toggle()}}function _createArrayControl(e,t,i,o,r,a,l,c){var h,u,p,_,g,m=new n.Type(t),f=c.getMinLength()||0,S=c.getMaxLength()||0,T=document.createElement("button"),y=_createPopup(T,a,e),E=function(){h.textContent=i.length>0?m.getDisplayName()+" list":M},C=function(){T.innerHTML=c.getPreviewText(i,o)||"...",a&&a.alignPosition()},I=function(){C(),l&&l()},A=function(n){var l=[s.createLabel((n+1).toString()),d({name:n,type:t},i[n],e,i,o,null,r,a,I)];(0===f||i.length>f)&&l.push(s.createButton({class:B},function(){i.splice(n,1),E(),g(),y.alignPosition(),_updateData(e),I()})),_addRow(u,l)};return g=function(){for(u.innerHTML="",_=0;_<i.length;_++)A(_);p.hidden=S>0&&i.length>=S},p=s.createButton({class:L},function(){i.push(_getDefaultValue({type:t},null,o,null,r,!0)),E(),g(),y.alignPosition(),_updateData(e),I()}),h=s.createLabel(),E(),_addPropertyEditorHeader(y,[h],[p]),u=document.createElement("table"),g(),y._element.appendChild(u),y.addToPage(),_setPopupTogglerButton(T,"",y),C(),T.popup=y,T}function _createSetControl(e,t,i,o,r){var a,l,c=document.createElement("button"),h=_createPopup(c,o,e),u=new n.Type(t).getValues(!0)||[],d=new n.Type(t).getDisplayName(),p=function(){c.innerHTML=d+" ("+i.length+"/"+u.length+")",o&&o.alignPosition()},_=function(t,n){var s=i.indexOf(u[t]);n?-1===s&&i.push(u[t]):s>=0&&i.splice(s,1),_updateData(e),p(),r&&r()};for(a=document.createElement("table"),l=0;l<u.length;l++)_addRow(a,[s.createLabel(u[l].toString()),s.createBooleanInput(i.indexOf(u[l])>=0,_.bind(this,l))]);return h._element.appendChild(a),h.addToPage(),_setPopupTogglerButton(c,"",h),p(),c.popup=h,c}function _addPairRow(e,t,i,n){_addRow(e,[t,s.createLabel(":"),i,n])}function _createPairsControl(e,t,i,o,r){var a,l,c,h,u,p=document.createElement("button"),_=_createPopup(p,r,e),g=function(){a.textContent=i.length>0?"list of pairs":M},m=function(){p.innerHTML=new n.Type(t).getDisplayName()+" ("+i.length+")",r&&r.alignPosition()},f=function(n){_addPairRow(l,d({name:0,type:t.first.type},i[n][0],e,i[n],null,null,o,r),d({name:1,type:t.second.type},i[n][1],e,i[n],null,null,o,r),s.createButton({class:B},function(){i.splice(n,1),g(),m(),u(),_.alignPosition(),_updateData(e)}))};return u=function(){for(l.innerHTML="",_addPairRow(l,s.createLabel(t.first.name),s.createLabel(t.second.name)),c=0;c<i.length;c++)f(c)},h=s.createButton({class:L},function(){i.push([_getDefaultValue({type:t.first.type},null,null,null,o),_getDefaultValue({type:t.second.type},null,null,null,o)]),g(),m(),f(i.length-1),_.alignPosition(),_updateData(e)}),a=s.createLabel(),
g(),_addPropertyEditorHeader(_,[a],[h]),l=document.createElement("table"),u(),_._element.appendChild(l),_.addToPage(),_setPopupTogglerButton(p,"",_),m(),p.popup=_,p}function _createRotationsControl(e,t,i){var o,r,a,l,c=document.createElement("button"),h=_createPopup(c,i,e),u=function(){t.length>1?c.textContent=t.length+" rotations":1===t.length?c.textContent=t[0].axis+(t[0].degrees<0?" - ":" + ")+Math.abs(t[0].degrees)+"°":c.textContent="none",i&&i.alignPosition()},p=function(r){_addPairRow(o,d({name:"axis",type:n.AXIS},t[r].axis,e,t[r],null,null,null,i,u),d({name:"degrees",type:{baseType:n.BaseType.NUMBER,min:-360,max:360}},t[r].degrees,e,t[r],null,null,null,i,u),s.createButton({class:B},function(){t.splice(r,1),u(),l(),h.alignPosition(),_updateData(e)}))};for(l=function(){for(o.innerHTML="",_addPairRow(o,s.createLabel("axis"),s.createLabel("degrees")),r=0;r<t.length;r++)p(r)},a=s.createButton({class:L},function(){t.push({axis:_getDefaultValue({type:n.AXIS}),degrees:_getDefaultValue({type:n.BaseType.NUMBER})}),u(),p(t.length-1),h.alignPosition(),_updateData(e)}),r=0;r<t.length;r++)"string"==typeof t[r]&&(t[r]={axis:t[r][0].toUpperCase(),degrees:parseFloat(t[r].substring(1))});return _addPropertyEditorHeader(h,[s.createLabel("rotations")],[a]),o=document.createElement("table"),l(),h._element.appendChild(o),h.addToPage(),_setPopupTogglerButton(c,"",h),u(),c.popup=h,c}function _createConfinesControl(e,t,i){var o,r,a,l=document.createElement("button"),c=_createPopup(l,i,e);for(o=document.createElement("table"),r=0;r<t.length;r++){switch(r){case 0:a="X";break;case 1:a="Y";break;case 2:a="Z";break;default:a=r.toString()}_addRow(o,[s.createLabel(a),_createRangeControl(e,{elementType:{unit:n.Unit.METERS}},t[r])])}return c._element.appendChild(o),c.addToPage(),_setPopupTogglerButton(l,"Confines",c),l.popup=c,l}function _createAssocArrayControl(e,t,i,o,r,a){var l,c,h,u,p,_=document.createElement("button"),g=_createPopup(_,a,e),m=function(){var e,i=[];for(e=0;e<t.length;e++)o.hasOwnProperty(t[e])||i.push(t[e]);return i},f=function(){_.innerHTML=new n.Type(i).getDisplayName()+" ("+Object.keys(o).length+")",a&&a.alignPosition()},S=function(){var e,t,i;if(u){for(;u.options.length>0;)u.remove(0);for(i=m(),e=0;e<i.length;e++)t=document.createElement("option"),t.text=i[e],u.add(t);0===i.length?(u.hidden=!0,c.disabled=!0):(u.hidden=!1,c.disabled=!1)}},T=function(t){var n=Object.keys(o)[t];_addPairRow(l,s.createLabel(n),d({name:n,type:i},o[n],e,o,null,null,r,a),s.createButton({class:B},function(){delete o[n],f(),S(),p(),g.alignPosition(),_updateData(e)}))},y=function(){return t?u:h};return p=function(){var e,t=Object.keys(o);for(l.innerHTML="",e=0;e<t.length;e++)T(e)},t?u=s.createSelector(m(),void 0,!1,function(){c.disabled=0===u.value.length}):(h=document.createElement("input"),h.type="text",h.onchange=function(){c.disabled=0===h.value.length}),c=s.createButton({class:L},function(){o[y().value]=_getDefaultValue({type:i},null,null,null,r),f(),S(),p(),g.alignPosition(),_updateData(e)}),c.disabled=0===y().value.length,_addPropertyEditorHeader(g,[y()],[c]),l=document.createElement("table"),p(),g._element.appendChild(l),g.addToPage(),_setPopupTogglerButton(_,"",g),f(),_.popup=g,_}function _createDefaultControl(e){var t=document.createElement("span");return t.innerHTML=e.toString(),t.classList.add(m),t}function _createUnsetControl(e,t,i,o,l,c,h,u){var p,_,m,f,S,y,E=document.createElement("div"),C=new n.Type(e.type),M=!1;return E.title="",S=e.optional||e.isRequired&&!e.isRequired(i,o,r.name),(!i||i===r.data)&&a||i!==r.data&&i[n.BASED_ON_PROPERTY_NAME]?m=_createDefaultControl(I):void 0!==e.defaultValue||e.defaultText||e.getDerivedDefault?(p=A,e.defaultText?p=e.defaultText:(_=e.defaultValue,void 0===_&&e.getDerivedDefault&&(_=e.getDerivedDefault(i,o,r.name)),"number"==typeof _?(p=_.toString(),C.getUnit()&&(p+=" "+C.getUnit())):"boolean"==typeof _?p=_?"yes":"no":"string"==typeof _?(p=_,M=!0):Array.isArray(_)&&(0===_.length?p="empty list":"number"==typeof _[0]||"string"==typeof _[0]?(p=C.getBaseType()===n.BaseType.RANGE?_.map(function(e){var t=C.getElementType();return e+(t&&t.getUnit()?" "+t.getUnit():"")}).join(" - "):_.join(", "),e.type===n.BaseType.COLOR3||e.type===n.BaseType.COLOR4?(p=s.createColorPreview(_).outerHTML+p,M=!1):M=!0):"boolean"==typeof _[0]&&(p=_.map(function(e){return e?"yes":"no"}).join(", "),M=!0))),M&&p.length>25&&(E.title+=p+"\n",p=p.substring(0,22)+"..."),m=_createDefaultControl(p)):m=_createDefaultControl(S?C.getBaseType()===n.BaseType.ROTATIONS?v:x:O),m.classList.add(b),E.appendChild(m),y=function(){var n,s,r=E.parentNode;r&&(n=_getDefaultValue(e,a,i,o,l),r.removeChild(E),u&&u.classList.remove(g),s=d(e,n,t,i,null,o,l,c,h,u),r.appendChild(s),r.control=s,_changeData(t,n,i,e.name,h))},f=document.createElement("button"),f.type="button",f.innerHTML=R,f.className=T,f.onclick=y,E.appendChild(f),E.title+="Click to set property",E.onclick=y,u&&u.classList.add(g),E}function editProperty(e,i){u[e]?u[e](i):t.showError("Cannot edit property '"+e+"': no edit callback found!")}var o,r,a,l,c,h,u,d,p,_,g="unset",m="propertyControl",f="propertyEditorHeader",S="propertyEditorHeaderButton",T="setProperty",y=5,E=100,C=16,M="empty list",I="inherited",A="default",x="not set",v="none",O="unknown",R="set",b="withSetButton",L="add icon",N="Add a new {element} with default values",D="copy icon",P="Duplicate this {element}",w="up icon",V="Move this {element} up in the list",F="down icon",U="Move this {element} down in the list",B="delete icon",H="Delete this {element}",G="Toggle editing {property}",j="new",k="_copy";return d=function(e,t,i,o,l,c,u,d,p,_){var f,S,T,y,E,C,M=new n.Type(e.type);if(i=i||e.name,E=!!e.isRequired&&e.isRequired(o,c,r.name),C=e.optional||e.isRequired&&!e.isRequired(o,c,r.name),void 0===t)f=_createUnsetControl(e,i,o,c,u,d,p,_);else{switch(M.getBaseType()){case n.BaseType.BOOLEAN:f=_createBooleanControl(i,t,o,e.name,p);break;case n.BaseType.NUMBER:f=_createNumberControl(i,t,M.isInteger(),p,o,e.name,M.getUnit(),M.getMin(),M.getMax());break;case n.BaseType.STRING:f=M.isLong()?_createLongStringControl(i,t,o,e.name,d,p):_createStringControl(i,t,o,e.name,e.getSuggestions&&e.getSuggestions(),p);break;case n.BaseType.ENUM:S=_createEnumControl(i,n.getPropertyValues(e,l||o,u,r.name),t,o,e.name,p),S.classList.add(m),f=document.createElement("div"),f.appendChild(S),M.isItemReference()&&(S.classList.add("withJumpButton"),T=s.createButton("↷",function(){h(M.getReferenceItemType(),S.value,M.getReferenceItemCategory())},"Jump to referenced item"),T.classList.add("jumpReference"),f.appendChild(T));break;case n.BaseType.COLOR3:case n.BaseType.COLOR4:f=_createColorControl(i,t);break;case n.BaseType.VECTOR3:f=_createVectorControl(i,t);break;case n.BaseType.RANGE:f=_createRangeControl(i,e.type,t);break;case n.BaseType.PAIRS:f=_createPairsControl(i,e.type,t,u,d);break;case n.BaseType.ROTATIONS:f=_createRotationsControl(i,t,d);break;case n.BaseType.SET:f=_createSetControl(i,e.type,t,d,p);break;case n.BaseType.CONFINES:f=_createConfinesControl(i,t,d);break;case n.BaseType.ARRAY:y=M.getElementType(),f=y.getBaseType()===n.BaseType.OBJECT?_createObjectControl(i,e.name,y.getDescriptor(),t,o,u,d,p,M):_createArrayControl(i,y.getDescriptor(),t,o,u,d,p,M);break;case n.BaseType.ASSOCIATIVE_ARRAY:f=_createAssocArrayControl(i,M.getValidKeys(),M.getElementType().getDescriptor(),t,u,d);break;case n.BaseType.OBJECT:f=_createObjectControl(i,e.name,e.type,t,o,u,d,p);break;default:f=_createDefaultControl(t)}_&&_.classList.remove(g),E||!C&&void 0===e.defaultValue&&!e.getDerivedDefault&&(o&&o!==r.data||!a||e.name===n.NAME_PROPERTY_NAME)||o===r.data&&e.name===n.BASED_ON_PROPERTY_NAME||(S||(S=f,S.classList.add(m),f=document.createElement("div"),f.appendChild(S),f.popup=S.popup),f.classList.add("withUnsetButton"),T=s.createButton("x",function(){var t,n=f.parentNode;S.popup&&S.popup.remove(),n.removeChild(f),t=_createUnsetControl(e,i,o,c,u,d,p,_),t.classList.add(m),n.appendChild(t),n.control=t,_changeData(i,void 0,o,e.name,p)},"Unset property"),T.classList.add("unsetProperty"),f.appendChild(T))}return f.classList.add(m),f},p=function(e,t,i,s,o,l,c,h){var p,_,g,m,f,S;return f=function(e,h){var p,_,f,S,T,y=i[g[h]];f=document.createElement("td"),f.classList.add("propertyName"),f.innerHTML=y.name,f.title=y.name+(y.description?": "+y.description:""),e.appendChild(f),S=document.createElement("td"),p=!y.isValid||y.isValid(t,o,r.name),_=!!y.isRequired&&y.isRequired(t,o,r.name)||!y.optional&&void 0===y.defaultValue&&void 0!==y.getDerivedDefault,!p||e.required&&!_?delete t[y.name]:!_||void 0!==t[y.name]||a&&t===r.data||(t[y.name]=_getDefaultValue(y,null,t,o,l,!0,!0)),T=d(y,t[y.name],s,t,null,o,l,c,m.bind(this,e,y.name===n.BASED_ON_PROPERTY_NAME),e),S.appendChild(T),S.control=T,e.appendChild(S),e.valueCell=S,e.hidden=!p,e.required=_,s||(u[y.name]=function(e){T.edit?T.edit(e):T.click()})},S=function(){var e,t;for(_=[],e=0;e<g.length;e++)t=document.createElement("tr"),t.className="property",f(t,e),p.appendChild(t),_.push(t)},m=function(e,n){var s,a;for(s=0;s<_.length;s++)a=!i[g[s]].isValid||i[g[s]].isValid(t,o,r.name),(_[s].hidden!==!a||a&&(n||i[g[s]].updateOnValidate&&e!==_[s]))&&(_[s].valueCell.control.popup&&_[s].valueCell.control.popup.remove(),_[s].innerHTML="",f(_[s],s));h&&h(),c&&c.alignPosition(!0)},p=document.createElement("table"),p.classList.add("propertiesTable"),g=Object.keys(i),S(),e.appendChild(p),p},_=function(e,t,i,s,a){o=e,r=t,l=i,l&&l.setEditProperty&&l.setEditProperty(editProperty),c=s,h=a,_updateBasedOn(),u={},p(e,t.data,n.itemDescriptors[t.category],null,null,t.data,null,s)},{createProperties:_,getDefaultItemData:getDefaultItemData}}),define("editor/preview/shader-preview",["modules/media-resources","armada/graphics"],function(e,t){"use strict";function _markupCode(e,t,i){for(var n=0;n<t.length;n++)e=e.replace(new RegExp(t[n],"g"),'<span class="'+i+'">$&</span>');return e}function _processCode(e){var t;return e=e.replace(/\/\/(.*?)\n/g,'<span class="glsl-comment">$&</span>'),e=e.replace(/ {2}/g,"&nbsp;&nbsp;"),t=e.match(new RegExp("#define\\s+\\w+\\s+[^\\n]+","g")),e=_markupCode(e,["#version","#define","#elseif","#ifdef","#ifndef","#endif","#if","#else"],"glsl-directive"),t&&(e=_markupCode(e,t.map(function(e){return e.split(" ")[1]}),"glsl-directive")),e=_markupCode(e,["uniform ","attribute ","varying ","const","precision ","lowp ","mediump ","highp ","invariant","struct","return","discard","\\bif\\b","\\belse\\b","\\bswitch\\b","\\bcase\\b","\\bfor\\b","\\bdo\\b","\\bbreak\\b","\\bcontinue\\b","true","false"],"glsl-keyword"),e=_markupCode(e,["void","bool","\\bint\\b","float","\\bvec2","\\bvec3","\\bvec4","\\bmat2","\\bmat3","\\bmat4","\\bivec2","\\bivec3","\\bivec4","\\bbvec2","\\bbvec3","\\bbvec4","sampler2D","samplerCube"],"glsl-type"),e=_markupCode(e,["gl_Position","gl_FragColor"],"glsl-variable"),e=_markupCode(e,["dot\\(","cross\\(","length\\(","normalize\\(","reflect\\(","abs\\(","sign\\(","fract\\(","min\\(","max\\(","pow\\(","sin\\(","cos\\(","mix\\(","step\\(","clamp\\(","texture2D\\(","textureCube\\("],"glsl-function"),e=_markupCode(e,["\\(","\\)","\\[","\\]"],"glsl-operator"),"<tbody>"+e.split("\n").map(function(e,t){return'<tr><td class="shader-line-number">'+t+"</td><td>"+e+"</td></tr>"}).join("")+"</tbody>"}function _getInfo(e){return"Attribute vectors: "+e._numAttributeVectors+", vertex uniform vectors: "+e._numVertexUniformVectors+", varying vectors: "+e._numVaryingVectors+", fragment uniform vectors: "+e._numFragmentUniformVectors+"<br>Texture units: "+e._numTextureUnits}function refresh(o,r){var a;s=r||s,i=o||i,t.getShader(s._name),e.executeWhenReady(function(){var e,o,r,l,c;i.options.hidden=!0,i.div.hidden=!1,i.canvas.hidden=!0,a=t.getManagedShader(s._name),n=document.createElement("div"),n.classList.add("previewContent"),e=document.createElement("h1"),e.textContent="Vertex shader",e.classList.add("glsl-header"),n.appendChild(e),o=document.createElement("table"),o.classList.add("glsl-code"),r=a._vertexShaderSource,o.innerHTML=_processCode(r),n.appendChild(o),l=document.createElement("h1"),l.textContent="Fragment shader",l.classList.add("glsl-header"),n.appendChild(l),c=document.createElement("table"),c.classList.add("glsl-code"),r=a._fragmentShaderSource,c.innerHTML=_processCode(r),n.appendChild(c),i.div.appendChild(n),i.info.innerHTML=_getInfo(a),i.info.hidden=!i.info.innerHTML,i.div.style.height=i.div.parentNode.clientHeight-(i.options.clientHeight+i.info.clientHeight)+"px"}),e.requestResourceLoad()}function clear(){n&&(n.parentNode.removeChild(n),n=null)}function handleDataChanged(e){o.indexOf(e)>=0&&(clear(),refresh())}function handleStartEdit(){return!0}function handleStopEdit(){return!0}var i,n,s,o=["vertexShaderSource","fragmentShaderSource"];return{refresh:refresh,clear:clear,handleDataChanged:handleDataChanged,handleStartEdit:handleStartEdit,handleStopEdit:handleStopEdit}}),define("editor/preview/webgl-preview",["utils/utils","utils/vectors","utils/matrices","modules/pools","modules/managed-gl","modules/media-resources","modules/audio","modules/scene/renderable-objects","modules/scene/scene-graph","armada/graphics","armada/configuration","armada/logic/constants","armada/logic/classes","armada/logic/explosion","editor/common"],function(e,t,i,n,s,o,r,a,l,c,h,u,d,p,_){"use strict";function WebGLPreviewContext(e,t){this.params=e,this.functions=t,this.modelOrientationMatrix=i.identity4(),this.cameraOrientationMatrix=i.identity4(),this.cameraDistance=0}function setContext(e){O&&O.functions.clear(),O=e}function getScene(){return S}function getWireframeShaderName(){return re}function setModel(e){T=e}function setMission(e){E=e}function setupWireframeModel(e){e.setUniformValueFunction(a.UNIFORM_COLOR_NAME,function(){return ae})}function setWireframeModel(e){y=e,setupWireframeModel(e)}function _updateInfo(){var e,t=[];A.info.innerHTML="",O&&(T&&T.getModel&&t.push("Model: triangles: "+T.getModel().getNumTriangles(T.getCurrentLOD())+", lines: "+T.getModel().getNumLines(T.getCurrentLOD())+", dimensions: "+T.getModel().getWidth(T.getCurrentLOD()).toFixed(3)+" × "+T.getModel().getHeight(T.getCurrentLOD()).toFixed(3)+" × "+T.getModel().getDepth(T.getCurrentLOD()).toFixed(3)),O.functions.getInfo&&(e=O.functions.getInfo())&&t.push(e),D&&t.push("FPS: "+D),A.info.appendChild(_.createLabel(t.join("<br/>")))),A.info.hidden=""===A.info.innerHTML}function _handleParticle(e,t){e.canBeReused()&&g.markAsFree(t)}function _handleExplosion(e,t){e.canBeReused()&&m.markAsFree(t)}function _updateCanvasSize(){A.div.style.height=A.div.parentNode.clientHeight-(A.options.clientHeight+A.info.clientHeight)+"px",A.canvas.style.height=A.div.style.height,A.canvas.width=A.canvas.clientWidth,A.canvas.height=A.canvas.clientHeight}function requestRender(e,t){R&&!e||(t=t||0,g.hasLockedObjects()&&g.executeForLockedObjects(_handleParticle),m.hasLockedObjects()&&m.executeForLockedObjects(_handleExplosion),_updateInfo(),_updateCanvasSize(),S.render(f,t),O&&O.functions.animate&&O.functions.animate(t),D=t?Math.round(1e3/t):0)}function _updateAnimateButton(){ce.animateButton&&(ce.animateButton.innerHTML=R?"Stop":"Animate")}function _renderFrame(e){var t;R&&(N||(N=e),t=e-N,b?(D=0,R=!1,_updateAnimateButton(),_updateInfo(),_updateCanvasSize()):(requestRender(!0,t),N=e,window.requestAnimationFrame(_renderFrame)))}function startAnimating(){R?b&&(b=!1):(R=!0,b=!1,N=0,_updateAnimateButton(),window.requestAnimationFrame(_renderFrame))}function stopAnimating(){b=!0}function _handleMouseMove(n){var s,o,r,a,l,c,h,u,d,p,_=S._camera,g=-(n.screenX-le[0])*Math.radians(U),m=-(n.screenY-le[1])*Math.radians(U),f=!1;(C||M)&&(I+=Math.abs(n.screenX-le[0])+Math.abs(n.screenY-le[1])),T?C&&(s=_.getCameraOrientationMatrix(),o=t.getRowA43Aux(s),r=t.getRowB43Aux(s),T.rotate(r,g),T.rotate(o,m),y&&y.setOrientationMatrix(T.oM),i.copyRotation4(O.modelOrientationMatrix,T.oM),O.functions.onModelRotate&&O.functions.onModelRotate()):C&&(_.setAngularVelocityVector([B*m,B*g,0]),_.update(1e4),_.setAngularVelocityVector([0,0,0]),i.copyRotation4(O.cameraOrientationMatrix,_.getCameraOrientationMatrix())),M&&(T?(_.setAngularVelocityVector([-m,-g,0]),_.update(1e4),_.setAngularVelocityVector([0,0,0]),i.copyRotation4(O.cameraOrientationMatrix,_.getCameraOrientationMatrix())):(_.setControlledVelocityVector([-(n.screenX-le[0])*H,(n.screenY-le[1])*H,0]),_.update(1e3),_.setControlledVelocityVector([0,0,0]))),O.functions.onMouseMove&&(a=_.getSpan()/(2*Math.tan(_.getFOV()*e.RAD*.5)),l=A.canvas.getBoundingClientRect(),c=l.width/l.height,h=((n.clientX-l.left)/l.width-.5)*c,u=.5-(n.clientY-l.top)/l.height,d=_.getCameraOrientationMatrix(),p=[0,0,0],t.add3(p,t.getRowC43ScaledAux(d,-a)),t.add3(p,t.scaled3Aux(t.getRowA43Aux(d),_.getSpan()*h)),t.add3(p,t.getRowB43ScaledAux(d,_.getSpan()*u)),t.normalize3(p),f=O.functions.onMouseMove(n,_.getCameraPositionMatrix(),p,C,M)),(M||C||f)&&requestRender(),le=[n.screenX,n.screenY]}function _handleMouseUp(e){switch(e.which){case Y:C=!1;break;case X:M=!1}return C||M||(document.body.onmousemove=null,A.canvas.onmousemove=_handleMouseMove,document.body.onmouseup=null),e.target===A.canvas&&I<=oe&&O.functions.onClick&&O.functions.onClick(e),e.preventDefault(),e.stopPropagation(),!1}function _handleMouseDown(e){switch(e.which){case Y:C=!0;break;case X:M=!0}return I=0,(C||M)&&(le=[e.screenX,e.screenY],A.canvas.onmousemove=null,document.body.onmousemove=_handleMouseMove,document.body.onmouseup=_handleMouseUp),e.preventDefault(),e.stopPropagation(),!1}function _handleWheel(e){var n,s,o=0;return e.deltaY>0&&(o=q),e.deltaY<1&&(o=z),o&&(s=i.translationVector3(S._camera.getCameraPositionMatrix()),n=t.length3(s),S._camera.setControlledVelocityVector([0,0,(T?n:G)*(o-1)]),S._camera.update(1e3),S._camera.setControlledVelocityVector([0,0,0]),O.cameraDistance=i.translationLength(S._camera.getCameraPositionMatrix()),requestRender()),!1}function _shouldRenderWireframe(){return x===w.WIREFRAME||x===w.BOTH}function _shouldRenderSolid(){return x===w.SOLID||x===w.BOTH||!y}function _updateForRenderMode(){y&&(_shouldRenderWireframe()?y._node.show():y._node.hide()),T&&(_shouldRenderSolid()?T._node.show():T._node.hide())}function _updateLOD(e){e.setStaticLOD&&e.setStaticLOD(c.getLOD(v))}function _updateForLOD(){T&&T._node.execute(_updateLOD),y&&y._node.execute(_updateLOD)}function _createSettingLabel(e){var t=document.createElement("span");return t.classList.add(Q),t.innerHTML=e,t}function createSetting(e,t){var i=document.createElement("div");return i.classList.add(J),t&&i.appendChild(_createSettingLabel(t)),i.appendChild(e),i}function _handleResize(){S&&(_updateCanvasSize(),requestRender())}function updateCanvas(e){var n,r,a;e=e||{},r=!e.preserve||e.reload,a=R,stopAnimating(),c.shouldUseShadowMapping()&&c.getShadowMappingShader(),r&&(O.functions.clear(),T=null,y=null,E=null,g.clear(),m.clear()),S?(e.clearScene||r)&&(S.clear(!0),S._clearColor=K,S._ambientColor=Z):(S=new l.Scene(0,0,1,1,!0,[!0,!0,!0,!0],K,!0,c.getLODContext(),c.getMaxDirLights(),c.getMaxPointLights(),c.getMaxSpotLights(),{useVerticalValues:!0,viewDistance:5e3,fov:V,span:F,transitionDuration:1e3,transitionStyle:"smooth"}),o.executeWhenReady(function(){n=c.getShadowMappingSettings(),n&&(n.deferSetup=!0),S.setShadowMapping(n)})),f&&!e.preserve&&requestRender(),O.functions.load(e,O.modelOrientationMatrix)&&(r=!0),f=f||new s.ManagedGLContext($,A.canvas,c.getAntialiasing(),!0,c.getFiltering()),o.executeWhenReady(function(){var n;A.div.hidden=!1,A.canvas.hidden=!1,_updateForLOD(),_updateInfo(),_updateCanvasSize(),f.clear(),o.executeWhenReady(function(){S.addToContext(f),f.setup(),r&&(T?(e.preserve||(O.cameraDistance=(O.params.defaultDistanceFactor||ee)*T.getScaledSize()),n=new d.ObjectView({name:ne,isAimingView:!1,fps:!1,fov:se,fovRange:[se,se],followsPosition:!0,followsOrientation:!1,movable:!0,turnable:!0,rotationCenterIsObject:!0,distanceRange:[0,ie*T.getScaledSize()],position:t.scaled3(O.params.cameraDirection||te,O.cameraDistance)}),S._camera.setViewDistance(5e3),S._camera.setConfiguration(n.createCameraConfiguration(T,h.getDefaultCameraBaseOrientation(),h.getDefaultCameraPointToFallback(),h.getDefaultCameraFOV(),h.getDefaultCameraSpan()))):(e.preserve||(E?(n=new d.SceneView({name:ne,fps:!0,lookAt:d.SceneViewLookAtMode.NONE,fov:se,fovRange:[se,se],movable:!0,turnable:!0,position:[0,0,j],rotations:W}),S._camera.setConfiguration(E.createCameraConfigurationForSceneView(n,S))):S._camera.moveToPosition([0,0,j],0),S._camera.getConfiguration().setRelativeOrientationMatrix(i.identity4(),!0)),S._camera.setViewDistance(k)),e.preserve&&S._camera.getConfiguration().setRelativeOrientationMatrix(i.copy(O.cameraOrientationMatrix),!0)),A.canvas.onmousedown=_handleMouseDown,A.canvas.onmousemove=_handleMouseMove,A.canvas.onwheel=_handleWheel,f.executeWhenReady(function(){_updateForRenderMode(),_updateForLOD(),O.functions.updateForRefresh(),O.params.animateOnRefresh||a&&!1!==O.params.animateOnRefresh?startAnimating():requestRender()})}),setTimeout(function(){o.requestResourceLoad()},0)}),o.requestResourceLoad()}function clearSettingsForNewItem(){x=x||w.SOLID,v=void 0!==v?v:c.getLODLevel(),O.modelOrientationMatrix=i.identity4(),O.cameraOrientationMatrix=i.identity4(),O.functions.clearSettingsForNewItem()}function createOptions(){A.options.innerHTML="",O.params.renderModeSetting&&(ce.renderModeSelector=_.createSelector(e.getEnumValues(w),x,!1,function(){x=ce.renderModeSelector.value,_updateForRenderMode(),requestRender()}),A.options.appendChild(createSetting(ce.renderModeSelector,"Render mode:"))),O.params.lodSetting&&(ce.lodSelector=_.createSelector(c.getLODLevels(),v,!1,function(){v=ce.lodSelector.value,_updateForLOD(),requestRender(),_updateInfo()}),A.options.appendChild(createSetting(ce.lodSelector,"LOD:"))),O.params.animateButton&&(ce.animateButton=_.createButton(R?"Stop":"Animate",function(){R?stopAnimating():startAnimating()}),A.options.appendChild(createSetting(ce.animateButton))),O.params.muteCheckbox&&(ce.muteCheckbox=_.createBooleanInput(L,function(){L=ce.muteCheckbox.checked,r.setMasterVolume(L?0:1)}),A.options.appendChild(createSetting(ce.muteCheckbox,"Mute:"))),O.functions.createOptions(),A.options.hidden=""===A.options.innerHTML}function refresh(e,t){A=e,createOptions(),updateCanvas(t),window.addEventListener("resize",_handleResize)}function clear(){stopAnimating(),setContext(null)}function handleDataChanged(e){O.params.optionRefreshProperties.indexOf(e)>=0&&createOptions(),O.params.canvasUpdateProperties.indexOf(e)>=0?updateCanvas({preserve:!0,reload:!0}):O.params.infoUpdateProperties.indexOf(e)>=0&&(_updateInfo(),_updateCanvasSize(),requestRender())}function setEditProperty(e){P=e}function editProperty(e,t){P(e,t)}var g,m,f,S,T,y,E,C,M,I,A,x,v,O,R,b,L,N,D,P,w={WIREFRAME:"wireframe",SOLID:"solid",BOTH:"both"},V=40,F=.2,U=1,B=.25,H=.25,G=1e3,j=500,k=15e3,W=[{axis:"X",degrees:90}],Y=e.MouseButton.LEFT,X=e.MouseButton.MIDDLE,q=1.05,z=.95,J="setting",Q="settingLabel",K=[0,0,0,1],Z=[0,0,0],$="context",ee=1.5,te=[0,-1,0],ie=100,ne="standard",se=45,oe=3,re="oneColor",ae=[1,1,1,1],le=[0,0],ce={renderModeSelector:null,lodSelector:null,animateButton:null,muteCheckbox:null};return g=n.getPool(u.PARTICLE_POOL_NAME,a.Particle),m=n.getPool(u.EXPLOSION_POOL_NAME,p.Explosion),{FREE_CAMERA_VIEW_DISTANCE:k,WebGLPreviewContext:WebGLPreviewContext,setContext:setContext,getScene:getScene,getWireframeShaderName:getWireframeShaderName,setModel:setModel,setMission:setMission,setWireframeModel:setWireframeModel,setupWireframeModel:setupWireframeModel,requestRender:requestRender,startAnimating:startAnimating,stopAnimating:stopAnimating,createSetting:createSetting,clearSettingsForNewItem:clearSettingsForNewItem,updateCanvas:updateCanvas,refresh:refresh,clear:clear,handleDataChanged:handleDataChanged,setEditProperty:setEditProperty,editProperty:editProperty}}),define("editor/preview/skybox-preview",["armada/logic/environments","editor/preview/webgl-preview"],function(e,t){"use strict";function _clear(){i&&(i.destroy(),i=null)}function _load(s){var o;s=s||{},o=!s.preserve||s.reload,o&&(i=new e.Skybox(n)),i.addToScene(t.getScene())}function _clearSettingsForNewItem(){return!0}function _createOptions(){return!0}function _updateForRefresh(){return!0}function refresh(e,i,o){var r=n===i;t.setContext(s),n=i,r?o||(o={preserve:!0,reload:!0}):t.clearSettingsForNewItem(),t.refresh(e,o)}function handleStartEdit(){return!0}function handleStopEdit(){return!0}var i,n,s,o=["shader","cubemap"],r=[],a=[];return s=new t.WebGLPreviewContext({renderModeSetting:!1,lodSetting:!1,canvasUpdateProperties:o,optionRefreshProperties:r,infoUpdateProperties:a},{clear:_clear,load:_load,updateForRefresh:_updateForRefresh,clearSettingsForNewItem:_clearSettingsForNewItem,createOptions:_createOptions}),{refresh:refresh,clear:t.clear,handleDataChanged:t.handleDataChanged,handleStartEdit:handleStartEdit,handleStopEdit:handleStopEdit}}),define("editor/preview/backgroundObject-preview",["armada/logic/environments","editor/preview/webgl-preview"],function(e,t){"use strict";function _clear(){i&&(i.destroy(),i=null)}function _load(s){var o;s=s||{},o=!s.preserve||s.reload,o&&(i=new e.BackgroundObject(n,600,0,-90,180)),i.addToScene(t.getScene(),!0)}function _clearSettingsForNewItem(){return!0}function _createOptions(){return!0}function _updateForRefresh(){return!0}function refresh(e,i,o){var r=n===i;t.setContext(s),n=i,r?o||(o={preserve:!0,reload:!0}):t.clearSettingsForNewItem(),t.refresh(e,o)}function handleStartEdit(){return!0}function handleStopEdit(){return!0}var i,n,s,o=["layers"],r=[],a=[];return s=new t.WebGLPreviewContext({renderModeSetting:!1,lodSetting:!1,canvasUpdateProperties:o,optionRefreshProperties:r,infoUpdateProperties:a},{clear:_clear,load:_load,updateForRefresh:_updateForRefresh,clearSettingsForNewItem:_clearSettingsForNewItem,createOptions:_createOptions}),{refresh:refresh,clear:t.clear,handleDataChanged:t.handleDataChanged,handleStartEdit:handleStartEdit,handleStopEdit:handleStopEdit}}),define("editor/preview/explosion-preview",["utils/matrices","modules/pools","modules/scene/renderable-objects","modules/scene/lights","armada/logic/constants","armada/logic/explosion","editor/common","editor/preview/webgl-preview"],function(e,t,i,n,s,o,r,a){"use strict";function _clear(){h&&(h.destroy(),h=null)}function _load(t,i){var s,r;if(t=t||{},s=!t.preserve||t.reload,t.clearScene||s){for(r=0;r<p.length;r++)a.getScene().addDirectionalLightSource(new n.DirectionalLightSource(p[r].color,p[r].direction));s&&(h=new o.Explosion(u,e.identity4(),i,[0,1,0],!0,!0,e.identity4())),h.addResourcesToScene(a.getScene(),!1),h.addToScene(a.getScene()._rootNode,null,!1,function(e){a.setModel(e)})}}function _clearSettingsForNewItem(){return!0}function _createOptions(){return f.restartButton=r.createButton("Restart",function(){h.vMo._node.markAsReusable(!0),h.addToScene(a.getScene()._rootNode,null,!1,function(e){a.setModel(e)}),a.startAnimating()}),c.options.appendChild(a.createSetting(f.restartButton)),!0}function _updateForRefresh(){return!0}function _getInfo(){var e=h&&h.vMo&&h.vMo._node;return(e?"Particles: "+(e.canBeReused()?"0":e._subnodes._length)+", ":"")+"Pool: "+l.getLockedObjectCount()+"/"+l.getObjects().length}function refresh(e,t,i){var n=u===t;a.setContext(d),c=e,u=t,n?i||(i={preserve:!0,reload:!0}):a.clearSettingsForNewItem(),a.refresh(e,i)}function handleStartEdit(){return!0}function handleStopEdit(){return!0}var l,c,h,u,d,p=[{color:[1,1,1],direction:[1,0,1]}],_=["particleEmitters","lightStates","soundEffect"],g=[],m=[],f={restartButton:null};return d=new a.WebGLPreviewContext({renderModeSetting:!1,lodSetting:!1,animateButton:!0,animateOnRefresh:!0,muteCheckbox:!0,canvasUpdateProperties:_,optionRefreshProperties:g,infoUpdateProperties:m,defaultDistanceFactor:2},{clear:_clear,load:_load,updateForRefresh:_updateForRefresh,clearSettingsForNewItem:_clearSettingsForNewItem,createOptions:_createOptions,getInfo:_getInfo}),l=t.getPool(s.PARTICLE_POOL_NAME,i.Particle),{refresh:refresh,clear:a.clear,handleDataChanged:a.handleDataChanged,handleStartEdit:handleStartEdit,handleStopEdit:handleStopEdit}}),define("editor/preview/projectile-preview",["modules/scene/lights","armada/logic/equipment","editor/preview/webgl-preview"],function(e,t,i){"use strict";function _clear(){n&&(n.destroy(),n=null)}function _load(o,a){var l,c;if(o=o||{},l=!o.preserve||o.reload,o.clearScene||l){for(c=0;c<r.length;c++)i.getScene().addDirectionalLightSource(new e.DirectionalLightSource(r[c].color,r[c].direction));l&&(n=new t.Projectile(s)),n.addResourcesToScene(i.getScene(),!1),n.addToScene(i.getScene(),!1,void 0,a,0,function(e){i.setModel(e)})}}function _clearSettingsForNewItem(){return!0}function _createOptions(){return!0}function _updateForRefresh(){return!0}function _onModelRotate(){n.vMo.updateDirection()}function refresh(e,t,n){var r=s===t;i.setContext(o),s=t,r?n||(n={preserve:!0,reload:!0}):i.clearSettingsForNewItem(),i.refresh(e,n)}function handleStartEdit(){return!0}function handleStopEdit(){return!0}var n,s,o,r=[{color:[1,1,1],direction:[1,0,1]}],a=["shader","texture","size","intersectionPositions","width"],l=[],c=[];return o=new i.WebGLPreviewContext({renderModeSetting:!1,lodSetting:!1,canvasUpdateProperties:a,optionRefreshProperties:l,infoUpdateProperties:c,defaultDistanceFactor:3},{clear:_clear,load:_load,updateForRefresh:_updateForRefresh,clearSettingsForNewItem:_clearSettingsForNewItem,createOptions:_createOptions,onModelRotate:_onModelRotate}),{refresh:refresh,clear:i.clear,handleDataChanged:i.handleDataChanged,handleStartEdit:handleStartEdit,handleStopEdit:handleStopEdit}}),define("editor/preview/weapon-preview",["modules/scene/renderable-objects","modules/scene/lights","armada/graphics","armada/logic/equipment","editor/common","editor/preview/webgl-preview"],function(e,t,i,n,s,o){"use strict";function _barrelMarkerColorFunction(){return _}function _highlightedBarrelMarkerColorFunction(){return g}function _updateForBarrelMarkerState(){var t,i,n=r._barrelMarkers._subnodes;if(h){for(t=0,i=n._first;i;i=i.next,t++)i._renderableObject.setUniformValueFunction(e.UNIFORM_COLOR_NAME,t===u?_highlightedBarrelMarkerColorFunction:_barrelMarkerColorFunction);r._barrelMarkers._renderableObject.setOrientationM4(r._transformMatrix),r._barrelMarkers._renderableObject.setPositionM4(r._transformMatrix),r._barrelMarkers.show()}else r._barrelMarkers.hide()}function _updateRotators(){r.setRotation(y.rotator1Angle.value,y.rotator2Angle.value),r.simulate(0),a.setRotation(y.rotator1Angle.value,y.rotator2Angle.value),a.simulate(0)}function _updateRotatorEditors(){var e=l._rotators;y.rotator1Angle.parentElement.hidden=e.length<1,y.rotator2Angle.parentElement.hidden=e.length<2}function _clear(){r&&(r.destroy(),r=null,a.destroy(),a=null)}function _load(e,s){var c,h,u;if(e=e||{},c=!e.preserve||e.reload,e.clearScene||c){for(h=i.isShadowMappingEnabled(),o.getScene()._clearColor=[0,0,0,1],o.getScene()._ambientColor=[0,0,0],u=0;u<p.length;u++)o.getScene().addDirectionalLightSource(new t.DirectionalLightSource(p[u].color,p[u].direction));i.setShadowMapping(),h!==i.isShadowMappingEnabled()&&(i.handleSettingsChanged(),c=!0),c&&(r=new n.Weapon(l),a=new n.Weapon(l)),r.addToScene(o.getScene()._rootNode,void 0,!1,{projectileResources:!1,sound:!1,orientationMatrix:s,barrelMarkers:!0,barrelMarkerSize:m,barrelMarkerShaderName:o.getWireframeShaderName()},c?function(e){o.setModel(e)}:null),a.addToScene(o.getScene()._rootNode,void 0,!0,{shaderName:o.getWireframeShaderName(),projectileResources:!1,sound:!1,orientationMatrix:s},c?function(e){o.setWireframeModel(e)}:null)}return _updateRotatorEditors(),c}function _clearSettingsForNewItem(){h=!1}function _createOptions(){var e=function(){_updateRotators(),_updateForBarrelMarkerState(),o.requestRender()};y.rotator1Angle=s.createNumericInput(0,{},e),y.rotator2Angle=s.createNumericInput(0,{},e),
c.options.appendChild(o.createSetting(y.rotator1Angle,"Rotator 1 angle:")),c.options.appendChild(o.createSetting(y.rotator2Angle,"Rotator 2 angle:"))}function _updateForRefresh(){_updateRotatorEditors(),_updateRotators(),_updateForBarrelMarkerState()}function _getInfo(){var e,t,i;return e="",r&&(t=r.getDamage())>0&&(e="Weapon: ",i=t-r.getDamage(1),e+="damage: "+Math.round(100*t)/100+" (-"+Math.round(100*i)/100+" / arm.), ",t=r.getFirepower(),i=t-r.getFirepower(1),e+="firepower: "+Math.round(100*t)/100+" (-"+Math.round(100*i)/100+" / arm.), ",e+="fire rate: "+Math.round(100*r.getFireRate())/100+" / s, ",e+="range: "+r.getRange(0)+" m"),e}function refresh(e,t,i){var n=l===t;o.setContext(d),c=e,l=t,n?i||(i={preserve:!0,reload:!0}):o.clearSettingsForNewItem(),o.refresh(e,i)}function handleStartEdit(e,t){"barrels"===e&&(h=!0,u=t,_updateForBarrelMarkerState(),o.requestRender())}function handleStopEdit(e){"barrels"===e&&(h=!1,_updateForBarrelMarkerState(),o.requestRender())}var r,a,l,c,h,u,d,p=[{color:[1,1,1],direction:[1,0,1]}],_=[0,.5,.5,1],g=[.8,.4,.3,1],m=.2,f=["model","shader","texture","defaultLuminosityFactors","barrels","rotators"],S=["rotators"],T=["cooldown","projectile","projectileVelocity"],y={rotator1Angle:null,rotator2Angle:null};return d=new o.WebGLPreviewContext({renderModeSetting:!0,lodSetting:!0,canvasUpdateProperties:f,optionRefreshProperties:S,infoUpdateProperties:T},{clear:_clear,load:_load,updateForRefresh:_updateForRefresh,getInfo:_getInfo,clearSettingsForNewItem:_clearSettingsForNewItem,createOptions:_createOptions}),{refresh:refresh,clear:o.clear,handleDataChanged:o.handleDataChanged,handleStartEdit:handleStartEdit,handleStopEdit:handleStopEdit}}),define("editor/preview/missile-preview",["utils/vectors","utils/matrices","modules/media-resources","modules/scene/lights","armada/graphics","armada/logic/environments","armada/logic/equipment","editor/common","editor/descriptors","editor/preview/webgl-preview"],function(e,t,i,n,s,o,r,a,l,c){"use strict";function _updateThrusters(){var e;for(h.resetThrusterBurn(),e=0;e<C.length;e++)switch(C[e]){case l.ThrusterUse.FORWARD:h.addThrusterBurnForward(1);break;case l.ThrusterUse.YAW_LEFT:h.addThrusterBurnYawLeft(1);break;case l.ThrusterUse.YAW_RIGHT:h.addThrusterBurnYawRight(1);break;case l.ThrusterUse.PITCH_UP:h.addThrusterBurnPitchUp(1);break;case l.ThrusterUse.PITCH_DOWN:h.addThrusterBurnPitchDown(1)}h.updateThrusterVisuals()}function _updateEngineStateEditor(){M.engineStateEditor.innerHTML=C.length>0?C[0]+(C.length>1?"...":""):S}function _addTrail(){var i,n,s,o,r,a,l,u=h._trailEmitter,d=u._descriptor._growthRate,p=u._descriptor._duration,g=h.vMo;for(i=g.getPositionVector(),e.add3(i,e.prodVec3Mat3Aux(_.getEnginePosition(),t.prodScalingRotation3Aux(g.sM,g.oM))),n=e.length3Squared(i)>0?e.normal3(i):e.getRowB43ScaledAux(g.oM,-1),s=5*_._length,o=3,r=s/o,a=p/(o*d),u.startNew(c.getScene(),e.sum3Aux(i,e.scaled3Aux(n,o*r))),l=1;l<=o;l++)u.addPoint(e.sum3Aux(i,e.scaled3Aux(n,(o-l)*r)),a);c.requestRender()}function _clear(){h&&(h.destroy(),h=null,u.destroy(),u=null)}function _load(e,t){var a,l,p,m;if(e=e||{},e.preserve&&void 0===e.environmentName&&(e.environmentName=g),a=e.environmentName!==g,l=!e.preserve||e.reload,a||l){if(p=s.isShadowMappingEnabled(),e.environmentName)d=o.getEnvironment(e.environmentName),d.hasShadows()?s.setShadowMapping():s.setShadowMapping(!1,!1);else{for(d=null,c.getScene()._clearColor=[0,0,0,1],c.getScene()._ambientColor=[0,0,0],m=0;m<f.length;m++)c.getScene().addDirectionalLightSource(new n.DirectionalLightSource(f[m].color,f[m].direction));s.setShadowMapping()}p!==s.isShadowMappingEnabled()&&(s.handleSettingsChanged(),l=!0)}return l&&(_clear(),h=new r.Missile(_),u=new r.Missile(_)),t&&(h.pMo.updateOrientationMatrix(t),u.pMo.updateOrientationMatrix(h.pMo.oM)),e.clearScene||l?(_.acquireResources({missileOnly:!1,sound:!0,trail:!0}),s.getShader(c.getWireframeShaderName()),h.addToScene(c.getScene(),!1,void 0,void 0,!0,l?function(e){c.setModel(e),h._trailEmitter.addResourcesToScene(c.getScene())}:null),u.addToScene(c.getScene(),!0,void 0,c.getWireframeShaderName(),!1,l?function(e){c.setWireframeModel(e)}:null)):(c.setModel(h.vMo),c.setWireframeModel(u.vMo)),e.environmentName&&(a||l)&&(d.addToScene(c.getScene()),d.addParticleEffectsToScene(c.getScene())&&i.executeWhenReady(c.startAnimating)),g=e.environmentName,_updateEngineStateEditor(),l}function _clearSettingsForNewItem(){g=null,C=[]}function _createEngineEditor(){var e,t,i,n,s,o=document.createElement("button"),r=new a.Popup(o,null,{}),h=[l.ThrusterUse.FORWARD,l.ThrusterUse.YAW_LEFT,l.ThrusterUse.YAW_RIGHT,l.ThrusterUse.PITCH_UP,l.ThrusterUse.PITCH_DOWN],u=function(e,t){var i=C.indexOf(h[e]);t?-1===i&&C.push(h[e]):i>=0&&C.splice(i,1),_updateEngineStateEditor(),_updateThrusters(),c.requestRender()};for(e=document.createElement("table"),s=0;s<h.length;s++)n=a.createBooleanInput(C.indexOf(h[s])>=0,u.bind(_createEngineEditor,s)),t=document.createElement("tr"),i=document.createElement("td"),i.appendChild(a.createLabel(h[s].toString())),t.appendChild(i),i=document.createElement("td"),i.appendChild(n),t.appendChild(i),e.appendChild(t);return r._element.appendChild(e),r.addToPage(),M.engineStatePopup=r,o.type="button",o.onclick=function(){r.toggle()},o}function _createOptions(){M.addTrailButton=a.createButton("Add trail",function(){_addTrail()}),p.options.appendChild(c.createSetting(M.addTrailButton)),M.environmentSelector=a.createSelector(o.getEnvironmentNames(),g,!0,function(){c.updateCanvas({preserve:!0,clearScene:!0,environmentName:"none"!==M.environmentSelector.value?M.environmentSelector.value:null})}),p.options.appendChild(c.createSetting(M.environmentSelector,"Environment:")),M.engineStateEditor=_createEngineEditor(),p.options.appendChild(c.createSetting(M.engineStateEditor,"Thrusters:"))}function _animate(){d&&d.simulate()}function _updateForRefresh(){_updateThrusters()}function _getInfo(){var e,t;return e="",h&&(t=_.getNominalRange())>0&&(e="Missile: ",e+="nominal range: "+Math.round(100*t)/100+" m"),e}function refresh(e,t,i){var n=_===t;c.setContext(m),p=e,_=t,n?i||(i={preserve:!0,reload:!0}):c.clearSettingsForNewItem(),c.refresh(e,i)}function handleStartEdit(){return!0}function handleStopEdit(){return!0}var h,u,d,p,_,g,m,f=[{color:[1,1,1],direction:[1,0,1]}],S="off",T=["model","modelScale","shader","texture","trail","thrusterSlots"],y=[],E=["launchVelocity","ignitionTime","acceleration","duration"],C=[],M={addTrailButton:null,environmentSelector:null,engineStateEditor:null,engineStatePopup:null};return m=new c.WebGLPreviewContext({renderModeSetting:!0,lodSetting:!0,animateButton:!0,canvasUpdateProperties:T,optionRefreshProperties:y,infoUpdateProperties:E},{clear:_clear,load:_load,animate:_animate,updateForRefresh:_updateForRefresh,getInfo:_getInfo,clearSettingsForNewItem:_clearSettingsForNewItem,createOptions:_createOptions}),{refresh:refresh,clear:c.clear,handleDataChanged:c.handleDataChanged,handleStartEdit:handleStartEdit,handleStopEdit:handleStopEdit}}),define("editor/preview/spacecraft-preview",["utils/utils","utils/matrices","modules/media-resources","modules/scene/renderable-objects","modules/scene/lights","armada/configuration","armada/graphics","armada/logic/environments","armada/logic/SpacecraftEvents","armada/logic/spacecraft","editor/common","editor/descriptors","editor/preview/webgl-preview"],function(e,t,i,n,s,o,r,a,l,c,h,u,d){"use strict";function _hitboxColorFunction(){return o.getSetting(o.BS.HITBOX_COLOR)}function _highlighterHitboxColorFunction(){return x}function _updateForHitboxState(){var e,t,i=p.getHitbox()._subnodes;if(C){for(e=0,t=i._first;t;t=t.next,e++)t._renderableObject.setUniformValueFunction(n.UNIFORM_COLOR_NAME,e===M?_highlighterHitboxColorFunction:_hitboxColorFunction);p.showHitbox()}else p.hideHitbox()}function _updateThrusters(){var e;if(p._propulsion){for(p.resetThrusterBurn(),e=0;e<D.length;e++)p.addThrusterBurn(D[e],D[e]===u.ThrusterUse.FORWARD||D[e]===u.ThrusterUse.REVERSE||D[e]===u.ThrusterUse.STRAFE_LEFT||D[e]===u.ThrusterUse.STRAFE_RIGHT||D[e]===u.ThrusterUse.RAISE||D[e]===u.ThrusterUse.LOWER?p.getMaxThrusterMoveBurnLevel():p.getMaxThrusterTurnBurnLevel());p.updatePropulsionVisuals()}}function _updateEngineStateEditor(){var e,t;if(P.engineStateEditor.disabled=!p._propulsion,P.engineStateEditor.disabled){for(D=[],t=P.engineStatePopup._element.querySelectorAll('input[type="checkbox"]'),e=0;e<t.length;e++)t[e].checked=!1;P.engineStatePopup.hide()}P.engineStateEditor.innerHTML=D.length>0?D[0]+(D.length>1?"...":""):p._propulsion?O:v}function _updateExplodeButton(){P.explodeButton.innerHTML=p&&p._hitpoints>0?"Explode":"Respawn",P.explodeButton.disabled=!p||0===p._hitpoints&&p._alive}function _updateShieldRechargeButton(){P.shieldRechargeButton.disabled=!p||p._hitpoints<=0||!p.hasShield()}function _clear(){p&&(p.destroy(),p=null,_.destroy(),_=null)}function _load(e,t){var n,o,l,h,u;if(e=e||{},e.preserve&&(void 0===e.environmentName&&(e.environmentName=S),void 0===e.loadoutName&&(e.loadoutName=T)),n=e.environmentName!==S,o=e.loadoutName!==T,l=!e.preserve||e.reload,n||l){if(h=r.isShadowMappingEnabled(),e.environmentName)g=a.getEnvironment(e.environmentName),g.hasShadows()?r.setShadowMapping():r.setShadowMapping(!1,!1);else{for(g=null,d.getScene()._clearColor=[0,0,0,1],d.getScene()._ambientColor=[0,0,0],u=0;u<A.length;u++)d.getScene().addDirectionalLightSource(new s.DirectionalLightSource(A[u].color,A[u].direction));r.setShadowMapping()}h!==r.isShadowMappingEnabled()&&(r.handleSettingsChanged(),l=!0)}return l&&(_clear(),p=new c.Spacecraft(f),_=new c.Spacecraft(f)),t&&(p.updatePhysicalOrientationMatrix(t),_.updatePhysicalOrientationMatrix(p.pMo.oM)),(o||n||l)&&(T&&(p.unequip(),_.unequip(),T=null),e.loadoutName&&(p.equipLoadout(f.getLoadout(e.loadoutName)),_.equipLoadout(f.getLoadout(e.loadoutName)),T=e.loadoutName)),p.addToScene(d.getScene(),void 0,!1,n||l?{weapons:!0,missilesInLaunchers:!0,allMissilesInLaunchers:!0,lightSources:!0,blinkers:!0,hitboxes:!0,thrusterParticles:!0,explosion:!0,shield:!0,sound:!0}:{self:!1,weapons:!0},{replaceVisualModel:!0,factionColor:y},n||l?function(e){d.setModel(e)}:null),_.addToScene(d.getScene(),void 0,!0,n||l?{weapons:!0,missilesInLaunchers:!0,allMissilesInLaunchers:!0}:{self:!1,weapons:!0},{replaceVisualModel:!0,shaderName:d.getWireframeShaderName()},n||l?function(e){d.setWireframeModel(e)}:null,function(e){d.setupWireframeModel(e)}),e.environmentName&&(n||l)&&(g.addToScene(d.getScene()),g.addParticleEffectsToScene(d.getScene())&&i.executeWhenReady(d.startAnimating)),S=e.environmentName,_updateEngineStateEditor(),l}function _clearSettingsForNewItem(){S=null,T=null,y||(E=!1),E||(y=f._factionColor?f._factionColor.slice():[0,0,0,0]),D=[],C=!1}function _createEngineEditor(){var t,i,n,s,o,r=document.createElement("button"),a=new h.Popup(r,null,{}),l=e.getEnumValues(u.ThrusterUse),c=function(e,t){var i=D.indexOf(l[e]);t?-1===i&&D.push(l[e]):i>=0&&D.splice(i,1),_updateEngineStateEditor(),_updateThrusters(),d.requestRender()};for(t=document.createElement("table"),o=0;o<l.length;o++)s=h.createBooleanInput(D.indexOf(l[o])>=0,c.bind(_createEngineEditor,o)),i=document.createElement("tr"),n=document.createElement("td"),n.appendChild(h.createLabel(l[o].toString())),i.appendChild(n),n=document.createElement("td"),n.appendChild(s),i.appendChild(n),t.appendChild(i);return a._element.appendChild(t),a.addToPage(),P.engineStatePopup=a,r.type="button",r.disabled=!0,r.onclick=function(){a.toggle()},r}function _createOptions(){P.environmentSelector=h.createSelector(a.getEnvironmentNames(),S,!0,function(){d.updateCanvas({preserve:!0,clearScene:!0,environmentName:"none"!==P.environmentSelector.value?P.environmentSelector.value:null}),_updateExplodeButton(),_updateShieldRechargeButton()}),m.options.appendChild(d.createSetting(P.environmentSelector,"Environment:")),P.loadoutSelector=h.createSelector(f.getLoadoutNames(),T,!0,function(){d.updateCanvas({preserve:!0,reload:!0,loadoutName:"none"!==P.loadoutSelector.value?P.loadoutSelector.value:null}),_updateEngineStateEditor(),_updateExplodeButton(),_updateShieldRechargeButton()}),m.options.appendChild(d.createSetting(P.loadoutSelector,"Loadout:")),P.factionColorPicker=h.createColorPicker(y,function(){E=!0,d.updateCanvas({preserve:!0,reload:!0}),_updateExplodeButton(),_updateShieldRechargeButton()}),m.options.appendChild(d.createSetting(P.factionColorPicker,"Faction color:")),P.engineStateEditor=_createEngineEditor(),m.options.appendChild(d.createSetting(P.engineStateEditor,"Engine:")),P.explodeButton=h.createButton("Explode",function(){p._hitpoints>0?(p.setHitpointsToZero(),p.addEventHandler(l.DESTRUCTED,function(){return p.vMo._node.hide(),_updateExplodeButton(),_updateShieldRechargeButton(),!1}),d.startAnimating()):(p.getExplosion()&&p.getExplosion().finish(),p.vMo._node.show(),p.respawn(),_updateThrusters(),d.requestRender()),_updateExplodeButton(),_updateShieldRechargeButton()}),m.options.appendChild(d.createSetting(P.explodeButton)),P.shieldRechargeButton=h.createButton("Recharge shield",function(){p.rechargeShield(),d.startAnimating()}),m.options.appendChild(d.createSetting(P.shieldRechargeButton))}function _animate(e){p&&p.simulate(e,N),g&&g.simulate()}function _updateForRefresh(){_updateForHitboxState(),p&&p._hitpoints<=0&&(p.vMo._node.show(),p.respawn()),_updateThrusters(),_updateExplodeButton(),_updateShieldRechargeButton()}function _onModelRotate(){var e=p&&p.getExplosion();e&&e.vMo.setOrientationMatrix(t.copy(p.vMo.oM))}function _getInfo(){var t,i,n;return t="",p&&(p._propulsion&&(t+="accel.: "+Math.round(p.getMaxAcceleration())+" m/s², speed: "+Math.round(p.getMaxCombatSpeed())+" m/s, ",t+="ang.accel.: "+Math.round(p.getMaxAngularAcceleration()*e.DEG)+" °/s², turn rate: "+Math.round(p.getMaxCombatTurnRate())+" °/s"),i=p.getFirepower(),i>0&&(n=i-p.getFirepower(1),t+=(t?", ":"")+" firepower: "+Math.round(100*i)/100+" (-"+Math.round(100*n)/100+" / arm.), ",t+="range: "+p.getWeaponRangesDisplayText()+" m"),p.hasShield()&&(t+=(t?", ":"")+" shield: "+p.getShieldCapacity()),t+=(t?", ":"")+"score value: "+p.getScoreValue(),t="Spacecraft: "+t),t}function refresh(e,t,i){var n=f===t;d.setContext(I),m=e,f=t,n?i||(i={preserve:!0,reload:!0}):d.clearSettingsForNewItem(),d.refresh(e,i)}function handleStartEdit(e,t){"bodies"===e&&(C=!0,M=t,_updateForHitboxState(),d.requestRender())}function handleStopEdit(e){"bodies"===e&&(C=!1,_updateForHitboxState(),d.requestRender())}var p,_,g,m,f,S,T,y,E,C,M,I,A=[{color:[1,1,1],direction:[1,0,1]}],x=[.8,.4,.3,.5],v="no propulsion",O="off",R=["basedOn","model","shader","texture","factionColor","defaultLuminosityFactors","bodies","weaponSlots","missileLaunchers","thrusterSlots","loadouts","humSound","explosion","lights","blinkers"],b=["basedOn","loadouts"],L=[],N={controlThrusters:!1,applyThrusterForces:!1},D=[],P={environmentSelector:null,loadoutSelector:null,factionColorPicker:null,engineStateEditor:null,engineStatePopup:null,explodeButton:null,shieldRechargeButton:null};return I=new d.WebGLPreviewContext({renderModeSetting:!0,lodSetting:!0,animateButton:!0,muteCheckbox:!0,canvasUpdateProperties:R,optionRefreshProperties:b,infoUpdateProperties:L},{clear:_clear,load:_load,updateForRefresh:_updateForRefresh,clearSettingsForNewItem:_clearSettingsForNewItem,createOptions:_createOptions,animate:_animate,onModelRotate:_onModelRotate,getInfo:_getInfo}),{refresh:refresh,clear:d.clear,handleDataChanged:d.handleDataChanged,handleStartEdit:handleStartEdit,handleStopEdit:handleStopEdit}}),define("editor/preview/environment-preview",["modules/media-resources","armada/control","armada/graphics","editor/common","editor/preview/webgl-preview"],function(e,t,i,n,s){"use strict";function _clear(){o&&o.removeFromScene(),a&&a.stop()}function _load(t){var n;t=t||{},t.preserve&&void 0===t.cameraSpeed&&(t.cameraSpeed=l),n=i.isShadowMappingEnabled(),o.hasShadows()?i.setShadowMapping():i.setShadowMapping(!1,!1),n!==i.isShadowMappingEnabled()&&i.handleSettingsChanged(),o.addToScene(s.getScene()),o.addParticleEffectsToScene(s.getScene())&&e.executeWhenReady(s.startAnimating),l=t.cameraSpeed}function _clearSettingsForNewItem(){l=0}function _createOptions(){p.cameraSpeedEditor=n.createNumericInput(l,{},function(e){s.updateCanvas({preserve:!0,clearScene:!0,cameraSpeed:e})}),r.options.appendChild(s.createSetting(p.cameraSpeedEditor,"Camera speed:"))}function _animate(e){o&&(a.executeActions(l>0?[[{name:"cameraMoveForward",intensity:l/a.getMaxSpeed()}]]:[],e),o.simulate())}function _updateForRefresh(){return!0}function refresh(e,i,n){var l=o===i;s.setContext(c),r=e,o=i,a=t.getController("camera"),l?n||(n={preserve:!0,reload:!0}):s.clearSettingsForNewItem(),s.refresh(e,n),a._controlledCamera=s.getScene()._camera}function handleStartEdit(){return!0}function handleStopEdit(){return!0}var o,r,a,l,c,h=["color","skyboxes","backgroundObjects","dustClouds","particleEffects"],u=[],d=[],p={cameraSpeedEditor:null};return c=new s.WebGLPreviewContext({renderModeSetting:!1,lodSetting:!1,animateButton:!0,muteCheckbox:!1,canvasUpdateProperties:h,optionRefreshProperties:u,infoUpdateProperties:d},{clear:_clear,load:_load,updateForRefresh:_updateForRefresh,clearSettingsForNewItem:_clearSettingsForNewItem,createOptions:_createOptions,animate:_animate}),{refresh:refresh,clear:s.clear,handleDataChanged:s.handleDataChanged,handleStartEdit:handleStartEdit,handleStopEdit:handleStopEdit}}),define("editor/preview/mission-preview",["utils/utils","utils/vectors","utils/matrices","modules/media-resources","modules/scene/camera","modules/scene/renderable-objects","editor/preview/webgl-preview"],function(e,t,i,n,s,o,r){"use strict";function _clear(){l&&(l.destroy(),l=null)}function _getColor(e,t,i){return U[0]=t*e[0],U[1]=t*e[1],U[2]=t*e[2],U[3]=i*e[3],U}function _scColorFunction(e){return _getColor(l._pilotedCraft&&l._pilotedCraft.isHostile(e)?L:b,e._away?I:1,e._away?A:1)}function _highlightedSpacecraftColorFunction(e){return _getColor(l._pilotedCraft&&l._pilotedCraft.isHostile(e)?D:N,e._away?I:1,e._away?A:1)}function _getDescriptorIndexForSpacecraft(e){var t,i,n=l.getData().spacecrafts;for(i=0,t=0;t<n.length;t++){if(e<i+(n[t].count||1))return t;i+=n[t].count||1}return-1}function _updateForSpacecraftSelection(){var e,t,i,n,s,r=l.getData().spacecrafts,a=l.getSpacecrafts();if(h>=0){for(t=0,e=0;e<h;e++)t+=r[e].count||1;i=t+(r[e].count||1)}else t=-1,i=-1;if(u>=0){for(n=0,e=0;e<u;e++)n+=r[e].count||1;s=n+(r[e].count||1)}else n=-1,s=-1;for(e=0;e<a.length;e++)a[e].vMo.setUniformValueFunction(o.UNIFORM_COLOR_NAME,e>=t&&e<i||e>=n&&e<s?_highlightedSpacecraftColorFunction.bind(this,a[e]):_scColorFunction.bind(this,a[e]))}function _load(e){var t;e=e||{},t=!e.preserve||e.reload,(e.clearScene||t)&&(t&&(l=a.createMission(f),r.setMission(l)),l.addToScene(r.getScene(),null,{spacecraftShaderName:S,gridShaderName:T,markerShaderName:y,gridColor:x,gridCount:E,smallestGridSize:C,markerColorPositive:v,markerColorNegative:O,markerSize:M,jumpMarkerColor:R,friendlyColor:b,hostileColor:L,smallestSizeWhenDrawn:P,awayColorFactor:I,awayAlphaFactor:A,callback:_updateForSpacecraftSelection}))}function _clearSettingsForNewItem(){return!0}function _createOptions(){return!0}function _updateForRefresh(){return!0}function _getInfo(){var e,t,i,n,s,o,r=0,c=0,h=0,u=0;if(e="",l){for(e='<span class="objectives">[show objectives]<div class="objectives popup">'+a.getMissionObjectives().join("<br>")+"</div></span>",t=l.getPerformanceLevelScores(),i=Object.keys(t),e+="  Score requirements:",o=0;o<i.length;o++)t[i[o]]>0&&(e+=" "+i[o]+": "+t[i[o]]);for(n=l.getSpacecrafts(),s=l._pilotedCraft,s&&(e+=", Player ship: "+(s.getDisplayName()||"unnamed "+s.getClass().getDisplayName())),o=0;o<n.length;o++)s&&n[o].isHostile(s)?(n[o]._away||h++,u++):(n[o]._away||r++,c++);e+=s?", friendlies: "+r+" / "+c+", hostiles: "+h+" / "+u:", spacecrafts: "+r+" / "+c}return e}function _onMouseMove(e,o,a){var c,h,_,g,m,f,S,T,y=-1,E=0;for(h=l.getSpacecrafts(),m=r.FREE_CAMERA_VIEW_DISTANCE*s.CAMERA_EXTENSION_FACTOR,T=w,f=i.translation4(o[12]+a[0]*m,o[13]+a[1]*m,o[14]+a[2]*m),c=0;c<h.length;c++)_=h[c],_._away&&0===_.pMo.pM[12]&&0===_.pMo.pM[13]&&0===_.pMo.pM[14]||_.pMo.checkHit(f,i.translation4v(t.scaled3(a,m)),1e3,T)&&(g=t.dot3(t.diff3Aux(_.getPhysicalPositionVector(),i.translationVector3(o)),a),(y<0||g<E)&&(y=c,E=g));return y!==d&&(y>=0?(p.textContent=h[y].getDisplayName()||h[y].getClass().getDisplayName(),p.hidden=!1):p.hidden=!0,d=y),p.style.left=e.clientX+V+"px",p.style.top=e.clientY+F+"px",S=y>=0?_getDescriptorIndexForSpacecraft(y):-1,u!==S&&(u=S,n.executeWhenReady(function(){_updateForSpacecraftSelection(),r.requestRender()})),!1}function _onClick(t){t.which===e.MouseButton.LEFT&&r.editProperty("spacecrafts",u)}function refresh(e,t,i){var n=a===t;r.setContext(c),p=e.tooltip,a=t,n?i||(i={preserve:!0,reload:!0}):r.clearSettingsForNewItem(),r.refresh(e,i)}function handleStartEdit(e,t){"spacecrafts"===e&&l.getData().spacecrafts&&l.getData().spacecrafts.length>0&&n.executeWhenReady(function(){h=t,_updateForSpacecraftSelection(),r.requestRender()})}function handleStopEdit(e){"spacecrafts"===e&&(h=-1,_updateForSpacecraftSelection(),r.requestRender())}var a,l,c,h,u,d,p,_=["environment","spacecrafts","events"],g=[],m=["events"],f="hard",S="oneColor",T="oneColor",y="oneColor",E=4,C=10,M=10,I=.5,A=.1,x=[1,1,1,.1],v=[1,1,0,.25],O=[1,.5,0,.25],R=[.4,.7,1,.5],b=[0,1,0,1],L=[1,0,0,1],N=[.75,1,.75,1],D=[1,.75,.75,1],P=.1,w=1,V=10,F=10,U=[0,0,0,0];return c=new r.WebGLPreviewContext({canvasUpdateProperties:_,optionRefreshProperties:g,infoUpdateProperties:m},{clear:_clear,load:_load,updateForRefresh:_updateForRefresh,getInfo:_getInfo,clearSettingsForNewItem:_clearSettingsForNewItem,createOptions:_createOptions,onMouseMove:_onMouseMove,onClick:_onClick}),{refresh:refresh,clear:r.clear,handleDataChanged:r.handleDataChanged,handleStartEdit:handleStartEdit,handleStopEdit:handleStopEdit,setEditProperty:r.setEditProperty}}),define("editor/editor",["utils/utils","modules/application","modules/media-resources","modules/scene/lights","armada/constants","armada/configuration","armada/graphics","armada/logic/classes","armada/logic/environments","armada/logic/missions","armada/control","armada/strings","editor/common","editor/descriptors","editor/properties","editor/preview/shader-preview","editor/preview/skybox-preview","editor/preview/backgroundObject-preview","editor/preview/explosion-preview","editor/preview/projectile-preview","editor/preview/weapon-preview","editor/preview/missile-preview","editor/preview/spacecraft-preview","editor/preview/environment-preview","editor/preview/mission-preview"],function(e,t,i,n,s,o,r,a,l,c,h,u,d,p,_,g,m,f,S,T,y,E,C,M,I){"use strict";function _expandList(e,t){var i;e.hidden=!1,t&&(i=document.getElementById(B).querySelector("."+fe),t.offsetTop<i.scrollTop?i.scrollTop=t.offsetTop:t.offsetTop+t.offsetHeight>i.scrollTop+i.clientHeight&&(i.scrollTop=t.offsetTop+t.offsetHeight-i.clientHeight))}function _toggleList(e){e.hidden=!e.hidden}function _createLabel(e){var t=document.createElement("div");return t.classList.add(me),t.innerHTML=e,t}function _hideLabel(e){e.querySelector("div."+me).hidden=!0}function _setLabel(e,t){var i=e.querySelector("div."+me);i.hidden=!1,i.innerHTML=t}function _clearPreview(){Be.type!==d.ItemType.NONE&&Ue[Be.category]&&Ue[Be.category].clear()}function _loadPreview(){var e=document.getElementById(H).querySelector("."+fe),t=e.querySelector("div#"+Re),i=document.getElementById(be),n=document.getElementById(Le),s=document.getElementById(Ne),o=document.getElementById(De);Be.type===d.ItemType.NONE?(i.hidden=!0,n.hidden=!0,t.hidden=!0,s.hidden=!0,o.hidden=!0,_setLabel(e,Pe)):Ue[Be.category]?(_hideLabel(e),Ue[Be.category].refresh({options:t,div:i,canvas:n,info:s,tooltip:o},Be.reference)):(i.hidden=!0,n.hidden=!0,t.hidden=!0,s.hidden=!0,o.hidden=!0,_setLabel(e,Ve))}function _changeReference(e,t,i,n,s,o){var r;if(o(i)===Be.category)switch(i.getBaseType()){case p.BaseType.ENUM:if(e[t]===n)return e[t]=s,!0;break;case p.BaseType.SET:if((r=e[t].indexOf(n))>=0)return e[t][r]=s,!0}return!1}function _changeReferences(e,t,i,n,s){var o,r,a,l,c;if(e)switch(t.getBaseType()){case p.BaseType.OBJECT:for(o=t.getProperties(),r=Object.keys(o),a=0;a<r.length;a++)l=new p.Type(o[r[a]].type),_changeReference(e,o[r[a]].name,l,i,n,s)||_changeReferences(e[o[r[a]].name],l,i,n,s);break;case p.BaseType.ARRAY:for(l=t.getElementType(),a=0;a<e.length;a++)_changeReference(e,a,l,i,n,s)||_changeReferences(e[a],l,i,n,s);break;case p.BaseType.ASSOCIATIVE_ARRAY:for(l=t.getElementType(),c=Object.keys(e),a=0;a<c.length;a++)_changeReference(e,c[a],l,i,n,s)||_changeReferences(e[c[a]],l,i,n,s);break;case p.BaseType.PAIRS:for(a=0;a<e.length;a++)l=t.getFirstType(),_changeReference(e[a],0,l,i,n,s)||_changeReferences(e[a][0],l,i,n,s),l=t.getSecondType(),_changeReference(e[a],1,l,i,n,s)||_changeReferences(e[a][1],l,i,n,s)}}function _updateHash(){location.hash=Be.type+"/"+Be.category+"/"+Be.name}function _createItemNameChangeHandler(e,t,i){return function(n,s){var o=p.itemDescriptors[s];o&&_changeReferences(n.getData(),new p.Type(o),e,t,i,!0),n.reloadData()}}function _handleNameChange(){var n,s=Be.data.name,o=x.innerHTML;if(s&&s!==o){switch(Be.type){case d.ItemType.RESOURCE:i.renameResource(Be.category,o,s),n=_createItemNameChangeHandler(o,s,function(e){return e.getResourceReference()});break;case d.ItemType.CLASS:a.renameClass(Be.category,o,s),n=_createItemNameChangeHandler(o,s,function(e){return e.getClassReference()});break;case d.ItemType.MISSION:return void((s=e.getFilenameWithoutExtension(Be.data.name))!==o&&t.showError("Name change not supported for this type of item!"));default:return void t.showError("Name change not supported for this type of item!")}x.innerHTML=s,Be.name=s,A[Be.type][Be.category][s]=A[Be.type][Be.category][o],delete A[Be.type][Be.category][o],i.executeForAllResources(n),a.executeForAllClasses(n),l.executeForAllEnvironments(n),_updateHash()}}function _updateHistoryButtons(){v.disabled=Ge<=0,O.disabled=Ge>=He.length-1}function _loadProperties(){var e=document.getElementById(G).querySelector("."+fe);e.innerHTML="",Be.type===d.ItemType.NONE?e.appendChild(_createLabel(Pe)):p.itemDescriptors[Be.category]?_.createProperties(e,Be,Ue[Be.category],_handleNameChange,D):e.appendChild(_createLabel(Fe))}function _loadItem(e,t,i,n){var s;P.hidden=!0,w.hidden=!0,(s=d.getItemReference({type:e,name:t,category:i},!0))&&(x&&x.classList.remove(Se),d.removePopups(),_clearPreview(),Be.type=e,Be.name=t,Be.category=i,Be.reference=s,Be.data=s.getData(),_loadProperties(),_loadPreview(),n||(n=A[Be.type][Be.category][Be.name]),_expandList(A[Be.type][Be.category]._list,n),x=n,x.classList.add(Se),_updateHash())}function _loadHistoryButtons(){v=document.getElementById(j),O=document.getElementById(k),v.onclick=function(){var e;Ge--,e=He[Ge],_loadItem(e.type,e.name,e.category),_updateHistoryButtons()},O.onclick=function(){var e;Ge++,e=He[Ge],_loadItem(e.type,e.name,e.category),_updateHistoryButtons()}}function _createElementClickHandler(e,t,i,n){return function(){D(t,n,i,e)}}function _getItemDataTransferType(e,t){return(e+"/"+t).toLowerCase()}function _createElementDragStartHandler(e,t,i){var n=_getItemDataTransferType(t,i);return function(t){t.dataTransfer.setData(n,e.id),e.classList.add(Me)}}function _createElementDragEndHandler(e){return function(){e.classList.remove(Me)}}function _createElementDragEnterHandler(e,t,i){var n=_getItemDataTransferType(t,i);return function(t){t.dataTransfer.types.indexOf(n)>=0&&t.dataTransfer.getData(n)!==e.id&&(e.classList.add(Ie),t.preventDefault())}}function _createElementDragOverHandler(e,t,i){var n=_getItemDataTransferType(t,i);return function(t){t.dataTransfer.types.indexOf(n)>=0&&t.dataTransfer.getData(n)!==e.id&&t.preventDefault()}}function _createElementDragLeaveHandler(e,t,i){var n=_getItemDataTransferType(t,i);return function(t){t.dataTransfer.types.indexOf(n)>=0&&e.classList.remove(Ie)}}function _createElementDropHandler(e,n,s){var o=_getItemDataTransferType(n,s);return function(r){var l=document.getElementById(r.dataTransfer.getData(o));switch(e.classList.remove(Ie),e.parentNode.insertBefore(l,e.nextSibling),n){case d.ItemType.RESOURCE:i.moveResourceAfter(s,l.firstChild.textContent,e.firstChild.textContent);break;case d.ItemType.CLASS:a.moveClassAfter(s,l.firstChild.textContent,e.firstChild.textContent);break;default:t.showError("Cannot move element of type '"+n+"'!")}}}function _getInfoObject(e,i){return{name:e,author:i,comment:"Created by Interstellar Armada editor",version:t.getVersion(),creationTime:(new Date).toString()}}function _getInfoString(e,t){return JSON.stringify(_getInfoObject(e,t))}function _getItemsString(e,t,i,n,s){var o,r,a,l,c;for(l='{"info":'+_getInfoString(e,t),o=0;o<i.length;o++){for(l+=',"'+i[o]+'":[',a=n(i[o]),r=0;r<a.length;r++)(c=s(i[o],a[r]).getData())&&(l+=(r>0?",":"")+JSON.stringify(c));l+="]"}return l+="}"}function _exportString(e,t){var i=new Blob([t],{type:"text/json"}),n=document.createEvent("MouseEvents"),s=document.createElement("a");s.download=e+".json",s.href=window.URL.createObjectURL(i),s.dataset.downloadurl=["text/json",s.download,s.href].join(":"),n.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(n)}function _loadExportDialog(){var n=document.getElementById(ie),s=document.getElementById(ne),o=document.getElementById(se),r=document.getElementById(oe),h=document.getElementById(re),u=document.getElementById(ae),p=document.getElementById(le),_=document.getElementById(ce),g=[d.ItemType.RESOURCE,d.ItemType.CLASS,d.ItemType.ENVIRONMENT,d.ItemType.MISSION],m=function(){return c.getMissionNames().map(function(t){return e.getFilenameWithoutExtension(t)})};d.setSelectorOptions(n,g),n.onchange=function(){n.value===d.ItemType.MISSION?(d.setSelectorOptions(r,m()),o.hidden=!0,h.hidden=!1):(s.value=n.value,o.hidden=!1,h.hidden=!0)},n.onchange(),p.onclick=function(){switch(n.value){case d.ItemType.RESOURCE:_exportString(s.value,_getItemsString(s.value,u.value,i.getResourceTypes(),i.getResourceNames,i.getResource));break;case d.ItemType.CLASS:_exportString(s.value,_getItemsString(s.value,u.value,a.getClassCategories(),a.getClassNames,a.getClass));break;case d.ItemType.ENVIRONMENT:_exportString(s.value,_getItemsString(s.value,u.value,[Ae],l.getEnvironmentNames,function(e,t){return e===Ae?l.getEnvironment(t):null}));break;case d.ItemType.MISSION:c.requestMissionDescriptor(c.getMissionNames()[r.selectedIndex],function(e){var t=Object.assign({info:_getInfoObject(e._name,u.value)},e.getData());delete t.name,_exportString(r.value,JSON.stringify(t))});break;default:t.showError("Exporting "+n.value+" is not yet implemented!")}w.hidden=!0},_.onclick=function(){w.hidden=!0},U=function(){var t;Be&&(t=g.indexOf(Be.type))>=0&&(n.selectedIndex=t,n.onchange(),n.value===d.ItemType.MISSION&&(t=m().indexOf(e.getFilenameWithoutExtension(Be.name)))>=0&&(r.selectedIndex=t))}}function _createCategoryList(t){var n,s,o,r,h,u,p,_,g,m,f,S,T=document.createElement("div");switch(t){case d.ItemType.RESOURCE:s=i.getResourceTypes(),S=i.getResourceNames;break;case d.ItemType.CLASS:s=a.getClassCategories(),S=a.getClassNames;break;case d.ItemType.ENVIRONMENT:s=[Ae],S=l.getEnvironmentNames;break;case d.ItemType.MISSION:s=[xe],S=c.getMissionNames.bind(this,void 0)}for(A[t]={},n=document.createElement("div"),n.classList.add(Te),n.textContent=t,T.appendChild(n),o=document.createElement("ul"),m=0;m<s.length;m++){for(r=document.createElement("li"),r.classList.add(ye),h=document.createElement("span"),h.classList.add(ye),h.innerHTML=s[m],r.appendChild(h),A[t][s[m]]={},p=document.createElement("ul"),
p.classList.add(Ee),u=S(s[m]),f=0;f<u.length;f++)_=document.createElement("li"),_.setAttribute("id",Oe+t+ve+s[m]+ve+u[f]),_.classList.add(Ce),_.draggable=t===d.ItemType.RESOURCE||t===d.ItemType.CLASS,g=document.createElement("span"),g.classList.add(Ce),g.textContent=u[f],t===d.ItemType.MISSION&&(g.textContent=e.getFilenameWithoutExtension(g.textContent)),_.appendChild(g),A[t][s[m]][u[f]]=g,g.onclick=_createElementClickHandler(g,t,s[m],u[f]),_.draggable&&(_.ondragstart=_createElementDragStartHandler(_,t,s[m],_.id),_.ondragend=_createElementDragEndHandler(_),_.ondragenter=_createElementDragEnterHandler(_,t,s[m]),_.ondragover=_createElementDragOverHandler(_,t,s[m]),_.ondragleave=_createElementDragLeaveHandler(_,t,s[m]),_.ondrop=_createElementDropHandler(_,t,s[m])),p.appendChild(_);p.hidden=!0,r.appendChild(p),h.onclick=_toggleList.bind(this,p),A[t][s[m]]._list=p,o.appendChild(r)}return T.appendChild(o),T}function _loadItems(){var e=document.getElementById(B).querySelector("."+fe);_hideLabel(e),A={},R&&e.removeChild(R),R=_createCategoryList(d.ItemType.RESOURCE),e.appendChild(R),b&&e.removeChild(b),b=_createCategoryList(d.ItemType.CLASS),e.appendChild(b),L&&e.removeChild(L),L=_createCategoryList(d.ItemType.ENVIRONMENT),e.appendChild(L),N&&e.removeChild(N),N=_createCategoryList(d.ItemType.MISSION),e.appendChild(N)}function _loadImportDialog(){var e=document.getElementById(de),i=document.getElementById(pe),n=document.getElementById(_e),s=document.getElementById(ge),o=[d.ItemType.MISSION];d.setSelectorOptions(e,o),n.onclick=function(){switch(e.value){case d.ItemType.MISSION:var n=i.files[0];n&&n.text().then(function(i){var s;try{s=JSON.parse(i)}catch(e){return void t.showError("The selected file doesn't seem to be a valid mission file!",t.ErrorSeverity.MINOR)}s&&(s.name=n.name,c.getMissionNames().indexOf(s.name)>=0?t.showError("A mission with this filename already exists!",t.ErrorSeverity.MINOR):(c.createMissionDescriptor(s),_loadItems(),D(e.value,s.name,d.ItemType.MISSION)))}.bind(this)).catch(function(){t.showError("Error while loading the mission file!",t.ErrorSeverity.MINOR)});break;default:t.showError("Importing "+e.value+" is not yet implemented!")}V.hidden=!0},s.onclick=function(){V.hidden=!0}}function _loadNewItemDialog(){var n,s,o,r=document.getElementById(X),h=document.getElementById(z),u=document.getElementById(J),g=document.getElementById(Q),m=document.getElementById(Z),f=document.getElementById($),S=[d.ItemType.RESOURCE,d.ItemType.CLASS,d.ItemType.ENVIRONMENT,d.ItemType.MISSION];d.setSelectorOptions(r,S),r.onchange=function(){switch(r.value){case d.ItemType.RESOURCE:d.setSelectorOptions(h,i.getResourceTypes()),n=i.getResourceNames,s=function(){var t=u.selectedIndex>0?e.deepCopy(i.getResource(h.value,u.value).getData()):_.getDefaultItemData(p.itemDescriptors[h.value],g.value,r.value,h.value);t.name=g.value,i.createResource(h.value,t)};break;case d.ItemType.CLASS:d.setSelectorOptions(h,a.getClassCategories()),n=a.getClassNames,s=function(){var t=u.selectedIndex>0?e.deepCopy(a.getClass(h.value,u.value).getData()):_.getDefaultItemData(p.itemDescriptors[h.value],g.value,r.value,h.value);t.name=g.value,a.createClass(h.value,t)};break;case d.ItemType.ENVIRONMENT:d.setSelectorOptions(h,[Ae]),n=l.getEnvironmentNames,s=function(){var t=u.selectedIndex>0?e.deepCopy(l.getEnvironment(u.value).getData()):_.getDefaultItemData(p.itemDescriptors[h.value],g.value,r.value,h.value);t.name=g.value,l.createEnvironment(t)};break;case d.ItemType.MISSION:d.setSelectorOptions(h,[xe]),n=c.getMissionNames.bind(this,void 0),s=null,o=function(t){var i;u.selectedIndex>0?c.requestMissionDescriptor(u.value,function(n){i=e.deepCopy(n.getData()),i.name=g.value,c.createMissionDescriptor(i),t()}):(i=e.deepCopy(_.getDefaultItemData(p.itemDescriptors[h.value],g.value,r.value,h.value)),i.name=g.value,c.createMissionDescriptor(i),t())};break;default:n=null,s=null,o=null,t.showError("Creating "+r.value+" is not yet implemented!")}document.getElementById(q).hidden=h.options.length<2,document.getElementById(K).hidden=h.options.length>=2,h.onchange()},h.onchange=function(){n&&(d.setSelectorOptions(u,["none"].concat(n(h.value))),r.value===d.ItemType.MISSION?g.value="mission":(g.value=h.value,g.value.indexOf("Classes")>=0?g.value=g.value.substring(0,g.value.indexOf("Classes")):"s"===g.value[g.value.length-1]&&(g.value=g.value.substring(0,g.value.length-1))))},u.onchange=function(){u.selectedIndex>0?r.value===d.ItemType.MISSION?(g.value=u.value,g.value.indexOf(".json")===g.value.length-5&&(g.value=g.value.substring(0,g.value.length-5)),g.value=g.value+"_copy"):g.value=u.value+"_copy":r.value===d.ItemType.MISSION?g.value="newMission":g.value=h.value},r.onchange(),m.onclick=function(){var e;if(n){if(e=n(h.value),e.indexOf(g.value)>=0)return void t.showError("Cannot create item: '"+g.value+"' already exists!",t.ErrorSeverity.MINOR);s?(s(),_loadItems(),P.hidden=!0,D(r.value,g.value,h.value)):o&&o(function(){_loadItems(),P.hidden=!0,D(r.value,g.value,h.value)})}},f.onclick=function(){P.hidden=!0},F=function(){var e;Be&&(e=S.indexOf(Be.type))>=0&&(r.selectedIndex=e,r.onchange(),(e=d.getSelectorOptions(h).indexOf(Be.category))>=0&&(h.selectedIndex=e,h.onchange()))}}function _loadDialogs(){P=document.getElementById(Y),w=document.getElementById(te),V=document.getElementById(ue),document.getElementById(W).onclick=function(){P.hidden=!P.hidden,P.hidden||(F(),w.hidden=!0,V.hidden=!0)},_loadNewItemDialog(),document.getElementById(ee).onclick=function(){w.hidden=!w.hidden,w.hidden||(U(),P.hidden=!0,V.hidden=!0)},_loadExportDialog(),document.getElementById(he).onclick=function(){V.hidden=!V.hidden,V.hidden||(P.hidden=!0,w.hidden=!0)},_loadImportDialog()}function _requestSettingsLoad(e){t.requestTextFile(e.folder,e.filename,function(e){var i=JSON.parse(e);t.log("Loading game settings...",1),r.loadSettingsFromJSON(i.graphics),r.loadSettingsFromLocalStorage(),o.loadSettingsFromJSON(i.logic),r.executeWhenReady(function(){n.setupLiSPSM(r.getLispsmMinimumNear(),r.getLispsmNearFactor())}),o.executeWhenReady(function(){l.requestLoad(),l.executeWhenReady(function(){c.requestLoad(!0),c.executeWhenReady(function(){var e;t.log("Game settings loaded.",1),localStorage[s.VERSION_LOCAL_STORAGE_ID]=t.getVersion(),t.log("Initialization completed."),_setLabel(document.getElementById(H),Pe+"<br>"+we),_setLabel(document.getElementById(G),Pe),_loadItems(),_loadHistoryButtons(),_loadDialogs(),location.hash&&(e=location.hash.substring(1).split("/"),e.length>3?D(e[0],location.hash.substring(3+e[0].length+e[1].length),e[1]):3===e.length?D(e[0],e[2],e[1]):e.length>0&&e[0]===d.ItemType.MISSION&&(Be.type=d.ItemType.MISSION,Be.category=xe,_expandList(A[Be.type][Be.category]._list),2===e.length&&("create"===e[1]?document.getElementById(W).click():"import"===e[1]&&document.getElementById(he).click())))})})})})}function _requestConfigLoad(){t.requestTextFile("config","config.json",function(e){var i=JSON.parse(e);t.log("Loading configuration..."),t.setFolders(i.folders),t.setLogVerbosity(i.logVerbosity),t.setVersion(i.version),t.setDebugVersion(i.debugVersion),t.log("Game version is: "+t.getVersion(),1),requirejs(["modules/media-resources"],function(e){o.loadConfigurationFromJSON(i.dataFiles.logic),r.loadConfigurationFromJSON(i.graphics),c.loadConfigurationFromJSON(i.logic),h.loadConfigurationFromJSON(i.control),e.requestConfigLoad(i.dataFiles.media.resources,function(){t.log("Configuration loaded.")}),t.requestTextFile(i.configFiles.strings.English.folder,i.configFiles.strings.English.filename,function(e){u.loadStrings("English",JSON.parse(e),u),u.setLanguage("English"),_requestSettingsLoad(i.configFiles.settings)})})})}function _handleResize(){d.alignPopups()}var A,x,v,O,R,b,L,N,D,P,w,V,F,U,B="items",H="preview",G="properties",j="backButton",k="forwardButton",W="newItemButton",Y="newItemDialog",X="newItemType",q="newItemCategoryContainer",z="newItemCategory",J="newItemBase",Q="newItemName",K="newItemDialogFiller",Z="newItemCreate",$="newItemCancel",ee="exportButton",te="exportDialog",ie="exportType",ne="exportName",se="exportNameContainer",oe="exportItem",re="exportItemContainer",ae="exportAuthor",le="exportExport",ce="exportCancel",he="importButton",ue="importDialog",de="importType",pe="importFile",_e="importImport",ge="importCancel",me="windowLabel",fe="windowContent",Se="selected",Te="itemType",ye="category",Ee="elementList",Ce="element",Me="inserting",Ie="dragover",Ae="environments",xe="missions",ve="_",Oe="element_",Re="previewOptions",be="previewDiv",Le="previewCanvas",Ne="previewInfo",De="previewTooltip",Pe="select an item from the left or click New or Import in the top left menu",we='for more information, check out the <a href="docs/editor/tutorial/00-index.html" target="_blank">Getting started guide</a>',Ve="preview not available for this type of item",Fe="properties not available for this type of item",Ue={shaders:g,skyboxClasses:m,backgroundObjectClasses:f,explosionClasses:S,projectileClasses:T,weaponClasses:y,missileClasses:E,spacecraftClasses:C,environments:M,missions:I},Be={type:d.ItemType.NONE,name:"",category:"",reference:null,data:null},He=[],Ge=-1;return D=function(e,t,i,n){Be.type===e&&Be.name===t&&Be.category===i||(_loadItem(e,t,i,n),He.length>0&&Ge<He.length-1&&He.splice(Ge+1),He.push({type:e,name:t,category:i,element:n}),Ge=He.length-1,_updateHistoryButtons())},{initialize:function(e){t.log("Initializing the Interstellar Armada Editor..."),t.useElectron(e.electron),t.setPreviouslyRunVersion(localStorage[s.VERSION_LOCAL_STORAGE_ID]),_requestConfigLoad(),window.addEventListener("resize",_handleResize)}}}),requirejs(["editor/editor"],function(e){"use strict";e.initialize({electron:!1})}),define("editor-main",function(){});